"use strict";function _classCallCheck(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}Object.defineProperty(exports,"__esModule",{value:!0}),exports.ObjectType=exports.ChangeType=void 0;var _createClass=function(){function e(e,t){for(var n=0;n<t.length;n++){var r=t[n];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(e,r.key,r)}}return function(t,n,r){return n&&e(t.prototype,n),r&&e(t,r),t}}(),_utils=require("../utils/utils.js"),SyncObject=function(){function e(t){_classCallCheck(this,e);var n=this;n._observers=[],n._filters={},t?n._data=(0,_utils.deepClone)(t):n._data={},n._internalObserve(new Path,n._data)}return _createClass(e,[{key:"observe",value:function(e){this._observers.push(e)}},{key:"find",value:function(e){var t=e.split(".");return this._findWithSplit(t)}},{key:"findBefore",value:function(e){var t={},n=e.split(".");return t.last=n.pop(),t.obj=this._findWithSplit(n),t}},{key:"_findWithSplit",value:function(e){var t=this._data;return e.forEach(function(e){t=t[e]}),t}},{key:"_fireEvent",value:function(e){this._observers.forEach(function(t){t(e)})}},{key:"_isObservable",value:function(e){return e.constructor===Object||e.constructor===Array}},{key:"_internalObserve",value:function(e,t){var n=this;if(n._isObservable(t)){var r=function(t){n._onChanges(e,t)};if(t.constructor===Object){Object.observe(t,r);for(var a in t)n._isObservable(t[a])&&n._internalObserve(e["new"](a),t[a])}else if(t.constructor===Array){Array.observe(t,r);for(var i in t)if(n._isObservable(t[i])){var o=e["new"](new ArrayIndex(t[i],i));n._internalObserve(o,t[i])}}}}},{key:"_onChanges",value:function(e,t){var n=this;for(var r in t){var a=t[r].object,i=void 0;if(a.constructor===Object&&(i=ObjectType.OBJECT),a.constructor===Array&&(i=ObjectType.ARRAY),"splice"===t[r].type)!function(){var o=t[r].index,s=e["new"](""+o),c=s.toString(),l=t[r].removed.length;if(0!==l){var u=t[r].removed;u.forEach(function(t,r){n._isObservable(t)&&e.removeIndex(o+r)}),n._fireEvent({cType:ChangeType.REMOVE,oType:i,field:c,data:l})}var f=t[r].addedCount;if(0!==f){var v=a.slice(o,o+f);v.forEach(function(t,r){if(n._isObservable(t)){var a=e["new"](new ArrayIndex(t,o+r));n._internalObserve(a,t)}}),n._fireEvent({cType:ChangeType.ADD,oType:i,field:c,data:(0,_utils.deepClone)(v)})}o!==a.length-1&&e.reIndexFrom(a)}();else{var o=e["new"](t[r].name),s=o.toString();if(s.indexOf("Symbol")!==-1)continue;var c=a[t[r].name];"update"===t[r].type&&this._fireEvent({cType:ChangeType.UPDATE,oType:i,field:s,data:(0,_utils.deepClone)(c)}),"add"===t[r].type&&(this._internalObserve(o,c),this._fireEvent({cType:ChangeType.ADD,oType:i,field:s,data:(0,_utils.deepClone)(c)})),"delete"===t[r].type&&this._fireEvent({cType:ChangeType.REMOVE,oType:i,field:s})}}}},{key:"data",get:function(){return this._data}}]),e}(),Path=function(){function e(){_classCallCheck(this,e),this._path=[],this._observables={}}return _createClass(e,[{key:"removeIndex",value:function(e){delete this._observables[e]}},{key:"reIndexFrom",value:function(e){var t=this;Object.keys(this._observables).forEach(function(n){var r=t._observables[n],a=e.indexOf(r.obj);r.idx!=a&&(r.idx=a,delete t._observables[n],t._observables[a]=r)})}},{key:"new",value:function(e){e.constructor==ArrayIndex&&(this._observables[e.idx]=e);var t=this.clone();return t._path.push(e),t}},{key:"clone",value:function(){var t=new e;return this._path.forEach(function(e){t._path.push(e)}),t}},{key:"toString",value:function(){var e="";return this._path.forEach(function(t,n){0===n?e=t.toString():e+="."+t.toString()}),e}}]),e}(),ArrayIndex=function(){function e(t,n){_classCallCheck(this,e),this.obj=t,this.idx=n}return _createClass(e,[{key:"toString",value:function(){return this.idx.toString()}}]),e}(),ChangeType=exports.ChangeType={UPDATE:"update",ADD:"add",REMOVE:"remove"},ObjectType=exports.ObjectType={OBJECT:"object",ARRAY:"array"};exports["default"]=SyncObject;
//# sourceMappingURL=SyncObject.js.map
