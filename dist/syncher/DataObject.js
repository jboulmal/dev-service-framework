"use strict";function _interopRequireDefault(e){return e&&e.__esModule?e:{"default":e}}function _classCallCheck(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}Object.defineProperty(exports,"__esModule",{value:!0});var _createClass=function(){function e(e,t){for(var n=0;n<t.length;n++){var r=t[n];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(e,r.key,r)}}return function(t,n,r){return n&&e(t.prototype,n),r&&e(t,r),t}}(),_SyncObject=require("./SyncObject"),_SyncObject2=_interopRequireDefault(_SyncObject),_DataObjectChild=require("./DataObjectChild"),_DataObjectChild2=_interopRequireDefault(_DataObjectChild),_utils=require("../utils/utils.js"),DataObject=function(){function e(t,n,r,o,a,c){_classCallCheck(this,e);var i=this;i._syncher=t,i._url=n,i._schema=r,i._status=o,i._syncObj=new _SyncObject2["default"](a),i._childrens=c,i._version=0,i._childId=0,i._childrenObjects={},i._childrenListeners=[],i._owner=t._owner,i._bus=t._bus}return _createClass(e,[{key:"_allocateListeners",value:function(){var e=this,t=this,n=t._url+"/children/";t._childrens&&t._childrens.forEach(function(r){var o=n+r,a=t._bus.addListener(o,function(n){if(n.from!==e._owner)switch(console.log("DataObject-Children-RCV: ",n),n.type){case"create":t._onChildCreate(n);break;case"delete":console.log(n);break;default:t._changeChildren(n)}});t._childrenListeners.push(a)})}},{key:"_releaseListeners",value:function(){var e=this;e._childrenListeners.forEach(function(e){e.remove()}),Object.keys(e._childrenObjects).forEach(function(t){e._childrenObjects[t]._releaseListeners()})}},{key:"pause",value:function(){throw"Not implemented"}},{key:"resume",value:function(){throw"Not implemented"}},{key:"stop",value:function(){throw"Not implemented"}},{key:"addChild",value:function(e,t){var n=this;n._childId++;var r=n._owner+"#"+n._childId,o=n._url+"/children/"+e,a={type:"create",from:n._owner,to:o,body:{resource:r,value:t}};return new Promise(function(e){var c=n._bus.postMessage(a);console.log("create-reporter-child( "+n._owner+" ): ",a);var i=new _DataObjectChild2["default"](n,r,t,n._owner,c);i.onChange(function(e){n._onChange(e,{path:o,childId:r})}),n._childrenObjects[r]=i,e(i)})}},{key:"onAddChild",value:function(e){this._onAddChildrenHandler=e}},{key:"_onChildCreate",value:function(e){var t=this,n=e.body.resource;console.log("create-observer-child( "+t._owner+" ): ",e);var r=new _DataObjectChild2["default"](t,n,e.body.value);t._childrenObjects[n]=r,setTimeout(function(){t._bus.postMessage({id:e.id,type:"response",from:e.to,to:e.from,body:{code:200,source:t._owner}})});var o={type:e.type,from:e.from,url:e.to,value:e.body.value,childId:n,identity:e.body.identity};t._onAddChildrenHandler&&(console.log("ADD-CHILDREN-EVENT: ",o),t._onAddChildrenHandler(o))}},{key:"_onChange",value:function(e,t){var n=this;if(n._version++,"on"===n._status){var r={type:"update",from:n._url,to:n._url+"/changes",body:{version:n._version,source:n._owner,attribute:e.field}};e.oType===_SyncObject.ObjectType.OBJECT?e.cType!==_SyncObject.ChangeType.REMOVE&&(r.body.value=e.data):(r.body.attributeType=e.oType,r.body.value=e.data,e.cType!==_SyncObject.ChangeType.UPDATE&&(r.body.operation=e.cType)),t&&(r.to=t.path,r.body.resource=t.childId),n._bus.postMessage(r)}}},{key:"_changeObject",value:function(e,t){var n=this;if(n._version+1===t.body.version){n._version++;var r=t.body.attribute,o=(0,_utils.deepClone)(t.body.value),a=e.findBefore(r);if(t.body.attributeType===_SyncObject.ObjectType.ARRAY)if(t.body.operation===_SyncObject.ChangeType.ADD){var c=a.obj,i=a.last;Array.prototype.splice.apply(c,[i,0].concat(o))}else if(t.body.operation===_SyncObject.ChangeType.REMOVE){var l=a.obj,s=a.last;l.splice(s,o)}else a.obj[a.last]=o;else t.body.value?a.obj[a.last]=o:delete a.obj[a.last]}else console.log("UNSYNCHRONIZED VERSION: (data => "+n._version+", msg => "+t.body.version+")")}},{key:"_changeChildren",value:function(e){var t=this;console.log("Change children: ",t._owner,e);var n=e.body.resource,r=t._childrenObjects[n];r?t._changeObject(r._syncObj,e):console.log("No children found for: ",n)}},{key:"url",get:function(){return this._url}},{key:"schema",get:function(){return this._schema}},{key:"status",get:function(){return this._status}},{key:"data",get:function(){return this._syncObj.data}},{key:"childrens",get:function(){return this._childrenObjects}}]),e}();exports["default"]=DataObject,module.exports=exports["default"];
//# sourceMappingURL=DataObject.js.map
