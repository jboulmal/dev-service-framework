{"version":3,"sources":["syncher/DataObjectReporter.js"],"names":["_interopRequireDefault","obj","__esModule","default","_classCallCheck","instance","Constructor","TypeError","_possibleConstructorReturn","self","call","ReferenceError","_inherits","subClass","superClass","prototype","Object","create","constructor","value","enumerable","writable","configurable","setPrototypeOf","__proto__","defineProperty","exports","_createClass","defineProperties","target","props","i","length","descriptor","key","protoProps","staticProps","_get","get","object","property","receiver","Function","desc","getOwnPropertyDescriptor","undefined","parent","getPrototypeOf","getter","_DataObject2","require","_DataObject3","_utils","DataObjectReporter","_DataObject","syncher","url","schema","initialStatus","initialData","childrens","this","_this2","_this","_subscriptions","_syncObj","observe","event","console","log","_onChange","_allocateListeners","_objectListener","_bus","addListener","_url","msg","type","_onResponse","_onRead","remove","observers","inviteMsg","from","_syncher","_owner","to","_subURL","body","resource","_schema","data","authorise","postMessage","deleteMsg","reply","code","_releaseListeners","_reporters","callback","_onSubscriptionHandler","_onResponseHandler","_onReadHandler","_onSubscribe","_onUnSubscribe","hypertyUrl","identity","accept","sub","status","childrenValues","keys","_childrenObjects","forEach","childId","childData","deepClone","id","version","_version","reject","reason","module"],"mappings":"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","file":"syncher/DataObjectReporter.js","sourcesContent":["/**\n* Copyright 2016 PT Inovação e Sistemas SA\n* Copyright 2016 INESC-ID\n* Copyright 2016 QUOBIS NETWORKS SL\n* Copyright 2016 FRAUNHOFER-GESELLSCHAFT ZUR FOERDERUNG DER ANGEWANDTEN FORSCHUNG E.V\n* Copyright 2016 ORANGE SA\n* Copyright 2016 Deutsche Telekom AG\n* Copyright 2016 Apizee\n* Copyright 2016 TECHNISCHE UNIVERSITAT BERLIN\n*\n* Licensed under the Apache License, Version 2.0 (the \"License\");\n* you may not use this file except in compliance with the License.\n* You may obtain a copy of the License at\n*\n*   http://www.apache.org/licenses/LICENSE-2.0\n*\n* Unless required by applicable law or agreed to in writing, software\n* distributed under the License is distributed on an \"AS IS\" BASIS,\n* WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n* See the License for the specific language governing permissions and\n* limitations under the License.\n**/\n\nimport DataObject from './DataObject';\nimport { deepClone } from '../utils/utils.js';\n\n/**\n * The class returned from the Syncher create call.\n * To be used as a reporter point, changes will be submited to DataObjectObserver instances.\n */\nclass DataObjectReporter extends DataObject /* implements SyncStatus */ {\n  /* private\n  _subscriptions: <hypertyUrl: { status: string } }>\n\n  ----event handlers----\n  _onSubscriptionHandler: (event) => void\n  _onResponseHandler: (event) => void\n  _onReadHandler: (event) => void\n  */\n\n  /**\n   * @ignore\n   * Should not be used directly by Hyperties. It's called by the Syncher.create method\n   */\n  constructor(syncher, url, schema, initialStatus, initialData, childrens) {\n    super(syncher, url, schema, initialStatus, initialData, childrens);\n    let _this = this;\n\n    _this._subscriptions = {};\n\n    _this._syncObj.observe((event) => {\n      console.log('DataObjectReporter-' + url + '-SEND: ', event);\n      _this._onChange(event);\n    });\n\n    _this._allocateListeners();\n  }\n\n  _allocateListeners() {\n    super._allocateListeners();\n    let _this = this;\n\n    _this._objectListener = _this._bus.addListener(_this._url, (msg) => {\n      console.log('DataObject-' + _this._url + '-RCV: ', msg);\n      switch (msg.type) {\n        case 'response': _this._onResponse(msg); break;\n        case 'read': _this._onRead(msg); break;\n      }\n    });\n  }\n\n  _releaseListeners() {\n    super._releaseListeners();\n    let _this = this;\n\n    _this._objectListener.remove();\n  }\n\n  /**\n   * Send invitations (create messages) to hyperties, observers list.\n   * @param  {HypertyURL[]} observers List of Hyperty URL's\n   */\n  inviteObservers(observers) {\n    let _this = this;\n\n    //FLOW-OUT: this message will be sent to the runtime instance of SyncherManager -> _onCreate\n    let inviteMsg = {\n      type: 'create', from: _this._syncher._owner, to: _this._syncher._subURL,\n      body: { resource: _this._url, schema: _this._schema, value: _this._syncObj.data, authorise: observers }\n    };\n\n    _this._bus.postMessage(inviteMsg);\n  }\n\n  /**\n   * Release and delete object data\n   */\n  delete() {\n    let _this = this;\n\n    //FLOW-OUT: this message will be sent to the runtime instance of SyncherManager -> _onDelete\n    let deleteMsg = {\n      type: 'delete', from: _this._owner, to: _this._syncher._subURL,\n      body: { resource: _this._url }\n    };\n\n    _this._bus.postMessage(deleteMsg, (reply) => {\n      console.log('DataObjectReporter-DELETE: ', reply);\n      if (reply.body.code === 200) {\n        _this._releaseListeners();\n        delete _this._syncher._reporters[_this._url];\n      }\n    });\n  }\n\n  /**\n   * Subscriptions requested and accepted to this reporter\n   * @type {Object<HypertyURL, SyncSubscription>}\n   */\n  get subscriptions() { return this._subscriptions; }\n\n  /**\n   * Setup the callback to process subscribe and unsubscribe notifications\n   * @param {function(event: MsgEvent)} callback function to receive events\n   */\n  onSubscription(callback) {\n    this._onSubscriptionHandler = callback;\n  }\n\n  /**\n   * Setup the callback to process response notifications of the create's\n   * @param {function(event: MsgEvent)} callback function to receive events\n   */\n  onResponse(callback) {\n    this._onResponseHandler = callback;\n  }\n\n  /**\n   * Setup the callback to process read notifications\n   * @param {function(event: MsgEvent)} callback\n   */\n  onRead(callback) {\n    this._onReadHandler = callback;\n  }\n\n  //FLOW-IN: message received from parent Syncher -> _onForward\n  _onForward(msg) {\n    let _this = this;\n\n    console.log('DataObjectReporter-RCV: ', msg);\n    switch (msg.body.type) {\n      case 'subscribe': _this._onSubscribe(msg); break;\n      case 'unsubscribe': _this._onUnSubscribe(msg); break;\n    }\n  }\n\n  //FLOW-IN: message received from this -> _onForward: emitted by a remote Syncher -> subscribe\n  _onSubscribe(msg) {\n    let _this = this;\n    let hypertyUrl = msg.body.from;\n\n    let event = {\n      type: msg.body.type,\n      url: hypertyUrl,\n\n      identity: msg.body.identity,\n\n      accept: () => {\n        //create new subscription\n        let sub = { url: hypertyUrl, status: 'on' };\n        _this._subscriptions[hypertyUrl] = sub;\n\n        //process and send childrens data\n        let childrenValues = {};\n        Object.keys(_this._childrenObjects).forEach((childId) => {\n          let childData = _this._childrenObjects[childId].data;\n          childrenValues[childId] = deepClone(childData);\n        });\n\n        //send ok response message\n        _this._bus.postMessage({\n          id: msg.id, type: 'response', from: msg.to, to: msg.from,\n          body: { code: 200, schema: _this._schema, version: _this._version, value: { data: deepClone(_this.data), childrens: childrenValues } }\n        });\n\n        return sub;\n      },\n\n      reject: (reason) => {\n        //send reject response message\n        _this._bus.postMessage({\n          id: msg.id, type: 'response', from: msg.to, to: msg.from,\n          body: { code: 403, desc: reason }\n        });\n      }\n    };\n\n    if (_this._onSubscriptionHandler) {\n      console.log('SUBSCRIPTION-EVENT: ', event);\n      _this._onSubscriptionHandler(event);\n    }\n  }\n\n  //FLOW-IN: message received from this -> _onForward: emitted by a remote DataObjectObserver -> unsubscribe\n  _onUnSubscribe(msg) {\n    let _this = this;\n    let hypertyUrl = msg.body.from;\n\n    let sub = _this._subscriptions[hypertyUrl];\n    delete _this._subscriptions[hypertyUrl];\n\n    let event = {\n      type: msg.body.type,\n      url: hypertyUrl,\n      object: sub\n    };\n\n    if (_this._onSubscriptionHandler) {\n      console.log('UN-SUBSCRIPTION-EVENT: ', event);\n      _this._onSubscriptionHandler(event);\n    }\n  }\n\n  //FLOW-IN: message received from ReporterURL address: emited by a remote Syncher -> _onRemoteCreate -> event.ack\n  _onResponse(msg) {\n    let _this = this;\n\n    let event = {\n      type: msg.type,\n      url: msg.from,\n      code: msg.body.code\n    };\n\n    if (_this._onResponseHandler) {\n      console.log('RESPONSE-EVENT: ', event);\n      _this._onResponseHandler(event);\n    }\n  }\n\n  //FLOW-IN: message received from ReporterURL address: emited by a remote Syncher -> read\n  _onRead(msg) {\n    let _this = this;\n\n    let event = {\n      type: msg.type,\n      url: msg.from,\n\n      accept: () => {\n        _this._bus.postMessage({\n          id: msg.id, type: 'response', from: msg.to, to: msg.from,\n          body: { code: 200, value: deepClone(_this.data) }\n        });\n      },\n\n      reject: (reason) => {\n        _this._bus.postMessage({\n          id: msg.id, type: 'response', from: msg.to, to: msg.from,\n          body: { code: 401, desc: reason }\n        });\n      }\n    };\n\n    if (_this._onReadHandler) {\n      console.log('READ-EVENT: ', event);\n      _this._onReadHandler(event);\n    }\n  }\n\n}\n\nexport default DataObjectReporter;\n"],"sourceRoot":"/source/"}