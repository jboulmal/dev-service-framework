{"version":3,"sources":["syncher/DataObjectObserver.js"],"names":["_interopRequireDefault","obj","__esModule","default","_classCallCheck","instance","Constructor","TypeError","_possibleConstructorReturn","self","call","ReferenceError","_inherits","subClass","superClass","prototype","Object","create","constructor","value","enumerable","writable","configurable","setPrototypeOf","__proto__","defineProperty","exports","_createClass","defineProperties","target","props","i","length","descriptor","key","protoProps","staticProps","_get","get","object","property","receiver","Function","desc","getOwnPropertyDescriptor","undefined","parent","getPrototypeOf","getter","_DataObject2","require","_DataObject3","_DataObjectChild","_DataObjectChild2","FilterType","ANY","START","EXACT","DataObjectObserver","_DataObject","syncher","url","schema","initialStatus","initialData","childrens","initialVersion","this","_this2","data","_this","_version","_filters","_syncObj","observe","event","_onFilter","keys","forEach","childId","childData","_childrenObjects","_allocateListeners","_changeListener","_bus","addListener","_url","msg","type","console","log","_changeObject","remove","_releaseListeners","_syncher","_observers","unSubscribeMsg","from","_owner","to","_subURL","body","resource","postMessage","reply","code","filter","callback","filterObj","idx","indexOf","substr","field","module"],"mappings":"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","file":"syncher/DataObjectObserver.js","sourcesContent":["/**\n* Copyright 2016 PT Inovação e Sistemas SA\n* Copyright 2016 INESC-ID\n* Copyright 2016 QUOBIS NETWORKS SL\n* Copyright 2016 FRAUNHOFER-GESELLSCHAFT ZUR FOERDERUNG DER ANGEWANDTEN FORSCHUNG E.V\n* Copyright 2016 ORANGE SA\n* Copyright 2016 Deutsche Telekom AG\n* Copyright 2016 Apizee\n* Copyright 2016 TECHNISCHE UNIVERSITAT BERLIN\n*\n* Licensed under the Apache License, Version 2.0 (the \"License\");\n* you may not use this file except in compliance with the License.\n* You may obtain a copy of the License at\n*\n*   http://www.apache.org/licenses/LICENSE-2.0\n*\n* Unless required by applicable law or agreed to in writing, software\n* distributed under the License is distributed on an \"AS IS\" BASIS,\n* WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n* See the License for the specific language governing permissions and\n* limitations under the License.\n**/\n\nimport DataObject from './DataObject';\nimport DataObjectChild from './DataObjectChild';\n\nlet FilterType = {ANY: 'any', START: 'start', EXACT: 'exact'};\n\n/**\n * The class returned from the Syncher subscribe call.\n * To be used as an observation point from a DataObjectReporter change.\n */\nclass DataObjectObserver extends DataObject /* implements SyncStatus */ {\n  /* private\n  _changeListener: MsgListener\n\n  ----event handlers----\n  _filters: {<filter>: {type: <start, exact>, callback: <function>} }\n  */\n\n  /**\n   * @ignore\n   * Should not be used directly by Hyperties. It's called by the Syncher.subscribe method\n   */\n  constructor(syncher, url, schema, initialStatus, initialData, childrens, initialVersion) {\n    super(syncher, url, schema, initialStatus, initialData.data, childrens);\n    let _this = this;\n\n    _this._version = initialVersion;\n    _this._filters = {};\n\n    _this._syncObj.observe((event) => {\n      _this._onFilter(event);\n    });\n\n    //setup childrens data from subscription\n    Object.keys(initialData.childrens).forEach((childId) => {\n      let childData = initialData.childrens[childId];\n      _this._childrenObjects[childId] = new DataObjectChild(_this, childId, childData);\n    });\n\n    _this._allocateListeners();\n  }\n\n  _allocateListeners() {\n    super._allocateListeners();\n    let _this = this;\n\n    _this._changeListener = _this._bus.addListener(_this._url + '/changes', (msg) => {\n      if (msg.type === 'update') {\n          console.log('DataObjectObserver-' + _this._url + '-RCV: ', msg);\n          _this._changeObject(_this._syncObj, msg);\n      }\n    });\n  }\n\n  _releaseListeners() {\n    super._releaseListeners();\n    let _this = this;\n\n    _this._changeListener.remove();\n  }\n\n  /**\n   * Release and delete object data\n   */\n  delete() {\n    let _this = this;\n\n    _this._releaseListeners();\n    delete _this._syncher._observers[_this._url];\n  }\n\n  /**\n   * Release and delete object data\n   */\n  unsubscribe() {\n    let _this = this;\n\n    //FLOW-OUT: this message will be sent to the runtime instance of SyncherManager -> _onLocalUnSubscribe\n    let unSubscribeMsg = {\n      type: 'unsubscribe', from: _this._owner, to: _this._syncher._subURL,\n      body: { resource: _this._url }\n    };\n\n    _this._bus.postMessage(unSubscribeMsg, (reply) => {\n      console.log('DataObjectObserver-UNSUBSCRIBE: ', reply);\n      if (reply.body.code === 200) {\n        _this._releaseListeners();\n        delete _this._syncher._observers[_this._url];\n      }\n    });\n  }\n\n  /**\n   * Register the change listeners sent by the reporter\n   * @param {string} filter - Filter that identifies the field (separated dot path). Accepts * at the end for a more unrestricted filtering.\n   * @param {function(event: MsgEvent)} callback\n   */\n  onChange(filter, callback) {\n    let key = filter;\n    let filterObj = {\n      type: FilterType.EXACT,\n      callback: callback\n    };\n\n    let idx = filter.indexOf('*');\n    if (idx === filter.length - 1) {\n      if (idx === 0) {\n        filterObj.type = FilterType.ANY;\n      } else {\n        filterObj.type = FilterType.START;\n        key = filter.substr(0, filter.length - 1);\n      }\n    }\n\n    this._filters[key] = filterObj;\n  }\n\n  _onFilter(event) {\n    let _this = this;\n\n    Object.keys(_this._filters).forEach((key) => {\n      let filter = _this._filters[key];\n      if (filter.type === FilterType.ANY) {\n        //match anything\n        filter.callback(event);\n      } else if (filter.type === FilterType.START) {\n        //if starts with filter...\n        if (event.field.indexOf(key) === 0) {\n          filter.callback(event);\n        }\n      } else if (filter.type === FilterType.EXACT) {\n        //exact match\n        if (event.field === key) {\n          filter.callback(event);\n        }\n      }\n    });\n  }\n}\n\nexport default DataObjectObserver;\n"],"sourceRoot":"/source/"}