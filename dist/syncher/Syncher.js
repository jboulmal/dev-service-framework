"use strict";function _interopRequireDefault(e){return e&&e.__esModule?e:{"default":e}}function _classCallCheck(e,o){if(!(e instanceof o))throw new TypeError("Cannot call a class as a function")}Object.defineProperty(exports,"__esModule",{value:!0});var _createClass=function(){function e(e,o){for(var r=0;r<o.length;r++){var t=o[r];t.enumerable=t.enumerable||!1,t.configurable=!0,"value"in t&&(t.writable=!0),Object.defineProperty(e,t.key,t)}}return function(o,r,t){return r&&e(o.prototype,r),t&&e(o,t),o}}(),_DataObjectReporter=require("./DataObjectReporter"),_DataObjectReporter2=_interopRequireDefault(_DataObjectReporter),_DataObjectObserver=require("./DataObjectObserver"),_DataObjectObserver2=_interopRequireDefault(_DataObjectObserver),_DataProvisional=require("./DataProvisional"),_DataProvisional2=_interopRequireDefault(_DataProvisional),Syncher=function(){function e(o,r,t){_classCallCheck(this,e);var n=this;n._owner=o,n._bus=r,n._subURL=t.runtimeURL+"/sm",n._reporters={},n._observers={},n._provisionals={},r.addListener(o,function(e){if(e.from!==o)switch(console.log("Syncher-RCV: ",e),e.type){case"forward":n._onForward(e);break;case"create":n._onRemoteCreate(e);break;case"delete":n._onRemoteDelete(e)}})}return _createClass(e,[{key:"create",value:function(e,o,r){var t=this;r.reporter=t._owner,r.schema=e;var n={type:"create",from:t._owner,to:t._subURL,body:{schema:e,value:r,authorise:o}};return new Promise(function(o,s){t._bus.postMessage(n,function(n){if(console.log("create-response: ",n),200===n.body.code){var a=n.body.resource,i=new _DataObjectReporter2["default"](t,a,e,"on",r,n.body.childrenResources);t._reporters[a]=i,o(i)}else s(n.body.desc)})})}},{key:"subscribe",value:function(e,o){var r=this,t={type:"subscribe",from:r._owner,to:r._subURL,body:{schema:e,resource:o}};return new Promise(function(n,s){r._bus.postMessage(t,function(t){console.log("subscribe-response: ",t);var a=r._provisionals[o];if(delete r._provisionals[o],a&&a._releaseListeners(),t.body.code<200)a=new _DataProvisional2["default"](r._owner,o,r._bus,t.body.childrenResources),r._provisionals[o]=a;else if(200===t.body.code){var i=new _DataObjectObserver2["default"](r,o,e,"on",t.body.value,a.children,t.body.version);r._observers[o]=i,n(i),a.apply(i)}else s(t.body.desc)})})}},{key:"read",value:function(e){var o=this,r={type:"read",from:o._owner,to:e};return new Promise(function(e,t){o._bus.postMessage(r,function(o){console.log("read-response: ",o),200===o.body.code?e(o.body.value):t(o.body.desc)})})}},{key:"onNotification",value:function(e){this._onNotificationHandler=e}},{key:"_onForward",value:function(e){var o=this,r=o._reporters[e.body.to];r._onForward(e)}},{key:"_onRemoteCreate",value:function(e){var o=this,r=e.from.slice(0,-13),t={type:e.type,from:e.body.source,url:r,schema:e.body.schema,value:e.body.value,identity:e.body.identity,ack:function(r){var t=200;r&&(t=r),o._bus.postMessage({id:e.id,type:"response",from:e.to,to:e.from,body:{code:t}})}};o._onNotificationHandler&&(console.log("NOTIFICATION-EVENT: ",t),o._onNotificationHandler(t))}},{key:"_onRemoteDelete",value:function(e){var o=this,r=e.body.resource,t=o._observers[r];if(t){var n={type:e.type,url:r,identity:e.body.identity,ack:function(r){var n=200;r&&(n=r),200===n&&t["delete"](),o._bus.postMessage({id:e.id,type:"response",from:e.to,to:e.from,body:{code:n,source:o._owner}})}};o._onNotificationHandler&&(console.log("NOTIFICATION-EVENT: ",n),o._onNotificationHandler(n))}else o._bus.postMessage({id:e.id,type:"response",from:e.to,to:e.from,body:{code:404,source:o._owner}})}},{key:"owner",get:function(){return this._owner}},{key:"reporters",get:function(){return this._reporters}},{key:"observers",get:function(){return this._observers}}]),e}();exports["default"]=Syncher,module.exports=exports["default"];
//# sourceMappingURL=Syncher.js.map
