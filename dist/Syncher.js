/**
* Copyright 2016 PT Inovação e Sistemas SA
* Copyright 2016 INESC-ID
* Copyright 2016 QUOBIS NETWORKS SL
* Copyright 2016 FRAUNHOFER-GESELLSCHAFT ZUR FOERDERUNG DER ANGEWANDTEN FORSCHUNG E.V
* Copyright 2016 ORANGE SA
* Copyright 2016 Deutsche Telekom AG
* Copyright 2016 Apizee
* Copyright 2016 TECHNISCHE UNIVERSITAT BERLIN
*
* Licensed under the Apache License, Version 2.0 (the "License");
* you may not use this file except in compliance with the License.
* You may obtain a copy of the License at
*
*   http://www.apache.org/licenses/LICENSE-2.0
*
* Unless required by applicable law or agreed to in writing, software
* distributed under the License is distributed on an "AS IS" BASIS,
* WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
* See the License for the specific language governing permissions and
* limitations under the License.
**/

// Distribution file for Syncher.js 
// version: 0.2.0

!function(e){if("object"==typeof exports&&"undefined"!=typeof module)module.exports=e();else if("function"==typeof define&&define.amd)define([],e);else{var t;t="undefined"!=typeof window?window:"undefined"!=typeof global?global:"undefined"!=typeof self?self:this,t.Syncher=e()}}(function(){return function e(t,n,r){function o(s,a){if(!n[s]){if(!t[s]){var u="function"==typeof require&&require;if(!a&&u)return u(s,!0);if(i)return i(s,!0);var c=new Error("Cannot find module '"+s+"'");throw c.code="MODULE_NOT_FOUND",c}var l=n[s]={exports:{}};t[s][0].call(l.exports,function(e){var n=t[s][1][e];return o(n?n:e)},l,l.exports,e,t,n,r)}return n[s].exports}for(var i="function"==typeof require&&require,s=0;s<r.length;s++)o(r[s]);return o}({1:[function(e,t,n){Object.observe&&!Array.observe&&function(e,t){"use strict";var n=e.getNotifier,r="performChange",o="_original",i="splice",s={push:function u(e){var t=arguments,s=u[o].apply(this,t);return n(this)[r](i,function(){return{index:s-t.length,addedCount:t.length,removed:[]}}),s},unshift:function c(e){var t=arguments,s=c[o].apply(this,t);return n(this)[r](i,function(){return{index:0,addedCount:t.length,removed:[]}}),s},pop:function l(){var e=this.length,t=l[o].call(this);return this.length!==e&&n(this)[r](i,function(){return{index:this.length,addedCount:0,removed:[t]}},this),t},shift:function f(){var e=this.length,t=f[o].call(this);return this.length!==e&&n(this)[r](i,function(){return{index:0,addedCount:0,removed:[t]}},this),t},splice:function d(e,t){var s=arguments,a=d[o].apply(this,s);return(a.length||s.length>2)&&n(this)[r](i,function(){return{index:e,addedCount:s.length-2,removed:a}},this),a}};for(var a in s)s[a][o]=t.prototype[a],t.prototype[a]=s[a];t.observe=function(t,n){return e.observe(t,n,["add","update","delete",i])},t.unobserve=e.unobserve}(Object,Array)},{}],2:[function(e,t,n){window.MutationObserver=window.MutationObserver||window.WebKitMutationObserver||function(e){function t(e){this.g=[],this.k=e}function n(e){!function n(){var r=e.takeRecords();r.length&&e.k(r,e),e.f=setTimeout(n,t._period)}()}function r(t){var n,r={type:null,target:null,addedNodes:[],removedNodes:[],previousSibling:null,nextSibling:null,attributeName:null,attributeNamespace:null,oldValue:null};for(n in t)r[n]!==e&&t[n]!==e&&(r[n]=t[n]);return r}function o(e,t){var n=a(e,t);return function(r){var o,u=r.length;t.a&&n.a&&i(r,e,n.a,t.d),(t.b||t.e)&&(o=s(r,e,n,t)),(o||r.length!==u)&&(n=a(e,t))}}function i(t,n,o,i){for(var s,a,u={},c=n.attributes,l=c.length;l--;)s=c[l],a=s.name,i&&i[a]===e||(s.value!==o[a]&&t.push(r({type:"attributes",target:n,attributeName:a,oldValue:o[a],attributeNamespace:s.namespaceURI})),u[a]=!0);for(a in o)u[a]||t.push(r({target:n,type:"attributes",attributeName:a,oldValue:o[a]}))}function s(t,n,o,s){function a(e,n,o,a,u){var l=e.length-1;u=-~((l-u)/2);for(var f,d,p;p=e.pop();)f=o[p.h],d=a[p.i],s.b&&u&&Math.abs(p.h-p.i)>=l&&(t.push(r({type:"childList",target:n,addedNodes:[f],removedNodes:[f],nextSibling:f.nextSibling,previousSibling:f.previousSibling})),u--),s.a&&d.a&&i(t,f,d.a,s.d),s.c&&3===f.nodeType&&f.nodeValue!==d.c&&t.push(r({type:"characterData",target:f})),s.e&&c(f,d)}function c(n,o){for(var d,p,b,h,v,y=n.childNodes,_=o.b,g=y.length,O=_?_.length:0,j=0,m=0,w=0;g>m||O>w;)h=y[m],v=(b=_[w])&&b.j,h===v?(s.a&&b.a&&i(t,h,b.a,s.d),s.c&&b.c!==e&&h.nodeValue!==b.c&&t.push(r({type:"characterData",target:h})),p&&a(p,n,y,_,j),s.e&&(h.childNodes.length||b.b&&b.b.length)&&c(h,b),m++,w++):(l=!0,d||(d={},p=[]),h&&(d[b=u(h)]||(d[b]=!0,-1===(b=f(_,h,w,"j"))?s.b&&(t.push(r({type:"childList",target:n,addedNodes:[h],nextSibling:h.nextSibling,previousSibling:h.previousSibling})),j++):p.push({h:m,i:b})),m++),v&&v!==y[m]&&(d[b=u(v)]||(d[b]=!0,-1===(b=f(y,v,m))?s.b&&(t.push(r({type:"childList",target:o.j,removedNodes:[v],nextSibling:_[w+1],previousSibling:_[w-1]})),j--):p.push({h:b,i:w})),w++));p&&a(p,n,y,_,j)}var l;return c(n,o),l}function a(e,t){var n=!0;return function r(e){var o={j:e};return!t.c||3!==e.nodeType&&8!==e.nodeType?(t.a&&n&&1===e.nodeType&&(o.a=l(e.attributes,function(e,n){return t.d&&!t.d[n.name]||(e[n.name]=n.value),e})),n&&(t.b||t.c||t.a&&t.e)&&(o.b=c(e.childNodes,r)),n=t.e):o.c=e.nodeValue,o}(e)}function u(e){try{return e.id||(e.mo_id=e.mo_id||d++)}catch(t){try{return e.nodeValue}catch(n){return d++}}}function c(e,t){for(var n=[],r=0;r<e.length;r++)n[r]=t(e[r],r,e);return n}function l(e,t){for(var n={},r=0;r<e.length;r++)n=t(n,e[r],r,e);return n}function f(e,t,n,r){for(;n<e.length;n++)if((r?e[n][r]:e[n])===t)return n;return-1}t._period=30,t.prototype={observe:function(e,t){for(var r={a:!!(t.attributes||t.attributeFilter||t.attributeOldValue),b:!!t.childList,e:!!t.subtree,c:!(!t.characterData&&!t.characterDataOldValue)},i=this.g,s=0;s<i.length;s++)i[s].m===e&&i.splice(s,1);t.attributeFilter&&(r.d=l(t.attributeFilter,function(e,t){return e[t]=!0,e})),i.push({m:e,l:o(e,r)}),this.f||n(this)},takeRecords:function(){for(var e=[],t=this.g,n=0;n<t.length;n++)t[n].l(e);return e},disconnect:function(){this.g=[],clearTimeout(this.f),this.f=null}};var d=1;return t}(void 0)},{}],3:[function(e,t,n){Object.observe||function(e,t,n,r){"use strict";var o,i,s=["add","update","delete","reconfigure","setPrototype","preventExtensions"],a=t.isArray||function(e){return function(t){return"[object Array]"===e.call(t)}}(e.prototype.toString),u=t.prototype.indexOf?t.indexOf||function(e,n,r){return t.prototype.indexOf.call(e,n,r)}:function(e,t,n){for(var r=n||0;r<e.length;r++)if(e[r]===t)return r;return-1},c=n.Map!==r&&Map.prototype.forEach?function(){return new Map}:function(){var e=[],t=[];return{size:0,has:function(t){return u(e,t)>-1},get:function(n){return t[u(e,n)]},set:function(n,r){var o=u(e,n);-1===o?(e.push(n),t.push(r),this.size++):t[o]=r},"delete":function(n){var r=u(e,n);r>-1&&(e.splice(r,1),t.splice(r,1),this.size--)},forEach:function(n){for(var r=0;r<e.length;r++)n.call(arguments[1],t[r],e[r],this)}}},l=e.getOwnPropertyNames?function(){var t=e.getOwnPropertyNames;try{arguments.callee}catch(n){var r=(t(u).join(" ")+" ").replace(/prototype |length |name /g,"").slice(0,-1).split(" ");r.length&&(t=function(t){var n=e.getOwnPropertyNames(t);if("function"==typeof t)for(var o,i=0;i<r.length;)(o=u(n,r[i++]))>-1&&n.splice(o,1);return n})}return t}():function(t){var n,r,o=[];if("hasOwnProperty"in t)for(n in t)t.hasOwnProperty(n)&&o.push(n);else{r=e.hasOwnProperty;for(n in t)r.call(t,n)&&o.push(n)}return a(t)&&o.push("length"),o},f=e.getPrototypeOf,d=e.defineProperties&&e.getOwnPropertyDescriptor,p=n.requestAnimationFrame||n.webkitRequestAnimationFrame||function(){var e=+new Date,t=e;return function(n){return setTimeout(function(){n((t=+new Date)-e)},17)}}(),b=function(e,t,n){var r=o.get(e);r?(v(r,e),O(e,r,t,n)):(r=h(e),O(e,r,t,n),1===o.size&&p(y))},h=function(t,n){var r,i=l(t),s=[],a=0,n={handlers:c(),frozen:e.isFrozen?e.isFrozen(t):!1,extensible:e.isExtensible?e.isExtensible(t):!0,proto:f&&f(t),properties:i,values:s,notifier:g(t,n)};if(d)for(r=n.descriptors=[];a<i.length;)r[a]=d(t,i[a]),s[a]=t[i[a++]];else for(;a<i.length;)s[a]=t[i[a++]];return o.set(t,n),n},v=function(){var t=d?function(e,t,n,r,o){var i=t.properties[n],s=e[i],a=t.values[n],u=t.descriptors[n];"value"in o&&(a===s?0===a&&1/a!==1/s:a===a||s===s)&&(j(e,t,{name:i,type:"update",object:e,oldValue:a},r),t.values[n]=s),!u.configurable||o.configurable&&o.writable===u.writable&&o.enumerable===u.enumerable&&o.get===u.get&&o.set===u.set||(j(e,t,{name:i,type:"reconfigure",object:e,oldValue:a},r),t.descriptors[n]=o)}:function(e,t,n,r){var o=t.properties[n],i=e[o],s=t.values[n];(s===i?0===s&&1/s!==1/i:s===s||i===i)&&(j(e,t,{name:o,type:"update",object:e,oldValue:s},r),t.values[n]=i)},n=d?function(e,n,r,o,i){for(var s,a=n.length;r&&a--;)null!==n[a]&&(s=d(e,n[a]),r--,s?t(e,o,a,i,s):(j(e,o,{name:n[a],type:"delete",object:e,oldValue:o.values[a]},i),o.properties.splice(a,1),o.values.splice(a,1),o.descriptors.splice(a,1)))}:function(e,t,n,r,o){for(var i=t.length;n&&i--;)null!==t[i]&&(j(e,r,{name:t[i],type:"delete",object:e,oldValue:r.values[i]},o),r.properties.splice(i,1),r.values.splice(i,1),n--)};return function(r,o,i){if(r.handlers.size&&!r.frozen){var s,a,c,p,b,h,v,y,_=r.values,g=r.descriptors,O=0;if(r.extensible)if(s=r.properties.slice(),a=s.length,c=l(o),g){for(;O<c.length;)b=c[O++],p=u(s,b),y=d(o,b),-1===p?(j(o,r,{name:b,type:"add",object:o},i),r.properties.push(b),_.push(o[b]),g.push(y)):(s[p]=null,a--,t(o,r,p,i,y));n(o,s,a,r,i),e.isExtensible(o)||(r.extensible=!1,j(o,r,{type:"preventExtensions",object:o},i),r.frozen=e.isFrozen(o))}else{for(;O<c.length;)b=c[O++],p=u(s,b),h=o[b],-1===p?(j(o,r,{name:b,type:"add",object:o},i),r.properties.push(b),_.push(h)):(s[p]=null,a--,t(o,r,p,i));n(o,s,a,r,i)}else if(!r.frozen){for(;O<s.length;O++)b=s[O],t(o,r,O,i,d(o,b));e.isFrozen(o)&&(r.frozen=!0)}f&&(v=f(o),v!==r.proto&&(j(o,r,{type:"setPrototype",name:"__proto__",object:o,oldValue:r.proto}),r.proto=v))}}}(),y=function(){o.size&&(o.forEach(v),i.forEach(_),p(y))},_=function(e,t){var n=e.changeRecords;n.length&&(e.changeRecords=[],t(n))},g=function(e,t){return arguments.length<2&&(t=o.get(e)),t&&t.notifier||{notify:function(t){t.type;var n=o.get(e);if(n){var r,i={object:e};for(r in t)"object"!==r&&(i[r]=t[r]);j(e,n,i)}},performChange:function(t,n){if("string"!=typeof t)throw new TypeError("Invalid non-string changeType");if("function"!=typeof n)throw new TypeError("Cannot perform non-function");var i,s,a=o.get(e),u=arguments[2],c=u===r?n():n.call(u);if(a&&v(a,e,t),a&&c&&"object"==typeof c){s={object:e,type:t};for(i in c)"object"!==i&&"type"!==i&&(s[i]=c[i]);j(e,a,s)}}}},O=function(e,t,n,r){var o=i.get(n);o||i.set(n,o={observed:c(),changeRecords:[]}),o.observed.set(e,{acceptList:r.slice(),data:t}),t.handlers.set(n,o)},j=function(e,t,n,r){t.handlers.forEach(function(t){var o=t.observed.get(e).acceptList;("string"!=typeof r||-1===u(o,r))&&u(o,n.type)>-1&&t.changeRecords.push(n)})};o=c(),i=c(),e.observe=function(t,n,o){if(!t||"object"!=typeof t&&"function"!=typeof t)throw new TypeError("Object.observe cannot observe non-object");if("function"!=typeof n)throw new TypeError("Object.observe cannot deliver to non-function");if(e.isFrozen&&e.isFrozen(n))throw new TypeError("Object.observe cannot deliver to a frozen function object");if(o===r)o=s;else if(!o||"object"!=typeof o)throw new TypeError("Third argument to Object.observe must be an array of strings.");return b(t,n,o),t},e.unobserve=function(e,t){if(null===e||"object"!=typeof e&&"function"!=typeof e)throw new TypeError("Object.unobserve cannot unobserve non-object");if("function"!=typeof t)throw new TypeError("Object.unobserve cannot deliver to non-function");var n,r=i.get(t);return r&&(n=r.observed.get(e))&&(r.observed.forEach(function(e,t){v(e.data,t)}),p(function(){_(r,t)}),1===r.observed.size&&r.observed.has(e)?i["delete"](t):r.observed["delete"](e),1===n.data.handlers.size?o["delete"](e):n.data.handlers["delete"](t)),e},e.getNotifier=function(t){if(null===t||"object"!=typeof t&&"function"!=typeof t)throw new TypeError("Object.getNotifier cannot getNotifier non-object");return e.isFrozen&&e.isFrozen(t)?null:g(t)},e.deliverChangeRecords=function(e){if("function"!=typeof e)throw new TypeError("Object.deliverChangeRecords cannot deliver to non-function");var t=i.get(e);t&&(t.observed.forEach(function(e,t){v(e.data,t)}),_(t,e))}}(Object,Array,this)},{}],4:[function(e,t,n){"use strict";function r(e){return e&&e.__esModule?e:{"default":e}}Object.defineProperty(n,"__esModule",{value:!0}),n.DataObjectObserver=n.DataObjectReporter=n.Syncher=void 0,e("mutationobserver-shim"),e("object.observe"),e("array.observe");var o=e("./syncher/Syncher"),i=r(o),s=e("./syncher/DataObjectReporter"),a=r(s),u=e("./syncher/DataObjectObserver"),c=r(u);n.Syncher=i["default"],n.DataObjectReporter=a["default"],n.DataObjectObserver=c["default"]},{"./syncher/DataObjectObserver":7,"./syncher/DataObjectReporter":8,"./syncher/Syncher":11,"array.observe":1,"mutationobserver-shim":2,"object.observe":3}],5:[function(e,t,n){"use strict";function r(e){return e&&e.__esModule?e:{"default":e}}function o(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}Object.defineProperty(n,"__esModule",{value:!0});var i=function(){function e(e,t){for(var n=0;n<t.length;n++){var r=t[n];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(e,r.key,r)}}return function(t,n,r){return n&&e(t.prototype,n),r&&e(t,r),t}}(),s=e("./SyncObject"),a=r(s),u=e("./DataObjectChild"),c=r(u),l=e("../utils/utils.js"),f=function(){function e(t,n,r,i,s,u){o(this,e);var c=this;c._syncher=t,c._url=n,c._schema=r,c._status=i,c._syncObj=new a["default"](s),c._childrens=u,c._version=0,c._childId=0,c._childrenObjects={},c._childrenListeners=[],c._owner=t._owner,c._bus=t._bus}return i(e,[{key:"_allocateListeners",value:function(){var e=this,t=this,n=t._url+"/children/";t._childrens&&t._childrens.forEach(function(r){var o=n+r,i=t._bus.addListener(o,function(n){if(n.from!==e._owner)switch(console.log("DataObject-Children-RCV: ",n),n.type){case"create":t._onChildrenCreate(n);break;case"delete":console.log(n);break;default:t._changeChildren(n)}});t._childrenListeners.push(i)})}},{key:"_releaseListeners",value:function(){var e=this;e._childrenListeners.forEach(function(e){e.remove()}),Object.keys(e._childrenObjects).forEach(function(t){e._childrenObjects[t]._releaseListeners()})}},{key:"pause",value:function(){throw"Not implemented"}},{key:"resume",value:function(){throw"Not implemented"}},{key:"stop",value:function(){throw"Not implemented"}},{key:"addChildren",value:function(e,t){var n=this;n._childId++;var r=n._owner+"#"+n._childId,o=n._url+"/children/"+e,i={type:"create",from:n._owner,to:o,body:{resource:r,value:t}};return new Promise(function(e){var s=n._bus.postMessage(i);console.log("create-reporter-child( "+n._owner+" ): ",i);var a=new c["default"](n,r,t,n._owner,s);a.onChange(function(e){n._onChange(e,{path:o,childId:r})}),n._childrenObjects[r]=a,e(a)})}},{key:"onAddChildren",value:function(e){this._onAddChildrenHandler=e}},{key:"_onChildrenCreate",value:function(e){var t=this,n=e.body.resource;console.log("create-observer-child( "+t._owner+" ): ",e);var r=new c["default"](t,n,e.body.value);t._childrenObjects[n]=r,setTimeout(function(){t._bus.postMessage({id:e.id,type:"response",from:e.to,to:e.from,body:{code:200,source:t._owner}})});var o={type:e.type,from:e.from,url:e.to,value:e.body.value,childId:n,identity:e.body.idToken};t._onAddChildrenHandler&&(console.log("ADD-CHILDREN-EVENT: ",o),t._onAddChildrenHandler(o))}},{key:"_onChange",value:function(e,t){var n=this;if(n._version++,"on"===n._status){var r={type:"update",from:n._url,to:n._url+"/changes",body:{version:n._version,source:n._owner,attribute:e.field}};e.oType===s.ObjectType.OBJECT?e.cType!==s.ChangeType.REMOVE&&(r.body.value=e.data):(r.body.attributeType=e.oType,r.body.value=e.data,e.cType!==s.ChangeType.UPDATE&&(r.body.operation=e.cType)),t&&(r.to=t.path,r.body.resource=t.childId),n._bus.postMessage(r)}}},{key:"_changeObject",value:function(e,t){var n=this;if(n._version+1===t.body.version){n._version++;var r=t.body.attribute,o=(0,l.deepClone)(t.body.value),i=e.findBefore(r);if(t.body.attributeType===s.ObjectType.ARRAY)if(t.body.operation===s.ChangeType.ADD){var a=i.obj,u=i.last;Array.prototype.splice.apply(a,[u,0].concat(o))}else if(t.body.operation===s.ChangeType.REMOVE){var c=i.obj,f=i.last;c.splice(f,o)}else i.obj[i.last]=o;else t.body.value?i.obj[i.last]=o:delete i.obj[i.last]}else console.log("UNSYNCHRONIZED VERSION: (data => "+n._version+", msg => "+t.body.version+")")}},{key:"_changeChildren",value:function(e){var t=this;console.log("Change children: ",t._owner,e);var n=e.body.resource,r=t._childrenObjects[n];r?t._changeObject(r._syncObj,e):console.log("No children found for: ",n)}},{key:"url",get:function(){return this._url}},{key:"schema",get:function(){return this._schema}},{key:"status",get:function(){return this._status}},{key:"data",get:function(){return this._syncObj.data}},{key:"childrens",get:function(){return this._childrenObjects}}]),e}();n["default"]=f,t.exports=n["default"]},{"../utils/utils.js":12,"./DataObjectChild":6,"./SyncObject":10}],6:[function(e,t,n){"use strict";function r(e){return e&&e.__esModule?e:{"default":e}}function o(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}Object.defineProperty(n,"__esModule",{value:!0});var i=function(){function e(e,t){for(var n=0;n<t.length;n++){var r=t[n];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(e,r.key,r)}}return function(t,n,r){return n&&e(t.prototype,n),r&&e(t,r),t}}(),s=e("./SyncObject"),a=r(s),u=function(){function e(t,n,r,i,s){o(this,e);var u=this;u._parent=t,u._childId=n,u._owner=i,u._msgId=s,u._syncObj=new a["default"](r),u._bus=t._bus,u._allocateListeners()}return i(e,[{key:"_allocateListeners",value:function(){var e=this;e._owner&&(e._listener=e._bus.addListener(e._owner,function(t){"response"===t.type&&t.id===e._msgId&&(console.log("DataObjectChild.onResponse:",t),e._onResponse(t))}))}},{key:"_releaseListeners",value:function(){var e=this;e._listener&&e._listener.remove()}},{key:"delete",value:function(){var e=this;delete e._parent._children[e._childId],e._releaseListeners()}},{key:"onChange",value:function(e){this._syncObj.observe(function(t){e(t)})}},{key:"onResponse",value:function(e){this._onResponseHandler=e}},{key:"_onResponse",value:function(e){var t=this,n={type:e.type,url:e.body.source,code:e.body.code};t._onResponseHandler&&t._onResponseHandler(n)}},{key:"childId",get:function(){return this._childId}},{key:"data",get:function(){return this._syncObj.data}}]),e}();n["default"]=u,t.exports=n["default"]},{"./SyncObject":10}],7:[function(e,t,n){"use strict";function r(e){return e&&e.__esModule?e:{"default":e}}function o(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}function i(e,t){if(!e)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return!t||"object"!=typeof t&&"function"!=typeof t?e:t}function s(e,t){if("function"!=typeof t&&null!==t)throw new TypeError("Super expression must either be null or a function, not "+typeof t);e.prototype=Object.create(t&&t.prototype,{constructor:{value:e,enumerable:!1,writable:!0,configurable:!0}}),t&&(Object.setPrototypeOf?Object.setPrototypeOf(e,t):e.__proto__=t)}Object.defineProperty(n,"__esModule",{value:!0});var a=function(){function e(e,t){for(var n=0;n<t.length;n++){var r=t[n];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(e,r.key,r)}}return function(t,n,r){return n&&e(t.prototype,n),r&&e(t,r),t}}(),u=function h(e,t,n){null===e&&(e=Function.prototype);var r=Object.getOwnPropertyDescriptor(e,t);if(void 0===r){var o=Object.getPrototypeOf(e);return null===o?void 0:h(o,t,n)}if("value"in r)return r.value;var i=r.get;if(void 0!==i)return i.call(n)},c=e("./DataObject"),l=r(c),f=e("./DataObjectChild"),d=r(f),p={ANY:"any",START:"start",EXACT:"exact"},b=function(e){function t(e,n,r,s,a,u,c){o(this,t);var l=i(this,Object.getPrototypeOf(t).call(this,e,n,r,s,a.data,u)),f=l;return f._version=c,f._filters={},f._syncObj.observe(function(e){f._onFilter(e)}),Object.keys(a.childrens).forEach(function(e){var t=a.childrens[e];f._childrenObjects[e]=new d["default"](f,e,t)}),f._allocateListeners(),l}return s(t,e),a(t,[{key:"_allocateListeners",value:function(){u(Object.getPrototypeOf(t.prototype),"_allocateListeners",this).call(this);var e=this;e._changeListener=e._bus.addListener(e._url+"/changes",function(t){"update"===t.type&&(console.log("DataObjectObserver-"+e._url+"-RCV: ",t),e._changeObject(e._syncObj,t))})}},{key:"_releaseListeners",value:function(){u(Object.getPrototypeOf(t.prototype),"_releaseListeners",this).call(this);var e=this;e._changeListener.remove()}},{key:"delete",value:function(){var e=this;e._releaseListeners(),delete e._syncher._observers[e._url]}},{key:"unsubscribe",value:function(){var e=this,t={type:"unsubscribe",from:e._owner,to:e._syncher._subURL,body:{resource:e._url}};e._bus.postMessage(t,function(t){console.log("DataObjectObserver-UNSUBSCRIBE: ",t),200===t.body.code&&(e._releaseListeners(),delete e._syncher._observers[e._url])})}},{key:"onChange",value:function(e,t){var n=e,r={type:p.EXACT,callback:t},o=e.indexOf("*");o===e.length-1&&(0===o?r.type=p.ANY:(r.type=p.START,n=e.substr(0,e.length-1))),this._filters[n]=r}},{key:"_onFilter",value:function(e){var t=this;Object.keys(t._filters).forEach(function(n){var r=t._filters[n];r.type===p.ANY?r.callback(e):r.type===p.START?0===e.field.indexOf(n)&&r.callback(e):r.type===p.EXACT&&e.field===n&&r.callback(e)})}}]),t}(l["default"]);n["default"]=b,t.exports=n["default"]},{"./DataObject":5,"./DataObjectChild":6}],8:[function(e,t,n){"use strict";function r(e){return e&&e.__esModule?e:{"default":e}}function o(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}function i(e,t){if(!e)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return!t||"object"!=typeof t&&"function"!=typeof t?e:t}function s(e,t){if("function"!=typeof t&&null!==t)throw new TypeError("Super expression must either be null or a function, not "+typeof t);e.prototype=Object.create(t&&t.prototype,{constructor:{value:e,enumerable:!1,writable:!0,configurable:!0}}),t&&(Object.setPrototypeOf?Object.setPrototypeOf(e,t):e.__proto__=t)}Object.defineProperty(n,"__esModule",{value:!0});var a=function(){function e(e,t){for(var n=0;n<t.length;n++){var r=t[n];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(e,r.key,r)}}return function(t,n,r){return n&&e(t.prototype,n),r&&e(t,r),t}}(),u=function p(e,t,n){null===e&&(e=Function.prototype);var r=Object.getOwnPropertyDescriptor(e,t);if(void 0===r){var o=Object.getPrototypeOf(e);return null===o?void 0:p(o,t,n)}if("value"in r)return r.value;var i=r.get;if(void 0!==i)return i.call(n)},c=e("./DataObject"),l=r(c),f=e("../utils/utils.js"),d=function(e){function t(e,n,r,s,a,u){o(this,t);var c=i(this,Object.getPrototypeOf(t).call(this,e,n,r,s,a,u)),l=c;return l._subscriptions={},l._syncObj.observe(function(e){console.log("DataObjectReporter-"+n+"-SEND: ",e),l._onChange(e)}),l._allocateListeners(),c}return s(t,e),a(t,[{key:"_allocateListeners",value:function(){u(Object.getPrototypeOf(t.prototype),"_allocateListeners",this).call(this);var e=this;e._responseListener=e._bus.addListener(e._url,function(t){"response"===t.type&&e._onResponse(t)})}},{key:"_releaseListeners",value:function(){u(Object.getPrototypeOf(t.prototype),"_releaseListeners",this).call(this);var e=this;e._responseListener.remove()}},{key:"inviteObservers",value:function(e){var t=this,n={type:"create",from:t._syncher._owner,to:t._syncher._subURL,body:{resource:t._url,schema:t._schema,value:t._syncObj.data,authorise:e}};t._bus.postMessage(n)}},{key:"delete",value:function(){var e=this,t={type:"delete",from:e._owner,to:e._syncher._subURL,body:{resource:e._url}};e._bus.postMessage(t,function(t){console.log("DataObjectReporter-DELETE: ",t),200===t.body.code&&(e._releaseListeners(),delete e._syncher._reporters[e._url])})}},{key:"onSubscription",value:function(e){this._onSubscriptionHandler=e}},{key:"onResponse",value:function(e){this._onResponseHandler=e}},{key:"_onForward",value:function(e){var t=this;switch(console.log("DataObjectReporter-RCV: ",e),e.body.type){case"subscribe":t._onSubscribe(e);break;case"unsubscribe":t._onUnSubscribe(e)}}},{key:"_onSubscribe",value:function(e){var t=this,n=e.body.from,r={type:e.body.type,url:n,accept:function(){var r={url:n,status:"on"};t._subscriptions[n]=r;var o={};return Object.keys(t._childrenObjects).forEach(function(e){var n=t._childrenObjects[e].data;o[e]=(0,f.deepClone)(n)}),t._bus.postMessage({id:e.id,type:"response",from:e.to,to:e.from,body:{code:200,schema:t._schema,version:t._version,value:{data:(0,f.deepClone)(t.data),childrens:o}}}),r},reject:function(n){t._bus.postMessage({id:e.id,type:"response",from:e.to,to:e.from,body:{code:403,desc:n}})}};t._onSubscriptionHandler&&(console.log("SUBSCRIPTION-EVENT: ",r),t._onSubscriptionHandler(r))}},{key:"_onUnSubscribe",value:function(e){var t=this,n=e.body.from,r=t._subscriptions[n];delete t._subscriptions[n];var o={type:e.body.type,url:n,object:r};t._onSubscriptionHandler&&(console.log("UN-SUBSCRIPTION-EVENT: ",o),t._onSubscriptionHandler(o))}},{key:"_onResponse",value:function(e){var t=this,n={type:e.type,url:e.from,code:e.body.code};t._onResponseHandler&&(console.log("RESPONSE-EVENT: ",n),t._onResponseHandler(n))}},{key:"subscriptions",get:function(){return this._subscriptions}}]),t}(l["default"]);n["default"]=d,t.exports=n["default"]},{"../utils/utils.js":12,"./DataObject":5}],9:[function(e,t,n){"use strict";function r(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}Object.defineProperty(n,"__esModule",{value:!0});var o=function(){function e(e,t){for(var n=0;n<t.length;n++){var r=t[n];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(e,r.key,r)}}return function(t,n,r){return n&&e(t.prototype,n),r&&e(t,r),t}}(),i=function(){function e(t,n,o,i){r(this,e);var s=this;s._owner=t,s._url=n,s._bus=o,s._children=i,s._changes=[],s._allocateListeners()}return o(e,[{key:"_allocateListeners",value:function(){var e=this;e._listener=e._bus.addListener(e._url,function(t){console.log("DataProvisional-"+e._url+"-RCV: ",t),e._changes.push(t)})}},{key:"_releaseListeners",value:function(){var e=this;e._listener.remove()}},{key:"apply",value:function(e){var t=this;t._changes.forEach(function(t){e._changeObject(e._syncObj,t)})}},{key:"children",get:function(){return this._children}}]),e}();n["default"]=i,t.exports=n["default"]},{}],10:[function(e,t,n){"use strict";function r(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}Object.defineProperty(n,"__esModule",{value:!0}),n.ObjectType=n.ChangeType=void 0;var o=function(){function e(e,t){for(var n=0;n<t.length;n++){var r=t[n];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(e,r.key,r)}}return function(t,n,r){return n&&e(t.prototype,n),r&&e(t,r),t}}(),i=e("../utils/utils.js"),s=function(){function e(t){r(this,e);var n=this;n._observers=[],n._filters={},t?n._data=(0,i.deepClone)(t):n._data={},n._internalObserve(new a,n._data)}return o(e,[{key:"observe",value:function(e){this._observers.push(e)}},{key:"find",value:function(e){var t=e.split(".");return this._findWithSplit(t)}},{key:"findBefore",value:function(e){var t={},n=e.split(".");return t.last=n.pop(),t.obj=this._findWithSplit(n),t}},{key:"_findWithSplit",value:function(e){var t=this._data;return e.forEach(function(e){t=t[e]}),t}},{key:"_fireEvent",value:function(e){this._observers.forEach(function(t){t(e)})}},{key:"_isObservable",value:function(e){return e.constructor===Object||e.constructor===Array}},{key:"_internalObserve",value:function(e,t){var n=this;if(n._isObservable(t)){var r=function(t){n._onChanges(e,t)};if(t.constructor===Object){Object.observe(t,r);for(var o in t)n._isObservable(t[o])&&n._internalObserve(e["new"](o),t[o])}else if(t.constructor===Array){Array.observe(t,r);for(var i in t)if(n._isObservable(t[i])){var s=e["new"](new u(t[i],i));n._internalObserve(s,t[i])}}}}},{key:"_onChanges",value:function(e,t){var n=this;for(var r in t){var o=t[r].object,s=void 0;if(o.constructor===Object&&(s=l.OBJECT),o.constructor===Array&&(s=l.ARRAY),"splice"===t[r].type)!function(){var a=t[r].index,l=e["new"](""+a),f=l.toString(),d=t[r].removed.length;if(0!==d){var p=t[r].removed;p.forEach(function(t,r){n._isObservable(t)&&e.removeIndex(a+r)}),n._fireEvent({cType:c.REMOVE,oType:s,field:f,data:d})}var b=t[r].addedCount;if(0!==b){var h=o.slice(a,a+b);h.forEach(function(t,r){if(n._isObservable(t)){var o=e["new"](new u(t,a+r));n._internalObserve(o,t)}}),n._fireEvent({cType:c.ADD,oType:s,field:f,data:(0,i.deepClone)(h)})}a!==o.length-1&&e.reIndexFrom(o)}();else{var a=e["new"](t[r].name),f=a.toString();if(-1!==f.indexOf("Symbol"))continue;var d=o[t[r].name];"update"===t[r].type&&this._fireEvent({cType:c.UPDATE,oType:s,field:f,data:(0,i.deepClone)(d)}),"add"===t[r].type&&(this._internalObserve(a,d),this._fireEvent({cType:c.ADD,oType:s,field:f,data:(0,i.deepClone)(d)})),"delete"===t[r].type&&this._fireEvent({cType:c.REMOVE,oType:s,field:f})}}}},{key:"data",get:function(){return this._data}}]),e}(),a=function(){function e(){r(this,e),this._path=[],this._observables={}}return o(e,[{key:"removeIndex",value:function(e){delete this._observables[e]}},{key:"reIndexFrom",value:function(e){var t=this;Object.keys(this._observables).forEach(function(n){var r=t._observables[n],o=e.indexOf(r.obj);r.idx!=o&&(r.idx=o,delete t._observables[n],t._observables[o]=r)})}},{key:"new",value:function(e){e.constructor==u&&(this._observables[e.idx]=e);var t=this.clone();return t._path.push(e),t}},{key:"clone",value:function(){var t=new e;return this._path.forEach(function(e){t._path.push(e)}),t}},{key:"toString",value:function(){var e="";return this._path.forEach(function(t,n){0===n?e=t.toString():e+="."+t.toString()}),e}}]),e}(),u=function(){function e(t,n){r(this,e),this.obj=t,this.idx=n}return o(e,[{key:"toString",value:function(){return this.idx.toString()}}]),e}(),c=n.ChangeType={UPDATE:"update",ADD:"add",REMOVE:"remove"},l=n.ObjectType={OBJECT:"object",ARRAY:"array"};n["default"]=s},{"../utils/utils.js":12}],11:[function(e,t,n){"use strict";function r(e){return e&&e.__esModule?e:{"default":e}}function o(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}Object.defineProperty(n,"__esModule",{value:!0});var i=function(){function e(e,t){for(var n=0;n<t.length;n++){var r=t[n];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(e,r.key,r)}}return function(t,n,r){return n&&e(t.prototype,n),r&&e(t,r),t}}(),s=e("./DataObjectReporter"),a=r(s),u=e("./DataObjectObserver"),c=r(u),l=e("./DataProvisional"),f=r(l),d=function(){function e(t,n,r){o(this,e);var i=this;i._owner=t,i._bus=n,i._subURL=r.runtimeURL+"/sm",i._reporters={},i._observers={},i._provisionals={},n.addListener(t,function(e){if(e.from!==t)switch(console.log("Syncher-RCV: ",e),e.type){case"forward":i._onForward(e);break;case"create":i._onRemoteCreate(e);break;case"delete":i._onRemoteDelete(e)}})}return i(e,[{key:"create",value:function(e,t,n){var r=this,o={type:"create",from:r._owner,to:r._subURL,body:{schema:e,value:n,authorise:t}};return new Promise(function(t,i){r._bus.postMessage(o,function(o){if(console.log("create-response: ",o),200===o.body.code){var s=o.body.resource,u=new a["default"](r,s,e,"on",n,o.body.childrenResources);r._reporters[s]=u,t(u)}else i(o.body.desc)})})}},{key:"subscribe",value:function(e,t){var n=this,r={type:"subscribe",from:n._owner,to:n._subURL,body:{schema:e,resource:t}};return new Promise(function(o,i){n._bus.postMessage(r,function(r){console.log("subscribe-response: ",r);var s=n._provisionals[t];if(delete n._provisionals[t],s&&s._releaseListeners(),r.body.code<200)s=new f["default"](n._owner,t,n._bus,r.body.childrenResources),n._provisionals[t]=s;else if(200===r.body.code){var a=new c["default"](n,t,e,"on",r.body.value,s.children,r.body.version);n._observers[t]=a,o(a),s.apply(a)}else i(r.body.desc)})})}},{key:"onNotification",value:function(e){this._onNotificationHandler=e}},{key:"_onForward",value:function(e){var t=this,n=t._reporters[e.body.to];n._onForward(e)}},{key:"_onRemoteCreate",value:function(e){var t=this,n=e.from.slice(0,-13),r={type:e.type,from:e.body.source,url:n,schema:e.body.schema,value:e.body.value,identity:e.body.idToken,ack:function(n){var r=200;n&&(r=n),t._bus.postMessage({id:e.id,type:"response",from:e.to,to:e.from,body:{code:r}})}};t._onNotificationHandler&&(console.log("NOTIFICATION-EVENT: ",r),
t._onNotificationHandler(r))}},{key:"_onRemoteDelete",value:function(e){var t=this,n=e.body.resource,r=t._observers[n];if(r){var o={type:e.type,url:n,identity:e.body.idToken,ack:function(n){var o=200;n&&(o=n),200===o&&r["delete"](),t._bus.postMessage({id:e.id,type:"response",from:e.to,to:e.from,body:{code:o,source:t._owner}})}};t._onNotificationHandler&&(console.log("NOTIFICATION-EVENT: ",o),t._onNotificationHandler(o))}else t._bus.postMessage({id:e.id,type:"response",from:e.to,to:e.from,body:{code:404,source:t._owner}})}},{key:"owner",get:function(){return this._owner}},{key:"reporters",get:function(){return this._reporters}},{key:"observers",get:function(){return this._observers}}]),e}();n["default"]=d,t.exports=n["default"]},{"./DataObjectObserver":7,"./DataObjectReporter":8,"./DataProvisional":9}],12:[function(e,t,n){"use strict";function r(e){var t=/([a-zA-Z-]*):\/\/(?:\.)?([-a-zA-Z0-9@:%._\+~#=]{2,256})([-a-zA-Z0-9@:%._\+~#=\/]*)/gi,n="$1,$2,$3",r=e.replace(t,n).split(",");r[0]===e&&(r[0]="https",r[1]=e);var o={type:r[0],domain:r[1],identity:r[2]};return o}function o(e){return e?JSON.parse(JSON.stringify(e)):void 0}Object.defineProperty(n,"__esModule",{value:!0}),n.divideURL=r,n.deepClone=o},{}]},{},[4])(4)});