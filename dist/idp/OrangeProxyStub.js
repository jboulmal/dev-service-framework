"use strict";function _classCallCheck(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}function getProxyKey(){return new Promise(function(e,t){var n=new XMLHttpRequest;n.onreadystatechange=function(){if(4==n.readyState&&200==n.status){var r=JSON.parse(n.responseText);void 0!=r.error?t(r.error):e(r)}},n.open("GET",SOURCEURL+KEYPATH,!0),n.send()})}function getProxyID(){return new Promise(function(e,t){var n=new XMLHttpRequest;n.onreadystatechange=function(){if(4==n.readyState&&200==n.status){var r=JSON.parse(n.responseText);void 0!=r.error?t(r.error):e(r.key)}},n.open("GET",SOURCEURL+IDPATH,!0),n.send()})}function getIdAssertion(){return new Promise(function(e,t){var n=new XMLHttpRequest;n.onreadystatechange=function(){if(4==n.readyState&&200==n.status){var r=JSON.parse(n.responseText);void 0!=r.error?t(r.error):e(r.key)}},n.open("GET",SOURCEURL+IDPATH,!0),n.send()})}function str2ab(e){for(var t=new ArrayBuffer(e.length),n=new Uint8Array(t),r=0,o=e.length;r<o;r++)n[r]=e.charCodeAt(r);return t}function ab2str(e){return String.fromCharCode.apply(null,new Uint8Array(e))}function activate(e,t,n){return{name:"RethinkOidcProtoStub",instance:new RethinkOidcProtoStub(e,t,n)}}Object.defineProperty(exports,"__esModule",{value:!0});var _createClass=function(){function e(e,t){for(var n=0;n<t.length;n++){var r=t[n];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(e,r.key,r)}}return function(t,n,r){return n&&e(t.prototype,n),r&&e(t,r),t}}();exports["default"]=activate;var SOURCEURL="https://energyq.idp.rethink.orange-labs.fr",AUTHPATH="/proxy/authorize",VERIFYPATH="/proxy/verify",DONEPATH="/proxy/done",KEYPATH="/proxy/key",IDPATH="/proxy/id",PROXYTYPE="rethink-oidc",IDSCOPE="openid",FULLSCOPE="openid webrtc",TYPE="id_token token",idp_addr={domain:"https://energyq.idp.rethink.orange-labs.fr",protocol:PROXYTYPE};"undefined"==typeof console&&((void 0).console={log:function(){}});var idp={generateAssertion:function(e){return new Promise(function(t,n){return getProxyID().then(function(n){var r=SOURCEURL+AUTHPATH+"?scope="+FULLSCOPE+"&client_id="+n+"&redirect_uri="+SOURCEURL+DONEPATH+"&response_type="+TYPE+"&nonce=N-"+Math.random()+"&rtcsdp="+btoa(e),o={method:"GET",credentials:"same-origin",redirect:"error"};fetch(r,o).then(function(e){return e.text()}).then(function(e){dump(e);for(var n={},r=e.split("&").toString().split(/[=,]+/),o=0;o<r.length;o+=2)n[r[o]]=r[o+1];t({assertion:n.id_token,idp:idp_addr})})})["catch"](function(e){var t=SOURCEURL+"/login";n({name:"IdPLoginError",loginUrl:t})})})},validateAssertion:function(e){e=e.split(".");var t=e[0],n=e[1],r=e[2];return r=r.replace(/_/g,"/").replace(/-/g,"+"),new Promise(function(e,o){return getProxyKey().then(function(i){return crypto.subtle.importKey("jwk",i,{name:"RSASSA-PKCS1-v1_5",hash:{name:"SHA-256"}},!0,["verify"]).then(function(i){return crypto.subtle.verify("RSASSA-PKCS1-v1_5",i,str2ab(atob(r)),str2ab(t+"."+n)).then(function(t){if(t){var r=JSON.parse(atob(n)),i=r.sub.split("@")[0];e({identity:i+"@"+idp_addr.domain,contents:atob(r.rtcsdp)})}else o(new Error("Invalid signature on identity assertion"))})})})})}},RethinkOidcProtoStub=function(){function e(t,n,r){_classCallCheck(this,e);var o=this;o.runtimeProtoStubURL=t,o.messageBus=n,o.config=r,o.messageBus.addListener("*",function(e){"domain-idp://orange.com"==e.to&&o.requestToIdp(e)})}return _createClass(e,[{key:"requestToIdp",value:function(e){var t=this,n=e.body.params;switch(e.body.method){case"generateAssertion":idp.generateAssertion(n.contents,n.origin,n.usernameHint).then(function(n){t.replyMessage(e,n)},function(n){t.replyMessage(e,n)});break;case"validateAssertion":idp.validateAssertion(n.assertion,n.origin).then(function(n){t.replyMessage(e,n)},function(n){t.replyMessage(e,n)})}}},{key:"replyMessage",value:function(e,t){var n=this,r={id:e.id,type:"response",to:e.from,from:e.to,body:{code:200,value:t}};n.messageBus.postMessage(r)}}]),e}();module.exports=exports["default"];
//# sourceMappingURL=OrangeProxyStub.js.map
