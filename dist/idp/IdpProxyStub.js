"use strict";function _classCallCheck(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}function urlParser(e,t){t=t.replace(/[\[]/,"\\[").replace(/[\]]/,"\\]");var n="[\\#&?]"+t+"=([^&#]*)",o=new RegExp(n),r=o.exec(e);return null===r?"":r[1]}function sendHTTPRequest(e,t){var n=new XMLHttpRequest;return"withCredentials"in n?n.open(e,t,!0):"undefined"!=typeof XDomainRequest?(n=new XDomainRequest,n.open(e,t)):n=null,new Promise(function(e,t){n?(n.onreadystatechange=function(o){if(4===n.readyState)if(200===n.status){var r=JSON.parse(n.responseText);e(r)}else t(400===n.status?"There was an error processing the token":"something else other than 200 was returned")},n.send()):t("CORS not supported")})}function activate(e,t,n){return{name:"IdpProxyProtoStub",instance:new IdpProxyProtoStub(e,t,n)}}Object.defineProperty(exports,"__esModule",{value:!0});var _createClass=function(){function e(e,t){for(var n=0;n<t.length;n++){var o=t[n];o.enumerable=o.enumerable||!1,o.configurable=!0,"value"in o&&(o.writable=!0),Object.defineProperty(e,o.key,o)}}return function(t,n,o){return n&&e(t.prototype,n),o&&e(t,o),t}}();exports["default"]=activate;var identities={},nIdentity=0,googleInfo={clientSecret:"Xx4rKucb5ZYTaXlcZX9HLfZW",clientID:"808329566012-tqr8qoh111942gd2kg007t0s8f277roi.apps.googleusercontent.com",redirectURI:location.protocol+"//"+location.hostname,issuer:"https://accounts.google.com",tokenEndpoint:"https://www.googleapis.com/oauth2/v4/token?",jwksUri:"https://www.googleapis.com/oauth2/v3/certs?",authorisationEndpoint:"https://accounts.google.com/o/oauth2/auth?",userinfo:"https://www.googleapis.com/oauth2/v3/userinfo?access_token=",tokenInfo:"https://www.googleapis.com/oauth2/v3/tokeninfo?id_token=",accessType:"offline",type:"code token id_token",scope:"openid%20email%20profile",state:"state"},exchangeCode=function(e){var t=googleInfo,n=t.tokenEndpoint+"code="+e+"&client_id="+t.clientID+"&client_secret="+t.clientSecret+"&redirect_uri="+t.redirectURI+"&grant_type=authorization_code";return new Promise(function(e,t){sendHTTPRequest("POST",n).then(function(t){e(t)},function(e){t(e)})})},IdpProxy={validateAssertion:function(e,t){return new Promise(function(t,n){var o=atob(e),r=JSON.parse(o),s=r.tokenID.split("."),i=JSON.parse(atob(s[1]));t({identity:i.email,contents:i})})},generateAssertion:function(e,t,n){var o=googleInfo;return new Promise(function(t,r){if(n){var s=(urlParser(n,"access_token"),urlParser(n,"id_token"),urlParser(n,"code"));exchangeCode(s).then(function(e){var n=o.userinfo+e.access_token;sendHTTPRequest("GET",n).then(function(n){var s={accessToken:e.access_token,idToken:e.id_token,refreshToken:e.refresh_token,tokenType:e.token_type,infoToken:n},i=o.tokenInfo+e.id_token;sendHTTPRequest("GET",i).then(function(o){s.tokenIDJSON=o,s.expires=o.exp,s.email=o.email;var r=btoa(JSON.stringify({tokenID:e.id_token,tokenIDJSON:o})),i={domain:"google.com",protocol:"OIDC"},a={assertion:r,idp:i,info:s,infoToken:n};identities[nIdentity]=a,++nIdentity,t(a)},function(e){r(e)})},function(e){r(e)})},function(e){r(e)})}else{var i=o.authorisationEndpoint+"scope="+o.scope+"&client_id="+o.clientID+"&redirect_uri="+o.redirectURI+"&response_type="+o.type+"&state="+o.state+"&access_type="+o.accessType+"&nonce="+e;r({name:"IdPLoginError",loginUrl:i})}})}},IdpProxyProtoStub=function(){function e(t,n,o){_classCallCheck(this,e);var r=this;r.runtimeProtoStubURL=t,r.messageBus=n,r.config=o,r.messageBus.addListener("*",function(e){"domain-idp://google.com"===e.to&&r.requestToIdp(e)})}return _createClass(e,[{key:"requestToIdp",value:function(e){var t=this,n=e.body.params;switch(e.body.method){case"generateAssertion":IdpProxy.generateAssertion(n.contents,n.origin,n.usernameHint).then(function(n){t.replyMessage(e,n)},function(n){t.replyMessage(e,n)});break;case"validateAssertion":IdpProxy.validateAssertion(n.assertion,n.origin).then(function(n){t.replyMessage(e,n)},function(n){t.replyMessage(e,n)})}}},{key:"replyMessage",value:function(e,t){var n=this,o={id:e.id,type:"response",to:e.from,from:e.to,body:{code:200,value:t}};n.messageBus.postMessage(o)}}]),e}();module.exports=exports["default"];
//# sourceMappingURL=IdpProxyStub.js.map
