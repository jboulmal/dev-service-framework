{
  "HelloHyperty": {
    "cguid": "1",
    "type": "0",
    "version": "0.1",
    "description": "description of Hello Hyperty",
    "objectName": "HelloHyperty",
    "sourcePackageURL": "/sourcePackage",
    "sourcePackage": {
      "sourceCode": "KGZ1bmN0aW9uKGYpe2lmKHR5cGVvZiBleHBvcnRzPT09Im9iamVjdCImJnR5cGVvZiBtb2R1bGUhPT0idW5kZWZpbmVkIil7bW9kdWxlLmV4cG9ydHM9ZigpfWVsc2UgaWYodHlwZW9mIGRlZmluZT09PSJmdW5jdGlvbiImJmRlZmluZS5hbWQpe2RlZmluZShbXSxmKX1lbHNle3ZhciBnO2lmKHR5cGVvZiB3aW5kb3chPT0idW5kZWZpbmVkIil7Zz13aW5kb3d9ZWxzZSBpZih0eXBlb2YgZ2xvYmFsIT09InVuZGVmaW5lZCIpe2c9Z2xvYmFsfWVsc2UgaWYodHlwZW9mIHNlbGYhPT0idW5kZWZpbmVkIil7Zz1zZWxmfWVsc2V7Zz10aGlzfWcuYWN0aXZhdGUgPSBmKCl9fSkoZnVuY3Rpb24oKXt2YXIgZGVmaW5lLG1vZHVsZSxleHBvcnRzO3JldHVybiAoZnVuY3Rpb24gZSh0LG4scil7ZnVuY3Rpb24gcyhvLHUpe2lmKCFuW29dKXtpZighdFtvXSl7dmFyIGE9dHlwZW9mIHJlcXVpcmU9PSJmdW5jdGlvbiImJnJlcXVpcmU7aWYoIXUmJmEpcmV0dXJuIGEobywhMCk7aWYoaSlyZXR1cm4gaShvLCEwKTt2YXIgZj1uZXcgRXJyb3IoIkNhbm5vdCBmaW5kIG1vZHVsZSAnIitvKyInIik7dGhyb3cgZi5jb2RlPSJNT0RVTEVfTk9UX0ZPVU5EIixmfXZhciBsPW5bb109e2V4cG9ydHM6e319O3Rbb11bMF0uY2FsbChsLmV4cG9ydHMsZnVuY3Rpb24oZSl7dmFyIG49dFtvXVsxXVtlXTtyZXR1cm4gcyhuP246ZSl9LGwsbC5leHBvcnRzLGUsdCxuLHIpfXJldHVybiBuW29dLmV4cG9ydHN9dmFyIGk9dHlwZW9mIHJlcXVpcmU9PSJmdW5jdGlvbiImJnJlcXVpcmU7Zm9yKHZhciBvPTA7bzxyLmxlbmd0aDtvKyspcyhyW29dKTtyZXR1cm4gc30pKHsxOltmdW5jdGlvbihyZXF1aXJlLG1vZHVsZSxleHBvcnRzKXsKLyoKQXV0aG9yOiBHZXJhaW50IEx1ZmYgYW5kIG90aGVycwpZZWFyOiAyMDEzCgpUaGlzIGNvZGUgaXMgcmVsZWFzZWQgaW50byB0aGUgInB1YmxpYyBkb21haW4iIGJ5IGl0cyBhdXRob3IocykuICBBbnlib2R5IG1heSB1c2UsIGFsdGVyIGFuZCBkaXN0cmlidXRlIHRoZSBjb2RlIHdpdGhvdXQgcmVzdHJpY3Rpb24uICBUaGUgYXV0aG9yIG1ha2VzIG5vIGd1YXJhbnRlZXMsIGFuZCB0YWtlcyBubyBsaWFiaWxpdHkgb2YgYW55IGtpbmQgZm9yIHVzZSBvZiB0aGlzIGNvZGUuCgpJZiB5b3UgZmluZCBhIGJ1ZyBvciBtYWtlIGFuIGltcHJvdmVtZW50LCBpdCB3b3VsZCBiZSBjb3VydGVvdXMgdG8gbGV0IHRoZSBhdXRob3Iga25vdywgYnV0IGl0IGlzIG5vdCBjb21wdWxzb3J5LgoqLwooZnVuY3Rpb24gKGdsb2JhbCwgZmFjdG9yeSkgewogIGlmICh0eXBlb2YgZGVmaW5lID09PSAnZnVuY3Rpb24nICYmIGRlZmluZS5hbWQpIHsKICAgIC8vIEFNRC4gUmVnaXN0ZXIgYXMgYW4gYW5vbnltb3VzIG1vZHVsZS4KICAgIGRlZmluZShbXSwgZmFjdG9yeSk7CiAgfSBlbHNlIGlmICh0eXBlb2YgbW9kdWxlICE9PSAndW5kZWZpbmVkJyAmJiBtb2R1bGUuZXhwb3J0cyl7CiAgICAvLyBDb21tb25KUy4gRGVmaW5lIGV4cG9ydC4KICAgIG1vZHVsZS5leHBvcnRzID0gZmFjdG9yeSgpOwogIH0gZWxzZSB7CiAgICAvLyBCcm93c2VyIGdsb2JhbHMKICAgIGdsb2JhbC50djQgPSBmYWN0b3J5KCk7CiAgfQp9KHRoaXMsIGZ1bmN0aW9uICgpIHsKCi8vIGh0dHBzOi8vZGV2ZWxvcGVyLm1vemlsbGEub3JnL2VuLVVTL2RvY3MvV2ViL0phdmFTY3JpcHQvUmVmZXJlbmNlL0dsb2JhbF9PYmplY3RzL09iamVjdC9rZXlzP3JlZGlyZWN0bG9jYWxlPWVuLVVTJnJlZGlyZWN0c2x1Zz1KYXZhU2NyaXB0JTJGUmVmZXJlbmNlJTJGR2xvYmFsX09iamVjdHMlMkZPYmplY3QlMkZrZXlzCmlmICghT2JqZWN0LmtleXMpIHsKCU9iamVjdC5rZXlzID0gKGZ1bmN0aW9uICgpIHsKCQl2YXIgaGFzT3duUHJvcGVydHkgPSBPYmplY3QucHJvdG90eXBlLmhhc093blByb3BlcnR5LAoJCQloYXNEb250RW51bUJ1ZyA9ICEoe3RvU3RyaW5nOiBudWxsfSkucHJvcGVydHlJc0VudW1lcmFibGUoJ3RvU3RyaW5nJyksCgkJCWRvbnRFbnVtcyA9IFsKCQkJCSd0b1N0cmluZycsCgkJCQkndG9Mb2NhbGVTdHJpbmcnLAoJCQkJJ3ZhbHVlT2YnLAoJCQkJJ2hhc093blByb3BlcnR5JywKCQkJCSdpc1Byb3RvdHlwZU9mJywKCQkJCSdwcm9wZXJ0eUlzRW51bWVyYWJsZScsCgkJCQknY29uc3RydWN0b3InCgkJCV0sCgkJCWRvbnRFbnVtc0xlbmd0aCA9IGRvbnRFbnVtcy5sZW5ndGg7CgoJCXJldHVybiBmdW5jdGlvbiAob2JqKSB7CgkJCWlmICh0eXBlb2Ygb2JqICE9PSAnb2JqZWN0JyAmJiB0eXBlb2Ygb2JqICE9PSAnZnVuY3Rpb24nIHx8IG9iaiA9PT0gbnVsbCkgewoJCQkJdGhyb3cgbmV3IFR5cGVFcnJvcignT2JqZWN0LmtleXMgY2FsbGVkIG9uIG5vbi1vYmplY3QnKTsKCQkJfQoKCQkJdmFyIHJlc3VsdCA9IFtdOwoKCQkJZm9yICh2YXIgcHJvcCBpbiBvYmopIHsKCQkJCWlmIChoYXNPd25Qcm9wZXJ0eS5jYWxsKG9iaiwgcHJvcCkpIHsKCQkJCQlyZXN1bHQucHVzaChwcm9wKTsKCQkJCX0KCQkJfQoKCQkJaWYgKGhhc0RvbnRFbnVtQnVnKSB7CgkJCQlmb3IgKHZhciBpPTA7IGkgPCBkb250RW51bXNMZW5ndGg7IGkrKykgewoJCQkJCWlmIChoYXNPd25Qcm9wZXJ0eS5jYWxsKG9iaiwgZG9udEVudW1zW2ldKSkgewoJCQkJCQlyZXN1bHQucHVzaChkb250RW51bXNbaV0pOwoJCQkJCX0KCQkJCX0KCQkJfQoJCQlyZXR1cm4gcmVzdWx0OwoJCX07Cgl9KSgpOwp9Ci8vIGh0dHBzOi8vZGV2ZWxvcGVyLm1vemlsbGEub3JnL2VuLVVTL2RvY3MvV2ViL0phdmFTY3JpcHQvUmVmZXJlbmNlL0dsb2JhbF9PYmplY3RzL09iamVjdC9jcmVhdGUKaWYgKCFPYmplY3QuY3JlYXRlKSB7CglPYmplY3QuY3JlYXRlID0gKGZ1bmN0aW9uKCl7CgkJZnVuY3Rpb24gRigpe30KCgkJcmV0dXJuIGZ1bmN0aW9uKG8pewoJCQlpZiAoYXJndW1lbnRzLmxlbmd0aCAhPT0gMSkgewoJCQkJdGhyb3cgbmV3IEVycm9yKCdPYmplY3QuY3JlYXRlIGltcGxlbWVudGF0aW9uIG9ubHkgYWNjZXB0cyBvbmUgcGFyYW1ldGVyLicpOwoJCQl9CgkJCUYucHJvdG90eXBlID0gbzsKCQkJcmV0dXJuIG5ldyBGKCk7CgkJfTsKCX0pKCk7Cn0KLy8gaHR0cHM6Ly9kZXZlbG9wZXIubW96aWxsYS5vcmcvZW4tVVMvZG9jcy9XZWIvSmF2YVNjcmlwdC9SZWZlcmVuY2UvR2xvYmFsX09iamVjdHMvQXJyYXkvaXNBcnJheT9yZWRpcmVjdGxvY2FsZT1lbi1VUyZyZWRpcmVjdHNsdWc9SmF2YVNjcmlwdCUyRlJlZmVyZW5jZSUyRkdsb2JhbF9PYmplY3RzJTJGQXJyYXklMkZpc0FycmF5CmlmKCFBcnJheS5pc0FycmF5KSB7CglBcnJheS5pc0FycmF5ID0gZnVuY3Rpb24gKHZBcmcpIHsKCQlyZXR1cm4gT2JqZWN0LnByb3RvdHlwZS50b1N0cmluZy5jYWxsKHZBcmcpID09PSAiW29iamVjdCBBcnJheV0iOwoJfTsKfQovLyBodHRwczovL2RldmVsb3Blci5tb3ppbGxhLm9yZy9lbi1VUy9kb2NzL1dlYi9KYXZhU2NyaXB0L1JlZmVyZW5jZS9HbG9iYWxfT2JqZWN0cy9BcnJheS9pbmRleE9mP3JlZGlyZWN0bG9jYWxlPWVuLVVTJnJlZGlyZWN0c2x1Zz1KYXZhU2NyaXB0JTJGUmVmZXJlbmNlJTJGR2xvYmFsX09iamVjdHMlMkZBcnJheSUyRmluZGV4T2YKaWYgKCFBcnJheS5wcm90b3R5cGUuaW5kZXhPZikgewoJQXJyYXkucHJvdG90eXBlLmluZGV4T2YgPSBmdW5jdGlvbiAoc2VhcmNoRWxlbWVudCAvKiwgZnJvbUluZGV4ICovICkgewoJCWlmICh0aGlzID09PSBudWxsKSB7CgkJCXRocm93IG5ldyBUeXBlRXJyb3IoKTsKCQl9CgkJdmFyIHQgPSBPYmplY3QodGhpcyk7CgkJdmFyIGxlbiA9IHQubGVuZ3RoID4+PiAwOwoKCQlpZiAobGVuID09PSAwKSB7CgkJCXJldHVybiAtMTsKCQl9CgkJdmFyIG4gPSAwOwoJCWlmIChhcmd1bWVudHMubGVuZ3RoID4gMSkgewoJCQluID0gTnVtYmVyKGFyZ3VtZW50c1sxXSk7CgkJCWlmIChuICE9PSBuKSB7IC8vIHNob3J0Y3V0IGZvciB2ZXJpZnlpbmcgaWYgaXQncyBOYU4KCQkJCW4gPSAwOwoJCQl9IGVsc2UgaWYgKG4gIT09IDAgJiYgbiAhPT0gSW5maW5pdHkgJiYgbiAhPT0gLUluZmluaXR5KSB7CgkJCQluID0gKG4gPiAwIHx8IC0xKSAqIE1hdGguZmxvb3IoTWF0aC5hYnMobikpOwoJCQl9CgkJfQoJCWlmIChuID49IGxlbikgewoJCQlyZXR1cm4gLTE7CgkJfQoJCXZhciBrID0gbiA+PSAwID8gbiA6IE1hdGgubWF4KGxlbiAtIE1hdGguYWJzKG4pLCAwKTsKCQlmb3IgKDsgayA8IGxlbjsgaysrKSB7CgkJCWlmIChrIGluIHQgJiYgdFtrXSA9PT0gc2VhcmNoRWxlbWVudCkgewoJCQkJcmV0dXJuIGs7CgkJCX0KCQl9CgkJcmV0dXJuIC0xOwoJfTsKfQoKLy8gR3J1bmdleSBPYmplY3QuaXNGcm96ZW4gaGFjawppZiAoIU9iamVjdC5pc0Zyb3plbikgewoJT2JqZWN0LmlzRnJvemVuID0gZnVuY3Rpb24gKG9iaikgewoJCXZhciBrZXkgPSAidHY0X3Rlc3RfZnJvemVuX2tleSI7CgkJd2hpbGUgKG9iai5oYXNPd25Qcm9wZXJ0eShrZXkpKSB7CgkJCWtleSArPSBNYXRoLnJhbmRvbSgpOwoJCX0KCQl0cnkgewoJCQlvYmpba2V5XSA9IHRydWU7CgkJCWRlbGV0ZSBvYmpba2V5XTsKCQkJcmV0dXJuIGZhbHNlOwoJCX0gY2F0Y2ggKGUpIHsKCQkJcmV0dXJuIHRydWU7CgkJfQoJfTsKfQovLyBCYXNlZCBvbjogaHR0cHM6Ly9naXRodWIuY29tL2dlcmFpbnRsdWZmL3VyaS10ZW1wbGF0ZXMsIGJ1dCB3aXRoIGFsbCB0aGUgZGUtc3Vic3RpdHV0aW9uIHN0dWZmIHJlbW92ZWQKCnZhciB1cmlUZW1wbGF0ZUdsb2JhbE1vZGlmaWVycyA9IHsKCSIrIjogdHJ1ZSwKCSIjIjogdHJ1ZSwKCSIuIjogdHJ1ZSwKCSIvIjogdHJ1ZSwKCSI7IjogdHJ1ZSwKCSI/IjogdHJ1ZSwKCSImIjogdHJ1ZQp9Owp2YXIgdXJpVGVtcGxhdGVTdWZmaWNlcyA9IHsKCSIqIjogdHJ1ZQp9OwoKZnVuY3Rpb24gbm90UmVhbGx5UGVyY2VudEVuY29kZShzdHJpbmcpIHsKCXJldHVybiBlbmNvZGVVUkkoc3RyaW5nKS5yZXBsYWNlKC8lMjVbMC05XVswLTldL2csIGZ1bmN0aW9uIChkb3VibGVFbmNvZGVkKSB7CgkJcmV0dXJuICIlIiArIGRvdWJsZUVuY29kZWQuc3Vic3RyaW5nKDMpOwoJfSk7Cn0KCmZ1bmN0aW9uIHVyaVRlbXBsYXRlU3Vic3RpdHV0aW9uKHNwZWMpIHsKCXZhciBtb2RpZmllciA9ICIiOwoJaWYgKHVyaVRlbXBsYXRlR2xvYmFsTW9kaWZpZXJzW3NwZWMuY2hhckF0KDApXSkgewoJCW1vZGlmaWVyID0gc3BlYy5jaGFyQXQoMCk7CgkJc3BlYyA9IHNwZWMuc3Vic3RyaW5nKDEpOwoJfQoJdmFyIHNlcGFyYXRvciA9ICIiOwoJdmFyIHByZWZpeCA9ICIiOwoJdmFyIHNob3VsZEVzY2FwZSA9IHRydWU7Cgl2YXIgc2hvd1ZhcmlhYmxlcyA9IGZhbHNlOwoJdmFyIHRyaW1FbXB0eVN0cmluZyA9IGZhbHNlOwoJaWYgKG1vZGlmaWVyID09PSAnKycpIHsKCQlzaG91bGRFc2NhcGUgPSBmYWxzZTsKCX0gZWxzZSBpZiAobW9kaWZpZXIgPT09ICIuIikgewoJCXByZWZpeCA9ICIuIjsKCQlzZXBhcmF0b3IgPSAiLiI7Cgl9IGVsc2UgaWYgKG1vZGlmaWVyID09PSAiLyIpIHsKCQlwcmVmaXggPSAiLyI7CgkJc2VwYXJhdG9yID0gIi8iOwoJfSBlbHNlIGlmIChtb2RpZmllciA9PT0gJyMnKSB7CgkJcHJlZml4ID0gIiMiOwoJCXNob3VsZEVzY2FwZSA9IGZhbHNlOwoJfSBlbHNlIGlmIChtb2RpZmllciA9PT0gJzsnKSB7CgkJcHJlZml4ID0gIjsiOwoJCXNlcGFyYXRvciA9ICI7IjsKCQlzaG93VmFyaWFibGVzID0gdHJ1ZTsKCQl0cmltRW1wdHlTdHJpbmcgPSB0cnVlOwoJfSBlbHNlIGlmIChtb2RpZmllciA9PT0gJz8nKSB7CgkJcHJlZml4ID0gIj8iOwoJCXNlcGFyYXRvciA9ICImIjsKCQlzaG93VmFyaWFibGVzID0gdHJ1ZTsKCX0gZWxzZSBpZiAobW9kaWZpZXIgPT09ICcmJykgewoJCXByZWZpeCA9ICImIjsKCQlzZXBhcmF0b3IgPSAiJiI7CgkJc2hvd1ZhcmlhYmxlcyA9IHRydWU7Cgl9CgoJdmFyIHZhck5hbWVzID0gW107Cgl2YXIgdmFyTGlzdCA9IHNwZWMuc3BsaXQoIiwiKTsKCXZhciB2YXJTcGVjcyA9IFtdOwoJdmFyIHZhclNwZWNNYXAgPSB7fTsKCWZvciAodmFyIGkgPSAwOyBpIDwgdmFyTGlzdC5sZW5ndGg7IGkrKykgewoJCXZhciB2YXJOYW1lID0gdmFyTGlzdFtpXTsKCQl2YXIgdHJ1bmNhdGUgPSBudWxsOwoJCWlmICh2YXJOYW1lLmluZGV4T2YoIjoiKSAhPT0gLTEpIHsKCQkJdmFyIHBhcnRzID0gdmFyTmFtZS5zcGxpdCgiOiIpOwoJCQl2YXJOYW1lID0gcGFydHNbMF07CgkJCXRydW5jYXRlID0gcGFyc2VJbnQocGFydHNbMV0sIDEwKTsKCQl9CgkJdmFyIHN1ZmZpY2VzID0ge307CgkJd2hpbGUgKHVyaVRlbXBsYXRlU3VmZmljZXNbdmFyTmFtZS5jaGFyQXQodmFyTmFtZS5sZW5ndGggLSAxKV0pIHsKCQkJc3VmZmljZXNbdmFyTmFtZS5jaGFyQXQodmFyTmFtZS5sZW5ndGggLSAxKV0gPSB0cnVlOwoJCQl2YXJOYW1lID0gdmFyTmFtZS5zdWJzdHJpbmcoMCwgdmFyTmFtZS5sZW5ndGggLSAxKTsKCQl9CgkJdmFyIHZhclNwZWMgPSB7CgkJCXRydW5jYXRlOiB0cnVuY2F0ZSwKCQkJbmFtZTogdmFyTmFtZSwKCQkJc3VmZmljZXM6IHN1ZmZpY2VzCgkJfTsKCQl2YXJTcGVjcy5wdXNoKHZhclNwZWMpOwoJCXZhclNwZWNNYXBbdmFyTmFtZV0gPSB2YXJTcGVjOwoJCXZhck5hbWVzLnB1c2godmFyTmFtZSk7Cgl9Cgl2YXIgc3ViRnVuY3Rpb24gPSBmdW5jdGlvbiAodmFsdWVGdW5jdGlvbikgewoJCXZhciByZXN1bHQgPSAiIjsKCQl2YXIgc3RhcnRJbmRleCA9IDA7CgkJZm9yICh2YXIgaSA9IDA7IGkgPCB2YXJTcGVjcy5sZW5ndGg7IGkrKykgewoJCQl2YXIgdmFyU3BlYyA9IHZhclNwZWNzW2ldOwoJCQl2YXIgdmFsdWUgPSB2YWx1ZUZ1bmN0aW9uKHZhclNwZWMubmFtZSk7CgkJCWlmICh2YWx1ZSA9PT0gbnVsbCB8fCB2YWx1ZSA9PT0gdW5kZWZpbmVkIHx8IChBcnJheS5pc0FycmF5KHZhbHVlKSAmJiB2YWx1ZS5sZW5ndGggPT09IDApIHx8ICh0eXBlb2YgdmFsdWUgPT09ICdvYmplY3QnICYmIE9iamVjdC5rZXlzKHZhbHVlKS5sZW5ndGggPT09IDApKSB7CgkJCQlzdGFydEluZGV4Kys7CgkJCQljb250aW51ZTsKCQkJfQoJCQlpZiAoaSA9PT0gc3RhcnRJbmRleCkgewoJCQkJcmVzdWx0ICs9IHByZWZpeDsKCQkJfSBlbHNlIHsKCQkJCXJlc3VsdCArPSAoc2VwYXJhdG9yIHx8ICIsIik7CgkJCX0KCQkJaWYgKEFycmF5LmlzQXJyYXkodmFsdWUpKSB7CgkJCQlpZiAoc2hvd1ZhcmlhYmxlcykgewoJCQkJCXJlc3VsdCArPSB2YXJTcGVjLm5hbWUgKyAiPSI7CgkJCQl9CgkJCQlmb3IgKHZhciBqID0gMDsgaiA8IHZhbHVlLmxlbmd0aDsgaisrKSB7CgkJCQkJaWYgKGogPiAwKSB7CgkJCQkJCXJlc3VsdCArPSB2YXJTcGVjLnN1ZmZpY2VzWycqJ10gPyAoc2VwYXJhdG9yIHx8ICIsIikgOiAiLCI7CgkJCQkJCWlmICh2YXJTcGVjLnN1ZmZpY2VzWycqJ10gJiYgc2hvd1ZhcmlhYmxlcykgewoJCQkJCQkJcmVzdWx0ICs9IHZhclNwZWMubmFtZSArICI9IjsKCQkJCQkJfQoJCQkJCX0KCQkJCQlyZXN1bHQgKz0gc2hvdWxkRXNjYXBlID8gZW5jb2RlVVJJQ29tcG9uZW50KHZhbHVlW2pdKS5yZXBsYWNlKC8hL2csICIlMjEiKSA6IG5vdFJlYWxseVBlcmNlbnRFbmNvZGUodmFsdWVbal0pOwoJCQkJfQoJCQl9IGVsc2UgaWYgKHR5cGVvZiB2YWx1ZSA9PT0gIm9iamVjdCIpIHsKCQkJCWlmIChzaG93VmFyaWFibGVzICYmICF2YXJTcGVjLnN1ZmZpY2VzWycqJ10pIHsKCQkJCQlyZXN1bHQgKz0gdmFyU3BlYy5uYW1lICsgIj0iOwoJCQkJfQoJCQkJdmFyIGZpcnN0ID0gdHJ1ZTsKCQkJCWZvciAodmFyIGtleSBpbiB2YWx1ZSkgewoJCQkJCWlmICghZmlyc3QpIHsKCQkJCQkJcmVzdWx0ICs9IHZhclNwZWMuc3VmZmljZXNbJyonXSA/IChzZXBhcmF0b3IgfHwgIiwiKSA6ICIsIjsKCQkJCQl9CgkJCQkJZmlyc3QgPSBmYWxzZTsKCQkJCQlyZXN1bHQgKz0gc2hvdWxkRXNjYXBlID8gZW5jb2RlVVJJQ29tcG9uZW50KGtleSkucmVwbGFjZSgvIS9nLCAiJTIxIikgOiBub3RSZWFsbHlQZXJjZW50RW5jb2RlKGtleSk7CgkJCQkJcmVzdWx0ICs9IHZhclNwZWMuc3VmZmljZXNbJyonXSA/ICc9JyA6ICIsIjsKCQkJCQlyZXN1bHQgKz0gc2hvdWxkRXNjYXBlID8gZW5jb2RlVVJJQ29tcG9uZW50KHZhbHVlW2tleV0pLnJlcGxhY2UoLyEvZywgIiUyMSIpIDogbm90UmVhbGx5UGVyY2VudEVuY29kZSh2YWx1ZVtrZXldKTsKCQkJCX0KCQkJfSBlbHNlIHsKCQkJCWlmIChzaG93VmFyaWFibGVzKSB7CgkJCQkJcmVzdWx0ICs9IHZhclNwZWMubmFtZTsKCQkJCQlpZiAoIXRyaW1FbXB0eVN0cmluZyB8fCB2YWx1ZSAhPT0gIiIpIHsKCQkJCQkJcmVzdWx0ICs9ICI9IjsKCQkJCQl9CgkJCQl9CgkJCQlpZiAodmFyU3BlYy50cnVuY2F0ZSAhPSBudWxsKSB7CgkJCQkJdmFsdWUgPSB2YWx1ZS5zdWJzdHJpbmcoMCwgdmFyU3BlYy50cnVuY2F0ZSk7CgkJCQl9CgkJCQlyZXN1bHQgKz0gc2hvdWxkRXNjYXBlID8gZW5jb2RlVVJJQ29tcG9uZW50KHZhbHVlKS5yZXBsYWNlKC8hL2csICIlMjEiKTogbm90UmVhbGx5UGVyY2VudEVuY29kZSh2YWx1ZSk7CgkJCX0KCQl9CgkJcmV0dXJuIHJlc3VsdDsKCX07CglzdWJGdW5jdGlvbi52YXJOYW1lcyA9IHZhck5hbWVzOwoJcmV0dXJuIHsKCQlwcmVmaXg6IHByZWZpeCwKCQlzdWJzdGl0dXRpb246IHN1YkZ1bmN0aW9uCgl9Owp9CgpmdW5jdGlvbiBVcmlUZW1wbGF0ZSh0ZW1wbGF0ZSkgewoJaWYgKCEodGhpcyBpbnN0YW5jZW9mIFVyaVRlbXBsYXRlKSkgewoJCXJldHVybiBuZXcgVXJpVGVtcGxhdGUodGVtcGxhdGUpOwoJfQoJdmFyIHBhcnRzID0gdGVtcGxhdGUuc3BsaXQoInsiKTsKCXZhciB0ZXh0UGFydHMgPSBbcGFydHMuc2hpZnQoKV07Cgl2YXIgcHJlZml4ZXMgPSBbXTsKCXZhciBzdWJzdGl0dXRpb25zID0gW107Cgl2YXIgdmFyTmFtZXMgPSBbXTsKCXdoaWxlIChwYXJ0cy5sZW5ndGggPiAwKSB7CgkJdmFyIHBhcnQgPSBwYXJ0cy5zaGlmdCgpOwoJCXZhciBzcGVjID0gcGFydC5zcGxpdCgifSIpWzBdOwoJCXZhciByZW1haW5kZXIgPSBwYXJ0LnN1YnN0cmluZyhzcGVjLmxlbmd0aCArIDEpOwoJCXZhciBmdW5jcyA9IHVyaVRlbXBsYXRlU3Vic3RpdHV0aW9uKHNwZWMpOwoJCXN1YnN0aXR1dGlvbnMucHVzaChmdW5jcy5zdWJzdGl0dXRpb24pOwoJCXByZWZpeGVzLnB1c2goZnVuY3MucHJlZml4KTsKCQl0ZXh0UGFydHMucHVzaChyZW1haW5kZXIpOwoJCXZhck5hbWVzID0gdmFyTmFtZXMuY29uY2F0KGZ1bmNzLnN1YnN0aXR1dGlvbi52YXJOYW1lcyk7Cgl9Cgl0aGlzLmZpbGwgPSBmdW5jdGlvbiAodmFsdWVGdW5jdGlvbikgewoJCXZhciByZXN1bHQgPSB0ZXh0UGFydHNbMF07CgkJZm9yICh2YXIgaSA9IDA7IGkgPCBzdWJzdGl0dXRpb25zLmxlbmd0aDsgaSsrKSB7CgkJCXZhciBzdWJzdGl0dXRpb24gPSBzdWJzdGl0dXRpb25zW2ldOwoJCQlyZXN1bHQgKz0gc3Vic3RpdHV0aW9uKHZhbHVlRnVuY3Rpb24pOwoJCQlyZXN1bHQgKz0gdGV4dFBhcnRzW2kgKyAxXTsKCQl9CgkJcmV0dXJuIHJlc3VsdDsKCX07Cgl0aGlzLnZhck5hbWVzID0gdmFyTmFtZXM7Cgl0aGlzLnRlbXBsYXRlID0gdGVtcGxhdGU7Cn0KVXJpVGVtcGxhdGUucHJvdG90eXBlID0gewoJdG9TdHJpbmc6IGZ1bmN0aW9uICgpIHsKCQlyZXR1cm4gdGhpcy50ZW1wbGF0ZTsKCX0sCglmaWxsRnJvbU9iamVjdDogZnVuY3Rpb24gKG9iaikgewoJCXJldHVybiB0aGlzLmZpbGwoZnVuY3Rpb24gKHZhck5hbWUpIHsKCQkJcmV0dXJuIG9ialt2YXJOYW1lXTsKCQl9KTsKCX0KfTsKdmFyIFZhbGlkYXRvckNvbnRleHQgPSBmdW5jdGlvbiBWYWxpZGF0b3JDb250ZXh0KHBhcmVudCwgY29sbGVjdE11bHRpcGxlLCBlcnJvclJlcG9ydGVyLCBjaGVja1JlY3Vyc2l2ZSwgdHJhY2tVbmtub3duUHJvcGVydGllcykgewoJdGhpcy5taXNzaW5nID0gW107Cgl0aGlzLm1pc3NpbmdNYXAgPSB7fTsKCXRoaXMuZm9ybWF0VmFsaWRhdG9ycyA9IHBhcmVudCA/IE9iamVjdC5jcmVhdGUocGFyZW50LmZvcm1hdFZhbGlkYXRvcnMpIDoge307Cgl0aGlzLnNjaGVtYXMgPSBwYXJlbnQgPyBPYmplY3QuY3JlYXRlKHBhcmVudC5zY2hlbWFzKSA6IHt9OwoJdGhpcy5jb2xsZWN0TXVsdGlwbGUgPSBjb2xsZWN0TXVsdGlwbGU7Cgl0aGlzLmVycm9ycyA9IFtdOwoJdGhpcy5oYW5kbGVFcnJvciA9IGNvbGxlY3RNdWx0aXBsZSA/IHRoaXMuY29sbGVjdEVycm9yIDogdGhpcy5yZXR1cm5FcnJvcjsKCWlmIChjaGVja1JlY3Vyc2l2ZSkgewoJCXRoaXMuY2hlY2tSZWN1cnNpdmUgPSB0cnVlOwoJCXRoaXMuc2Nhbm5lZCA9IFtdOwoJCXRoaXMuc2Nhbm5lZEZyb3plbiA9IFtdOwoJCXRoaXMuc2Nhbm5lZEZyb3plblNjaGVtYXMgPSBbXTsKCQl0aGlzLnNjYW5uZWRGcm96ZW5WYWxpZGF0aW9uRXJyb3JzID0gW107CgkJdGhpcy52YWxpZGF0ZWRTY2hlbWFzS2V5ID0gJ3R2NF92YWxpZGF0aW9uX2lkJzsKCQl0aGlzLnZhbGlkYXRpb25FcnJvcnNLZXkgPSAndHY0X3ZhbGlkYXRpb25fZXJyb3JzX2lkJzsKCX0KCWlmICh0cmFja1Vua25vd25Qcm9wZXJ0aWVzKSB7CgkJdGhpcy50cmFja1Vua25vd25Qcm9wZXJ0aWVzID0gdHJ1ZTsKCQl0aGlzLmtub3duUHJvcGVydHlQYXRocyA9IHt9OwoJCXRoaXMudW5rbm93blByb3BlcnR5UGF0aHMgPSB7fTsKCX0KCXRoaXMuZXJyb3JSZXBvcnRlciA9IGVycm9yUmVwb3J0ZXIgfHwgZGVmYXVsdEVycm9yUmVwb3J0ZXIoJ2VuJyk7CglpZiAodHlwZW9mIHRoaXMuZXJyb3JSZXBvcnRlciA9PT0gJ3N0cmluZycpIHsKCQl0aHJvdyBuZXcgRXJyb3IoJ2RlYnVnJyk7Cgl9Cgl0aGlzLmRlZmluZWRLZXl3b3JkcyA9IHt9OwoJaWYgKHBhcmVudCkgewoJCWZvciAodmFyIGtleSBpbiBwYXJlbnQuZGVmaW5lZEtleXdvcmRzKSB7CgkJCXRoaXMuZGVmaW5lZEtleXdvcmRzW2tleV0gPSBwYXJlbnQuZGVmaW5lZEtleXdvcmRzW2tleV0uc2xpY2UoMCk7CgkJfQoJfQp9OwpWYWxpZGF0b3JDb250ZXh0LnByb3RvdHlwZS5kZWZpbmVLZXl3b3JkID0gZnVuY3Rpb24gKGtleXdvcmQsIGtleXdvcmRGdW5jdGlvbikgewoJdGhpcy5kZWZpbmVkS2V5d29yZHNba2V5d29yZF0gPSB0aGlzLmRlZmluZWRLZXl3b3Jkc1trZXl3b3JkXSB8fCBbXTsKCXRoaXMuZGVmaW5lZEtleXdvcmRzW2tleXdvcmRdLnB1c2goa2V5d29yZEZ1bmN0aW9uKTsKfTsKVmFsaWRhdG9yQ29udGV4dC5wcm90b3R5cGUuY3JlYXRlRXJyb3IgPSBmdW5jdGlvbiAoY29kZSwgbWVzc2FnZVBhcmFtcywgZGF0YVBhdGgsIHNjaGVtYVBhdGgsIHN1YkVycm9ycywgZGF0YSwgc2NoZW1hKSB7Cgl2YXIgZXJyb3IgPSBuZXcgVmFsaWRhdGlvbkVycm9yKGNvZGUsIG1lc3NhZ2VQYXJhbXMsIGRhdGFQYXRoLCBzY2hlbWFQYXRoLCBzdWJFcnJvcnMpOwoJZXJyb3IubWVzc2FnZSA9IHRoaXMuZXJyb3JSZXBvcnRlcihlcnJvciwgZGF0YSwgc2NoZW1hKTsKCXJldHVybiBlcnJvcjsKfTsKVmFsaWRhdG9yQ29udGV4dC5wcm90b3R5cGUucmV0dXJuRXJyb3IgPSBmdW5jdGlvbiAoZXJyb3IpIHsKCXJldHVybiBlcnJvcjsKfTsKVmFsaWRhdG9yQ29udGV4dC5wcm90b3R5cGUuY29sbGVjdEVycm9yID0gZnVuY3Rpb24gKGVycm9yKSB7CglpZiAoZXJyb3IpIHsKCQl0aGlzLmVycm9ycy5wdXNoKGVycm9yKTsKCX0KCXJldHVybiBudWxsOwp9OwpWYWxpZGF0b3JDb250ZXh0LnByb3RvdHlwZS5wcmVmaXhFcnJvcnMgPSBmdW5jdGlvbiAoc3RhcnRJbmRleCwgZGF0YVBhdGgsIHNjaGVtYVBhdGgpIHsKCWZvciAodmFyIGkgPSBzdGFydEluZGV4OyBpIDwgdGhpcy5lcnJvcnMubGVuZ3RoOyBpKyspIHsKCQl0aGlzLmVycm9yc1tpXSA9IHRoaXMuZXJyb3JzW2ldLnByZWZpeFdpdGgoZGF0YVBhdGgsIHNjaGVtYVBhdGgpOwoJfQoJcmV0dXJuIHRoaXM7Cn07ClZhbGlkYXRvckNvbnRleHQucHJvdG90eXBlLmJhblVua25vd25Qcm9wZXJ0aWVzID0gZnVuY3Rpb24gKGRhdGEsIHNjaGVtYSkgewoJZm9yICh2YXIgdW5rbm93blBhdGggaW4gdGhpcy51bmtub3duUHJvcGVydHlQYXRocykgewoJCXZhciBlcnJvciA9IHRoaXMuY3JlYXRlRXJyb3IoRXJyb3JDb2Rlcy5VTktOT1dOX1BST1BFUlRZLCB7cGF0aDogdW5rbm93blBhdGh9LCB1bmtub3duUGF0aCwgIiIsIG51bGwsIGRhdGEsIHNjaGVtYSk7CgkJdmFyIHJlc3VsdCA9IHRoaXMuaGFuZGxlRXJyb3IoZXJyb3IpOwoJCWlmIChyZXN1bHQpIHsKCQkJcmV0dXJuIHJlc3VsdDsKCQl9Cgl9CglyZXR1cm4gbnVsbDsKfTsKClZhbGlkYXRvckNvbnRleHQucHJvdG90eXBlLmFkZEZvcm1hdCA9IGZ1bmN0aW9uIChmb3JtYXQsIHZhbGlkYXRvcikgewoJaWYgKHR5cGVvZiBmb3JtYXQgPT09ICdvYmplY3QnKSB7CgkJZm9yICh2YXIga2V5IGluIGZvcm1hdCkgewoJCQl0aGlzLmFkZEZvcm1hdChrZXksIGZvcm1hdFtrZXldKTsKCQl9CgkJcmV0dXJuIHRoaXM7Cgl9Cgl0aGlzLmZvcm1hdFZhbGlkYXRvcnNbZm9ybWF0XSA9IHZhbGlkYXRvcjsKfTsKVmFsaWRhdG9yQ29udGV4dC5wcm90b3R5cGUucmVzb2x2ZVJlZnMgPSBmdW5jdGlvbiAoc2NoZW1hLCB1cmxIaXN0b3J5KSB7CglpZiAoc2NoZW1hWyckcmVmJ10gIT09IHVuZGVmaW5lZCkgewoJCXVybEhpc3RvcnkgPSB1cmxIaXN0b3J5IHx8IHt9OwoJCWlmICh1cmxIaXN0b3J5W3NjaGVtYVsnJHJlZiddXSkgewoJCQlyZXR1cm4gdGhpcy5jcmVhdGVFcnJvcihFcnJvckNvZGVzLkNJUkNVTEFSX1JFRkVSRU5DRSwge3VybHM6IE9iamVjdC5rZXlzKHVybEhpc3RvcnkpLmpvaW4oJywgJyl9LCAnJywgJycsIG51bGwsIHVuZGVmaW5lZCwgc2NoZW1hKTsKCQl9CgkJdXJsSGlzdG9yeVtzY2hlbWFbJyRyZWYnXV0gPSB0cnVlOwoJCXNjaGVtYSA9IHRoaXMuZ2V0U2NoZW1hKHNjaGVtYVsnJHJlZiddLCB1cmxIaXN0b3J5KTsKCX0KCXJldHVybiBzY2hlbWE7Cn07ClZhbGlkYXRvckNvbnRleHQucHJvdG90eXBlLmdldFNjaGVtYSA9IGZ1bmN0aW9uICh1cmwsIHVybEhpc3RvcnkpIHsKCXZhciBzY2hlbWE7CglpZiAodGhpcy5zY2hlbWFzW3VybF0gIT09IHVuZGVmaW5lZCkgewoJCXNjaGVtYSA9IHRoaXMuc2NoZW1hc1t1cmxdOwoJCXJldHVybiB0aGlzLnJlc29sdmVSZWZzKHNjaGVtYSwgdXJsSGlzdG9yeSk7Cgl9Cgl2YXIgYmFzZVVybCA9IHVybDsKCXZhciBmcmFnbWVudCA9ICIiOwoJaWYgKHVybC5pbmRleE9mKCcjJykgIT09IC0xKSB7CgkJZnJhZ21lbnQgPSB1cmwuc3Vic3RyaW5nKHVybC5pbmRleE9mKCIjIikgKyAxKTsKCQliYXNlVXJsID0gdXJsLnN1YnN0cmluZygwLCB1cmwuaW5kZXhPZigiIyIpKTsKCX0KCWlmICh0eXBlb2YgdGhpcy5zY2hlbWFzW2Jhc2VVcmxdID09PSAnb2JqZWN0JykgewoJCXNjaGVtYSA9IHRoaXMuc2NoZW1hc1tiYXNlVXJsXTsKCQl2YXIgcG9pbnRlclBhdGggPSBkZWNvZGVVUklDb21wb25lbnQoZnJhZ21lbnQpOwoJCWlmIChwb2ludGVyUGF0aCA9PT0gIiIpIHsKCQkJcmV0dXJuIHRoaXMucmVzb2x2ZVJlZnMoc2NoZW1hLCB1cmxIaXN0b3J5KTsKCQl9IGVsc2UgaWYgKHBvaW50ZXJQYXRoLmNoYXJBdCgwKSAhPT0gIi8iKSB7CgkJCXJldHVybiB1bmRlZmluZWQ7CgkJfQoJCXZhciBwYXJ0cyA9IHBvaW50ZXJQYXRoLnNwbGl0KCIvIikuc2xpY2UoMSk7CgkJZm9yICh2YXIgaSA9IDA7IGkgPCBwYXJ0cy5sZW5ndGg7IGkrKykgewoJCQl2YXIgY29tcG9uZW50ID0gcGFydHNbaV0ucmVwbGFjZSgvfjEvZywgIi8iKS5yZXBsYWNlKC9+MC9nLCAifiIpOwoJCQlpZiAoc2NoZW1hW2NvbXBvbmVudF0gPT09IHVuZGVmaW5lZCkgewoJCQkJc2NoZW1hID0gdW5kZWZpbmVkOwoJCQkJYnJlYWs7CgkJCX0KCQkJc2NoZW1hID0gc2NoZW1hW2NvbXBvbmVudF07CgkJfQoJCWlmIChzY2hlbWEgIT09IHVuZGVmaW5lZCkgewoJCQlyZXR1cm4gdGhpcy5yZXNvbHZlUmVmcyhzY2hlbWEsIHVybEhpc3RvcnkpOwoJCX0KCX0KCWlmICh0aGlzLm1pc3NpbmdbYmFzZVVybF0gPT09IHVuZGVmaW5lZCkgewoJCXRoaXMubWlzc2luZy5wdXNoKGJhc2VVcmwpOwoJCXRoaXMubWlzc2luZ1tiYXNlVXJsXSA9IGJhc2VVcmw7CgkJdGhpcy5taXNzaW5nTWFwW2Jhc2VVcmxdID0gYmFzZVVybDsKCX0KfTsKVmFsaWRhdG9yQ29udGV4dC5wcm90b3R5cGUuc2VhcmNoU2NoZW1hcyA9IGZ1bmN0aW9uIChzY2hlbWEsIHVybCkgewoJaWYgKEFycmF5LmlzQXJyYXkoc2NoZW1hKSkgewoJCWZvciAodmFyIGkgPSAwOyBpIDwgc2NoZW1hLmxlbmd0aDsgaSsrKSB7CgkJCXRoaXMuc2VhcmNoU2NoZW1hcyhzY2hlbWFbaV0sIHVybCk7CgkJfQoJfSBlbHNlIGlmIChzY2hlbWEgJiYgdHlwZW9mIHNjaGVtYSA9PT0gIm9iamVjdCIpIHsKCQlpZiAodHlwZW9mIHNjaGVtYS5pZCA9PT0gInN0cmluZyIpIHsKCQkJaWYgKGlzVHJ1c3RlZFVybCh1cmwsIHNjaGVtYS5pZCkpIHsKCQkJCWlmICh0aGlzLnNjaGVtYXNbc2NoZW1hLmlkXSA9PT0gdW5kZWZpbmVkKSB7CgkJCQkJdGhpcy5zY2hlbWFzW3NjaGVtYS5pZF0gPSBzY2hlbWE7CgkJCQl9CgkJCX0KCQl9CgkJZm9yICh2YXIga2V5IGluIHNjaGVtYSkgewoJCQlpZiAoa2V5ICE9PSAiZW51bSIpIHsKCQkJCWlmICh0eXBlb2Ygc2NoZW1hW2tleV0gPT09ICJvYmplY3QiKSB7CgkJCQkJdGhpcy5zZWFyY2hTY2hlbWFzKHNjaGVtYVtrZXldLCB1cmwpOwoJCQkJfSBlbHNlIGlmIChrZXkgPT09ICIkcmVmIikgewoJCQkJCXZhciB1cmkgPSBnZXREb2N1bWVudFVyaShzY2hlbWFba2V5XSk7CgkJCQkJaWYgKHVyaSAmJiB0aGlzLnNjaGVtYXNbdXJpXSA9PT0gdW5kZWZpbmVkICYmIHRoaXMubWlzc2luZ01hcFt1cmldID09PSB1bmRlZmluZWQpIHsKCQkJCQkJdGhpcy5taXNzaW5nTWFwW3VyaV0gPSB1cmk7CgkJCQkJfQoJCQkJfQoJCQl9CgkJfQoJfQp9OwpWYWxpZGF0b3JDb250ZXh0LnByb3RvdHlwZS5hZGRTY2hlbWEgPSBmdW5jdGlvbiAodXJsLCBzY2hlbWEpIHsKCS8vb3ZlcmxvYWQKCWlmICh0eXBlb2YgdXJsICE9PSAnc3RyaW5nJyB8fCB0eXBlb2Ygc2NoZW1hID09PSAndW5kZWZpbmVkJykgewoJCWlmICh0eXBlb2YgdXJsID09PSAnb2JqZWN0JyAmJiB0eXBlb2YgdXJsLmlkID09PSAnc3RyaW5nJykgewoJCQlzY2hlbWEgPSB1cmw7CgkJCXVybCA9IHNjaGVtYS5pZDsKCQl9CgkJZWxzZSB7CgkJCXJldHVybjsKCQl9Cgl9CglpZiAodXJsID09PSBnZXREb2N1bWVudFVyaSh1cmwpICsgIiMiKSB7CgkJLy8gUmVtb3ZlIGVtcHR5IGZyYWdtZW50CgkJdXJsID0gZ2V0RG9jdW1lbnRVcmkodXJsKTsKCX0KCXRoaXMuc2NoZW1hc1t1cmxdID0gc2NoZW1hOwoJZGVsZXRlIHRoaXMubWlzc2luZ01hcFt1cmxdOwoJbm9ybVNjaGVtYShzY2hlbWEsIHVybCk7Cgl0aGlzLnNlYXJjaFNjaGVtYXMoc2NoZW1hLCB1cmwpOwp9OwoKVmFsaWRhdG9yQ29udGV4dC5wcm90b3R5cGUuZ2V0U2NoZW1hTWFwID0gZnVuY3Rpb24gKCkgewoJdmFyIG1hcCA9IHt9OwoJZm9yICh2YXIga2V5IGluIHRoaXMuc2NoZW1hcykgewoJCW1hcFtrZXldID0gdGhpcy5zY2hlbWFzW2tleV07Cgl9CglyZXR1cm4gbWFwOwp9OwoKVmFsaWRhdG9yQ29udGV4dC5wcm90b3R5cGUuZ2V0U2NoZW1hVXJpcyA9IGZ1bmN0aW9uIChmaWx0ZXJSZWdFeHApIHsKCXZhciBsaXN0ID0gW107Cglmb3IgKHZhciBrZXkgaW4gdGhpcy5zY2hlbWFzKSB7CgkJaWYgKCFmaWx0ZXJSZWdFeHAgfHwgZmlsdGVyUmVnRXhwLnRlc3Qoa2V5KSkgewoJCQlsaXN0LnB1c2goa2V5KTsKCQl9Cgl9CglyZXR1cm4gbGlzdDsKfTsKClZhbGlkYXRvckNvbnRleHQucHJvdG90eXBlLmdldE1pc3NpbmdVcmlzID0gZnVuY3Rpb24gKGZpbHRlclJlZ0V4cCkgewoJdmFyIGxpc3QgPSBbXTsKCWZvciAodmFyIGtleSBpbiB0aGlzLm1pc3NpbmdNYXApIHsKCQlpZiAoIWZpbHRlclJlZ0V4cCB8fCBmaWx0ZXJSZWdFeHAudGVzdChrZXkpKSB7CgkJCWxpc3QucHVzaChrZXkpOwoJCX0KCX0KCXJldHVybiBsaXN0Owp9OwoKVmFsaWRhdG9yQ29udGV4dC5wcm90b3R5cGUuZHJvcFNjaGVtYXMgPSBmdW5jdGlvbiAoKSB7Cgl0aGlzLnNjaGVtYXMgPSB7fTsKCXRoaXMucmVzZXQoKTsKfTsKVmFsaWRhdG9yQ29udGV4dC5wcm90b3R5cGUucmVzZXQgPSBmdW5jdGlvbiAoKSB7Cgl0aGlzLm1pc3NpbmcgPSBbXTsKCXRoaXMubWlzc2luZ01hcCA9IHt9OwoJdGhpcy5lcnJvcnMgPSBbXTsKfTsKClZhbGlkYXRvckNvbnRleHQucHJvdG90eXBlLnZhbGlkYXRlQWxsID0gZnVuY3Rpb24gKGRhdGEsIHNjaGVtYSwgZGF0YVBhdGhQYXJ0cywgc2NoZW1hUGF0aFBhcnRzLCBkYXRhUG9pbnRlclBhdGgpIHsKCXZhciB0b3BMZXZlbDsKCXNjaGVtYSA9IHRoaXMucmVzb2x2ZVJlZnMoc2NoZW1hKTsKCWlmICghc2NoZW1hKSB7CgkJcmV0dXJuIG51bGw7Cgl9IGVsc2UgaWYgKHNjaGVtYSBpbnN0YW5jZW9mIFZhbGlkYXRpb25FcnJvcikgewoJCXRoaXMuZXJyb3JzLnB1c2goc2NoZW1hKTsKCQlyZXR1cm4gc2NoZW1hOwoJfQoKCXZhciBzdGFydEVycm9yQ291bnQgPSB0aGlzLmVycm9ycy5sZW5ndGg7Cgl2YXIgZnJvemVuSW5kZXgsIHNjYW5uZWRGcm96ZW5TY2hlbWFJbmRleCA9IG51bGwsIHNjYW5uZWRTY2hlbWFzSW5kZXggPSBudWxsOwoJaWYgKHRoaXMuY2hlY2tSZWN1cnNpdmUgJiYgZGF0YSAmJiB0eXBlb2YgZGF0YSA9PT0gJ29iamVjdCcpIHsKCQl0b3BMZXZlbCA9ICF0aGlzLnNjYW5uZWQubGVuZ3RoOwoJCWlmIChkYXRhW3RoaXMudmFsaWRhdGVkU2NoZW1hc0tleV0pIHsKCQkJdmFyIHNjaGVtYUluZGV4ID0gZGF0YVt0aGlzLnZhbGlkYXRlZFNjaGVtYXNLZXldLmluZGV4T2Yoc2NoZW1hKTsKCQkJaWYgKHNjaGVtYUluZGV4ICE9PSAtMSkgewoJCQkJdGhpcy5lcnJvcnMgPSB0aGlzLmVycm9ycy5jb25jYXQoZGF0YVt0aGlzLnZhbGlkYXRpb25FcnJvcnNLZXldW3NjaGVtYUluZGV4XSk7CgkJCQlyZXR1cm4gbnVsbDsKCQkJfQoJCX0KCQlpZiAoT2JqZWN0LmlzRnJvemVuKGRhdGEpKSB7CgkJCWZyb3plbkluZGV4ID0gdGhpcy5zY2FubmVkRnJvemVuLmluZGV4T2YoZGF0YSk7CgkJCWlmIChmcm96ZW5JbmRleCAhPT0gLTEpIHsKCQkJCXZhciBmcm96ZW5TY2hlbWFJbmRleCA9IHRoaXMuc2Nhbm5lZEZyb3plblNjaGVtYXNbZnJvemVuSW5kZXhdLmluZGV4T2Yoc2NoZW1hKTsKCQkJCWlmIChmcm96ZW5TY2hlbWFJbmRleCAhPT0gLTEpIHsKCQkJCQl0aGlzLmVycm9ycyA9IHRoaXMuZXJyb3JzLmNvbmNhdCh0aGlzLnNjYW5uZWRGcm96ZW5WYWxpZGF0aW9uRXJyb3JzW2Zyb3plbkluZGV4XVtmcm96ZW5TY2hlbWFJbmRleF0pOwoJCQkJCXJldHVybiBudWxsOwoJCQkJfQoJCQl9CgkJfQoJCXRoaXMuc2Nhbm5lZC5wdXNoKGRhdGEpOwoJCWlmIChPYmplY3QuaXNGcm96ZW4oZGF0YSkpIHsKCQkJaWYgKGZyb3plbkluZGV4ID09PSAtMSkgewoJCQkJZnJvemVuSW5kZXggPSB0aGlzLnNjYW5uZWRGcm96ZW4ubGVuZ3RoOwoJCQkJdGhpcy5zY2FubmVkRnJvemVuLnB1c2goZGF0YSk7CgkJCQl0aGlzLnNjYW5uZWRGcm96ZW5TY2hlbWFzLnB1c2goW10pOwoJCQl9CgkJCXNjYW5uZWRGcm96ZW5TY2hlbWFJbmRleCA9IHRoaXMuc2Nhbm5lZEZyb3plblNjaGVtYXNbZnJvemVuSW5kZXhdLmxlbmd0aDsKCQkJdGhpcy5zY2FubmVkRnJvemVuU2NoZW1hc1tmcm96ZW5JbmRleF1bc2Nhbm5lZEZyb3plblNjaGVtYUluZGV4XSA9IHNjaGVtYTsKCQkJdGhpcy5zY2FubmVkRnJvemVuVmFsaWRhdGlvbkVycm9yc1tmcm96ZW5JbmRleF1bc2Nhbm5lZEZyb3plblNjaGVtYUluZGV4XSA9IFtdOwoJCX0gZWxzZSB7CgkJCWlmICghZGF0YVt0aGlzLnZhbGlkYXRlZFNjaGVtYXNLZXldKSB7CgkJCQl0cnkgewoJCQkJCU9iamVjdC5kZWZpbmVQcm9wZXJ0eShkYXRhLCB0aGlzLnZhbGlkYXRlZFNjaGVtYXNLZXksIHsKCQkJCQkJdmFsdWU6IFtdLAoJCQkJCQljb25maWd1cmFibGU6IHRydWUKCQkJCQl9KTsKCQkJCQlPYmplY3QuZGVmaW5lUHJvcGVydHkoZGF0YSwgdGhpcy52YWxpZGF0aW9uRXJyb3JzS2V5LCB7CgkJCQkJCXZhbHVlOiBbXSwKCQkJCQkJY29uZmlndXJhYmxlOiB0cnVlCgkJCQkJfSk7CgkJCQl9IGNhdGNoIChlKSB7CgkJCQkJLy9JRSA3Lzggd29ya2Fyb3VuZAoJCQkJCWRhdGFbdGhpcy52YWxpZGF0ZWRTY2hlbWFzS2V5XSA9IFtdOwoJCQkJCWRhdGFbdGhpcy52YWxpZGF0aW9uRXJyb3JzS2V5XSA9IFtdOwoJCQkJfQoJCQl9CgkJCXNjYW5uZWRTY2hlbWFzSW5kZXggPSBkYXRhW3RoaXMudmFsaWRhdGVkU2NoZW1hc0tleV0ubGVuZ3RoOwoJCQlkYXRhW3RoaXMudmFsaWRhdGVkU2NoZW1hc0tleV1bc2Nhbm5lZFNjaGVtYXNJbmRleF0gPSBzY2hlbWE7CgkJCWRhdGFbdGhpcy52YWxpZGF0aW9uRXJyb3JzS2V5XVtzY2FubmVkU2NoZW1hc0luZGV4XSA9IFtdOwoJCX0KCX0KCgl2YXIgZXJyb3JDb3VudCA9IHRoaXMuZXJyb3JzLmxlbmd0aDsKCXZhciBlcnJvciA9IHRoaXMudmFsaWRhdGVCYXNpYyhkYXRhLCBzY2hlbWEsIGRhdGFQb2ludGVyUGF0aCkKCQl8fCB0aGlzLnZhbGlkYXRlTnVtZXJpYyhkYXRhLCBzY2hlbWEsIGRhdGFQb2ludGVyUGF0aCkKCQl8fCB0aGlzLnZhbGlkYXRlU3RyaW5nKGRhdGEsIHNjaGVtYSwgZGF0YVBvaW50ZXJQYXRoKQoJCXx8IHRoaXMudmFsaWRhdGVBcnJheShkYXRhLCBzY2hlbWEsIGRhdGFQb2ludGVyUGF0aCkKCQl8fCB0aGlzLnZhbGlkYXRlT2JqZWN0KGRhdGEsIHNjaGVtYSwgZGF0YVBvaW50ZXJQYXRoKQoJCXx8IHRoaXMudmFsaWRhdGVDb21iaW5hdGlvbnMoZGF0YSwgc2NoZW1hLCBkYXRhUG9pbnRlclBhdGgpCgkJfHwgdGhpcy52YWxpZGF0ZUh5cGVybWVkaWEoZGF0YSwgc2NoZW1hLCBkYXRhUG9pbnRlclBhdGgpCgkJfHwgdGhpcy52YWxpZGF0ZUZvcm1hdChkYXRhLCBzY2hlbWEsIGRhdGFQb2ludGVyUGF0aCkKCQl8fCB0aGlzLnZhbGlkYXRlRGVmaW5lZEtleXdvcmRzKGRhdGEsIHNjaGVtYSwgZGF0YVBvaW50ZXJQYXRoKQoJCXx8IG51bGw7CgoJaWYgKHRvcExldmVsKSB7CgkJd2hpbGUgKHRoaXMuc2Nhbm5lZC5sZW5ndGgpIHsKCQkJdmFyIGl0ZW0gPSB0aGlzLnNjYW5uZWQucG9wKCk7CgkJCWRlbGV0ZSBpdGVtW3RoaXMudmFsaWRhdGVkU2NoZW1hc0tleV07CgkJfQoJCXRoaXMuc2Nhbm5lZEZyb3plbiA9IFtdOwoJCXRoaXMuc2Nhbm5lZEZyb3plblNjaGVtYXMgPSBbXTsKCX0KCglpZiAoZXJyb3IgfHwgZXJyb3JDb3VudCAhPT0gdGhpcy5lcnJvcnMubGVuZ3RoKSB7CgkJd2hpbGUgKChkYXRhUGF0aFBhcnRzICYmIGRhdGFQYXRoUGFydHMubGVuZ3RoKSB8fCAoc2NoZW1hUGF0aFBhcnRzICYmIHNjaGVtYVBhdGhQYXJ0cy5sZW5ndGgpKSB7CgkJCXZhciBkYXRhUGFydCA9IChkYXRhUGF0aFBhcnRzICYmIGRhdGFQYXRoUGFydHMubGVuZ3RoKSA/ICIiICsgZGF0YVBhdGhQYXJ0cy5wb3AoKSA6IG51bGw7CgkJCXZhciBzY2hlbWFQYXJ0ID0gKHNjaGVtYVBhdGhQYXJ0cyAmJiBzY2hlbWFQYXRoUGFydHMubGVuZ3RoKSA/ICIiICsgc2NoZW1hUGF0aFBhcnRzLnBvcCgpIDogbnVsbDsKCQkJaWYgKGVycm9yKSB7CgkJCQllcnJvciA9IGVycm9yLnByZWZpeFdpdGgoZGF0YVBhcnQsIHNjaGVtYVBhcnQpOwoJCQl9CgkJCXRoaXMucHJlZml4RXJyb3JzKGVycm9yQ291bnQsIGRhdGFQYXJ0LCBzY2hlbWFQYXJ0KTsKCQl9Cgl9CgoJaWYgKHNjYW5uZWRGcm96ZW5TY2hlbWFJbmRleCAhPT0gbnVsbCkgewoJCXRoaXMuc2Nhbm5lZEZyb3plblZhbGlkYXRpb25FcnJvcnNbZnJvemVuSW5kZXhdW3NjYW5uZWRGcm96ZW5TY2hlbWFJbmRleF0gPSB0aGlzLmVycm9ycy5zbGljZShzdGFydEVycm9yQ291bnQpOwoJfSBlbHNlIGlmIChzY2FubmVkU2NoZW1hc0luZGV4ICE9PSBudWxsKSB7CgkJZGF0YVt0aGlzLnZhbGlkYXRpb25FcnJvcnNLZXldW3NjYW5uZWRTY2hlbWFzSW5kZXhdID0gdGhpcy5lcnJvcnMuc2xpY2Uoc3RhcnRFcnJvckNvdW50KTsKCX0KCglyZXR1cm4gdGhpcy5oYW5kbGVFcnJvcihlcnJvcik7Cn07ClZhbGlkYXRvckNvbnRleHQucHJvdG90eXBlLnZhbGlkYXRlRm9ybWF0ID0gZnVuY3Rpb24gKGRhdGEsIHNjaGVtYSkgewoJaWYgKHR5cGVvZiBzY2hlbWEuZm9ybWF0ICE9PSAnc3RyaW5nJyB8fCAhdGhpcy5mb3JtYXRWYWxpZGF0b3JzW3NjaGVtYS5mb3JtYXRdKSB7CgkJcmV0dXJuIG51bGw7Cgl9Cgl2YXIgZXJyb3JNZXNzYWdlID0gdGhpcy5mb3JtYXRWYWxpZGF0b3JzW3NjaGVtYS5mb3JtYXRdLmNhbGwobnVsbCwgZGF0YSwgc2NoZW1hKTsKCWlmICh0eXBlb2YgZXJyb3JNZXNzYWdlID09PSAnc3RyaW5nJyB8fCB0eXBlb2YgZXJyb3JNZXNzYWdlID09PSAnbnVtYmVyJykgewoJCXJldHVybiB0aGlzLmNyZWF0ZUVycm9yKEVycm9yQ29kZXMuRk9STUFUX0NVU1RPTSwge21lc3NhZ2U6IGVycm9yTWVzc2FnZX0sICcnLCAnL2Zvcm1hdCcsIG51bGwsIGRhdGEsIHNjaGVtYSk7Cgl9IGVsc2UgaWYgKGVycm9yTWVzc2FnZSAmJiB0eXBlb2YgZXJyb3JNZXNzYWdlID09PSAnb2JqZWN0JykgewoJCXJldHVybiB0aGlzLmNyZWF0ZUVycm9yKEVycm9yQ29kZXMuRk9STUFUX0NVU1RPTSwge21lc3NhZ2U6IGVycm9yTWVzc2FnZS5tZXNzYWdlIHx8ICI/In0sIGVycm9yTWVzc2FnZS5kYXRhUGF0aCB8fCAnJywgZXJyb3JNZXNzYWdlLnNjaGVtYVBhdGggfHwgIi9mb3JtYXQiLCBudWxsLCBkYXRhLCBzY2hlbWEpOwoJfQoJcmV0dXJuIG51bGw7Cn07ClZhbGlkYXRvckNvbnRleHQucHJvdG90eXBlLnZhbGlkYXRlRGVmaW5lZEtleXdvcmRzID0gZnVuY3Rpb24gKGRhdGEsIHNjaGVtYSwgZGF0YVBvaW50ZXJQYXRoKSB7Cglmb3IgKHZhciBrZXkgaW4gdGhpcy5kZWZpbmVkS2V5d29yZHMpIHsKCQlpZiAodHlwZW9mIHNjaGVtYVtrZXldID09PSAndW5kZWZpbmVkJykgewoJCQljb250aW51ZTsKCQl9CgkJdmFyIHZhbGlkYXRpb25GdW5jdGlvbnMgPSB0aGlzLmRlZmluZWRLZXl3b3Jkc1trZXldOwoJCWZvciAodmFyIGkgPSAwOyBpIDwgdmFsaWRhdGlvbkZ1bmN0aW9ucy5sZW5ndGg7IGkrKykgewoJCQl2YXIgZnVuYyA9IHZhbGlkYXRpb25GdW5jdGlvbnNbaV07CgkJCXZhciByZXN1bHQgPSBmdW5jKGRhdGEsIHNjaGVtYVtrZXldLCBzY2hlbWEsIGRhdGFQb2ludGVyUGF0aCk7CgkJCWlmICh0eXBlb2YgcmVzdWx0ID09PSAnc3RyaW5nJyB8fCB0eXBlb2YgcmVzdWx0ID09PSAnbnVtYmVyJykgewoJCQkJcmV0dXJuIHRoaXMuY3JlYXRlRXJyb3IoRXJyb3JDb2Rlcy5LRVlXT1JEX0NVU1RPTSwge2tleToga2V5LCBtZXNzYWdlOiByZXN1bHR9LCAnJywgJycsIG51bGwsIGRhdGEsIHNjaGVtYSkucHJlZml4V2l0aChudWxsLCBrZXkpOwoJCQl9IGVsc2UgaWYgKHJlc3VsdCAmJiB0eXBlb2YgcmVzdWx0ID09PSAnb2JqZWN0JykgewoJCQkJdmFyIGNvZGUgPSByZXN1bHQuY29kZTsKCQkJCWlmICh0eXBlb2YgY29kZSA9PT0gJ3N0cmluZycpIHsKCQkJCQlpZiAoIUVycm9yQ29kZXNbY29kZV0pIHsKCQkJCQkJdGhyb3cgbmV3IEVycm9yKCdVbmRlZmluZWQgZXJyb3IgY29kZSAodXNlIGRlZmluZUVycm9yKTogJyArIGNvZGUpOwoJCQkJCX0KCQkJCQljb2RlID0gRXJyb3JDb2Rlc1tjb2RlXTsKCQkJCX0gZWxzZSBpZiAodHlwZW9mIGNvZGUgIT09ICdudW1iZXInKSB7CgkJCQkJY29kZSA9IEVycm9yQ29kZXMuS0VZV09SRF9DVVNUT007CgkJCQl9CgkJCQl2YXIgbWVzc2FnZVBhcmFtcyA9ICh0eXBlb2YgcmVzdWx0Lm1lc3NhZ2UgPT09ICdvYmplY3QnKSA/IHJlc3VsdC5tZXNzYWdlIDoge2tleToga2V5LCBtZXNzYWdlOiByZXN1bHQubWVzc2FnZSB8fCAiPyJ9OwoJCQkJdmFyIHNjaGVtYVBhdGggPSByZXN1bHQuc2NoZW1hUGF0aCB8fCAoIi8iICsga2V5LnJlcGxhY2UoL34vZywgJ34wJykucmVwbGFjZSgvXC8vZywgJ34xJykpOwoJCQkJcmV0dXJuIHRoaXMuY3JlYXRlRXJyb3IoY29kZSwgbWVzc2FnZVBhcmFtcywgcmVzdWx0LmRhdGFQYXRoIHx8IG51bGwsIHNjaGVtYVBhdGgsIG51bGwsIGRhdGEsIHNjaGVtYSk7CgkJCX0KCQl9Cgl9CglyZXR1cm4gbnVsbDsKfTsKCmZ1bmN0aW9uIHJlY3Vyc2l2ZUNvbXBhcmUoQSwgQikgewoJaWYgKEEgPT09IEIpIHsKCQlyZXR1cm4gdHJ1ZTsKCX0KCWlmIChBICYmIEIgJiYgdHlwZW9mIEEgPT09ICJvYmplY3QiICYmIHR5cGVvZiBCID09PSAib2JqZWN0IikgewoJCWlmIChBcnJheS5pc0FycmF5KEEpICE9PSBBcnJheS5pc0FycmF5KEIpKSB7CgkJCXJldHVybiBmYWxzZTsKCQl9IGVsc2UgaWYgKEFycmF5LmlzQXJyYXkoQSkpIHsKCQkJaWYgKEEubGVuZ3RoICE9PSBCLmxlbmd0aCkgewoJCQkJcmV0dXJuIGZhbHNlOwoJCQl9CgkJCWZvciAodmFyIGkgPSAwOyBpIDwgQS5sZW5ndGg7IGkrKykgewoJCQkJaWYgKCFyZWN1cnNpdmVDb21wYXJlKEFbaV0sIEJbaV0pKSB7CgkJCQkJcmV0dXJuIGZhbHNlOwoJCQkJfQoJCQl9CgkJfSBlbHNlIHsKCQkJdmFyIGtleTsKCQkJZm9yIChrZXkgaW4gQSkgewoJCQkJaWYgKEJba2V5XSA9PT0gdW5kZWZpbmVkICYmIEFba2V5XSAhPT0gdW5kZWZpbmVkKSB7CgkJCQkJcmV0dXJuIGZhbHNlOwoJCQkJfQoJCQl9CgkJCWZvciAoa2V5IGluIEIpIHsKCQkJCWlmIChBW2tleV0gPT09IHVuZGVmaW5lZCAmJiBCW2tleV0gIT09IHVuZGVmaW5lZCkgewoJCQkJCXJldHVybiBmYWxzZTsKCQkJCX0KCQkJfQoJCQlmb3IgKGtleSBpbiBBKSB7CgkJCQlpZiAoIXJlY3Vyc2l2ZUNvbXBhcmUoQVtrZXldLCBCW2tleV0pKSB7CgkJCQkJcmV0dXJuIGZhbHNlOwoJCQkJfQoJCQl9CgkJfQoJCXJldHVybiB0cnVlOwoJfQoJcmV0dXJuIGZhbHNlOwp9CgpWYWxpZGF0b3JDb250ZXh0LnByb3RvdHlwZS52YWxpZGF0ZUJhc2ljID0gZnVuY3Rpb24gdmFsaWRhdGVCYXNpYyhkYXRhLCBzY2hlbWEsIGRhdGFQb2ludGVyUGF0aCkgewoJdmFyIGVycm9yOwoJaWYgKGVycm9yID0gdGhpcy52YWxpZGF0ZVR5cGUoZGF0YSwgc2NoZW1hLCBkYXRhUG9pbnRlclBhdGgpKSB7CgkJcmV0dXJuIGVycm9yLnByZWZpeFdpdGgobnVsbCwgInR5cGUiKTsKCX0KCWlmIChlcnJvciA9IHRoaXMudmFsaWRhdGVFbnVtKGRhdGEsIHNjaGVtYSwgZGF0YVBvaW50ZXJQYXRoKSkgewoJCXJldHVybiBlcnJvci5wcmVmaXhXaXRoKG51bGwsICJ0eXBlIik7Cgl9CglyZXR1cm4gbnVsbDsKfTsKClZhbGlkYXRvckNvbnRleHQucHJvdG90eXBlLnZhbGlkYXRlVHlwZSA9IGZ1bmN0aW9uIHZhbGlkYXRlVHlwZShkYXRhLCBzY2hlbWEpIHsKCWlmIChzY2hlbWEudHlwZSA9PT0gdW5kZWZpbmVkKSB7CgkJcmV0dXJuIG51bGw7Cgl9Cgl2YXIgZGF0YVR5cGUgPSB0eXBlb2YgZGF0YTsKCWlmIChkYXRhID09PSBudWxsKSB7CgkJZGF0YVR5cGUgPSAibnVsbCI7Cgl9IGVsc2UgaWYgKEFycmF5LmlzQXJyYXkoZGF0YSkpIHsKCQlkYXRhVHlwZSA9ICJhcnJheSI7Cgl9Cgl2YXIgYWxsb3dlZFR5cGVzID0gc2NoZW1hLnR5cGU7CglpZiAoIUFycmF5LmlzQXJyYXkoYWxsb3dlZFR5cGVzKSkgewoJCWFsbG93ZWRUeXBlcyA9IFthbGxvd2VkVHlwZXNdOwoJfQoKCWZvciAodmFyIGkgPSAwOyBpIDwgYWxsb3dlZFR5cGVzLmxlbmd0aDsgaSsrKSB7CgkJdmFyIHR5cGUgPSBhbGxvd2VkVHlwZXNbaV07CgkJaWYgKHR5cGUgPT09IGRhdGFUeXBlIHx8ICh0eXBlID09PSAiaW50ZWdlciIgJiYgZGF0YVR5cGUgPT09ICJudW1iZXIiICYmIChkYXRhICUgMSA9PT0gMCkpKSB7CgkJCXJldHVybiBudWxsOwoJCX0KCX0KCXJldHVybiB0aGlzLmNyZWF0ZUVycm9yKEVycm9yQ29kZXMuSU5WQUxJRF9UWVBFLCB7dHlwZTogZGF0YVR5cGUsIGV4cGVjdGVkOiBhbGxvd2VkVHlwZXMuam9pbigiLyIpfSwgJycsICcnLCBudWxsLCBkYXRhLCBzY2hlbWEpOwp9OwoKVmFsaWRhdG9yQ29udGV4dC5wcm90b3R5cGUudmFsaWRhdGVFbnVtID0gZnVuY3Rpb24gdmFsaWRhdGVFbnVtKGRhdGEsIHNjaGVtYSkgewoJaWYgKHNjaGVtYVsiZW51bSJdID09PSB1bmRlZmluZWQpIHsKCQlyZXR1cm4gbnVsbDsKCX0KCWZvciAodmFyIGkgPSAwOyBpIDwgc2NoZW1hWyJlbnVtIl0ubGVuZ3RoOyBpKyspIHsKCQl2YXIgZW51bVZhbCA9IHNjaGVtYVsiZW51bSJdW2ldOwoJCWlmIChyZWN1cnNpdmVDb21wYXJlKGRhdGEsIGVudW1WYWwpKSB7CgkJCXJldHVybiBudWxsOwoJCX0KCX0KCXJldHVybiB0aGlzLmNyZWF0ZUVycm9yKEVycm9yQ29kZXMuRU5VTV9NSVNNQVRDSCwge3ZhbHVlOiAodHlwZW9mIEpTT04gIT09ICd1bmRlZmluZWQnKSA/IEpTT04uc3RyaW5naWZ5KGRhdGEpIDogZGF0YX0sICcnLCAnJywgbnVsbCwgZGF0YSwgc2NoZW1hKTsKfTsKClZhbGlkYXRvckNvbnRleHQucHJvdG90eXBlLnZhbGlkYXRlTnVtZXJpYyA9IGZ1bmN0aW9uIHZhbGlkYXRlTnVtZXJpYyhkYXRhLCBzY2hlbWEsIGRhdGFQb2ludGVyUGF0aCkgewoJcmV0dXJuIHRoaXMudmFsaWRhdGVNdWx0aXBsZU9mKGRhdGEsIHNjaGVtYSwgZGF0YVBvaW50ZXJQYXRoKQoJCXx8IHRoaXMudmFsaWRhdGVNaW5NYXgoZGF0YSwgc2NoZW1hLCBkYXRhUG9pbnRlclBhdGgpCgkJfHwgdGhpcy52YWxpZGF0ZU5hTihkYXRhLCBzY2hlbWEsIGRhdGFQb2ludGVyUGF0aCkKCQl8fCBudWxsOwp9OwoKdmFyIENMT1NFX0VOT1VHSF9MT1cgPSBNYXRoLnBvdygyLCAtNTEpOwp2YXIgQ0xPU0VfRU5PVUdIX0hJR0ggPSAxIC0gQ0xPU0VfRU5PVUdIX0xPVzsKVmFsaWRhdG9yQ29udGV4dC5wcm90b3R5cGUudmFsaWRhdGVNdWx0aXBsZU9mID0gZnVuY3Rpb24gdmFsaWRhdGVNdWx0aXBsZU9mKGRhdGEsIHNjaGVtYSkgewoJdmFyIG11bHRpcGxlT2YgPSBzY2hlbWEubXVsdGlwbGVPZiB8fCBzY2hlbWEuZGl2aXNpYmxlQnk7CglpZiAobXVsdGlwbGVPZiA9PT0gdW5kZWZpbmVkKSB7CgkJcmV0dXJuIG51bGw7Cgl9CglpZiAodHlwZW9mIGRhdGEgPT09ICJudW1iZXIiKSB7CgkJdmFyIHJlbWFpbmRlciA9IChkYXRhL211bHRpcGxlT2YpJTE7CgkJaWYgKHJlbWFpbmRlciA+PSBDTE9TRV9FTk9VR0hfTE9XICYmIHJlbWFpbmRlciA8IENMT1NFX0VOT1VHSF9ISUdIKSB7CgkJCXJldHVybiB0aGlzLmNyZWF0ZUVycm9yKEVycm9yQ29kZXMuTlVNQkVSX01VTFRJUExFX09GLCB7dmFsdWU6IGRhdGEsIG11bHRpcGxlT2Y6IG11bHRpcGxlT2Z9LCAnJywgJycsIG51bGwsIGRhdGEsIHNjaGVtYSk7CgkJfQoJfQoJcmV0dXJuIG51bGw7Cn07CgpWYWxpZGF0b3JDb250ZXh0LnByb3RvdHlwZS52YWxpZGF0ZU1pbk1heCA9IGZ1bmN0aW9uIHZhbGlkYXRlTWluTWF4KGRhdGEsIHNjaGVtYSkgewoJaWYgKHR5cGVvZiBkYXRhICE9PSAibnVtYmVyIikgewoJCXJldHVybiBudWxsOwoJfQoJaWYgKHNjaGVtYS5taW5pbXVtICE9PSB1bmRlZmluZWQpIHsKCQlpZiAoZGF0YSA8IHNjaGVtYS5taW5pbXVtKSB7CgkJCXJldHVybiB0aGlzLmNyZWF0ZUVycm9yKEVycm9yQ29kZXMuTlVNQkVSX01JTklNVU0sIHt2YWx1ZTogZGF0YSwgbWluaW11bTogc2NoZW1hLm1pbmltdW19LCAnJywgJy9taW5pbXVtJywgbnVsbCwgZGF0YSwgc2NoZW1hKTsKCQl9CgkJaWYgKHNjaGVtYS5leGNsdXNpdmVNaW5pbXVtICYmIGRhdGEgPT09IHNjaGVtYS5taW5pbXVtKSB7CgkJCXJldHVybiB0aGlzLmNyZWF0ZUVycm9yKEVycm9yQ29kZXMuTlVNQkVSX01JTklNVU1fRVhDTFVTSVZFLCB7dmFsdWU6IGRhdGEsIG1pbmltdW06IHNjaGVtYS5taW5pbXVtfSwgJycsICcvZXhjbHVzaXZlTWluaW11bScsIG51bGwsIGRhdGEsIHNjaGVtYSk7CgkJfQoJfQoJaWYgKHNjaGVtYS5tYXhpbXVtICE9PSB1bmRlZmluZWQpIHsKCQlpZiAoZGF0YSA+IHNjaGVtYS5tYXhpbXVtKSB7CgkJCXJldHVybiB0aGlzLmNyZWF0ZUVycm9yKEVycm9yQ29kZXMuTlVNQkVSX01BWElNVU0sIHt2YWx1ZTogZGF0YSwgbWF4aW11bTogc2NoZW1hLm1heGltdW19LCAnJywgJy9tYXhpbXVtJywgbnVsbCwgZGF0YSwgc2NoZW1hKTsKCQl9CgkJaWYgKHNjaGVtYS5leGNsdXNpdmVNYXhpbXVtICYmIGRhdGEgPT09IHNjaGVtYS5tYXhpbXVtKSB7CgkJCXJldHVybiB0aGlzLmNyZWF0ZUVycm9yKEVycm9yQ29kZXMuTlVNQkVSX01BWElNVU1fRVhDTFVTSVZFLCB7dmFsdWU6IGRhdGEsIG1heGltdW06IHNjaGVtYS5tYXhpbXVtfSwgJycsICcvZXhjbHVzaXZlTWF4aW11bScsIG51bGwsIGRhdGEsIHNjaGVtYSk7CgkJfQoJfQoJcmV0dXJuIG51bGw7Cn07CgpWYWxpZGF0b3JDb250ZXh0LnByb3RvdHlwZS52YWxpZGF0ZU5hTiA9IGZ1bmN0aW9uIHZhbGlkYXRlTmFOKGRhdGEsIHNjaGVtYSkgewoJaWYgKHR5cGVvZiBkYXRhICE9PSAibnVtYmVyIikgewoJCXJldHVybiBudWxsOwoJfQoJaWYgKGlzTmFOKGRhdGEpID09PSB0cnVlIHx8IGRhdGEgPT09IEluZmluaXR5IHx8IGRhdGEgPT09IC1JbmZpbml0eSkgewoJCXJldHVybiB0aGlzLmNyZWF0ZUVycm9yKEVycm9yQ29kZXMuTlVNQkVSX05PVF9BX05VTUJFUiwge3ZhbHVlOiBkYXRhfSwgJycsICcvdHlwZScsIG51bGwsIGRhdGEsIHNjaGVtYSk7Cgl9CglyZXR1cm4gbnVsbDsKfTsKClZhbGlkYXRvckNvbnRleHQucHJvdG90eXBlLnZhbGlkYXRlU3RyaW5nID0gZnVuY3Rpb24gdmFsaWRhdGVTdHJpbmcoZGF0YSwgc2NoZW1hLCBkYXRhUG9pbnRlclBhdGgpIHsKCXJldHVybiB0aGlzLnZhbGlkYXRlU3RyaW5nTGVuZ3RoKGRhdGEsIHNjaGVtYSwgZGF0YVBvaW50ZXJQYXRoKQoJCXx8IHRoaXMudmFsaWRhdGVTdHJpbmdQYXR0ZXJuKGRhdGEsIHNjaGVtYSwgZGF0YVBvaW50ZXJQYXRoKQoJCXx8IG51bGw7Cn07CgpWYWxpZGF0b3JDb250ZXh0LnByb3RvdHlwZS52YWxpZGF0ZVN0cmluZ0xlbmd0aCA9IGZ1bmN0aW9uIHZhbGlkYXRlU3RyaW5nTGVuZ3RoKGRhdGEsIHNjaGVtYSkgewoJaWYgKHR5cGVvZiBkYXRhICE9PSAic3RyaW5nIikgewoJCXJldHVybiBudWxsOwoJfQoJaWYgKHNjaGVtYS5taW5MZW5ndGggIT09IHVuZGVmaW5lZCkgewoJCWlmIChkYXRhLmxlbmd0aCA8IHNjaGVtYS5taW5MZW5ndGgpIHsKCQkJcmV0dXJuIHRoaXMuY3JlYXRlRXJyb3IoRXJyb3JDb2Rlcy5TVFJJTkdfTEVOR1RIX1NIT1JULCB7bGVuZ3RoOiBkYXRhLmxlbmd0aCwgbWluaW11bTogc2NoZW1hLm1pbkxlbmd0aH0sICcnLCAnL21pbkxlbmd0aCcsIG51bGwsIGRhdGEsIHNjaGVtYSk7CgkJfQoJfQoJaWYgKHNjaGVtYS5tYXhMZW5ndGggIT09IHVuZGVmaW5lZCkgewoJCWlmIChkYXRhLmxlbmd0aCA+IHNjaGVtYS5tYXhMZW5ndGgpIHsKCQkJcmV0dXJuIHRoaXMuY3JlYXRlRXJyb3IoRXJyb3JDb2Rlcy5TVFJJTkdfTEVOR1RIX0xPTkcsIHtsZW5ndGg6IGRhdGEubGVuZ3RoLCBtYXhpbXVtOiBzY2hlbWEubWF4TGVuZ3RofSwgJycsICcvbWF4TGVuZ3RoJywgbnVsbCwgZGF0YSwgc2NoZW1hKTsKCQl9Cgl9CglyZXR1cm4gbnVsbDsKfTsKClZhbGlkYXRvckNvbnRleHQucHJvdG90eXBlLnZhbGlkYXRlU3RyaW5nUGF0dGVybiA9IGZ1bmN0aW9uIHZhbGlkYXRlU3RyaW5nUGF0dGVybihkYXRhLCBzY2hlbWEpIHsKCWlmICh0eXBlb2YgZGF0YSAhPT0gInN0cmluZyIgfHwgKHR5cGVvZiBzY2hlbWEucGF0dGVybiAhPT0gInN0cmluZyIgJiYgIShzY2hlbWEucGF0dGVybiBpbnN0YW5jZW9mIFJlZ0V4cCkpKSB7CgkJcmV0dXJuIG51bGw7Cgl9Cgl2YXIgcmVnZXhwOwoJaWYgKHNjaGVtYS5wYXR0ZXJuIGluc3RhbmNlb2YgUmVnRXhwKSB7CgkgIHJlZ2V4cCA9IHNjaGVtYS5wYXR0ZXJuOwoJfQoJZWxzZSB7CgkgIHZhciBib2R5LCBmbGFncyA9ICcnOwoJICAvLyBDaGVjayBmb3IgcmVndWxhciBleHByZXNzaW9uIGxpdGVyYWxzCgkgIC8vIEBzZWUgaHR0cDovL3d3dy5lY21hLWludGVybmF0aW9uYWwub3JnL2VjbWEtMjYyLzUuMS8jc2VjLTcuOC41CgkgIHZhciBsaXRlcmFsID0gc2NoZW1hLnBhdHRlcm4ubWF0Y2goL15cLyguKylcLyhbaW1nXSopJC8pOwoJICBpZiAobGl0ZXJhbCkgewoJICAgIGJvZHkgPSBsaXRlcmFsWzFdOwoJICAgIGZsYWdzID0gbGl0ZXJhbFsyXTsKCSAgfQoJICBlbHNlIHsKCSAgICBib2R5ID0gc2NoZW1hLnBhdHRlcm47CgkgIH0KCSAgcmVnZXhwID0gbmV3IFJlZ0V4cChib2R5LCBmbGFncyk7Cgl9CglpZiAoIXJlZ2V4cC50ZXN0KGRhdGEpKSB7CgkJcmV0dXJuIHRoaXMuY3JlYXRlRXJyb3IoRXJyb3JDb2Rlcy5TVFJJTkdfUEFUVEVSTiwge3BhdHRlcm46IHNjaGVtYS5wYXR0ZXJufSwgJycsICcvcGF0dGVybicsIG51bGwsIGRhdGEsIHNjaGVtYSk7Cgl9CglyZXR1cm4gbnVsbDsKfTsKClZhbGlkYXRvckNvbnRleHQucHJvdG90eXBlLnZhbGlkYXRlQXJyYXkgPSBmdW5jdGlvbiB2YWxpZGF0ZUFycmF5KGRhdGEsIHNjaGVtYSwgZGF0YVBvaW50ZXJQYXRoKSB7CglpZiAoIUFycmF5LmlzQXJyYXkoZGF0YSkpIHsKCQlyZXR1cm4gbnVsbDsKCX0KCXJldHVybiB0aGlzLnZhbGlkYXRlQXJyYXlMZW5ndGgoZGF0YSwgc2NoZW1hLCBkYXRhUG9pbnRlclBhdGgpCgkJfHwgdGhpcy52YWxpZGF0ZUFycmF5VW5pcXVlSXRlbXMoZGF0YSwgc2NoZW1hLCBkYXRhUG9pbnRlclBhdGgpCgkJfHwgdGhpcy52YWxpZGF0ZUFycmF5SXRlbXMoZGF0YSwgc2NoZW1hLCBkYXRhUG9pbnRlclBhdGgpCgkJfHwgbnVsbDsKfTsKClZhbGlkYXRvckNvbnRleHQucHJvdG90eXBlLnZhbGlkYXRlQXJyYXlMZW5ndGggPSBmdW5jdGlvbiB2YWxpZGF0ZUFycmF5TGVuZ3RoKGRhdGEsIHNjaGVtYSkgewoJdmFyIGVycm9yOwoJaWYgKHNjaGVtYS5taW5JdGVtcyAhPT0gdW5kZWZpbmVkKSB7CgkJaWYgKGRhdGEubGVuZ3RoIDwgc2NoZW1hLm1pbkl0ZW1zKSB7CgkJCWVycm9yID0gdGhpcy5jcmVhdGVFcnJvcihFcnJvckNvZGVzLkFSUkFZX0xFTkdUSF9TSE9SVCwge2xlbmd0aDogZGF0YS5sZW5ndGgsIG1pbmltdW06IHNjaGVtYS5taW5JdGVtc30sICcnLCAnL21pbkl0ZW1zJywgbnVsbCwgZGF0YSwgc2NoZW1hKTsKCQkJaWYgKHRoaXMuaGFuZGxlRXJyb3IoZXJyb3IpKSB7CgkJCQlyZXR1cm4gZXJyb3I7CgkJCX0KCQl9Cgl9CglpZiAoc2NoZW1hLm1heEl0ZW1zICE9PSB1bmRlZmluZWQpIHsKCQlpZiAoZGF0YS5sZW5ndGggPiBzY2hlbWEubWF4SXRlbXMpIHsKCQkJZXJyb3IgPSB0aGlzLmNyZWF0ZUVycm9yKEVycm9yQ29kZXMuQVJSQVlfTEVOR1RIX0xPTkcsIHtsZW5ndGg6IGRhdGEubGVuZ3RoLCBtYXhpbXVtOiBzY2hlbWEubWF4SXRlbXN9LCAnJywgJy9tYXhJdGVtcycsIG51bGwsIGRhdGEsIHNjaGVtYSk7CgkJCWlmICh0aGlzLmhhbmRsZUVycm9yKGVycm9yKSkgewoJCQkJcmV0dXJuIGVycm9yOwoJCQl9CgkJfQoJfQoJcmV0dXJuIG51bGw7Cn07CgpWYWxpZGF0b3JDb250ZXh0LnByb3RvdHlwZS52YWxpZGF0ZUFycmF5VW5pcXVlSXRlbXMgPSBmdW5jdGlvbiB2YWxpZGF0ZUFycmF5VW5pcXVlSXRlbXMoZGF0YSwgc2NoZW1hKSB7CglpZiAoc2NoZW1hLnVuaXF1ZUl0ZW1zKSB7CgkJZm9yICh2YXIgaSA9IDA7IGkgPCBkYXRhLmxlbmd0aDsgaSsrKSB7CgkJCWZvciAodmFyIGogPSBpICsgMTsgaiA8IGRhdGEubGVuZ3RoOyBqKyspIHsKCQkJCWlmIChyZWN1cnNpdmVDb21wYXJlKGRhdGFbaV0sIGRhdGFbal0pKSB7CgkJCQkJdmFyIGVycm9yID0gdGhpcy5jcmVhdGVFcnJvcihFcnJvckNvZGVzLkFSUkFZX1VOSVFVRSwge21hdGNoMTogaSwgbWF0Y2gyOiBqfSwgJycsICcvdW5pcXVlSXRlbXMnLCBudWxsLCBkYXRhLCBzY2hlbWEpOwoJCQkJCWlmICh0aGlzLmhhbmRsZUVycm9yKGVycm9yKSkgewoJCQkJCQlyZXR1cm4gZXJyb3I7CgkJCQkJfQoJCQkJfQoJCQl9CgkJfQoJfQoJcmV0dXJuIG51bGw7Cn07CgpWYWxpZGF0b3JDb250ZXh0LnByb3RvdHlwZS52YWxpZGF0ZUFycmF5SXRlbXMgPSBmdW5jdGlvbiB2YWxpZGF0ZUFycmF5SXRlbXMoZGF0YSwgc2NoZW1hLCBkYXRhUG9pbnRlclBhdGgpIHsKCWlmIChzY2hlbWEuaXRlbXMgPT09IHVuZGVmaW5lZCkgewoJCXJldHVybiBudWxsOwoJfQoJdmFyIGVycm9yLCBpOwoJaWYgKEFycmF5LmlzQXJyYXkoc2NoZW1hLml0ZW1zKSkgewoJCWZvciAoaSA9IDA7IGkgPCBkYXRhLmxlbmd0aDsgaSsrKSB7CgkJCWlmIChpIDwgc2NoZW1hLml0ZW1zLmxlbmd0aCkgewoJCQkJaWYgKGVycm9yID0gdGhpcy52YWxpZGF0ZUFsbChkYXRhW2ldLCBzY2hlbWEuaXRlbXNbaV0sIFtpXSwgWyJpdGVtcyIsIGldLCBkYXRhUG9pbnRlclBhdGggKyAiLyIgKyBpKSkgewoJCQkJCXJldHVybiBlcnJvcjsKCQkJCX0KCQkJfSBlbHNlIGlmIChzY2hlbWEuYWRkaXRpb25hbEl0ZW1zICE9PSB1bmRlZmluZWQpIHsKCQkJCWlmICh0eXBlb2Ygc2NoZW1hLmFkZGl0aW9uYWxJdGVtcyA9PT0gImJvb2xlYW4iKSB7CgkJCQkJaWYgKCFzY2hlbWEuYWRkaXRpb25hbEl0ZW1zKSB7CgkJCQkJCWVycm9yID0gKHRoaXMuY3JlYXRlRXJyb3IoRXJyb3JDb2Rlcy5BUlJBWV9BRERJVElPTkFMX0lURU1TLCB7fSwgJy8nICsgaSwgJy9hZGRpdGlvbmFsSXRlbXMnLCBudWxsLCBkYXRhLCBzY2hlbWEpKTsKCQkJCQkJaWYgKHRoaXMuaGFuZGxlRXJyb3IoZXJyb3IpKSB7CgkJCQkJCQlyZXR1cm4gZXJyb3I7CgkJCQkJCX0KCQkJCQl9CgkJCQl9IGVsc2UgaWYgKGVycm9yID0gdGhpcy52YWxpZGF0ZUFsbChkYXRhW2ldLCBzY2hlbWEuYWRkaXRpb25hbEl0ZW1zLCBbaV0sIFsiYWRkaXRpb25hbEl0ZW1zIl0sIGRhdGFQb2ludGVyUGF0aCArICIvIiArIGkpKSB7CgkJCQkJcmV0dXJuIGVycm9yOwoJCQkJfQoJCQl9CgkJfQoJfSBlbHNlIHsKCQlmb3IgKGkgPSAwOyBpIDwgZGF0YS5sZW5ndGg7IGkrKykgewoJCQlpZiAoZXJyb3IgPSB0aGlzLnZhbGlkYXRlQWxsKGRhdGFbaV0sIHNjaGVtYS5pdGVtcywgW2ldLCBbIml0ZW1zIl0sIGRhdGFQb2ludGVyUGF0aCArICIvIiArIGkpKSB7CgkJCQlyZXR1cm4gZXJyb3I7CgkJCX0KCQl9Cgl9CglyZXR1cm4gbnVsbDsKfTsKClZhbGlkYXRvckNvbnRleHQucHJvdG90eXBlLnZhbGlkYXRlT2JqZWN0ID0gZnVuY3Rpb24gdmFsaWRhdGVPYmplY3QoZGF0YSwgc2NoZW1hLCBkYXRhUG9pbnRlclBhdGgpIHsKCWlmICh0eXBlb2YgZGF0YSAhPT0gIm9iamVjdCIgfHwgZGF0YSA9PT0gbnVsbCB8fCBBcnJheS5pc0FycmF5KGRhdGEpKSB7CgkJcmV0dXJuIG51bGw7Cgl9CglyZXR1cm4gdGhpcy52YWxpZGF0ZU9iamVjdE1pbk1heFByb3BlcnRpZXMoZGF0YSwgc2NoZW1hLCBkYXRhUG9pbnRlclBhdGgpCgkJfHwgdGhpcy52YWxpZGF0ZU9iamVjdFJlcXVpcmVkUHJvcGVydGllcyhkYXRhLCBzY2hlbWEsIGRhdGFQb2ludGVyUGF0aCkKCQl8fCB0aGlzLnZhbGlkYXRlT2JqZWN0UHJvcGVydGllcyhkYXRhLCBzY2hlbWEsIGRhdGFQb2ludGVyUGF0aCkKCQl8fCB0aGlzLnZhbGlkYXRlT2JqZWN0RGVwZW5kZW5jaWVzKGRhdGEsIHNjaGVtYSwgZGF0YVBvaW50ZXJQYXRoKQoJCXx8IG51bGw7Cn07CgpWYWxpZGF0b3JDb250ZXh0LnByb3RvdHlwZS52YWxpZGF0ZU9iamVjdE1pbk1heFByb3BlcnRpZXMgPSBmdW5jdGlvbiB2YWxpZGF0ZU9iamVjdE1pbk1heFByb3BlcnRpZXMoZGF0YSwgc2NoZW1hKSB7Cgl2YXIga2V5cyA9IE9iamVjdC5rZXlzKGRhdGEpOwoJdmFyIGVycm9yOwoJaWYgKHNjaGVtYS5taW5Qcm9wZXJ0aWVzICE9PSB1bmRlZmluZWQpIHsKCQlpZiAoa2V5cy5sZW5ndGggPCBzY2hlbWEubWluUHJvcGVydGllcykgewoJCQllcnJvciA9IHRoaXMuY3JlYXRlRXJyb3IoRXJyb3JDb2Rlcy5PQkpFQ1RfUFJPUEVSVElFU19NSU5JTVVNLCB7cHJvcGVydHlDb3VudDoga2V5cy5sZW5ndGgsIG1pbmltdW06IHNjaGVtYS5taW5Qcm9wZXJ0aWVzfSwgJycsICcvbWluUHJvcGVydGllcycsIG51bGwsIGRhdGEsIHNjaGVtYSk7CgkJCWlmICh0aGlzLmhhbmRsZUVycm9yKGVycm9yKSkgewoJCQkJcmV0dXJuIGVycm9yOwoJCQl9CgkJfQoJfQoJaWYgKHNjaGVtYS5tYXhQcm9wZXJ0aWVzICE9PSB1bmRlZmluZWQpIHsKCQlpZiAoa2V5cy5sZW5ndGggPiBzY2hlbWEubWF4UHJvcGVydGllcykgewoJCQllcnJvciA9IHRoaXMuY3JlYXRlRXJyb3IoRXJyb3JDb2Rlcy5PQkpFQ1RfUFJPUEVSVElFU19NQVhJTVVNLCB7cHJvcGVydHlDb3VudDoga2V5cy5sZW5ndGgsIG1heGltdW06IHNjaGVtYS5tYXhQcm9wZXJ0aWVzfSwgJycsICcvbWF4UHJvcGVydGllcycsIG51bGwsIGRhdGEsIHNjaGVtYSk7CgkJCWlmICh0aGlzLmhhbmRsZUVycm9yKGVycm9yKSkgewoJCQkJcmV0dXJuIGVycm9yOwoJCQl9CgkJfQoJfQoJcmV0dXJuIG51bGw7Cn07CgpWYWxpZGF0b3JDb250ZXh0LnByb3RvdHlwZS52YWxpZGF0ZU9iamVjdFJlcXVpcmVkUHJvcGVydGllcyA9IGZ1bmN0aW9uIHZhbGlkYXRlT2JqZWN0UmVxdWlyZWRQcm9wZXJ0aWVzKGRhdGEsIHNjaGVtYSkgewoJaWYgKHNjaGVtYS5yZXF1aXJlZCAhPT0gdW5kZWZpbmVkKSB7CgkJZm9yICh2YXIgaSA9IDA7IGkgPCBzY2hlbWEucmVxdWlyZWQubGVuZ3RoOyBpKyspIHsKCQkJdmFyIGtleSA9IHNjaGVtYS5yZXF1aXJlZFtpXTsKCQkJaWYgKGRhdGFba2V5XSA9PT0gdW5kZWZpbmVkKSB7CgkJCQl2YXIgZXJyb3IgPSB0aGlzLmNyZWF0ZUVycm9yKEVycm9yQ29kZXMuT0JKRUNUX1JFUVVJUkVELCB7a2V5OiBrZXl9LCAnJywgJy9yZXF1aXJlZC8nICsgaSwgbnVsbCwgZGF0YSwgc2NoZW1hKTsKCQkJCWlmICh0aGlzLmhhbmRsZUVycm9yKGVycm9yKSkgewoJCQkJCXJldHVybiBlcnJvcjsKCQkJCX0KCQkJfQoJCX0KCX0KCXJldHVybiBudWxsOwp9OwoKVmFsaWRhdG9yQ29udGV4dC5wcm90b3R5cGUudmFsaWRhdGVPYmplY3RQcm9wZXJ0aWVzID0gZnVuY3Rpb24gdmFsaWRhdGVPYmplY3RQcm9wZXJ0aWVzKGRhdGEsIHNjaGVtYSwgZGF0YVBvaW50ZXJQYXRoKSB7Cgl2YXIgZXJyb3I7Cglmb3IgKHZhciBrZXkgaW4gZGF0YSkgewoJCXZhciBrZXlQb2ludGVyUGF0aCA9IGRhdGFQb2ludGVyUGF0aCArICIvIiArIGtleS5yZXBsYWNlKC9+L2csICd+MCcpLnJlcGxhY2UoL1wvL2csICd+MScpOwoJCXZhciBmb3VuZE1hdGNoID0gZmFsc2U7CgkJaWYgKHNjaGVtYS5wcm9wZXJ0aWVzICE9PSB1bmRlZmluZWQgJiYgc2NoZW1hLnByb3BlcnRpZXNba2V5XSAhPT0gdW5kZWZpbmVkKSB7CgkJCWZvdW5kTWF0Y2ggPSB0cnVlOwoJCQlpZiAoZXJyb3IgPSB0aGlzLnZhbGlkYXRlQWxsKGRhdGFba2V5XSwgc2NoZW1hLnByb3BlcnRpZXNba2V5XSwgW2tleV0sIFsicHJvcGVydGllcyIsIGtleV0sIGtleVBvaW50ZXJQYXRoKSkgewoJCQkJcmV0dXJuIGVycm9yOwoJCQl9CgkJfQoJCWlmIChzY2hlbWEucGF0dGVyblByb3BlcnRpZXMgIT09IHVuZGVmaW5lZCkgewoJCQlmb3IgKHZhciBwYXR0ZXJuS2V5IGluIHNjaGVtYS5wYXR0ZXJuUHJvcGVydGllcykgewoJCQkJdmFyIHJlZ2V4cCA9IG5ldyBSZWdFeHAocGF0dGVybktleSk7CgkJCQlpZiAocmVnZXhwLnRlc3Qoa2V5KSkgewoJCQkJCWZvdW5kTWF0Y2ggPSB0cnVlOwoJCQkJCWlmIChlcnJvciA9IHRoaXMudmFsaWRhdGVBbGwoZGF0YVtrZXldLCBzY2hlbWEucGF0dGVyblByb3BlcnRpZXNbcGF0dGVybktleV0sIFtrZXldLCBbInBhdHRlcm5Qcm9wZXJ0aWVzIiwgcGF0dGVybktleV0sIGtleVBvaW50ZXJQYXRoKSkgewoJCQkJCQlyZXR1cm4gZXJyb3I7CgkJCQkJfQoJCQkJfQoJCQl9CgkJfQoJCWlmICghZm91bmRNYXRjaCkgewoJCQlpZiAoc2NoZW1hLmFkZGl0aW9uYWxQcm9wZXJ0aWVzICE9PSB1bmRlZmluZWQpIHsKCQkJCWlmICh0aGlzLnRyYWNrVW5rbm93blByb3BlcnRpZXMpIHsKCQkJCQl0aGlzLmtub3duUHJvcGVydHlQYXRoc1trZXlQb2ludGVyUGF0aF0gPSB0cnVlOwoJCQkJCWRlbGV0ZSB0aGlzLnVua25vd25Qcm9wZXJ0eVBhdGhzW2tleVBvaW50ZXJQYXRoXTsKCQkJCX0KCQkJCWlmICh0eXBlb2Ygc2NoZW1hLmFkZGl0aW9uYWxQcm9wZXJ0aWVzID09PSAiYm9vbGVhbiIpIHsKCQkJCQlpZiAoIXNjaGVtYS5hZGRpdGlvbmFsUHJvcGVydGllcykgewoJCQkJCQllcnJvciA9IHRoaXMuY3JlYXRlRXJyb3IoRXJyb3JDb2Rlcy5PQkpFQ1RfQURESVRJT05BTF9QUk9QRVJUSUVTLCB7a2V5OiBrZXl9LCAnJywgJy9hZGRpdGlvbmFsUHJvcGVydGllcycsIG51bGwsIGRhdGEsIHNjaGVtYSkucHJlZml4V2l0aChrZXksIG51bGwpOwoJCQkJCQlpZiAodGhpcy5oYW5kbGVFcnJvcihlcnJvcikpIHsKCQkJCQkJCXJldHVybiBlcnJvcjsKCQkJCQkJfQoJCQkJCX0KCQkJCX0gZWxzZSB7CgkJCQkJaWYgKGVycm9yID0gdGhpcy52YWxpZGF0ZUFsbChkYXRhW2tleV0sIHNjaGVtYS5hZGRpdGlvbmFsUHJvcGVydGllcywgW2tleV0sIFsiYWRkaXRpb25hbFByb3BlcnRpZXMiXSwga2V5UG9pbnRlclBhdGgpKSB7CgkJCQkJCXJldHVybiBlcnJvcjsKCQkJCQl9CgkJCQl9CgkJCX0gZWxzZSBpZiAodGhpcy50cmFja1Vua25vd25Qcm9wZXJ0aWVzICYmICF0aGlzLmtub3duUHJvcGVydHlQYXRoc1trZXlQb2ludGVyUGF0aF0pIHsKCQkJCXRoaXMudW5rbm93blByb3BlcnR5UGF0aHNba2V5UG9pbnRlclBhdGhdID0gdHJ1ZTsKCQkJfQoJCX0gZWxzZSBpZiAodGhpcy50cmFja1Vua25vd25Qcm9wZXJ0aWVzKSB7CgkJCXRoaXMua25vd25Qcm9wZXJ0eVBhdGhzW2tleVBvaW50ZXJQYXRoXSA9IHRydWU7CgkJCWRlbGV0ZSB0aGlzLnVua25vd25Qcm9wZXJ0eVBhdGhzW2tleVBvaW50ZXJQYXRoXTsKCQl9Cgl9CglyZXR1cm4gbnVsbDsKfTsKClZhbGlkYXRvckNvbnRleHQucHJvdG90eXBlLnZhbGlkYXRlT2JqZWN0RGVwZW5kZW5jaWVzID0gZnVuY3Rpb24gdmFsaWRhdGVPYmplY3REZXBlbmRlbmNpZXMoZGF0YSwgc2NoZW1hLCBkYXRhUG9pbnRlclBhdGgpIHsKCXZhciBlcnJvcjsKCWlmIChzY2hlbWEuZGVwZW5kZW5jaWVzICE9PSB1bmRlZmluZWQpIHsKCQlmb3IgKHZhciBkZXBLZXkgaW4gc2NoZW1hLmRlcGVuZGVuY2llcykgewoJCQlpZiAoZGF0YVtkZXBLZXldICE9PSB1bmRlZmluZWQpIHsKCQkJCXZhciBkZXAgPSBzY2hlbWEuZGVwZW5kZW5jaWVzW2RlcEtleV07CgkJCQlpZiAodHlwZW9mIGRlcCA9PT0gInN0cmluZyIpIHsKCQkJCQlpZiAoZGF0YVtkZXBdID09PSB1bmRlZmluZWQpIHsKCQkJCQkJZXJyb3IgPSB0aGlzLmNyZWF0ZUVycm9yKEVycm9yQ29kZXMuT0JKRUNUX0RFUEVOREVOQ1lfS0VZLCB7a2V5OiBkZXBLZXksIG1pc3Npbmc6IGRlcH0sICcnLCAnJywgbnVsbCwgZGF0YSwgc2NoZW1hKS5wcmVmaXhXaXRoKG51bGwsIGRlcEtleSkucHJlZml4V2l0aChudWxsLCAiZGVwZW5kZW5jaWVzIik7CgkJCQkJCWlmICh0aGlzLmhhbmRsZUVycm9yKGVycm9yKSkgewoJCQkJCQkJcmV0dXJuIGVycm9yOwoJCQkJCQl9CgkJCQkJfQoJCQkJfSBlbHNlIGlmIChBcnJheS5pc0FycmF5KGRlcCkpIHsKCQkJCQlmb3IgKHZhciBpID0gMDsgaSA8IGRlcC5sZW5ndGg7IGkrKykgewoJCQkJCQl2YXIgcmVxdWlyZWRLZXkgPSBkZXBbaV07CgkJCQkJCWlmIChkYXRhW3JlcXVpcmVkS2V5XSA9PT0gdW5kZWZpbmVkKSB7CgkJCQkJCQllcnJvciA9IHRoaXMuY3JlYXRlRXJyb3IoRXJyb3JDb2Rlcy5PQkpFQ1RfREVQRU5ERU5DWV9LRVksIHtrZXk6IGRlcEtleSwgbWlzc2luZzogcmVxdWlyZWRLZXl9LCAnJywgJy8nICsgaSwgbnVsbCwgZGF0YSwgc2NoZW1hKS5wcmVmaXhXaXRoKG51bGwsIGRlcEtleSkucHJlZml4V2l0aChudWxsLCAiZGVwZW5kZW5jaWVzIik7CgkJCQkJCQlpZiAodGhpcy5oYW5kbGVFcnJvcihlcnJvcikpIHsKCQkJCQkJCQlyZXR1cm4gZXJyb3I7CgkJCQkJCQl9CgkJCQkJCX0KCQkJCQl9CgkJCQl9IGVsc2UgewoJCQkJCWlmIChlcnJvciA9IHRoaXMudmFsaWRhdGVBbGwoZGF0YSwgZGVwLCBbXSwgWyJkZXBlbmRlbmNpZXMiLCBkZXBLZXldLCBkYXRhUG9pbnRlclBhdGgpKSB7CgkJCQkJCXJldHVybiBlcnJvcjsKCQkJCQl9CgkJCQl9CgkJCX0KCQl9Cgl9CglyZXR1cm4gbnVsbDsKfTsKClZhbGlkYXRvckNvbnRleHQucHJvdG90eXBlLnZhbGlkYXRlQ29tYmluYXRpb25zID0gZnVuY3Rpb24gdmFsaWRhdGVDb21iaW5hdGlvbnMoZGF0YSwgc2NoZW1hLCBkYXRhUG9pbnRlclBhdGgpIHsKCXJldHVybiB0aGlzLnZhbGlkYXRlQWxsT2YoZGF0YSwgc2NoZW1hLCBkYXRhUG9pbnRlclBhdGgpCgkJfHwgdGhpcy52YWxpZGF0ZUFueU9mKGRhdGEsIHNjaGVtYSwgZGF0YVBvaW50ZXJQYXRoKQoJCXx8IHRoaXMudmFsaWRhdGVPbmVPZihkYXRhLCBzY2hlbWEsIGRhdGFQb2ludGVyUGF0aCkKCQl8fCB0aGlzLnZhbGlkYXRlTm90KGRhdGEsIHNjaGVtYSwgZGF0YVBvaW50ZXJQYXRoKQoJCXx8IG51bGw7Cn07CgpWYWxpZGF0b3JDb250ZXh0LnByb3RvdHlwZS52YWxpZGF0ZUFsbE9mID0gZnVuY3Rpb24gdmFsaWRhdGVBbGxPZihkYXRhLCBzY2hlbWEsIGRhdGFQb2ludGVyUGF0aCkgewoJaWYgKHNjaGVtYS5hbGxPZiA9PT0gdW5kZWZpbmVkKSB7CgkJcmV0dXJuIG51bGw7Cgl9Cgl2YXIgZXJyb3I7Cglmb3IgKHZhciBpID0gMDsgaSA8IHNjaGVtYS5hbGxPZi5sZW5ndGg7IGkrKykgewoJCXZhciBzdWJTY2hlbWEgPSBzY2hlbWEuYWxsT2ZbaV07CgkJaWYgKGVycm9yID0gdGhpcy52YWxpZGF0ZUFsbChkYXRhLCBzdWJTY2hlbWEsIFtdLCBbImFsbE9mIiwgaV0sIGRhdGFQb2ludGVyUGF0aCkpIHsKCQkJcmV0dXJuIGVycm9yOwoJCX0KCX0KCXJldHVybiBudWxsOwp9OwoKVmFsaWRhdG9yQ29udGV4dC5wcm90b3R5cGUudmFsaWRhdGVBbnlPZiA9IGZ1bmN0aW9uIHZhbGlkYXRlQW55T2YoZGF0YSwgc2NoZW1hLCBkYXRhUG9pbnRlclBhdGgpIHsKCWlmIChzY2hlbWEuYW55T2YgPT09IHVuZGVmaW5lZCkgewoJCXJldHVybiBudWxsOwoJfQoJdmFyIGVycm9ycyA9IFtdOwoJdmFyIHN0YXJ0RXJyb3JDb3VudCA9IHRoaXMuZXJyb3JzLmxlbmd0aDsKCXZhciBvbGRVbmtub3duUHJvcGVydHlQYXRocywgb2xkS25vd25Qcm9wZXJ0eVBhdGhzOwoJaWYgKHRoaXMudHJhY2tVbmtub3duUHJvcGVydGllcykgewoJCW9sZFVua25vd25Qcm9wZXJ0eVBhdGhzID0gdGhpcy51bmtub3duUHJvcGVydHlQYXRoczsKCQlvbGRLbm93blByb3BlcnR5UGF0aHMgPSB0aGlzLmtub3duUHJvcGVydHlQYXRoczsKCX0KCXZhciBlcnJvckF0RW5kID0gdHJ1ZTsKCWZvciAodmFyIGkgPSAwOyBpIDwgc2NoZW1hLmFueU9mLmxlbmd0aDsgaSsrKSB7CgkJaWYgKHRoaXMudHJhY2tVbmtub3duUHJvcGVydGllcykgewoJCQl0aGlzLnVua25vd25Qcm9wZXJ0eVBhdGhzID0ge307CgkJCXRoaXMua25vd25Qcm9wZXJ0eVBhdGhzID0ge307CgkJfQoJCXZhciBzdWJTY2hlbWEgPSBzY2hlbWEuYW55T2ZbaV07CgoJCXZhciBlcnJvckNvdW50ID0gdGhpcy5lcnJvcnMubGVuZ3RoOwoJCXZhciBlcnJvciA9IHRoaXMudmFsaWRhdGVBbGwoZGF0YSwgc3ViU2NoZW1hLCBbXSwgWyJhbnlPZiIsIGldLCBkYXRhUG9pbnRlclBhdGgpOwoKCQlpZiAoZXJyb3IgPT09IG51bGwgJiYgZXJyb3JDb3VudCA9PT0gdGhpcy5lcnJvcnMubGVuZ3RoKSB7CgkJCXRoaXMuZXJyb3JzID0gdGhpcy5lcnJvcnMuc2xpY2UoMCwgc3RhcnRFcnJvckNvdW50KTsKCgkJCWlmICh0aGlzLnRyYWNrVW5rbm93blByb3BlcnRpZXMpIHsKCQkJCWZvciAodmFyIGtub3duS2V5IGluIHRoaXMua25vd25Qcm9wZXJ0eVBhdGhzKSB7CgkJCQkJb2xkS25vd25Qcm9wZXJ0eVBhdGhzW2tub3duS2V5XSA9IHRydWU7CgkJCQkJZGVsZXRlIG9sZFVua25vd25Qcm9wZXJ0eVBhdGhzW2tub3duS2V5XTsKCQkJCX0KCQkJCWZvciAodmFyIHVua25vd25LZXkgaW4gdGhpcy51bmtub3duUHJvcGVydHlQYXRocykgewoJCQkJCWlmICghb2xkS25vd25Qcm9wZXJ0eVBhdGhzW3Vua25vd25LZXldKSB7CgkJCQkJCW9sZFVua25vd25Qcm9wZXJ0eVBhdGhzW3Vua25vd25LZXldID0gdHJ1ZTsKCQkJCQl9CgkJCQl9CgkJCQkvLyBXZSBuZWVkIHRvIGNvbnRpbnVlIGxvb3Bpbmcgc28gd2UgY2F0Y2ggYWxsIHRoZSBwcm9wZXJ0eSBkZWZpbml0aW9ucywgYnV0IHdlIGRvbid0IHdhbnQgdG8gcmV0dXJuIGFuIGVycm9yCgkJCQllcnJvckF0RW5kID0gZmFsc2U7CgkJCQljb250aW51ZTsKCQkJfQoKCQkJcmV0dXJuIG51bGw7CgkJfQoJCWlmIChlcnJvcikgewoJCQllcnJvcnMucHVzaChlcnJvci5wcmVmaXhXaXRoKG51bGwsICIiICsgaSkucHJlZml4V2l0aChudWxsLCAiYW55T2YiKSk7CgkJfQoJfQoJaWYgKHRoaXMudHJhY2tVbmtub3duUHJvcGVydGllcykgewoJCXRoaXMudW5rbm93blByb3BlcnR5UGF0aHMgPSBvbGRVbmtub3duUHJvcGVydHlQYXRoczsKCQl0aGlzLmtub3duUHJvcGVydHlQYXRocyA9IG9sZEtub3duUHJvcGVydHlQYXRoczsKCX0KCWlmIChlcnJvckF0RW5kKSB7CgkJZXJyb3JzID0gZXJyb3JzLmNvbmNhdCh0aGlzLmVycm9ycy5zbGljZShzdGFydEVycm9yQ291bnQpKTsKCQl0aGlzLmVycm9ycyA9IHRoaXMuZXJyb3JzLnNsaWNlKDAsIHN0YXJ0RXJyb3JDb3VudCk7CgkJcmV0dXJuIHRoaXMuY3JlYXRlRXJyb3IoRXJyb3JDb2Rlcy5BTllfT0ZfTUlTU0lORywge30sICIiLCAiL2FueU9mIiwgZXJyb3JzLCBkYXRhLCBzY2hlbWEpOwoJfQp9OwoKVmFsaWRhdG9yQ29udGV4dC5wcm90b3R5cGUudmFsaWRhdGVPbmVPZiA9IGZ1bmN0aW9uIHZhbGlkYXRlT25lT2YoZGF0YSwgc2NoZW1hLCBkYXRhUG9pbnRlclBhdGgpIHsKCWlmIChzY2hlbWEub25lT2YgPT09IHVuZGVmaW5lZCkgewoJCXJldHVybiBudWxsOwoJfQoJdmFyIHZhbGlkSW5kZXggPSBudWxsOwoJdmFyIGVycm9ycyA9IFtdOwoJdmFyIHN0YXJ0RXJyb3JDb3VudCA9IHRoaXMuZXJyb3JzLmxlbmd0aDsKCXZhciBvbGRVbmtub3duUHJvcGVydHlQYXRocywgb2xkS25vd25Qcm9wZXJ0eVBhdGhzOwoJaWYgKHRoaXMudHJhY2tVbmtub3duUHJvcGVydGllcykgewoJCW9sZFVua25vd25Qcm9wZXJ0eVBhdGhzID0gdGhpcy51bmtub3duUHJvcGVydHlQYXRoczsKCQlvbGRLbm93blByb3BlcnR5UGF0aHMgPSB0aGlzLmtub3duUHJvcGVydHlQYXRoczsKCX0KCWZvciAodmFyIGkgPSAwOyBpIDwgc2NoZW1hLm9uZU9mLmxlbmd0aDsgaSsrKSB7CgkJaWYgKHRoaXMudHJhY2tVbmtub3duUHJvcGVydGllcykgewoJCQl0aGlzLnVua25vd25Qcm9wZXJ0eVBhdGhzID0ge307CgkJCXRoaXMua25vd25Qcm9wZXJ0eVBhdGhzID0ge307CgkJfQoJCXZhciBzdWJTY2hlbWEgPSBzY2hlbWEub25lT2ZbaV07CgoJCXZhciBlcnJvckNvdW50ID0gdGhpcy5lcnJvcnMubGVuZ3RoOwoJCXZhciBlcnJvciA9IHRoaXMudmFsaWRhdGVBbGwoZGF0YSwgc3ViU2NoZW1hLCBbXSwgWyJvbmVPZiIsIGldLCBkYXRhUG9pbnRlclBhdGgpOwoKCQlpZiAoZXJyb3IgPT09IG51bGwgJiYgZXJyb3JDb3VudCA9PT0gdGhpcy5lcnJvcnMubGVuZ3RoKSB7CgkJCWlmICh2YWxpZEluZGV4ID09PSBudWxsKSB7CgkJCQl2YWxpZEluZGV4ID0gaTsKCQkJfSBlbHNlIHsKCQkJCXRoaXMuZXJyb3JzID0gdGhpcy5lcnJvcnMuc2xpY2UoMCwgc3RhcnRFcnJvckNvdW50KTsKCQkJCXJldHVybiB0aGlzLmNyZWF0ZUVycm9yKEVycm9yQ29kZXMuT05FX09GX01VTFRJUExFLCB7aW5kZXgxOiB2YWxpZEluZGV4LCBpbmRleDI6IGl9LCAiIiwgIi9vbmVPZiIsIG51bGwsIGRhdGEsIHNjaGVtYSk7CgkJCX0KCQkJaWYgKHRoaXMudHJhY2tVbmtub3duUHJvcGVydGllcykgewoJCQkJZm9yICh2YXIga25vd25LZXkgaW4gdGhpcy5rbm93blByb3BlcnR5UGF0aHMpIHsKCQkJCQlvbGRLbm93blByb3BlcnR5UGF0aHNba25vd25LZXldID0gdHJ1ZTsKCQkJCQlkZWxldGUgb2xkVW5rbm93blByb3BlcnR5UGF0aHNba25vd25LZXldOwoJCQkJfQoJCQkJZm9yICh2YXIgdW5rbm93bktleSBpbiB0aGlzLnVua25vd25Qcm9wZXJ0eVBhdGhzKSB7CgkJCQkJaWYgKCFvbGRLbm93blByb3BlcnR5UGF0aHNbdW5rbm93bktleV0pIHsKCQkJCQkJb2xkVW5rbm93blByb3BlcnR5UGF0aHNbdW5rbm93bktleV0gPSB0cnVlOwoJCQkJCX0KCQkJCX0KCQkJfQoJCX0gZWxzZSBpZiAoZXJyb3IpIHsKCQkJZXJyb3JzLnB1c2goZXJyb3IpOwoJCX0KCX0KCWlmICh0aGlzLnRyYWNrVW5rbm93blByb3BlcnRpZXMpIHsKCQl0aGlzLnVua25vd25Qcm9wZXJ0eVBhdGhzID0gb2xkVW5rbm93blByb3BlcnR5UGF0aHM7CgkJdGhpcy5rbm93blByb3BlcnR5UGF0aHMgPSBvbGRLbm93blByb3BlcnR5UGF0aHM7Cgl9CglpZiAodmFsaWRJbmRleCA9PT0gbnVsbCkgewoJCWVycm9ycyA9IGVycm9ycy5jb25jYXQodGhpcy5lcnJvcnMuc2xpY2Uoc3RhcnRFcnJvckNvdW50KSk7CgkJdGhpcy5lcnJvcnMgPSB0aGlzLmVycm9ycy5zbGljZSgwLCBzdGFydEVycm9yQ291bnQpOwoJCXJldHVybiB0aGlzLmNyZWF0ZUVycm9yKEVycm9yQ29kZXMuT05FX09GX01JU1NJTkcsIHt9LCAiIiwgIi9vbmVPZiIsIGVycm9ycywgZGF0YSwgc2NoZW1hKTsKCX0gZWxzZSB7CgkJdGhpcy5lcnJvcnMgPSB0aGlzLmVycm9ycy5zbGljZSgwLCBzdGFydEVycm9yQ291bnQpOwoJfQoJcmV0dXJuIG51bGw7Cn07CgpWYWxpZGF0b3JDb250ZXh0LnByb3RvdHlwZS52YWxpZGF0ZU5vdCA9IGZ1bmN0aW9uIHZhbGlkYXRlTm90KGRhdGEsIHNjaGVtYSwgZGF0YVBvaW50ZXJQYXRoKSB7CglpZiAoc2NoZW1hLm5vdCA9PT0gdW5kZWZpbmVkKSB7CgkJcmV0dXJuIG51bGw7Cgl9Cgl2YXIgb2xkRXJyb3JDb3VudCA9IHRoaXMuZXJyb3JzLmxlbmd0aDsKCXZhciBvbGRVbmtub3duUHJvcGVydHlQYXRocywgb2xkS25vd25Qcm9wZXJ0eVBhdGhzOwoJaWYgKHRoaXMudHJhY2tVbmtub3duUHJvcGVydGllcykgewoJCW9sZFVua25vd25Qcm9wZXJ0eVBhdGhzID0gdGhpcy51bmtub3duUHJvcGVydHlQYXRoczsKCQlvbGRLbm93blByb3BlcnR5UGF0aHMgPSB0aGlzLmtub3duUHJvcGVydHlQYXRoczsKCQl0aGlzLnVua25vd25Qcm9wZXJ0eVBhdGhzID0ge307CgkJdGhpcy5rbm93blByb3BlcnR5UGF0aHMgPSB7fTsKCX0KCXZhciBlcnJvciA9IHRoaXMudmFsaWRhdGVBbGwoZGF0YSwgc2NoZW1hLm5vdCwgbnVsbCwgbnVsbCwgZGF0YVBvaW50ZXJQYXRoKTsKCXZhciBub3RFcnJvcnMgPSB0aGlzLmVycm9ycy5zbGljZShvbGRFcnJvckNvdW50KTsKCXRoaXMuZXJyb3JzID0gdGhpcy5lcnJvcnMuc2xpY2UoMCwgb2xkRXJyb3JDb3VudCk7CglpZiAodGhpcy50cmFja1Vua25vd25Qcm9wZXJ0aWVzKSB7CgkJdGhpcy51bmtub3duUHJvcGVydHlQYXRocyA9IG9sZFVua25vd25Qcm9wZXJ0eVBhdGhzOwoJCXRoaXMua25vd25Qcm9wZXJ0eVBhdGhzID0gb2xkS25vd25Qcm9wZXJ0eVBhdGhzOwoJfQoJaWYgKGVycm9yID09PSBudWxsICYmIG5vdEVycm9ycy5sZW5ndGggPT09IDApIHsKCQlyZXR1cm4gdGhpcy5jcmVhdGVFcnJvcihFcnJvckNvZGVzLk5PVF9QQVNTRUQsIHt9LCAiIiwgIi9ub3QiLCBudWxsLCBkYXRhLCBzY2hlbWEpOwoJfQoJcmV0dXJuIG51bGw7Cn07CgpWYWxpZGF0b3JDb250ZXh0LnByb3RvdHlwZS52YWxpZGF0ZUh5cGVybWVkaWEgPSBmdW5jdGlvbiB2YWxpZGF0ZUNvbWJpbmF0aW9ucyhkYXRhLCBzY2hlbWEsIGRhdGFQb2ludGVyUGF0aCkgewoJaWYgKCFzY2hlbWEubGlua3MpIHsKCQlyZXR1cm4gbnVsbDsKCX0KCXZhciBlcnJvcjsKCWZvciAodmFyIGkgPSAwOyBpIDwgc2NoZW1hLmxpbmtzLmxlbmd0aDsgaSsrKSB7CgkJdmFyIGxkbyA9IHNjaGVtYS5saW5rc1tpXTsKCQlpZiAobGRvLnJlbCA9PT0gImRlc2NyaWJlZGJ5IikgewoJCQl2YXIgdGVtcGxhdGUgPSBuZXcgVXJpVGVtcGxhdGUobGRvLmhyZWYpOwoJCQl2YXIgYWxsUHJlc2VudCA9IHRydWU7CgkJCWZvciAodmFyIGogPSAwOyBqIDwgdGVtcGxhdGUudmFyTmFtZXMubGVuZ3RoOyBqKyspIHsKCQkJCWlmICghKHRlbXBsYXRlLnZhck5hbWVzW2pdIGluIGRhdGEpKSB7CgkJCQkJYWxsUHJlc2VudCA9IGZhbHNlOwoJCQkJCWJyZWFrOwoJCQkJfQoJCQl9CgkJCWlmIChhbGxQcmVzZW50KSB7CgkJCQl2YXIgc2NoZW1hVXJsID0gdGVtcGxhdGUuZmlsbEZyb21PYmplY3QoZGF0YSk7CgkJCQl2YXIgc3ViU2NoZW1hID0geyIkcmVmIjogc2NoZW1hVXJsfTsKCQkJCWlmIChlcnJvciA9IHRoaXMudmFsaWRhdGVBbGwoZGF0YSwgc3ViU2NoZW1hLCBbXSwgWyJsaW5rcyIsIGldLCBkYXRhUG9pbnRlclBhdGgpKSB7CgkJCQkJcmV0dXJuIGVycm9yOwoJCQkJfQoJCQl9CgkJfQoJfQp9OwoKLy8gcGFyc2VVUkkoKSBhbmQgcmVzb2x2ZVVybCgpIGFyZSBmcm9tIGh0dHBzOi8vZ2lzdC5naXRodWIuY29tLzEwODg4NTAKLy8gICAtICByZWxlYXNlZCBhcyBwdWJsaWMgZG9tYWluIGJ5IGF1dGhvciAoIllhZmZsZSIpIC0gc2VlIGNvbW1lbnRzIG9uIGdpc3QKCmZ1bmN0aW9uIHBhcnNlVVJJKHVybCkgewoJdmFyIG0gPSBTdHJpbmcodXJsKS5yZXBsYWNlKC9eXHMrfFxzKyQvZywgJycpLm1hdGNoKC9eKFteOlwvPyNdKzopPyhcL1wvKD86W146QF0qKD86OlteOkBdKik/QCk/KChbXjpcLz8jXSopKD86OihcZCopKT8pKT8oW14/I10qKShcP1teI10qKT8oI1tcc1xTXSopPy8pOwoJLy8gYXV0aG9yaXR5ID0gJy8vJyArIHVzZXIgKyAnOicgKyBwYXNzICdAJyArIGhvc3RuYW1lICsgJzonIHBvcnQKCXJldHVybiAobSA/IHsKCQlocmVmICAgICA6IG1bMF0gfHwgJycsCgkJcHJvdG9jb2wgOiBtWzFdIHx8ICcnLAoJCWF1dGhvcml0eTogbVsyXSB8fCAnJywKCQlob3N0ICAgICA6IG1bM10gfHwgJycsCgkJaG9zdG5hbWUgOiBtWzRdIHx8ICcnLAoJCXBvcnQgICAgIDogbVs1XSB8fCAnJywKCQlwYXRobmFtZSA6IG1bNl0gfHwgJycsCgkJc2VhcmNoICAgOiBtWzddIHx8ICcnLAoJCWhhc2ggICAgIDogbVs4XSB8fCAnJwoJfSA6IG51bGwpOwp9CgpmdW5jdGlvbiByZXNvbHZlVXJsKGJhc2UsIGhyZWYpIHsvLyBSRkMgMzk4NgoKCWZ1bmN0aW9uIHJlbW92ZURvdFNlZ21lbnRzKGlucHV0KSB7CgkJdmFyIG91dHB1dCA9IFtdOwoJCWlucHV0LnJlcGxhY2UoL14oXC5cLj8oXC98JCkpKy8sICcnKQoJCQkucmVwbGFjZSgvXC8oXC4oXC98JCkpKy9nLCAnLycpCgkJCS5yZXBsYWNlKC9cL1wuXC4kLywgJy8uLi8nKQoJCQkucmVwbGFjZSgvXC8/W15cL10qL2csIGZ1bmN0aW9uIChwKSB7CgkJCQlpZiAocCA9PT0gJy8uLicpIHsKCQkJCQlvdXRwdXQucG9wKCk7CgkJCQl9IGVsc2UgewoJCQkJCW91dHB1dC5wdXNoKHApOwoJCQkJfQoJCX0pOwoJCXJldHVybiBvdXRwdXQuam9pbignJykucmVwbGFjZSgvXlwvLywgaW5wdXQuY2hhckF0KDApID09PSAnLycgPyAnLycgOiAnJyk7Cgl9CgoJaHJlZiA9IHBhcnNlVVJJKGhyZWYgfHwgJycpOwoJYmFzZSA9IHBhcnNlVVJJKGJhc2UgfHwgJycpOwoKCXJldHVybiAhaHJlZiB8fCAhYmFzZSA/IG51bGwgOiAoaHJlZi5wcm90b2NvbCB8fCBiYXNlLnByb3RvY29sKSArCgkJKGhyZWYucHJvdG9jb2wgfHwgaHJlZi5hdXRob3JpdHkgPyBocmVmLmF1dGhvcml0eSA6IGJhc2UuYXV0aG9yaXR5KSArCgkJcmVtb3ZlRG90U2VnbWVudHMoaHJlZi5wcm90b2NvbCB8fCBocmVmLmF1dGhvcml0eSB8fCBocmVmLnBhdGhuYW1lLmNoYXJBdCgwKSA9PT0gJy8nID8gaHJlZi5wYXRobmFtZSA6IChocmVmLnBhdGhuYW1lID8gKChiYXNlLmF1dGhvcml0eSAmJiAhYmFzZS5wYXRobmFtZSA/ICcvJyA6ICcnKSArIGJhc2UucGF0aG5hbWUuc2xpY2UoMCwgYmFzZS5wYXRobmFtZS5sYXN0SW5kZXhPZignLycpICsgMSkgKyBocmVmLnBhdGhuYW1lKSA6IGJhc2UucGF0aG5hbWUpKSArCgkJKGhyZWYucHJvdG9jb2wgfHwgaHJlZi5hdXRob3JpdHkgfHwgaHJlZi5wYXRobmFtZSA/IGhyZWYuc2VhcmNoIDogKGhyZWYuc2VhcmNoIHx8IGJhc2Uuc2VhcmNoKSkgKwoJCWhyZWYuaGFzaDsKfQoKZnVuY3Rpb24gZ2V0RG9jdW1lbnRVcmkodXJpKSB7CglyZXR1cm4gdXJpLnNwbGl0KCcjJylbMF07Cn0KZnVuY3Rpb24gbm9ybVNjaGVtYShzY2hlbWEsIGJhc2VVcmkpIHsKCWlmIChzY2hlbWEgJiYgdHlwZW9mIHNjaGVtYSA9PT0gIm9iamVjdCIpIHsKCQlpZiAoYmFzZVVyaSA9PT0gdW5kZWZpbmVkKSB7CgkJCWJhc2VVcmkgPSBzY2hlbWEuaWQ7CgkJfSBlbHNlIGlmICh0eXBlb2Ygc2NoZW1hLmlkID09PSAic3RyaW5nIikgewoJCQliYXNlVXJpID0gcmVzb2x2ZVVybChiYXNlVXJpLCBzY2hlbWEuaWQpOwoJCQlzY2hlbWEuaWQgPSBiYXNlVXJpOwoJCX0KCQlpZiAoQXJyYXkuaXNBcnJheShzY2hlbWEpKSB7CgkJCWZvciAodmFyIGkgPSAwOyBpIDwgc2NoZW1hLmxlbmd0aDsgaSsrKSB7CgkJCQlub3JtU2NoZW1hKHNjaGVtYVtpXSwgYmFzZVVyaSk7CgkJCX0KCQl9IGVsc2UgewoJCQlpZiAodHlwZW9mIHNjaGVtYVsnJHJlZiddID09PSAic3RyaW5nIikgewoJCQkJc2NoZW1hWyckcmVmJ10gPSByZXNvbHZlVXJsKGJhc2VVcmksIHNjaGVtYVsnJHJlZiddKTsKCQkJfQoJCQlmb3IgKHZhciBrZXkgaW4gc2NoZW1hKSB7CgkJCQlpZiAoa2V5ICE9PSAiZW51bSIpIHsKCQkJCQlub3JtU2NoZW1hKHNjaGVtYVtrZXldLCBiYXNlVXJpKTsKCQkJCX0KCQkJfQoJCX0KCX0KfQoKZnVuY3Rpb24gZGVmYXVsdEVycm9yUmVwb3J0ZXIobGFuZ3VhZ2UpIHsKCWxhbmd1YWdlID0gbGFuZ3VhZ2UgfHwgJ2VuJzsKCgl2YXIgZXJyb3JNZXNzYWdlcyA9IGxhbmd1YWdlc1tsYW5ndWFnZV07CgoJcmV0dXJuIGZ1bmN0aW9uIChlcnJvcikgewoJCXZhciBtZXNzYWdlVGVtcGxhdGUgPSBlcnJvck1lc3NhZ2VzW2Vycm9yLmNvZGVdIHx8IEVycm9yTWVzc2FnZXNEZWZhdWx0W2Vycm9yLmNvZGVdOwoJCWlmICh0eXBlb2YgbWVzc2FnZVRlbXBsYXRlICE9PSAnc3RyaW5nJykgewoJCQlyZXR1cm4gIlVua25vd24gZXJyb3IgY29kZSAiICsgZXJyb3IuY29kZSArICI6ICIgKyBKU09OLnN0cmluZ2lmeShlcnJvci5tZXNzYWdlUGFyYW1zKTsKCQl9CgkJdmFyIG1lc3NhZ2VQYXJhbXMgPSBlcnJvci5wYXJhbXM7CgkJLy8gQWRhcHRlZCBmcm9tIENyb2NrZm9yZCdzIHN1cHBsYW50KCkKCQlyZXR1cm4gbWVzc2FnZVRlbXBsYXRlLnJlcGxhY2UoL1x7KFtee31dKilcfS9nLCBmdW5jdGlvbiAod2hvbGUsIHZhck5hbWUpIHsKCQkJdmFyIHN1YlZhbHVlID0gbWVzc2FnZVBhcmFtc1t2YXJOYW1lXTsKCQkJcmV0dXJuIHR5cGVvZiBzdWJWYWx1ZSA9PT0gJ3N0cmluZycgfHwgdHlwZW9mIHN1YlZhbHVlID09PSAnbnVtYmVyJyA/IHN1YlZhbHVlIDogd2hvbGU7CgkJfSk7Cgl9Owp9Cgp2YXIgRXJyb3JDb2RlcyA9IHsKCUlOVkFMSURfVFlQRTogMCwKCUVOVU1fTUlTTUFUQ0g6IDEsCglBTllfT0ZfTUlTU0lORzogMTAsCglPTkVfT0ZfTUlTU0lORzogMTEsCglPTkVfT0ZfTVVMVElQTEU6IDEyLAoJTk9UX1BBU1NFRDogMTMsCgkvLyBOdW1lcmljIGVycm9ycwoJTlVNQkVSX01VTFRJUExFX09GOiAxMDAsCglOVU1CRVJfTUlOSU1VTTogMTAxLAoJTlVNQkVSX01JTklNVU1fRVhDTFVTSVZFOiAxMDIsCglOVU1CRVJfTUFYSU1VTTogMTAzLAoJTlVNQkVSX01BWElNVU1fRVhDTFVTSVZFOiAxMDQsCglOVU1CRVJfTk9UX0FfTlVNQkVSOiAxMDUsCgkvLyBTdHJpbmcgZXJyb3JzCglTVFJJTkdfTEVOR1RIX1NIT1JUOiAyMDAsCglTVFJJTkdfTEVOR1RIX0xPTkc6IDIwMSwKCVNUUklOR19QQVRURVJOOiAyMDIsCgkvLyBPYmplY3QgZXJyb3JzCglPQkpFQ1RfUFJPUEVSVElFU19NSU5JTVVNOiAzMDAsCglPQkpFQ1RfUFJPUEVSVElFU19NQVhJTVVNOiAzMDEsCglPQkpFQ1RfUkVRVUlSRUQ6IDMwMiwKCU9CSkVDVF9BRERJVElPTkFMX1BST1BFUlRJRVM6IDMwMywKCU9CSkVDVF9ERVBFTkRFTkNZX0tFWTogMzA0LAoJLy8gQXJyYXkgZXJyb3JzCglBUlJBWV9MRU5HVEhfU0hPUlQ6IDQwMCwKCUFSUkFZX0xFTkdUSF9MT05HOiA0MDEsCglBUlJBWV9VTklRVUU6IDQwMiwKCUFSUkFZX0FERElUSU9OQUxfSVRFTVM6IDQwMywKCS8vIEN1c3RvbS91c2VyLWRlZmluZWQgZXJyb3JzCglGT1JNQVRfQ1VTVE9NOiA1MDAsCglLRVlXT1JEX0NVU1RPTTogNTAxLAoJLy8gU2NoZW1hIHN0cnVjdHVyZQoJQ0lSQ1VMQVJfUkVGRVJFTkNFOiA2MDAsCgkvLyBOb24tc3RhbmRhcmQgdmFsaWRhdGlvbiBvcHRpb25zCglVTktOT1dOX1BST1BFUlRZOiAxMDAwCn07CnZhciBFcnJvckNvZGVMb29rdXAgPSB7fTsKZm9yICh2YXIga2V5IGluIEVycm9yQ29kZXMpIHsKCUVycm9yQ29kZUxvb2t1cFtFcnJvckNvZGVzW2tleV1dID0ga2V5Owp9CnZhciBFcnJvck1lc3NhZ2VzRGVmYXVsdCA9IHsKCUlOVkFMSURfVFlQRTogIkludmFsaWQgdHlwZToge3R5cGV9IChleHBlY3RlZCB7ZXhwZWN0ZWR9KSIsCglFTlVNX01JU01BVENIOiAiTm8gZW51bSBtYXRjaCBmb3I6IHt2YWx1ZX0iLAoJQU5ZX09GX01JU1NJTkc6ICJEYXRhIGRvZXMgbm90IG1hdGNoIGFueSBzY2hlbWFzIGZyb20gXCJhbnlPZlwiIiwKCU9ORV9PRl9NSVNTSU5HOiAiRGF0YSBkb2VzIG5vdCBtYXRjaCBhbnkgc2NoZW1hcyBmcm9tIFwib25lT2ZcIiIsCglPTkVfT0ZfTVVMVElQTEU6ICJEYXRhIGlzIHZhbGlkIGFnYWluc3QgbW9yZSB0aGFuIG9uZSBzY2hlbWEgZnJvbSBcIm9uZU9mXCI6IGluZGljZXMge2luZGV4MX0gYW5kIHtpbmRleDJ9IiwKCU5PVF9QQVNTRUQ6ICJEYXRhIG1hdGNoZXMgc2NoZW1hIGZyb20gXCJub3RcIiIsCgkvLyBOdW1lcmljIGVycm9ycwoJTlVNQkVSX01VTFRJUExFX09GOiAiVmFsdWUge3ZhbHVlfSBpcyBub3QgYSBtdWx0aXBsZSBvZiB7bXVsdGlwbGVPZn0iLAoJTlVNQkVSX01JTklNVU06ICJWYWx1ZSB7dmFsdWV9IGlzIGxlc3MgdGhhbiBtaW5pbXVtIHttaW5pbXVtfSIsCglOVU1CRVJfTUlOSU1VTV9FWENMVVNJVkU6ICJWYWx1ZSB7dmFsdWV9IGlzIGVxdWFsIHRvIGV4Y2x1c2l2ZSBtaW5pbXVtIHttaW5pbXVtfSIsCglOVU1CRVJfTUFYSU1VTTogIlZhbHVlIHt2YWx1ZX0gaXMgZ3JlYXRlciB0aGFuIG1heGltdW0ge21heGltdW19IiwKCU5VTUJFUl9NQVhJTVVNX0VYQ0xVU0lWRTogIlZhbHVlIHt2YWx1ZX0gaXMgZXF1YWwgdG8gZXhjbHVzaXZlIG1heGltdW0ge21heGltdW19IiwKCU5VTUJFUl9OT1RfQV9OVU1CRVI6ICJWYWx1ZSB7dmFsdWV9IGlzIG5vdCBhIHZhbGlkIG51bWJlciIsCgkvLyBTdHJpbmcgZXJyb3JzCglTVFJJTkdfTEVOR1RIX1NIT1JUOiAiU3RyaW5nIGlzIHRvbyBzaG9ydCAoe2xlbmd0aH0gY2hhcnMpLCBtaW5pbXVtIHttaW5pbXVtfSIsCglTVFJJTkdfTEVOR1RIX0xPTkc6ICJTdHJpbmcgaXMgdG9vIGxvbmcgKHtsZW5ndGh9IGNoYXJzKSwgbWF4aW11bSB7bWF4aW11bX0iLAoJU1RSSU5HX1BBVFRFUk46ICJTdHJpbmcgZG9lcyBub3QgbWF0Y2ggcGF0dGVybjoge3BhdHRlcm59IiwKCS8vIE9iamVjdCBlcnJvcnMKCU9CSkVDVF9QUk9QRVJUSUVTX01JTklNVU06ICJUb28gZmV3IHByb3BlcnRpZXMgZGVmaW5lZCAoe3Byb3BlcnR5Q291bnR9KSwgbWluaW11bSB7bWluaW11bX0iLAoJT0JKRUNUX1BST1BFUlRJRVNfTUFYSU1VTTogIlRvbyBtYW55IHByb3BlcnRpZXMgZGVmaW5lZCAoe3Byb3BlcnR5Q291bnR9KSwgbWF4aW11bSB7bWF4aW11bX0iLAoJT0JKRUNUX1JFUVVJUkVEOiAiTWlzc2luZyByZXF1aXJlZCBwcm9wZXJ0eToge2tleX0iLAoJT0JKRUNUX0FERElUSU9OQUxfUFJPUEVSVElFUzogIkFkZGl0aW9uYWwgcHJvcGVydGllcyBub3QgYWxsb3dlZCIsCglPQkpFQ1RfREVQRU5ERU5DWV9LRVk6ICJEZXBlbmRlbmN5IGZhaWxlZCAtIGtleSBtdXN0IGV4aXN0OiB7bWlzc2luZ30gKGR1ZSB0byBrZXk6IHtrZXl9KSIsCgkvLyBBcnJheSBlcnJvcnMKCUFSUkFZX0xFTkdUSF9TSE9SVDogIkFycmF5IGlzIHRvbyBzaG9ydCAoe2xlbmd0aH0pLCBtaW5pbXVtIHttaW5pbXVtfSIsCglBUlJBWV9MRU5HVEhfTE9ORzogIkFycmF5IGlzIHRvbyBsb25nICh7bGVuZ3RofSksIG1heGltdW0ge21heGltdW19IiwKCUFSUkFZX1VOSVFVRTogIkFycmF5IGl0ZW1zIGFyZSBub3QgdW5pcXVlIChpbmRpY2VzIHttYXRjaDF9IGFuZCB7bWF0Y2gyfSkiLAoJQVJSQVlfQURESVRJT05BTF9JVEVNUzogIkFkZGl0aW9uYWwgaXRlbXMgbm90IGFsbG93ZWQiLAoJLy8gRm9ybWF0IGVycm9ycwoJRk9STUFUX0NVU1RPTTogIkZvcm1hdCB2YWxpZGF0aW9uIGZhaWxlZCAoe21lc3NhZ2V9KSIsCglLRVlXT1JEX0NVU1RPTTogIktleXdvcmQgZmFpbGVkOiB7a2V5fSAoe21lc3NhZ2V9KSIsCgkvLyBTY2hlbWEgc3RydWN0dXJlCglDSVJDVUxBUl9SRUZFUkVOQ0U6ICJDaXJjdWxhciAkcmVmczoge3VybHN9IiwKCS8vIE5vbi1zdGFuZGFyZCB2YWxpZGF0aW9uIG9wdGlvbnMKCVVOS05PV05fUFJPUEVSVFk6ICJVbmtub3duIHByb3BlcnR5IChub3QgaW4gc2NoZW1hKSIKfTsKCmZ1bmN0aW9uIFZhbGlkYXRpb25FcnJvcihjb2RlLCBwYXJhbXMsIGRhdGFQYXRoLCBzY2hlbWFQYXRoLCBzdWJFcnJvcnMpIHsKCUVycm9yLmNhbGwodGhpcyk7CglpZiAoY29kZSA9PT0gdW5kZWZpbmVkKSB7CgkJdGhyb3cgbmV3IEVycm9yICgiTm8gZXJyb3IgY29kZSBzdXBwbGllZDogIiArIHNjaGVtYVBhdGgpOwoJfQoJdGhpcy5tZXNzYWdlID0gJyc7Cgl0aGlzLnBhcmFtcyA9IHBhcmFtczsKCXRoaXMuY29kZSA9IGNvZGU7Cgl0aGlzLmRhdGFQYXRoID0gZGF0YVBhdGggfHwgIiI7Cgl0aGlzLnNjaGVtYVBhdGggPSBzY2hlbWFQYXRoIHx8ICIiOwoJdGhpcy5zdWJFcnJvcnMgPSBzdWJFcnJvcnMgfHwgbnVsbDsKCgl2YXIgZXJyID0gbmV3IEVycm9yKHRoaXMubWVzc2FnZSk7Cgl0aGlzLnN0YWNrID0gZXJyLnN0YWNrIHx8IGVyci5zdGFja3RyYWNlOwoJaWYgKCF0aGlzLnN0YWNrKSB7CgkJdHJ5IHsKCQkJdGhyb3cgZXJyOwoJCX0KCQljYXRjaChlcnIpIHsKCQkJdGhpcy5zdGFjayA9IGVyci5zdGFjayB8fCBlcnIuc3RhY2t0cmFjZTsKCQl9Cgl9Cn0KVmFsaWRhdGlvbkVycm9yLnByb3RvdHlwZSA9IE9iamVjdC5jcmVhdGUoRXJyb3IucHJvdG90eXBlKTsKVmFsaWRhdGlvbkVycm9yLnByb3RvdHlwZS5jb25zdHJ1Y3RvciA9IFZhbGlkYXRpb25FcnJvcjsKVmFsaWRhdGlvbkVycm9yLnByb3RvdHlwZS5uYW1lID0gJ1ZhbGlkYXRpb25FcnJvcic7CgpWYWxpZGF0aW9uRXJyb3IucHJvdG90eXBlLnByZWZpeFdpdGggPSBmdW5jdGlvbiAoZGF0YVByZWZpeCwgc2NoZW1hUHJlZml4KSB7CglpZiAoZGF0YVByZWZpeCAhPT0gbnVsbCkgewoJCWRhdGFQcmVmaXggPSBkYXRhUHJlZml4LnJlcGxhY2UoL34vZywgIn4wIikucmVwbGFjZSgvXC8vZywgIn4xIik7CgkJdGhpcy5kYXRhUGF0aCA9ICIvIiArIGRhdGFQcmVmaXggKyB0aGlzLmRhdGFQYXRoOwoJfQoJaWYgKHNjaGVtYVByZWZpeCAhPT0gbnVsbCkgewoJCXNjaGVtYVByZWZpeCA9IHNjaGVtYVByZWZpeC5yZXBsYWNlKC9+L2csICJ+MCIpLnJlcGxhY2UoL1wvL2csICJ+MSIpOwoJCXRoaXMuc2NoZW1hUGF0aCA9ICIvIiArIHNjaGVtYVByZWZpeCArIHRoaXMuc2NoZW1hUGF0aDsKCX0KCWlmICh0aGlzLnN1YkVycm9ycyAhPT0gbnVsbCkgewoJCWZvciAodmFyIGkgPSAwOyBpIDwgdGhpcy5zdWJFcnJvcnMubGVuZ3RoOyBpKyspIHsKCQkJdGhpcy5zdWJFcnJvcnNbaV0ucHJlZml4V2l0aChkYXRhUHJlZml4LCBzY2hlbWFQcmVmaXgpOwoJCX0KCX0KCXJldHVybiB0aGlzOwp9OwoKZnVuY3Rpb24gaXNUcnVzdGVkVXJsKGJhc2VVcmwsIHRlc3RVcmwpIHsKCWlmKHRlc3RVcmwuc3Vic3RyaW5nKDAsIGJhc2VVcmwubGVuZ3RoKSA9PT0gYmFzZVVybCl7CgkJdmFyIHJlbWFpbmRlciA9IHRlc3RVcmwuc3Vic3RyaW5nKGJhc2VVcmwubGVuZ3RoKTsKCQlpZiAoKHRlc3RVcmwubGVuZ3RoID4gMCAmJiB0ZXN0VXJsLmNoYXJBdChiYXNlVXJsLmxlbmd0aCAtIDEpID09PSAiLyIpCgkJCXx8IHJlbWFpbmRlci5jaGFyQXQoMCkgPT09ICIjIgoJCQl8fCByZW1haW5kZXIuY2hhckF0KDApID09PSAiPyIpIHsKCQkJcmV0dXJuIHRydWU7CgkJfQoJfQoJcmV0dXJuIGZhbHNlOwp9Cgp2YXIgbGFuZ3VhZ2VzID0ge307CmZ1bmN0aW9uIGNyZWF0ZUFwaShsYW5ndWFnZSkgewoJdmFyIGdsb2JhbENvbnRleHQgPSBuZXcgVmFsaWRhdG9yQ29udGV4dCgpOwoJdmFyIGN1cnJlbnRMYW5ndWFnZTsKCXZhciBjdXN0b21FcnJvclJlcG9ydGVyOwoJdmFyIGFwaSA9IHsKCQlzZXRFcnJvclJlcG9ydGVyOiBmdW5jdGlvbiAocmVwb3J0ZXIpIHsKCQkJaWYgKHR5cGVvZiByZXBvcnRlciA9PT0gJ3N0cmluZycpIHsKCQkJCXJldHVybiB0aGlzLmxhbmd1YWdlKHJlcG9ydGVyKTsKCQkJfQoJCQljdXN0b21FcnJvclJlcG9ydGVyID0gcmVwb3J0ZXI7CgkJCXJldHVybiB0cnVlOwoJCX0sCgkJYWRkRm9ybWF0OiBmdW5jdGlvbiAoKSB7CgkJCWdsb2JhbENvbnRleHQuYWRkRm9ybWF0LmFwcGx5KGdsb2JhbENvbnRleHQsIGFyZ3VtZW50cyk7CgkJfSwKCQlsYW5ndWFnZTogZnVuY3Rpb24gKGNvZGUpIHsKCQkJaWYgKCFjb2RlKSB7CgkJCQlyZXR1cm4gY3VycmVudExhbmd1YWdlOwoJCQl9CgkJCWlmICghbGFuZ3VhZ2VzW2NvZGVdKSB7CgkJCQljb2RlID0gY29kZS5zcGxpdCgnLScpWzBdOyAvLyBmYWxsIGJhY2sgdG8gYmFzZSBsYW5ndWFnZQoJCQl9CgkJCWlmIChsYW5ndWFnZXNbY29kZV0pIHsKCQkJCWN1cnJlbnRMYW5ndWFnZSA9IGNvZGU7CgkJCQlyZXR1cm4gY29kZTsgLy8gc28geW91IGNhbiB0ZWxsIGlmIGZhbGwtYmFjayBoYXMgaGFwcGVuZWQKCQkJfQoJCQlyZXR1cm4gZmFsc2U7CgkJfSwKCQlhZGRMYW5ndWFnZTogZnVuY3Rpb24gKGNvZGUsIG1lc3NhZ2VNYXApIHsKCQkJdmFyIGtleTsKCQkJZm9yIChrZXkgaW4gRXJyb3JDb2RlcykgewoJCQkJaWYgKG1lc3NhZ2VNYXBba2V5XSAmJiAhbWVzc2FnZU1hcFtFcnJvckNvZGVzW2tleV1dKSB7CgkJCQkJbWVzc2FnZU1hcFtFcnJvckNvZGVzW2tleV1dID0gbWVzc2FnZU1hcFtrZXldOwoJCQkJfQoJCQl9CgkJCXZhciByb290Q29kZSA9IGNvZGUuc3BsaXQoJy0nKVswXTsKCQkJaWYgKCFsYW5ndWFnZXNbcm9vdENvZGVdKSB7IC8vIHVzZSBmb3IgYmFzZSBsYW5ndWFnZSBpZiBub3QgeWV0IGRlZmluZWQKCQkJCWxhbmd1YWdlc1tjb2RlXSA9IG1lc3NhZ2VNYXA7CgkJCQlsYW5ndWFnZXNbcm9vdENvZGVdID0gbWVzc2FnZU1hcDsKCQkJfSBlbHNlIHsKCQkJCWxhbmd1YWdlc1tjb2RlXSA9IE9iamVjdC5jcmVhdGUobGFuZ3VhZ2VzW3Jvb3RDb2RlXSk7CgkJCQlmb3IgKGtleSBpbiBtZXNzYWdlTWFwKSB7CgkJCQkJaWYgKHR5cGVvZiBsYW5ndWFnZXNbcm9vdENvZGVdW2tleV0gPT09ICd1bmRlZmluZWQnKSB7CgkJCQkJCWxhbmd1YWdlc1tyb290Q29kZV1ba2V5XSA9IG1lc3NhZ2VNYXBba2V5XTsKCQkJCQl9CgkJCQkJbGFuZ3VhZ2VzW2NvZGVdW2tleV0gPSBtZXNzYWdlTWFwW2tleV07CgkJCQl9CgkJCX0KCQkJcmV0dXJuIHRoaXM7CgkJfSwKCQlmcmVzaEFwaTogZnVuY3Rpb24gKGxhbmd1YWdlKSB7CgkJCXZhciByZXN1bHQgPSBjcmVhdGVBcGkoKTsKCQkJaWYgKGxhbmd1YWdlKSB7CgkJCQlyZXN1bHQubGFuZ3VhZ2UobGFuZ3VhZ2UpOwoJCQl9CgkJCXJldHVybiByZXN1bHQ7CgkJfSwKCQl2YWxpZGF0ZTogZnVuY3Rpb24gKGRhdGEsIHNjaGVtYSwgY2hlY2tSZWN1cnNpdmUsIGJhblVua25vd25Qcm9wZXJ0aWVzKSB7CgkJCXZhciBkZWYgPSBkZWZhdWx0RXJyb3JSZXBvcnRlcihjdXJyZW50TGFuZ3VhZ2UpOwoJCQl2YXIgZXJyb3JSZXBvcnRlciA9IGN1c3RvbUVycm9yUmVwb3J0ZXIgPyBmdW5jdGlvbiAoZXJyb3IsIGRhdGEsIHNjaGVtYSkgewoJCQkJcmV0dXJuIGN1c3RvbUVycm9yUmVwb3J0ZXIoZXJyb3IsIGRhdGEsIHNjaGVtYSkgfHwgZGVmKGVycm9yLCBkYXRhLCBzY2hlbWEpOwoJCQl9IDogZGVmOwoJCQl2YXIgY29udGV4dCA9IG5ldyBWYWxpZGF0b3JDb250ZXh0KGdsb2JhbENvbnRleHQsIGZhbHNlLCBlcnJvclJlcG9ydGVyLCBjaGVja1JlY3Vyc2l2ZSwgYmFuVW5rbm93blByb3BlcnRpZXMpOwoJCQlpZiAodHlwZW9mIHNjaGVtYSA9PT0gInN0cmluZyIpIHsKCQkJCXNjaGVtYSA9IHsiJHJlZiI6IHNjaGVtYX07CgkJCX0KCQkJY29udGV4dC5hZGRTY2hlbWEoIiIsIHNjaGVtYSk7CgkJCXZhciBlcnJvciA9IGNvbnRleHQudmFsaWRhdGVBbGwoZGF0YSwgc2NoZW1hLCBudWxsLCBudWxsLCAiIik7CgkJCWlmICghZXJyb3IgJiYgYmFuVW5rbm93blByb3BlcnRpZXMpIHsKCQkJCWVycm9yID0gY29udGV4dC5iYW5Vbmtub3duUHJvcGVydGllcyhkYXRhLCBzY2hlbWEpOwoJCQl9CgkJCXRoaXMuZXJyb3IgPSBlcnJvcjsKCQkJdGhpcy5taXNzaW5nID0gY29udGV4dC5taXNzaW5nOwoJCQl0aGlzLnZhbGlkID0gKGVycm9yID09PSBudWxsKTsKCQkJcmV0dXJuIHRoaXMudmFsaWQ7CgkJfSwKCQl2YWxpZGF0ZVJlc3VsdDogZnVuY3Rpb24gKCkgewoJCQl2YXIgcmVzdWx0ID0ge307CgkJCXRoaXMudmFsaWRhdGUuYXBwbHkocmVzdWx0LCBhcmd1bWVudHMpOwoJCQlyZXR1cm4gcmVzdWx0OwoJCX0sCgkJdmFsaWRhdGVNdWx0aXBsZTogZnVuY3Rpb24gKGRhdGEsIHNjaGVtYSwgY2hlY2tSZWN1cnNpdmUsIGJhblVua25vd25Qcm9wZXJ0aWVzKSB7CgkJCXZhciBkZWYgPSBkZWZhdWx0RXJyb3JSZXBvcnRlcihjdXJyZW50TGFuZ3VhZ2UpOwoJCQl2YXIgZXJyb3JSZXBvcnRlciA9IGN1c3RvbUVycm9yUmVwb3J0ZXIgPyBmdW5jdGlvbiAoZXJyb3IsIGRhdGEsIHNjaGVtYSkgewoJCQkJcmV0dXJuIGN1c3RvbUVycm9yUmVwb3J0ZXIoZXJyb3IsIGRhdGEsIHNjaGVtYSkgfHwgZGVmKGVycm9yLCBkYXRhLCBzY2hlbWEpOwoJCQl9IDogZGVmOwoJCQl2YXIgY29udGV4dCA9IG5ldyBWYWxpZGF0b3JDb250ZXh0KGdsb2JhbENvbnRleHQsIHRydWUsIGVycm9yUmVwb3J0ZXIsIGNoZWNrUmVjdXJzaXZlLCBiYW5Vbmtub3duUHJvcGVydGllcyk7CgkJCWlmICh0eXBlb2Ygc2NoZW1hID09PSAic3RyaW5nIikgewoJCQkJc2NoZW1hID0geyIkcmVmIjogc2NoZW1hfTsKCQkJfQoJCQljb250ZXh0LmFkZFNjaGVtYSgiIiwgc2NoZW1hKTsKCQkJY29udGV4dC52YWxpZGF0ZUFsbChkYXRhLCBzY2hlbWEsIG51bGwsIG51bGwsICIiKTsKCQkJaWYgKGJhblVua25vd25Qcm9wZXJ0aWVzKSB7CgkJCQljb250ZXh0LmJhblVua25vd25Qcm9wZXJ0aWVzKGRhdGEsIHNjaGVtYSk7CgkJCX0KCQkJdmFyIHJlc3VsdCA9IHt9OwoJCQlyZXN1bHQuZXJyb3JzID0gY29udGV4dC5lcnJvcnM7CgkJCXJlc3VsdC5taXNzaW5nID0gY29udGV4dC5taXNzaW5nOwoJCQlyZXN1bHQudmFsaWQgPSAocmVzdWx0LmVycm9ycy5sZW5ndGggPT09IDApOwoJCQlyZXR1cm4gcmVzdWx0OwoJCX0sCgkJYWRkU2NoZW1hOiBmdW5jdGlvbiAoKSB7CgkJCXJldHVybiBnbG9iYWxDb250ZXh0LmFkZFNjaGVtYS5hcHBseShnbG9iYWxDb250ZXh0LCBhcmd1bWVudHMpOwoJCX0sCgkJZ2V0U2NoZW1hOiBmdW5jdGlvbiAoKSB7CgkJCXJldHVybiBnbG9iYWxDb250ZXh0LmdldFNjaGVtYS5hcHBseShnbG9iYWxDb250ZXh0LCBhcmd1bWVudHMpOwoJCX0sCgkJZ2V0U2NoZW1hTWFwOiBmdW5jdGlvbiAoKSB7CgkJCXJldHVybiBnbG9iYWxDb250ZXh0LmdldFNjaGVtYU1hcC5hcHBseShnbG9iYWxDb250ZXh0LCBhcmd1bWVudHMpOwoJCX0sCgkJZ2V0U2NoZW1hVXJpczogZnVuY3Rpb24gKCkgewoJCQlyZXR1cm4gZ2xvYmFsQ29udGV4dC5nZXRTY2hlbWFVcmlzLmFwcGx5KGdsb2JhbENvbnRleHQsIGFyZ3VtZW50cyk7CgkJfSwKCQlnZXRNaXNzaW5nVXJpczogZnVuY3Rpb24gKCkgewoJCQlyZXR1cm4gZ2xvYmFsQ29udGV4dC5nZXRNaXNzaW5nVXJpcy5hcHBseShnbG9iYWxDb250ZXh0LCBhcmd1bWVudHMpOwoJCX0sCgkJZHJvcFNjaGVtYXM6IGZ1bmN0aW9uICgpIHsKCQkJZ2xvYmFsQ29udGV4dC5kcm9wU2NoZW1hcy5hcHBseShnbG9iYWxDb250ZXh0LCBhcmd1bWVudHMpOwoJCX0sCgkJZGVmaW5lS2V5d29yZDogZnVuY3Rpb24gKCkgewoJCQlnbG9iYWxDb250ZXh0LmRlZmluZUtleXdvcmQuYXBwbHkoZ2xvYmFsQ29udGV4dCwgYXJndW1lbnRzKTsKCQl9LAoJCWRlZmluZUVycm9yOiBmdW5jdGlvbiAoY29kZU5hbWUsIGNvZGVOdW1iZXIsIGRlZmF1bHRNZXNzYWdlKSB7CgkJCWlmICh0eXBlb2YgY29kZU5hbWUgIT09ICdzdHJpbmcnIHx8ICEvXltBLVpdKyhfW0EtWl0rKSokLy50ZXN0KGNvZGVOYW1lKSkgewoJCQkJdGhyb3cgbmV3IEVycm9yKCdDb2RlIG5hbWUgbXVzdCBiZSBhIHN0cmluZyBpbiBVUFBFUl9DQVNFX1dJVEhfVU5ERVJTQ09SRVMnKTsKCQkJfQoJCQlpZiAodHlwZW9mIGNvZGVOdW1iZXIgIT09ICdudW1iZXInIHx8IGNvZGVOdW1iZXIlMSAhPT0gMCB8fCBjb2RlTnVtYmVyIDwgMTAwMDApIHsKCQkJCXRocm93IG5ldyBFcnJvcignQ29kZSBudW1iZXIgbXVzdCBiZSBhbiBpbnRlZ2VyID4gMTAwMDAnKTsKCQkJfQoJCQlpZiAodHlwZW9mIEVycm9yQ29kZXNbY29kZU5hbWVdICE9PSAndW5kZWZpbmVkJykgewoJCQkJdGhyb3cgbmV3IEVycm9yKCdFcnJvciBhbHJlYWR5IGRlZmluZWQ6ICcgKyBjb2RlTmFtZSArICcgYXMgJyArIEVycm9yQ29kZXNbY29kZU5hbWVdKTsKCQkJfQoJCQlpZiAodHlwZW9mIEVycm9yQ29kZUxvb2t1cFtjb2RlTnVtYmVyXSAhPT0gJ3VuZGVmaW5lZCcpIHsKCQkJCXRocm93IG5ldyBFcnJvcignRXJyb3IgY29kZSBhbHJlYWR5IHVzZWQ6ICcgKyBFcnJvckNvZGVMb29rdXBbY29kZU51bWJlcl0gKyAnIGFzICcgKyBjb2RlTnVtYmVyKTsKCQkJfQoJCQlFcnJvckNvZGVzW2NvZGVOYW1lXSA9IGNvZGVOdW1iZXI7CgkJCUVycm9yQ29kZUxvb2t1cFtjb2RlTnVtYmVyXSA9IGNvZGVOYW1lOwoJCQlFcnJvck1lc3NhZ2VzRGVmYXVsdFtjb2RlTmFtZV0gPSBFcnJvck1lc3NhZ2VzRGVmYXVsdFtjb2RlTnVtYmVyXSA9IGRlZmF1bHRNZXNzYWdlOwoJCQlmb3IgKHZhciBsYW5nQ29kZSBpbiBsYW5ndWFnZXMpIHsKCQkJCXZhciBsYW5ndWFnZSA9IGxhbmd1YWdlc1tsYW5nQ29kZV07CgkJCQlpZiAobGFuZ3VhZ2VbY29kZU5hbWVdKSB7CgkJCQkJbGFuZ3VhZ2VbY29kZU51bWJlcl0gPSBsYW5ndWFnZVtjb2RlTnVtYmVyXSB8fCBsYW5ndWFnZVtjb2RlTmFtZV07CgkJCQl9CgkJCX0KCQl9LAoJCXJlc2V0OiBmdW5jdGlvbiAoKSB7CgkJCWdsb2JhbENvbnRleHQucmVzZXQoKTsKCQkJdGhpcy5lcnJvciA9IG51bGw7CgkJCXRoaXMubWlzc2luZyA9IFtdOwoJCQl0aGlzLnZhbGlkID0gdHJ1ZTsKCQl9LAoJCW1pc3Npbmc6IFtdLAoJCWVycm9yOiBudWxsLAoJCXZhbGlkOiB0cnVlLAoJCW5vcm1TY2hlbWE6IG5vcm1TY2hlbWEsCgkJcmVzb2x2ZVVybDogcmVzb2x2ZVVybCwKCQlnZXREb2N1bWVudFVyaTogZ2V0RG9jdW1lbnRVcmksCgkJZXJyb3JDb2RlczogRXJyb3JDb2RlcwoJfTsKCWFwaS5sYW5ndWFnZShsYW5ndWFnZSB8fCAnZW4nKTsKCXJldHVybiBhcGk7Cn0KCnZhciB0djQgPSBjcmVhdGVBcGkoKTsKdHY0LmFkZExhbmd1YWdlKCdlbi1nYicsIEVycm9yTWVzc2FnZXNEZWZhdWx0KTsKCi8vbGVnYWN5IHByb3BlcnR5CnR2NC50djQgPSB0djQ7CgpyZXR1cm4gdHY0OyAvLyB1c2VkIGJ5IF9oZWFkZXIuanMgdG8gZ2xvYmFsaXNlLgoKfSkpOwp9LHt9XSwyOltmdW5jdGlvbihyZXF1aXJlLG1vZHVsZSxleHBvcnRzKXsKLyoKICogIENvcHlyaWdodCAoYykgMjAxNCBUaGUgV2ViUlRDIHByb2plY3QgYXV0aG9ycy4gQWxsIFJpZ2h0cyBSZXNlcnZlZC4KICoKICogIFVzZSBvZiB0aGlzIHNvdXJjZSBjb2RlIGlzIGdvdmVybmVkIGJ5IGEgQlNELXN0eWxlIGxpY2Vuc2UKICogIHRoYXQgY2FuIGJlIGZvdW5kIGluIHRoZSBMSUNFTlNFIGZpbGUgaW4gdGhlIHJvb3Qgb2YgdGhlIHNvdXJjZQogKiAgdHJlZS4KICovCgovKiBNb3JlIGluZm9ybWF0aW9uIGFib3V0IHRoZXNlIG9wdGlvbnMgYXQganNoaW50LmNvbS9kb2NzL29wdGlvbnMgKi8KLyoganNoaW50IGJyb3dzZXI6IHRydWUsIGNhbWVsY2FzZTogdHJ1ZSwgY3VybHk6IHRydWUsIGRldmVsOiB0cnVlLAogICBlcWVxZXE6IHRydWUsIGZvcmluOiBmYWxzZSwgZ2xvYmFsc3RyaWN0OiB0cnVlLCBub2RlOiB0cnVlLAogICBxdW90bWFyazogc2luZ2xlLCB1bmRlZjogdHJ1ZSwgdW51c2VkOiBzdHJpY3QgKi8KLyogZ2xvYmFsIG1velJUQ0ljZUNhbmRpZGF0ZSwgbW96UlRDUGVlckNvbm5lY3Rpb24sIFByb21pc2UsCm1velJUQ1Nlc3Npb25EZXNjcmlwdGlvbiwgd2Via2l0UlRDUGVlckNvbm5lY3Rpb24sIE1lZGlhU3RyZWFtVHJhY2sgKi8KLyogZXhwb3J0ZWQgdHJhY2UscmVxdWVzdFVzZXJNZWRpYSAqLwoKJ3VzZSBzdHJpY3QnOwoKdmFyIGdldFVzZXJNZWRpYSA9IG51bGw7CnZhciBhdHRhY2hNZWRpYVN0cmVhbSA9IG51bGw7CnZhciByZWF0dGFjaE1lZGlhU3RyZWFtID0gbnVsbDsKdmFyIHdlYnJ0Y0RldGVjdGVkQnJvd3NlciA9IG51bGw7CnZhciB3ZWJydGNEZXRlY3RlZFZlcnNpb24gPSBudWxsOwp2YXIgd2VicnRjTWluaW11bVZlcnNpb24gPSBudWxsOwp2YXIgd2VicnRjVXRpbHMgPSB7CiAgbG9nOiBmdW5jdGlvbigpIHsKICAgIC8vIHN1cHByZXNzIGNvbnNvbGUubG9nIG91dHB1dCB3aGVuIGJlaW5nIGluY2x1ZGVkIGFzIGEgbW9kdWxlLgogICAgaWYgKHR5cGVvZiBtb2R1bGUgIT09ICd1bmRlZmluZWQnIHx8CiAgICAgICAgdHlwZW9mIHJlcXVpcmUgPT09ICdmdW5jdGlvbicgJiYgdHlwZW9mIGRlZmluZSA9PT0gJ2Z1bmN0aW9uJykgewogICAgICByZXR1cm47CiAgICB9CiAgICBjb25zb2xlLmxvZy5hcHBseShjb25zb2xlLCBhcmd1bWVudHMpOwogIH0sCiAgZXh0cmFjdFZlcnNpb246IGZ1bmN0aW9uKHVhc3RyaW5nLCBleHByLCBwb3MpIHsKICAgIHZhciBtYXRjaCA9IHVhc3RyaW5nLm1hdGNoKGV4cHIpOwogICAgcmV0dXJuIG1hdGNoICYmIG1hdGNoLmxlbmd0aCA+PSBwb3MgJiYgcGFyc2VJbnQobWF0Y2hbcG9zXSk7CiAgfQp9OwoKZnVuY3Rpb24gdHJhY2UodGV4dCkgewogIC8vIFRoaXMgZnVuY3Rpb24gaXMgdXNlZCBmb3IgbG9nZ2luZy4KICBpZiAodGV4dFt0ZXh0Lmxlbmd0aCAtIDFdID09PSAnXG4nKSB7CiAgICB0ZXh0ID0gdGV4dC5zdWJzdHJpbmcoMCwgdGV4dC5sZW5ndGggLSAxKTsKICB9CiAgaWYgKHdpbmRvdy5wZXJmb3JtYW5jZSkgewogICAgdmFyIG5vdyA9ICh3aW5kb3cucGVyZm9ybWFuY2Uubm93KCkgLyAxMDAwKS50b0ZpeGVkKDMpOwogICAgd2VicnRjVXRpbHMubG9nKG5vdyArICc6ICcgKyB0ZXh0KTsKICB9IGVsc2UgewogICAgd2VicnRjVXRpbHMubG9nKHRleHQpOwogIH0KfQoKaWYgKHR5cGVvZiB3aW5kb3cgPT09ICdvYmplY3QnKSB7CiAgaWYgKHdpbmRvdy5IVE1MTWVkaWFFbGVtZW50ICYmCiAgICAhKCdzcmNPYmplY3QnIGluIHdpbmRvdy5IVE1MTWVkaWFFbGVtZW50LnByb3RvdHlwZSkpIHsKICAgIC8vIFNoaW0gdGhlIHNyY09iamVjdCBwcm9wZXJ0eSwgb25jZSwgd2hlbiBIVE1MTWVkaWFFbGVtZW50IGlzIGZvdW5kLgogICAgT2JqZWN0LmRlZmluZVByb3BlcnR5KHdpbmRvdy5IVE1MTWVkaWFFbGVtZW50LnByb3RvdHlwZSwgJ3NyY09iamVjdCcsIHsKICAgICAgZ2V0OiBmdW5jdGlvbigpIHsKICAgICAgICAvLyBJZiBwcmVmaXhlZCBzcmNPYmplY3QgcHJvcGVydHkgZXhpc3RzLCByZXR1cm4gaXQuCiAgICAgICAgLy8gT3RoZXJ3aXNlIHVzZSB0aGUgc2hpbW1lZCBwcm9wZXJ0eSwgX3NyY09iamVjdAogICAgICAgIHJldHVybiAnbW96U3JjT2JqZWN0JyBpbiB0aGlzID8gdGhpcy5tb3pTcmNPYmplY3QgOiB0aGlzLl9zcmNPYmplY3Q7CiAgICAgIH0sCiAgICAgIHNldDogZnVuY3Rpb24oc3RyZWFtKSB7CiAgICAgICAgaWYgKCdtb3pTcmNPYmplY3QnIGluIHRoaXMpIHsKICAgICAgICAgIHRoaXMubW96U3JjT2JqZWN0ID0gc3RyZWFtOwogICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAvLyBVc2UgX3NyY09iamVjdCBhcyBhIHByaXZhdGUgcHJvcGVydHkgZm9yIHRoaXMgc2hpbQogICAgICAgICAgdGhpcy5fc3JjT2JqZWN0ID0gc3RyZWFtOwogICAgICAgICAgLy8gVE9ETzogcmV2b2tlT2JqZWN0VXJsKHRoaXMuc3JjKSB3aGVuICFzdHJlYW0gdG8gcmVsZWFzZSByZXNvdXJjZXM/CiAgICAgICAgICB0aGlzLnNyYyA9IFVSTC5jcmVhdGVPYmplY3RVUkwoc3RyZWFtKTsKICAgICAgICB9CiAgICAgIH0KICAgIH0pOwogIH0KICAvLyBQcm94eSBleGlzdGluZyBnbG9iYWxzCiAgZ2V0VXNlck1lZGlhID0gd2luZG93Lm5hdmlnYXRvciAmJiB3aW5kb3cubmF2aWdhdG9yLmdldFVzZXJNZWRpYTsKfQoKLy8gQXR0YWNoIGEgbWVkaWEgc3RyZWFtIHRvIGFuIGVsZW1lbnQuCmF0dGFjaE1lZGlhU3RyZWFtID0gZnVuY3Rpb24oZWxlbWVudCwgc3RyZWFtKSB7CiAgZWxlbWVudC5zcmNPYmplY3QgPSBzdHJlYW07Cn07CgpyZWF0dGFjaE1lZGlhU3RyZWFtID0gZnVuY3Rpb24odG8sIGZyb20pIHsKICB0by5zcmNPYmplY3QgPSBmcm9tLnNyY09iamVjdDsKfTsKCmlmICh0eXBlb2Ygd2luZG93ID09PSAndW5kZWZpbmVkJyB8fCAhd2luZG93Lm5hdmlnYXRvcikgewogIHdlYnJ0Y1V0aWxzLmxvZygnVGhpcyBkb2VzIG5vdCBhcHBlYXIgdG8gYmUgYSBicm93c2VyJyk7CiAgd2VicnRjRGV0ZWN0ZWRCcm93c2VyID0gJ25vdCBhIGJyb3dzZXInOwp9IGVsc2UgaWYgKG5hdmlnYXRvci5tb3pHZXRVc2VyTWVkaWEgJiYgd2luZG93Lm1velJUQ1BlZXJDb25uZWN0aW9uKSB7CiAgd2VicnRjVXRpbHMubG9nKCdUaGlzIGFwcGVhcnMgdG8gYmUgRmlyZWZveCcpOwoKICB3ZWJydGNEZXRlY3RlZEJyb3dzZXIgPSAnZmlyZWZveCc7CgogIC8vIHRoZSBkZXRlY3RlZCBmaXJlZm94IHZlcnNpb24uCiAgd2VicnRjRGV0ZWN0ZWRWZXJzaW9uID0gd2VicnRjVXRpbHMuZXh0cmFjdFZlcnNpb24obmF2aWdhdG9yLnVzZXJBZ2VudCwKICAgICAgL0ZpcmVmb3hcLyhbMC05XSspXC4vLCAxKTsKCiAgLy8gdGhlIG1pbmltdW0gZmlyZWZveCB2ZXJzaW9uIHN0aWxsIHN1cHBvcnRlZCBieSBhZGFwdGVyLgogIHdlYnJ0Y01pbmltdW1WZXJzaW9uID0gMzE7CgogIC8vIFRoZSBSVENQZWVyQ29ubmVjdGlvbiBvYmplY3QuCiAgd2luZG93LlJUQ1BlZXJDb25uZWN0aW9uID0gZnVuY3Rpb24ocGNDb25maWcsIHBjQ29uc3RyYWludHMpIHsKICAgIGlmICh3ZWJydGNEZXRlY3RlZFZlcnNpb24gPCAzOCkgewogICAgICAvLyAudXJscyBpcyBub3Qgc3VwcG9ydGVkIGluIEZGIDwgMzguCiAgICAgIC8vIGNyZWF0ZSBSVENJY2VTZXJ2ZXJzIHdpdGggYSBzaW5nbGUgdXJsLgogICAgICBpZiAocGNDb25maWcgJiYgcGNDb25maWcuaWNlU2VydmVycykgewogICAgICAgIHZhciBuZXdJY2VTZXJ2ZXJzID0gW107CiAgICAgICAgZm9yICh2YXIgaSA9IDA7IGkgPCBwY0NvbmZpZy5pY2VTZXJ2ZXJzLmxlbmd0aDsgaSsrKSB7CiAgICAgICAgICB2YXIgc2VydmVyID0gcGNDb25maWcuaWNlU2VydmVyc1tpXTsKICAgICAgICAgIGlmIChzZXJ2ZXIuaGFzT3duUHJvcGVydHkoJ3VybHMnKSkgewogICAgICAgICAgICBmb3IgKHZhciBqID0gMDsgaiA8IHNlcnZlci51cmxzLmxlbmd0aDsgaisrKSB7CiAgICAgICAgICAgICAgdmFyIG5ld1NlcnZlciA9IHsKICAgICAgICAgICAgICAgIHVybDogc2VydmVyLnVybHNbal0KICAgICAgICAgICAgICB9OwogICAgICAgICAgICAgIGlmIChzZXJ2ZXIudXJsc1tqXS5pbmRleE9mKCd0dXJuJykgPT09IDApIHsKICAgICAgICAgICAgICAgIG5ld1NlcnZlci51c2VybmFtZSA9IHNlcnZlci51c2VybmFtZTsKICAgICAgICAgICAgICAgIG5ld1NlcnZlci5jcmVkZW50aWFsID0gc2VydmVyLmNyZWRlbnRpYWw7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIG5ld0ljZVNlcnZlcnMucHVzaChuZXdTZXJ2ZXIpOwogICAgICAgICAgICB9CiAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICBuZXdJY2VTZXJ2ZXJzLnB1c2gocGNDb25maWcuaWNlU2VydmVyc1tpXSk7CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICAgIHBjQ29uZmlnLmljZVNlcnZlcnMgPSBuZXdJY2VTZXJ2ZXJzOwogICAgICB9CiAgICB9CiAgICByZXR1cm4gbmV3IG1velJUQ1BlZXJDb25uZWN0aW9uKHBjQ29uZmlnLCBwY0NvbnN0cmFpbnRzKTsgLy8ganNjczppZ25vcmUgcmVxdWlyZUNhcGl0YWxpemVkQ29uc3RydWN0b3JzCiAgfTsKCiAgLy8gVGhlIFJUQ1Nlc3Npb25EZXNjcmlwdGlvbiBvYmplY3QuCiAgaWYgKCF3aW5kb3cuUlRDU2Vzc2lvbkRlc2NyaXB0aW9uKSB7CiAgICB3aW5kb3cuUlRDU2Vzc2lvbkRlc2NyaXB0aW9uID0gbW96UlRDU2Vzc2lvbkRlc2NyaXB0aW9uOwogIH0KCiAgLy8gVGhlIFJUQ0ljZUNhbmRpZGF0ZSBvYmplY3QuCiAgaWYgKCF3aW5kb3cuUlRDSWNlQ2FuZGlkYXRlKSB7CiAgICB3aW5kb3cuUlRDSWNlQ2FuZGlkYXRlID0gbW96UlRDSWNlQ2FuZGlkYXRlOwogIH0KCiAgLy8gZ2V0VXNlck1lZGlhIGNvbnN0cmFpbnRzIHNoaW0uCiAgZ2V0VXNlck1lZGlhID0gZnVuY3Rpb24oY29uc3RyYWludHMsIG9uU3VjY2Vzcywgb25FcnJvcikgewogICAgdmFyIGNvbnN0cmFpbnRzVG9GRjM3ID0gZnVuY3Rpb24oYykgewogICAgICBpZiAodHlwZW9mIGMgIT09ICdvYmplY3QnIHx8IGMucmVxdWlyZSkgewogICAgICAgIHJldHVybiBjOwogICAgICB9CiAgICAgIHZhciByZXF1aXJlID0gW107CiAgICAgIE9iamVjdC5rZXlzKGMpLmZvckVhY2goZnVuY3Rpb24oa2V5KSB7CiAgICAgICAgaWYgKGtleSA9PT0gJ3JlcXVpcmUnIHx8IGtleSA9PT0gJ2FkdmFuY2VkJyB8fCBrZXkgPT09ICdtZWRpYVNvdXJjZScpIHsKICAgICAgICAgIHJldHVybjsKICAgICAgICB9CiAgICAgICAgdmFyIHIgPSBjW2tleV0gPSAodHlwZW9mIGNba2V5XSA9PT0gJ29iamVjdCcpID8KICAgICAgICAgICAgY1trZXldIDoge2lkZWFsOiBjW2tleV19OwogICAgICAgIGlmIChyLm1pbiAhPT0gdW5kZWZpbmVkIHx8CiAgICAgICAgICAgIHIubWF4ICE9PSB1bmRlZmluZWQgfHwgci5leGFjdCAhPT0gdW5kZWZpbmVkKSB7CiAgICAgICAgICByZXF1aXJlLnB1c2goa2V5KTsKICAgICAgICB9CiAgICAgICAgaWYgKHIuZXhhY3QgIT09IHVuZGVmaW5lZCkgewogICAgICAgICAgaWYgKHR5cGVvZiByLmV4YWN0ID09PSAnbnVtYmVyJykgewogICAgICAgICAgICByLm1pbiA9IHIubWF4ID0gci5leGFjdDsKICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgIGNba2V5XSA9IHIuZXhhY3Q7CiAgICAgICAgICB9CiAgICAgICAgICBkZWxldGUgci5leGFjdDsKICAgICAgICB9CiAgICAgICAgaWYgKHIuaWRlYWwgIT09IHVuZGVmaW5lZCkgewogICAgICAgICAgYy5hZHZhbmNlZCA9IGMuYWR2YW5jZWQgfHwgW107CiAgICAgICAgICB2YXIgb2MgPSB7fTsKICAgICAgICAgIGlmICh0eXBlb2Ygci5pZGVhbCA9PT0gJ251bWJlcicpIHsKICAgICAgICAgICAgb2Nba2V5XSA9IHttaW46IHIuaWRlYWwsIG1heDogci5pZGVhbH07CiAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICBvY1trZXldID0gci5pZGVhbDsKICAgICAgICAgIH0KICAgICAgICAgIGMuYWR2YW5jZWQucHVzaChvYyk7CiAgICAgICAgICBkZWxldGUgci5pZGVhbDsKICAgICAgICAgIGlmICghT2JqZWN0LmtleXMocikubGVuZ3RoKSB7CiAgICAgICAgICAgIGRlbGV0ZSBjW2tleV07CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICB9KTsKICAgICAgaWYgKHJlcXVpcmUubGVuZ3RoKSB7CiAgICAgICAgYy5yZXF1aXJlID0gcmVxdWlyZTsKICAgICAgfQogICAgICByZXR1cm4gYzsKICAgIH07CiAgICBpZiAod2VicnRjRGV0ZWN0ZWRWZXJzaW9uIDwgMzgpIHsKICAgICAgd2VicnRjVXRpbHMubG9nKCdzcGVjOiAnICsgSlNPTi5zdHJpbmdpZnkoY29uc3RyYWludHMpKTsKICAgICAgaWYgKGNvbnN0cmFpbnRzLmF1ZGlvKSB7CiAgICAgICAgY29uc3RyYWludHMuYXVkaW8gPSBjb25zdHJhaW50c1RvRkYzNyhjb25zdHJhaW50cy5hdWRpbyk7CiAgICAgIH0KICAgICAgaWYgKGNvbnN0cmFpbnRzLnZpZGVvKSB7CiAgICAgICAgY29uc3RyYWludHMudmlkZW8gPSBjb25zdHJhaW50c1RvRkYzNyhjb25zdHJhaW50cy52aWRlbyk7CiAgICAgIH0KICAgICAgd2VicnRjVXRpbHMubG9nKCdmZjM3OiAnICsgSlNPTi5zdHJpbmdpZnkoY29uc3RyYWludHMpKTsKICAgIH0KICAgIHJldHVybiBuYXZpZ2F0b3IubW96R2V0VXNlck1lZGlhKGNvbnN0cmFpbnRzLCBvblN1Y2Nlc3MsIG9uRXJyb3IpOwogIH07CgogIG5hdmlnYXRvci5nZXRVc2VyTWVkaWEgPSBnZXRVc2VyTWVkaWE7CgogIC8vIFNoaW0gZm9yIG1lZGlhRGV2aWNlcyBvbiBvbGRlciB2ZXJzaW9ucy4KICBpZiAoIW5hdmlnYXRvci5tZWRpYURldmljZXMpIHsKICAgIG5hdmlnYXRvci5tZWRpYURldmljZXMgPSB7Z2V0VXNlck1lZGlhOiByZXF1ZXN0VXNlck1lZGlhLAogICAgICBhZGRFdmVudExpc3RlbmVyOiBmdW5jdGlvbigpIHsgfSwKICAgICAgcmVtb3ZlRXZlbnRMaXN0ZW5lcjogZnVuY3Rpb24oKSB7IH0KICAgIH07CiAgfQogIG5hdmlnYXRvci5tZWRpYURldmljZXMuZW51bWVyYXRlRGV2aWNlcyA9CiAgICAgIG5hdmlnYXRvci5tZWRpYURldmljZXMuZW51bWVyYXRlRGV2aWNlcyB8fCBmdW5jdGlvbigpIHsKICAgIHJldHVybiBuZXcgUHJvbWlzZShmdW5jdGlvbihyZXNvbHZlKSB7CiAgICAgIHZhciBpbmZvcyA9IFsKICAgICAgICB7a2luZDogJ2F1ZGlvaW5wdXQnLCBkZXZpY2VJZDogJ2RlZmF1bHQnLCBsYWJlbDogJycsIGdyb3VwSWQ6ICcnfSwKICAgICAgICB7a2luZDogJ3ZpZGVvaW5wdXQnLCBkZXZpY2VJZDogJ2RlZmF1bHQnLCBsYWJlbDogJycsIGdyb3VwSWQ6ICcnfQogICAgICBdOwogICAgICByZXNvbHZlKGluZm9zKTsKICAgIH0pOwogIH07CgogIGlmICh3ZWJydGNEZXRlY3RlZFZlcnNpb24gPCA0MSkgewogICAgLy8gV29yayBhcm91bmQgaHR0cDovL2J1Z3ppbC5sYS8xMTY5NjY1CiAgICB2YXIgb3JnRW51bWVyYXRlRGV2aWNlcyA9CiAgICAgICAgbmF2aWdhdG9yLm1lZGlhRGV2aWNlcy5lbnVtZXJhdGVEZXZpY2VzLmJpbmQobmF2aWdhdG9yLm1lZGlhRGV2aWNlcyk7CiAgICBuYXZpZ2F0b3IubWVkaWFEZXZpY2VzLmVudW1lcmF0ZURldmljZXMgPSBmdW5jdGlvbigpIHsKICAgICAgcmV0dXJuIG9yZ0VudW1lcmF0ZURldmljZXMoKS50aGVuKHVuZGVmaW5lZCwgZnVuY3Rpb24oZSkgewogICAgICAgIGlmIChlLm5hbWUgPT09ICdOb3RGb3VuZEVycm9yJykgewogICAgICAgICAgcmV0dXJuIFtdOwogICAgICAgIH0KICAgICAgICB0aHJvdyBlOwogICAgICB9KTsKICAgIH07CiAgfQp9IGVsc2UgaWYgKG5hdmlnYXRvci53ZWJraXRHZXRVc2VyTWVkaWEgJiYgd2luZG93LndlYmtpdFJUQ1BlZXJDb25uZWN0aW9uKSB7CiAgd2VicnRjVXRpbHMubG9nKCdUaGlzIGFwcGVhcnMgdG8gYmUgQ2hyb21lJyk7CgogIHdlYnJ0Y0RldGVjdGVkQnJvd3NlciA9ICdjaHJvbWUnOwoKICAvLyB0aGUgZGV0ZWN0ZWQgY2hyb21lIHZlcnNpb24uCiAgd2VicnRjRGV0ZWN0ZWRWZXJzaW9uID0gd2VicnRjVXRpbHMuZXh0cmFjdFZlcnNpb24obmF2aWdhdG9yLnVzZXJBZ2VudCwKICAgICAgL0Nocm9tKGV8aXVtKVwvKFswLTldKylcLi8sIDIpOwoKICAvLyB0aGUgbWluaW11bSBjaHJvbWUgdmVyc2lvbiBzdGlsbCBzdXBwb3J0ZWQgYnkgYWRhcHRlci4KICB3ZWJydGNNaW5pbXVtVmVyc2lvbiA9IDM4OwoKICAvLyBUaGUgUlRDUGVlckNvbm5lY3Rpb24gb2JqZWN0LgogIHdpbmRvdy5SVENQZWVyQ29ubmVjdGlvbiA9IGZ1bmN0aW9uKHBjQ29uZmlnLCBwY0NvbnN0cmFpbnRzKSB7CiAgICAvLyBUcmFuc2xhdGUgaWNlVHJhbnNwb3J0UG9saWN5IHRvIGljZVRyYW5zcG9ydHMsCiAgICAvLyBzZWUgaHR0cHM6Ly9jb2RlLmdvb2dsZS5jb20vcC93ZWJydGMvaXNzdWVzL2RldGFpbD9pZD00ODY5CiAgICBpZiAocGNDb25maWcgJiYgcGNDb25maWcuaWNlVHJhbnNwb3J0UG9saWN5KSB7CiAgICAgIHBjQ29uZmlnLmljZVRyYW5zcG9ydHMgPSBwY0NvbmZpZy5pY2VUcmFuc3BvcnRQb2xpY3k7CiAgICB9CgogICAgdmFyIHBjID0gbmV3IHdlYmtpdFJUQ1BlZXJDb25uZWN0aW9uKHBjQ29uZmlnLCBwY0NvbnN0cmFpbnRzKTsgLy8ganNjczppZ25vcmUgcmVxdWlyZUNhcGl0YWxpemVkQ29uc3RydWN0b3JzCiAgICB2YXIgb3JpZ0dldFN0YXRzID0gcGMuZ2V0U3RhdHMuYmluZChwYyk7CiAgICBwYy5nZXRTdGF0cyA9IGZ1bmN0aW9uKHNlbGVjdG9yLCBzdWNjZXNzQ2FsbGJhY2ssIGVycm9yQ2FsbGJhY2spIHsgLy8ganNoaW50IGlnbm9yZTogbGluZQogICAgICB2YXIgc2VsZiA9IHRoaXM7CiAgICAgIHZhciBhcmdzID0gYXJndW1lbnRzOwoKICAgICAgLy8gSWYgc2VsZWN0b3IgaXMgYSBmdW5jdGlvbiB0aGVuIHdlIGFyZSBpbiB0aGUgb2xkIHN0eWxlIHN0YXRzIHNvIGp1c3QKICAgICAgLy8gcGFzcyBiYWNrIHRoZSBvcmlnaW5hbCBnZXRTdGF0cyBmb3JtYXQgdG8gYXZvaWQgYnJlYWtpbmcgb2xkIHVzZXJzLgogICAgICBpZiAoYXJndW1lbnRzLmxlbmd0aCA+IDAgJiYgdHlwZW9mIHNlbGVjdG9yID09PSAnZnVuY3Rpb24nKSB7CiAgICAgICAgcmV0dXJuIG9yaWdHZXRTdGF0cyhzZWxlY3Rvciwgc3VjY2Vzc0NhbGxiYWNrKTsKICAgICAgfQoKICAgICAgdmFyIGZpeENocm9tZVN0YXRzID0gZnVuY3Rpb24ocmVzcG9uc2UpIHsKICAgICAgICB2YXIgc3RhbmRhcmRSZXBvcnQgPSB7fTsKICAgICAgICB2YXIgcmVwb3J0cyA9IHJlc3BvbnNlLnJlc3VsdCgpOwogICAgICAgIHJlcG9ydHMuZm9yRWFjaChmdW5jdGlvbihyZXBvcnQpIHsKICAgICAgICAgIHZhciBzdGFuZGFyZFN0YXRzID0gewogICAgICAgICAgICBpZDogcmVwb3J0LmlkLAogICAgICAgICAgICB0aW1lc3RhbXA6IHJlcG9ydC50aW1lc3RhbXAsCiAgICAgICAgICAgIHR5cGU6IHJlcG9ydC50eXBlCiAgICAgICAgICB9OwogICAgICAgICAgcmVwb3J0Lm5hbWVzKCkuZm9yRWFjaChmdW5jdGlvbihuYW1lKSB7CiAgICAgICAgICAgIHN0YW5kYXJkU3RhdHNbbmFtZV0gPSByZXBvcnQuc3RhdChuYW1lKTsKICAgICAgICAgIH0pOwogICAgICAgICAgc3RhbmRhcmRSZXBvcnRbc3RhbmRhcmRTdGF0cy5pZF0gPSBzdGFuZGFyZFN0YXRzOwogICAgICAgIH0pOwoKICAgICAgICByZXR1cm4gc3RhbmRhcmRSZXBvcnQ7CiAgICAgIH07CgogICAgICBpZiAoYXJndW1lbnRzLmxlbmd0aCA+PSAyKSB7CiAgICAgICAgdmFyIHN1Y2Nlc3NDYWxsYmFja1dyYXBwZXIgPSBmdW5jdGlvbihyZXNwb25zZSkgewogICAgICAgICAgYXJnc1sxXShmaXhDaHJvbWVTdGF0cyhyZXNwb25zZSkpOwogICAgICAgIH07CgogICAgICAgIHJldHVybiBvcmlnR2V0U3RhdHMuYXBwbHkodGhpcywgW3N1Y2Nlc3NDYWxsYmFja1dyYXBwZXIsIGFyZ3VtZW50c1swXV0pOwogICAgICB9CgogICAgICAvLyBwcm9taXNlLXN1cHBvcnQKICAgICAgcmV0dXJuIG5ldyBQcm9taXNlKGZ1bmN0aW9uKHJlc29sdmUsIHJlamVjdCkgewogICAgICAgIGlmIChhcmdzLmxlbmd0aCA9PT0gMSAmJiBzZWxlY3RvciA9PT0gbnVsbCkgewogICAgICAgICAgb3JpZ0dldFN0YXRzLmFwcGx5KHNlbGYsIFsKICAgICAgICAgICAgICBmdW5jdGlvbihyZXNwb25zZSkgewogICAgICAgICAgICAgICAgcmVzb2x2ZS5hcHBseShudWxsLCBbZml4Q2hyb21lU3RhdHMocmVzcG9uc2UpXSk7CiAgICAgICAgICAgICAgfSwgcmVqZWN0XSk7CiAgICAgICAgfSBlbHNlIHsKICAgICAgICAgIG9yaWdHZXRTdGF0cy5hcHBseShzZWxmLCBbcmVzb2x2ZSwgcmVqZWN0XSk7CiAgICAgICAgfQogICAgICB9KTsKICAgIH07CgogICAgcmV0dXJuIHBjOwogIH07CgogIC8vIGFkZCBwcm9taXNlIHN1cHBvcnQKICBbJ2NyZWF0ZU9mZmVyJywgJ2NyZWF0ZUFuc3dlciddLmZvckVhY2goZnVuY3Rpb24obWV0aG9kKSB7CiAgICB2YXIgbmF0aXZlTWV0aG9kID0gd2Via2l0UlRDUGVlckNvbm5lY3Rpb24ucHJvdG90eXBlW21ldGhvZF07CiAgICB3ZWJraXRSVENQZWVyQ29ubmVjdGlvbi5wcm90b3R5cGVbbWV0aG9kXSA9IGZ1bmN0aW9uKCkgewogICAgICB2YXIgc2VsZiA9IHRoaXM7CiAgICAgIGlmIChhcmd1bWVudHMubGVuZ3RoIDwgMSB8fCAoYXJndW1lbnRzLmxlbmd0aCA9PT0gMSAmJgogICAgICAgICAgdHlwZW9mKGFyZ3VtZW50c1swXSkgPT09ICdvYmplY3QnKSkgewogICAgICAgIHZhciBvcHRzID0gYXJndW1lbnRzLmxlbmd0aCA9PT0gMSA/IGFyZ3VtZW50c1swXSA6IHVuZGVmaW5lZDsKICAgICAgICByZXR1cm4gbmV3IFByb21pc2UoZnVuY3Rpb24ocmVzb2x2ZSwgcmVqZWN0KSB7CiAgICAgICAgICBuYXRpdmVNZXRob2QuYXBwbHkoc2VsZiwgW3Jlc29sdmUsIHJlamVjdCwgb3B0c10pOwogICAgICAgIH0pOwogICAgICB9IGVsc2UgewogICAgICAgIHJldHVybiBuYXRpdmVNZXRob2QuYXBwbHkodGhpcywgYXJndW1lbnRzKTsKICAgICAgfQogICAgfTsKICB9KTsKCiAgWydzZXRMb2NhbERlc2NyaXB0aW9uJywgJ3NldFJlbW90ZURlc2NyaXB0aW9uJywKICAgICAgJ2FkZEljZUNhbmRpZGF0ZSddLmZvckVhY2goZnVuY3Rpb24obWV0aG9kKSB7CiAgICB2YXIgbmF0aXZlTWV0aG9kID0gd2Via2l0UlRDUGVlckNvbm5lY3Rpb24ucHJvdG90eXBlW21ldGhvZF07CiAgICB3ZWJraXRSVENQZWVyQ29ubmVjdGlvbi5wcm90b3R5cGVbbWV0aG9kXSA9IGZ1bmN0aW9uKCkgewogICAgICB2YXIgYXJncyA9IGFyZ3VtZW50czsKICAgICAgdmFyIHNlbGYgPSB0aGlzOwogICAgICByZXR1cm4gbmV3IFByb21pc2UoZnVuY3Rpb24ocmVzb2x2ZSwgcmVqZWN0KSB7CiAgICAgICAgbmF0aXZlTWV0aG9kLmFwcGx5KHNlbGYsIFthcmdzWzBdLAogICAgICAgICAgICBmdW5jdGlvbigpIHsKICAgICAgICAgICAgICByZXNvbHZlKCk7CiAgICAgICAgICAgICAgaWYgKGFyZ3MubGVuZ3RoID49IDIpIHsKICAgICAgICAgICAgICAgIGFyZ3NbMV0uYXBwbHkobnVsbCwgW10pOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgfSwKICAgICAgICAgICAgZnVuY3Rpb24oZXJyKSB7CiAgICAgICAgICAgICAgcmVqZWN0KGVycik7CiAgICAgICAgICAgICAgaWYgKGFyZ3MubGVuZ3RoID49IDMpIHsKICAgICAgICAgICAgICAgIGFyZ3NbMl0uYXBwbHkobnVsbCwgW2Vycl0pOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgfV0KICAgICAgICAgICk7CiAgICAgIH0pOwogICAgfTsKICB9KTsKCiAgLy8gZ2V0VXNlck1lZGlhIGNvbnN0cmFpbnRzIHNoaW0uCiAgdmFyIGNvbnN0cmFpbnRzVG9DaHJvbWUgPSBmdW5jdGlvbihjKSB7CiAgICBpZiAodHlwZW9mIGMgIT09ICdvYmplY3QnIHx8IGMubWFuZGF0b3J5IHx8IGMub3B0aW9uYWwpIHsKICAgICAgcmV0dXJuIGM7CiAgICB9CiAgICB2YXIgY2MgPSB7fTsKICAgIE9iamVjdC5rZXlzKGMpLmZvckVhY2goZnVuY3Rpb24oa2V5KSB7CiAgICAgIGlmIChrZXkgPT09ICdyZXF1aXJlJyB8fCBrZXkgPT09ICdhZHZhbmNlZCcgfHwga2V5ID09PSAnbWVkaWFTb3VyY2UnKSB7CiAgICAgICAgcmV0dXJuOwogICAgICB9CiAgICAgIHZhciByID0gKHR5cGVvZiBjW2tleV0gPT09ICdvYmplY3QnKSA/IGNba2V5XSA6IHtpZGVhbDogY1trZXldfTsKICAgICAgaWYgKHIuZXhhY3QgIT09IHVuZGVmaW5lZCAmJiB0eXBlb2Ygci5leGFjdCA9PT0gJ251bWJlcicpIHsKICAgICAgICByLm1pbiA9IHIubWF4ID0gci5leGFjdDsKICAgICAgfQogICAgICB2YXIgb2xkbmFtZSA9IGZ1bmN0aW9uKHByZWZpeCwgbmFtZSkgewogICAgICAgIGlmIChwcmVmaXgpIHsKICAgICAgICAgIHJldHVybiBwcmVmaXggKyBuYW1lLmNoYXJBdCgwKS50b1VwcGVyQ2FzZSgpICsgbmFtZS5zbGljZSgxKTsKICAgICAgICB9CiAgICAgICAgcmV0dXJuIChuYW1lID09PSAnZGV2aWNlSWQnKSA/ICdzb3VyY2VJZCcgOiBuYW1lOwogICAgICB9OwogICAgICBpZiAoci5pZGVhbCAhPT0gdW5kZWZpbmVkKSB7CiAgICAgICAgY2Mub3B0aW9uYWwgPSBjYy5vcHRpb25hbCB8fCBbXTsKICAgICAgICB2YXIgb2MgPSB7fTsKICAgICAgICBpZiAodHlwZW9mIHIuaWRlYWwgPT09ICdudW1iZXInKSB7CiAgICAgICAgICBvY1tvbGRuYW1lKCdtaW4nLCBrZXkpXSA9IHIuaWRlYWw7CiAgICAgICAgICBjYy5vcHRpb25hbC5wdXNoKG9jKTsKICAgICAgICAgIG9jID0ge307CiAgICAgICAgICBvY1tvbGRuYW1lKCdtYXgnLCBrZXkpXSA9IHIuaWRlYWw7CiAgICAgICAgICBjYy5vcHRpb25hbC5wdXNoKG9jKTsKICAgICAgICB9IGVsc2UgewogICAgICAgICAgb2Nbb2xkbmFtZSgnJywga2V5KV0gPSByLmlkZWFsOwogICAgICAgICAgY2Mub3B0aW9uYWwucHVzaChvYyk7CiAgICAgICAgfQogICAgICB9CiAgICAgIGlmIChyLmV4YWN0ICE9PSB1bmRlZmluZWQgJiYgdHlwZW9mIHIuZXhhY3QgIT09ICdudW1iZXInKSB7CiAgICAgICAgY2MubWFuZGF0b3J5ID0gY2MubWFuZGF0b3J5IHx8IHt9OwogICAgICAgIGNjLm1hbmRhdG9yeVtvbGRuYW1lKCcnLCBrZXkpXSA9IHIuZXhhY3Q7CiAgICAgIH0gZWxzZSB7CiAgICAgICAgWydtaW4nLCAnbWF4J10uZm9yRWFjaChmdW5jdGlvbihtaXgpIHsKICAgICAgICAgIGlmIChyW21peF0gIT09IHVuZGVmaW5lZCkgewogICAgICAgICAgICBjYy5tYW5kYXRvcnkgPSBjYy5tYW5kYXRvcnkgfHwge307CiAgICAgICAgICAgIGNjLm1hbmRhdG9yeVtvbGRuYW1lKG1peCwga2V5KV0gPSByW21peF07CiAgICAgICAgICB9CiAgICAgICAgfSk7CiAgICAgIH0KICAgIH0pOwogICAgaWYgKGMuYWR2YW5jZWQpIHsKICAgICAgY2Mub3B0aW9uYWwgPSAoY2Mub3B0aW9uYWwgfHwgW10pLmNvbmNhdChjLmFkdmFuY2VkKTsKICAgIH0KICAgIHJldHVybiBjYzsKICB9OwoKICBnZXRVc2VyTWVkaWEgPSBmdW5jdGlvbihjb25zdHJhaW50cywgb25TdWNjZXNzLCBvbkVycm9yKSB7CiAgICBpZiAoY29uc3RyYWludHMuYXVkaW8pIHsKICAgICAgY29uc3RyYWludHMuYXVkaW8gPSBjb25zdHJhaW50c1RvQ2hyb21lKGNvbnN0cmFpbnRzLmF1ZGlvKTsKICAgIH0KICAgIGlmIChjb25zdHJhaW50cy52aWRlbykgewogICAgICBjb25zdHJhaW50cy52aWRlbyA9IGNvbnN0cmFpbnRzVG9DaHJvbWUoY29uc3RyYWludHMudmlkZW8pOwogICAgfQogICAgd2VicnRjVXRpbHMubG9nKCdjaHJvbWU6ICcgKyBKU09OLnN0cmluZ2lmeShjb25zdHJhaW50cykpOwogICAgcmV0dXJuIG5hdmlnYXRvci53ZWJraXRHZXRVc2VyTWVkaWEoY29uc3RyYWludHMsIG9uU3VjY2Vzcywgb25FcnJvcik7CiAgfTsKICBuYXZpZ2F0b3IuZ2V0VXNlck1lZGlhID0gZ2V0VXNlck1lZGlhOwoKICBpZiAoIW5hdmlnYXRvci5tZWRpYURldmljZXMpIHsKICAgIG5hdmlnYXRvci5tZWRpYURldmljZXMgPSB7Z2V0VXNlck1lZGlhOiByZXF1ZXN0VXNlck1lZGlhLAogICAgICAgICAgICAgICAgICAgICAgICAgICAgICBlbnVtZXJhdGVEZXZpY2VzOiBmdW5jdGlvbigpIHsKICAgICAgcmV0dXJuIG5ldyBQcm9taXNlKGZ1bmN0aW9uKHJlc29sdmUpIHsKICAgICAgICB2YXIga2luZHMgPSB7YXVkaW86ICdhdWRpb2lucHV0JywgdmlkZW86ICd2aWRlb2lucHV0J307CiAgICAgICAgcmV0dXJuIE1lZGlhU3RyZWFtVHJhY2suZ2V0U291cmNlcyhmdW5jdGlvbihkZXZpY2VzKSB7CiAgICAgICAgICByZXNvbHZlKGRldmljZXMubWFwKGZ1bmN0aW9uKGRldmljZSkgewogICAgICAgICAgICByZXR1cm4ge2xhYmVsOiBkZXZpY2UubGFiZWwsCiAgICAgICAgICAgICAgICAgICAga2luZDoga2luZHNbZGV2aWNlLmtpbmRdLAogICAgICAgICAgICAgICAgICAgIGRldmljZUlkOiBkZXZpY2UuaWQsCiAgICAgICAgICAgICAgICAgICAgZ3JvdXBJZDogJyd9OwogICAgICAgICAgfSkpOwogICAgICAgIH0pOwogICAgICB9KTsKICAgIH19OwogIH0KCiAgLy8gQSBzaGltIGZvciBnZXRVc2VyTWVkaWEgbWV0aG9kIG9uIHRoZSBtZWRpYURldmljZXMgb2JqZWN0LgogIC8vIFRPRE8oS2FwdGVuSmFuc3NvbikgcmVtb3ZlIG9uY2UgaW1wbGVtZW50ZWQgaW4gQ2hyb21lIHN0YWJsZS4KICBpZiAoIW5hdmlnYXRvci5tZWRpYURldmljZXMuZ2V0VXNlck1lZGlhKSB7CiAgICBuYXZpZ2F0b3IubWVkaWFEZXZpY2VzLmdldFVzZXJNZWRpYSA9IGZ1bmN0aW9uKGNvbnN0cmFpbnRzKSB7CiAgICAgIHJldHVybiByZXF1ZXN0VXNlck1lZGlhKGNvbnN0cmFpbnRzKTsKICAgIH07CiAgfSBlbHNlIHsKICAgIC8vIEV2ZW4gdGhvdWdoIENocm9tZSA0NSBoYXMgbmF2aWdhdG9yLm1lZGlhRGV2aWNlcyBhbmQgYSBnZXRVc2VyTWVkaWEKICAgIC8vIGZ1bmN0aW9uIHdoaWNoIHJldHVybnMgYSBQcm9taXNlLCBpdCBkb2VzIG5vdCBhY2NlcHQgc3BlYy1zdHlsZQogICAgLy8gY29uc3RyYWludHMuCiAgICB2YXIgb3JpZ0dldFVzZXJNZWRpYSA9IG5hdmlnYXRvci5tZWRpYURldmljZXMuZ2V0VXNlck1lZGlhLgogICAgICAgIGJpbmQobmF2aWdhdG9yLm1lZGlhRGV2aWNlcyk7CiAgICBuYXZpZ2F0b3IubWVkaWFEZXZpY2VzLmdldFVzZXJNZWRpYSA9IGZ1bmN0aW9uKGMpIHsKICAgICAgd2VicnRjVXRpbHMubG9nKCdzcGVjOiAgICcgKyBKU09OLnN0cmluZ2lmeShjKSk7IC8vIHdoaXRlc3BhY2UgZm9yIGFsaWdubWVudAogICAgICBjLmF1ZGlvID0gY29uc3RyYWludHNUb0Nocm9tZShjLmF1ZGlvKTsKICAgICAgYy52aWRlbyA9IGNvbnN0cmFpbnRzVG9DaHJvbWUoYy52aWRlbyk7CiAgICAgIHdlYnJ0Y1V0aWxzLmxvZygnY2hyb21lOiAnICsgSlNPTi5zdHJpbmdpZnkoYykpOwogICAgICByZXR1cm4gb3JpZ0dldFVzZXJNZWRpYShjKTsKICAgIH07CiAgfQoKICAvLyBEdW1teSBkZXZpY2VjaGFuZ2UgZXZlbnQgbWV0aG9kcy4KICAvLyBUT0RPKEthcHRlbkphbnNzb24pIHJlbW92ZSBvbmNlIGltcGxlbWVudGVkIGluIENocm9tZSBzdGFibGUuCiAgaWYgKHR5cGVvZiBuYXZpZ2F0b3IubWVkaWFEZXZpY2VzLmFkZEV2ZW50TGlzdGVuZXIgPT09ICd1bmRlZmluZWQnKSB7CiAgICBuYXZpZ2F0b3IubWVkaWFEZXZpY2VzLmFkZEV2ZW50TGlzdGVuZXIgPSBmdW5jdGlvbigpIHsKICAgICAgd2VicnRjVXRpbHMubG9nKCdEdW1teSBtZWRpYURldmljZXMuYWRkRXZlbnRMaXN0ZW5lciBjYWxsZWQuJyk7CiAgICB9OwogIH0KICBpZiAodHlwZW9mIG5hdmlnYXRvci5tZWRpYURldmljZXMucmVtb3ZlRXZlbnRMaXN0ZW5lciA9PT0gJ3VuZGVmaW5lZCcpIHsKICAgIG5hdmlnYXRvci5tZWRpYURldmljZXMucmVtb3ZlRXZlbnRMaXN0ZW5lciA9IGZ1bmN0aW9uKCkgewogICAgICB3ZWJydGNVdGlscy5sb2coJ0R1bW15IG1lZGlhRGV2aWNlcy5yZW1vdmVFdmVudExpc3RlbmVyIGNhbGxlZC4nKTsKICAgIH07CiAgfQoKICAvLyBBdHRhY2ggYSBtZWRpYSBzdHJlYW0gdG8gYW4gZWxlbWVudC4KICBhdHRhY2hNZWRpYVN0cmVhbSA9IGZ1bmN0aW9uKGVsZW1lbnQsIHN0cmVhbSkgewogICAgaWYgKHdlYnJ0Y0RldGVjdGVkVmVyc2lvbiA+PSA0MykgewogICAgICBlbGVtZW50LnNyY09iamVjdCA9IHN0cmVhbTsKICAgIH0gZWxzZSBpZiAodHlwZW9mIGVsZW1lbnQuc3JjICE9PSAndW5kZWZpbmVkJykgewogICAgICBlbGVtZW50LnNyYyA9IFVSTC5jcmVhdGVPYmplY3RVUkwoc3RyZWFtKTsKICAgIH0gZWxzZSB7CiAgICAgIHdlYnJ0Y1V0aWxzLmxvZygnRXJyb3IgYXR0YWNoaW5nIHN0cmVhbSB0byBlbGVtZW50LicpOwogICAgfQogIH07CiAgcmVhdHRhY2hNZWRpYVN0cmVhbSA9IGZ1bmN0aW9uKHRvLCBmcm9tKSB7CiAgICBpZiAod2VicnRjRGV0ZWN0ZWRWZXJzaW9uID49IDQzKSB7CiAgICAgIHRvLnNyY09iamVjdCA9IGZyb20uc3JjT2JqZWN0OwogICAgfSBlbHNlIHsKICAgICAgdG8uc3JjID0gZnJvbS5zcmM7CiAgICB9CiAgfTsKCn0gZWxzZSBpZiAobmF2aWdhdG9yLm1lZGlhRGV2aWNlcyAmJiBuYXZpZ2F0b3IudXNlckFnZW50Lm1hdGNoKAogICAgL0VkZ2VcLyhcZCspLihcZCspJC8pKSB7CiAgd2VicnRjVXRpbHMubG9nKCdUaGlzIGFwcGVhcnMgdG8gYmUgRWRnZScpOwogIHdlYnJ0Y0RldGVjdGVkQnJvd3NlciA9ICdlZGdlJzsKCiAgd2VicnRjRGV0ZWN0ZWRWZXJzaW9uID0gd2VicnRjVXRpbHMuZXh0cmFjdFZlcnNpb24obmF2aWdhdG9yLnVzZXJBZ2VudCwKICAgICAgL0VkZ2VcLyhcZCspLihcZCspJC8sIDIpOwoKICAvLyB0aGUgbWluaW11bSB2ZXJzaW9uIHN0aWxsIHN1cHBvcnRlZCBieSBhZGFwdGVyLgogIHdlYnJ0Y01pbmltdW1WZXJzaW9uID0gMTI7Cn0gZWxzZSB7CiAgd2VicnRjVXRpbHMubG9nKCdCcm93c2VyIGRvZXMgbm90IGFwcGVhciB0byBiZSBXZWJSVEMtY2FwYWJsZScpOwp9CgovLyBSZXR1cm5zIHRoZSByZXN1bHQgb2YgZ2V0VXNlck1lZGlhIGFzIGEgUHJvbWlzZS4KZnVuY3Rpb24gcmVxdWVzdFVzZXJNZWRpYShjb25zdHJhaW50cykgewogIHJldHVybiBuZXcgUHJvbWlzZShmdW5jdGlvbihyZXNvbHZlLCByZWplY3QpIHsKICAgIGdldFVzZXJNZWRpYShjb25zdHJhaW50cywgcmVzb2x2ZSwgcmVqZWN0KTsKICB9KTsKfQoKdmFyIHdlYnJ0Y1Rlc3RpbmcgPSB7fTsKdHJ5IHsKICBPYmplY3QuZGVmaW5lUHJvcGVydHkod2VicnRjVGVzdGluZywgJ3ZlcnNpb24nLCB7CiAgICBzZXQ6IGZ1bmN0aW9uKHZlcnNpb24pIHsKICAgICAgd2VicnRjRGV0ZWN0ZWRWZXJzaW9uID0gdmVyc2lvbjsKICAgIH0KICB9KTsKfSBjYXRjaCAoZSkge30KCmlmICh0eXBlb2YgbW9kdWxlICE9PSAndW5kZWZpbmVkJykgewogIHZhciBSVENQZWVyQ29ubmVjdGlvbjsKICBpZiAodHlwZW9mIHdpbmRvdyAhPT0gJ3VuZGVmaW5lZCcpIHsKICAgIFJUQ1BlZXJDb25uZWN0aW9uID0gd2luZG93LlJUQ1BlZXJDb25uZWN0aW9uOwogIH0KICBtb2R1bGUuZXhwb3J0cyA9IHsKICAgIFJUQ1BlZXJDb25uZWN0aW9uOiBSVENQZWVyQ29ubmVjdGlvbiwKICAgIGdldFVzZXJNZWRpYTogZ2V0VXNlck1lZGlhLAogICAgYXR0YWNoTWVkaWFTdHJlYW06IGF0dGFjaE1lZGlhU3RyZWFtLAogICAgcmVhdHRhY2hNZWRpYVN0cmVhbTogcmVhdHRhY2hNZWRpYVN0cmVhbSwKICAgIHdlYnJ0Y0RldGVjdGVkQnJvd3Nlcjogd2VicnRjRGV0ZWN0ZWRCcm93c2VyLAogICAgd2VicnRjRGV0ZWN0ZWRWZXJzaW9uOiB3ZWJydGNEZXRlY3RlZFZlcnNpb24sCiAgICB3ZWJydGNNaW5pbXVtVmVyc2lvbjogd2VicnRjTWluaW11bVZlcnNpb24sCiAgICB3ZWJydGNUZXN0aW5nOiB3ZWJydGNUZXN0aW5nLAogICAgd2VicnRjVXRpbHM6IHdlYnJ0Y1V0aWxzCiAgICAvL3JlcXVlc3RVc2VyTWVkaWE6IG5vdCBleHBvc2VkIG9uIHB1cnBvc2UuCiAgICAvL3RyYWNlOiBub3QgZXhwb3NlZCBvbiBwdXJwb3NlLgogIH07Cn0gZWxzZSBpZiAoKHR5cGVvZiByZXF1aXJlID09PSAnZnVuY3Rpb24nKSAmJiAodHlwZW9mIGRlZmluZSA9PT0gJ2Z1bmN0aW9uJykpIHsKICAvLyBFeHBvc2Ugb2JqZWN0cyBhbmQgZnVuY3Rpb25zIHdoZW4gUmVxdWlyZUpTIGlzIGRvaW5nIHRoZSBsb2FkaW5nLgogIGRlZmluZShbXSwgZnVuY3Rpb24oKSB7CiAgICByZXR1cm4gewogICAgICBSVENQZWVyQ29ubmVjdGlvbjogd2luZG93LlJUQ1BlZXJDb25uZWN0aW9uLAogICAgICBnZXRVc2VyTWVkaWE6IGdldFVzZXJNZWRpYSwKICAgICAgYXR0YWNoTWVkaWFTdHJlYW06IGF0dGFjaE1lZGlhU3RyZWFtLAogICAgICByZWF0dGFjaE1lZGlhU3RyZWFtOiByZWF0dGFjaE1lZGlhU3RyZWFtLAogICAgICB3ZWJydGNEZXRlY3RlZEJyb3dzZXI6IHdlYnJ0Y0RldGVjdGVkQnJvd3NlciwKICAgICAgd2VicnRjRGV0ZWN0ZWRWZXJzaW9uOiB3ZWJydGNEZXRlY3RlZFZlcnNpb24sCiAgICAgIHdlYnJ0Y01pbmltdW1WZXJzaW9uOiB3ZWJydGNNaW5pbXVtVmVyc2lvbiwKICAgICAgd2VicnRjVGVzdGluZzogd2VicnRjVGVzdGluZywKICAgICAgd2VicnRjVXRpbHM6IHdlYnJ0Y1V0aWxzCiAgICAgIC8vcmVxdWVzdFVzZXJNZWRpYTogbm90IGV4cG9zZWQgb24gcHVycG9zZS4KICAgICAgLy90cmFjZTogbm90IGV4cG9zZWQgb24gcHVycG9zZS4KICAgIH07CiAgfSk7Cn0KCn0se31dLDM6W2Z1bmN0aW9uKHJlcXVpcmUsbW9kdWxlLGV4cG9ydHMpewondXNlIHN0cmljdCc7CgpPYmplY3QuZGVmaW5lUHJvcGVydHkoZXhwb3J0cywgJ19fZXNNb2R1bGUnLCB7CiAgdmFsdWU6IHRydWUKfSk7Cgp2YXIgX2NyZWF0ZUNsYXNzID0gKGZ1bmN0aW9uICgpIHsgZnVuY3Rpb24gZGVmaW5lUHJvcGVydGllcyh0YXJnZXQsIHByb3BzKSB7IGZvciAodmFyIGkgPSAwOyBpIDwgcHJvcHMubGVuZ3RoOyBpKyspIHsgdmFyIGRlc2NyaXB0b3IgPSBwcm9wc1tpXTsgZGVzY3JpcHRvci5lbnVtZXJhYmxlID0gZGVzY3JpcHRvci5lbnVtZXJhYmxlIHx8IGZhbHNlOyBkZXNjcmlwdG9yLmNvbmZpZ3VyYWJsZSA9IHRydWU7IGlmICgndmFsdWUnIGluIGRlc2NyaXB0b3IpIGRlc2NyaXB0b3Iud3JpdGFibGUgPSB0cnVlOyBPYmplY3QuZGVmaW5lUHJvcGVydHkodGFyZ2V0LCBkZXNjcmlwdG9yLmtleSwgZGVzY3JpcHRvcik7IH0gfSByZXR1cm4gZnVuY3Rpb24gKENvbnN0cnVjdG9yLCBwcm90b1Byb3BzLCBzdGF0aWNQcm9wcykgeyBpZiAocHJvdG9Qcm9wcykgZGVmaW5lUHJvcGVydGllcyhDb25zdHJ1Y3Rvci5wcm90b3R5cGUsIHByb3RvUHJvcHMpOyBpZiAoc3RhdGljUHJvcHMpIGRlZmluZVByb3BlcnRpZXMoQ29uc3RydWN0b3IsIHN0YXRpY1Byb3BzKTsgcmV0dXJuIENvbnN0cnVjdG9yOyB9OyB9KSgpOwoKZXhwb3J0c1snZGVmYXVsdCddID0gYWN0aXZhdGU7CgpmdW5jdGlvbiBfaW50ZXJvcFJlcXVpcmVEZWZhdWx0KG9iaikgeyByZXR1cm4gb2JqICYmIG9iai5fX2VzTW9kdWxlID8gb2JqIDogeyAnZGVmYXVsdCc6IG9iaiB9OyB9CgpmdW5jdGlvbiBfY2xhc3NDYWxsQ2hlY2soaW5zdGFuY2UsIENvbnN0cnVjdG9yKSB7IGlmICghKGluc3RhbmNlIGluc3RhbmNlb2YgQ29uc3RydWN0b3IpKSB7IHRocm93IG5ldyBUeXBlRXJyb3IoJ0Nhbm5vdCBjYWxsIGEgY2xhc3MgYXMgYSBmdW5jdGlvbicpOyB9IH0KCnZhciBfc3JjU2VydmljZUZyYW1ld29yayA9IHJlcXVpcmUoJy4uL3NyYy9zZXJ2aWNlLWZyYW1ld29yaycpOwoKdmFyIF9zcmNIeXBlcnR5SHlwZXJ0eUNvbm5lY3RvciA9IHJlcXVpcmUoJy4uL3NyYy9oeXBlcnR5L0h5cGVydHlDb25uZWN0b3InKTsKCnZhciBfc3JjSHlwZXJ0eUh5cGVydHlDb25uZWN0b3IyID0gX2ludGVyb3BSZXF1aXJlRGVmYXVsdChfc3JjSHlwZXJ0eUh5cGVydHlDb25uZWN0b3IpOwoKdmFyIEhlbGxvSHlwZXJ0eSA9IChmdW5jdGlvbiAoKSB7CiAgZnVuY3Rpb24gSGVsbG9IeXBlcnR5KGh5cGVydHlVUkwsIGJ1cywgY29uZmlndXJhdGlvbikgewogICAgX2NsYXNzQ2FsbENoZWNrKHRoaXMsIEhlbGxvSHlwZXJ0eSk7CgogICAgY29uc29sZS5sb2coJ1dvcmxkIEh5cGVydHkgSW5zdGFuY2UnKTsKCiAgICB2YXIgX3RoaXMgPSB0aGlzOwogICAgX3RoaXMuYnVzID0gYnVzOwogICAgX3RoaXMuY29uZmlndXJhdGlvbiA9IGNvbmZpZ3VyYXRpb247CiAgICBfdGhpcy5oeXBlcnR5VVJMID0gaHlwZXJ0eVVSTDsKCiAgICB2YXIgc3luY2hlciA9IG5ldyBfc3JjU2VydmljZUZyYW1ld29yay5TeW5jaGVyKGh5cGVydHlVUkwsIGJ1cywgY29uZmlndXJhdGlvbik7CiAgICBfdGhpcy5zeW5jaGVyID0gc3luY2hlcjsKCiAgICBfdGhpcy5zeW5jaGVyLm9uTm90aWZpY2F0aW9uKGZ1bmN0aW9uIChldmVudCkgewogICAgICBjb25zb2xlLmxvZygnaHlwZXJ0eSBoZWxsbyBoYXZlIGFuIG5vdGlmaWNhdGlvbjogJywgZXZlbnQpOwogICAgICBfdGhpcy5oeXBlcnR5Q29ubmVjdG9yLl9vbk5vdGlmaWNhdGlvbihldmVudCwgaHlwZXJ0eVVSTCk7CiAgICB9KTsKCiAgICBfdGhpcy5oeXBlcnR5Q29ubmVjdG9yID0gbmV3IF9zcmNIeXBlcnR5SHlwZXJ0eUNvbm5lY3RvcjJbJ2RlZmF1bHQnXShzeW5jaGVyKTsKICAgIF90aGlzLmh5cGVydHlDb25uZWN0b3IubmFtZSA9ICdIZWxsbyBIeXBlcnR5JzsKICB9CgogIF9jcmVhdGVDbGFzcyhIZWxsb0h5cGVydHksIFt7CiAgICBrZXk6ICdjb25uZWN0JywKICAgIHZhbHVlOiBmdW5jdGlvbiBjb25uZWN0KGh5cGVydHlVUkwsIG9wdGlvbnMpIHsKICAgICAgdmFyIF90aGlzID0gdGhpczsKICAgICAgX3RoaXMudG8gPSBoeXBlcnR5VVJMOwoKICAgICAgcmV0dXJuIG5ldyBQcm9taXNlKGZ1bmN0aW9uIChyZXNvbHZlLCByZWplY3QpIHsKCiAgICAgICAgY29uc29sZS5pbmZvKCdDb25uZWN0aW5nIHRvOiAnLCBoeXBlcnR5VVJMKTsKICAgICAgICBfdGhpcy5oeXBlcnR5Q29ubmVjdG9yLmNvbm5lY3QoaHlwZXJ0eVVSTCwgb3B0aW9ucykudGhlbihmdW5jdGlvbiAoY29udHJvbGxlcikgewogICAgICAgICAgY29uc29sZS5pbmZvKCdDb25uZWN0ZWQgdG86ICcsIGh5cGVydHlVUkwsIGNvbnRyb2xsZXIpOwogICAgICAgICAgcmVzb2x2ZShjb250cm9sbGVyKTsKICAgICAgICB9KVsnY2F0Y2gnXShmdW5jdGlvbiAocmVhc29uKSB7CiAgICAgICAgICByZWplY3QocmVhc29uKTsKICAgICAgICB9KTsKICAgICAgfSk7CiAgICB9CiAgfSwgewogICAga2V5OiAnYWNjZXB0JywKICAgIHZhbHVlOiBmdW5jdGlvbiBhY2NlcHQoKSB7CiAgICAgIHZhciBfdGhpcyA9IHRoaXM7CgogICAgICByZXR1cm4gbmV3IFByb21pc2UoZnVuY3Rpb24gKHJlc29sdmUsIHJlamVjdCkgewoKICAgICAgICBjb25zb2xlLmluZm8oJ1N1YnNjcmliaW5nIG9iamVjdCcpOwogICAgICAgIF90aGlzLmh5cGVydHlDb25uZWN0b3IuYWNjZXB0KCkudGhlbihmdW5jdGlvbiAoY29udHJvbGxlcikgewogICAgICAgICAgY29uc29sZS5pbmZvKCdzdWJzY3JpYmVkIHRvOiAnLCBjb250cm9sbGVyKTsKICAgICAgICAgIHJlc29sdmUoY29udHJvbGxlcik7CiAgICAgICAgfSlbJ2NhdGNoJ10oZnVuY3Rpb24gKHJlYXNvbikgewogICAgICAgICAgY29uc29sZS5lcnJvcihyZWFzb24pOwogICAgICAgICAgcmVqZWN0KHJlYXNvbik7CiAgICAgICAgfSk7CiAgICAgIH0pOwogICAgfQogIH0sIHsKICAgIGtleTogJ2Rpc2Nvbm5lY3QnLAogICAgdmFsdWU6IGZ1bmN0aW9uIGRpc2Nvbm5lY3QoKSB7CgogICAgICB2YXIgX3RoaXMgPSB0aGlzOwoKICAgICAgcmV0dXJuIG5ldyBQcm9taXNlKGZ1bmN0aW9uIChyZXNvbHZlLCByZWplY3QpIHsKCiAgICAgICAgY29uc29sZS5pbmZvKCdkaXNjb25uZWN0aW5nIG9iamVjdCcpOwogICAgICAgIF90aGlzLmh5cGVydHlDb25uZWN0b3IuZGlzY29ubmVjdCgpLnRoZW4oZnVuY3Rpb24gKHJlc3VsdCkgewogICAgICAgICAgY29uc29sZS5pbmZvKCdkaXNjb25uZWN0ZWQnKTsKICAgICAgICAgIHJlc29sdmUocmVzdWx0KTsKICAgICAgICB9KVsnY2F0Y2gnXShmdW5jdGlvbiAocmVhc29uKSB7CiAgICAgICAgICBjb25zb2xlLmVycm9yKHJlYXNvbik7CiAgICAgICAgICByZWplY3QocmVhc29uKTsKICAgICAgICB9KTsKICAgICAgfSk7CiAgICB9CiAgfSwgewogICAga2V5OiAnc2VuZE1lc3NhZ2UnLAogICAgdmFsdWU6IGZ1bmN0aW9uIHNlbmRNZXNzYWdlKCkgewoKICAgICAgdmFyIF90aGlzID0gdGhpczsKCiAgICAgIF90aGlzLmJ1cy5wb3N0TWVzc2FnZSh7CiAgICAgICAgZnJvbTogX3RoaXMuaHlwZXJ0eVVSTCwKICAgICAgICB0bzogJ2h5cGVydHktcnVudGltZTovL3NwMS9Xb3JsZEh5cGVydHknLAogICAgICAgIGJvZHk6IHsKICAgICAgICAgIHZhbHVlOiAnSGVsbG8gZnJvbSB3b3JsZCBoeXBlcnR5IGluc3RhbmNlJwogICAgICAgIH0KICAgICAgfSk7CiAgICB9CiAgfV0pOwoKICByZXR1cm4gSGVsbG9IeXBlcnR5Owp9KSgpOwoKZnVuY3Rpb24gYWN0aXZhdGUoaHlwZXJ0eVVSTCwgYnVzLCBjb25maWd1cmF0aW9uKSB7CgogIHJldHVybiB7CiAgICBoeXBlcnR5TmFtZTogJ0hlbGxvSHlwZXJ0eScsCiAgICBoeXBlcnR5Q29kZTogbmV3IEhlbGxvSHlwZXJ0eShoeXBlcnR5VVJMLCBidXMsIGNvbmZpZ3VyYXRpb24pCiAgfTsKfQoKbW9kdWxlLmV4cG9ydHMgPSBleHBvcnRzWydkZWZhdWx0J107Cgp9LHsiLi4vc3JjL2h5cGVydHkvSHlwZXJ0eUNvbm5lY3RvciI6MTMsIi4uL3NyYy9zZXJ2aWNlLWZyYW1ld29yayI6MTh9XSw0OltmdW5jdGlvbihyZXF1aXJlLG1vZHVsZSxleHBvcnRzKXsKLyoqCiAqIENyZWF0ZWQgYnkgYW1vIG9uIDE0LzExLzIwMTUuCiAqLwondXNlIHN0cmljdCc7CgpPYmplY3QuZGVmaW5lUHJvcGVydHkoZXhwb3J0cywgJ19fZXNNb2R1bGUnLCB7CiAgICB2YWx1ZTogdHJ1ZQp9KTsKCnZhciBfY3JlYXRlQ2xhc3MgPSAoZnVuY3Rpb24gKCkgeyBmdW5jdGlvbiBkZWZpbmVQcm9wZXJ0aWVzKHRhcmdldCwgcHJvcHMpIHsgZm9yICh2YXIgaSA9IDA7IGkgPCBwcm9wcy5sZW5ndGg7IGkrKykgeyB2YXIgZGVzY3JpcHRvciA9IHByb3BzW2ldOyBkZXNjcmlwdG9yLmVudW1lcmFibGUgPSBkZXNjcmlwdG9yLmVudW1lcmFibGUgfHwgZmFsc2U7IGRlc2NyaXB0b3IuY29uZmlndXJhYmxlID0gdHJ1ZTsgaWYgKCd2YWx1ZScgaW4gZGVzY3JpcHRvcikgZGVzY3JpcHRvci53cml0YWJsZSA9IHRydWU7IE9iamVjdC5kZWZpbmVQcm9wZXJ0eSh0YXJnZXQsIGRlc2NyaXB0b3Iua2V5LCBkZXNjcmlwdG9yKTsgfSB9IHJldHVybiBmdW5jdGlvbiAoQ29uc3RydWN0b3IsIHByb3RvUHJvcHMsIHN0YXRpY1Byb3BzKSB7IGlmIChwcm90b1Byb3BzKSBkZWZpbmVQcm9wZXJ0aWVzKENvbnN0cnVjdG9yLnByb3RvdHlwZSwgcHJvdG9Qcm9wcyk7IGlmIChzdGF0aWNQcm9wcykgZGVmaW5lUHJvcGVydGllcyhDb25zdHJ1Y3Rvciwgc3RhdGljUHJvcHMpOyByZXR1cm4gQ29uc3RydWN0b3I7IH07IH0pKCk7CgpmdW5jdGlvbiBfY2xhc3NDYWxsQ2hlY2soaW5zdGFuY2UsIENvbnN0cnVjdG9yKSB7IGlmICghKGluc3RhbmNlIGluc3RhbmNlb2YgQ29uc3RydWN0b3IpKSB7IHRocm93IG5ldyBUeXBlRXJyb3IoJ0Nhbm5vdCBjYWxsIGEgY2xhc3MgYXMgYSBmdW5jdGlvbicpOyB9IH0KCnZhciBDYXRhbG9ndWVEYXRhT2JqZWN0ID0gKGZ1bmN0aW9uICgpIHsKICAgIC8qKgogICAgICogQ3JlYXRlcyB0aGUgQ2F0YWxvZ3VlIERhdGEgT2JqZWN0CiAgICAgKiBAcGFyYW0gZ3VpZCAtIEdsb2JhbCBVbmlxdWUgaWRlbnRpZmllciBvZiB0aGUgQ2F0YWxvZ3VlIE9iamVjdCAoZS5nLiBIeXBlcnR5IGRlc2NyaXB0b3IsIFByb3RvY29sU3R1YiBkZXNjcmlwdG9yLAogICAgICogZXRjKSBlbmFibGluZyB0aGUgc2FtZSBvYmplY3QgdG8gYmUgc3RvcmVkIGFuZCBkaXNjb3ZlcmVkIGluIGRpZmZlcmVudCBDYXRhbG9ndWVzLiBUaGF0IG1lYW5zLCBndWlkIGNvcnJlc3BvbmRzIHRvCiAgICAgKiA8cmVzb3VyY2UtdHlwZS1pZD4gcGVyIEJORiBvZiBSZXNvdXJjZSBQYXRoLiBDb3VsZG4ndCB3ZSBoYXZlIHByb2JsZW1zIHdpdGggdG9vIGxvbmcgVVJMIHBhdGhzPwogICAgICogQHBhcmFtIHR5cGUgLSBpbmRpY2F0ZXMgdGhlIHR5cGUgb2YgQ2F0YWxvZ3VlIERhdGEgT2JqZWN0IGUuZy4gSHlwZXJ0eSwgUHJvdG9jb2xTdHViLCBldGMKICAgICAqIEBwYXJhbSBvYmplY3ROYW1lIC0gaHVtYW4tdW5kZXJzdGFuZGFibGUgbmFtZSBvZiB0aGUgY2F0YWxvZ3VlIG9iamVjdCBlLmcuICJNeSBBd2Vzb21lIEh5cGVydHkiCiAgICAgKiBAcGFyYW0gZGVzY3JpcHRpb24gLSBkZXNjcmlwdGlvbiBvZiB0aGUgc291cmNlIHBhY2thZ2UKICAgICAqIEBwYXJhbSBsYW5ndWFnZSAtIHRoZSBwcm9ncmFtbWluZyBsYW5ndWFnZSB1c2VkIGluIHRoZSBTb3VyY2VQYWNrYWdlLlNvdXJjZUNvZGUKICAgICAqIEBwYXJhbSBzb3VyY2VQYWNrYWdlVVJMIC0gQSBzdHJpbmcgY29udGFpbmluZyB0aGUgVVJMIGZyb20gd2hlcmUgdGhlIHNvdXJjZSBjb2RlIHBhY2thZ2Ugb2YgdGhlIGNvcnJlc3BvbmRpbmcKICAgICAqIGNhdGFsb2d1ZSBvYmplY3QsIGUuZy4gZGVwbG95YWJsZSBwYWNrYWdlcyBjb250YWluaW5nIGV4ZWN1dGFibGUgY29kZSBmb3IgSHlwZXJ0aWVzIG9yIFByb3RvU3R1YnMsIGNhbiBiZSBkb3dubG9hZGVkCiAgICAgKi8KCiAgICBmdW5jdGlvbiBDYXRhbG9ndWVEYXRhT2JqZWN0KGd1aWQsIHR5cGUsIG9iamVjdE5hbWUsIGRlc2NyaXB0aW9uLCBsYW5ndWFnZSwgc291cmNlUGFja2FnZVVSTCkgewogICAgICAgIF9jbGFzc0NhbGxDaGVjayh0aGlzLCBDYXRhbG9ndWVEYXRhT2JqZWN0KTsKCiAgICAgICAgdGhpcy5fZ3VpZCA9IGd1aWQ7CiAgICAgICAgdGhpcy5fdHlwZSA9IHR5cGU7CiAgICAgICAgdGhpcy5fb2JqZWN0TmFtZSA9IG9iamVjdE5hbWU7CiAgICAgICAgdGhpcy5fZGVzY3JpcHRpb24gPSBkZXNjcmlwdGlvbjsKICAgICAgICB0aGlzLl9sYW5ndWFnZSA9IGxhbmd1YWdlOwogICAgICAgIHRoaXMuX3NvdXJjZVBhY2thZ2VVUkwgPSBzb3VyY2VQYWNrYWdlVVJMOwoKICAgICAgICB0aGlzLl9zaWduYXR1cmUgPSBudWxsOwogICAgICAgIHRoaXMuX3NvdXJjZVBhY2thZ2UgPSBudWxsOwogICAgfQoKICAgIC8vIEdldHRlcnMKCiAgICBfY3JlYXRlQ2xhc3MoQ2F0YWxvZ3VlRGF0YU9iamVjdCwgW3sKICAgICAgICBrZXk6ICdndWlkJywKICAgICAgICBnZXQ6IGZ1bmN0aW9uIGdldCgpIHsKICAgICAgICAgICAgcmV0dXJuIHRoaXMuX2d1aWQ7CiAgICAgICAgfQogICAgfSwgewogICAgICAgIGtleTogJ3R5cGUnLAogICAgICAgIGdldDogZnVuY3Rpb24gZ2V0KCkgewogICAgICAgICAgICByZXR1cm4gdGhpcy5fdHlwZTsKICAgICAgICB9CiAgICB9LCB7CiAgICAgICAga2V5OiAnb2JqZWN0TmFtZScsCiAgICAgICAgZ2V0OiBmdW5jdGlvbiBnZXQoKSB7CiAgICAgICAgICAgIHJldHVybiB0aGlzLl9vYmplY3ROYW1lOwogICAgICAgIH0KICAgIH0sIHsKICAgICAgICBrZXk6ICdkZXNjcmlwdGlvbicsCiAgICAgICAgZ2V0OiBmdW5jdGlvbiBnZXQoKSB7CiAgICAgICAgICAgIHJldHVybiB0aGlzLl9kZXNjcmlwdGlvbjsKICAgICAgICB9CiAgICB9LCB7CiAgICAgICAga2V5OiAnbGFuZ3VhZ2UnLAogICAgICAgIGdldDogZnVuY3Rpb24gZ2V0KCkgewogICAgICAgICAgICByZXR1cm4gdGhpcy5fbGFuZ3VhZ2U7CiAgICAgICAgfQogICAgfSwgewogICAgICAgIGtleTogJ3NpZ25hdHVyZScsCiAgICAgICAgZ2V0OiBmdW5jdGlvbiBnZXQoKSB7CiAgICAgICAgICAgIHJldHVybiB0aGlzLl9zaWduYXR1cmU7CiAgICAgICAgfSwKCiAgICAgICAgLy8gU2V0dGVycwogICAgICAgIC8qKgogICAgICAgICAqIFNldCB0aGUgc2lnbmF0dXJlIHRvIGVuYWJsZXMgaW50ZWdyaXR5IGFuZCBhdXRoZW50aWNpdHkgdmVyaWZpY2F0aW9uCiAgICAgICAgICogQHBhcmFtIHNpZ25hdHVyZQogICAgICAgICAqLwogICAgICAgIHNldDogZnVuY3Rpb24gc2V0KHNpZ25hdHVyZSkgewogICAgICAgICAgICBpZiAoc2lnbmF0dXJlKSB0aGlzLl9zaWduYXR1cmUgPSBzaWduYXR1cmU7CiAgICAgICAgfQogICAgfSwgewogICAgICAgIGtleTogJ3NvdXJjZVBhY2thZ2UnLAogICAgICAgIGdldDogZnVuY3Rpb24gZ2V0KCkgewogICAgICAgICAgICByZXR1cm4gdGhpcy5fc291cmNlUGFja2FnZTsKICAgICAgICB9LAogICAgICAgIHNldDogZnVuY3Rpb24gc2V0KHNyY1BhY2thZ2UpIHsKICAgICAgICAgICAgaWYgKHNyY1BhY2thZ2UpIHRoaXMuX3NvdXJjZVBhY2thZ2UgPSBzcmNQYWNrYWdlOwogICAgICAgIH0KICAgIH0sIHsKICAgICAgICBrZXk6ICdzb3VyY2VQYWNrYWdlVVJMJywKICAgICAgICBnZXQ6IGZ1bmN0aW9uIGdldCgpIHsKICAgICAgICAgICAgcmV0dXJuIHRoaXMuX3NvdXJjZVBhY2thZ2VVUkw7CiAgICAgICAgfQogICAgfV0pOwoKICAgIHJldHVybiBDYXRhbG9ndWVEYXRhT2JqZWN0Owp9KSgpOwoKdmFyIENhdGFsb2d1ZU9iamVjdFR5cGUgPSB7CiAgICBIWVBFUlRZOiAnaHlwZXJ0eScsIFBST1RPU1RVQjogJ3Byb3Rvc3R1YicsIEhZUEVSVFlfUlVOVElNRTogJ2h5cGVydHlfcnVudGltZScsCiAgICBIWVBFUlRZX0lOVEVSQ0VQVE9SOiAnaHlwZXJ0eV9pbnNwZWN0b3InLCBIWVBFUlRZX0RBVEFfT0JKRUNUOiAnaHlwZXJ0eV9kYXRhX29iamVjdCcsCiAgICBQT0xJQ1lfRU5GT1JDRVI6ICdwb2xpY3lfZW5mb3JjZXInCn07CmV4cG9ydHMuQ2F0YWxvZ3VlT2JqZWN0VHlwZSA9IENhdGFsb2d1ZU9iamVjdFR5cGU7CnZhciBEYXRhT2JqZWN0U291cmNlTGFuZ3VhZ2UgPSB7CiAgICBKQVZBU0NSSVBUX0VDTUE2OiAnamF2YXNjcmlwdF9lY21hNicsIEpBVkFTQ1JJUFRfRUNNQTU6ICdqYXZhc2NyaXB0X2VjbWE1JywKICAgIEpTT05fU0NIRU1BX1Y0OiAnanNvbl9zY2hlbWFfdjQnLCBQWVRIT046ICdweXRob24nLCBUWVBFU0NSSVBUOiAndHlwZXNjcmlwdCcKfTsKZXhwb3J0cy5EYXRhT2JqZWN0U291cmNlTGFuZ3VhZ2UgPSBEYXRhT2JqZWN0U291cmNlTGFuZ3VhZ2U7CmV4cG9ydHNbJ2RlZmF1bHQnXSA9IENhdGFsb2d1ZURhdGFPYmplY3Q7Cgp9LHt9XSw1OltmdW5jdGlvbihyZXF1aXJlLG1vZHVsZSxleHBvcnRzKXsKJ3VzZSBzdHJpY3QnOwoKT2JqZWN0LmRlZmluZVByb3BlcnR5KGV4cG9ydHMsICdfX2VzTW9kdWxlJywgewogICAgdmFsdWU6IHRydWUKfSk7Cgp2YXIgX2NyZWF0ZUNsYXNzID0gKGZ1bmN0aW9uICgpIHsgZnVuY3Rpb24gZGVmaW5lUHJvcGVydGllcyh0YXJnZXQsIHByb3BzKSB7IGZvciAodmFyIGkgPSAwOyBpIDwgcHJvcHMubGVuZ3RoOyBpKyspIHsgdmFyIGRlc2NyaXB0b3IgPSBwcm9wc1tpXTsgZGVzY3JpcHRvci5lbnVtZXJhYmxlID0gZGVzY3JpcHRvci5lbnVtZXJhYmxlIHx8IGZhbHNlOyBkZXNjcmlwdG9yLmNvbmZpZ3VyYWJsZSA9IHRydWU7IGlmICgndmFsdWUnIGluIGRlc2NyaXB0b3IpIGRlc2NyaXB0b3Iud3JpdGFibGUgPSB0cnVlOyBPYmplY3QuZGVmaW5lUHJvcGVydHkodGFyZ2V0LCBkZXNjcmlwdG9yLmtleSwgZGVzY3JpcHRvcik7IH0gfSByZXR1cm4gZnVuY3Rpb24gKENvbnN0cnVjdG9yLCBwcm90b1Byb3BzLCBzdGF0aWNQcm9wcykgeyBpZiAocHJvdG9Qcm9wcykgZGVmaW5lUHJvcGVydGllcyhDb25zdHJ1Y3Rvci5wcm90b3R5cGUsIHByb3RvUHJvcHMpOyBpZiAoc3RhdGljUHJvcHMpIGRlZmluZVByb3BlcnRpZXMoQ29uc3RydWN0b3IsIHN0YXRpY1Byb3BzKTsgcmV0dXJuIENvbnN0cnVjdG9yOyB9OyB9KSgpOwoKdmFyIF9nZXQgPSBmdW5jdGlvbiBnZXQoX3gsIF94MiwgX3gzKSB7IHZhciBfYWdhaW4gPSB0cnVlOyBfZnVuY3Rpb246IHdoaWxlIChfYWdhaW4pIHsgdmFyIG9iamVjdCA9IF94LCBwcm9wZXJ0eSA9IF94MiwgcmVjZWl2ZXIgPSBfeDM7IF9hZ2FpbiA9IGZhbHNlOyBpZiAob2JqZWN0ID09PSBudWxsKSBvYmplY3QgPSBGdW5jdGlvbi5wcm90b3R5cGU7IHZhciBkZXNjID0gT2JqZWN0LmdldE93blByb3BlcnR5RGVzY3JpcHRvcihvYmplY3QsIHByb3BlcnR5KTsgaWYgKGRlc2MgPT09IHVuZGVmaW5lZCkgeyB2YXIgcGFyZW50ID0gT2JqZWN0LmdldFByb3RvdHlwZU9mKG9iamVjdCk7IGlmIChwYXJlbnQgPT09IG51bGwpIHsgcmV0dXJuIHVuZGVmaW5lZDsgfSBlbHNlIHsgX3ggPSBwYXJlbnQ7IF94MiA9IHByb3BlcnR5OyBfeDMgPSByZWNlaXZlcjsgX2FnYWluID0gdHJ1ZTsgZGVzYyA9IHBhcmVudCA9IHVuZGVmaW5lZDsgY29udGludWUgX2Z1bmN0aW9uOyB9IH0gZWxzZSBpZiAoJ3ZhbHVlJyBpbiBkZXNjKSB7IHJldHVybiBkZXNjLnZhbHVlOyB9IGVsc2UgeyB2YXIgZ2V0dGVyID0gZGVzYy5nZXQ7IGlmIChnZXR0ZXIgPT09IHVuZGVmaW5lZCkgeyByZXR1cm4gdW5kZWZpbmVkOyB9IHJldHVybiBnZXR0ZXIuY2FsbChyZWNlaXZlcik7IH0gfSB9OwoKZnVuY3Rpb24gX2ludGVyb3BSZXF1aXJlRGVmYXVsdChvYmopIHsgcmV0dXJuIG9iaiAmJiBvYmouX19lc01vZHVsZSA/IG9iaiA6IHsgJ2RlZmF1bHQnOiBvYmogfTsgfQoKZnVuY3Rpb24gX2NsYXNzQ2FsbENoZWNrKGluc3RhbmNlLCBDb25zdHJ1Y3RvcikgeyBpZiAoIShpbnN0YW5jZSBpbnN0YW5jZW9mIENvbnN0cnVjdG9yKSkgeyB0aHJvdyBuZXcgVHlwZUVycm9yKCdDYW5ub3QgY2FsbCBhIGNsYXNzIGFzIGEgZnVuY3Rpb24nKTsgfSB9CgpmdW5jdGlvbiBfaW5oZXJpdHMoc3ViQ2xhc3MsIHN1cGVyQ2xhc3MpIHsgaWYgKHR5cGVvZiBzdXBlckNsYXNzICE9PSAnZnVuY3Rpb24nICYmIHN1cGVyQ2xhc3MgIT09IG51bGwpIHsgdGhyb3cgbmV3IFR5cGVFcnJvcignU3VwZXIgZXhwcmVzc2lvbiBtdXN0IGVpdGhlciBiZSBudWxsIG9yIGEgZnVuY3Rpb24sIG5vdCAnICsgdHlwZW9mIHN1cGVyQ2xhc3MpOyB9IHN1YkNsYXNzLnByb3RvdHlwZSA9IE9iamVjdC5jcmVhdGUoc3VwZXJDbGFzcyAmJiBzdXBlckNsYXNzLnByb3RvdHlwZSwgeyBjb25zdHJ1Y3RvcjogeyB2YWx1ZTogc3ViQ2xhc3MsIGVudW1lcmFibGU6IGZhbHNlLCB3cml0YWJsZTogdHJ1ZSwgY29uZmlndXJhYmxlOiB0cnVlIH0gfSk7IGlmIChzdXBlckNsYXNzKSBPYmplY3Quc2V0UHJvdG90eXBlT2YgPyBPYmplY3Quc2V0UHJvdG90eXBlT2Yoc3ViQ2xhc3MsIHN1cGVyQ2xhc3MpIDogc3ViQ2xhc3MuX19wcm90b19fID0gc3VwZXJDbGFzczsgfQoKdmFyIF9yZVRISU5LT2JqZWN0UmV0aGlua09iamVjdCA9IHJlcXVpcmUoJy4uL3JlVEhJTktPYmplY3QvUmV0aGlua09iamVjdCcpOwoKdmFyIF9yZVRISU5LT2JqZWN0UmV0aGlua09iamVjdDIgPSBfaW50ZXJvcFJlcXVpcmVEZWZhdWx0KF9yZVRISU5LT2JqZWN0UmV0aGlua09iamVjdCk7Cgp2YXIgX0NhdGFsb2d1ZURhdGFPYmplY3QgPSByZXF1aXJlKCcuL0NhdGFsb2d1ZURhdGFPYmplY3QnKTsKCnZhciBfQ2F0YWxvZ3VlRGF0YU9iamVjdDIgPSBfaW50ZXJvcFJlcXVpcmVEZWZhdWx0KF9DYXRhbG9ndWVEYXRhT2JqZWN0KTsKCnZhciBfU291cmNlUGFja2FnZSA9IHJlcXVpcmUoJy4vU291cmNlUGFja2FnZScpOwoKdmFyIF9Tb3VyY2VQYWNrYWdlMiA9IF9pbnRlcm9wUmVxdWlyZURlZmF1bHQoX1NvdXJjZVBhY2thZ2UpOwoKdmFyIF9IeXBlcnR5RGVzY3JpcHRvciA9IHJlcXVpcmUoJy4vSHlwZXJ0eURlc2NyaXB0b3InKTsKCnZhciBfSHlwZXJ0eURlc2NyaXB0b3IyID0gX2ludGVyb3BSZXF1aXJlRGVmYXVsdChfSHlwZXJ0eURlc2NyaXB0b3IpOwoKdmFyIF9Qcm90b2NvbFN0dWJEZXNjcmlwdG9yID0gcmVxdWlyZSgnLi9Qcm90b2NvbFN0dWJEZXNjcmlwdG9yJyk7Cgp2YXIgX1Byb3RvY29sU3R1YkRlc2NyaXB0b3IyID0gX2ludGVyb3BSZXF1aXJlRGVmYXVsdChfUHJvdG9jb2xTdHViRGVzY3JpcHRvcik7Cgp2YXIgX0h5cGVydHlSdW50aW1lRGVzY3JpcHRvciA9IHJlcXVpcmUoJy4vSHlwZXJ0eVJ1bnRpbWVEZXNjcmlwdG9yJyk7Cgp2YXIgX0h5cGVydHlSdW50aW1lRGVzY3JpcHRvcjIgPSBfaW50ZXJvcFJlcXVpcmVEZWZhdWx0KF9IeXBlcnR5UnVudGltZURlc2NyaXB0b3IpOwoKdmFyIF9Qb2xpY3lFbmZvcmNlckRlc2NyaXB0b3IgPSByZXF1aXJlKCcuL1BvbGljeUVuZm9yY2VyRGVzY3JpcHRvcicpOwoKdmFyIF9Qb2xpY3lFbmZvcmNlckRlc2NyaXB0b3IyID0gX2ludGVyb3BSZXF1aXJlRGVmYXVsdChfUG9saWN5RW5mb3JjZXJEZXNjcmlwdG9yKTsKCnZhciBfRGF0YU9iamVjdFNjaGVtYSA9IHJlcXVpcmUoJy4vRGF0YU9iamVjdFNjaGVtYScpOwoKdmFyIF9EYXRhT2JqZWN0U2NoZW1hMiA9IF9pbnRlcm9wUmVxdWlyZURlZmF1bHQoX0RhdGFPYmplY3RTY2hlbWEpOwoKdmFyIENhdGFsb2d1ZURhdGFPYmplY3RGYWN0b3J5ID0gKGZ1bmN0aW9uIChfUmV0aGlua09iamVjdCkgewogICAgX2luaGVyaXRzKENhdGFsb2d1ZURhdGFPYmplY3RGYWN0b3J5LCBfUmV0aGlua09iamVjdCk7CgogICAgLyoqCiAgICAgKiBDb25zdHJ1Y3RvcgogICAgICogQHBhcmFtIHtib29sZWFufSB2YWxpZGF0aW9uCiAgICAgKiBAcGFyYW0ge1VSTC5VUkwgfSBzY2hlbWEgLSBsaW5rIHRvIHRoZSBzY2hlbWEKICAgICAqLwoKICAgIGZ1bmN0aW9uIENhdGFsb2d1ZURhdGFPYmplY3RGYWN0b3J5KHZhbGlkYXRpb24sIHNjaGVtYSkgewogICAgICAgIF9jbGFzc0NhbGxDaGVjayh0aGlzLCBDYXRhbG9ndWVEYXRhT2JqZWN0RmFjdG9yeSk7CgogICAgICAgIF9nZXQoT2JqZWN0LmdldFByb3RvdHlwZU9mKENhdGFsb2d1ZURhdGFPYmplY3RGYWN0b3J5LnByb3RvdHlwZSksICdjb25zdHJ1Y3RvcicsIHRoaXMpLmNhbGwodGhpcywgdmFsaWRhdGlvbiwgc2NoZW1hKTsKICAgIH0KCiAgICBfY3JlYXRlQ2xhc3MoQ2F0YWxvZ3VlRGF0YU9iamVjdEZhY3RvcnksIFt7CiAgICAgICAga2V5OiAnY3JlYXRlQ2F0YWxvZ3VlRGF0YU9iamVjdCcsCiAgICAgICAgdmFsdWU6IGZ1bmN0aW9uIGNyZWF0ZUNhdGFsb2d1ZURhdGFPYmplY3QodHlwZSwgb2JqZWN0TmFtZSwgZGVzY3JpcHRpb24sIGxhbmd1YWdlLCBzb3VyY2VQYWNrYWdlVVJMKSB7CiAgICAgICAgICAgIGlmICh0eXBlb2YgdHlwZSA9PT0gInVuZGVmaW5lZCIgfHwgdHlwZW9mIG9iamVjdE5hbWUgPT09ICJ1bmRlZmluZWQiIHx8IHR5cGVvZiBkZXNjcmlwdGlvbiA9PT0gInVuZGVmaW5lZCIgfHwgdHlwZW9mIGxhbmd1YWdlID09PSAidW5kZWZpbmVkIiB8fCB0eXBlb2Ygc291cmNlUGFja2FnZVVSTCA9PT0gInVuZGVmaW5lZCIpIHRocm93IG5ldyBFcnJvcigiSW52YWxpZCBwYXJhbWV0ZXJzISIpOwogICAgICAgICAgICByZXR1cm4gbmV3IF9DYXRhbG9ndWVEYXRhT2JqZWN0MlsnZGVmYXVsdCddKHRoaXMuX2dlbmVyYXRlR3VpZCgpLCB0eXBlLCBvYmplY3ROYW1lLCBkZXNjcmlwdGlvbiwgbGFuZ3VhZ2UsIHNvdXJjZVBhY2thZ2VVUkwpOwogICAgICAgIH0KICAgIH0sIHsKICAgICAgICBrZXk6ICdjcmVhdGVIeXBlcnR5RGVzY3JpcHRvck9iamVjdCcsCiAgICAgICAgdmFsdWU6IGZ1bmN0aW9uIGNyZWF0ZUh5cGVydHlEZXNjcmlwdG9yT2JqZWN0KG9iamVjdE5hbWUsIGRlc2NyaXB0aW9uLCBsYW5ndWFnZSwgc291cmNlUGFja2FnZVVSTCwgaHlwZXJ0eVR5cGUsIGRhdGFPYmplY3RzKSB7CiAgICAgICAgICAgIGlmICh0eXBlb2Ygb2JqZWN0TmFtZSA9PT0gInVuZGVmaW5lZCIgfHwgdHlwZW9mIGRlc2NyaXB0aW9uID09PSAidW5kZWZpbmVkIiB8fCB0eXBlb2YgbGFuZ3VhZ2UgPT09ICJ1bmRlZmluZWQiIHx8IHR5cGVvZiBzb3VyY2VQYWNrYWdlVVJMID09PSAidW5kZWZpbmVkIiB8fCB0eXBlb2YgaHlwZXJ0eVR5cGUgPT09ICJ1bmRlZmluZWQiIHx8IHR5cGVvZiBkYXRhT2JqZWN0cyA9PT0gInVuZGVmaW5lZCIpIHRocm93IG5ldyBFcnJvcigiSW52YWxpZCBwYXJhbWV0ZXJzISIpOwogICAgICAgICAgICByZXR1cm4gbmV3IF9IeXBlcnR5RGVzY3JpcHRvcjJbJ2RlZmF1bHQnXSh0aGlzLl9nZW5lcmF0ZUd1aWQoKSwgX0NhdGFsb2d1ZURhdGFPYmplY3QuQ2F0YWxvZ3VlT2JqZWN0VHlwZS5IWVBFUlRZLCBvYmplY3ROYW1lLCBkZXNjcmlwdGlvbiwgbGFuZ3VhZ2UsIHNvdXJjZVBhY2thZ2VVUkwsIGh5cGVydHlUeXBlLCBkYXRhT2JqZWN0cyk7CiAgICAgICAgfQogICAgfSwgewogICAgICAgIGtleTogJ2NyZWF0ZVByb3RvU3R1YkRlc2NyaXB0b3JPYmplY3QnLAogICAgICAgIHZhbHVlOiBmdW5jdGlvbiBjcmVhdGVQcm90b1N0dWJEZXNjcmlwdG9yT2JqZWN0KG9iamVjdE5hbWUsIGRlc2NyaXB0aW9uLCBsYW5ndWFnZSwgc291cmNlUGFja2FnZVVSTCwgbWVzc2FnZVNjaGVtYXMsIGNvbmZpZ3VyYXRpb25MaXN0LCBjb25zdHJhaW50TGlzdCkgewogICAgICAgICAgICBpZiAodHlwZW9mIG9iamVjdE5hbWUgPT09ICJ1bmRlZmluZWQiIHx8IHR5cGVvZiBkZXNjcmlwdGlvbiA9PT0gInVuZGVmaW5lZCIgfHwgdHlwZW9mIGxhbmd1YWdlID09PSAidW5kZWZpbmVkIiB8fCB0eXBlb2Ygc291cmNlUGFja2FnZVVSTCA9PT0gInVuZGVmaW5lZCIgfHwgdHlwZW9mIG1lc3NhZ2VTY2hlbWFzID09PSAidW5kZWZpbmVkIiB8fCB0eXBlb2YgY29uZmlndXJhdGlvbkxpc3QgPT09ICJ1bmRlZmluZWQiIHx8IHR5cGVvZiBjb25zdHJhaW50TGlzdCA9PT0gInVuZGVmaW5lZCIpIHRocm93IG5ldyBFcnJvcigiSW52YWxpZCBwYXJhbWV0ZXJzISIpOwogICAgICAgICAgICByZXR1cm4gbmV3IF9Qcm90b2NvbFN0dWJEZXNjcmlwdG9yMlsnZGVmYXVsdCddKHRoaXMuX2dlbmVyYXRlR3VpZCgpLCBfQ2F0YWxvZ3VlRGF0YU9iamVjdC5DYXRhbG9ndWVPYmplY3RUeXBlLlBST1RPU1RVQiwgb2JqZWN0TmFtZSwgZGVzY3JpcHRpb24sIGxhbmd1YWdlLCBzb3VyY2VQYWNrYWdlVVJMLCBtZXNzYWdlU2NoZW1hcywgY29uZmlndXJhdGlvbkxpc3QsIGNvbnN0cmFpbnRMaXN0KTsKICAgICAgICB9CiAgICB9LCB7CiAgICAgICAga2V5OiAnY3JlYXRlSHlwZXJ0eVJ1bnRpbWVEZXNjcmlwdG9yT2JqZWN0JywKICAgICAgICB2YWx1ZTogZnVuY3Rpb24gY3JlYXRlSHlwZXJ0eVJ1bnRpbWVEZXNjcmlwdG9yT2JqZWN0KG9iamVjdE5hbWUsIGRlc2NyaXB0aW9uLCBsYW5ndWFnZSwgc291cmNlUGFja2FnZVVSTCwgcnVudGltZVR5cGUsIGh5cGVydHlDYXBhYmlsaXRpZXMsIHByb3RvY29sQ2FwYWJpbGl0aWVzKSB7CiAgICAgICAgICAgIGlmICh0eXBlb2Ygb2JqZWN0TmFtZSA9PT0gInVuZGVmaW5lZCIgfHwgdHlwZW9mIGRlc2NyaXB0aW9uID09PSAidW5kZWZpbmVkIiB8fCB0eXBlb2YgbGFuZ3VhZ2UgPT09ICJ1bmRlZmluZWQiIHx8IHR5cGVvZiBzb3VyY2VQYWNrYWdlVVJMID09PSAidW5kZWZpbmVkIiB8fCB0eXBlb2YgcnVudGltZVR5cGUgPT09ICJ1bmRlZmluZWQiIHx8IHR5cGVvZiBoeXBlcnR5Q2FwYWJpbGl0aWVzID09PSAidW5kZWZpbmVkIiB8fCB0eXBlb2YgcHJvdG9jb2xDYXBhYmlsaXRpZXMgPT09ICJ1bmRlZmluZWQiKSB0aHJvdyBuZXcgRXJyb3IoIkludmFsaWQgcGFyYW1ldGVycyEiKTsKCiAgICAgICAgICAgIHJldHVybiBuZXcgX0h5cGVydHlSdW50aW1lRGVzY3JpcHRvcjJbJ2RlZmF1bHQnXSh0aGlzLl9nZW5lcmF0ZUd1aWQoKSwgX0NhdGFsb2d1ZURhdGFPYmplY3QuQ2F0YWxvZ3VlT2JqZWN0VHlwZS5IWVBFUlRZX1JVTlRJTUUsIG9iamVjdE5hbWUsIGRlc2NyaXB0aW9uLCBsYW5ndWFnZSwgc291cmNlUGFja2FnZVVSTCwgcnVudGltZVR5cGUsIGh5cGVydHlDYXBhYmlsaXRpZXMsIHByb3RvY29sQ2FwYWJpbGl0aWVzKTsKICAgICAgICB9CiAgICB9LCB7CiAgICAgICAga2V5OiAnY3JlYXRlUG9saWN5RW5mb3JjZXJEZXNjcmlwdG9yT2JqZWN0JywKICAgICAgICB2YWx1ZTogZnVuY3Rpb24gY3JlYXRlUG9saWN5RW5mb3JjZXJEZXNjcmlwdG9yT2JqZWN0KG9iamVjdE5hbWUsIGRlc2NyaXB0aW9uLCBsYW5ndWFnZSwgc291cmNlUGFja2FnZVVSTCwgY29uZmlndXJhdGlvbiwgcG9saWNpZXMpIHsKICAgICAgICAgICAgaWYgKHR5cGVvZiBvYmplY3ROYW1lID09PSAidW5kZWZpbmVkIiB8fCB0eXBlb2YgZGVzY3JpcHRpb24gPT09ICJ1bmRlZmluZWQiIHx8IHR5cGVvZiBsYW5ndWFnZSA9PT0gInVuZGVmaW5lZCIgfHwgdHlwZW9mIHNvdXJjZVBhY2thZ2VVUkwgPT09ICJ1bmRlZmluZWQiIHx8IHR5cGVvZiBjb25maWd1cmF0aW9uID09PSAidW5kZWZpbmVkIiB8fCB0eXBlb2YgcG9saWNpZXMgPT09ICJ1bmRlZmluZWQiKSB0aHJvdyBuZXcgRXJyb3IoIkludmFsaWQgcGFyYW1ldGVycyEiKTsKCiAgICAgICAgICAgIHJldHVybiBuZXcgX1BvbGljeUVuZm9yY2VyRGVzY3JpcHRvcjJbJ2RlZmF1bHQnXSh0aGlzLl9nZW5lcmF0ZUd1aWQoKSwgX0NhdGFsb2d1ZURhdGFPYmplY3QuQ2F0YWxvZ3VlT2JqZWN0VHlwZS5QT0xJQ1lfRU5GT1JDRVIsIG9iamVjdE5hbWUsIGRlc2NyaXB0aW9uLCBsYW5ndWFnZSwgc291cmNlUGFja2FnZVVSTCwgY29uZmlndXJhdGlvbiwgcG9saWNpZXMpOwogICAgICAgIH0KICAgIH0sIHsKICAgICAgICBrZXk6ICdjcmVhdGVEYXRhT2JqZWN0U2NoZW1hJywKICAgICAgICB2YWx1ZTogZnVuY3Rpb24gY3JlYXRlRGF0YU9iamVjdFNjaGVtYSh0eXBlLCBvYmplY3ROYW1lLCBkZXNjcmlwdGlvbiwgbGFuZ3VhZ2UsIHNvdXJjZVBhY2thZ2VVUkwpIHsKICAgICAgICAgICAgaWYgKHR5cGVvZiB0eXBlID09PSAidW5kZWZpbmVkIiB8fCB0eXBlb2Ygb2JqZWN0TmFtZSA9PT0gInVuZGVmaW5lZCIgfHwgdHlwZW9mIGRlc2NyaXB0aW9uID09PSAidW5kZWZpbmVkIiB8fCB0eXBlb2YgbGFuZ3VhZ2UgPT09ICJ1bmRlZmluZWQiIHx8IHR5cGVvZiBzb3VyY2VQYWNrYWdlVVJMID09PSAidW5kZWZpbmVkIikgdGhyb3cgbmV3IEVycm9yKCJJbnZhbGlkIHBhcmFtZXRlcnMhIik7CgogICAgICAgICAgICByZXR1cm4gbmV3IF9EYXRhT2JqZWN0U2NoZW1hMlsnZGVmYXVsdCddKHRoaXMuX2dlbmVyYXRlR3VpZCgpLCB0eXBlLCBvYmplY3ROYW1lLCBkZXNjcmlwdGlvbiwgbGFuZ3VhZ2UsIHNvdXJjZVBhY2thZ2VVUkwpOwogICAgICAgIH0KICAgIH0sIHsKICAgICAgICBrZXk6ICdjcmVhdGVTb3VyY2VQYWNrYWdlJywKICAgICAgICB2YWx1ZTogZnVuY3Rpb24gY3JlYXRlU291cmNlUGFja2FnZShzb3VyY2VDb2RlLCBzb3VyY2VDb2RlQ2xhc3NuYW1lKSB7CiAgICAgICAgICAgIGlmICh0eXBlb2Ygc291cmNlQ29kZSA9PT0gInVuZGVmaW5lZCIgfHwgdHlwZW9mIHNvdXJjZUNvZGVDbGFzc25hbWUgPT09ICJ1bmRlZmluZWQiKSB0aHJvdyBuZXcgRXJyb3IoIkludmFsaWQgcGFyYW1ldGVycyEiKTsKCiAgICAgICAgICAgIHJldHVybiBuZXcgX1NvdXJjZVBhY2thZ2UyWydkZWZhdWx0J10oc291cmNlQ29kZSwgc291cmNlQ29kZUNsYXNzbmFtZSk7CiAgICAgICAgfQogICAgfSwgewogICAgICAgIGtleTogJ19nZW5lcmF0ZUd1aWQnLAogICAgICAgIHZhbHVlOiBmdW5jdGlvbiBfZ2VuZXJhdGVHdWlkKCkgewogICAgICAgICAgICB2YXIgZCA9IG5ldyBEYXRlKCkuZ2V0VGltZSgpOwoKICAgICAgICAgICAgcmV0dXJuICd4eHh4eHh4eC14eHh4LTR4eHgteXh4eC14eHh4eHh4eHh4eHgnLnJlcGxhY2UoL1t4eV0vZywgZnVuY3Rpb24gKGMpIHsKICAgICAgICAgICAgICAgIHZhciByID0gKGQgKyBNYXRoLnJhbmRvbSgpICogMTYpICUgMTYgfCAwOwogICAgICAgICAgICAgICAgZCA9IE1hdGguZmxvb3IoZCAvIDE2KTsKICAgICAgICAgICAgICAgIHJldHVybiAoYyA9PSAneCcgPyByIDogciAmIDB4MyB8IDB4OCkudG9TdHJpbmcoMTYpOwogICAgICAgICAgICB9KTsKICAgICAgICB9CiAgICB9XSk7CgogICAgcmV0dXJuIENhdGFsb2d1ZURhdGFPYmplY3RGYWN0b3J5Owp9KShfcmVUSElOS09iamVjdFJldGhpbmtPYmplY3QyWydkZWZhdWx0J10pOwoKZXhwb3J0c1snZGVmYXVsdCddID0gQ2F0YWxvZ3VlRGF0YU9iamVjdEZhY3Rvcnk7Cm1vZHVsZS5leHBvcnRzID0gZXhwb3J0c1snZGVmYXVsdCddOwoKfSx7Ii4uL3JlVEhJTktPYmplY3QvUmV0aGlua09iamVjdCI6MTcsIi4vQ2F0YWxvZ3VlRGF0YU9iamVjdCI6NCwiLi9EYXRhT2JqZWN0U2NoZW1hIjo2LCIuL0h5cGVydHlEZXNjcmlwdG9yIjo3LCIuL0h5cGVydHlSdW50aW1lRGVzY3JpcHRvciI6OCwiLi9Qb2xpY3lFbmZvcmNlckRlc2NyaXB0b3IiOjksIi4vUHJvdG9jb2xTdHViRGVzY3JpcHRvciI6MTAsIi4vU291cmNlUGFja2FnZSI6MTF9XSw2OltmdW5jdGlvbihyZXF1aXJlLG1vZHVsZSxleHBvcnRzKXsKLyoqCiAqIENyZWF0ZWQgYnkgcHp1IG9uIDE5LjExLjE1LgogKi8KCid1c2Ugc3RyaWN0JzsKCk9iamVjdC5kZWZpbmVQcm9wZXJ0eShleHBvcnRzLCAnX19lc01vZHVsZScsIHsKICAgIHZhbHVlOiB0cnVlCn0pOwoKdmFyIF9nZXQgPSBmdW5jdGlvbiBnZXQoX3gsIF94MiwgX3gzKSB7IHZhciBfYWdhaW4gPSB0cnVlOyBfZnVuY3Rpb246IHdoaWxlIChfYWdhaW4pIHsgdmFyIG9iamVjdCA9IF94LCBwcm9wZXJ0eSA9IF94MiwgcmVjZWl2ZXIgPSBfeDM7IF9hZ2FpbiA9IGZhbHNlOyBpZiAob2JqZWN0ID09PSBudWxsKSBvYmplY3QgPSBGdW5jdGlvbi5wcm90b3R5cGU7IHZhciBkZXNjID0gT2JqZWN0LmdldE93blByb3BlcnR5RGVzY3JpcHRvcihvYmplY3QsIHByb3BlcnR5KTsgaWYgKGRlc2MgPT09IHVuZGVmaW5lZCkgeyB2YXIgcGFyZW50ID0gT2JqZWN0LmdldFByb3RvdHlwZU9mKG9iamVjdCk7IGlmIChwYXJlbnQgPT09IG51bGwpIHsgcmV0dXJuIHVuZGVmaW5lZDsgfSBlbHNlIHsgX3ggPSBwYXJlbnQ7IF94MiA9IHByb3BlcnR5OyBfeDMgPSByZWNlaXZlcjsgX2FnYWluID0gdHJ1ZTsgZGVzYyA9IHBhcmVudCA9IHVuZGVmaW5lZDsgY29udGludWUgX2Z1bmN0aW9uOyB9IH0gZWxzZSBpZiAoJ3ZhbHVlJyBpbiBkZXNjKSB7IHJldHVybiBkZXNjLnZhbHVlOyB9IGVsc2UgeyB2YXIgZ2V0dGVyID0gZGVzYy5nZXQ7IGlmIChnZXR0ZXIgPT09IHVuZGVmaW5lZCkgeyByZXR1cm4gdW5kZWZpbmVkOyB9IHJldHVybiBnZXR0ZXIuY2FsbChyZWNlaXZlcik7IH0gfSB9OwoKZnVuY3Rpb24gX2ludGVyb3BSZXF1aXJlRGVmYXVsdChvYmopIHsgcmV0dXJuIG9iaiAmJiBvYmouX19lc01vZHVsZSA/IG9iaiA6IHsgJ2RlZmF1bHQnOiBvYmogfTsgfQoKZnVuY3Rpb24gX2NsYXNzQ2FsbENoZWNrKGluc3RhbmNlLCBDb25zdHJ1Y3RvcikgeyBpZiAoIShpbnN0YW5jZSBpbnN0YW5jZW9mIENvbnN0cnVjdG9yKSkgeyB0aHJvdyBuZXcgVHlwZUVycm9yKCdDYW5ub3QgY2FsbCBhIGNsYXNzIGFzIGEgZnVuY3Rpb24nKTsgfSB9CgpmdW5jdGlvbiBfaW5oZXJpdHMoc3ViQ2xhc3MsIHN1cGVyQ2xhc3MpIHsgaWYgKHR5cGVvZiBzdXBlckNsYXNzICE9PSAnZnVuY3Rpb24nICYmIHN1cGVyQ2xhc3MgIT09IG51bGwpIHsgdGhyb3cgbmV3IFR5cGVFcnJvcignU3VwZXIgZXhwcmVzc2lvbiBtdXN0IGVpdGhlciBiZSBudWxsIG9yIGEgZnVuY3Rpb24sIG5vdCAnICsgdHlwZW9mIHN1cGVyQ2xhc3MpOyB9IHN1YkNsYXNzLnByb3RvdHlwZSA9IE9iamVjdC5jcmVhdGUoc3VwZXJDbGFzcyAmJiBzdXBlckNsYXNzLnByb3RvdHlwZSwgeyBjb25zdHJ1Y3RvcjogeyB2YWx1ZTogc3ViQ2xhc3MsIGVudW1lcmFibGU6IGZhbHNlLCB3cml0YWJsZTogdHJ1ZSwgY29uZmlndXJhYmxlOiB0cnVlIH0gfSk7IGlmIChzdXBlckNsYXNzKSBPYmplY3Quc2V0UHJvdG90eXBlT2YgPyBPYmplY3Quc2V0UHJvdG90eXBlT2Yoc3ViQ2xhc3MsIHN1cGVyQ2xhc3MpIDogc3ViQ2xhc3MuX19wcm90b19fID0gc3VwZXJDbGFzczsgfQoKdmFyIF9DYXRhbG9ndWVEYXRhT2JqZWN0MiA9IHJlcXVpcmUoJy4vQ2F0YWxvZ3VlRGF0YU9iamVjdCcpOwoKdmFyIF9DYXRhbG9ndWVEYXRhT2JqZWN0MyA9IF9pbnRlcm9wUmVxdWlyZURlZmF1bHQoX0NhdGFsb2d1ZURhdGFPYmplY3QyKTsKCnZhciBEYXRhT2JqZWN0U2NoZW1hID0gKGZ1bmN0aW9uIChfQ2F0YWxvZ3VlRGF0YU9iamVjdCkgewogICAgX2luaGVyaXRzKERhdGFPYmplY3RTY2hlbWEsIF9DYXRhbG9ndWVEYXRhT2JqZWN0KTsKCiAgICBmdW5jdGlvbiBEYXRhT2JqZWN0U2NoZW1hKGd1aWQsIHR5cGUsIG9iamVjdE5hbWUsIGRlc2NyaXB0aW9uLCBsYW5ndWFnZSwgc291cmNlUGFja2FnZVVSTCkgewogICAgICAgIF9jbGFzc0NhbGxDaGVjayh0aGlzLCBEYXRhT2JqZWN0U2NoZW1hKTsKCiAgICAgICAgX2dldChPYmplY3QuZ2V0UHJvdG90eXBlT2YoRGF0YU9iamVjdFNjaGVtYS5wcm90b3R5cGUpLCAnY29uc3RydWN0b3InLCB0aGlzKS5jYWxsKHRoaXMsIGd1aWQsIHR5cGUsIG9iamVjdE5hbWUsIGRlc2NyaXB0aW9uLCBsYW5ndWFnZSwgc291cmNlUGFja2FnZVVSTCk7CiAgICB9CgogICAgLy9DaGlsZHJlbgogICAgcmV0dXJuIERhdGFPYmplY3RTY2hlbWE7Cn0pKF9DYXRhbG9ndWVEYXRhT2JqZWN0M1snZGVmYXVsdCddKTsKCnZhciBNZXNzYWdlRGF0YU9iamVjdFNjaGVtYSA9IChmdW5jdGlvbiAoX0RhdGFPYmplY3RTY2hlbWEpIHsKICAgIF9pbmhlcml0cyhNZXNzYWdlRGF0YU9iamVjdFNjaGVtYSwgX0RhdGFPYmplY3RTY2hlbWEpOwoKICAgIGZ1bmN0aW9uIE1lc3NhZ2VEYXRhT2JqZWN0U2NoZW1hKGd1aWQsIHR5cGUsIG9iamVjdE5hbWUsIGRlc2NyaXB0aW9uLCBsYW5ndWFnZSwgc291cmNlUGFja2FnZVVSTCkgewogICAgICAgIF9jbGFzc0NhbGxDaGVjayh0aGlzLCBNZXNzYWdlRGF0YU9iamVjdFNjaGVtYSk7CgogICAgICAgIF9nZXQoT2JqZWN0LmdldFByb3RvdHlwZU9mKE1lc3NhZ2VEYXRhT2JqZWN0U2NoZW1hLnByb3RvdHlwZSksICdjb25zdHJ1Y3RvcicsIHRoaXMpLmNhbGwodGhpcywgZ3VpZCwgdHlwZSwgb2JqZWN0TmFtZSwgZGVzY3JpcHRpb24sIGxhbmd1YWdlLCBzb3VyY2VQYWNrYWdlVVJMKTsKICAgIH0KCiAgICByZXR1cm4gTWVzc2FnZURhdGFPYmplY3RTY2hlbWE7Cn0pKERhdGFPYmplY3RTY2hlbWEpOwoKZXhwb3J0cy5NZXNzYWdlRGF0YU9iamVjdFNjaGVtYSA9IE1lc3NhZ2VEYXRhT2JqZWN0U2NoZW1hOwoKdmFyIEh5cGVydHlEYXRhT2JqZWN0U2NoZW1hID0gKGZ1bmN0aW9uIChfRGF0YU9iamVjdFNjaGVtYTIpIHsKICAgIF9pbmhlcml0cyhIeXBlcnR5RGF0YU9iamVjdFNjaGVtYSwgX0RhdGFPYmplY3RTY2hlbWEyKTsKCiAgICBmdW5jdGlvbiBIeXBlcnR5RGF0YU9iamVjdFNjaGVtYShndWlkLCB0eXBlLCBvYmplY3ROYW1lLCBkZXNjcmlwdGlvbiwgbGFuZ3VhZ2UsIHNvdXJjZVBhY2thZ2VVUkwsIGFjY2Vzc0NvbnRyb2xQb2xpY3kpIHsKICAgICAgICBfY2xhc3NDYWxsQ2hlY2sodGhpcywgSHlwZXJ0eURhdGFPYmplY3RTY2hlbWEpOwoKICAgICAgICBfZ2V0KE9iamVjdC5nZXRQcm90b3R5cGVPZihIeXBlcnR5RGF0YU9iamVjdFNjaGVtYS5wcm90b3R5cGUpLCAnY29uc3RydWN0b3InLCB0aGlzKS5jYWxsKHRoaXMsIGd1aWQsIHR5cGUsIG9iamVjdE5hbWUsIGRlc2NyaXB0aW9uLCBsYW5ndWFnZSwgc291cmNlUGFja2FnZVVSTCk7CiAgICAgICAgdGhpcy5fYWNjZXNzQ29udHJvbFBvbGljeSA9IGFjY2Vzc0NvbnRyb2xQb2xpY3k7CiAgICB9CgogICAgLy9DaGlsZHJlbgogICAgcmV0dXJuIEh5cGVydHlEYXRhT2JqZWN0U2NoZW1hOwp9KShEYXRhT2JqZWN0U2NoZW1hKTsKCmV4cG9ydHMuSHlwZXJ0eURhdGFPYmplY3RTY2hlbWEgPSBIeXBlcnR5RGF0YU9iamVjdFNjaGVtYTsKCnZhciBDb21tdW5pY2F0aW9uRGF0YU9iamVjdFNjaGVtYSA9IChmdW5jdGlvbiAoX0h5cGVydHlEYXRhT2JqZWN0U2NoZW1hKSB7CiAgICBfaW5oZXJpdHMoQ29tbXVuaWNhdGlvbkRhdGFPYmplY3RTY2hlbWEsIF9IeXBlcnR5RGF0YU9iamVjdFNjaGVtYSk7CgogICAgZnVuY3Rpb24gQ29tbXVuaWNhdGlvbkRhdGFPYmplY3RTY2hlbWEoZ3VpZCwgdHlwZSwgb2JqZWN0TmFtZSwgZGVzY3JpcHRpb24sIGxhbmd1YWdlLCBzb3VyY2VQYWNrYWdlVVJMLCBhY2Nlc3NDb250cm9sUG9saWN5KSB7CiAgICAgICAgX2NsYXNzQ2FsbENoZWNrKHRoaXMsIENvbW11bmljYXRpb25EYXRhT2JqZWN0U2NoZW1hKTsKCiAgICAgICAgX2dldChPYmplY3QuZ2V0UHJvdG90eXBlT2YoQ29tbXVuaWNhdGlvbkRhdGFPYmplY3RTY2hlbWEucHJvdG90eXBlKSwgJ2NvbnN0cnVjdG9yJywgdGhpcykuY2FsbCh0aGlzLCBndWlkLCB0eXBlLCBvYmplY3ROYW1lLCBkZXNjcmlwdGlvbiwgbGFuZ3VhZ2UsIHNvdXJjZVBhY2thZ2VVUkwsIGFjY2Vzc0NvbnRyb2xQb2xpY3kpOwogICAgfQoKICAgIHJldHVybiBDb21tdW5pY2F0aW9uRGF0YU9iamVjdFNjaGVtYTsKfSkoSHlwZXJ0eURhdGFPYmplY3RTY2hlbWEpOwoKZXhwb3J0cy5Db21tdW5pY2F0aW9uRGF0YU9iamVjdFNjaGVtYSA9IENvbW11bmljYXRpb25EYXRhT2JqZWN0U2NoZW1hOwoKdmFyIENvbm5lY3Rpb25EYXRhT2JqZWN0U2NoZW1hID0gKGZ1bmN0aW9uIChfSHlwZXJ0eURhdGFPYmplY3RTY2hlbWEyKSB7CiAgICBfaW5oZXJpdHMoQ29ubmVjdGlvbkRhdGFPYmplY3RTY2hlbWEsIF9IeXBlcnR5RGF0YU9iamVjdFNjaGVtYTIpOwoKICAgIGZ1bmN0aW9uIENvbm5lY3Rpb25EYXRhT2JqZWN0U2NoZW1hKGd1aWQsIHR5cGUsIG9iamVjdE5hbWUsIGRlc2NyaXB0aW9uLCBsYW5ndWFnZSwgc291cmNlUGFja2FnZVVSTCwgYWNjZXNzQ29udHJvbFBvbGljeSkgewogICAgICAgIF9jbGFzc0NhbGxDaGVjayh0aGlzLCBDb25uZWN0aW9uRGF0YU9iamVjdFNjaGVtYSk7CgogICAgICAgIF9nZXQoT2JqZWN0LmdldFByb3RvdHlwZU9mKENvbm5lY3Rpb25EYXRhT2JqZWN0U2NoZW1hLnByb3RvdHlwZSksICdjb25zdHJ1Y3RvcicsIHRoaXMpLmNhbGwodGhpcywgZ3VpZCwgdHlwZSwgb2JqZWN0TmFtZSwgZGVzY3JpcHRpb24sIGxhbmd1YWdlLCBzb3VyY2VQYWNrYWdlVVJMLCBhY2Nlc3NDb250cm9sUG9saWN5KTsKICAgIH0KCiAgICByZXR1cm4gQ29ubmVjdGlvbkRhdGFPYmplY3RTY2hlbWE7Cn0pKEh5cGVydHlEYXRhT2JqZWN0U2NoZW1hKTsKCmV4cG9ydHMuQ29ubmVjdGlvbkRhdGFPYmplY3RTY2hlbWEgPSBDb25uZWN0aW9uRGF0YU9iamVjdFNjaGVtYTsKCnZhciBJZGVudGlmeURhdGFPYmplY3RTY2hlbWEgPSAoZnVuY3Rpb24gKF9IeXBlcnR5RGF0YU9iamVjdFNjaGVtYTMpIHsKICAgIF9pbmhlcml0cyhJZGVudGlmeURhdGFPYmplY3RTY2hlbWEsIF9IeXBlcnR5RGF0YU9iamVjdFNjaGVtYTMpOwoKICAgIGZ1bmN0aW9uIElkZW50aWZ5RGF0YU9iamVjdFNjaGVtYShndWlkLCB0eXBlLCBvYmplY3ROYW1lLCBkZXNjcmlwdGlvbiwgbGFuZ3VhZ2UsIHNvdXJjZVBhY2thZ2VVUkwsIGFjY2Vzc0NvbnRyb2xQb2xpY3kpIHsKICAgICAgICBfY2xhc3NDYWxsQ2hlY2sodGhpcywgSWRlbnRpZnlEYXRhT2JqZWN0U2NoZW1hKTsKCiAgICAgICAgX2dldChPYmplY3QuZ2V0UHJvdG90eXBlT2YoSWRlbnRpZnlEYXRhT2JqZWN0U2NoZW1hLnByb3RvdHlwZSksICdjb25zdHJ1Y3RvcicsIHRoaXMpLmNhbGwodGhpcywgZ3VpZCwgdHlwZSwgb2JqZWN0TmFtZSwgZGVzY3JpcHRpb24sIGxhbmd1YWdlLCBzb3VyY2VQYWNrYWdlVVJMLCBhY2Nlc3NDb250cm9sUG9saWN5KTsKICAgIH0KCiAgICByZXR1cm4gSWRlbnRpZnlEYXRhT2JqZWN0U2NoZW1hOwp9KShIeXBlcnR5RGF0YU9iamVjdFNjaGVtYSk7CgpleHBvcnRzLklkZW50aWZ5RGF0YU9iamVjdFNjaGVtYSA9IElkZW50aWZ5RGF0YU9iamVjdFNjaGVtYTsKCnZhciBDb250ZXh0RGF0YU9iamVjdFNjaGVtYSA9IChmdW5jdGlvbiAoX0h5cGVydHlEYXRhT2JqZWN0U2NoZW1hNCkgewogICAgX2luaGVyaXRzKENvbnRleHREYXRhT2JqZWN0U2NoZW1hLCBfSHlwZXJ0eURhdGFPYmplY3RTY2hlbWE0KTsKCiAgICBmdW5jdGlvbiBDb250ZXh0RGF0YU9iamVjdFNjaGVtYShndWlkLCB0eXBlLCBvYmplY3ROYW1lLCBkZXNjcmlwdGlvbiwgbGFuZ3VhZ2UsIHNvdXJjZVBhY2thZ2VVUkwsIGFjY2Vzc0NvbnRyb2xQb2xpY3kpIHsKICAgICAgICBfY2xhc3NDYWxsQ2hlY2sodGhpcywgQ29udGV4dERhdGFPYmplY3RTY2hlbWEpOwoKICAgICAgICBfZ2V0KE9iamVjdC5nZXRQcm90b3R5cGVPZihDb250ZXh0RGF0YU9iamVjdFNjaGVtYS5wcm90b3R5cGUpLCAnY29uc3RydWN0b3InLCB0aGlzKS5jYWxsKHRoaXMsIGd1aWQsIHR5cGUsIG9iamVjdE5hbWUsIGRlc2NyaXB0aW9uLCBsYW5ndWFnZSwgc291cmNlUGFja2FnZVVSTCwgYWNjZXNzQ29udHJvbFBvbGljeSk7CiAgICB9CgogICAgcmV0dXJuIENvbnRleHREYXRhT2JqZWN0U2NoZW1hOwp9KShIeXBlcnR5RGF0YU9iamVjdFNjaGVtYSk7CgpleHBvcnRzLkNvbnRleHREYXRhT2JqZWN0U2NoZW1hID0gQ29udGV4dERhdGFPYmplY3RTY2hlbWE7CmV4cG9ydHNbJ2RlZmF1bHQnXSA9IERhdGFPYmplY3RTY2hlbWE7Cgp9LHsiLi9DYXRhbG9ndWVEYXRhT2JqZWN0Ijo0fV0sNzpbZnVuY3Rpb24ocmVxdWlyZSxtb2R1bGUsZXhwb3J0cyl7Ci8qKgogKiBDcmVhdGVkIGJ5IGFtbyBvbiAxNC8xMS8yMDE1LgogKi8KJ3VzZSBzdHJpY3QnOwoKT2JqZWN0LmRlZmluZVByb3BlcnR5KGV4cG9ydHMsICdfX2VzTW9kdWxlJywgewogICAgdmFsdWU6IHRydWUKfSk7Cgp2YXIgX2NyZWF0ZUNsYXNzID0gKGZ1bmN0aW9uICgpIHsgZnVuY3Rpb24gZGVmaW5lUHJvcGVydGllcyh0YXJnZXQsIHByb3BzKSB7IGZvciAodmFyIGkgPSAwOyBpIDwgcHJvcHMubGVuZ3RoOyBpKyspIHsgdmFyIGRlc2NyaXB0b3IgPSBwcm9wc1tpXTsgZGVzY3JpcHRvci5lbnVtZXJhYmxlID0gZGVzY3JpcHRvci5lbnVtZXJhYmxlIHx8IGZhbHNlOyBkZXNjcmlwdG9yLmNvbmZpZ3VyYWJsZSA9IHRydWU7IGlmICgndmFsdWUnIGluIGRlc2NyaXB0b3IpIGRlc2NyaXB0b3Iud3JpdGFibGUgPSB0cnVlOyBPYmplY3QuZGVmaW5lUHJvcGVydHkodGFyZ2V0LCBkZXNjcmlwdG9yLmtleSwgZGVzY3JpcHRvcik7IH0gfSByZXR1cm4gZnVuY3Rpb24gKENvbnN0cnVjdG9yLCBwcm90b1Byb3BzLCBzdGF0aWNQcm9wcykgeyBpZiAocHJvdG9Qcm9wcykgZGVmaW5lUHJvcGVydGllcyhDb25zdHJ1Y3Rvci5wcm90b3R5cGUsIHByb3RvUHJvcHMpOyBpZiAoc3RhdGljUHJvcHMpIGRlZmluZVByb3BlcnRpZXMoQ29uc3RydWN0b3IsIHN0YXRpY1Byb3BzKTsgcmV0dXJuIENvbnN0cnVjdG9yOyB9OyB9KSgpOwoKdmFyIF9nZXQgPSBmdW5jdGlvbiBnZXQoX3gsIF94MiwgX3gzKSB7IHZhciBfYWdhaW4gPSB0cnVlOyBfZnVuY3Rpb246IHdoaWxlIChfYWdhaW4pIHsgdmFyIG9iamVjdCA9IF94LCBwcm9wZXJ0eSA9IF94MiwgcmVjZWl2ZXIgPSBfeDM7IF9hZ2FpbiA9IGZhbHNlOyBpZiAob2JqZWN0ID09PSBudWxsKSBvYmplY3QgPSBGdW5jdGlvbi5wcm90b3R5cGU7IHZhciBkZXNjID0gT2JqZWN0LmdldE93blByb3BlcnR5RGVzY3JpcHRvcihvYmplY3QsIHByb3BlcnR5KTsgaWYgKGRlc2MgPT09IHVuZGVmaW5lZCkgeyB2YXIgcGFyZW50ID0gT2JqZWN0LmdldFByb3RvdHlwZU9mKG9iamVjdCk7IGlmIChwYXJlbnQgPT09IG51bGwpIHsgcmV0dXJuIHVuZGVmaW5lZDsgfSBlbHNlIHsgX3ggPSBwYXJlbnQ7IF94MiA9IHByb3BlcnR5OyBfeDMgPSByZWNlaXZlcjsgX2FnYWluID0gdHJ1ZTsgZGVzYyA9IHBhcmVudCA9IHVuZGVmaW5lZDsgY29udGludWUgX2Z1bmN0aW9uOyB9IH0gZWxzZSBpZiAoJ3ZhbHVlJyBpbiBkZXNjKSB7IHJldHVybiBkZXNjLnZhbHVlOyB9IGVsc2UgeyB2YXIgZ2V0dGVyID0gZGVzYy5nZXQ7IGlmIChnZXR0ZXIgPT09IHVuZGVmaW5lZCkgeyByZXR1cm4gdW5kZWZpbmVkOyB9IHJldHVybiBnZXR0ZXIuY2FsbChyZWNlaXZlcik7IH0gfSB9OwoKZnVuY3Rpb24gX2ludGVyb3BSZXF1aXJlRGVmYXVsdChvYmopIHsgcmV0dXJuIG9iaiAmJiBvYmouX19lc01vZHVsZSA/IG9iaiA6IHsgJ2RlZmF1bHQnOiBvYmogfTsgfQoKZnVuY3Rpb24gX2NsYXNzQ2FsbENoZWNrKGluc3RhbmNlLCBDb25zdHJ1Y3RvcikgeyBpZiAoIShpbnN0YW5jZSBpbnN0YW5jZW9mIENvbnN0cnVjdG9yKSkgeyB0aHJvdyBuZXcgVHlwZUVycm9yKCdDYW5ub3QgY2FsbCBhIGNsYXNzIGFzIGEgZnVuY3Rpb24nKTsgfSB9CgpmdW5jdGlvbiBfaW5oZXJpdHMoc3ViQ2xhc3MsIHN1cGVyQ2xhc3MpIHsgaWYgKHR5cGVvZiBzdXBlckNsYXNzICE9PSAnZnVuY3Rpb24nICYmIHN1cGVyQ2xhc3MgIT09IG51bGwpIHsgdGhyb3cgbmV3IFR5cGVFcnJvcignU3VwZXIgZXhwcmVzc2lvbiBtdXN0IGVpdGhlciBiZSBudWxsIG9yIGEgZnVuY3Rpb24sIG5vdCAnICsgdHlwZW9mIHN1cGVyQ2xhc3MpOyB9IHN1YkNsYXNzLnByb3RvdHlwZSA9IE9iamVjdC5jcmVhdGUoc3VwZXJDbGFzcyAmJiBzdXBlckNsYXNzLnByb3RvdHlwZSwgeyBjb25zdHJ1Y3RvcjogeyB2YWx1ZTogc3ViQ2xhc3MsIGVudW1lcmFibGU6IGZhbHNlLCB3cml0YWJsZTogdHJ1ZSwgY29uZmlndXJhYmxlOiB0cnVlIH0gfSk7IGlmIChzdXBlckNsYXNzKSBPYmplY3Quc2V0UHJvdG90eXBlT2YgPyBPYmplY3Quc2V0UHJvdG90eXBlT2Yoc3ViQ2xhc3MsIHN1cGVyQ2xhc3MpIDogc3ViQ2xhc3MuX19wcm90b19fID0gc3VwZXJDbGFzczsgfQoKdmFyIF9DYXRhbG9ndWVEYXRhT2JqZWN0MiA9IHJlcXVpcmUoJy4vQ2F0YWxvZ3VlRGF0YU9iamVjdCcpOwoKdmFyIF9DYXRhbG9ndWVEYXRhT2JqZWN0MyA9IF9pbnRlcm9wUmVxdWlyZURlZmF1bHQoX0NhdGFsb2d1ZURhdGFPYmplY3QyKTsKCnZhciBIeXBlcnR5RGVzY3JpcHRvciA9IChmdW5jdGlvbiAoX0NhdGFsb2d1ZURhdGFPYmplY3QpIHsKICAgIF9pbmhlcml0cyhIeXBlcnR5RGVzY3JpcHRvciwgX0NhdGFsb2d1ZURhdGFPYmplY3QpOwoKICAgIGZ1bmN0aW9uIEh5cGVydHlEZXNjcmlwdG9yKGd1aWQsIGNhdGFsb2d1ZVR5cGUsIG9iamVjdE5hbWUsIGRlc2NyaXB0aW9uLCBsYW5ndWFnZSwgc291cmNlUGFja2FnZVVSTCwgaHlwZXJ0eVR5cGUsIGRhdGFPYmplY3RzKSB7CiAgICAgICAgX2NsYXNzQ2FsbENoZWNrKHRoaXMsIEh5cGVydHlEZXNjcmlwdG9yKTsKCiAgICAgICAgX2dldChPYmplY3QuZ2V0UHJvdG90eXBlT2YoSHlwZXJ0eURlc2NyaXB0b3IucHJvdG90eXBlKSwgJ2NvbnN0cnVjdG9yJywgdGhpcykuY2FsbCh0aGlzLCBndWlkLCBjYXRhbG9ndWVUeXBlLCBvYmplY3ROYW1lLCBkZXNjcmlwdGlvbiwgbGFuZ3VhZ2UsIHNvdXJjZVBhY2thZ2VVUkwpOwoKICAgICAgICB0aGlzLl9jb25maWd1cmF0aW9uRGF0YUxpc3QgPSB7fTsKICAgICAgICB0aGlzLl9ydW50aW1lQ29uc3RyYWludExpc3QgPSB7fTsKICAgICAgICB0aGlzLl9wb2xpY2llcyA9IHt9OwogICAgICAgIHRoaXMuX21lc3NhZ2VTY2hlbWEgPSBudWxsOwoKICAgICAgICB0aGlzLl9oeXBlcnR5VHlwZSA9IGh5cGVydHlUeXBlOwogICAgICAgIHRoaXMuX2RhdGFPYmplY3RzID0gZGF0YU9iamVjdHM7CiAgICB9CgogICAgX2NyZWF0ZUNsYXNzKEh5cGVydHlEZXNjcmlwdG9yLCBbewogICAgICAgIGtleTogJ2h5cGVydHlUeXBlJywKICAgICAgICBnZXQ6IGZ1bmN0aW9uIGdldCgpIHsKICAgICAgICAgICAgcmV0dXJuIHRoaXMuX2h5cGVydHlUeXBlOwogICAgICAgIH0sCiAgICAgICAgc2V0OiBmdW5jdGlvbiBzZXQoaFR5cGUpIHsKICAgICAgICAgICAgaWYgKGhUeXBlKSB0aGlzLl9oeXBlcnR5VHlwZSA9IGhUeXBlOwogICAgICAgIH0KICAgIH0sIHsKICAgICAgICBrZXk6ICdkYXRhT2JqZWN0cycsCiAgICAgICAgZ2V0OiBmdW5jdGlvbiBnZXQoKSB7CiAgICAgICAgICAgIHJldHVybiB0aGlzLl9kYXRhT2JqZWN0czsKICAgICAgICB9LAogICAgICAgIHNldDogZnVuY3Rpb24gc2V0KGRhdGFPYmplY3RVcmwpIHsKICAgICAgICAgICAgaWYgKGRhdGFPYmplY3RVcmwpIHRoaXMuX2RhdGFPYmplY3RzID0gZGF0YU9iamVjdFVybDsKICAgICAgICB9CiAgICB9LCB7CiAgICAgICAga2V5OiAnY29uZmlndXJhdGlvbkRhdGFMaXN0JywKICAgICAgICBnZXQ6IGZ1bmN0aW9uIGdldCgpIHsKICAgICAgICAgICAgcmV0dXJuIHRoaXMuX2NvbmZpZ3VyYXRpb25EYXRhTGlzdDsKICAgICAgICB9LAogICAgICAgIHNldDogZnVuY3Rpb24gc2V0KGNvbmZpZ0RhdGFMaXN0KSB7CiAgICAgICAgICAgIGlmIChjb25maWdEYXRhTGlzdCkgdGhpcy5fY29uZmlndXJhdGlvbkRhdGFMaXN0ID0gY29uZmlnRGF0YUxpc3Q7CiAgICAgICAgfQogICAgfSwgewogICAgICAgIGtleTogJ3J1bnRpbWVDb25zdHJhaW50TGlzdCcsCiAgICAgICAgZ2V0OiBmdW5jdGlvbiBnZXQoKSB7CiAgICAgICAgICAgIHJldHVybiB0aGlzLl9ydW50aW1lQ29uc3RyYWludExpc3Q7CiAgICAgICAgfSwKICAgICAgICBzZXQ6IGZ1bmN0aW9uIHNldChydW50aW1lQ29uc3RMaXN0KSB7CiAgICAgICAgICAgIGlmIChydW50aW1lQ29uc3RMaXN0KSB0aGlzLl9ydW50aW1lQ29uc3RyYWludExpc3QgPSBydW50aW1lQ29uc3RMaXN0OwogICAgICAgIH0KICAgIH0sIHsKICAgICAgICBrZXk6ICdtZXNzYWdlU2NoZW1hJywKICAgICAgICBnZXQ6IGZ1bmN0aW9uIGdldCgpIHsKICAgICAgICAgICAgcmV0dXJuIHRoaXMuX21lc3NhZ2VTY2hlbWE7CiAgICAgICAgfSwKICAgICAgICBzZXQ6IGZ1bmN0aW9uIHNldChtc2dTY2hlbWEpIHsKICAgICAgICAgICAgaWYgKG1zZ1NjaGVtYSkgdGhpcy5fbWVzc2FnZVNjaGVtYSA9IG1zZ1NjaGVtYTsKICAgICAgICB9CiAgICB9LCB7CiAgICAgICAga2V5OiAncG9saWNpZXMnLAogICAgICAgIGdldDogZnVuY3Rpb24gZ2V0KCkgewogICAgICAgICAgICByZXR1cm4gdGhpcy5fcG9saWNpZXM7CiAgICAgICAgfSwKICAgICAgICBzZXQ6IGZ1bmN0aW9uIHNldChwb2xpY3lMaXN0KSB7CiAgICAgICAgICAgIGlmIChwb2xpY3lMaXN0KSB0aGlzLl9wb2xpY2llcyA9IHBvbGljeUxpc3Q7CiAgICAgICAgfQogICAgfV0pOwoKICAgIHJldHVybiBIeXBlcnR5RGVzY3JpcHRvcjsKfSkoX0NhdGFsb2d1ZURhdGFPYmplY3QzWydkZWZhdWx0J10pOwoKdmFyIFJ1bnRpbWVIeXBlcnR5Q2FwYWJpbGl0eVR5cGUgPSB7fTsKZXhwb3J0cy5SdW50aW1lSHlwZXJ0eUNhcGFiaWxpdHlUeXBlID0gUnVudGltZUh5cGVydHlDYXBhYmlsaXR5VHlwZTsKdmFyIEh5cGVydHlUeXBlID0geyBDT01NVU5JQ0FUT1I6ICdjb21tdW5pY2F0b3InLCBJREVOVElUWTogJ2lkZW50aXR5JywgQ09OVEVYVDogJ2NvbnRleHQnIH07CmV4cG9ydHMuSHlwZXJ0eVR5cGUgPSBIeXBlcnR5VHlwZTsKZXhwb3J0c1snZGVmYXVsdCddID0gSHlwZXJ0eURlc2NyaXB0b3I7Cgp9LHsiLi9DYXRhbG9ndWVEYXRhT2JqZWN0Ijo0fV0sODpbZnVuY3Rpb24ocmVxdWlyZSxtb2R1bGUsZXhwb3J0cyl7Ci8qKgogKiBDcmVhdGVkIGJ5IGFtbyBvbiAxNC8xMS8yMDE1LgogKi8KCid1c2Ugc3RyaWN0JzsKCk9iamVjdC5kZWZpbmVQcm9wZXJ0eShleHBvcnRzLCAnX19lc01vZHVsZScsIHsKICAgIHZhbHVlOiB0cnVlCn0pOwoKdmFyIF9jcmVhdGVDbGFzcyA9IChmdW5jdGlvbiAoKSB7IGZ1bmN0aW9uIGRlZmluZVByb3BlcnRpZXModGFyZ2V0LCBwcm9wcykgeyBmb3IgKHZhciBpID0gMDsgaSA8IHByb3BzLmxlbmd0aDsgaSsrKSB7IHZhciBkZXNjcmlwdG9yID0gcHJvcHNbaV07IGRlc2NyaXB0b3IuZW51bWVyYWJsZSA9IGRlc2NyaXB0b3IuZW51bWVyYWJsZSB8fCBmYWxzZTsgZGVzY3JpcHRvci5jb25maWd1cmFibGUgPSB0cnVlOyBpZiAoJ3ZhbHVlJyBpbiBkZXNjcmlwdG9yKSBkZXNjcmlwdG9yLndyaXRhYmxlID0gdHJ1ZTsgT2JqZWN0LmRlZmluZVByb3BlcnR5KHRhcmdldCwgZGVzY3JpcHRvci5rZXksIGRlc2NyaXB0b3IpOyB9IH0gcmV0dXJuIGZ1bmN0aW9uIChDb25zdHJ1Y3RvciwgcHJvdG9Qcm9wcywgc3RhdGljUHJvcHMpIHsgaWYgKHByb3RvUHJvcHMpIGRlZmluZVByb3BlcnRpZXMoQ29uc3RydWN0b3IucHJvdG90eXBlLCBwcm90b1Byb3BzKTsgaWYgKHN0YXRpY1Byb3BzKSBkZWZpbmVQcm9wZXJ0aWVzKENvbnN0cnVjdG9yLCBzdGF0aWNQcm9wcyk7IHJldHVybiBDb25zdHJ1Y3RvcjsgfTsgfSkoKTsKCnZhciBfZ2V0ID0gZnVuY3Rpb24gZ2V0KF94LCBfeDIsIF94MykgeyB2YXIgX2FnYWluID0gdHJ1ZTsgX2Z1bmN0aW9uOiB3aGlsZSAoX2FnYWluKSB7IHZhciBvYmplY3QgPSBfeCwgcHJvcGVydHkgPSBfeDIsIHJlY2VpdmVyID0gX3gzOyBfYWdhaW4gPSBmYWxzZTsgaWYgKG9iamVjdCA9PT0gbnVsbCkgb2JqZWN0ID0gRnVuY3Rpb24ucHJvdG90eXBlOyB2YXIgZGVzYyA9IE9iamVjdC5nZXRPd25Qcm9wZXJ0eURlc2NyaXB0b3Iob2JqZWN0LCBwcm9wZXJ0eSk7IGlmIChkZXNjID09PSB1bmRlZmluZWQpIHsgdmFyIHBhcmVudCA9IE9iamVjdC5nZXRQcm90b3R5cGVPZihvYmplY3QpOyBpZiAocGFyZW50ID09PSBudWxsKSB7IHJldHVybiB1bmRlZmluZWQ7IH0gZWxzZSB7IF94ID0gcGFyZW50OyBfeDIgPSBwcm9wZXJ0eTsgX3gzID0gcmVjZWl2ZXI7IF9hZ2FpbiA9IHRydWU7IGRlc2MgPSBwYXJlbnQgPSB1bmRlZmluZWQ7IGNvbnRpbnVlIF9mdW5jdGlvbjsgfSB9IGVsc2UgaWYgKCd2YWx1ZScgaW4gZGVzYykgeyByZXR1cm4gZGVzYy52YWx1ZTsgfSBlbHNlIHsgdmFyIGdldHRlciA9IGRlc2MuZ2V0OyBpZiAoZ2V0dGVyID09PSB1bmRlZmluZWQpIHsgcmV0dXJuIHVuZGVmaW5lZDsgfSByZXR1cm4gZ2V0dGVyLmNhbGwocmVjZWl2ZXIpOyB9IH0gfTsKCmZ1bmN0aW9uIF9pbnRlcm9wUmVxdWlyZURlZmF1bHQob2JqKSB7IHJldHVybiBvYmogJiYgb2JqLl9fZXNNb2R1bGUgPyBvYmogOiB7ICdkZWZhdWx0Jzogb2JqIH07IH0KCmZ1bmN0aW9uIF9jbGFzc0NhbGxDaGVjayhpbnN0YW5jZSwgQ29uc3RydWN0b3IpIHsgaWYgKCEoaW5zdGFuY2UgaW5zdGFuY2VvZiBDb25zdHJ1Y3RvcikpIHsgdGhyb3cgbmV3IFR5cGVFcnJvcignQ2Fubm90IGNhbGwgYSBjbGFzcyBhcyBhIGZ1bmN0aW9uJyk7IH0gfQoKZnVuY3Rpb24gX2luaGVyaXRzKHN1YkNsYXNzLCBzdXBlckNsYXNzKSB7IGlmICh0eXBlb2Ygc3VwZXJDbGFzcyAhPT0gJ2Z1bmN0aW9uJyAmJiBzdXBlckNsYXNzICE9PSBudWxsKSB7IHRocm93IG5ldyBUeXBlRXJyb3IoJ1N1cGVyIGV4cHJlc3Npb24gbXVzdCBlaXRoZXIgYmUgbnVsbCBvciBhIGZ1bmN0aW9uLCBub3QgJyArIHR5cGVvZiBzdXBlckNsYXNzKTsgfSBzdWJDbGFzcy5wcm90b3R5cGUgPSBPYmplY3QuY3JlYXRlKHN1cGVyQ2xhc3MgJiYgc3VwZXJDbGFzcy5wcm90b3R5cGUsIHsgY29uc3RydWN0b3I6IHsgdmFsdWU6IHN1YkNsYXNzLCBlbnVtZXJhYmxlOiBmYWxzZSwgd3JpdGFibGU6IHRydWUsIGNvbmZpZ3VyYWJsZTogdHJ1ZSB9IH0pOyBpZiAoc3VwZXJDbGFzcykgT2JqZWN0LnNldFByb3RvdHlwZU9mID8gT2JqZWN0LnNldFByb3RvdHlwZU9mKHN1YkNsYXNzLCBzdXBlckNsYXNzKSA6IHN1YkNsYXNzLl9fcHJvdG9fXyA9IHN1cGVyQ2xhc3M7IH0KCnZhciBfQ2F0YWxvZ3VlRGF0YU9iamVjdDIgPSByZXF1aXJlKCcuL0NhdGFsb2d1ZURhdGFPYmplY3QnKTsKCnZhciBfQ2F0YWxvZ3VlRGF0YU9iamVjdDMgPSBfaW50ZXJvcFJlcXVpcmVEZWZhdWx0KF9DYXRhbG9ndWVEYXRhT2JqZWN0Mik7Cgp2YXIgSHlwZXJ0eVJ1bnRpbWVEZXNjcmlwdG9yID0gKGZ1bmN0aW9uIChfQ2F0YWxvZ3VlRGF0YU9iamVjdCkgewogICAgX2luaGVyaXRzKEh5cGVydHlSdW50aW1lRGVzY3JpcHRvciwgX0NhdGFsb2d1ZURhdGFPYmplY3QpOwoKICAgIGZ1bmN0aW9uIEh5cGVydHlSdW50aW1lRGVzY3JpcHRvcihndWlkLCBjYXRhbG9ndWVUeXBlLCBvYmplY3ROYW1lLCBkZXNjcmlwdGlvbiwgbGFuZ3VhZ2UsIHNvdXJjZVBhY2thZ2VVUkwsIHJ1bnRpbWVUeXBlLCBoeXBlcnR5Q2FwYWJpbGl0aWVzLCBwcm90b2NvbENhcGFiaWxpdGllcykgewogICAgICAgIF9jbGFzc0NhbGxDaGVjayh0aGlzLCBIeXBlcnR5UnVudGltZURlc2NyaXB0b3IpOwoKICAgICAgICBfZ2V0KE9iamVjdC5nZXRQcm90b3R5cGVPZihIeXBlcnR5UnVudGltZURlc2NyaXB0b3IucHJvdG90eXBlKSwgJ2NvbnN0cnVjdG9yJywgdGhpcykuY2FsbCh0aGlzLCBndWlkLCBjYXRhbG9ndWVUeXBlLCBvYmplY3ROYW1lLCBkZXNjcmlwdGlvbiwgbGFuZ3VhZ2UsIHNvdXJjZVBhY2thZ2VVUkwpOwoKICAgICAgICB0aGlzLl9ydW50aW1lVHlwZSA9IHJ1bnRpbWVUeXBlOwogICAgICAgIGlmIChoeXBlcnR5Q2FwYWJpbGl0aWVzKSB0aGlzLl9oeXBlcnR5Q2FwYWJpbGl0aWVzID0gaHlwZXJ0eUNhcGFiaWxpdGllcztlbHNlIHRoaXMuX2h5cGVydHlDYXBhYmlsaXRpZXMgPSB7fTsKICAgICAgICBpZiAocHJvdG9jb2xDYXBhYmlsaXRpZXMpIHRoaXMuX3Byb3RvY29sQ2FwYWJpbGl0aWVzID0gcHJvdG9jb2xDYXBhYmlsaXRpZXM7ZWxzZSB0aGlzLl9wcm90b2NvbENhcGFiaWxpdGllcyA9IHt9OwogICAgfQoKICAgIF9jcmVhdGVDbGFzcyhIeXBlcnR5UnVudGltZURlc2NyaXB0b3IsIFt7CiAgICAgICAga2V5OiAncnVudGltZVR5cGUnLAogICAgICAgIGdldDogZnVuY3Rpb24gZ2V0KCkgewogICAgICAgICAgICByZXR1cm4gdGhpcy5fcnVudGltZVR5cGU7CiAgICAgICAgfQogICAgfSwgewogICAgICAgIGtleTogJ2h5cGVydHlDYXBhYmlsaXRpZXMnLAogICAgICAgIGdldDogZnVuY3Rpb24gZ2V0KCkgewogICAgICAgICAgICByZXR1cm4gdGhpcy5faHlwZXJ0eUNhcGFiaWxpdGllczsKICAgICAgICB9CiAgICB9LCB7CiAgICAgICAga2V5OiAncHJvdG9jb2xDYXBhYmlsaXRpZXMnLAogICAgICAgIGdldDogZnVuY3Rpb24gZ2V0KCkgewogICAgICAgICAgICByZXR1cm4gdGhpcy5faHlwZXJ0eUNhcGFiaWxpdGllczsKICAgICAgICB9CiAgICB9XSk7CgogICAgcmV0dXJuIEh5cGVydHlSdW50aW1lRGVzY3JpcHRvcjsKfSkoX0NhdGFsb2d1ZURhdGFPYmplY3QzWydkZWZhdWx0J10pOwoKdmFyIFJ1bnRpbWVUeXBlID0geyBCUk9XU0VSOiAnYnJvd3NlcicsIFNUQU5EQUxPTkU6ICdzdGFuZGFsb25lJywgU0VSVkVSOiAnc2VydmVyJywgR0FURVdBWTogJ2dhdGV3YXknIH07CmV4cG9ydHMuUnVudGltZVR5cGUgPSBSdW50aW1lVHlwZTsKdmFyIFJ1bnRpbWVIeXBlcnR5Q2FwYWJpbGl0eVR5cGUgPSB7IE1JQzogJ21pYycsIENBTUVSQTogJ2NhbWVyYScsIFNFTlNPUjogJ3NlbnNvcicsIFdFQlJUQzogJ3dlYnJ0YycsCiAgICBPUlRDOiAnb3J0YycgfTsKZXhwb3J0cy5SdW50aW1lSHlwZXJ0eUNhcGFiaWxpdHlUeXBlID0gUnVudGltZUh5cGVydHlDYXBhYmlsaXR5VHlwZTsKdmFyIFJ1bnRpbWVQcm90b2NvbENhcGFiaWxpdHlUeXBlID0geyBIVFRQOiAnaHR0cCcsIEhUVFBTOiAnaHR0cHMnLCBXUzogJ3dzJywgV1NTOiAnd3NzJywgQ09BUDogJ2NvYXAnLAogICAgREFUQUNIQU5FTDogJ2RhdGFjaGFubmVsJyB9OwpleHBvcnRzLlJ1bnRpbWVQcm90b2NvbENhcGFiaWxpdHlUeXBlID0gUnVudGltZVByb3RvY29sQ2FwYWJpbGl0eVR5cGU7CmV4cG9ydHNbJ2RlZmF1bHQnXSA9IEh5cGVydHlSdW50aW1lRGVzY3JpcHRvcjsKCn0seyIuL0NhdGFsb2d1ZURhdGFPYmplY3QiOjR9XSw5OltmdW5jdGlvbihyZXF1aXJlLG1vZHVsZSxleHBvcnRzKXsKLyoqCiAqIENyZWF0ZWQgYnkgcHp1IG9uIDE5LjExLjE1LgogKi8KJ3VzZSBzdHJpY3QnOwoKT2JqZWN0LmRlZmluZVByb3BlcnR5KGV4cG9ydHMsICdfX2VzTW9kdWxlJywgewogICAgdmFsdWU6IHRydWUKfSk7Cgp2YXIgX2NyZWF0ZUNsYXNzID0gKGZ1bmN0aW9uICgpIHsgZnVuY3Rpb24gZGVmaW5lUHJvcGVydGllcyh0YXJnZXQsIHByb3BzKSB7IGZvciAodmFyIGkgPSAwOyBpIDwgcHJvcHMubGVuZ3RoOyBpKyspIHsgdmFyIGRlc2NyaXB0b3IgPSBwcm9wc1tpXTsgZGVzY3JpcHRvci5lbnVtZXJhYmxlID0gZGVzY3JpcHRvci5lbnVtZXJhYmxlIHx8IGZhbHNlOyBkZXNjcmlwdG9yLmNvbmZpZ3VyYWJsZSA9IHRydWU7IGlmICgndmFsdWUnIGluIGRlc2NyaXB0b3IpIGRlc2NyaXB0b3Iud3JpdGFibGUgPSB0cnVlOyBPYmplY3QuZGVmaW5lUHJvcGVydHkodGFyZ2V0LCBkZXNjcmlwdG9yLmtleSwgZGVzY3JpcHRvcik7IH0gfSByZXR1cm4gZnVuY3Rpb24gKENvbnN0cnVjdG9yLCBwcm90b1Byb3BzLCBzdGF0aWNQcm9wcykgeyBpZiAocHJvdG9Qcm9wcykgZGVmaW5lUHJvcGVydGllcyhDb25zdHJ1Y3Rvci5wcm90b3R5cGUsIHByb3RvUHJvcHMpOyBpZiAoc3RhdGljUHJvcHMpIGRlZmluZVByb3BlcnRpZXMoQ29uc3RydWN0b3IsIHN0YXRpY1Byb3BzKTsgcmV0dXJuIENvbnN0cnVjdG9yOyB9OyB9KSgpOwoKdmFyIF9nZXQgPSBmdW5jdGlvbiBnZXQoX3gsIF94MiwgX3gzKSB7IHZhciBfYWdhaW4gPSB0cnVlOyBfZnVuY3Rpb246IHdoaWxlIChfYWdhaW4pIHsgdmFyIG9iamVjdCA9IF94LCBwcm9wZXJ0eSA9IF94MiwgcmVjZWl2ZXIgPSBfeDM7IF9hZ2FpbiA9IGZhbHNlOyBpZiAob2JqZWN0ID09PSBudWxsKSBvYmplY3QgPSBGdW5jdGlvbi5wcm90b3R5cGU7IHZhciBkZXNjID0gT2JqZWN0LmdldE93blByb3BlcnR5RGVzY3JpcHRvcihvYmplY3QsIHByb3BlcnR5KTsgaWYgKGRlc2MgPT09IHVuZGVmaW5lZCkgeyB2YXIgcGFyZW50ID0gT2JqZWN0LmdldFByb3RvdHlwZU9mKG9iamVjdCk7IGlmIChwYXJlbnQgPT09IG51bGwpIHsgcmV0dXJuIHVuZGVmaW5lZDsgfSBlbHNlIHsgX3ggPSBwYXJlbnQ7IF94MiA9IHByb3BlcnR5OyBfeDMgPSByZWNlaXZlcjsgX2FnYWluID0gdHJ1ZTsgZGVzYyA9IHBhcmVudCA9IHVuZGVmaW5lZDsgY29udGludWUgX2Z1bmN0aW9uOyB9IH0gZWxzZSBpZiAoJ3ZhbHVlJyBpbiBkZXNjKSB7IHJldHVybiBkZXNjLnZhbHVlOyB9IGVsc2UgeyB2YXIgZ2V0dGVyID0gZGVzYy5nZXQ7IGlmIChnZXR0ZXIgPT09IHVuZGVmaW5lZCkgeyByZXR1cm4gdW5kZWZpbmVkOyB9IHJldHVybiBnZXR0ZXIuY2FsbChyZWNlaXZlcik7IH0gfSB9OwoKZnVuY3Rpb24gX2ludGVyb3BSZXF1aXJlRGVmYXVsdChvYmopIHsgcmV0dXJuIG9iaiAmJiBvYmouX19lc01vZHVsZSA/IG9iaiA6IHsgJ2RlZmF1bHQnOiBvYmogfTsgfQoKZnVuY3Rpb24gX2NsYXNzQ2FsbENoZWNrKGluc3RhbmNlLCBDb25zdHJ1Y3RvcikgeyBpZiAoIShpbnN0YW5jZSBpbnN0YW5jZW9mIENvbnN0cnVjdG9yKSkgeyB0aHJvdyBuZXcgVHlwZUVycm9yKCdDYW5ub3QgY2FsbCBhIGNsYXNzIGFzIGEgZnVuY3Rpb24nKTsgfSB9CgpmdW5jdGlvbiBfaW5oZXJpdHMoc3ViQ2xhc3MsIHN1cGVyQ2xhc3MpIHsgaWYgKHR5cGVvZiBzdXBlckNsYXNzICE9PSAnZnVuY3Rpb24nICYmIHN1cGVyQ2xhc3MgIT09IG51bGwpIHsgdGhyb3cgbmV3IFR5cGVFcnJvcignU3VwZXIgZXhwcmVzc2lvbiBtdXN0IGVpdGhlciBiZSBudWxsIG9yIGEgZnVuY3Rpb24sIG5vdCAnICsgdHlwZW9mIHN1cGVyQ2xhc3MpOyB9IHN1YkNsYXNzLnByb3RvdHlwZSA9IE9iamVjdC5jcmVhdGUoc3VwZXJDbGFzcyAmJiBzdXBlckNsYXNzLnByb3RvdHlwZSwgeyBjb25zdHJ1Y3RvcjogeyB2YWx1ZTogc3ViQ2xhc3MsIGVudW1lcmFibGU6IGZhbHNlLCB3cml0YWJsZTogdHJ1ZSwgY29uZmlndXJhYmxlOiB0cnVlIH0gfSk7IGlmIChzdXBlckNsYXNzKSBPYmplY3Quc2V0UHJvdG90eXBlT2YgPyBPYmplY3Quc2V0UHJvdG90eXBlT2Yoc3ViQ2xhc3MsIHN1cGVyQ2xhc3MpIDogc3ViQ2xhc3MuX19wcm90b19fID0gc3VwZXJDbGFzczsgfQoKdmFyIF9DYXRhbG9ndWVEYXRhT2JqZWN0MiA9IHJlcXVpcmUoJy4vQ2F0YWxvZ3VlRGF0YU9iamVjdCcpOwoKdmFyIF9DYXRhbG9ndWVEYXRhT2JqZWN0MyA9IF9pbnRlcm9wUmVxdWlyZURlZmF1bHQoX0NhdGFsb2d1ZURhdGFPYmplY3QyKTsKCnZhciBQb2xpY3lFbmZvcmNlckRlc2NyaXB0b3IgPSAoZnVuY3Rpb24gKF9DYXRhbG9ndWVEYXRhT2JqZWN0KSB7CiAgICBfaW5oZXJpdHMoUG9saWN5RW5mb3JjZXJEZXNjcmlwdG9yLCBfQ2F0YWxvZ3VlRGF0YU9iamVjdCk7CgogICAgZnVuY3Rpb24gUG9saWN5RW5mb3JjZXJEZXNjcmlwdG9yKGd1aWQsIHR5cGUsIG9iamVjdE5hbWUsIGRlc2NyaXB0aW9uLCBsYW5ndWFnZSwgc291cmNlUGFja2FnZVVSTCwgY29uZmlndXJhdGlvbiwgcG9saWNpZXMpIHsKICAgICAgICBfY2xhc3NDYWxsQ2hlY2sodGhpcywgUG9saWN5RW5mb3JjZXJEZXNjcmlwdG9yKTsKCiAgICAgICAgX2dldChPYmplY3QuZ2V0UHJvdG90eXBlT2YoUG9saWN5RW5mb3JjZXJEZXNjcmlwdG9yLnByb3RvdHlwZSksICdjb25zdHJ1Y3RvcicsIHRoaXMpLmNhbGwodGhpcywgZ3VpZCwgdHlwZSwgb2JqZWN0TmFtZSwgZGVzY3JpcHRpb24sIGxhbmd1YWdlLCBzb3VyY2VQYWNrYWdlVVJMKTsKCiAgICAgICAgdGhpcy5fY29uZmlndXJhdGlvbiA9IGNvbmZpZ3VyYXRpb247CiAgICAgICAgdGhpcy5fcG9saWNpZXMgPSBwb2xpY2llczsKICAgIH0KCiAgICBfY3JlYXRlQ2xhc3MoUG9saWN5RW5mb3JjZXJEZXNjcmlwdG9yLCBbewogICAgICAgIGtleTogJ2NvbmZpZ3VyYXRpb24nLAogICAgICAgIGdldDogZnVuY3Rpb24gZ2V0KCkgewogICAgICAgICAgICByZXR1cm4gdGhpcy5fY29uZmlndXJhdGlvbjsKICAgICAgICB9LAogICAgICAgIHNldDogZnVuY3Rpb24gc2V0KGNvbmZpZ3VyYXRpb24pIHsKICAgICAgICAgICAgdGhpcy5fY29uZmlndXJhdGlvbiA9IGNvbmZpZ3VyYXRpb247CiAgICAgICAgfQogICAgfSwgewogICAgICAgIGtleTogJ3BvbGljaWVzJywKICAgICAgICBnZXQ6IGZ1bmN0aW9uIGdldCgpIHsKICAgICAgICAgICAgcmV0dXJuIHRoaXMuX3BvbGljaWVzOwogICAgICAgIH0sCiAgICAgICAgc2V0OiBmdW5jdGlvbiBzZXQocG9saWNpZXMpIHsKICAgICAgICAgICAgdGhpcy5fcG9saWNpZXMgPSBwb2xpY2llczsKICAgICAgICB9CiAgICB9XSk7CgogICAgcmV0dXJuIFBvbGljeUVuZm9yY2VyRGVzY3JpcHRvcjsKfSkoX0NhdGFsb2d1ZURhdGFPYmplY3QzWydkZWZhdWx0J10pOwoKZXhwb3J0c1snZGVmYXVsdCddID0gUG9saWN5RW5mb3JjZXJEZXNjcmlwdG9yOwptb2R1bGUuZXhwb3J0cyA9IGV4cG9ydHNbJ2RlZmF1bHQnXTsKCn0seyIuL0NhdGFsb2d1ZURhdGFPYmplY3QiOjR9XSwxMDpbZnVuY3Rpb24ocmVxdWlyZSxtb2R1bGUsZXhwb3J0cyl7Ci8qKgogKiBDcmVhdGVkIGJ5IGFtbyBvbiAxNC8xMS8yMDE1LgogKi8KCid1c2Ugc3RyaWN0JzsKCk9iamVjdC5kZWZpbmVQcm9wZXJ0eShleHBvcnRzLCAnX19lc01vZHVsZScsIHsKICAgIHZhbHVlOiB0cnVlCn0pOwoKdmFyIF9jcmVhdGVDbGFzcyA9IChmdW5jdGlvbiAoKSB7IGZ1bmN0aW9uIGRlZmluZVByb3BlcnRpZXModGFyZ2V0LCBwcm9wcykgeyBmb3IgKHZhciBpID0gMDsgaSA8IHByb3BzLmxlbmd0aDsgaSsrKSB7IHZhciBkZXNjcmlwdG9yID0gcHJvcHNbaV07IGRlc2NyaXB0b3IuZW51bWVyYWJsZSA9IGRlc2NyaXB0b3IuZW51bWVyYWJsZSB8fCBmYWxzZTsgZGVzY3JpcHRvci5jb25maWd1cmFibGUgPSB0cnVlOyBpZiAoJ3ZhbHVlJyBpbiBkZXNjcmlwdG9yKSBkZXNjcmlwdG9yLndyaXRhYmxlID0gdHJ1ZTsgT2JqZWN0LmRlZmluZVByb3BlcnR5KHRhcmdldCwgZGVzY3JpcHRvci5rZXksIGRlc2NyaXB0b3IpOyB9IH0gcmV0dXJuIGZ1bmN0aW9uIChDb25zdHJ1Y3RvciwgcHJvdG9Qcm9wcywgc3RhdGljUHJvcHMpIHsgaWYgKHByb3RvUHJvcHMpIGRlZmluZVByb3BlcnRpZXMoQ29uc3RydWN0b3IucHJvdG90eXBlLCBwcm90b1Byb3BzKTsgaWYgKHN0YXRpY1Byb3BzKSBkZWZpbmVQcm9wZXJ0aWVzKENvbnN0cnVjdG9yLCBzdGF0aWNQcm9wcyk7IHJldHVybiBDb25zdHJ1Y3RvcjsgfTsgfSkoKTsKCnZhciBfZ2V0ID0gZnVuY3Rpb24gZ2V0KF94LCBfeDIsIF94MykgeyB2YXIgX2FnYWluID0gdHJ1ZTsgX2Z1bmN0aW9uOiB3aGlsZSAoX2FnYWluKSB7IHZhciBvYmplY3QgPSBfeCwgcHJvcGVydHkgPSBfeDIsIHJlY2VpdmVyID0gX3gzOyBfYWdhaW4gPSBmYWxzZTsgaWYgKG9iamVjdCA9PT0gbnVsbCkgb2JqZWN0ID0gRnVuY3Rpb24ucHJvdG90eXBlOyB2YXIgZGVzYyA9IE9iamVjdC5nZXRPd25Qcm9wZXJ0eURlc2NyaXB0b3Iob2JqZWN0LCBwcm9wZXJ0eSk7IGlmIChkZXNjID09PSB1bmRlZmluZWQpIHsgdmFyIHBhcmVudCA9IE9iamVjdC5nZXRQcm90b3R5cGVPZihvYmplY3QpOyBpZiAocGFyZW50ID09PSBudWxsKSB7IHJldHVybiB1bmRlZmluZWQ7IH0gZWxzZSB7IF94ID0gcGFyZW50OyBfeDIgPSBwcm9wZXJ0eTsgX3gzID0gcmVjZWl2ZXI7IF9hZ2FpbiA9IHRydWU7IGRlc2MgPSBwYXJlbnQgPSB1bmRlZmluZWQ7IGNvbnRpbnVlIF9mdW5jdGlvbjsgfSB9IGVsc2UgaWYgKCd2YWx1ZScgaW4gZGVzYykgeyByZXR1cm4gZGVzYy52YWx1ZTsgfSBlbHNlIHsgdmFyIGdldHRlciA9IGRlc2MuZ2V0OyBpZiAoZ2V0dGVyID09PSB1bmRlZmluZWQpIHsgcmV0dXJuIHVuZGVmaW5lZDsgfSByZXR1cm4gZ2V0dGVyLmNhbGwocmVjZWl2ZXIpOyB9IH0gfTsKCmZ1bmN0aW9uIF9pbnRlcm9wUmVxdWlyZURlZmF1bHQob2JqKSB7IHJldHVybiBvYmogJiYgb2JqLl9fZXNNb2R1bGUgPyBvYmogOiB7ICdkZWZhdWx0Jzogb2JqIH07IH0KCmZ1bmN0aW9uIF9jbGFzc0NhbGxDaGVjayhpbnN0YW5jZSwgQ29uc3RydWN0b3IpIHsgaWYgKCEoaW5zdGFuY2UgaW5zdGFuY2VvZiBDb25zdHJ1Y3RvcikpIHsgdGhyb3cgbmV3IFR5cGVFcnJvcignQ2Fubm90IGNhbGwgYSBjbGFzcyBhcyBhIGZ1bmN0aW9uJyk7IH0gfQoKZnVuY3Rpb24gX2luaGVyaXRzKHN1YkNsYXNzLCBzdXBlckNsYXNzKSB7IGlmICh0eXBlb2Ygc3VwZXJDbGFzcyAhPT0gJ2Z1bmN0aW9uJyAmJiBzdXBlckNsYXNzICE9PSBudWxsKSB7IHRocm93IG5ldyBUeXBlRXJyb3IoJ1N1cGVyIGV4cHJlc3Npb24gbXVzdCBlaXRoZXIgYmUgbnVsbCBvciBhIGZ1bmN0aW9uLCBub3QgJyArIHR5cGVvZiBzdXBlckNsYXNzKTsgfSBzdWJDbGFzcy5wcm90b3R5cGUgPSBPYmplY3QuY3JlYXRlKHN1cGVyQ2xhc3MgJiYgc3VwZXJDbGFzcy5wcm90b3R5cGUsIHsgY29uc3RydWN0b3I6IHsgdmFsdWU6IHN1YkNsYXNzLCBlbnVtZXJhYmxlOiBmYWxzZSwgd3JpdGFibGU6IHRydWUsIGNvbmZpZ3VyYWJsZTogdHJ1ZSB9IH0pOyBpZiAoc3VwZXJDbGFzcykgT2JqZWN0LnNldFByb3RvdHlwZU9mID8gT2JqZWN0LnNldFByb3RvdHlwZU9mKHN1YkNsYXNzLCBzdXBlckNsYXNzKSA6IHN1YkNsYXNzLl9fcHJvdG9fXyA9IHN1cGVyQ2xhc3M7IH0KCnZhciBfQ2F0YWxvZ3VlRGF0YU9iamVjdDIgPSByZXF1aXJlKCcuL0NhdGFsb2d1ZURhdGFPYmplY3QnKTsKCnZhciBfQ2F0YWxvZ3VlRGF0YU9iamVjdDMgPSBfaW50ZXJvcFJlcXVpcmVEZWZhdWx0KF9DYXRhbG9ndWVEYXRhT2JqZWN0Mik7Cgp2YXIgX0h5cGVydHlSdW50aW1lRGVzY3JpcHRvciA9IHJlcXVpcmUoJy4vSHlwZXJ0eVJ1bnRpbWVEZXNjcmlwdG9yJyk7Cgp2YXIgX0h5cGVydHlSdW50aW1lRGVzY3JpcHRvcjIgPSBfaW50ZXJvcFJlcXVpcmVEZWZhdWx0KF9IeXBlcnR5UnVudGltZURlc2NyaXB0b3IpOwoKdmFyIFByb3RvY29sU3R1YkRlc2NyaXB0b3IgPSAoZnVuY3Rpb24gKF9DYXRhbG9ndWVEYXRhT2JqZWN0KSB7CiAgICBfaW5oZXJpdHMoUHJvdG9jb2xTdHViRGVzY3JpcHRvciwgX0NhdGFsb2d1ZURhdGFPYmplY3QpOwoKICAgIGZ1bmN0aW9uIFByb3RvY29sU3R1YkRlc2NyaXB0b3IoZ3VpZCwgdHlwZSwgb2JqZWN0TmFtZSwgZGVzY3JpcHRpb24sIGxhbmd1YWdlLCBzb3VyY2VQYWNrYWdlVVJMLCBtZXNzYWdlU2NoZW1hcywgY29uZmlndXJhdGlvbkxpc3QsIGNvbnN0cmFpbnRMaXN0KSB7CiAgICAgICAgX2NsYXNzQ2FsbENoZWNrKHRoaXMsIFByb3RvY29sU3R1YkRlc2NyaXB0b3IpOwoKICAgICAgICBfZ2V0KE9iamVjdC5nZXRQcm90b3R5cGVPZihQcm90b2NvbFN0dWJEZXNjcmlwdG9yLnByb3RvdHlwZSksICdjb25zdHJ1Y3RvcicsIHRoaXMpLmNhbGwodGhpcywgZ3VpZCwgdHlwZSwgb2JqZWN0TmFtZSwgZGVzY3JpcHRpb24sIGxhbmd1YWdlLCBzb3VyY2VQYWNrYWdlVVJMKTsKCiAgICAgICAgdGhpcy5fbWVzc2FnZVNjaGVtYXMgPSBtZXNzYWdlU2NoZW1hczsKICAgICAgICBpZiAoY29uZmlndXJhdGlvbkxpc3QpIHRoaXMuX2NvbmZpZ3VyYXRpb25MaXN0ID0gY29uZmlndXJhdGlvbkxpc3Q7ZWxzZSB0aGlzLl9jb25maWd1cmF0aW9uTGlzdCA9IHt9OwoKICAgICAgICBpZiAoY29uc3RyYWludExpc3QpIHRoaXMuX2NvbnN0cmFpbnRzTGlzdCA9IGNvbnN0cmFpbnRMaXN0O2Vsc2UgdGhpcy5fY29uc3RyYWludHNMaXN0ID0ge307CiAgICB9CgogICAgX2NyZWF0ZUNsYXNzKFByb3RvY29sU3R1YkRlc2NyaXB0b3IsIFt7CiAgICAgICAga2V5OiAnbWVzc2FnZVNjaGVtYXMnLAogICAgICAgIGdldDogZnVuY3Rpb24gZ2V0KCkgewogICAgICAgICAgICByZXR1cm4gdGhpcy5fbWVzc2FnZVNjaGVtYXM7CiAgICAgICAgfQogICAgfSwgewogICAgICAgIGtleTogJ2NvbnN0cmFpbnRzTGlzdCcsCiAgICAgICAgZ2V0OiBmdW5jdGlvbiBnZXQoKSB7CiAgICAgICAgICAgIHJldHVybiB0aGlzLl9jb25zdHJhaW50c0xpc3Q7CiAgICAgICAgfQogICAgfSwgewogICAgICAgIGtleTogJ2NvbmZpZ3VyYXRpb25MaXN0JywKICAgICAgICBnZXQ6IGZ1bmN0aW9uIGdldCgpIHsKICAgICAgICAgICAgcmV0dXJuIHRoaXMuX2NvbmZpZ3VyYXRpb25MaXN0OwogICAgICAgIH0KICAgIH1dKTsKCiAgICByZXR1cm4gUHJvdG9jb2xTdHViRGVzY3JpcHRvcjsKfSkoX0NhdGFsb2d1ZURhdGFPYmplY3QzWydkZWZhdWx0J10pOwoKZXhwb3J0c1snZGVmYXVsdCddID0gUHJvdG9jb2xTdHViRGVzY3JpcHRvcjsKbW9kdWxlLmV4cG9ydHMgPSBleHBvcnRzWydkZWZhdWx0J107Cgp9LHsiLi9DYXRhbG9ndWVEYXRhT2JqZWN0Ijo0LCIuL0h5cGVydHlSdW50aW1lRGVzY3JpcHRvciI6OH1dLDExOltmdW5jdGlvbihyZXF1aXJlLG1vZHVsZSxleHBvcnRzKXsKLyoqCiAqIENyZWF0ZWQgYnkgYW1vIG9uIDE0LzExLzIwMTUuCiAqLwoidXNlIHN0cmljdCI7CgpPYmplY3QuZGVmaW5lUHJvcGVydHkoZXhwb3J0cywgIl9fZXNNb2R1bGUiLCB7CiAgICB2YWx1ZTogdHJ1ZQp9KTsKCnZhciBfY3JlYXRlQ2xhc3MgPSAoZnVuY3Rpb24gKCkgeyBmdW5jdGlvbiBkZWZpbmVQcm9wZXJ0aWVzKHRhcmdldCwgcHJvcHMpIHsgZm9yICh2YXIgaSA9IDA7IGkgPCBwcm9wcy5sZW5ndGg7IGkrKykgeyB2YXIgZGVzY3JpcHRvciA9IHByb3BzW2ldOyBkZXNjcmlwdG9yLmVudW1lcmFibGUgPSBkZXNjcmlwdG9yLmVudW1lcmFibGUgfHwgZmFsc2U7IGRlc2NyaXB0b3IuY29uZmlndXJhYmxlID0gdHJ1ZTsgaWYgKCJ2YWx1ZSIgaW4gZGVzY3JpcHRvcikgZGVzY3JpcHRvci53cml0YWJsZSA9IHRydWU7IE9iamVjdC5kZWZpbmVQcm9wZXJ0eSh0YXJnZXQsIGRlc2NyaXB0b3Iua2V5LCBkZXNjcmlwdG9yKTsgfSB9IHJldHVybiBmdW5jdGlvbiAoQ29uc3RydWN0b3IsIHByb3RvUHJvcHMsIHN0YXRpY1Byb3BzKSB7IGlmIChwcm90b1Byb3BzKSBkZWZpbmVQcm9wZXJ0aWVzKENvbnN0cnVjdG9yLnByb3RvdHlwZSwgcHJvdG9Qcm9wcyk7IGlmIChzdGF0aWNQcm9wcykgZGVmaW5lUHJvcGVydGllcyhDb25zdHJ1Y3Rvciwgc3RhdGljUHJvcHMpOyByZXR1cm4gQ29uc3RydWN0b3I7IH07IH0pKCk7CgpmdW5jdGlvbiBfY2xhc3NDYWxsQ2hlY2soaW5zdGFuY2UsIENvbnN0cnVjdG9yKSB7IGlmICghKGluc3RhbmNlIGluc3RhbmNlb2YgQ29uc3RydWN0b3IpKSB7IHRocm93IG5ldyBUeXBlRXJyb3IoIkNhbm5vdCBjYWxsIGEgY2xhc3MgYXMgYSBmdW5jdGlvbiIpOyB9IH0KCnZhciBTb3VyY2VQYWNrYWdlID0gKGZ1bmN0aW9uICgpIHsKICAgIGZ1bmN0aW9uIFNvdXJjZVBhY2thZ2Uoc291cmNlQ29kZSwgc291cmNlQ29kZUNsYXNzbmFtZSkgewogICAgICAgIF9jbGFzc0NhbGxDaGVjayh0aGlzLCBTb3VyY2VQYWNrYWdlKTsKCiAgICAgICAgdGhpcy5fc291cmNlQ29kZSA9IHNvdXJjZUNvZGU7CiAgICAgICAgdGhpcy5fc291cmNlQ29kZUNsYXNzbmFtZSA9IHNvdXJjZUNvZGVDbGFzc25hbWU7CgogICAgICAgIHRoaXMuX2VuY29kaW5nID0gbnVsbDsKICAgICAgICB0aGlzLl9zaWduYXR1cmUgPSBudWxsOwogICAgfQoKICAgIF9jcmVhdGVDbGFzcyhTb3VyY2VQYWNrYWdlLCBbewogICAgICAgIGtleTogInNvdXJjZUNvZGUiLAogICAgICAgIGdldDogZnVuY3Rpb24gZ2V0KCkgewogICAgICAgICAgICByZXR1cm4gdGhpcy5fc291cmNlQ29kZTsKICAgICAgICB9CiAgICB9LCB7CiAgICAgICAga2V5OiAic291cmNlQ29kZUNsYXNzbmFtZSIsCiAgICAgICAgZ2V0OiBmdW5jdGlvbiBnZXQoKSB7CiAgICAgICAgICAgIHJldHVybiB0aGlzLl9zb3VyY2VDb2RlOwogICAgICAgIH0KICAgIH0sIHsKICAgICAgICBrZXk6ICJlbmNvZGluZyIsCiAgICAgICAgZ2V0OiBmdW5jdGlvbiBnZXQoKSB7CiAgICAgICAgICAgIHJldHVybiB0aGlzLl9lbmNvZGluZzsKICAgICAgICB9LAogICAgICAgIHNldDogZnVuY3Rpb24gc2V0KGVuY29kaW5nKSB7CiAgICAgICAgICAgIGlmIChlbmNvZGluZykgdGhpcy5fZW5jb2RpbmcgPSBlbmNvZGluZzsKICAgICAgICB9CiAgICB9LCB7CiAgICAgICAga2V5OiAic2lnbmF0dXJlIiwKICAgICAgICBnZXQ6IGZ1bmN0aW9uIGdldCgpIHsKICAgICAgICAgICAgcmV0dXJuIHRoaXMuX3NpZ25hdHVyZTsKICAgICAgICB9LAogICAgICAgIHNldDogZnVuY3Rpb24gc2V0KHNpZ24pIHsKICAgICAgICAgICAgaWYgKHNpZ24pIHRoaXMuX3NpZ25hdHVyZSA9IHNpZ247CiAgICAgICAgfQogICAgfV0pOwoKICAgIHJldHVybiBTb3VyY2VQYWNrYWdlOwp9KSgpOwoKZXhwb3J0c1siZGVmYXVsdCJdID0gU291cmNlUGFja2FnZTsKbW9kdWxlLmV4cG9ydHMgPSBleHBvcnRzWyJkZWZhdWx0Il07Cgp9LHt9XSwxMjpbZnVuY3Rpb24ocmVxdWlyZSxtb2R1bGUsZXhwb3J0cyl7Ci8qIGpzaGludCB1bmRlZjogdHJ1ZSAqLwovKiBnbG9iYWxzIFJUQ1BlZXJDb25uZWN0aW9uICovCi8qIGdsb2JhbHMgUlRDU2Vzc2lvbkRlc2NyaXB0aW9uICovCi8qIGdsb2JhbHMgUlRDSWNlQ2FuZGlkYXRlICovCgondXNlIHN0cmljdCc7CgpPYmplY3QuZGVmaW5lUHJvcGVydHkoZXhwb3J0cywgJ19fZXNNb2R1bGUnLCB7CiAgdmFsdWU6IHRydWUKfSk7Cgp2YXIgX2NyZWF0ZUNsYXNzID0gKGZ1bmN0aW9uICgpIHsgZnVuY3Rpb24gZGVmaW5lUHJvcGVydGllcyh0YXJnZXQsIHByb3BzKSB7IGZvciAodmFyIGkgPSAwOyBpIDwgcHJvcHMubGVuZ3RoOyBpKyspIHsgdmFyIGRlc2NyaXB0b3IgPSBwcm9wc1tpXTsgZGVzY3JpcHRvci5lbnVtZXJhYmxlID0gZGVzY3JpcHRvci5lbnVtZXJhYmxlIHx8IGZhbHNlOyBkZXNjcmlwdG9yLmNvbmZpZ3VyYWJsZSA9IHRydWU7IGlmICgndmFsdWUnIGluIGRlc2NyaXB0b3IpIGRlc2NyaXB0b3Iud3JpdGFibGUgPSB0cnVlOyBPYmplY3QuZGVmaW5lUHJvcGVydHkodGFyZ2V0LCBkZXNjcmlwdG9yLmtleSwgZGVzY3JpcHRvcik7IH0gfSByZXR1cm4gZnVuY3Rpb24gKENvbnN0cnVjdG9yLCBwcm90b1Byb3BzLCBzdGF0aWNQcm9wcykgeyBpZiAocHJvdG9Qcm9wcykgZGVmaW5lUHJvcGVydGllcyhDb25zdHJ1Y3Rvci5wcm90b3R5cGUsIHByb3RvUHJvcHMpOyBpZiAoc3RhdGljUHJvcHMpIGRlZmluZVByb3BlcnRpZXMoQ29uc3RydWN0b3IsIHN0YXRpY1Byb3BzKTsgcmV0dXJuIENvbnN0cnVjdG9yOyB9OyB9KSgpOwoKdmFyIF9nZXQgPSBmdW5jdGlvbiBnZXQoX3gsIF94MiwgX3gzKSB7IHZhciBfYWdhaW4gPSB0cnVlOyBfZnVuY3Rpb246IHdoaWxlIChfYWdhaW4pIHsgdmFyIG9iamVjdCA9IF94LCBwcm9wZXJ0eSA9IF94MiwgcmVjZWl2ZXIgPSBfeDM7IF9hZ2FpbiA9IGZhbHNlOyBpZiAob2JqZWN0ID09PSBudWxsKSBvYmplY3QgPSBGdW5jdGlvbi5wcm90b3R5cGU7IHZhciBkZXNjID0gT2JqZWN0LmdldE93blByb3BlcnR5RGVzY3JpcHRvcihvYmplY3QsIHByb3BlcnR5KTsgaWYgKGRlc2MgPT09IHVuZGVmaW5lZCkgeyB2YXIgcGFyZW50ID0gT2JqZWN0LmdldFByb3RvdHlwZU9mKG9iamVjdCk7IGlmIChwYXJlbnQgPT09IG51bGwpIHsgcmV0dXJuIHVuZGVmaW5lZDsgfSBlbHNlIHsgX3ggPSBwYXJlbnQ7IF94MiA9IHByb3BlcnR5OyBfeDMgPSByZWNlaXZlcjsgX2FnYWluID0gdHJ1ZTsgZGVzYyA9IHBhcmVudCA9IHVuZGVmaW5lZDsgY29udGludWUgX2Z1bmN0aW9uOyB9IH0gZWxzZSBpZiAoJ3ZhbHVlJyBpbiBkZXNjKSB7IHJldHVybiBkZXNjLnZhbHVlOyB9IGVsc2UgeyB2YXIgZ2V0dGVyID0gZGVzYy5nZXQ7IGlmIChnZXR0ZXIgPT09IHVuZGVmaW5lZCkgeyByZXR1cm4gdW5kZWZpbmVkOyB9IHJldHVybiBnZXR0ZXIuY2FsbChyZWNlaXZlcik7IH0gfSB9OwoKZnVuY3Rpb24gX2ludGVyb3BSZXF1aXJlRGVmYXVsdChvYmopIHsgcmV0dXJuIG9iaiAmJiBvYmouX19lc01vZHVsZSA/IG9iaiA6IHsgJ2RlZmF1bHQnOiBvYmogfTsgfQoKZnVuY3Rpb24gX2NsYXNzQ2FsbENoZWNrKGluc3RhbmNlLCBDb25zdHJ1Y3RvcikgeyBpZiAoIShpbnN0YW5jZSBpbnN0YW5jZW9mIENvbnN0cnVjdG9yKSkgeyB0aHJvdyBuZXcgVHlwZUVycm9yKCdDYW5ub3QgY2FsbCBhIGNsYXNzIGFzIGEgZnVuY3Rpb24nKTsgfSB9CgpmdW5jdGlvbiBfaW5oZXJpdHMoc3ViQ2xhc3MsIHN1cGVyQ2xhc3MpIHsgaWYgKHR5cGVvZiBzdXBlckNsYXNzICE9PSAnZnVuY3Rpb24nICYmIHN1cGVyQ2xhc3MgIT09IG51bGwpIHsgdGhyb3cgbmV3IFR5cGVFcnJvcignU3VwZXIgZXhwcmVzc2lvbiBtdXN0IGVpdGhlciBiZSBudWxsIG9yIGEgZnVuY3Rpb24sIG5vdCAnICsgdHlwZW9mIHN1cGVyQ2xhc3MpOyB9IHN1YkNsYXNzLnByb3RvdHlwZSA9IE9iamVjdC5jcmVhdGUoc3VwZXJDbGFzcyAmJiBzdXBlckNsYXNzLnByb3RvdHlwZSwgeyBjb25zdHJ1Y3RvcjogeyB2YWx1ZTogc3ViQ2xhc3MsIGVudW1lcmFibGU6IGZhbHNlLCB3cml0YWJsZTogdHJ1ZSwgY29uZmlndXJhYmxlOiB0cnVlIH0gfSk7IGlmIChzdXBlckNsYXNzKSBPYmplY3Quc2V0UHJvdG90eXBlT2YgPyBPYmplY3Quc2V0UHJvdG90eXBlT2Yoc3ViQ2xhc3MsIHN1cGVyQ2xhc3MpIDogc3ViQ2xhc3MuX19wcm90b19fID0gc3VwZXJDbGFzczsgfQoKcmVxdWlyZSgnd2VicnRjLWFkYXB0ZXItdGVzdCcpOwoKdmFyIF91dGlsc0V2ZW50RW1pdHRlciA9IHJlcXVpcmUoJy4uL3V0aWxzL0V2ZW50RW1pdHRlcicpOwoKdmFyIF91dGlsc0V2ZW50RW1pdHRlcjIgPSBfaW50ZXJvcFJlcXVpcmVEZWZhdWx0KF91dGlsc0V2ZW50RW1pdHRlcik7Cgp2YXIgQ29ubmVjdGlvbkNvbnRyb2xsZXIgPSAoZnVuY3Rpb24gKF9FdmVudEVtaXR0ZXIpIHsKICBfaW5oZXJpdHMoQ29ubmVjdGlvbkNvbnRyb2xsZXIsIF9FdmVudEVtaXR0ZXIpOwoKICBmdW5jdGlvbiBDb25uZWN0aW9uQ29udHJvbGxlcigpIHsKICAgIF9jbGFzc0NhbGxDaGVjayh0aGlzLCBDb25uZWN0aW9uQ29udHJvbGxlcik7CgogICAgX2dldChPYmplY3QuZ2V0UHJvdG90eXBlT2YoQ29ubmVjdGlvbkNvbnRyb2xsZXIucHJvdG90eXBlKSwgJ2NvbnN0cnVjdG9yJywgdGhpcykuY2FsbCh0aGlzKTsKCiAgICB2YXIgX3RoaXMgPSB0aGlzOwoKICAgIF90aGlzLm1vZGUgPSAnb2ZmZXInOwoKICAgIF90aGlzLm1lZGlhQ29uc3RyYWludHMgPSB7CiAgICAgIG9wdGlvbmFsOiBbXSwKICAgICAgbWFuZGF0b3J5OiB7CiAgICAgICAgb2ZmZXJUb1JlY2VpdmVBdWRpbzogdHJ1ZSwKICAgICAgICBvZmZlclRvUmVjZWl2ZVZpZGVvOiB0cnVlCiAgICAgIH0KICAgIH07CgogICAgLy8gUHJlcGFyZSB0aGUgUGVlckNvbm5lY3Rpb24KICAgIHZhciBwZWVyQ29ubmVjdGlvbiA9IG5ldyBSVENQZWVyQ29ubmVjdGlvbigpOwoKICAgIHBlZXJDb25uZWN0aW9uLmFkZEV2ZW50TGlzdGVuZXIoJ3NpZ25hbGluZ3N0YXRlY2hhbmdlJywgZnVuY3Rpb24gKGV2ZW50KSB7CgogICAgICBjb25zb2xlLmluZm8oJ3NpZ25hbGluZ3N0YXRlY2hhbmdlJywgZXZlbnQpOwoKICAgICAgaWYgKGV2ZW50LmN1cnJlbnRUYXJnZXQuc2lnbmFsaW5nU3RhdGUgPT09ICdoYXZlLXJlbW90ZS1vZmZlcicpIHsKICAgICAgICBfdGhpcy5tb2RlID0gJ2Fuc3dlcic7CiAgICAgICAgX3RoaXMudHJpZ2dlcignY29udHJvbGxlcjpzdGF0ZTpjaGFuZ2UnLCBfdGhpcy5tb2RlKTsKICAgICAgfQoKICAgICAgaWYgKGV2ZW50LmN1cnJlbnRUYXJnZXQuc2lnbmFsaW5nU3RhdGUgPT09ICdoYXZlLWxvY2FsLW9mZmVyJykgewogICAgICAgIF90aGlzLnRyaWdnZXIoJ2NvbnRyb2xsZXI6c3RhdGU6Y2hhbmdlJywgX3RoaXMubW9kZSk7CiAgICAgIH0KICAgIH0pOwoKICAgIHBlZXJDb25uZWN0aW9uLmFkZEV2ZW50TGlzdGVuZXIoJ2ljZWNvbm5lY3Rpb25zdGF0ZWNoYW5nZScsIGZ1bmN0aW9uIChldmVudCkgewogICAgICBjb25zb2xlLmluZm8oZXZlbnQuY3VycmVudFRhcmdldC5pY2VDb25uZWN0aW9uU3RhdGUpOwogICAgfSk7CgogICAgcGVlckNvbm5lY3Rpb24uYWRkRXZlbnRMaXN0ZW5lcignaWNlY2FuZGlkYXRlJywgZnVuY3Rpb24gKGV2ZW50KSB7CgogICAgICBpZiAoIWV2ZW50LmNhbmRpZGF0ZSkgcmV0dXJuOwoKICAgICAgdmFyIGRhdGEgPSBfdGhpcy5fY29ubmVjdGlvbkRhdGFPYmplY3RSZXBvcnRlci5kYXRhOwogICAgICBkYXRhLmljZSA9IHsKICAgICAgICB0eXBlOiAnY2FuZGlkYXRlJywKICAgICAgICBjYW5kaWRhdGU6IGV2ZW50LmNhbmRpZGF0ZS5jYW5kaWRhdGUsCiAgICAgICAgc2RwTWlkOiBldmVudC5jYW5kaWRhdGUuc2RwTWlkLAogICAgICAgIHNkcE1MaW5lSW5kZXg6IGV2ZW50LmNhbmRpZGF0ZS5zZHBNTGluZUluZGV4CiAgICAgIH07CiAgICB9KTsKCiAgICAvLyBBZGQgc3RyZWFtIHRvIFBlZXJDb25uZWN0aW9uCiAgICBwZWVyQ29ubmVjdGlvbi5hZGRFdmVudExpc3RlbmVyKCdhZGRzdHJlYW0nLCBmdW5jdGlvbiAoZXZlbnQpIHsKICAgICAgY29uc29sZS5pbmZvKCdhZGQgc3RyZWFtIGZyb20gbW9kZTogJywgX3RoaXMubW9kZSk7CiAgICAgIF90aGlzLnRyaWdnZXIoJ3N0cmVhbTphZGRlZCcsIFVSTC5jcmVhdGVPYmplY3RVUkwoZXZlbnQuc3RyZWFtKSwgX3RoaXMuY29ubmVjdGlvbkRhdGFPYmplY3RSZXBvcnRlciwgX3RoaXMuY29ubmVjdGlvbkRhdGFPYmplY3RPYnNlcnZlcik7CiAgICB9KTsKCiAgICBfdGhpcy5wZWVyQ29ubmVjdGlvbiA9IHBlZXJDb25uZWN0aW9uOwogIH0KCiAgX2NyZWF0ZUNsYXNzKENvbm5lY3Rpb25Db250cm9sbGVyLCBbewogICAga2V5OiAnZ2V0VXNlck1lZGlhJywKCiAgICAvKioKICAgICAqIEdldCBXZWJSVEMgQVBJIHJlc291cmNlcwogICAgICogQHBhcmFtICB7T2JqZWN0fSAgICAgb3B0aW9ucyBPYmplY3QgY29udGFpbmluZyB0aGUgaW5mb3JtYXRpb24gdGhhdCByZXNvdXJjZXMgd2lsbCBiZSB1c2VkIChjYW1lcmEsIG1pYywgcmVzb2x1dGlvbiwgZXRjKTsKICAgICAqIEByZXR1cm4ge1Byb21pc2V9CiAgICAgKi8KICAgIHZhbHVlOiBmdW5jdGlvbiBnZXRVc2VyTWVkaWEoY29uc3RyYWludHMpIHsKCiAgICAgIHZhciBfdGhpcyA9IHRoaXM7CgogICAgICByZXR1cm4gbmV3IFByb21pc2UoZnVuY3Rpb24gKHJlc29sdmUsIHJlamVjdCkgewoKICAgICAgICBuYXZpZ2F0b3IubWVkaWFEZXZpY2VzLmdldFVzZXJNZWRpYShjb25zdHJhaW50cykudGhlbihmdW5jdGlvbiAobWVkaWFTdHJlYW0pIHsKICAgICAgICAgIF90aGlzLnBlZXJDb25uZWN0aW9uLmFkZFN0cmVhbShtZWRpYVN0cmVhbSk7CiAgICAgICAgICByZXNvbHZlKG1lZGlhU3RyZWFtKTsKICAgICAgICB9KVsnY2F0Y2gnXShmdW5jdGlvbiAocmVhc29uKSB7CiAgICAgICAgICByZWplY3QocmVhc29uKTsKICAgICAgICB9KTsKICAgICAgfSk7CiAgICB9CiAgfSwgewogICAga2V5OiAnY2hhbmdlUGVlckluZm9ybWF0aW9uJywKICAgIHZhbHVlOiBmdW5jdGlvbiBjaGFuZ2VQZWVySW5mb3JtYXRpb24oKSB7CgogICAgICB2YXIgX3RoaXMgPSB0aGlzOwoKICAgICAgX3RoaXMuX2Nvbm5lY3Rpb25EYXRhT2JqZWN0T2JzZXJ2ZXIub25DaGFuZ2UoJyonLCBmdW5jdGlvbiAoZXZlbnQpIHsKICAgICAgICBjb25zb2xlLmRlYnVnKCdtZXNzYWdlOicsIGV2ZW50KTsKCiAgICAgICAgdmFyIG1lc3NhZ2UgPSBldmVudC5kYXRhOwoKICAgICAgICBpZiAobWVzc2FnZS50eXBlID09PSAnb2ZmZXInIHx8IG1lc3NhZ2UudHlwZSA9PT0gJ2Fuc3dlcicpIHsKCiAgICAgICAgICBfdGhpcy5wZWVyQ29ubmVjdGlvbi5zZXRSZW1vdGVEZXNjcmlwdGlvbihuZXcgUlRDU2Vzc2lvbkRlc2NyaXB0aW9uKG1lc3NhZ2UpLCBfdGhpcy5yZW1vdGVEZXNjcmlwdGlvblN1Y2Nlc3MsIF90aGlzLnJlbW90ZURlc2NyaXB0aW9uRXJyb3IpOwogICAgICAgIH0gZWxzZSBpZiAobWVzc2FnZS50eXBlID09PSAnY2FuZGlkYXRlJykgewogICAgICAgICAgX3RoaXMucGVlckNvbm5lY3Rpb24uYWRkSWNlQ2FuZGlkYXRlKG5ldyBSVENJY2VDYW5kaWRhdGUoeyBjYW5kaWRhdGU6IG1lc3NhZ2UuY2FuZGlkYXRlIH0pKTsKICAgICAgICB9CiAgICAgIH0pOwogICAgfQogIH0sIHsKICAgIGtleTogJ3JlbW90ZURlc2NyaXB0aW9uU3VjY2VzcycsCiAgICB2YWx1ZTogZnVuY3Rpb24gcmVtb3RlRGVzY3JpcHRpb25TdWNjZXNzKCkgewogICAgICBjb25zb2xlLmluZm8oJ3JlbW90ZSBzdWNjZXNzJyk7CiAgICB9CiAgfSwgewogICAga2V5OiAncmVtb3RlRGVzY3JpcHRpb25FcnJvcicsCiAgICB2YWx1ZTogZnVuY3Rpb24gcmVtb3RlRGVzY3JpcHRpb25FcnJvcihlcnJvcikgewogICAgICBjb25zb2xlLmVycm9yKCdlcnJvcjogJywgZXJyb3IpOwogICAgfQogIH0sIHsKICAgIGtleTogJ2NyZWF0ZU9mZmVyJywKICAgIHZhbHVlOiBmdW5jdGlvbiBjcmVhdGVPZmZlcigpIHsKICAgICAgdmFyIF90aGlzID0gdGhpczsKCiAgICAgIF90aGlzLnBlZXJDb25uZWN0aW9uLmNyZWF0ZU9mZmVyKGZ1bmN0aW9uIChkZXNjcmlwdGlvbikgewogICAgICAgIF90aGlzLm9uTG9jYWxTZXNzaW9uQ3JlYXRlZChkZXNjcmlwdGlvbik7CiAgICAgIH0sIF90aGlzLmluZm9FcnJvciwgX3RoaXMubWVkaWFDb25zdHJhaW50cyk7CiAgICB9CiAgfSwgewogICAga2V5OiAnY3JlYXRlQW5zd2VyJywKICAgIHZhbHVlOiBmdW5jdGlvbiBjcmVhdGVBbnN3ZXIoKSB7CiAgICAgIHZhciBfdGhpcyA9IHRoaXM7CgogICAgICBfdGhpcy5wZWVyQ29ubmVjdGlvbi5jcmVhdGVBbnN3ZXIoZnVuY3Rpb24gKGRlc2NyaXB0aW9uKSB7CiAgICAgICAgX3RoaXMub25Mb2NhbFNlc3Npb25DcmVhdGVkKGRlc2NyaXB0aW9uKTsKICAgICAgfSwgX3RoaXMuaW5mb0Vycm9yKTsKICAgIH0KICB9LCB7CiAgICBrZXk6ICdvbkxvY2FsU2Vzc2lvbkNyZWF0ZWQnLAogICAgdmFsdWU6IGZ1bmN0aW9uIG9uTG9jYWxTZXNzaW9uQ3JlYXRlZChkZXNjcmlwdGlvbikgewoKICAgICAgdmFyIF90aGlzID0gdGhpczsKICAgICAgdmFyIHBlZXJDb25uZWN0aW9uID0gX3RoaXMucGVlckNvbm5lY3Rpb247CgogICAgICBwZWVyQ29ubmVjdGlvbi5zZXRMb2NhbERlc2NyaXB0aW9uKGRlc2NyaXB0aW9uLCBmdW5jdGlvbiAoKSB7CgogICAgICAgIHZhciBkYXRhID0gX3RoaXMuX2Nvbm5lY3Rpb25EYXRhT2JqZWN0UmVwb3J0ZXIuZGF0YTsKICAgICAgICBkYXRhLnNkcCA9IHsKICAgICAgICAgIHNkcDogZGVzY3JpcHRpb24uc2RwLAogICAgICAgICAgdHlwZTogZGVzY3JpcHRpb24udHlwZQogICAgICAgIH07CiAgICAgIH0sIF90aGlzLmluZm9FcnJvcik7CiAgICB9CiAgfSwgewogICAga2V5OiAnaW5mb0Vycm9yJywKICAgIHZhbHVlOiBmdW5jdGlvbiBpbmZvRXJyb3IoZXJyKSB7CiAgICAgIGNvbnNvbGUuZXJyb3IoZXJyLnRvU3RyaW5nKCksIGVycik7CiAgICB9CgogICAgLyoqCiAgICAgKiBVc2VkIHRvIGFjY2VwdCBhbiBpbmNvbWluZyBjb25uZWN0aW9uIHJlcXVlc3QuCiAgICAgKiBAbWV0aG9kIGFjY2VwdAogICAgICogQHJldHVybiB7UHJvbWlzZX0KICAgICAqLwogIH0sIHsKICAgIGtleTogJ2FjY2VwdCcsCiAgICB2YWx1ZTogZnVuY3Rpb24gYWNjZXB0KCkgewogICAgICAvLyBUT0RPOiBvcHRpbWl6ZSB0aGUgZGlzY29ubmVjdCBmdW5jdGlvbgoKICAgICAgLy8gbGV0IF90aGlzID0gdGhpczsKCiAgICAgIHJldHVybiBuZXcgUHJvbWlzZShmdW5jdGlvbiAocmVzb2x2ZSwgcmVqZWN0KSB7CiAgICAgICAgdHJ5IHsKICAgICAgICAgIHJlc29sdmUodHJ1ZSk7CiAgICAgICAgfSBjYXRjaCAoZSkgewogICAgICAgICAgcmVqZWN0KCdlcnJvciBhY2NlcHRpbmcgY29ubmVjdGlvbicpOwogICAgICAgIH0KICAgICAgfSk7CiAgICB9CgogICAgLyoqCiAgICAqIFVzZWQgdG8gZGVjbGluZSBhbiBpbmNvbWluZyBjb25uZWN0aW9uIHJlcXVlc3QuCiAgICAqIEBtZXRob2QgZGVjbGluZQogICAgKiBAcmV0dXJuIHtQcm9taXNlfQogICAgKi8KICB9LCB7CiAgICBrZXk6ICdkZWNsaW5lJywKICAgIHZhbHVlOiBmdW5jdGlvbiBkZWNsaW5lKCkge30KCiAgICAvKioKICAgICAqIFVzZWQgdG8gY2xvc2UgYW4gZXhpc3RpbmcgY29ubmVjdGlvbiBpbnN0YW5jZS4KICAgICAqIEBtZXRob2QgZGlzY29ubmVjdAogICAgICogQHJldHVybiB7UHJvbWlzZX0KICAgICAqLwogIH0sIHsKICAgIGtleTogJ2Rpc2Nvbm5lY3QnLAogICAgdmFsdWU6IGZ1bmN0aW9uIGRpc2Nvbm5lY3QoKSB7CgogICAgICAvLyBUT0RPOiBvcHRpbWl6ZSB0aGUgZGlzY29ubmVjdCBmdW5jdGlvbgoKICAgICAgdmFyIF90aGlzID0gdGhpczsKCiAgICAgIHJldHVybiBuZXcgUHJvbWlzZShmdW5jdGlvbiAocmVzb2x2ZSwgcmVqZWN0KSB7CgogICAgICAgIHRyeSB7CgogICAgICAgICAgX3RoaXMucGVlckNvbm5lY3Rpb24uY2xvc2UoKTsKCiAgICAgICAgICByZXNvbHZlKHRydWUpOwogICAgICAgIH0gY2F0Y2ggKGUpIHsKICAgICAgICAgIHJlamVjdCgnZXJyb3IgZGlzY29ubmVjdGluZyBjb25uZWN0aW9uJyk7CiAgICAgICAgfQogICAgICB9KTsKICAgIH0KCiAgICAvKioKICAgICAqIFVzZWQgdG8gYWRkL2ludml0ZSBuZXcgcGVlcnMgb24gYW4gZXhpc3RpbmcgY29ubmVjdGlvbiBpbnN0YW5jZSAoZm9yIG11bHRpcGFydHkgY29ubmVjdGlvbnMpLgogICAgICogQG1ldGhvZCBhZGRQZWVyCiAgICAgKiBAcmV0dXJuIHtQcm9taXNlfQogICAgICovCiAgfSwgewogICAga2V5OiAnYWRkUGVlcicsCiAgICB2YWx1ZTogZnVuY3Rpb24gYWRkUGVlcigpIHt9CgogICAgLyoqCiAgICAgKiBVc2VkIHRvIHJlbW92ZSBhIHBlZXIgZnJvbSBhbiBleGlzdGluZyBjb25uZWN0aW9uIGluc3RhbmNlLgogICAgICogQG1ldGhvZCByZW1vdmVQZWVyCiAgICAgKiBAcmV0dXJuIHtQcm9taXNlfQogICAgICovCiAgfSwgewogICAga2V5OiAncmVtb3ZlUGVlcicsCiAgICB2YWx1ZTogZnVuY3Rpb24gcmVtb3ZlUGVlcigpIHt9CiAgfSwgewogICAga2V5OiAnc3RhdHVzJywKICAgIGdldDogZnVuY3Rpb24gZ2V0KCkgewogICAgICB2YXIgX3RoaXMgPSB0aGlzOwogICAgICByZXR1cm4gX3RoaXMuX3N0YXR1czsKICAgIH0KCiAgICAvKioKICAgICogU2V0IHRoZSBjb25uZWN0aW9uRGF0YU9iamVjdCBpbiB0aGUgY29udHJvbGxlcgogICAgKiBAcGFyYW0ge0Nvbm5lY3Rpb25EYXRhT2JqZWN0fSBjb25uZWN0aW9uRGF0YU9iamVjdCAtIGhhdmUgYWxsIGluZm9ybWF0aW9uIGFib3V0IHRoZSBzeW5jaGVyIG9iamVjdDsKICAgICovCiAgfSwgewogICAga2V5OiAnY29ubmVjdGlvbkRhdGFPYmplY3RSZXBvcnRlcicsCiAgICBzZXQ6IGZ1bmN0aW9uIHNldChjb25uZWN0aW9uRGF0YU9iamVjdCkgewogICAgICBpZiAoIWNvbm5lY3Rpb25EYXRhT2JqZWN0KSB0aHJvdyBuZXcgRXJyb3IoJ1RoZSBDb25uZWN0aW9uIERhdGEgT2JqZWN0IGlzIGEgbmVlZGVkIHBhcmFtZXRlcicpOwoKICAgICAgdmFyIF90aGlzID0gdGhpczsKICAgICAgX3RoaXMuX2Nvbm5lY3Rpb25EYXRhT2JqZWN0UmVwb3J0ZXIgPSBjb25uZWN0aW9uRGF0YU9iamVjdDsKCiAgICAgIGNvbm5lY3Rpb25EYXRhT2JqZWN0Lm9uU3Vic2NyaXB0aW9uKGZ1bmN0aW9uIChldmVudCkgewogICAgICAgIGV2ZW50LmFjY2VwdCgpOwoKICAgICAgICBpZiAoX3RoaXMubW9kZSA9PT0gJ29mZmVyJykgewogICAgICAgICAgX3RoaXMuY3JlYXRlT2ZmZXIoKTsKICAgICAgICB9IGVsc2UgewogICAgICAgICAgX3RoaXMuY3JlYXRlQW5zd2VyKCk7CiAgICAgICAgfQogICAgICB9KTsKCiAgICAgIGNvbnNvbGUuaW5mbygnU2V0IGNvbm5lY3Rpb25EYXRhT2JqZWN0OiAnLCBfdGhpcy5fY29ubmVjdGlvbkRhdGFPYmplY3RSZXBvcnRlcik7CiAgICB9LAoKICAgIC8qKgogICAgKiByZXR1cm4gdGhlIGNvbm5lY3Rpb25EYXRhT2JqZWN0IGluIHRoZSBjb250cm9sbGVyCiAgICAqIEByZXR1cm4ge0Nvbm5lY3Rpb25EYXRhT2JqZWN0fSBjb25uZWN0aW9uRGF0YU9iamVjdAogICAgKi8KICAgIGdldDogZnVuY3Rpb24gZ2V0KCkgewogICAgICB2YXIgX3RoaXMgPSB0aGlzOwogICAgICByZXR1cm4gX3RoaXMuX2Nvbm5lY3Rpb25EYXRhT2JqZWN0UmVwb3J0ZXI7CiAgICB9CgogICAgLyoqCiAgICAqIFNldCB0aGUgY29ubmVjdGlvbkRhdGFPYmplY3QgaW4gdGhlIGNvbnRyb2xsZXIKICAgICogQHBhcmFtIHtDb25uZWN0aW9uRGF0YU9iamVjdH0gY29ubmVjdGlvbkRhdGFPYmplY3QgLSBoYXZlIGFsbCBpbmZvcm1hdGlvbiBhYm91dCB0aGUgc3luY2hlciBvYmplY3Q7CiAgICAqLwogIH0sIHsKICAgIGtleTogJ2Nvbm5lY3Rpb25EYXRhT2JqZWN0T2JzZXJ2ZXInLAogICAgc2V0OiBmdW5jdGlvbiBzZXQoY29ubmVjdGlvbkRhdGFPYmplY3QpIHsKICAgICAgaWYgKCFjb25uZWN0aW9uRGF0YU9iamVjdCkgdGhyb3cgbmV3IEVycm9yKCdUaGUgQ29ubmVjdGlvbiBEYXRhIE9iamVjdCBpcyBhIG5lZWRlZCBwYXJhbWV0ZXInKTsKCiAgICAgIHZhciBfdGhpcyA9IHRoaXM7CiAgICAgIF90aGlzLl9jb25uZWN0aW9uRGF0YU9iamVjdE9ic2VydmVyID0gY29ubmVjdGlvbkRhdGFPYmplY3Q7CgogICAgICBjb25uZWN0aW9uRGF0YU9iamVjdC5vbk5vdGlmaWNhdGlvbihmdW5jdGlvbiAoZXZlbnQpIHsKICAgICAgICBjb25zb2xlLmluZm8oJ0Nvbm5lY3Rpb24gRGF0YSBPYmplY3QgT2JzZXJ2ZXIgbm90aWZpY2F0aW9uOiAnLCBldmVudCk7CiAgICAgICAgX3RoaXMudHJpZ2dlcignb246bm90aWZpY2F0aW9uJywgZXZlbnQpOwogICAgICB9KTsKCiAgICAgIGNvbnNvbGUuaW5mbygnU2V0IGNvbm5lY3Rpb25EYXRhT2JqZWN0OiAnLCBfdGhpcy5fY29ubmVjdGlvbkRhdGFPYmplY3RPYnNlcnZlcik7CgogICAgICBfdGhpcy5jaGFuZ2VQZWVySW5mb3JtYXRpb24oKTsKICAgIH0sCgogICAgLyoqCiAgICAqIHJldHVybiB0aGUgY29ubmVjdGlvbkRhdGFPYmplY3QgaW4gdGhlIGNvbnRyb2xsZXIKICAgICogQHJldHVybiB7Q29ubmVjdGlvbkRhdGFPYmplY3R9IGNvbm5lY3Rpb25EYXRhT2JqZWN0CiAgICAqLwogICAgZ2V0OiBmdW5jdGlvbiBnZXQoKSB7CiAgICAgIHZhciBfdGhpcyA9IHRoaXM7CiAgICAgIHJldHVybiBfdGhpcy5fY29ubmVjdGlvbkRhdGFPYmplY3RPYnNlcnZlcjsKICAgIH0KICB9XSk7CgogIHJldHVybiBDb25uZWN0aW9uQ29udHJvbGxlcjsKfSkoX3V0aWxzRXZlbnRFbWl0dGVyMlsnZGVmYXVsdCddKTsKCmV4cG9ydHNbJ2RlZmF1bHQnXSA9IENvbm5lY3Rpb25Db250cm9sbGVyOwptb2R1bGUuZXhwb3J0cyA9IGV4cG9ydHNbJ2RlZmF1bHQnXTsKCn0seyIuLi91dGlscy9FdmVudEVtaXR0ZXIiOjIzLCJ3ZWJydGMtYWRhcHRlci10ZXN0IjoyfV0sMTM6W2Z1bmN0aW9uKHJlcXVpcmUsbW9kdWxlLGV4cG9ydHMpewondXNlIHN0cmljdCc7CgpPYmplY3QuZGVmaW5lUHJvcGVydHkoZXhwb3J0cywgJ19fZXNNb2R1bGUnLCB7CiAgdmFsdWU6IHRydWUKfSk7Cgp2YXIgX2NyZWF0ZUNsYXNzID0gKGZ1bmN0aW9uICgpIHsgZnVuY3Rpb24gZGVmaW5lUHJvcGVydGllcyh0YXJnZXQsIHByb3BzKSB7IGZvciAodmFyIGkgPSAwOyBpIDwgcHJvcHMubGVuZ3RoOyBpKyspIHsgdmFyIGRlc2NyaXB0b3IgPSBwcm9wc1tpXTsgZGVzY3JpcHRvci5lbnVtZXJhYmxlID0gZGVzY3JpcHRvci5lbnVtZXJhYmxlIHx8IGZhbHNlOyBkZXNjcmlwdG9yLmNvbmZpZ3VyYWJsZSA9IHRydWU7IGlmICgndmFsdWUnIGluIGRlc2NyaXB0b3IpIGRlc2NyaXB0b3Iud3JpdGFibGUgPSB0cnVlOyBPYmplY3QuZGVmaW5lUHJvcGVydHkodGFyZ2V0LCBkZXNjcmlwdG9yLmtleSwgZGVzY3JpcHRvcik7IH0gfSByZXR1cm4gZnVuY3Rpb24gKENvbnN0cnVjdG9yLCBwcm90b1Byb3BzLCBzdGF0aWNQcm9wcykgeyBpZiAocHJvdG9Qcm9wcykgZGVmaW5lUHJvcGVydGllcyhDb25zdHJ1Y3Rvci5wcm90b3R5cGUsIHByb3RvUHJvcHMpOyBpZiAoc3RhdGljUHJvcHMpIGRlZmluZVByb3BlcnRpZXMoQ29uc3RydWN0b3IsIHN0YXRpY1Byb3BzKTsgcmV0dXJuIENvbnN0cnVjdG9yOyB9OyB9KSgpOwoKdmFyIF9nZXQgPSBmdW5jdGlvbiBnZXQoX3gsIF94MiwgX3gzKSB7IHZhciBfYWdhaW4gPSB0cnVlOyBfZnVuY3Rpb246IHdoaWxlIChfYWdhaW4pIHsgdmFyIG9iamVjdCA9IF94LCBwcm9wZXJ0eSA9IF94MiwgcmVjZWl2ZXIgPSBfeDM7IF9hZ2FpbiA9IGZhbHNlOyBpZiAob2JqZWN0ID09PSBudWxsKSBvYmplY3QgPSBGdW5jdGlvbi5wcm90b3R5cGU7IHZhciBkZXNjID0gT2JqZWN0LmdldE93blByb3BlcnR5RGVzY3JpcHRvcihvYmplY3QsIHByb3BlcnR5KTsgaWYgKGRlc2MgPT09IHVuZGVmaW5lZCkgeyB2YXIgcGFyZW50ID0gT2JqZWN0LmdldFByb3RvdHlwZU9mKG9iamVjdCk7IGlmIChwYXJlbnQgPT09IG51bGwpIHsgcmV0dXJuIHVuZGVmaW5lZDsgfSBlbHNlIHsgX3ggPSBwYXJlbnQ7IF94MiA9IHByb3BlcnR5OyBfeDMgPSByZWNlaXZlcjsgX2FnYWluID0gdHJ1ZTsgZGVzYyA9IHBhcmVudCA9IHVuZGVmaW5lZDsgY29udGludWUgX2Z1bmN0aW9uOyB9IH0gZWxzZSBpZiAoJ3ZhbHVlJyBpbiBkZXNjKSB7IHJldHVybiBkZXNjLnZhbHVlOyB9IGVsc2UgeyB2YXIgZ2V0dGVyID0gZGVzYy5nZXQ7IGlmIChnZXR0ZXIgPT09IHVuZGVmaW5lZCkgeyByZXR1cm4gdW5kZWZpbmVkOyB9IHJldHVybiBnZXR0ZXIuY2FsbChyZWNlaXZlcik7IH0gfSB9OwoKZnVuY3Rpb24gX2ludGVyb3BSZXF1aXJlRGVmYXVsdChvYmopIHsgcmV0dXJuIG9iaiAmJiBvYmouX19lc01vZHVsZSA/IG9iaiA6IHsgJ2RlZmF1bHQnOiBvYmogfTsgfQoKZnVuY3Rpb24gX2NsYXNzQ2FsbENoZWNrKGluc3RhbmNlLCBDb25zdHJ1Y3RvcikgeyBpZiAoIShpbnN0YW5jZSBpbnN0YW5jZW9mIENvbnN0cnVjdG9yKSkgeyB0aHJvdyBuZXcgVHlwZUVycm9yKCdDYW5ub3QgY2FsbCBhIGNsYXNzIGFzIGEgZnVuY3Rpb24nKTsgfSB9CgpmdW5jdGlvbiBfaW5oZXJpdHMoc3ViQ2xhc3MsIHN1cGVyQ2xhc3MpIHsgaWYgKHR5cGVvZiBzdXBlckNsYXNzICE9PSAnZnVuY3Rpb24nICYmIHN1cGVyQ2xhc3MgIT09IG51bGwpIHsgdGhyb3cgbmV3IFR5cGVFcnJvcignU3VwZXIgZXhwcmVzc2lvbiBtdXN0IGVpdGhlciBiZSBudWxsIG9yIGEgZnVuY3Rpb24sIG5vdCAnICsgdHlwZW9mIHN1cGVyQ2xhc3MpOyB9IHN1YkNsYXNzLnByb3RvdHlwZSA9IE9iamVjdC5jcmVhdGUoc3VwZXJDbGFzcyAmJiBzdXBlckNsYXNzLnByb3RvdHlwZSwgeyBjb25zdHJ1Y3RvcjogeyB2YWx1ZTogc3ViQ2xhc3MsIGVudW1lcmFibGU6IGZhbHNlLCB3cml0YWJsZTogdHJ1ZSwgY29uZmlndXJhYmxlOiB0cnVlIH0gfSk7IGlmIChzdXBlckNsYXNzKSBPYmplY3Quc2V0UHJvdG90eXBlT2YgPyBPYmplY3Quc2V0UHJvdG90eXBlT2Yoc3ViQ2xhc3MsIHN1cGVyQ2xhc3MpIDogc3ViQ2xhc3MuX19wcm90b19fID0gc3VwZXJDbGFzczsgfQoKdmFyIF9Db25uZWN0aW9uQ29udHJvbGxlciA9IHJlcXVpcmUoJy4vQ29ubmVjdGlvbkNvbnRyb2xsZXInKTsKCnZhciBfQ29ubmVjdGlvbkNvbnRyb2xsZXIyID0gX2ludGVyb3BSZXF1aXJlRGVmYXVsdChfQ29ubmVjdGlvbkNvbnRyb2xsZXIpOwoKdmFyIF91dGlsc0V2ZW50RW1pdHRlciA9IHJlcXVpcmUoJy4uL3V0aWxzL0V2ZW50RW1pdHRlcicpOwoKdmFyIF91dGlsc0V2ZW50RW1pdHRlcjIgPSBfaW50ZXJvcFJlcXVpcmVEZWZhdWx0KF91dGlsc0V2ZW50RW1pdHRlcik7CgovKioKICogSHlwZXJ0eSBDb25uZWN0b3I7CiAqIEBhdXRob3IgVml0b3IgU2lsdmEgW3ZpdG9yLXQtc2lsdmFAdGVsZWNvbS5wdF0KICogQHZlcnNpb24gMC4xLjAKICovCgp2YXIgSHlwZXJ0eUNvbm5lY3RvciA9IChmdW5jdGlvbiAoX0V2ZW50RW1pdHRlcikgewogIF9pbmhlcml0cyhIeXBlcnR5Q29ubmVjdG9yLCBfRXZlbnRFbWl0dGVyKTsKCiAgLyoqCiAgICogQ3JlYXRlIGEgbmV3IEh5cGVydHkgQ29ubmVjdG9yCiAgICogQHBhcmFtICB7U3luY2hlcn0gc3luY2hlciAtIFN5bmNoZXIgcHJvdmlkZWQgZnJvbSB0aGUgcnVudGltZSBjb3JlCiAgICovCgogIGZ1bmN0aW9uIEh5cGVydHlDb25uZWN0b3Ioc3luY2hlcikgewogICAgX2NsYXNzQ2FsbENoZWNrKHRoaXMsIEh5cGVydHlDb25uZWN0b3IpOwoKICAgIGlmICghc3luY2hlcikgdGhyb3cgbmV3IEVycm9yKCdUaGUgU3luY2hlciBpcyBhIG5lZWRlZCBwYXJhbWV0ZXInKTsKCiAgICBfZ2V0KE9iamVjdC5nZXRQcm90b3R5cGVPZihIeXBlcnR5Q29ubmVjdG9yLnByb3RvdHlwZSksICdjb25zdHJ1Y3RvcicsIHRoaXMpLmNhbGwodGhpcywgc3luY2hlcik7CgogICAgdmFyIF90aGlzID0gdGhpczsKCiAgICBfdGhpcy5jb250cm9sbGVycyA9IHt9OwoKICAgIC8vIHN0ZXAgMiAtIGh0dHBzOi8vZ2l0aHViLmNvbS9yZVRISU5LLXByb2plY3Qvc2NlbmFyaW8tc2VydmljZS1pbXBsZW1lbnRhdGlvbi90cmVlL21hc3Rlci9kb2NzL2h5cGVydGllcy9jb25uZWN0b3Ijbm90aWZpY2F0aW9uLWFib3V0LWluY29taW5nLWNvbm5lY3Rpb24tcmVxdWVzdAogICAgc3luY2hlci5vbk5vdGlmaWNhdGlvbihmdW5jdGlvbiAoZXZlbnQpIHsKICAgICAgY29uc29sZS5pbmZvKCdjb25uZWN0b3IgaGF2ZSBhbiBub3RpZmljYXRpb246ICcsIGV2ZW50KTsKICAgICAgX3RoaXMuX2F1dG9TdWJzY3JpYmUoZXZlbnQpOwogICAgfSk7CgogICAgX3RoaXMuX3N5bmNoZXIgPSBzeW5jaGVyOwogIH0KCiAgLyoqCiAgICogRXN0YWJsaXNoIGNvbm5lY3Rpb24gd2l0aCBvdGhlciBjbGllbnQgaWRlbnRpZmllcgogICAqIEBwYXJhbSAge0h5cGVydHlVUkx9IEh5cGVydHlVUkwgLSBEZWZpbmUgdGhlIGlkZW50aWZpZXIgb2YgdGhlIG90aGVyIGNvbXBvbmVudAogICAqIEBwYXJhbSAge09iamVjdH0gb3B0aW9ucyAtIE9iamVjdCB3aXRoIG9wdGlvbnMgdG8gaW1wcm92ZSB0aGUgY29ubmVjdAogICAqLwoKICBfY3JlYXRlQ2xhc3MoSHlwZXJ0eUNvbm5lY3RvciwgW3sKICAgIGtleTogJ2Nvbm5lY3QnLAogICAgdmFsdWU6IGZ1bmN0aW9uIGNvbm5lY3QoaHlwZXJ0eVVSTCwgb3B0aW9ucykgewogICAgICAvLyBUT0RPOiBDSGFuZ2UgdGhlIGh5cGVydHlVUkwgZm9yIGEgbGlzdCBvZiBVUkxTCiAgICAgIHZhciBfdGhpcyA9IHRoaXM7CgogICAgICBvcHRpb25zID0gb3B0aW9ucyB8fCB7IHZpZGVvOiB0cnVlLCBhdWRpbzogdHJ1ZSB9OwoKICAgICAgdmFyIGNvbm5lY3Rpb25Db250cm9sbGVyID0gbmV3IF9Db25uZWN0aW9uQ29udHJvbGxlcjJbJ2RlZmF1bHQnXSgpOwoKICAgICAgY29ubmVjdGlvbkNvbnRyb2xsZXIuYWRkRXZlbnRMaXN0ZW5lcignY29udHJvbGxlcjpzdGF0ZTpjaGFuZ2UnLCBmdW5jdGlvbiAoc3RhdGUpIHsKICAgICAgICBpZiAoc3RhdGUgPT09ICdhbnN3ZXInKSB7CiAgICAgICAgICBjb25zb2xlLmluZm8oJ2Nvbm5lY3Rpb24gY29udHJvbGxlciBzdGF0ZTogJywgc3RhdGUpOwogICAgICAgICAgX3RoaXMubW9kZSA9IHN0YXRlOwoKICAgICAgICAgIC8vIF90aGlzLl9hdXRvQ29ubmVjdChfdGhpcy5ub3RpZmljYXRpb25FdmVudC5mcm9tKTsKICAgICAgICB9CiAgICAgIH0pOwoKICAgICAgX3RoaXMuY29udHJvbGxlcnNbaHlwZXJ0eVVSTF0gPSBjb25uZWN0aW9uQ29udHJvbGxlcjsKCiAgICAgIHJldHVybiBuZXcgUHJvbWlzZShmdW5jdGlvbiAocmVzb2x2ZSwgcmVqZWN0KSB7CgogICAgICAgIC8vIFN0ZXAgMyBhbmQgNCAtIGh0dHBzOi8vZ2l0aHViLmNvbS9yZVRISU5LLXByb2plY3Qvc2NlbmFyaW8tc2VydmljZS1pbXBsZW1lbnRhdGlvbi90cmVlL21hc3Rlci9kb2NzL2h5cGVydGllcy9jb25uZWN0b3IjY3JlYXRlLW5ldy1jb25uZWN0aW9uCiAgICAgICAgY29ubmVjdGlvbkNvbnRyb2xsZXIuZ2V0VXNlck1lZGlhKG9wdGlvbnMpLnRoZW4oZnVuY3Rpb24gKGNvbW1SZXNvdXJjZXMpIHsKICAgICAgICAgIGNvbnNvbGUuaW5mbygnR2V0IHdlYlJUQyBjb21tb24gcmVzb3VyY2VzJywgY29tbVJlc291cmNlcywgaHlwZXJ0eVVSTCk7CgogICAgICAgICAgLy8gVE9ETzogT3B0aW1pemUgdGhlIHJlc291cmNlcyB0byBnZXQ7CiAgICAgICAgICAvLyBhbmQgYWRkIGFsbCBvcHRpb25zIGF2YWlsYWJsZTsKICAgICAgICAgIHZhciBpbml0aWFsID0ge307CiAgICAgICAgICBpbml0aWFsLm93bmVyID0gdHJ1ZTsKICAgICAgICAgIGluaXRpYWwudG8gPSBoeXBlcnR5VVJMOwogICAgICAgICAgaW5pdGlhbC5yZXNvdXJjZXMgPSB7CiAgICAgICAgICAgIHZpZGVvOiBvcHRpb25zLnZpZGVvLAogICAgICAgICAgICBhdWRpbzogb3B0aW9ucy5hdWRpbwogICAgICAgICAgfTsKCiAgICAgICAgICAvLyBTdGVwIDUgLSBodHRwczovL2dpdGh1Yi5jb20vcmVUSElOSy1wcm9qZWN0L3NjZW5hcmlvLXNlcnZpY2UtaW1wbGVtZW50YXRpb24vdHJlZS9tYXN0ZXIvZG9jcy9oeXBlcnRpZXMvY29ubmVjdG9yI2NyZWF0ZS1uZXctY29ubmVjdGlvbgogICAgICAgICAgcmV0dXJuIF90aGlzLl9zeW5jaGVyLmNyZWF0ZSh7fSwgW2h5cGVydHlVUkxdLCBpbml0aWFsKTsKICAgICAgICB9KS50aGVuKGZ1bmN0aW9uIChjb25uZWN0aW9uRGF0YU9iamVjdCkgewogICAgICAgICAgY29uc29sZS5pbmZvKCdSZXR1cm4gQ3JlYXRlIENvbm5lY3Rpb24gRGF0YSBPYmplY3QnLCBjb25uZWN0aW9uRGF0YU9iamVjdCk7CgogICAgICAgICAgLy8gU3RlcCAxMSAtIGh0dHBzOi8vZ2l0aHViLmNvbS9yZVRISU5LLXByb2plY3Qvc2NlbmFyaW8tc2VydmljZS1pbXBsZW1lbnRhdGlvbi90cmVlL21hc3Rlci9kb2NzL2h5cGVydGllcy9jb25uZWN0b3IjY3JlYXRlLW5ldy1jb25uZWN0aW9uCiAgICAgICAgICBjb25uZWN0aW9uQ29udHJvbGxlci5jb25uZWN0aW9uRGF0YU9iamVjdFJlcG9ydGVyID0gY29ubmVjdGlvbkRhdGFPYmplY3Q7CgogICAgICAgICAgLy8gU3RlcCAxMiAtIGh0dHBzOi8vZ2l0aHViLmNvbS9yZVRISU5LLXByb2plY3Qvc2NlbmFyaW8tc2VydmljZS1pbXBsZW1lbnRhdGlvbi90cmVlL21hc3Rlci9kb2NzL2h5cGVydGllcy9jb25uZWN0b3IjY3JlYXRlLW5ldy1jb25uZWN0aW9uCiAgICAgICAgICByZXNvbHZlKGNvbm5lY3Rpb25Db250cm9sbGVyKTsKICAgICAgICB9KVsnY2F0Y2gnXShmdW5jdGlvbiAocmVhc29uKSB7CiAgICAgICAgICBjb25zb2xlLmVycm9yKHJlYXNvbik7CiAgICAgICAgICByZWplY3QocmVhc29uKTsKICAgICAgICB9KTsKICAgICAgfSk7CiAgICB9CgogICAgLyoqCiAgICAgKiBBY2NlcHQgdGhlIGluY29taW5nIGNhbGwKICAgICAqIEBtZXRob2QgYWNjZXB0CiAgICAgKiBAcmV0dXJuIHtQcm9taXNlfQogICAgICovCiAgfSwgewogICAga2V5OiAnYWNjZXB0JywKICAgIHZhbHVlOiBmdW5jdGlvbiBhY2NlcHQoKSB7CiAgICAgIHZhciBfdGhpcyA9IHRoaXM7CgogICAgICByZXR1cm4gbmV3IFByb21pc2UoZnVuY3Rpb24gKHJlc29sdmUsIHJlamVjdCkgewoKICAgICAgICB2YXIgb2JqZWN0VVJMID0gX3RoaXMubm90aWZpY2F0aW9uRXZlbnQudXJsOwoKICAgICAgICAvLyBzdGVwIDYgLSBodHRwczovL2dpdGh1Yi5jb20vcmVUSElOSy1wcm9qZWN0L3NjZW5hcmlvLXNlcnZpY2UtaW1wbGVtZW50YXRpb24vdHJlZS9tYXN0ZXIvZG9jcy9oeXBlcnRpZXMvY29ubmVjdG9yI25vdGlmaWNhdGlvbi1hYm91dC1pbmNvbWluZy1jb25uZWN0aW9uLXJlcXVlc3QKICAgICAgICAvLyBhZnRlciB3YWl0aW5nIGZvciBhbiBhbnN3ZXIsIHdlIGNhbiBub3cgc3Vic2NyaWJlIHRoZSBvYmplY3RVUkwKICAgICAgICBfdGhpcy5fc3luY2hlci5zdWJzY3JpYmUob2JqZWN0VVJMKS50aGVuKGZ1bmN0aW9uIChjb25uZWN0aW9uRGF0YU9iamVjdCkgewogICAgICAgICAgY29uc29sZS5pbmZvKCdSZXR1cm4gU3Vic2NyaWJlIENvbm5lY3Rpb24gRGF0YSBPYmplY3QnLCBjb25uZWN0aW9uRGF0YU9iamVjdCk7CgogICAgICAgICAgLy8gc3RlcCA3IGFuZCAxMCAtIGh0dHBzOi8vZ2l0aHViLmNvbS9yZVRISU5LLXByb2plY3Qvc2NlbmFyaW8tc2VydmljZS1pbXBsZW1lbnRhdGlvbi90cmVlL21hc3Rlci9kb2NzL2h5cGVydGllcy9jb25uZWN0b3Ijbm90aWZpY2F0aW9uLWFib3V0LWluY29taW5nLWNvbm5lY3Rpb24tcmVxdWVzdAogICAgICAgICAgX3RoaXMuY29ubmVjdGlvbkNvbnRyb2xsZXIuY29ubmVjdGlvbkRhdGFPYmplY3RPYnNlcnZlciA9IGNvbm5lY3Rpb25EYXRhT2JqZWN0OwogICAgICAgICAgcmVzb2x2ZShfdGhpcy5jb25uZWN0aW9uQ29udHJvbGxlcik7CgogICAgICAgICAgdmFyIHJlc291cmNlcyA9IGNvbm5lY3Rpb25EYXRhT2JqZWN0LmRhdGEucmVzb3VyY2VzOwogICAgICAgICAgcmV0dXJuIF90aGlzLmNvbm5lY3Rpb25Db250cm9sbGVyLmdldFVzZXJNZWRpYShyZXNvdXJjZXMpOwogICAgICAgIH0pLnRoZW4oZnVuY3Rpb24gKGNvbW1SZXNvdXJjZXMpIHsKICAgICAgICAgIGNvbnNvbGUuaW5mbygnR2V0IHdlYlJUQyBjb21tb24gcmVzb3VyY2VzJywgY29tbVJlc291cmNlcyk7CiAgICAgICAgfSlbJ2NhdGNoJ10oZnVuY3Rpb24gKHJlYXNvbikgewogICAgICAgICAgY29uc29sZS5lcnJvcihyZWFzb24pOwogICAgICAgICAgcmVqZWN0KHJlYXNvbik7CiAgICAgICAgfSk7CiAgICAgIH0pOwogICAgfQoKICAgIC8qKgogICAgICogQ29ubmVjdGlvbiBpcyBjbG9zZWQgYnkgbG9jYWwgcGVlciBhbmQgZGlzY29ubmVjdGVkOwogICAgICogQG1ldGhvZCBkaXNjb25uZWN0CiAgICAgKiBAcmV0dXJuIHtQcm9taXNlfQogICAgICovCiAgfSwgewogICAga2V5OiAnZGlzY29ubmVjdCcsCiAgICB2YWx1ZTogZnVuY3Rpb24gZGlzY29ubmVjdCgpIHsKCiAgICAgIHZhciBfdGhpcyA9IHRoaXM7CgogICAgICByZXR1cm4gbmV3IFByb21pc2UoZnVuY3Rpb24gKHJlc29sdmUsIHJlamVjdCkgewoKICAgICAgICBfdGhpcy5jb25uZWN0aW9uQ29udHJvbGxlci5kaXNjb25uZWN0KCkudGhlbihmdW5jdGlvbiAoZGlzY29ubmVjdGVkKSB7CgogICAgICAgICAgY29uc29sZS5pbmZvKCdkaXNjb25uZWN0ZWQ6ICcsIGRpc2Nvbm5lY3RlZCk7CgogICAgICAgICAgcmVzb2x2ZShkaXNjb25uZWN0ZWQpOwogICAgICAgIH0pWydjYXRjaCddKGZ1bmN0aW9uIChyZWFzb24pIHsKICAgICAgICAgIHJlamVjdChyZWFzb24pOwogICAgICAgIH0pOwogICAgICB9KTsKICAgIH0KICB9LCB7CiAgICBrZXk6ICdfYXV0b0Nvbm5lY3QnLAogICAgdmFsdWU6IGZ1bmN0aW9uIF9hdXRvQ29ubmVjdChoeXBlcnR5VVJMKSB7CiAgICAgIHZhciBfdGhpcyA9IHRoaXM7CgogICAgICBfdGhpcy5fc3luY2hlci5jcmVhdGUoe30sIFtoeXBlcnR5VVJMXSwge30pLnRoZW4oZnVuY3Rpb24gKGNvbm5lY3Rpb25EYXRhT2JqZWN0KSB7CiAgICAgICAgY29uc29sZS5pbmZvKCdSZXR1cm4gQ3JlYXRlIENvbm5lY3Rpb24gRGF0YSBPYmplY3QnLCBjb25uZWN0aW9uRGF0YU9iamVjdCk7CiAgICAgICAgX3RoaXMuY29ubmVjdGlvbkNvbnRyb2xsZXIuY29ubmVjdGlvbkRhdGFPYmplY3RSZXBvcnRlciA9IGNvbm5lY3Rpb25EYXRhT2JqZWN0OwogICAgICB9KVsnY2F0Y2gnXShmdW5jdGlvbiAocmVhc29uKSB7CiAgICAgICAgY29uc29sZS5lcnJvcihyZWFzb24pOwogICAgICB9KTsKICAgIH0KICB9LCB7CiAgICBrZXk6ICdfYXV0b1N1YnNjcmliZScsCiAgICB2YWx1ZTogZnVuY3Rpb24gX2F1dG9TdWJzY3JpYmUoZXZlbnQpIHsKICAgICAgdmFyIF90aGlzID0gdGhpczsKICAgICAgdmFyIHVybCA9IGV2ZW50LnVybDsKCiAgICAgIGV2ZW50LmFjaygpOwoKICAgICAgX3RoaXMuX3N5bmNoZXIuc3Vic2NyaWJlKHVybCkudGhlbihmdW5jdGlvbiAoY29ubmVjdGlvbkRhdGFPYmplY3QpIHsKICAgICAgICBjb25zb2xlLmluZm8oJ1JldHVybiBTdWJzY3JpYmUgQ29ubmVjdGlvbiBEYXRhIE9iamVjdCcsIGNvbm5lY3Rpb25EYXRhT2JqZWN0KTsKCiAgICAgICAgdmFyIGNvbm5lY3Rpb25Db250cm9sbGVyID0gbmV3IF9Db25uZWN0aW9uQ29udHJvbGxlcjJbJ2RlZmF1bHQnXSgpOwogICAgICAgIGNvbm5lY3Rpb25Db250cm9sbGVyLmNvbm5lY3Rpb25EYXRhT2JqZWN0T2JzZXJ2ZXIgPSBjb25uZWN0aW9uRGF0YU9iamVjdDsKICAgICAgICBfdGhpcy50cmlnZ2VyKCdvbjpzdWJzY3JpYmUnLCBjb25uZWN0aW9uQ29udHJvbGxlcik7CiAgICAgIH0pWydjYXRjaCddKGZ1bmN0aW9uICgpIHt9KTsKICAgIH0KICB9XSk7CgogIHJldHVybiBIeXBlcnR5Q29ubmVjdG9yOwp9KShfdXRpbHNFdmVudEVtaXR0ZXIyWydkZWZhdWx0J10pOwoKZXhwb3J0c1snZGVmYXVsdCddID0gSHlwZXJ0eUNvbm5lY3RvcjsKbW9kdWxlLmV4cG9ydHMgPSBleHBvcnRzWydkZWZhdWx0J107Cgp9LHsiLi4vdXRpbHMvRXZlbnRFbWl0dGVyIjoyMywiLi9Db25uZWN0aW9uQ29udHJvbGxlciI6MTJ9XSwxNDpbZnVuY3Rpb24ocmVxdWlyZSxtb2R1bGUsZXhwb3J0cyl7Ci8qKgoqIENsYXNzIGltcGxlbWVudGF0aW9uIG9mIE1lc3NhZ2UgRGF0YSBNb2RlbAoqLwoKJ3VzZSBzdHJpY3QnOwoKT2JqZWN0LmRlZmluZVByb3BlcnR5KGV4cG9ydHMsICdfX2VzTW9kdWxlJywgewogICAgdmFsdWU6IHRydWUKfSk7CgpmdW5jdGlvbiBfY2xhc3NDYWxsQ2hlY2soaW5zdGFuY2UsIENvbnN0cnVjdG9yKSB7IGlmICghKGluc3RhbmNlIGluc3RhbmNlb2YgQ29uc3RydWN0b3IpKSB7IHRocm93IG5ldyBUeXBlRXJyb3IoJ0Nhbm5vdCBjYWxsIGEgY2xhc3MgYXMgYSBmdW5jdGlvbicpOyB9IH0KCnZhciBNZXNzYWdlID0gZnVuY3Rpb24gTWVzc2FnZShpZCwgZnJvbSwgdG9MaXN0LCB0eXBlLCBjb250ZXh0SWQsIGJvZHksIHNpZ25hdHVyZSkgewogICAgX2NsYXNzQ2FsbENoZWNrKHRoaXMsIE1lc3NhZ2UpOwoKICAgIHRoaXMuaWQgPSBpZDsKICAgIHRoaXMuZnJvbSA9IGZyb207CiAgICB0aGlzLnRvID0gdG9MaXN0OwogICAgdGhpcy50eXBlID0gdHlwZTsKICAgIHRoaXMuY29udGV4dElkID0gY29udGV4dElkOwogICAgdGhpcy5zaWduYXR1cmUgPSBzaWduYXR1cmU7CiAgICB0aGlzLmJvZHkgPSBib2R5Owp9CgovKgpnZXQgaWQoKXsgcmV0dXJuIHRoaXMuaWQ7IH0KIGdldCBmcm9tKCl7IHJldHVybiB0aGlzLmZyb207IH0KIGdldCB0eXBlKCkgeyByZXR1cm4gdGhpcy50eXBlOyB9CiBnZXQgY29udGV4dElkKCkgeyByZXR1cm4gdGhpcy5jb250ZXh0SWQ7IH0KIGdldCBib2R5KCl7IHJldHVybiB0aGlzLmJvZHk7IH0KIHNldCBpZChpZGVudGlmaWVyKXsKICAgIGlmKGlkZW50aWZpZXIpCiAgICAgICAgdGhpcy5pZCA9IGlkZW50aWZpZXI7Cn0KIHNldCBmcm9tKHNlbmRlcil7CiAgICBpZihzZW5kZXIpCiAgICAgICAgdGhpcy5mcm9tID0gc2VuZGVyOwp9CiBzZXQgdHlwZShtc2dUeXBlKXsKICAgIGlmKG1zZ1R5cGUpCiAgICAgICAgdGhpcy50eXBlID0gbXNnVHlwZTsKfQogc2V0IGNvbnRleHRJZChjSUQpewogICAgaWYoY0lEKQogICAgICAgIHRoaXMuY29udGV4dElkID0gY0lEOwp9CnNldCBib2R5KG1zZ0JvZHkpewogICAgaWYobXNnQm9keSkKICAgICAgICB0aGlzLmJvZHkgPSBtc2dCb2R5Owp9CnNldCB0byhyZWNpcGllbnRMaXN0KXsKICAgIGlmKHJlY2lwaWVudExpc3QpCiAgICAgICAgdGhpcy50byA9IHJlY2lwaWVudExpc3Q7Cn0KIHNldCBzaWduYXR1cmUoc2lnbmF0dXJlKSB7CiAgICBpZiAoc2lnbmF0dXJlKQogICAgICAgIHRoaXMuc2lnbmF0dXJlID0gc2lnbmF0dXJlOwp9Ki8KCjsKCmV4cG9ydHMuTWVzc2FnZSA9IE1lc3NhZ2U7CnZhciBNZXNzYWdlVHlwZSA9IHsgQ1JFQVRFOiAnY3JlYXRlJywgUkVBRDogJ3JlYWQnLCBVUERBVEU6ICd1cGRhdGUnLCBERUxFVEU6ICdkZWxldGUnLCBTVUJTQ1JJQkU6ICdzdWJzY3JpYmUnLAogICAgVU5TVUJTQ1JJQkU6ICd1bnN1YnNjcmliZScsIFJFU1BPTlNFOiAncmVzcG9uc2UnLCBGT1JXQVJEOiAnZm9yd2FyZCcgfTsKCmV4cG9ydHMuTWVzc2FnZVR5cGUgPSBNZXNzYWdlVHlwZTsKZXhwb3J0c1snZGVmYXVsdCddID0gTWVzc2FnZTsKCn0se31dLDE1OltmdW5jdGlvbihyZXF1aXJlLG1vZHVsZSxleHBvcnRzKXsKJ3VzZSBzdHJpY3QnOwoKT2JqZWN0LmRlZmluZVByb3BlcnR5KGV4cG9ydHMsICdfX2VzTW9kdWxlJywgewogICAgdmFsdWU6IHRydWUKfSk7Cgp2YXIgX2dldCA9IGZ1bmN0aW9uIGdldChfeCwgX3gyLCBfeDMpIHsgdmFyIF9hZ2FpbiA9IHRydWU7IF9mdW5jdGlvbjogd2hpbGUgKF9hZ2FpbikgeyB2YXIgb2JqZWN0ID0gX3gsIHByb3BlcnR5ID0gX3gyLCByZWNlaXZlciA9IF94MzsgX2FnYWluID0gZmFsc2U7IGlmIChvYmplY3QgPT09IG51bGwpIG9iamVjdCA9IEZ1bmN0aW9uLnByb3RvdHlwZTsgdmFyIGRlc2MgPSBPYmplY3QuZ2V0T3duUHJvcGVydHlEZXNjcmlwdG9yKG9iamVjdCwgcHJvcGVydHkpOyBpZiAoZGVzYyA9PT0gdW5kZWZpbmVkKSB7IHZhciBwYXJlbnQgPSBPYmplY3QuZ2V0UHJvdG90eXBlT2Yob2JqZWN0KTsgaWYgKHBhcmVudCA9PT0gbnVsbCkgeyByZXR1cm4gdW5kZWZpbmVkOyB9IGVsc2UgeyBfeCA9IHBhcmVudDsgX3gyID0gcHJvcGVydHk7IF94MyA9IHJlY2VpdmVyOyBfYWdhaW4gPSB0cnVlOyBkZXNjID0gcGFyZW50ID0gdW5kZWZpbmVkOyBjb250aW51ZSBfZnVuY3Rpb247IH0gfSBlbHNlIGlmICgndmFsdWUnIGluIGRlc2MpIHsgcmV0dXJuIGRlc2MudmFsdWU7IH0gZWxzZSB7IHZhciBnZXR0ZXIgPSBkZXNjLmdldDsgaWYgKGdldHRlciA9PT0gdW5kZWZpbmVkKSB7IHJldHVybiB1bmRlZmluZWQ7IH0gcmV0dXJuIGdldHRlci5jYWxsKHJlY2VpdmVyKTsgfSB9IH07CgpmdW5jdGlvbiBfaW5oZXJpdHMoc3ViQ2xhc3MsIHN1cGVyQ2xhc3MpIHsgaWYgKHR5cGVvZiBzdXBlckNsYXNzICE9PSAnZnVuY3Rpb24nICYmIHN1cGVyQ2xhc3MgIT09IG51bGwpIHsgdGhyb3cgbmV3IFR5cGVFcnJvcignU3VwZXIgZXhwcmVzc2lvbiBtdXN0IGVpdGhlciBiZSBudWxsIG9yIGEgZnVuY3Rpb24sIG5vdCAnICsgdHlwZW9mIHN1cGVyQ2xhc3MpOyB9IHN1YkNsYXNzLnByb3RvdHlwZSA9IE9iamVjdC5jcmVhdGUoc3VwZXJDbGFzcyAmJiBzdXBlckNsYXNzLnByb3RvdHlwZSwgeyBjb25zdHJ1Y3RvcjogeyB2YWx1ZTogc3ViQ2xhc3MsIGVudW1lcmFibGU6IGZhbHNlLCB3cml0YWJsZTogdHJ1ZSwgY29uZmlndXJhYmxlOiB0cnVlIH0gfSk7IGlmIChzdXBlckNsYXNzKSBPYmplY3Quc2V0UHJvdG90eXBlT2YgPyBPYmplY3Quc2V0UHJvdG90eXBlT2Yoc3ViQ2xhc3MsIHN1cGVyQ2xhc3MpIDogc3ViQ2xhc3MuX19wcm90b19fID0gc3VwZXJDbGFzczsgfQoKZnVuY3Rpb24gX2NsYXNzQ2FsbENoZWNrKGluc3RhbmNlLCBDb25zdHJ1Y3RvcikgeyBpZiAoIShpbnN0YW5jZSBpbnN0YW5jZW9mIENvbnN0cnVjdG9yKSkgeyB0aHJvdyBuZXcgVHlwZUVycm9yKCdDYW5ub3QgY2FsbCBhIGNsYXNzIGFzIGEgZnVuY3Rpb24nKTsgfSB9Cgp2YXIgTWVzc2FnZUJvZHkgPQoKLyoqCiAqCiAqIEBwYXJhbSB7SWRlbnRpdHkuSldUfSBpZFRva2VuIC0gdG9rZW4gZm9yIElkZW50aXR5IGFzc2VydGlvbiBwdXJwb3NlCiAqIEBwYXJhbSB7SWRlbnRpdHkuSldUfSBhY2Nlc3NUb2tlbgogKiBAcGFyYW0ge1VSTC5VUkx9IHJlc291cmNlCiAqIEBwYXJhbSB7VVJMLkh5cGVydHlDYXRhbG9ndWVVUkx9IHNjaGVtYQogKiBAcGFyYW0ge0lkZW50aXR5LkpXVH0gYXNzZXJ0ZWRJZGVudGl0eQogKgogKi8KZnVuY3Rpb24gTWVzc2FnZUJvZHkoaWRUb2tlbiwgYWNjZXNzVG9rZW4sIHJlc291cmNlLCBzY2hlbWEsIGFzc2VydGVkSWRlbnRpdHkpIHsKICAgIF9jbGFzc0NhbGxDaGVjayh0aGlzLCBNZXNzYWdlQm9keSk7CgogICAgLy9sZXQgX3RoaXMgPSB0aGlzOwogICAgaWYgKHR5cGVvZiBpZG9rZW4gIT09ICd1bmRlZmluZWQnKSB0aGlzLmlkVG9rZW4gPSBpZFRva2VuOwogICAgaWYgKHR5cGVvZiBhY2Nlc3NUb2tlbiAhPT0gJ3VuZGVmaW5lZCcpIHRoaXMuYWNjZXNzVG9rZW4gPSBhY2Nlc3NUb2tlbjsKICAgIGlmICh0eXBlb2YgcmVzb3VyY2UgIT09ICd1bmRlZmluZWQnKSB0aGlzLnJlc291cmNlID0gcmVzb3VyY2U7CiAgICBpZiAodHlwZW9mIHNjaGVtYSAhPT0gJ3VuZGVmaW5lZCcpIHRoaXMuc2NoZW1hID0gc2NoZW1hOwogICAgaWYgKHR5cGVvZiBhc3NlcnRlZElkZW50aXR5ICE9PSAndW5kZWZpbmVkJykgdGhpcy5hc3NlcnRlZElkZW50aXR5ID0gYXNzZXJ0ZWRJZGVudGl0eTsKfTsKCnZhciBDcmVhdGVNZXNzYWdlQm9keSA9IChmdW5jdGlvbiAoX01lc3NhZ2VCb2R5KSB7CiAgICBfaW5oZXJpdHMoQ3JlYXRlTWVzc2FnZUJvZHksIF9NZXNzYWdlQm9keSk7CgogICAgZnVuY3Rpb24gQ3JlYXRlTWVzc2FnZUJvZHkodmFsdWUsIHBvbGljeSwgaWRUb2tlbiwgYWNjZXNzVG9rZW4sIHJlc291cmNlLCBzY2hlbWEsIGFzc2VydGVkSWRlbnRpdHkpIHsKICAgICAgICBfY2xhc3NDYWxsQ2hlY2sodGhpcywgQ3JlYXRlTWVzc2FnZUJvZHkpOwoKICAgICAgICBpZiAodHlwZW9mIHZhbHVlID09PSAndW5kZWZpbmVkJykgdGhyb3cgbmV3IEVycm9yKCJUaGUgdmFsdWUgcGFyYW1ldGVyIGlzIG51bGwiKTsKICAgICAgICBfZ2V0KE9iamVjdC5nZXRQcm90b3R5cGVPZihDcmVhdGVNZXNzYWdlQm9keS5wcm90b3R5cGUpLCAnY29uc3RydWN0b3InLCB0aGlzKS5jYWxsKHRoaXMsIGlkVG9rZW4sIGFjY2Vzc1Rva2VuLCByZXNvdXJjZSwgc2NoZW1hLCBhc3NlcnRlZElkZW50aXR5LCBzY2hlbWEsIGFzc2VydGVkSWRlbnRpdHkpOwoKICAgICAgICB0aGlzLnZhbHVlID0gdmFsdWU7CiAgICAgICAgaWYgKHBvbGljeSkgdGhpcy5wb2xpY3kgPSBwb2xpY3k7CiAgICB9CgogICAgcmV0dXJuIENyZWF0ZU1lc3NhZ2VCb2R5Owp9KShNZXNzYWdlQm9keSk7CgpleHBvcnRzLkNyZWF0ZU1lc3NhZ2VCb2R5ID0gQ3JlYXRlTWVzc2FnZUJvZHk7Cgp2YXIgUmVhZE1lc3NhZ2VCb2R5ID0gKGZ1bmN0aW9uIChfTWVzc2FnZUJvZHkyKSB7CiAgICBfaW5oZXJpdHMoUmVhZE1lc3NhZ2VCb2R5LCBfTWVzc2FnZUJvZHkyKTsKCiAgICBmdW5jdGlvbiBSZWFkTWVzc2FnZUJvZHkoaWRUb2tlbiwgYWNjZXNzVG9rZW4sIHJlc291cmNlLCBzY2hlbWEsIGFzc2VydGVkSWRlbnRpdHksIGF0dHJpYnV0ZSwgY3JpdGVyaWFTeW50YXgsIGNyaXRlcmlhKSB7CiAgICAgICAgX2NsYXNzQ2FsbENoZWNrKHRoaXMsIFJlYWRNZXNzYWdlQm9keSk7CgogICAgICAgIF9nZXQoT2JqZWN0LmdldFByb3RvdHlwZU9mKFJlYWRNZXNzYWdlQm9keS5wcm90b3R5cGUpLCAnY29uc3RydWN0b3InLCB0aGlzKS5jYWxsKHRoaXMsIGlkVG9rZW4sIGFjY2Vzc1Rva2VuLCByZXNvdXJjZSwgc2NoZW1hLCBhc3NlcnRlZElkZW50aXR5KTsKCiAgICAgICAgaWYgKGF0dHJpYnV0ZSkgdGhpcy5hdHRyaWJ1dGUgPSBhdHRyaWJ1dGU7CgogICAgICAgIGlmIChjcml0ZXJpYVN5bnRheCkgdGhpcy5jcml0ZXJpYVN5bnRheCA9IGNyaXRlcmlhU3ludGF4OwoKICAgICAgICBpZiAoY3JpdGVyaWEpIHRoaXMuY3JpdGVyaWEgPSBjcml0ZXJpYTsKICAgIH0KCiAgICByZXR1cm4gUmVhZE1lc3NhZ2VCb2R5Owp9KShNZXNzYWdlQm9keSk7CgpleHBvcnRzLlJlYWRNZXNzYWdlQm9keSA9IFJlYWRNZXNzYWdlQm9keTsKCnZhciBEZWxldGVNZXNzYWdlQm9keSA9IChmdW5jdGlvbiAoX01lc3NhZ2VCb2R5MykgewogICAgX2luaGVyaXRzKERlbGV0ZU1lc3NhZ2VCb2R5LCBfTWVzc2FnZUJvZHkzKTsKCiAgICBmdW5jdGlvbiBEZWxldGVNZXNzYWdlQm9keShpZFRva2VuLCBhY2Nlc3NUb2tlbiwgcmVzb3VyY2UsIHNjaGVtYSwgYXNzZXJ0ZWRJZGVudGl0eSwgYXR0cmlidXRlKSB7CiAgICAgICAgX2NsYXNzQ2FsbENoZWNrKHRoaXMsIERlbGV0ZU1lc3NhZ2VCb2R5KTsKCiAgICAgICAgX2dldChPYmplY3QuZ2V0UHJvdG90eXBlT2YoRGVsZXRlTWVzc2FnZUJvZHkucHJvdG90eXBlKSwgJ2NvbnN0cnVjdG9yJywgdGhpcykuY2FsbCh0aGlzLCBpZFRva2VuLCBhY2Nlc3NUb2tlbiwgcmVzb3VyY2UsIHNjaGVtYSwgYXNzZXJ0ZWRJZGVudGl0eSk7CgogICAgICAgIGlmIChhdHRyaWJ1dGUpIHsKICAgICAgICAgICAgdGhpcy5hdHRyaWJ1dGUgPSBhdHRyaWJ1dGU7CiAgICAgICAgfQogICAgfQoKICAgIHJldHVybiBEZWxldGVNZXNzYWdlQm9keTsKfSkoTWVzc2FnZUJvZHkpOwoKZXhwb3J0cy5EZWxldGVNZXNzYWdlQm9keSA9IERlbGV0ZU1lc3NhZ2VCb2R5OwoKdmFyIFVwZGF0ZU1lc3NhZ2VCb2R5ID0gKGZ1bmN0aW9uIChfTWVzc2FnZUJvZHk0KSB7CiAgICBfaW5oZXJpdHMoVXBkYXRlTWVzc2FnZUJvZHksIF9NZXNzYWdlQm9keTQpOwoKICAgIGZ1bmN0aW9uIFVwZGF0ZU1lc3NhZ2VCb2R5KGlkVG9rZW4sIGFjY2Vzc1Rva2VuLCByZXNvdXJjZSwgc2NoZW1hLCBhc3NlcnRlZElkZW50aXR5LCBhdHRyaWJ1dGUsIHZhbHVlKSB7CiAgICAgICAgX2NsYXNzQ2FsbENoZWNrKHRoaXMsIFVwZGF0ZU1lc3NhZ2VCb2R5KTsKCiAgICAgICAgX2dldChPYmplY3QuZ2V0UHJvdG90eXBlT2YoVXBkYXRlTWVzc2FnZUJvZHkucHJvdG90eXBlKSwgJ2NvbnN0cnVjdG9yJywgdGhpcykuY2FsbCh0aGlzLCBpZFRva2VuLCBhY2Nlc3NUb2tlbiwgcmVzb3VyY2UsIHNjaGVtYSwgYXNzZXJ0ZWRJZGVudGl0eSk7CgogICAgICAgIHRoaXMuYXR0cmlidXRlID0gYXR0cmlidXRlOwogICAgICAgIHRoaXMudmFsdWUgPSB2YWx1ZTsKICAgIH0KCiAgICByZXR1cm4gVXBkYXRlTWVzc2FnZUJvZHk7Cn0pKE1lc3NhZ2VCb2R5KTsKCmV4cG9ydHMuVXBkYXRlTWVzc2FnZUJvZHkgPSBVcGRhdGVNZXNzYWdlQm9keTsKCnZhciBGb3J3YXJkTWVzc2FnZUJvZHkgPSAoZnVuY3Rpb24gKF9NZXNzYWdlQm9keTUpIHsKICAgIF9pbmhlcml0cyhGb3J3YXJkTWVzc2FnZUJvZHksIF9NZXNzYWdlQm9keTUpOwoKICAgIGZ1bmN0aW9uIEZvcndhcmRNZXNzYWdlQm9keShpZFRva2VuLCBhY2Nlc3NUb2tlbiwgcmVzb3VyY2UsIHNjaGVtYSwgYXNzZXJ0ZWRJZGVudGl0eSwgbWVzc2FnZSkgewogICAgICAgIF9jbGFzc0NhbGxDaGVjayh0aGlzLCBGb3J3YXJkTWVzc2FnZUJvZHkpOwoKICAgICAgICBfZ2V0KE9iamVjdC5nZXRQcm90b3R5cGVPZihGb3J3YXJkTWVzc2FnZUJvZHkucHJvdG90eXBlKSwgJ2NvbnN0cnVjdG9yJywgdGhpcykuY2FsbCh0aGlzLCBpZFRva2VuLCBhY2Nlc3NUb2tlbiwgcmVzb3VyY2UsIHNjaGVtYSwgYXNzZXJ0ZWRJZGVudGl0eSk7CgogICAgICAgIHRoaXMubWVzc2FnZSA9IG1lc3NhZ2U7CiAgICB9CgogICAgcmV0dXJuIEZvcndhcmRNZXNzYWdlQm9keTsKfSkoTWVzc2FnZUJvZHkpOwoKZXhwb3J0cy5Gb3J3YXJkTWVzc2FnZUJvZHkgPSBGb3J3YXJkTWVzc2FnZUJvZHk7Cgp2YXIgUmVzcG9uc2VNZXNzYWdlQm9keSA9IChmdW5jdGlvbiAoX01lc3NhZ2VCb2R5NikgewogICAgX2luaGVyaXRzKFJlc3BvbnNlTWVzc2FnZUJvZHksIF9NZXNzYWdlQm9keTYpOwoKICAgIGZ1bmN0aW9uIFJlc3BvbnNlTWVzc2FnZUJvZHkoaWRUb2tlbiwgYWNjZXNzVG9rZW4sIHJlc291cmNlLCBjb2RlLCB2YWx1ZSkgewogICAgICAgIF9jbGFzc0NhbGxDaGVjayh0aGlzLCBSZXNwb25zZU1lc3NhZ2VCb2R5KTsKCiAgICAgICAgX2dldChPYmplY3QuZ2V0UHJvdG90eXBlT2YoUmVzcG9uc2VNZXNzYWdlQm9keS5wcm90b3R5cGUpLCAnY29uc3RydWN0b3InLCB0aGlzKS5jYWxsKHRoaXMsIGlkVG9rZW4sIGFjY2Vzc1Rva2VuLCByZXNvdXJjZSk7CgogICAgICAgIGlmIChjb2RlKSB7CiAgICAgICAgICAgIHRoaXMuY29kZSA9IGNvZGU7CiAgICAgICAgICAgIHRoaXMuZGVzY3JpcHRpb24gPSBSRUFTT05fUEhSQVNFW2NvZGVdOwogICAgICAgIH0KCiAgICAgICAgaWYgKHZhbHVlKSB0aGlzLnZhbHVlID0gdmFsdWU7CiAgICB9CgogICAgcmV0dXJuIFJlc3BvbnNlTWVzc2FnZUJvZHk7Cn0pKE1lc3NhZ2VCb2R5KTsKCmV4cG9ydHMuUmVzcG9uc2VNZXNzYWdlQm9keSA9IFJlc3BvbnNlTWVzc2FnZUJvZHk7CnZhciBSRVNQT05TX0NPREUgPSB7CiAgICAxMDA6ICcxMDAnLAogICAgMTAxOiAnMTAxJywKICAgIDIwMDogJzIwMCcsCiAgICAyMDE6ICcyMDEnLAogICAgMjAyOiAnMjAyJywKICAgIDIwMzogJzIwMycsCiAgICAyMDQ6ICcyMDQnLAogICAgMjA1OiAnMjA1JywKICAgIDIwNjogJzIwNicsCiAgICAzMDA6ICczMDAnLAogICAgMzAxOiAnMzAxJywKICAgIDMwMjogJzMwMicsCiAgICAzMDM6ICczMDMnLAogICAgMzA0OiAnMzA0JywKICAgIDMwNTogJzMwNScsCiAgICAzMDc6ICczMDcnLAogICAgNDAwOiAnNDAwJywKICAgIDQwMTogJzQwMScsCiAgICA0MDI6ICc0MDInLAogICAgNDAzOiAnNDAzJywKICAgIDQwNDogJzQwNCcsCiAgICA0MDU6ICc0MDUnLAogICAgNDA2OiAnNDA2JywKICAgIDQwNzogJzQwNycsCiAgICA0MDg6ICc0MDgnLAogICAgNDA5OiAnNDA5JywKICAgIDQxMDogJzQxMCcsCiAgICA0MTE6ICc0MTEnLAogICAgNDEyOiAnNDEyJywKICAgIDQxMzogJzQxMycsCiAgICA0MTQ6ICc0MTQnLAogICAgNDE1OiAnNDE1JywKICAgIDQxNjogJzQxNicsCiAgICA0MTc6ICc0MTcnLAogICAgNDI2OiAnNDI2JywKICAgIDUwMDogJzUwMCcsCiAgICA1MDE6ICc1MDEnLAogICAgNTAyOiAnNTAyJywKICAgIDUwMzogJzUwMycsCiAgICA1MDQ6ICc1MDQnLAogICAgNTA1OiAnNTA1Jwp9OwpleHBvcnRzLlJFU1BPTlNfQ09ERSA9IFJFU1BPTlNfQ09ERTsKdmFyIFJFQVNPTl9QSFJBU0UgPSB7CiAgICAxMDA6ICdDb250aW51ZScsCiAgICAxMDE6ICdTd2l0Y2hpbmcgUHJvdG9jb2xzJywKICAgIDIwMDogJ09LJywKICAgIDIwMTogJ0NyZWF0ZWQnLAogICAgMjAyOiAnQWNjZXB0ZWQnLAogICAgMjAzOiAnTm9uLUF1dGhvcml0YXRpdmUgSW5mb3JtYXRpb24nLAogICAgMjA0OiAnTm8gQ29udGVudCcsCiAgICAyMDU6ICdSZXNldCBDb250ZW50JywKICAgIDIwNjogJ1BhcnRpYWwgQ29udGVudCcsCiAgICAzMDA6ICdNdWx0aXBsZSBDaG9pY2VzJywKICAgIDMwMTogJ01vdmVkIFBlcm1hbmVudGx5JywKICAgIDMwMjogJ0ZvdW5kJywKICAgIDMwMzogJ1NlZSBPdGhlcicsCiAgICAzMDQ6ICdOb3QgTW9kaWZpZWQnLAogICAgMzA1OiAnVXNlIFByb3h5JywKICAgIDMwNzogJ1RlbXBvcmFyeSBSZWRpcmVjdCcsCiAgICA0MDA6ICdCYWQgUmVxdWVzdCcsCiAgICA0MDE6ICdVbmF1dGhvcml6ZWQnLAogICAgNDAyOiAnUGF5bWVudCBSZXF1aXJlZCcsCiAgICA0MDM6ICdGb3JiaWRkZW4nLAogICAgNDA0OiAnTm90IEZvdW5kJywKICAgIDQwNTogJ01ldGhvZCBOb3QgQWxsb3dlZCcsCiAgICA0MDY6ICdOb3QgQWNjZXB0YWJsZScsCiAgICA0MDc6ICdQcm94eSBBdXRoZW50aWNhdGlvbiBSZXF1aXJlZCcsCiAgICA0MDg6ICdSZXF1ZXN0IFRpbWVvdXQnLAogICAgNDA5OiAnQ29uZmxpY3QnLAogICAgNDEwOiAnR29uZScsCiAgICA0MTE6ICdMZW5ndGggUmVxdWlyZWQnLAogICAgNDEyOiAnUHJlY29uZGl0aW9uIEZhaWxlZCcsCiAgICA0MTM6ICdQYXlsb2FkIFRvbyBMYXJnZScsCiAgICA0MTQ6ICdSZXF1ZXN0LVVSSSBUb28gTG9uZycsCiAgICA0MTU6ICdVbnN1cHBvcnRlZCBNZWRpYSBUeXBlJywKICAgIDQxNjogJ1JhbmdlIE5vdCBTYXRpc2ZpYWJsZScsCiAgICA0MTc6ICdFeHBlY3RhdGlvbiBGYWlsZWQnLAogICAgNDI2OiAnVXBncmFkZSBSZXF1aXJlZCcsCiAgICA1MDA6ICdJbnRlcm5hbCBTZXJ2ZXIgRXJyb3InLAogICAgNTAxOiAnTm90IEltcGxlbWVudGVkJywKICAgIDUwMjogJ0JhZCBHYXRld2F5JywKICAgIDUwMzogJ1NlcnZpY2UgVW5hdmFpbGFibGUnLAogICAgNTA0OiAnR2F0ZXdheSBUaW1lLW91dCcsCiAgICA1MDU6ICdIVFRQIFZlcnNpb24gTm90IFN1cHBvcnRlZCcKfTsKCmV4cG9ydHMuUkVBU09OX1BIUkFTRSA9IFJFQVNPTl9QSFJBU0U7CmV4cG9ydHNbJ2RlZmF1bHQnXSA9IE1lc3NhZ2VCb2R5OwoKfSx7fV0sMTY6W2Z1bmN0aW9uKHJlcXVpcmUsbW9kdWxlLGV4cG9ydHMpewovKioKKiBNZXNzYWdlIEZhY3RvcnkKKiAKKi8KCid1c2Ugc3RyaWN0JzsKCk9iamVjdC5kZWZpbmVQcm9wZXJ0eShleHBvcnRzLCAnX19lc01vZHVsZScsIHsKICAgIHZhbHVlOiB0cnVlCn0pOwoKdmFyIF9jcmVhdGVDbGFzcyA9IChmdW5jdGlvbiAoKSB7IGZ1bmN0aW9uIGRlZmluZVByb3BlcnRpZXModGFyZ2V0LCBwcm9wcykgeyBmb3IgKHZhciBpID0gMDsgaSA8IHByb3BzLmxlbmd0aDsgaSsrKSB7IHZhciBkZXNjcmlwdG9yID0gcHJvcHNbaV07IGRlc2NyaXB0b3IuZW51bWVyYWJsZSA9IGRlc2NyaXB0b3IuZW51bWVyYWJsZSB8fCBmYWxzZTsgZGVzY3JpcHRvci5jb25maWd1cmFibGUgPSB0cnVlOyBpZiAoJ3ZhbHVlJyBpbiBkZXNjcmlwdG9yKSBkZXNjcmlwdG9yLndyaXRhYmxlID0gdHJ1ZTsgT2JqZWN0LmRlZmluZVByb3BlcnR5KHRhcmdldCwgZGVzY3JpcHRvci5rZXksIGRlc2NyaXB0b3IpOyB9IH0gcmV0dXJuIGZ1bmN0aW9uIChDb25zdHJ1Y3RvciwgcHJvdG9Qcm9wcywgc3RhdGljUHJvcHMpIHsgaWYgKHByb3RvUHJvcHMpIGRlZmluZVByb3BlcnRpZXMoQ29uc3RydWN0b3IucHJvdG90eXBlLCBwcm90b1Byb3BzKTsgaWYgKHN0YXRpY1Byb3BzKSBkZWZpbmVQcm9wZXJ0aWVzKENvbnN0cnVjdG9yLCBzdGF0aWNQcm9wcyk7IHJldHVybiBDb25zdHJ1Y3RvcjsgfTsgfSkoKTsKCnZhciBfZ2V0ID0gZnVuY3Rpb24gZ2V0KF94LCBfeDIsIF94MykgeyB2YXIgX2FnYWluID0gdHJ1ZTsgX2Z1bmN0aW9uOiB3aGlsZSAoX2FnYWluKSB7IHZhciBvYmplY3QgPSBfeCwgcHJvcGVydHkgPSBfeDIsIHJlY2VpdmVyID0gX3gzOyBfYWdhaW4gPSBmYWxzZTsgaWYgKG9iamVjdCA9PT0gbnVsbCkgb2JqZWN0ID0gRnVuY3Rpb24ucHJvdG90eXBlOyB2YXIgZGVzYyA9IE9iamVjdC5nZXRPd25Qcm9wZXJ0eURlc2NyaXB0b3Iob2JqZWN0LCBwcm9wZXJ0eSk7IGlmIChkZXNjID09PSB1bmRlZmluZWQpIHsgdmFyIHBhcmVudCA9IE9iamVjdC5nZXRQcm90b3R5cGVPZihvYmplY3QpOyBpZiAocGFyZW50ID09PSBudWxsKSB7IHJldHVybiB1bmRlZmluZWQ7IH0gZWxzZSB7IF94ID0gcGFyZW50OyBfeDIgPSBwcm9wZXJ0eTsgX3gzID0gcmVjZWl2ZXI7IF9hZ2FpbiA9IHRydWU7IGRlc2MgPSBwYXJlbnQgPSB1bmRlZmluZWQ7IGNvbnRpbnVlIF9mdW5jdGlvbjsgfSB9IGVsc2UgaWYgKCd2YWx1ZScgaW4gZGVzYykgeyByZXR1cm4gZGVzYy52YWx1ZTsgfSBlbHNlIHsgdmFyIGdldHRlciA9IGRlc2MuZ2V0OyBpZiAoZ2V0dGVyID09PSB1bmRlZmluZWQpIHsgcmV0dXJuIHVuZGVmaW5lZDsgfSByZXR1cm4gZ2V0dGVyLmNhbGwocmVjZWl2ZXIpOyB9IH0gfTsKCmZ1bmN0aW9uIF9pbnRlcm9wUmVxdWlyZURlZmF1bHQob2JqKSB7IHJldHVybiBvYmogJiYgb2JqLl9fZXNNb2R1bGUgPyBvYmogOiB7ICdkZWZhdWx0Jzogb2JqIH07IH0KCmZ1bmN0aW9uIF9jbGFzc0NhbGxDaGVjayhpbnN0YW5jZSwgQ29uc3RydWN0b3IpIHsgaWYgKCEoaW5zdGFuY2UgaW5zdGFuY2VvZiBDb25zdHJ1Y3RvcikpIHsgdGhyb3cgbmV3IFR5cGVFcnJvcignQ2Fubm90IGNhbGwgYSBjbGFzcyBhcyBhIGZ1bmN0aW9uJyk7IH0gfQoKZnVuY3Rpb24gX2luaGVyaXRzKHN1YkNsYXNzLCBzdXBlckNsYXNzKSB7IGlmICh0eXBlb2Ygc3VwZXJDbGFzcyAhPT0gJ2Z1bmN0aW9uJyAmJiBzdXBlckNsYXNzICE9PSBudWxsKSB7IHRocm93IG5ldyBUeXBlRXJyb3IoJ1N1cGVyIGV4cHJlc3Npb24gbXVzdCBlaXRoZXIgYmUgbnVsbCBvciBhIGZ1bmN0aW9uLCBub3QgJyArIHR5cGVvZiBzdXBlckNsYXNzKTsgfSBzdWJDbGFzcy5wcm90b3R5cGUgPSBPYmplY3QuY3JlYXRlKHN1cGVyQ2xhc3MgJiYgc3VwZXJDbGFzcy5wcm90b3R5cGUsIHsgY29uc3RydWN0b3I6IHsgdmFsdWU6IHN1YkNsYXNzLCBlbnVtZXJhYmxlOiBmYWxzZSwgd3JpdGFibGU6IHRydWUsIGNvbmZpZ3VyYWJsZTogdHJ1ZSB9IH0pOyBpZiAoc3VwZXJDbGFzcykgT2JqZWN0LnNldFByb3RvdHlwZU9mID8gT2JqZWN0LnNldFByb3RvdHlwZU9mKHN1YkNsYXNzLCBzdXBlckNsYXNzKSA6IHN1YkNsYXNzLl9fcHJvdG9fXyA9IHN1cGVyQ2xhc3M7IH0KCnZhciBfcmVUSElOS09iamVjdFJldGhpbmtPYmplY3RKcyA9IHJlcXVpcmUoJy4uL3JlVEhJTktPYmplY3QvUmV0aGlua09iamVjdC5qcycpOwoKdmFyIF9yZVRISU5LT2JqZWN0UmV0aGlua09iamVjdEpzMiA9IF9pbnRlcm9wUmVxdWlyZURlZmF1bHQoX3JlVEhJTktPYmplY3RSZXRoaW5rT2JqZWN0SnMpOwoKdmFyIF9NZXNzYWdlSnMgPSByZXF1aXJlKCcuL01lc3NhZ2UuanMnKTsKCnZhciBfTWVzc2FnZUpzMiA9IF9pbnRlcm9wUmVxdWlyZURlZmF1bHQoX01lc3NhZ2VKcyk7Cgp2YXIgX01lc3NhZ2VCb2R5SnMgPSByZXF1aXJlKCcuL01lc3NhZ2VCb2R5LmpzJyk7Cgp2YXIgTWVzc2FnZUZhY3RvcnkgPSAoZnVuY3Rpb24gKF9SZXRoaW5rT2JqZWN0KSB7CiAgICBfaW5oZXJpdHMoTWVzc2FnZUZhY3RvcnksIF9SZXRoaW5rT2JqZWN0KTsKCiAgICAvKioKICAgICAqIENvbnN0cnVjdG9yCiAgICAgKiBAcGFyYW0ge2Jvb2xlYW59IHZhbGlkYXRpb24KICAgICAqIEBwYXJhbSB7VVJMLlVSTCB9IHNjaGVtYSAtIGxpbmsgdG8gdGhlIHNjaGVtYQogICAgICovCgogICAgZnVuY3Rpb24gTWVzc2FnZUZhY3RvcnkodmFsaWRhdGlvbiwgc2NoZW1hKSB7CiAgICAgICAgX2NsYXNzQ2FsbENoZWNrKHRoaXMsIE1lc3NhZ2VGYWN0b3J5KTsKCiAgICAgICAgX2dldChPYmplY3QuZ2V0UHJvdG90eXBlT2YoTWVzc2FnZUZhY3RvcnkucHJvdG90eXBlKSwgJ2NvbnN0cnVjdG9yJywgdGhpcykuY2FsbCh0aGlzLCB2YWxpZGF0aW9uLCBzY2hlbWEpOwoKICAgICAgICB2YXIgX3RoaXMgPSB0aGlzOwogICAgfQoKICAgIF9jcmVhdGVDbGFzcyhNZXNzYWdlRmFjdG9yeSwgW3sKICAgICAgICBrZXk6ICd2YWxpZGF0ZScsCiAgICAgICAgdmFsdWU6IGZ1bmN0aW9uIHZhbGlkYXRlKGRhdGEpIHsKICAgICAgICAgICAgcmV0dXJuIF9nZXQoT2JqZWN0LmdldFByb3RvdHlwZU9mKE1lc3NhZ2VGYWN0b3J5LnByb3RvdHlwZSksICd2YWxpZGF0ZScsIHRoaXMpLmNhbGwodGhpcywgZGF0YSk7CiAgICAgICAgfQoKICAgICAgICAvKioKICAgICAgICAgKiBDcmVhdGUgYSBNZXNzYWdlIHdpdGggQ1JFQVRFIE1lc3NhZ2VUeXBlIGFuZCBDcmVhdGUgTWVzc2FnZSBCb2R5CiAgICAgICAgICoKICAgICAgICAgKiBAcGFyYW0ge1VSTC5VUkx9IGZyb20gLSB0aGUgc2VuZGVyIG9mIHRoaXMgbWVzc2FnZQogICAgICAgICAqIEBwYXJhbSB7VVJMLlVSTExpc3R9IE9uZSBvciBtb3JlIFVSTHMgb2YgTWVzc2FnZSByZWNpcGllbnRzLiBBY2NvcmRpbmcgdG8gdGhlIFVSTCBzY2hlbWUgaXQgbWF5IGJlIGhhbmRsZWQgaW4KICAgICAgICAgKiBkaWZmZXJlbnQgd2F5cwogICAgICAgICAqIEBwYXJhbSB7T2JqZWN0fSBjb250ZXh0SWQgLSB0aGUgR1VJRCB1c2VkIHRvIGlkZW50aXR5IGVnIGEgY29tbXVuaWNhdGlvbiBzZXNzaW9uIGxpa2UgYSB0ZWxlcGhvbnkgY2FsbAogICAgICAgICAqIEBwYXJhbSB7SWRlbnRpdHkuSldUfSBpZFRva2VuIC0gdG9rZW4gZm9yIElkZW50aXR5IGFzc2VydGlvbiBwdXJwb3NlCiAgICAgICAgICogQHBhcmFtIHtJZGVudGl0eS5KV1R9IGFjY2Vzc1Rva2VuIC0gYWNjZXNzIHRva2VuIGZvciBhY2Nlc3MgY29udHJvbCBwdXJwb3NlcwogICAgICAgICAqIEBwYXJhbSB7VVJMLlVSbH0gcmVzb3VyY2UgLSBVUkwgb2YgRGF0YSBPYmplY3QgUmVzb3VyY2UgYXNzb2NpYXRlZCB3aXRoIHRoZSBtZXNzYWdlCiAgICAgICAgICogQHBhcmFtIHtzdHJpbmd9IHNpZ25hdHVyZSAtCiAgICAgICAgICogQHBhcmFtIHtzdHJpbmd9IHZhbHVlIC0gdGhlIGNyZWF0ZWQgb2JqZWN0IGluIEpTT04gZm9ybWF0CiAgICAgICAgICogQHBhcmFtIHtVUkwuVVJMfSBwb2xpY3kgLSBVUkwgZnJvbSB3aGVyZSBhY2Nlc3MgcG9saWN5IGNvbnRyb2wgY2FuIGJlIGRvd25sb2FkZWQKICAgICAgICAgKgogICAgICAgICAqIEByZXR1cm4ge01lc3NhZ2V9IENyZWF0ZSBNZXNzYWdlCiAgICAgICAgICovCiAgICB9LCB7CiAgICAgICAga2V5OiAnY3JlYXRlTWVzc2FnZVJlcXVlc3QnLAogICAgICAgIHZhbHVlOiBmdW5jdGlvbiBjcmVhdGVNZXNzYWdlUmVxdWVzdChmcm9tLCB0bywgY29udGV4dElkLCBpZFRva2VuLCBhY2Nlc3NUb2tlbiwgcmVzb3VyY2UsIHNpZ25hdHVyZSwgc2NoZW1hLCBhc3NlcnRlZElkZW50aXR5LCB2YWx1ZSwgcG9saWN5KSB7CiAgICAgICAgICAgIGlmICh0eXBlb2YgZnJvbSA9PT0gJ3VuZGVmaW5lZCcgfHwgdHlwZW9mIGNvbnRleHRJZCA9PT0gJ3VuZGVmaW5lZCcgfHwgdHlwZW9mIHZhbHVlID09PSAndW5kZWZpbmVkJykgdGhyb3cgbmV3IEVycm9yKCJmcm9tLCBjb250ZXh0SWQsIGFuZCB2YWx1ZSBvZiBvYmplY3QgdG8gYmUgY3JlYXRlZCBNVVNUIGJlIHNwZWNpZmllZCIpOwoKICAgICAgICAgICAgdmFyIG1lc3NhZ2VCb2R5ID0gbmV3IF9NZXNzYWdlQm9keUpzLkNyZWF0ZU1lc3NhZ2VCb2R5KHZhbHVlLCBwb2xpY3ksIGlkVG9rZW4sIGFjY2Vzc1Rva2VuLCByZXNvdXJjZSwgc2NoZW1hLCBhc3NlcnRlZElkZW50aXR5KTsKICAgICAgICAgICAgdmFyIG1lc3NhZ2UgPSBuZXcgX01lc3NhZ2VKczJbJ2RlZmF1bHQnXShNZXNzYWdlRmFjdG9yeS5fZ2VuZXJhdGVNZXNzYWdlSWQoKSwgZnJvbSwgdG8sIF9NZXNzYWdlSnMuTWVzc2FnZVR5cGUuQ1JFQVRFLCBjb250ZXh0SWQsIG1lc3NhZ2VCb2R5LCBzaWduYXR1cmUpOwogICAgICAgICAgICByZXR1cm4gbWVzc2FnZTsKICAgICAgICB9CiAgICB9LCB7CiAgICAgICAga2V5OiAnY3JlYXRlRm9yd2FyZE1lc3NhZ2VSZXF1ZXN0JywKICAgICAgICB2YWx1ZTogZnVuY3Rpb24gY3JlYXRlRm9yd2FyZE1lc3NhZ2VSZXF1ZXN0KGRhdGEsIGZyb20sIHRvLCBjb250ZXh0SWQsIGlkVG9rZW4sIGFjY2Vzc1Rva2VuLCByZXNvdXJjZSwgc2lnbmF0dXJlLCBzY2hlbWEsIGFzc2VydGVkSWRlbnRpdHkpIHsKICAgICAgICAgICAgaWYgKHR5cGVvZiBmcm9tID09PSAndW5kZWZpbmVkJyB8fCB0eXBlb2YgY29udGV4dElkID09PSAndW5kZWZpbmVkJyB8fCB0eXBlb2YgZGF0YSA9PT0gJ3VuZGVmaW5lZCcpIHRocm93IG5ldyBFcnJvcigiZnJvbSwgY29udGV4dElkLCBhbmQgbWVzc2FnZSB0byBmb3J3YXJkIE1VU1QgYmUgc3BlY2lmaWVkIik7CgogICAgICAgICAgICB2YXIgbWVzc2FnZUJvZHkgPSBuZXcgX01lc3NhZ2VCb2R5SnMuRm9yd2FyZE1lc3NhZ2VCb2R5KGlkVG9rZW4sIGFjY2Vzc1Rva2VuLCByZXNvdXJjZSwgc2NoZW1hLCBhc3NlcnRlZElkZW50aXR5LCBkYXRhKTsKICAgICAgICAgICAgdmFyIG1lc3NhZ2UgPSBuZXcgX01lc3NhZ2VKczJbJ2RlZmF1bHQnXShNZXNzYWdlRmFjdG9yeS5fZ2VuZXJhdGVNZXNzYWdlSWQoKSwgZnJvbSwgdG8sIF9NZXNzYWdlSnMuTWVzc2FnZVR5cGUuRk9SV0FSRCwgY29udGV4dElkLCBtZXNzYWdlQm9keSwgc2lnbmF0dXJlKTsKICAgICAgICAgICAgcmV0dXJuIG1lc3NhZ2U7CiAgICAgICAgfQoKICAgICAgICAvKioKICAgICAgICAgKiAgQ3JlYXRlIERlbGV0ZSBNZXNzYWdlCiAgICAgICAgICogQHBhcmFtIHtVUkwuVVJMfSBmcm9tIC0gdGhlIHNlbmRlciBvZiB0aGlzIG1lc3NhZ2UKICAgICAgICAgKiBAcGFyYW0ge1VSTC5VUkxMaXN0fSB0byAtIE9uZSBvciBtb3JlIFVSTHMgb2YgTWVzc2FnZSByZWNpcGllbnRzLiBBY2NvcmRpbmcgdG8gdGhlIFVSTCBzY2hlbWUgaXQgbWF5IGJlIGhhbmRsZWQgaW4KICAgICAgICAgKiBkaWZmZXJlbnQgd2F5cwogICAgICAgICAqIEBwYXJhbSB7T2JqZWN0fSBjb250ZXh0SWQgLSB0aGUgR1VJRCB1c2VkIHRvIGlkZW50aXR5IGVnIGEgY29tbXVuaWNhdGlvbiBzZXNzaW9uIGxpa2UgYSB0ZWxlcGhvbnkgY2FsbAogICAgICAgICAqIEBwYXJhbSB7SWRlbnRpdHkuSldUfSBpZFRva2VuIC0gdG9rZW4gZm9yIElkZW50aXR5IGFzc2VydGlvbiBwdXJwb3NlCiAgICAgICAgICogQHBhcmFtIHtJZGVudGl0eS5KV1R9IGFjY2Vzc1Rva2VuIC0gYWNjZXNzIHRva2VuIGZvciBhY2Nlc3MgY29udHJvbCBwdXJwb3NlcwogICAgICAgICAqIEBwYXJhbSB7VVJMLlVSbH0gcmVzb3VyY2UgLSBVUkwgb2YgRGF0YSBPYmplY3QgUmVzb3VyY2UgYXNzb2NpYXRlZCB3aXRoIHRoZSBtZXNzYWdlCiAgICAgICAgICogQHBhcmFtIHtzdHJpbmd9IHNpZ25hdHVyZSAtCiAgICAgICAgICogQHBhcmFtIGF0dHJpYnV0ZSAtIElkZW50aWZpZXMgdGhlIGF0dHJpYnV0ZSBpbiB0aGUgT2JqZWN0IHRvIGJlIGRlbGV0ZWQKICAgICAgICAgKiBAcGFyYW0gc2NoZW1hCiAgICAgICAgICogQHBhcmFtIGFzc2VydGVkSWRlbnRpdHkgLSB1c2VyIGlkZW50aXR5CiAgICAgICAgICogQHJldHVybiBEZWxldGUgTWVzc2FnZQogICAgICAgICAqLwogICAgfSwgewogICAgICAgIGtleTogJ2NyZWF0ZURlbGV0ZU1lc3NhZ2VSZXF1ZXN0JywKICAgICAgICB2YWx1ZTogZnVuY3Rpb24gY3JlYXRlRGVsZXRlTWVzc2FnZVJlcXVlc3QoZnJvbSwgdG8sIGNvbnRleHRJZCwgaWRUb2tlbiwgYWNjZXNzVG9rZW4sIHJlc291cmNlLCBzaWduYXR1cmUsIGF0dHJpYnV0ZSwgc2NoZW1hLCBhc3NlcnRlZElkZW50aXR5KSB7CiAgICAgICAgICAgIGlmICh0eXBlb2YgZnJvbSA9PT0gJ3VuZGVmaW5lZCcgfHwgdHlwZW9mIGNvbnRleHRJZCA9PT0gJ3VuZGVmaW5lZCcpIHRocm93IG5ldyBFcnJvcigiZnJvbSwgY29udGV4dElkLCBhbmQgdmFsdWUgb2Ygb2JqZWN0IHRvIGJlIGNyZWF0ZWQgTVVTVCBiZSBzcGVjaWZpZWQiKTsKICAgICAgICAgICAgdmFyIG1lc3NhZ2VCb2R5ID0gbmV3IF9NZXNzYWdlQm9keUpzLkRlbGV0ZU1lc3NhZ2VCb2R5KGlkVG9rZW4sIGFjY2Vzc1Rva2VuLCByZXNvdXJjZSwgYXR0cmlidXRlLCBzY2hlbWEsIGFzc2VydGVkSWRlbnRpdHkpOwogICAgICAgICAgICB2YXIgbWVzc2FnZSA9IG5ldyBfTWVzc2FnZUpzMlsnZGVmYXVsdCddKE1lc3NhZ2VGYWN0b3J5Ll9nZW5lcmF0ZU1lc3NhZ2VJZCgpLCBmcm9tLCB0bywgX01lc3NhZ2VKcy5NZXNzYWdlVHlwZS5ERUxFVEUsIGNvbnRleHRJZCwgbWVzc2FnZUJvZHksIHNpZ25hdHVyZSk7CiAgICAgICAgICAgIHJldHVybiBtZXNzYWdlOwogICAgICAgIH0KCiAgICAgICAgLyoqCiAgICAgICAgICogQ3JlYXRlcyBhbiBVcGRhdGUgTWVzc2FnZSBSZXF1ZXN0CiAgICAgICAgICogQHBhcmFtIHtVUkwuVVJMfSBmcm9tIC0gdGhlIHNlbmRlciBvZiB0aGlzIG1lc3NhZ2UKICAgICAgICAgKiBAcGFyYW0ge1VSTC5VUkxMaXN0fSBPbmUgb3IgbW9yZSBVUkxzIG9mIE1lc3NhZ2UgcmVjaXBpZW50cy4gQWNjb3JkaW5nIHRvIHRoZSBVUkwgc2NoZW1lIGl0IG1heSBiZSBoYW5kbGVkIGluCiAgICAgICAgICogZGlmZmVyZW50IHdheXMKICAgICAgICAgKiBAcGFyYW0ge09iamVjdH0gY29udGV4dElkIC0gdGhlIEdVSUQgdXNlZCB0byBpZGVudGl0eSBlZyBhIGNvbW11bmljYXRpb24gc2Vzc2lvbiBsaWtlIGEgdGVsZXBob255IGNhbGwKICAgICAgICAgKiBAcGFyYW0ge0lkZW50aXR5LkpXVH0gaWRUb2tlbiAtIHRva2VuIGZvciBJZGVudGl0eSBhc3NlcnRpb24gcHVycG9zZQogICAgICAgICAqIEBwYXJhbSB7SWRlbnRpdHkuSldUfSBhY2Nlc3NUb2tlbiAtIGFjY2VzcyB0b2tlbiBmb3IgYWNjZXNzIGNvbnRyb2wgcHVycG9zZXMKICAgICAgICAgKiBAcGFyYW0ge1VSTC5VUmx9IHJlc291cmNlIC0gVVJMIG9mIERhdGEgT2JqZWN0IFJlc291cmNlIGFzc29jaWF0ZWQgd2l0aCB0aGUgbWVzc2FnZQogICAgICAgICAqIEBwYXJhbSB7c3RyaW5nfSBzaWduYXR1cmUgLQogICAgICAgICAqIEBwYXJhbSBhdHRyaWJ1dGUgLSBJZGVudGlmaWVzIHRoZSBhdHRyaWJ1dGUgaW4gdGhlIE9iamVjdCB0byBiZSB1cGRhdGVkCiAgICAgICAgICogQHBhcmFtIHZhbHVlIC0gVGhlIG5ldyB2YWx1ZSBvZiB0aGUgYXR0cmlidXRlIHRvIGJlIHVwZGF0ZWQKICAgICAgICAgKi8KICAgIH0sIHsKICAgICAgICBrZXk6ICdjcmVhdGVVcGRhdGVNZXNzYWdlUmVxdWVzdCcsCiAgICAgICAgdmFsdWU6IGZ1bmN0aW9uIGNyZWF0ZVVwZGF0ZU1lc3NhZ2VSZXF1ZXN0KGZyb20sIHRvLCBjb250ZXh0SWQsIGlkVG9rZW4sIGFjY2Vzc1Rva2VuLCByZXNvdXJjZSwgc2lnbmF0dXJlLCBzY2hlbWEsIGFzc2VydGVkSWRlbnRpdHksIGF0dHJpYnV0ZSwgdmFsdWUpIHsKICAgICAgICAgICAgaWYgKHR5cGVvZiBmcm9tID09PSAndW5kZWZpbmVkJyB8fCB0eXBlb2YgY29udGV4dElkID09PSAndW5kZWZpbmVkJykgdGhyb3cgbmV3IEVycm9yKCJmcm9tLCBhbmQgY29udGV4dElkIE1VU1QgYmUgc3BlY2lmaWVkIik7CiAgICAgICAgICAgIHZhciBtZXNzYWdlQm9keSA9IG5ldyBfTWVzc2FnZUJvZHlKcy5VcGRhdGVNZXNzYWdlQm9keShpZFRva2VuLCBhY2Nlc3NUb2tlbiwgcmVzb3VyY2UsIHNjaGVtYSwgYXNzZXJ0ZWRJZGVudGl0eSwgYXR0cmlidXRlLCB2YWx1ZSk7CiAgICAgICAgICAgIHZhciBtZXNzYWdlID0gbmV3IF9NZXNzYWdlSnMyWydkZWZhdWx0J10oTWVzc2FnZUZhY3RvcnkuX2dlbmVyYXRlTWVzc2FnZUlkKCksIGZyb20sIHRvLCBfTWVzc2FnZUpzLk1lc3NhZ2VUeXBlLlVQREFURSwgY29udGV4dElkLCBtZXNzYWdlQm9keSwgc2lnbmF0dXJlKTsKICAgICAgICAgICAgcmV0dXJuIG1lc3NhZ2U7CiAgICAgICAgfQoKICAgICAgICAvKioKICAgICAgICAgKgogICAgICAgICAqIEBwYXJhbSB7VVJMLlVSTH0gZnJvbSAtIHRoZSBzZW5kZXIgb2YgdGhpcyBtZXNzYWdlCiAgICAgICAgICogQHBhcmFtIHtVUkwuVVJMTGlzdH0gT25lIG9yIG1vcmUgVVJMcyBvZiBNZXNzYWdlIHJlY2lwaWVudHMuIEFjY29yZGluZyB0byB0aGUgVVJMIHNjaGVtZSBpdCBtYXkgYmUgaGFuZGxlZCBpbgogICAgICAgICAqIGRpZmZlcmVudCB3YXlzCiAgICAgICAgICogQHBhcmFtIHtPYmplY3R9IGNvbnRleHRJZCAtIHRoZSBHVUlEIHVzZWQgdG8gaWRlbnRpdHkgZWcgYSBjb21tdW5pY2F0aW9uIHNlc3Npb24gbGlrZSBhIHRlbGVwaG9ueSBjYWxsCiAgICAgICAgICogQHBhcmFtIHtJZGVudGl0eS5KV1R9IGlkVG9rZW4gLSB0b2tlbiBmb3IgSWRlbnRpdHkgYXNzZXJ0aW9uIHB1cnBvc2UKICAgICAgICAgKiBAcGFyYW0ge0lkZW50aXR5LkpXVH0gYWNjZXNzVG9rZW4gLSBhY2Nlc3MgdG9rZW4gZm9yIGFjY2VzcyBjb250cm9sIHB1cnBvc2VzCiAgICAgICAgICogQHBhcmFtIHtVUkwuVVJsfSByZXNvdXJjZSAtIFVSTCBvZiBEYXRhIE9iamVjdCBSZXNvdXJjZSBhc3NvY2lhdGVkIHdpdGggdGhlIG1lc3NhZ2UKICAgICAgICAgKiBAcGFyYW0ge3N0cmluZ30gc2lnbmF0dXJlIC0KICAgICAgICAgKiBAcGFyYW0gc2NoZW1hIC0KICAgICAgICAgKiBAcGFyYW0gYXNzZXJ0ZWRJZGVudGl0eSAtIHRoZSB1c2VyIGlkZW50aXR5CiAgICAgICAgICogQHBhcmFtIGF0dHJpYnV0ZSAtIElkZW50aWZpZXMgdGhlIGF0dHJpYnV0ZSBpbiB0aGUgT2JqZWN0IHRvIGJlIHJlYWQKICAgICAgICAgKiBAcGFyYW0gY3JpdGVyaWFTeW50YXggLQogICAgICAgICAqIEBwYXJhbSBjcml0ZXJpYSAtCiAgICAgICAgICovCiAgICB9LCB7CiAgICAgICAga2V5OiAnY3JlYXRlUmVhZE1lc3NhZ2VSZXF1ZXN0JywKICAgICAgICB2YWx1ZTogZnVuY3Rpb24gY3JlYXRlUmVhZE1lc3NhZ2VSZXF1ZXN0KGZyb20sIHRvLCBjb250ZXh0SWQsIGlkVG9rZW4sIGFjY2Vzc1Rva2VuLCByZXNvdXJjZSwgc2lnbmF0dXJlLCBzY2hlbWEsIGFzc2VydGVkSWRlbnRpdHksIGF0dHJpYnV0ZSwgY3JpdGVyaWFTeW50YXgsIGNyaXRlcmlhKSB7CiAgICAgICAgICAgIGlmICh0eXBlb2YgZnJvbSA9PT0gJ3VuZGVmaW5lZCcgfHwgdHlwZW9mIGNvbnRleHRJZCA9PT0gJ3VuZGVmaW5lZCcpIHRocm93IG5ldyBFcnJvcigiZnJvbSwgYW5kIGNvbnRleHRJZCBNVVNUIGJlIHNwZWNpZmllZCIpOwogICAgICAgICAgICB2YXIgbWVzc2FnZUJvZHkgPSBuZXcgX01lc3NhZ2VCb2R5SnMuUmVhZE1lc3NhZ2VCb2R5KGlkVG9rZW4sIGFjY2Vzc1Rva2VuLCByZXNvdXJjZSwgc2NoZW1hLCBhc3NlcnRlZElkZW50aXR5LCBhdHRyaWJ1dGUsIGNyaXRlcmlhU3ludGF4LCBjcml0ZXJpYSk7CiAgICAgICAgICAgIHZhciBtZXNzYWdlID0gbmV3IF9NZXNzYWdlSnMyWydkZWZhdWx0J10oTWVzc2FnZUZhY3RvcnkuX2dlbmVyYXRlTWVzc2FnZUlkKCksIGZyb20sIHRvLCBfTWVzc2FnZUpzLk1lc3NhZ2VUeXBlLlVQREFURSwgY29udGV4dElkLCBtZXNzYWdlQm9keSwgc2lnbmF0dXJlKTsKICAgICAgICAgICAgcmV0dXJuIG1lc3NhZ2U7CiAgICAgICAgfQoKICAgICAgICAvKioKICAgICAgICAgKgogICAgICAgICAqIEBwYXJhbSB7VVJMLlVSTH0gZnJvbSAtIHRoZSBzZW5kZXIgb2YgdGhpcyBtZXNzYWdlCiAgICAgICAgICogQHBhcmFtIHtVUkwuVVJMTGlzdH0gT25lIG9yIG1vcmUgVVJMcyBvZiBNZXNzYWdlIHJlY2lwaWVudHMuIEFjY29yZGluZyB0byB0aGUgVVJMIHNjaGVtZSBpdCBtYXkgYmUgaGFuZGxlZCBpbgogICAgICAgICAqIGRpZmZlcmVudCB3YXlzCiAgICAgICAgICogQHBhcmFtIHtPYmplY3R9IGNvbnRleHRJZCAtIHRoZSBHVUlEIHVzZWQgdG8gaWRlbnRpdHkgZWcgYSBjb21tdW5pY2F0aW9uIHNlc3Npb24gbGlrZSBhIHRlbGVwaG9ueSBjYWxsCiAgICAgICAgICogQHBhcmFtIHtJZGVudGl0eS5KV1R9IGlkVG9rZW4gLSB0b2tlbiBmb3IgSWRlbnRpdHkgYXNzZXJ0aW9uIHB1cnBvc2UKICAgICAgICAgKiBAcGFyYW0ge0lkZW50aXR5LkpXVH0gYWNjZXNzVG9rZW4gLSBhY2Nlc3MgdG9rZW4gZm9yIGFjY2VzcyBjb250cm9sIHB1cnBvc2VzCiAgICAgICAgICogQHBhcmFtIHtVUkwuVVJsfSByZXNvdXJjZSAtIFVSTCBvZiBEYXRhIE9iamVjdCBSZXNvdXJjZSBhc3NvY2lhdGVkIHdpdGggdGhlIG1lc3NhZ2UKICAgICAgICAgKiBAcGFyYW0ge3N0cmluZ30gc2lnbmF0dXJlIC0KICAgICAgICAgKiBAcGFyYW0gc2NoZW1hIC0KICAgICAgICAgKiBAcGFyYW0gYXNzZXJ0ZWRJZGVudGl0eSAtIHRoZSB1c2VyJ3MgaWRlbnRpdHkKICAgICAgICAgKiBAcGFyYW0gY29kZSAtIHJlc3BvbnNlIGNvZGUgY29tcGxpYW50IHdpdGggSFRUUCByZXNwb25zZSBjb2RlcyAoUkZDNzIzMSkuCiAgICAgICAgICogQHBhcmFtIHZhbHVlIC0gQ29udGFpbnMgYSBkYXRhIHZhbHVlIGluIEpTT04gZm9ybWF0LgogICAgICAgICAqLwogICAgfSwgewogICAgICAgIGtleTogJ2NyZWF0ZU1lc3NhZ2VSZXNwb25zZScsCiAgICAgICAgdmFsdWU6IGZ1bmN0aW9uIGNyZWF0ZU1lc3NhZ2VSZXNwb25zZShmcm9tLCB0bywgY29udGV4dElkLCBpZFRva2VuLCBhY2Nlc3NUb2tlbiwgcmVzb3VyY2UsIHNpZ25hdHVyZSwgc2NoZW1hLCBhc3NlcnRlZElkZW50aXR5LCBjb2RlLCB2YWx1ZSkgewogICAgICAgICAgICBpZiAodHlwZW9mIGZyb20gPT09ICd1bmRlZmluZWQnIHx8IHR5cGVvZiBjb250ZXh0SWQgPT09ICd1bmRlZmluZWQnIHx8IHR5cGVvZiBjb2RlID09PSAndW5kZWZpbmVkJykgdGhyb3cgbmV3IEVycm9yKCJmcm9tLCBjb250ZXh0SWQsIGFuZCByZXNwb25zZSBDb2RlIE1VU1QgYmUgc3BlY2lmaWVkIik7CiAgICAgICAgICAgIHZhciByZXNwb25zZSA9IG5ldyBfTWVzc2FnZUJvZHlKcy5SZXNwb25zZU1lc3NhZ2VCb2R5KGlkVG9rZW4sIGFjY2Vzc1Rva2VuLCByZXNvdXJjZSwgY29kZSwgdmFsdWUpOwogICAgICAgICAgICByZXR1cm4gbmV3IF9NZXNzYWdlSnMyWydkZWZhdWx0J10oTWVzc2FnZUZhY3RvcnkuX2dlbmVyYXRlTWVzc2FnZUlkKCksIGZyb20sIHRvLCBfTWVzc2FnZUpzLk1lc3NhZ2VUeXBlLlJFU1BPTlNFLCBjb250ZXh0SWQsIHJlc3BvbnNlLCBzaWduYXR1cmUpOwogICAgICAgIH0KCiAgICAgICAgLyoqCiAgICAgICAgICogR2VuZXJhdGUgYSBEZWxldGUgTWVzc2FnZSBCb2R5IHRvIHRoZSBnaXZlbiBNZXNzYWdlCiAgICAgICAgICogQHBhcmFtIHtNZXNzYWdlfSBkYXRhIC0gdGhlIGlucHV0IE1lc3NhZ2UKICAgICAgICAgKiBAcGFyYW0ge3N0cmluZ30gYXR0cmlidXRlIC0gdGhlIGF0dHJpYnV0ZSB0byBiZSBkZWxldGVkCiAgICAgICAgICogQHJldHVybiB7TWVzc2FnZX0gRGVsZXRlIE1lc3NhZ2UKICAgICAgICAgKi8KICAgIH0sIHsKICAgICAgICBrZXk6ICdnZW5lcmF0ZURlbGV0ZU1lc3NhZ2VCb2R5JywKICAgICAgICB2YWx1ZTogZnVuY3Rpb24gZ2VuZXJhdGVEZWxldGVNZXNzYWdlQm9keShkYXRhLCBhdHRyaWJ1dGUpIHsKICAgICAgICAgICAgaWYgKHR5cGVvZiBkYXRhID09PSAndW5kZWZpbmVkJyB8fCB0eXBlb2YgYXR0cmlidXRlID09PSAndW5kZWZpbmVkJykgdGhyb3cgbmV3IEVycm9yKCJtZXNzYWdlIGFuZCBhdHRyaWJ1dGUgTVVTVCBiZSBzcGVjaWZpZWQiKTsKICAgICAgICAgICAgdmFyIHByZXZpb3VzQm9keSA9IGRhdGEuYm9keTsKICAgICAgICAgICAgdmFyIGlkVG9rZW4gPSBwcmV2aW91c0JvZHkuaWRUb2tlbjsKICAgICAgICAgICAgdmFyIGFjY2Vzc1Rva2VuID0gcHJldmlvdXNCb2R5LmFjY2Vzc1Rva2VuOwogICAgICAgICAgICB2YXIgcmVzb3VyY2UgPSBwcmV2aW91c0JvZHkucmVzb3VyY2U7CiAgICAgICAgICAgIHZhciBzY2hlbWEgPSBwcmV2aW91c0JvZHkuc2NoZW1hOwogICAgICAgICAgICB2YXIgYXNzZXJ0ZWRJZGVudGl0eSA9IHByZXZpb3VzQm9keS5hc3NlcnRlZElkZW50aXR5OwoKICAgICAgICAgICAgdmFyIG5ld0JvZHkgPSBuZXcgX01lc3NhZ2VCb2R5SnMuRGVsZXRlTWVzc2FnZUJvZHkoaWRUb2tlbiwgYWNjZXNzVG9rZW4sIHJlc291cmNlLCBhdHRyaWJ1dGUsIHNjaGVtYSwgYXNzZXJ0ZWRJZGVudGl0eSk7CiAgICAgICAgICAgIHJldHVybiBuZXcgX01lc3NhZ2VKczJbJ2RlZmF1bHQnXShkYXRhLmlkLCBkYXRhLmZyb20sIGRhdGEudG8sIF9NZXNzYWdlSnMuTWVzc2FnZVR5cGUuREVMRVRFLCBkYXRhLmNvbnRleHRJZCwgbmV3Qm9keSwgZGF0YS5zaWduYXR1cmUpOwogICAgICAgIH0KCiAgICAgICAgLyoqCiAgICAgICAgICogR2VuZXJhdGUgYW4gVXBkYXRlIE1lc3NhZ2UgQm9keSB0byB0aGUgZ2l2ZW4gTWVzc2FnZQogICAgICAgICAqIEBwYXJhbSB7TWVzc2FnZX0gZGF0YSAtIE1lc3NhZ2UgdG8gYmUgdXBkYXRlZAogICAgICAgICAqIEBwYXJhbSB7c3RyaW5nfSBhdHRyaWJ1dGUgdG8gYmUgdXBkYXRlZAogICAgICAgICAqIEBwYXJhbSB7b2JqZWN0fSB2YWx1ZSB0aGUgbmV3IHZhbHVlIG9mIHRoZSBhdHRyaWJ1dGUKICAgICAgICAgKiBAcmV0dXJuIHtNZXNzYWdlfSBVcGRhdGUgTWVzc2FnZQogICAgICAgICAqLwogICAgfSwgewogICAgICAgIGtleTogJ2dlbmVyYXRlVXBkYXRlTWVzc2FnZUJvZHknLAogICAgICAgIHZhbHVlOiBmdW5jdGlvbiBnZW5lcmF0ZVVwZGF0ZU1lc3NhZ2VCb2R5KGRhdGEsIGF0dHJpYnV0ZSwgdmFsdWUpIHsKICAgICAgICAgICAgaWYgKCFkYXRhIHx8ICFhdHRyaWJ1dGUgfHwgIXZhbHVlKSB0aHJvdyBuZXcgRXJyb3IoIm1lc3NhZ2UgYXR0cmlidXRlIGFuZCB2YWx1ZSBNVVNUIGJlIHNwZWNpZmllZCIpOwogICAgICAgICAgICB2YXIgcHJldmlvdXNCb2R5ID0gZGF0YS5ib2R5OwogICAgICAgICAgICB2YXIgaWRUb2tlbiA9IHByZXZpb3VzQm9keS5pZFRva2VuOwogICAgICAgICAgICB2YXIgYWNjZXNzVG9rZW4gPSBwcmV2aW91c0JvZHkuYWNjZXNzVG9rZW47CiAgICAgICAgICAgIHZhciByZXNvdXJjZSA9IHByZXZpb3VzQm9keS5yZXNvdXJjZTsKICAgICAgICAgICAgdmFyIHNjaGVtYSA9IHByZXZpb3VzQm9keS5zY2hlbWE7CiAgICAgICAgICAgIHZhciBhc3NlcnRlZElkZW50aXR5ID0gcHJldmlvdXNCb2R5LmFzc2VydGVkSWRlbnRpdHk7CgogICAgICAgICAgICB2YXIgbmV3Qm9keSA9IG5ldyBfTWVzc2FnZUJvZHlKcy5VcGRhdGVNZXNzYWdlQm9keShpZFRva2VuLCBhY2Nlc3NUb2tlbiwgcmVzb3VyY2UsIHNjaGVtYSwgYXNzZXJ0ZWRJZGVudGl0eSwgYXR0cmlidXRlLCB2YWx1ZSk7CiAgICAgICAgICAgIHJldHVybiBuZXcgX01lc3NhZ2VKczJbJ2RlZmF1bHQnXShkYXRhLmlkLCBkYXRhLmZyb20sIGRhdGEudG8sIF9NZXNzYWdlSnMuTWVzc2FnZVR5cGUuVVBEQVRFLCBkYXRhLmNvbnRleHRJZCwgbmV3Qm9keSwgZGF0YS5zaWduYXR1cmUpOwogICAgICAgIH0KCiAgICAgICAgLyoqCiAgICAgICAgICogZ2VuZXJhdGUgYSBSZWFkIE1lc3NhZ2UgQm9keSB0byBnaXZlbiByZXF1ZXN0CiAgICAgICAgICogQHBhcmFtIHtNZXNzYWdlfSBkYXRhIC0gTWVzc2FnZSB0byBiZSB1cGRhdGVkCiAgICAgICAgICogQHBhcmFtIHtPYmplY3R9IGF0dHJpYnV0ZSAtIElkZW50aWZpZXMgdGhlIGF0dHJpYnV0ZSBpbiB0aGUgT2JqZWN0IHRvIGJlIHJlYWQKICAgICAgICAgKiBAcGFyYW0ge09iamVjdH0gY3JpdGVyaWEKICAgICAgICAgKiBAcGFyYW0ge09iamVjdH0gY3JpdGVyaWFTeW50YXgKICAgICAgICAgKi8KICAgIH0sIHsKICAgICAgICBrZXk6ICdnZW5lcmF0ZVJlYWRNZXNzYWdlQm9keScsCiAgICAgICAgdmFsdWU6IGZ1bmN0aW9uIGdlbmVyYXRlUmVhZE1lc3NhZ2VCb2R5KGRhdGEsIGF0dHJpYnV0ZSwgY3JpdGVyaWEsIGNyaXRlcmlhU3ludGF4KSB7CiAgICAgICAgICAgIGlmICghZGF0YSkgdGhyb3cgbmV3IEVycm9yKCJtZXNzYWdlIE1VU1QgYmUgc3BlY2lmaWVkIik7CiAgICAgICAgICAgIHZhciBwcmV2aW91c0JvZHkgPSBkYXRhLmJvZHk7CiAgICAgICAgICAgIHZhciBpZFRva2VuID0gcHJldmlvdXNCb2R5LmlkVG9rZW47CiAgICAgICAgICAgIHZhciBhY2Nlc3NUb2tlbiA9IHByZXZpb3VzQm9keS5hY2Nlc3NUb2tlbjsKICAgICAgICAgICAgdmFyIHJlc291cmNlID0gcHJldmlvdXNCb2R5LnJlc291cmNlOwogICAgICAgICAgICB2YXIgc2NoZW1hID0gcHJldmlvdXNCb2R5LnNjaGVtYTsKICAgICAgICAgICAgdmFyIGFzc2VydGVkSWRlbnRpdHkgPSBwcmV2aW91c0JvZHkuYXNzZXJ0ZWRJZGVudGl0eTsKCiAgICAgICAgICAgIHZhciByZWFkQm9keSA9IG5ldyBfTWVzc2FnZUJvZHlKcy5SZWFkTWVzc2FnZUJvZHkoaWRUb2tlbiwgYWNjZXNzVG9rZW4sIHJlc291cmNlLCBzY2hlbWEsIGFzc2VydGVkSWRlbnRpdHksIGF0dHJpYnV0ZSwgY3JpdGVyaWFTeW50YXgsIGNyaXRlcmlhKTsKICAgICAgICAgICAgcmV0dXJuIG5ldyBfTWVzc2FnZUpzMlsnZGVmYXVsdCddKGRhdGEuaWQsIGRhdGEuZnJvbSwgZGF0YS50bywgX01lc3NhZ2VKcy5NZXNzYWdlVHlwZS5SRUFELCBkYXRhLmNvbnRleHRJZCwgcmVhZEJvZHksIGRhdGEuc2lnbmF0dXJlKTsKICAgICAgICB9CgogICAgICAgIC8qKgogICAgICAgICAqIEdlbmVyYXRlIGEgcmVzcG9uc2UgdG8gdGhlIGdpdmVuIE1lc3NhZ2UKICAgICAgICAgKiBAcGFyYW0ge01lc3NhZ2V9IGRhdGEgLSBNZXNzYWdlIHRvIGJlIHVwZGF0ZWQKICAgICAgICAgKiBAcGFyYW0gY29kZSAtIHJlc3BvbnNlIGNvZGUgY29tcGxpYW50IHdpdGggSFRUUCByZXNwb25zZSBjb2RlcyAoUkZDNzIzMSkuCiAgICAgICAgICogQHBhcmFtIHZhbHVlIC0gQ29udGFpbnMgYSBkYXRhIHZhbHVlIGluIEpTT04gZm9ybWF0LgogICAgICAgICAqLwogICAgfSwgewogICAgICAgIGtleTogJ2dlbmVyYXRlTWVzc2FnZVJlc3BvbnNlJywKICAgICAgICB2YWx1ZTogZnVuY3Rpb24gZ2VuZXJhdGVNZXNzYWdlUmVzcG9uc2UoZGF0YSwgY29kZSwgdmFsdWUpIHsKICAgICAgICAgICAgaWYgKCFkYXRhIHx8ICFjb2RlKSB0aHJvdyBuZXcgRXJyb3IoIm1lc3NhZ2UgYW5kIHJlc3BvbnNlIGNvZGUgTVVTVCBiZSBzcGVjaWZpZWQiKTsKCiAgICAgICAgICAgIHZhciBwcmV2aW91c0JvZHkgPSBkYXRhLmJvZHk7CiAgICAgICAgICAgIHZhciBpZFRva2VuID0gcHJldmlvdXNCb2R5LmlkVG9rZW47CiAgICAgICAgICAgIHZhciBhY2Nlc3NUb2tlbiA9IHByZXZpb3VzQm9keS5hY2Nlc3NUb2tlbjsKICAgICAgICAgICAgdmFyIHJlc291cmNlID0gcHJldmlvdXNCb2R5LnJlc291cmNlOwoKICAgICAgICAgICAgdmFyIHJlc3BvbnNlID0gbmV3IF9NZXNzYWdlQm9keUpzLlJlc3BvbnNlTWVzc2FnZUJvZHkoaWRUb2tlbiwgYWNjZXNzVG9rZW4sIHJlc291cmNlLCBjb2RlLCB2YWx1ZSk7CiAgICAgICAgICAgIHJldHVybiBuZXcgX01lc3NhZ2VKczJbJ2RlZmF1bHQnXShkYXRhLmlkLCBkYXRhLmZyb20sIGRhdGEudG8sIF9NZXNzYWdlSnMuTWVzc2FnZVR5cGUuUkVTUE9OU0UsIGRhdGEuY29udGV4dElkLCByZXNwb25zZSwgZGF0YS5zaWduYXR1cmUpOwogICAgICAgIH0KICAgIH1dLCBbewogICAgICAgIGtleTogJ19nZW5lcmF0ZU1lc3NhZ2VJZCcsCiAgICAgICAgdmFsdWU6IGZ1bmN0aW9uIF9nZW5lcmF0ZU1lc3NhZ2VJZCgpIHsKICAgICAgICAgICAgdmFyIGQgPSBuZXcgRGF0ZSgpLmdldFRpbWUoKTsKCiAgICAgICAgICAgIHJldHVybiAneHh4eHh4eHgteHh4eC00eHh4LXl4eHgteHh4eHh4eHh4eHh4Jy5yZXBsYWNlKC9beHldL2csIGZ1bmN0aW9uIChjKSB7CiAgICAgICAgICAgICAgICB2YXIgciA9IChkICsgTWF0aC5yYW5kb20oKSAqIDE2KSAlIDE2IHwgMDsKICAgICAgICAgICAgICAgIGQgPSBNYXRoLmZsb29yKGQgLyAxNik7CiAgICAgICAgICAgICAgICByZXR1cm4gKGMgPT0gJ3gnID8gciA6IHIgJiAweDMgfCAweDgpLnRvU3RyaW5nKDE2KTsKICAgICAgICAgICAgfSk7CiAgICAgICAgfQogICAgfV0pOwoKICAgIHJldHVybiBNZXNzYWdlRmFjdG9yeTsKfSkoX3JlVEhJTktPYmplY3RSZXRoaW5rT2JqZWN0SnMyWydkZWZhdWx0J10pOwoKZXhwb3J0c1snZGVmYXVsdCddID0gTWVzc2FnZUZhY3Rvcnk7Cm1vZHVsZS5leHBvcnRzID0gZXhwb3J0c1snZGVmYXVsdCddOwoKfSx7Ii4uL3JlVEhJTktPYmplY3QvUmV0aGlua09iamVjdC5qcyI6MTcsIi4vTWVzc2FnZS5qcyI6MTQsIi4vTWVzc2FnZUJvZHkuanMiOjE1fV0sMTc6W2Z1bmN0aW9uKHJlcXVpcmUsbW9kdWxlLGV4cG9ydHMpewoidXNlIHN0cmljdCI7CgpPYmplY3QuZGVmaW5lUHJvcGVydHkoZXhwb3J0cywgIl9fZXNNb2R1bGUiLCB7CiAgICB2YWx1ZTogdHJ1ZQp9KTsKCnZhciBfY3JlYXRlQ2xhc3MgPSAoZnVuY3Rpb24gKCkgeyBmdW5jdGlvbiBkZWZpbmVQcm9wZXJ0aWVzKHRhcmdldCwgcHJvcHMpIHsgZm9yICh2YXIgaSA9IDA7IGkgPCBwcm9wcy5sZW5ndGg7IGkrKykgeyB2YXIgZGVzY3JpcHRvciA9IHByb3BzW2ldOyBkZXNjcmlwdG9yLmVudW1lcmFibGUgPSBkZXNjcmlwdG9yLmVudW1lcmFibGUgfHwgZmFsc2U7IGRlc2NyaXB0b3IuY29uZmlndXJhYmxlID0gdHJ1ZTsgaWYgKCJ2YWx1ZSIgaW4gZGVzY3JpcHRvcikgZGVzY3JpcHRvci53cml0YWJsZSA9IHRydWU7IE9iamVjdC5kZWZpbmVQcm9wZXJ0eSh0YXJnZXQsIGRlc2NyaXB0b3Iua2V5LCBkZXNjcmlwdG9yKTsgfSB9IHJldHVybiBmdW5jdGlvbiAoQ29uc3RydWN0b3IsIHByb3RvUHJvcHMsIHN0YXRpY1Byb3BzKSB7IGlmIChwcm90b1Byb3BzKSBkZWZpbmVQcm9wZXJ0aWVzKENvbnN0cnVjdG9yLnByb3RvdHlwZSwgcHJvdG9Qcm9wcyk7IGlmIChzdGF0aWNQcm9wcykgZGVmaW5lUHJvcGVydGllcyhDb25zdHJ1Y3Rvciwgc3RhdGljUHJvcHMpOyByZXR1cm4gQ29uc3RydWN0b3I7IH07IH0pKCk7CgpmdW5jdGlvbiBfaW50ZXJvcFJlcXVpcmVEZWZhdWx0KG9iaikgeyByZXR1cm4gb2JqICYmIG9iai5fX2VzTW9kdWxlID8gb2JqIDogeyAiZGVmYXVsdCI6IG9iaiB9OyB9CgpmdW5jdGlvbiBfY2xhc3NDYWxsQ2hlY2soaW5zdGFuY2UsIENvbnN0cnVjdG9yKSB7IGlmICghKGluc3RhbmNlIGluc3RhbmNlb2YgQ29uc3RydWN0b3IpKSB7IHRocm93IG5ldyBUeXBlRXJyb3IoIkNhbm5vdCBjYWxsIGEgY2xhc3MgYXMgYSBmdW5jdGlvbiIpOyB9IH0KCnZhciBfdHY0ID0gcmVxdWlyZSgidHY0Iik7Cgp2YXIgX3R2NDIgPSBfaW50ZXJvcFJlcXVpcmVEZWZhdWx0KF90djQpOwoKdmFyIFJldGhpbmtPYmplY3QgPSAoZnVuY3Rpb24gKCkgewogICAgZnVuY3Rpb24gUmV0aGlua09iamVjdCh2YWxpZGF0aW9uLCBzY2hlbWEpIHsKICAgICAgICBfY2xhc3NDYWxsQ2hlY2sodGhpcywgUmV0aGlua09iamVjdCk7CgogICAgICAgIHZhciBfdGhpcyA9IHRoaXM7CgogICAgICAgIHRoaXMudmFsaWRhdGlvbiA9IHZhbGlkYXRpb247CiAgICAgICAgdGhpcy5zY2hlbWEgPSBzY2hlbWE7CiAgICB9CgogICAgX2NyZWF0ZUNsYXNzKFJldGhpbmtPYmplY3QsIFt7CiAgICAgICAga2V5OiAidmFsaWRhdGUiLAogICAgICAgIHZhbHVlOiBmdW5jdGlvbiB2YWxpZGF0ZShkYXRhKSB7CiAgICAgICAgICAgIGlmICh0aGlzLnNjaGVtYSkgcmV0dXJuIF90djQyWyJkZWZhdWx0Il0udmFsaWRhdGUoZGF0YSwgdGhpcy5zY2hlbWEpO2Vsc2UgcmV0dXJuIGZhbHNlOwogICAgICAgIH0KICAgIH1dKTsKCiAgICByZXR1cm4gUmV0aGlua09iamVjdDsKfSkoKTsKCmV4cG9ydHMuUmV0aGlua09iamVjdCA9IFJldGhpbmtPYmplY3Q7CmV4cG9ydHNbImRlZmF1bHQiXSA9IFJldGhpbmtPYmplY3Q7Cgp9LHsidHY0IjoxfV0sMTg6W2Z1bmN0aW9uKHJlcXVpcmUsbW9kdWxlLGV4cG9ydHMpewovLyBpbXBvcnQgQWRkcmVzc0ZhY3RvcnkgZnJvbSAnLi9hZGRyZXNzLWZhY3RvcnkvdXJsJzsKJ3VzZSBzdHJpY3QnOwoKT2JqZWN0LmRlZmluZVByb3BlcnR5KGV4cG9ydHMsICdfX2VzTW9kdWxlJywgewogIHZhbHVlOiB0cnVlCn0pOwoKZnVuY3Rpb24gX2ludGVyb3BSZXF1aXJlRGVmYXVsdChvYmopIHsgcmV0dXJuIG9iaiAmJiBvYmouX19lc01vZHVsZSA/IG9iaiA6IHsgJ2RlZmF1bHQnOiBvYmogfTsgfQoKdmFyIF9jYXRhbG9ndWVGYWN0b3J5Q2F0YWxvZ3VlRGF0YU9iamVjdEZhY3RvcnkgPSByZXF1aXJlKCcuL2NhdGFsb2d1ZS1mYWN0b3J5L0NhdGFsb2d1ZURhdGFPYmplY3RGYWN0b3J5Jyk7Cgp2YXIgX2NhdGFsb2d1ZUZhY3RvcnlDYXRhbG9ndWVEYXRhT2JqZWN0RmFjdG9yeTIgPSBfaW50ZXJvcFJlcXVpcmVEZWZhdWx0KF9jYXRhbG9ndWVGYWN0b3J5Q2F0YWxvZ3VlRGF0YU9iamVjdEZhY3RvcnkpOwoKdmFyIF9tZXNzYWdlRmFjdG9yeU1lc3NhZ2VGYWN0b3J5ID0gcmVxdWlyZSgnLi9tZXNzYWdlLWZhY3RvcnkvTWVzc2FnZUZhY3RvcnknKTsKCnZhciBfbWVzc2FnZUZhY3RvcnlNZXNzYWdlRmFjdG9yeTIgPSBfaW50ZXJvcFJlcXVpcmVEZWZhdWx0KF9tZXNzYWdlRmFjdG9yeU1lc3NhZ2VGYWN0b3J5KTsKCnZhciBfc3luY2hlclN5bmNoZXIgPSByZXF1aXJlKCcuL3N5bmNoZXIvU3luY2hlcicpOwoKdmFyIF9zeW5jaGVyU3luY2hlcjIgPSBfaW50ZXJvcFJlcXVpcmVEZWZhdWx0KF9zeW5jaGVyU3luY2hlcik7Cgp2YXIgX3N5bmNoZXJEYXRhT2JqZWN0UmVwb3J0ZXIgPSByZXF1aXJlKCcuL3N5bmNoZXIvRGF0YU9iamVjdFJlcG9ydGVyJyk7Cgp2YXIgX3N5bmNoZXJEYXRhT2JqZWN0UmVwb3J0ZXIyID0gX2ludGVyb3BSZXF1aXJlRGVmYXVsdChfc3luY2hlckRhdGFPYmplY3RSZXBvcnRlcik7Cgp2YXIgX3N5bmNoZXJEYXRhT2JqZWN0T2JzZXJ2ZXIgPSByZXF1aXJlKCcuL3N5bmNoZXIvRGF0YU9iamVjdE9ic2VydmVyJyk7Cgp2YXIgX3N5bmNoZXJEYXRhT2JqZWN0T2JzZXJ2ZXIyID0gX2ludGVyb3BSZXF1aXJlRGVmYXVsdChfc3luY2hlckRhdGFPYmplY3RPYnNlcnZlcik7Cgp2YXIgX2h5cGVydHlIeXBlcnR5Q29ubmVjdG9yID0gcmVxdWlyZSgnLi9oeXBlcnR5L0h5cGVydHlDb25uZWN0b3InKTsKCnZhciBfaHlwZXJ0eUh5cGVydHlDb25uZWN0b3IyID0gX2ludGVyb3BSZXF1aXJlRGVmYXVsdChfaHlwZXJ0eUh5cGVydHlDb25uZWN0b3IpOwoKdmFyIF9jYXRhbG9ndWVGYWN0b3J5SHlwZXJ0eURlc2NyaXB0b3IgPSByZXF1aXJlKCcuL2NhdGFsb2d1ZS1mYWN0b3J5L0h5cGVydHlEZXNjcmlwdG9yJyk7Cgp2YXIgX2NhdGFsb2d1ZUZhY3RvcnlIeXBlcnR5RGVzY3JpcHRvcjIgPSBfaW50ZXJvcFJlcXVpcmVEZWZhdWx0KF9jYXRhbG9ndWVGYWN0b3J5SHlwZXJ0eURlc2NyaXB0b3IpOwoKdmFyIF9jYXRhbG9ndWVGYWN0b3J5UHJvdG9jb2xTdHViRGVzY3JpcHRvciA9IHJlcXVpcmUoJy4vY2F0YWxvZ3VlLWZhY3RvcnkvUHJvdG9jb2xTdHViRGVzY3JpcHRvcicpOwoKdmFyIF9jYXRhbG9ndWVGYWN0b3J5UHJvdG9jb2xTdHViRGVzY3JpcHRvcjIgPSBfaW50ZXJvcFJlcXVpcmVEZWZhdWx0KF9jYXRhbG9ndWVGYWN0b3J5UHJvdG9jb2xTdHViRGVzY3JpcHRvcik7Cgp2YXIgX2NhdGFsb2d1ZUZhY3RvcnlTb3VyY2VQYWNrYWdlID0gcmVxdWlyZSgnLi9jYXRhbG9ndWUtZmFjdG9yeS9Tb3VyY2VQYWNrYWdlJyk7Cgp2YXIgX2NhdGFsb2d1ZUZhY3RvcnlTb3VyY2VQYWNrYWdlMiA9IF9pbnRlcm9wUmVxdWlyZURlZmF1bHQoX2NhdGFsb2d1ZUZhY3RvcnlTb3VyY2VQYWNrYWdlKTsKCi8vIGV4cG9ydCB7QWRkcmVzc0ZhY3Rvcnl9OwpleHBvcnRzLkNhdGFsb2d1ZUZhY3RvcnkgPSBfY2F0YWxvZ3VlRmFjdG9yeUNhdGFsb2d1ZURhdGFPYmplY3RGYWN0b3J5MlsnZGVmYXVsdCddOwpleHBvcnRzLk1lc3NhZ2VGYWN0b3J5ID0gX21lc3NhZ2VGYWN0b3J5TWVzc2FnZUZhY3RvcnkyWydkZWZhdWx0J107CmV4cG9ydHMuU3luY2hlciA9IF9zeW5jaGVyU3luY2hlcjJbJ2RlZmF1bHQnXTsKZXhwb3J0cy5EYXRhT2JqZWN0UmVwb3J0ZXIgPSBfc3luY2hlckRhdGFPYmplY3RSZXBvcnRlcjJbJ2RlZmF1bHQnXTsKZXhwb3J0cy5EYXRhT2JqZWN0T2JzZXJ2ZXIgPSBfc3luY2hlckRhdGFPYmplY3RPYnNlcnZlcjJbJ2RlZmF1bHQnXTsKZXhwb3J0cy5IeXBlcnR5Q29ubmVjdG9yID0gX2h5cGVydHlIeXBlcnR5Q29ubmVjdG9yMlsnZGVmYXVsdCddOwpleHBvcnRzLkh5cGVydHlEZXNjcmlwdG9yID0gX2NhdGFsb2d1ZUZhY3RvcnlIeXBlcnR5RGVzY3JpcHRvcjJbJ2RlZmF1bHQnXTsKZXhwb3J0cy5Qcm90b2NvbFN0dWJEZXNjcmlwdG9yID0gX2NhdGFsb2d1ZUZhY3RvcnlQcm90b2NvbFN0dWJEZXNjcmlwdG9yMlsnZGVmYXVsdCddOwpleHBvcnRzLlNvdXJjZVBhY2thZ2UgPSBfY2F0YWxvZ3VlRmFjdG9yeVNvdXJjZVBhY2thZ2UyWydkZWZhdWx0J107Cgp9LHsiLi9jYXRhbG9ndWUtZmFjdG9yeS9DYXRhbG9ndWVEYXRhT2JqZWN0RmFjdG9yeSI6NSwiLi9jYXRhbG9ndWUtZmFjdG9yeS9IeXBlcnR5RGVzY3JpcHRvciI6NywiLi9jYXRhbG9ndWUtZmFjdG9yeS9Qcm90b2NvbFN0dWJEZXNjcmlwdG9yIjoxMCwiLi9jYXRhbG9ndWUtZmFjdG9yeS9Tb3VyY2VQYWNrYWdlIjoxMSwiLi9oeXBlcnR5L0h5cGVydHlDb25uZWN0b3IiOjEzLCIuL21lc3NhZ2UtZmFjdG9yeS9NZXNzYWdlRmFjdG9yeSI6MTYsIi4vc3luY2hlci9EYXRhT2JqZWN0T2JzZXJ2ZXIiOjE5LCIuL3N5bmNoZXIvRGF0YU9iamVjdFJlcG9ydGVyIjoyMCwiLi9zeW5jaGVyL1N5bmNoZXIiOjIyfV0sMTk6W2Z1bmN0aW9uKHJlcXVpcmUsbW9kdWxlLGV4cG9ydHMpewondXNlIHN0cmljdCc7CgpPYmplY3QuZGVmaW5lUHJvcGVydHkoZXhwb3J0cywgJ19fZXNNb2R1bGUnLCB7CiAgdmFsdWU6IHRydWUKfSk7Cgp2YXIgX2NyZWF0ZUNsYXNzID0gKGZ1bmN0aW9uICgpIHsgZnVuY3Rpb24gZGVmaW5lUHJvcGVydGllcyh0YXJnZXQsIHByb3BzKSB7IGZvciAodmFyIGkgPSAwOyBpIDwgcHJvcHMubGVuZ3RoOyBpKyspIHsgdmFyIGRlc2NyaXB0b3IgPSBwcm9wc1tpXTsgZGVzY3JpcHRvci5lbnVtZXJhYmxlID0gZGVzY3JpcHRvci5lbnVtZXJhYmxlIHx8IGZhbHNlOyBkZXNjcmlwdG9yLmNvbmZpZ3VyYWJsZSA9IHRydWU7IGlmICgndmFsdWUnIGluIGRlc2NyaXB0b3IpIGRlc2NyaXB0b3Iud3JpdGFibGUgPSB0cnVlOyBPYmplY3QuZGVmaW5lUHJvcGVydHkodGFyZ2V0LCBkZXNjcmlwdG9yLmtleSwgZGVzY3JpcHRvcik7IH0gfSByZXR1cm4gZnVuY3Rpb24gKENvbnN0cnVjdG9yLCBwcm90b1Byb3BzLCBzdGF0aWNQcm9wcykgeyBpZiAocHJvdG9Qcm9wcykgZGVmaW5lUHJvcGVydGllcyhDb25zdHJ1Y3Rvci5wcm90b3R5cGUsIHByb3RvUHJvcHMpOyBpZiAoc3RhdGljUHJvcHMpIGRlZmluZVByb3BlcnRpZXMoQ29uc3RydWN0b3IsIHN0YXRpY1Byb3BzKTsgcmV0dXJuIENvbnN0cnVjdG9yOyB9OyB9KSgpOwoKZnVuY3Rpb24gX2ludGVyb3BSZXF1aXJlRGVmYXVsdChvYmopIHsgcmV0dXJuIG9iaiAmJiBvYmouX19lc01vZHVsZSA/IG9iaiA6IHsgJ2RlZmF1bHQnOiBvYmogfTsgfQoKZnVuY3Rpb24gX2NsYXNzQ2FsbENoZWNrKGluc3RhbmNlLCBDb25zdHJ1Y3RvcikgeyBpZiAoIShpbnN0YW5jZSBpbnN0YW5jZW9mIENvbnN0cnVjdG9yKSkgeyB0aHJvdyBuZXcgVHlwZUVycm9yKCdDYW5ub3QgY2FsbCBhIGNsYXNzIGFzIGEgZnVuY3Rpb24nKTsgfSB9Cgp2YXIgX1N5bmNPYmplY3QgPSByZXF1aXJlKCcuL1N5bmNPYmplY3QnKTsKCnZhciBfU3luY09iamVjdDIgPSBfaW50ZXJvcFJlcXVpcmVEZWZhdWx0KF9TeW5jT2JqZWN0KTsKCnZhciBGaWx0ZXJUeXBlID0geyBBTlk6ICdhbnknLCBTVEFSVDogJ3N0YXJ0JywgRVhBQ1Q6ICdleGFjdCcgfTsKCnZhciBEYXRhT2JqZWN0T2JzZXJ2ZXIgLyogaW1wbGVtZW50cyBTeW5jU3RhdHVzICovID0gKGZ1bmN0aW9uICgpIHsKICAvKiBwcml2YXRlCiAgX3ZlcnNpb246IG51bWJlcgogIF9vd25lcjogSHlwZXJ0eVVSTAogICBfdXJsOiBPYmplY3RVUkwKICBfc2NoZW1hOiBTY2hlbWEKICBfc3RhdHVzOiBvbiB8IHBhdXNlZAogICBfc3luY09iajogU3luY0RhdGEKICAgLS0tLWV2ZW50IGhhbmRsZXJzLS0tLQogIF9maWx0ZXJzOiB7PGZpbHRlcj46IHt0eXBlOiA8c3RhcnQsIGV4YWN0PiwgY2FsbGJhY2s6IDxmdW5jdGlvbj59IH0KICAqLwoKICBmdW5jdGlvbiBEYXRhT2JqZWN0T2JzZXJ2ZXIob3duZXJVUkwsIG9iamVjdFVSTCwgc2NoZW1hLCBpbml0aWFsU3RhdHVzLCBpbml0aWFsRGF0YSkgewogICAgX2NsYXNzQ2FsbENoZWNrKHRoaXMsIERhdGFPYmplY3RPYnNlcnZlcik7CgogICAgdmFyIF90aGlzID0gdGhpczsKCiAgICBfdGhpcy5fdmVyc2lvbiA9IDA7CiAgICBfdGhpcy5fb3duZXIgPSBvd25lclVSTDsKICAgIF90aGlzLl91cmwgPSBvYmplY3RVUkw7CiAgICBfdGhpcy5fc2NoZW1hID0gc2NoZW1hOwoKICAgIF90aGlzLl9zdGF0dXMgPSBpbml0aWFsU3RhdHVzOwogICAgX3RoaXMuX3N5bmNPYmogPSBuZXcgX1N5bmNPYmplY3QyWydkZWZhdWx0J10oaW5pdGlhbERhdGEpOwogICAgX3RoaXMuX3N5bmNPYmoub2JzZXJ2ZShmdW5jdGlvbiAoZXZlbnQpIHsKICAgICAgX3RoaXMuX29uRmlsdGVyKGV2ZW50KTsKICAgIH0pOwoKICAgIF90aGlzLl9maWx0ZXJzID0ge307CiAgfQoKICBfY3JlYXRlQ2xhc3MoRGF0YU9iamVjdE9ic2VydmVyLCBbewogICAga2V5OiAncGF1c2UnLAogICAgdmFsdWU6IGZ1bmN0aW9uIHBhdXNlKCkgewogICAgICAvL1RPRE86IHRoaXMgZmVhdHVyZSBuZWVkcyBtb3JlIGFuYWxpc2UKICAgICAgdGhyb3cgJ05vdCBpbXBsZW1lbnRlZCc7CiAgICB9CiAgfSwgewogICAga2V5OiAncmVzdW1lJywKICAgIHZhbHVlOiBmdW5jdGlvbiByZXN1bWUoKSB7CiAgICAgIC8vVE9ETzogdGhpcyBmZWF0dXJlIG5lZWRzIG1vcmUgYW5hbGlzZQogICAgICB0aHJvdyAnTm90IGltcGxlbWVudGVkJzsKICAgIH0KICB9LCB7CiAgICBrZXk6ICdzdG9wJywKICAgIHZhbHVlOiBmdW5jdGlvbiBzdG9wKCkgewogICAgICAvL1RPRE86IHNob3VsZCByZW1vdmUgdGhlIHN1YnNjcmlwdGlvbiBhbmQgc2VuZCBtZXNzYWdlIHVuc3Vic2NyaWJlPwogICAgICB0aHJvdyAnTm90IGltcGxlbWVudGVkJzsKICAgIH0KCiAgICAvL3JlZ2lzdGVyIGNoYW5nZSBmaWx0ZXIKICB9LCB7CiAgICBrZXk6ICdvbkNoYW5nZScsCiAgICB2YWx1ZTogZnVuY3Rpb24gb25DaGFuZ2UoZmlsdGVyLCBjYWxsYmFjaykgewogICAgICB2YXIga2V5ID0gZmlsdGVyOwogICAgICB2YXIgZmlsdGVyT2JqID0gewogICAgICAgIHR5cGU6IEZpbHRlclR5cGUuRVhBQ1QsCiAgICAgICAgY2FsbGJhY2s6IGNhbGxiYWNrCiAgICAgIH07CgogICAgICB2YXIgaWR4ID0gZmlsdGVyLmluZGV4T2YoJyonKTsKICAgICAgaWYgKGlkeCA9PT0gZmlsdGVyLmxlbmd0aCAtIDEpIHsKICAgICAgICBpZiAoaWR4ID09PSAwKSB7CiAgICAgICAgICBmaWx0ZXJPYmoudHlwZSA9IEZpbHRlclR5cGUuQU5ZOwogICAgICAgIH0gZWxzZSB7CiAgICAgICAgICBmaWx0ZXJPYmoudHlwZSA9IEZpbHRlclR5cGUuU1RBUlQ7CiAgICAgICAgICBrZXkgPSBmaWx0ZXIuc3Vic3RyKDAsIGZpbHRlci5sZW5ndGggLSAxKTsKICAgICAgICB9CiAgICAgIH0KCiAgICAgIHRoaXMuX2ZpbHRlcnNba2V5XSA9IGZpbHRlck9iajsKICAgIH0KCiAgICAvL2ZpbHRlciBjaGFuZ2VzCiAgfSwgewogICAga2V5OiAnX29uRmlsdGVyJywKICAgIHZhbHVlOiBmdW5jdGlvbiBfb25GaWx0ZXIoZXZlbnQpIHsKICAgICAgdmFyIF90aGlzID0gdGhpczsKCiAgICAgIE9iamVjdC5rZXlzKF90aGlzLl9maWx0ZXJzKS5mb3JFYWNoKGZ1bmN0aW9uIChrZXkpIHsKICAgICAgICB2YXIgZmlsdGVyID0gX3RoaXMuX2ZpbHRlcnNba2V5XTsKICAgICAgICBpZiAoZmlsdGVyLnR5cGUgPT09IEZpbHRlclR5cGUuQU5ZKSB7CiAgICAgICAgICAvL21hdGNoIGFueXRoaW5nCiAgICAgICAgICBmaWx0ZXIuY2FsbGJhY2soZXZlbnQpOwogICAgICAgIH0gZWxzZSBpZiAoZmlsdGVyLnR5cGUgPT09IEZpbHRlclR5cGUuU1RBUlQpIHsKICAgICAgICAgIC8vaWYgc3RhcnRzIHdpdGggZmlsdGVyLi4uCiAgICAgICAgICBpZiAoZXZlbnQuZmllbGQuaW5kZXhPZihrZXkpID09PSAwKSB7CiAgICAgICAgICAgIGZpbHRlci5jYWxsYmFjayhldmVudCk7CiAgICAgICAgICB9CiAgICAgICAgfSBlbHNlIGlmIChmaWx0ZXIudHlwZSA9PT0gRmlsdGVyVHlwZS5FWEFDVCkgewogICAgICAgICAgLy9leGFjdCBtYXRjaAogICAgICAgICAgaWYgKGV2ZW50LmZpZWxkID09PSBrZXkpIHsKICAgICAgICAgICAgZmlsdGVyLmNhbGxiYWNrKGV2ZW50KTsKICAgICAgICAgIH0KICAgICAgICB9CiAgICAgIH0pOwogICAgfQoKICAgIC8vcmVjZWl2ZSBhbmQgcHJvY2VzcyBjaGFuZ2UgbWVzc2FnZXMKICB9LCB7CiAgICBrZXk6ICdfY2hhbmdlT2JqZWN0JywKICAgIHZhbHVlOiBmdW5jdGlvbiBfY2hhbmdlT2JqZWN0KG1zZykgewogICAgICB2YXIgX3RoaXMgPSB0aGlzOwoKICAgICAgLy9UT0RPOiB1cGRhdGUgdmVyc2lvbiA/CiAgICAgIC8vaG93IHRvIGhhbmRsZSBhbiBpbmNvcnJlY3QgdmVyc2lvbiA/IEV4YW1wbGU6IHJlY2VpdmUgYSB2ZXJzaW9uIDMgd2hlbiB0aGUgb2JzZXJ2ZXIgaXMgaW4gdmVyc2lvbiAxLCB3aGVyZSBpcyB0aGUgdmVyc2lvbiAyID8KICAgICAgLy93aWxsIHdlIG5lZWQgdG8gY29uZmlybSB0aGUgcmVjZXB0aW9uID8KICAgICAgaWYgKF90aGlzLl92ZXJzaW9uICsgMSA9PT0gbXNnLmJvZHkudmVyc2lvbikgewogICAgICAgIF90aGlzLl92ZXJzaW9uKys7CiAgICAgICAgdmFyIHBhdGggPSBtc2cuYm9keS5hdHRyaWI7CiAgICAgICAgdmFyIHZhbHVlID0gbXNnLmJvZHkudmFsdWU7CiAgICAgICAgdmFyIGZpbmRSZXN1bHQgPSBfdGhpcy5fc3luY09iai5maW5kQmVmb3JlKHBhdGgpOwoKICAgICAgICBpZiAobXNnLnR5cGUgPT09IF9TeW5jT2JqZWN0LkNoYW5nZVR5cGUuVVBEQVRFKSB7CiAgICAgICAgICBmaW5kUmVzdWx0Lm9ialtmaW5kUmVzdWx0Lmxhc3RdID0gdmFsdWU7CiAgICAgICAgfSBlbHNlIHsKICAgICAgICAgIGlmIChtc2cudHlwZSA9PT0gX1N5bmNPYmplY3QuQ2hhbmdlVHlwZS5BREQpIHsKICAgICAgICAgICAgaWYgKG1zZy5ib2R5Lm9UeXBlID09PSBfU3luY09iamVjdC5PYmplY3RUeXBlLk9CSkVDVCkgewogICAgICAgICAgICAgIGZpbmRSZXN1bHQub2JqW2ZpbmRSZXN1bHQubGFzdF0gPSB2YWx1ZTsKICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAvL0FSUkFZCiAgICAgICAgICAgICAgdmFyIGFyciA9IGZpbmRSZXN1bHQub2JqOwogICAgICAgICAgICAgIHZhciBpbmRleCA9IGZpbmRSZXN1bHQubGFzdDsKICAgICAgICAgICAgICBBcnJheS5wcm90b3R5cGUuc3BsaWNlLmFwcGx5KGFyciwgW2luZGV4LCAwXS5jb25jYXQodmFsdWUpKTsKICAgICAgICAgICAgfQogICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgLy9SRU1PVkUKICAgICAgICAgICAgaWYgKG1zZy5ib2R5Lm9UeXBlID09PSBfU3luY09iamVjdC5PYmplY3RUeXBlLk9CSkVDVCkgewogICAgICAgICAgICAgIGRlbGV0ZSBmaW5kUmVzdWx0Lm9ialtmaW5kUmVzdWx0Lmxhc3RdOwogICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgIC8vQVJSQVkKICAgICAgICAgICAgICB2YXIgYXJyID0gZmluZFJlc3VsdC5vYmo7CiAgICAgICAgICAgICAgdmFyIGluZGV4ID0gZmluZFJlc3VsdC5sYXN0OwogICAgICAgICAgICAgIGFyci5zcGxpY2UoaW5kZXgsIHZhbHVlKTsKICAgICAgICAgICAgfQogICAgICAgICAgfQogICAgICAgIH0KICAgICAgfSBlbHNlIHsKICAgICAgICAvL1RPRE86IGhvdyB0byBoYW5kbGUgdW5zeW5jaHJvbml6ZWQgdmVyc2lvbnM/CiAgICAgICAgY29uc29sZS5sb2coJ3Vuc3luY2hyb25pemVkIHZlcnNpb25zJyk7CiAgICAgIH0KICAgIH0KICB9LCB7CiAgICBrZXk6ICd2ZXJzaW9uJywKICAgIGdldDogZnVuY3Rpb24gZ2V0KCkgewogICAgICByZXR1cm4gdGhpcy5fdmVyc2lvbjsKICAgIH0KICB9LCB7CiAgICBrZXk6ICdvd25lcicsCiAgICBnZXQ6IGZ1bmN0aW9uIGdldCgpIHsKICAgICAgcmV0dXJuIHRoaXMuX293bmVyOwogICAgfQogIH0sIHsKICAgIGtleTogJ3VybCcsCiAgICBnZXQ6IGZ1bmN0aW9uIGdldCgpIHsKICAgICAgcmV0dXJuIHRoaXMuX3VybDsKICAgIH0KICB9LCB7CiAgICBrZXk6ICdzY2hlbWEnLAogICAgZ2V0OiBmdW5jdGlvbiBnZXQoKSB7CiAgICAgIHJldHVybiB0aGlzLl9zY2hlbWE7CiAgICB9CiAgfSwgewogICAga2V5OiAnc3RhdHVzJywKICAgIGdldDogZnVuY3Rpb24gZ2V0KCkgewogICAgICByZXR1cm4gdGhpcy5fc3RhdHVzOwogICAgfQogIH0sIHsKICAgIGtleTogJ2RhdGEnLAogICAgZ2V0OiBmdW5jdGlvbiBnZXQoKSB7CiAgICAgIHJldHVybiB0aGlzLl9zeW5jT2JqLmRhdGE7CiAgICB9CiAgfV0pOwoKICByZXR1cm4gRGF0YU9iamVjdE9ic2VydmVyOwp9KSgpOwoKZXhwb3J0c1snZGVmYXVsdCddID0gRGF0YU9iamVjdE9ic2VydmVyOwptb2R1bGUuZXhwb3J0cyA9IGV4cG9ydHNbJ2RlZmF1bHQnXTsKCn0seyIuL1N5bmNPYmplY3QiOjIxfV0sMjA6W2Z1bmN0aW9uKHJlcXVpcmUsbW9kdWxlLGV4cG9ydHMpewondXNlIHN0cmljdCc7CgpPYmplY3QuZGVmaW5lUHJvcGVydHkoZXhwb3J0cywgJ19fZXNNb2R1bGUnLCB7CiAgdmFsdWU6IHRydWUKfSk7Cgp2YXIgX2NyZWF0ZUNsYXNzID0gKGZ1bmN0aW9uICgpIHsgZnVuY3Rpb24gZGVmaW5lUHJvcGVydGllcyh0YXJnZXQsIHByb3BzKSB7IGZvciAodmFyIGkgPSAwOyBpIDwgcHJvcHMubGVuZ3RoOyBpKyspIHsgdmFyIGRlc2NyaXB0b3IgPSBwcm9wc1tpXTsgZGVzY3JpcHRvci5lbnVtZXJhYmxlID0gZGVzY3JpcHRvci5lbnVtZXJhYmxlIHx8IGZhbHNlOyBkZXNjcmlwdG9yLmNvbmZpZ3VyYWJsZSA9IHRydWU7IGlmICgndmFsdWUnIGluIGRlc2NyaXB0b3IpIGRlc2NyaXB0b3Iud3JpdGFibGUgPSB0cnVlOyBPYmplY3QuZGVmaW5lUHJvcGVydHkodGFyZ2V0LCBkZXNjcmlwdG9yLmtleSwgZGVzY3JpcHRvcik7IH0gfSByZXR1cm4gZnVuY3Rpb24gKENvbnN0cnVjdG9yLCBwcm90b1Byb3BzLCBzdGF0aWNQcm9wcykgeyBpZiAocHJvdG9Qcm9wcykgZGVmaW5lUHJvcGVydGllcyhDb25zdHJ1Y3Rvci5wcm90b3R5cGUsIHByb3RvUHJvcHMpOyBpZiAoc3RhdGljUHJvcHMpIGRlZmluZVByb3BlcnRpZXMoQ29uc3RydWN0b3IsIHN0YXRpY1Byb3BzKTsgcmV0dXJuIENvbnN0cnVjdG9yOyB9OyB9KSgpOwoKZnVuY3Rpb24gX2ludGVyb3BSZXF1aXJlRGVmYXVsdChvYmopIHsgcmV0dXJuIG9iaiAmJiBvYmouX19lc01vZHVsZSA/IG9iaiA6IHsgJ2RlZmF1bHQnOiBvYmogfTsgfQoKZnVuY3Rpb24gX2NsYXNzQ2FsbENoZWNrKGluc3RhbmNlLCBDb25zdHJ1Y3RvcikgeyBpZiAoIShpbnN0YW5jZSBpbnN0YW5jZW9mIENvbnN0cnVjdG9yKSkgeyB0aHJvdyBuZXcgVHlwZUVycm9yKCdDYW5ub3QgY2FsbCBhIGNsYXNzIGFzIGEgZnVuY3Rpb24nKTsgfSB9Cgp2YXIgX1N5bmNPYmplY3QgPSByZXF1aXJlKCcuL1N5bmNPYmplY3QnKTsKCnZhciBfU3luY09iamVjdDIgPSBfaW50ZXJvcFJlcXVpcmVEZWZhdWx0KF9TeW5jT2JqZWN0KTsKCnZhciBfdXRpbHNVdGlsc0pzID0gcmVxdWlyZSgnLi4vdXRpbHMvdXRpbHMuanMnKTsKCnZhciBEYXRhT2JqZWN0UmVwb3J0ZXIgLyogaW1wbGVtZW50cyBTeW5jU3RhdHVzICovID0gKGZ1bmN0aW9uICgpIHsKICAvKiBwcml2YXRlCiAgX3ZlcnNpb246IG51bWJlcgogICBfdXJsOiBPYmplY3RVUkwKICBfc2NoZW1hOiBTY2hlbWEKICBfYnVzOiBNaW5pQnVzCiAgX3N0YXR1czogb24gfCBwYXVzZWQKICAgX3N5bmNPYmo6IFN5bmNEYXRhCiAgX3N1YnNjcmlwdGlvbnM6IDxoeXBlcnR5VXJsOiB7IHN0YXR1czogc3RyaW5nIH0gfT4KICAgLS0tLWV2ZW50IGhhbmRsZXJzLS0tLQogIF9vblN1YnNjcmlwdGlvbkhhbmRsZXI6IChldmVudCkgPT4gdm9pZAogICovCgogIGZ1bmN0aW9uIERhdGFPYmplY3RSZXBvcnRlcihvd25lciwgdXJsLCBzY2hlbWEsIGJ1cywgaW5pdGlhbFN0YXR1cywgaW5pdGlhbERhdGEpIHsKICAgIF9jbGFzc0NhbGxDaGVjayh0aGlzLCBEYXRhT2JqZWN0UmVwb3J0ZXIpOwoKICAgIHZhciBfdGhpcyA9IHRoaXM7CgogICAgX3RoaXMuX3ZlcnNpb24gPSAwOwogICAgX3RoaXMuX293bmVyID0gb3duZXI7CiAgICBfdGhpcy5fdXJsID0gdXJsOwogICAgX3RoaXMuX3NjaGVtYSA9IHNjaGVtYTsKICAgIF90aGlzLl9idXMgPSBidXM7CgogICAgX3RoaXMuX3N1YnNjcmlwdGlvbnMgPSB7fTsKCiAgICBfdGhpcy5fc3RhdHVzID0gaW5pdGlhbFN0YXR1czsKICAgIF90aGlzLl9zeW5jT2JqID0gbmV3IF9TeW5jT2JqZWN0MlsnZGVmYXVsdCddKGluaXRpYWxEYXRhKTsKICAgIF90aGlzLl9zeW5jT2JqLm9ic2VydmUoZnVuY3Rpb24gKGV2ZW50KSB7CiAgICAgIF90aGlzLl9vbkNoYW5nZShldmVudCk7CiAgICB9KTsKICB9CgogIF9jcmVhdGVDbGFzcyhEYXRhT2JqZWN0UmVwb3J0ZXIsIFt7CiAgICBrZXk6ICdwYXVzZScsCiAgICB2YWx1ZTogZnVuY3Rpb24gcGF1c2UoKSB7CiAgICAgIC8vVE9ETzogcGF1c2UgY2hhbmdlIHJlcG9ydHM/CiAgICB9CiAgfSwgewogICAga2V5OiAncmVzdW1lJywKICAgIHZhbHVlOiBmdW5jdGlvbiByZXN1bWUoKSB7CiAgICAgIC8vVE9ETzogcmVzdW1lIGNoYW5nZSByZXBvcnRzPwogICAgfQogIH0sIHsKICAgIGtleTogJ3N0b3AnLAogICAgdmFsdWU6IGZ1bmN0aW9uIHN0b3AoKSB7CiAgICAgIC8vVE9ETzogZGVzdHJveSByZXBvcnRlcj8KICAgIH0KICB9LCB7CiAgICBrZXk6ICdvblN1YnNjcmlwdGlvbicsCiAgICB2YWx1ZTogZnVuY3Rpb24gb25TdWJzY3JpcHRpb24oY2FsbGJhY2spIHsKICAgICAgdGhpcy5fb25TdWJzY3JpcHRpb25IYW5kbGVyID0gY2FsbGJhY2s7CiAgICB9CiAgfSwgewogICAga2V5OiAnX29uRm9yd2FyZCcsCiAgICB2YWx1ZTogZnVuY3Rpb24gX29uRm9yd2FyZChtc2cpIHsKICAgICAgdmFyIF90aGlzID0gdGhpczsKCiAgICAgIGNvbnNvbGUubG9nKCdEYXRhT2JqZWN0UmVwb3J0ZXItUkNWOiAnLCBtc2cpOwogICAgICBzd2l0Y2ggKG1zZy5ib2R5LnR5cGUpIHsKICAgICAgICBjYXNlICdzdWJzY3JpYmUnOgogICAgICAgICAgX3RoaXMuX29uU3Vic2NyaWJlKG1zZyk7YnJlYWs7CiAgICAgICAgY2FzZSAndW5zdWJzY3JpYmUnOgogICAgICAgICAgX3RoaXMuX29uVW5TdWJzY3JpYmUobXNnKTticmVhazsKICAgICAgfQogICAgfQogIH0sIHsKICAgIGtleTogJ19vblN1YnNjcmliZScsCiAgICB2YWx1ZTogZnVuY3Rpb24gX29uU3Vic2NyaWJlKG1zZykgewogICAgICB2YXIgX3RoaXMgPSB0aGlzOwogICAgICB2YXIgaHlwZXJ0eVVybCA9IG1zZy5ib2R5LmZyb207CgogICAgICB2YXIgZXZlbnQgPSB7CiAgICAgICAgdHlwZTogbXNnLmJvZHkudHlwZSwKICAgICAgICB1cmw6IGh5cGVydHlVcmwsCgogICAgICAgIGFjY2VwdDogZnVuY3Rpb24gYWNjZXB0KCkgewogICAgICAgICAgLy9jcmVhdGUgbmV3IHN1YnNjcmlwdGlvbgogICAgICAgICAgX3RoaXMuX3N1YnNjcmlwdGlvbnNbaHlwZXJ0eVVybF0gPSB7IHN0YXR1czogJ29uJyB9OwoKICAgICAgICAgIC8vc2VuZCBvayByZXNwb25zZSBtZXNzYWdlCiAgICAgICAgICBfdGhpcy5fYnVzLnBvc3RNZXNzYWdlKHsKICAgICAgICAgICAgaWQ6IG1zZy5pZCwgdHlwZTogJ3Jlc3BvbnNlJywgZnJvbTogbXNnLnRvLCB0bzogbXNnLmZyb20sCiAgICAgICAgICAgIGJvZHk6IHsgY29kZTogMjAwLCBzY2hlbWE6IF90aGlzLl9zY2hlbWEsIHZlcnNpb246IF90aGlzLl92ZXJzaW9uLCB2YWx1ZTogKDAsIF91dGlsc1V0aWxzSnMuZGVlcENsb25lKShfdGhpcy5kYXRhKSB9CiAgICAgICAgICB9KTsKICAgICAgICB9LAoKICAgICAgICByZWplY3Q6IGZ1bmN0aW9uIHJlamVjdChyZWFzb24pIHsKICAgICAgICAgIC8vc2VuZCByZWplY3QgcmVzcG9uc2UgbWVzc2FnZQogICAgICAgICAgX3RoaXMuX2J1cy5wb3N0TWVzc2FnZSh7CiAgICAgICAgICAgIGlkOiBtc2cuaWQsIHR5cGU6ICdyZXNwb25zZScsIGZyb206IG1zZy50bywgdG86IG1zZy5mcm9tLAogICAgICAgICAgICBib2R5OiB7IGNvZGU6IDQwMywgZGVzYzogcmVhc29uIH0KICAgICAgICAgIH0pOwogICAgICAgIH0KICAgICAgfTsKCiAgICAgIGlmIChfdGhpcy5fb25TdWJzY3JpcHRpb25IYW5kbGVyKSB7CiAgICAgICAgX3RoaXMuX29uU3Vic2NyaXB0aW9uSGFuZGxlcihldmVudCk7CiAgICAgIH0KICAgIH0KICB9LCB7CiAgICBrZXk6ICdfb25VblN1YnNjcmliZScsCiAgICB2YWx1ZTogZnVuY3Rpb24gX29uVW5TdWJzY3JpYmUobXNnKSB7CiAgICAgIHZhciBfdGhpcyA9IHRoaXM7CiAgICAgIHZhciBoeXBlcnR5VXJsID0gbXNnLmJvZHkuZnJvbTsKCiAgICAgIHZhciBzdWIgPSBfdGhpcy5fc3Vic2NyaXB0aW9uc1toeXBlcnR5VXJsXTsKICAgICAgZGVsZXRlIF90aGlzLl9zdWJzY3JpcHRpb25zW2h5cGVydHlVcmxdOwoKICAgICAgdmFyIGV2ZW50ID0gewogICAgICAgIHR5cGU6IG1zZy5ib2R5LnR5cGUsCiAgICAgICAgdXJsOiBoeXBlcnR5VXJsLAogICAgICAgIG9iamVjdDogc3ViCiAgICAgIH07CgogICAgICBpZiAoX3RoaXMuX29uU3Vic2NyaXB0aW9uSGFuZGxlcikgewogICAgICAgIF90aGlzLl9vblN1YnNjcmlwdGlvbkhhbmRsZXIoZXZlbnQpOwogICAgICB9CiAgICB9CgogICAgLy9zZW5kIGRlbHRhIG1lc3NhZ2VzIHRvIHN1YnNjcmlwdGlvbnMKICB9LCB7CiAgICBrZXk6ICdfb25DaGFuZ2UnLAogICAgdmFsdWU6IGZ1bmN0aW9uIF9vbkNoYW5nZShldmVudCkgewogICAgICB2YXIgX3RoaXMgPSB0aGlzOwoKICAgICAgX3RoaXMuX3ZlcnNpb24rKzsKCiAgICAgIGlmIChfdGhpcy5fc3RhdHVzID09PSAnb24nKSB7CiAgICAgICAgX3RoaXMuX2J1cy5wb3N0TWVzc2FnZSh7CiAgICAgICAgICB0eXBlOiBldmVudC5jVHlwZSwgZnJvbTogX3RoaXMuX293bmVyLCB0bzogX3RoaXMuX3VybCwKICAgICAgICAgIGJvZHk6IHsgdmVyc2lvbjogX3RoaXMuX3ZlcnNpb24sIG9UeXBlOiBldmVudC5vVHlwZSwgYXR0cmliOiBldmVudC5maWVsZCwgdmFsdWU6IGV2ZW50LmRhdGEgfQogICAgICAgIH0pOwogICAgICB9CiAgICB9CiAgfSwgewogICAga2V5OiAndmVyc2lvbicsCiAgICBnZXQ6IGZ1bmN0aW9uIGdldCgpIHsKICAgICAgcmV0dXJuIHRoaXMuX3ZlcnNpb247CiAgICB9CiAgfSwgewogICAga2V5OiAndXJsJywKICAgIGdldDogZnVuY3Rpb24gZ2V0KCkgewogICAgICByZXR1cm4gdGhpcy5fdXJsOwogICAgfQogIH0sIHsKICAgIGtleTogJ3NjaGVtYScsCiAgICBnZXQ6IGZ1bmN0aW9uIGdldCgpIHsKICAgICAgcmV0dXJuIHRoaXMuX3NjaGVtYTsKICAgIH0KICB9LCB7CiAgICBrZXk6ICdzdGF0dXMnLAogICAgZ2V0OiBmdW5jdGlvbiBnZXQoKSB7CiAgICAgIHJldHVybiB0aGlzLl9zdGF0dXM7CiAgICB9CiAgfSwgewogICAga2V5OiAnZGF0YScsCiAgICBnZXQ6IGZ1bmN0aW9uIGdldCgpIHsKICAgICAgcmV0dXJuIHRoaXMuX3N5bmNPYmouZGF0YTsKICAgIH0KICB9LCB7CiAgICBrZXk6ICdzdWJzY3JpcHRpb25zJywKICAgIGdldDogZnVuY3Rpb24gZ2V0KCkgewogICAgICByZXR1cm4gdGhpcy5fc3Vic2NyaXB0aW9uczsKICAgIH0KICB9XSk7CgogIHJldHVybiBEYXRhT2JqZWN0UmVwb3J0ZXI7Cn0pKCk7CgpleHBvcnRzWydkZWZhdWx0J10gPSBEYXRhT2JqZWN0UmVwb3J0ZXI7Cm1vZHVsZS5leHBvcnRzID0gZXhwb3J0c1snZGVmYXVsdCddOwoKfSx7Ii4uL3V0aWxzL3V0aWxzLmpzIjoyNCwiLi9TeW5jT2JqZWN0IjoyMX1dLDIxOltmdW5jdGlvbihyZXF1aXJlLG1vZHVsZSxleHBvcnRzKXsKJ3VzZSBzdHJpY3QnOwoKT2JqZWN0LmRlZmluZVByb3BlcnR5KGV4cG9ydHMsICdfX2VzTW9kdWxlJywgewogIHZhbHVlOiB0cnVlCn0pOwoKdmFyIF9jcmVhdGVDbGFzcyA9IChmdW5jdGlvbiAoKSB7IGZ1bmN0aW9uIGRlZmluZVByb3BlcnRpZXModGFyZ2V0LCBwcm9wcykgeyBmb3IgKHZhciBpID0gMDsgaSA8IHByb3BzLmxlbmd0aDsgaSsrKSB7IHZhciBkZXNjcmlwdG9yID0gcHJvcHNbaV07IGRlc2NyaXB0b3IuZW51bWVyYWJsZSA9IGRlc2NyaXB0b3IuZW51bWVyYWJsZSB8fCBmYWxzZTsgZGVzY3JpcHRvci5jb25maWd1cmFibGUgPSB0cnVlOyBpZiAoJ3ZhbHVlJyBpbiBkZXNjcmlwdG9yKSBkZXNjcmlwdG9yLndyaXRhYmxlID0gdHJ1ZTsgT2JqZWN0LmRlZmluZVByb3BlcnR5KHRhcmdldCwgZGVzY3JpcHRvci5rZXksIGRlc2NyaXB0b3IpOyB9IH0gcmV0dXJuIGZ1bmN0aW9uIChDb25zdHJ1Y3RvciwgcHJvdG9Qcm9wcywgc3RhdGljUHJvcHMpIHsgaWYgKHByb3RvUHJvcHMpIGRlZmluZVByb3BlcnRpZXMoQ29uc3RydWN0b3IucHJvdG90eXBlLCBwcm90b1Byb3BzKTsgaWYgKHN0YXRpY1Byb3BzKSBkZWZpbmVQcm9wZXJ0aWVzKENvbnN0cnVjdG9yLCBzdGF0aWNQcm9wcyk7IHJldHVybiBDb25zdHJ1Y3RvcjsgfTsgfSkoKTsKCmZ1bmN0aW9uIF9jbGFzc0NhbGxDaGVjayhpbnN0YW5jZSwgQ29uc3RydWN0b3IpIHsgaWYgKCEoaW5zdGFuY2UgaW5zdGFuY2VvZiBDb25zdHJ1Y3RvcikpIHsgdGhyb3cgbmV3IFR5cGVFcnJvcignQ2Fubm90IGNhbGwgYSBjbGFzcyBhcyBhIGZ1bmN0aW9uJyk7IH0gfQoKdmFyIF91dGlsc1V0aWxzSnMgPSByZXF1aXJlKCcuLi91dGlscy91dGlscy5qcycpOwoKdmFyIFN5bmNPYmplY3QgPSAoZnVuY3Rpb24gKCkgewogIC8qIHByaXZhdGUKICAgIF9kYXRhOiBhbnk7CiAgICBfb2JzZXJ2ZXJzOiAoKGV2ZW50OiBDaGFuZ2VFdmVudCkgPT4gdm9pZClbXQogICovCgogIGZ1bmN0aW9uIFN5bmNPYmplY3QoaW5pdGlhbERhdGEpIHsKICAgIF9jbGFzc0NhbGxDaGVjayh0aGlzLCBTeW5jT2JqZWN0KTsKCiAgICB2YXIgX3RoaXMgPSB0aGlzOwoKICAgIF90aGlzLl9vYnNlcnZlcnMgPSBbXTsKICAgIF90aGlzLl9maWx0ZXJzID0ge307CgogICAgaWYgKGluaXRpYWxEYXRhKSB7CiAgICAgIF90aGlzLl9kYXRhID0gaW5pdGlhbERhdGE7CiAgICB9IGVsc2UgewogICAgICBfdGhpcy5fZGF0YSA9IHt9OwogICAgfQoKICAgIF90aGlzLl9pbnRlcm5hbE9ic2VydmUobmV3IFBhdGgoKSwgX3RoaXMuX2RhdGEpOwogIH0KCiAgLy9keW5hbWljIHBhdGggZm9yIEFycmF5IGluZGV4Li4uCgogIF9jcmVhdGVDbGFzcyhTeW5jT2JqZWN0LCBbewogICAga2V5OiAnb2JzZXJ2ZScsCiAgICB2YWx1ZTogZnVuY3Rpb24gb2JzZXJ2ZShjYWxsYmFjaykgewogICAgICB0aGlzLl9vYnNlcnZlcnMucHVzaChjYWxsYmFjayk7CiAgICB9CiAgfSwgewogICAga2V5OiAnZmluZCcsCiAgICB2YWx1ZTogZnVuY3Rpb24gZmluZChwYXRoKSB7CiAgICAgIHZhciBsaXN0ID0gcGF0aC5zcGxpdCgnLicpOwoKICAgICAgcmV0dXJuIHRoaXMuX2ZpbmRXaXRoU3BsaXQobGlzdCk7CiAgICB9CiAgfSwgewogICAga2V5OiAnZmluZEJlZm9yZScsCiAgICB2YWx1ZTogZnVuY3Rpb24gZmluZEJlZm9yZShwYXRoKSB7CiAgICAgIHZhciByZXN1bHQgPSB7fTsKICAgICAgdmFyIGxpc3QgPSBwYXRoLnNwbGl0KCcuJyk7CiAgICAgIHJlc3VsdC5sYXN0ID0gbGlzdC5wb3AoKTsKICAgICAgcmVzdWx0Lm9iaiA9IHRoaXMuX2ZpbmRXaXRoU3BsaXQobGlzdCk7CgogICAgICByZXR1cm4gcmVzdWx0OwogICAgfQogIH0sIHsKICAgIGtleTogJ19maW5kV2l0aFNwbGl0JywKICAgIHZhbHVlOiBmdW5jdGlvbiBfZmluZFdpdGhTcGxpdChsaXN0KSB7CiAgICAgIHZhciBvYmogPSB0aGlzLl9kYXRhOwogICAgICBsaXN0LmZvckVhY2goZnVuY3Rpb24gKHZhbHVlKSB7CiAgICAgICAgb2JqID0gb2JqW3ZhbHVlXTsKICAgICAgfSk7CgogICAgICByZXR1cm4gb2JqOwogICAgfQogIH0sIHsKICAgIGtleTogJ19maXJlRXZlbnQnLAogICAgdmFsdWU6IGZ1bmN0aW9uIF9maXJlRXZlbnQoZXZlbnQpIHsKICAgICAgdGhpcy5fb2JzZXJ2ZXJzLmZvckVhY2goZnVuY3Rpb24gKGNhbGxiYWNrKSB7CiAgICAgICAgY2FsbGJhY2soZXZlbnQpOwogICAgICB9KTsKICAgIH0KICB9LCB7CiAgICBrZXk6ICdfaXNPYnNlcnZhYmxlJywKICAgIHZhbHVlOiBmdW5jdGlvbiBfaXNPYnNlcnZhYmxlKG9iaikgewogICAgICBpZiAob2JqLmNvbnN0cnVjdG9yID09PSBPYmplY3QgfHwgb2JqLmNvbnN0cnVjdG9yID09PSBBcnJheSkgewogICAgICAgIHJldHVybiB0cnVlOwogICAgICB9CgogICAgICByZXR1cm4gZmFsc2U7CiAgICB9CiAgfSwgewogICAga2V5OiAnX2ludGVybmFsT2JzZXJ2ZScsCiAgICB2YWx1ZTogZnVuY3Rpb24gX2ludGVybmFsT2JzZXJ2ZShwYXRoLCBvYmopIHsKICAgICAgdmFyIF90aGlzID0gdGhpczsKCiAgICAgIGlmIChfdGhpcy5faXNPYnNlcnZhYmxlKG9iaikpIHsKICAgICAgICB2YXIgaGFuZGxlciA9IGZ1bmN0aW9uIGhhbmRsZXIoY2hhbmdlcykgewogICAgICAgICAgX3RoaXMuX29uQ2hhbmdlcyhwYXRoLCBjaGFuZ2VzKTsKICAgICAgICB9OwoKICAgICAgICBpZiAob2JqLmNvbnN0cnVjdG9yID09PSBPYmplY3QpIHsKICAgICAgICAgIE9iamVjdC5vYnNlcnZlKG9iaiwgaGFuZGxlcik7CiAgICAgICAgICBmb3IgKHZhciBwcm9wIGluIG9iaikgewogICAgICAgICAgICBpZiAoX3RoaXMuX2lzT2JzZXJ2YWJsZShvYmpbcHJvcF0pKSB7CiAgICAgICAgICAgICAgX3RoaXMuX2ludGVybmFsT2JzZXJ2ZShwYXRoWyduZXcnXShwcm9wKSwgb2JqW3Byb3BdKTsKICAgICAgICAgICAgfQogICAgICAgICAgfQogICAgICAgIH0gZWxzZSBpZiAob2JqLmNvbnN0cnVjdG9yID09PSBBcnJheSkgewogICAgICAgICAgQXJyYXkub2JzZXJ2ZShvYmosIGhhbmRsZXIpOwogICAgICAgICAgZm9yICh2YXIgcHJvcCBpbiBvYmopIHsKICAgICAgICAgICAgaWYgKF90aGlzLl9pc09ic2VydmFibGUob2JqW3Byb3BdKSkgewogICAgICAgICAgICAgIHZhciBucCA9IHBhdGhbJ25ldyddKG5ldyBBcnJheUluZGV4KG9ialtwcm9wXSwgcHJvcCkpOwogICAgICAgICAgICAgIF90aGlzLl9pbnRlcm5hbE9ic2VydmUobnAsIG9ialtwcm9wXSk7CiAgICAgICAgICAgIH0KICAgICAgICAgIH0KICAgICAgICB9CiAgICAgIH0KICAgIH0KICB9LCB7CiAgICBrZXk6ICdfb25DaGFuZ2VzJywKICAgIHZhbHVlOiBmdW5jdGlvbiBfb25DaGFuZ2VzKHBhdGgsIGNoYW5nZXMpIHsKICAgICAgdmFyIF90aGlzMiA9IHRoaXM7CgogICAgICBmb3IgKHZhciBpIGluIGNoYW5nZXMpIHsKICAgICAgICB2YXIgb2JqID0gY2hhbmdlc1tpXS5vYmplY3Q7CiAgICAgICAgdmFyIG9ialR5cGUgPSB1bmRlZmluZWQ7CgogICAgICAgIGlmIChvYmouY29uc3RydWN0b3IgPT0gT2JqZWN0KSB7CiAgICAgICAgICBvYmpUeXBlID0gT2JqZWN0VHlwZS5PQkpFQ1Q7CiAgICAgICAgfQoKICAgICAgICBpZiAob2JqLmNvbnN0cnVjdG9yID09IEFycmF5KSB7CiAgICAgICAgICBvYmpUeXBlID0gT2JqZWN0VHlwZS5BUlJBWTsKICAgICAgICB9CgogICAgICAgIGlmIChjaGFuZ2VzW2ldLnR5cGUgPT09ICdzcGxpY2UnKSB7CiAgICAgICAgICAoZnVuY3Rpb24gKCkgewogICAgICAgICAgICB2YXIgaWR4ID0gY2hhbmdlc1tpXS5pbmRleDsKICAgICAgICAgICAgdmFyIGZpZWxkID0gcGF0aFsnbmV3J10oJycgKyBpZHgpOwogICAgICAgICAgICB2YXIgZmllbGRTdHJpbmcgPSBmaWVsZC50b1N0cmluZygpOwoKICAgICAgICAgICAgdmFyIHJlbW92ZVNpemUgPSBjaGFuZ2VzW2ldLnJlbW92ZWQubGVuZ3RoOwogICAgICAgICAgICBpZiAocmVtb3ZlU2l6ZSAhPT0gMCkgewogICAgICAgICAgICAgIHZhciByZW1vdmVWYWx1ZXMgPSBjaGFuZ2VzW2ldLnJlbW92ZWQ7CiAgICAgICAgICAgICAgcmVtb3ZlVmFsdWVzLmZvckVhY2goZnVuY3Rpb24gKHZhbHVlLCBpbmRleCkgewogICAgICAgICAgICAgICAgaWYgKF90aGlzMi5faXNPYnNlcnZhYmxlKHZhbHVlKSkgewogICAgICAgICAgICAgICAgICBwYXRoLnJlbW92ZUluZGV4KGlkeCArIGluZGV4KTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICB9KTsKCiAgICAgICAgICAgICAgX3RoaXMyLl9maXJlRXZlbnQoewogICAgICAgICAgICAgICAgY1R5cGU6IENoYW5nZVR5cGUuUkVNT1ZFLAogICAgICAgICAgICAgICAgb1R5cGU6IG9ialR5cGUsCiAgICAgICAgICAgICAgICBmaWVsZDogZmllbGRTdHJpbmcsCiAgICAgICAgICAgICAgICBkYXRhOiByZW1vdmVTaXplCiAgICAgICAgICAgICAgfSk7CiAgICAgICAgICAgIH0KCiAgICAgICAgICAgIHZhciBhZGRTaXplID0gY2hhbmdlc1tpXS5hZGRlZENvdW50OwogICAgICAgICAgICBpZiAoYWRkU2l6ZSAhPT0gMCkgewogICAgICAgICAgICAgIHZhciBhZGRWYWx1ZXMgPSBvYmouc2xpY2UoaWR4LCBpZHggKyBhZGRTaXplKTsKICAgICAgICAgICAgICBhZGRWYWx1ZXMuZm9yRWFjaChmdW5jdGlvbiAodmFsdWUsIGluZGV4KSB7CiAgICAgICAgICAgICAgICBpZiAoX3RoaXMyLl9pc09ic2VydmFibGUodmFsdWUpKSB7CiAgICAgICAgICAgICAgICAgIHZhciBucCA9IHBhdGhbJ25ldyddKG5ldyBBcnJheUluZGV4KHZhbHVlLCBpZHggKyBpbmRleCkpOwogICAgICAgICAgICAgICAgICBfdGhpczIuX2ludGVybmFsT2JzZXJ2ZShucCwgdmFsdWUpOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIH0pOwoKICAgICAgICAgICAgICBfdGhpczIuX2ZpcmVFdmVudCh7CiAgICAgICAgICAgICAgICBjVHlwZTogQ2hhbmdlVHlwZS5BREQsCiAgICAgICAgICAgICAgICBvVHlwZTogb2JqVHlwZSwKICAgICAgICAgICAgICAgIGZpZWxkOiBmaWVsZFN0cmluZywKICAgICAgICAgICAgICAgIGRhdGE6ICgwLCBfdXRpbHNVdGlsc0pzLmRlZXBDbG9uZSkoYWRkVmFsdWVzKQogICAgICAgICAgICAgIH0pOwogICAgICAgICAgICB9CgogICAgICAgICAgICAvL3JlLWRlZmluZSBwYXRocy4uLgogICAgICAgICAgICBpZiAoaWR4ICE9IG9iai5sZW5ndGggLSAxKSB7CiAgICAgICAgICAgICAgcGF0aC5yZUluZGV4RnJvbShvYmopOwogICAgICAgICAgICB9CiAgICAgICAgICB9KSgpOwogICAgICAgIH0gZWxzZSB7CiAgICAgICAgICB2YXIgZmllbGQgPSBwYXRoWyduZXcnXShjaGFuZ2VzW2ldLm5hbWUpOwogICAgICAgICAgdmFyIGZpZWxkU3RyaW5nID0gZmllbGQudG9TdHJpbmcoKTsKCiAgICAgICAgICBpZiAoZmllbGRTdHJpbmcuaW5kZXhPZignU3ltYm9sJykgIT09IC0xKSB7CiAgICAgICAgICAgIC8vaGFjayBmb3IgUGhhbnRvbUpTMgogICAgICAgICAgICAvL2NvbnNvbGUubG9nKCdTWU1CT0w6ICcsIGNoYW5nZXNbaV0pOwogICAgICAgICAgICBjb250aW51ZTsKICAgICAgICAgIH0KCiAgICAgICAgICAvL2xldCBvbGRWYWx1ZSA9IGNoYW5nZXNbaV0ub2xkVmFsdWU7CiAgICAgICAgICB2YXIgbmV3VmFsdWUgPSBvYmpbY2hhbmdlc1tpXS5uYW1lXTsKICAgICAgICAgIGlmIChjaGFuZ2VzW2ldLnR5cGUgPT09ICd1cGRhdGUnKSB7CiAgICAgICAgICAgIHRoaXMuX2ZpcmVFdmVudCh7CiAgICAgICAgICAgICAgY1R5cGU6IENoYW5nZVR5cGUuVVBEQVRFLAogICAgICAgICAgICAgIG9UeXBlOiBvYmpUeXBlLAogICAgICAgICAgICAgIGZpZWxkOiBmaWVsZFN0cmluZywKICAgICAgICAgICAgICBkYXRhOiAoMCwgX3V0aWxzVXRpbHNKcy5kZWVwQ2xvbmUpKG5ld1ZhbHVlKQogICAgICAgICAgICB9KTsKICAgICAgICAgIH0KCiAgICAgICAgICBpZiAoY2hhbmdlc1tpXS50eXBlID09PSAnYWRkJykgewogICAgICAgICAgICB0aGlzLl9pbnRlcm5hbE9ic2VydmUoZmllbGQsIG5ld1ZhbHVlKTsKICAgICAgICAgICAgdGhpcy5fZmlyZUV2ZW50KHsKICAgICAgICAgICAgICBjVHlwZTogQ2hhbmdlVHlwZS5BREQsCiAgICAgICAgICAgICAgb1R5cGU6IG9ialR5cGUsCiAgICAgICAgICAgICAgZmllbGQ6IGZpZWxkU3RyaW5nLAogICAgICAgICAgICAgIGRhdGE6ICgwLCBfdXRpbHNVdGlsc0pzLmRlZXBDbG9uZSkobmV3VmFsdWUpCiAgICAgICAgICAgIH0pOwogICAgICAgICAgfQoKICAgICAgICAgIGlmIChjaGFuZ2VzW2ldLnR5cGUgPT09ICdkZWxldGUnKSB7CiAgICAgICAgICAgIHRoaXMuX2ZpcmVFdmVudCh7CiAgICAgICAgICAgICAgY1R5cGU6IENoYW5nZVR5cGUuUkVNT1ZFLAogICAgICAgICAgICAgIG9UeXBlOiBvYmpUeXBlLAogICAgICAgICAgICAgIGZpZWxkOiBmaWVsZFN0cmluZwogICAgICAgICAgICB9KTsKICAgICAgICAgIH0KICAgICAgICB9CiAgICAgIH0KICAgIH0KICB9LCB7CiAgICBrZXk6ICdkYXRhJywKICAgIGdldDogZnVuY3Rpb24gZ2V0KCkgewogICAgICByZXR1cm4gdGhpcy5fZGF0YTsKICAgIH0KICB9XSk7CgogIHJldHVybiBTeW5jT2JqZWN0Owp9KSgpOwoKdmFyIFBhdGggPSAoZnVuY3Rpb24gKCkgewogIGZ1bmN0aW9uIFBhdGgoKSB7CiAgICBfY2xhc3NDYWxsQ2hlY2sodGhpcywgUGF0aCk7CgogICAgdGhpcy5fcGF0aCA9IFtdOwogICAgdGhpcy5fb2JzZXJ2YWJsZXMgPSB7fTsgLy88aW5kZXg6QXJyYXlJbmRleD4KICB9CgogIF9jcmVhdGVDbGFzcyhQYXRoLCBbewogICAga2V5OiAncmVtb3ZlSW5kZXgnLAogICAgdmFsdWU6IGZ1bmN0aW9uIHJlbW92ZUluZGV4KGlkeCkgewogICAgICAvL2NvbnNvbGUubG9nKCdSRU1PVkUtUEFUSCAnICsgaWR4KTsKICAgICAgZGVsZXRlIHRoaXMuX29ic2VydmFibGVzW2lkeF07CiAgICB9CiAgfSwgewogICAga2V5OiAncmVJbmRleEZyb20nLAogICAgdmFsdWU6IGZ1bmN0aW9uIHJlSW5kZXhGcm9tKGFycmF5KSB7CiAgICAgIHZhciBfdGhpczMgPSB0aGlzOwoKICAgICAgT2JqZWN0LmtleXModGhpcy5fb2JzZXJ2YWJsZXMpLmZvckVhY2goZnVuY3Rpb24gKGtleSkgewogICAgICAgIHZhciBhcnJheUluZGV4ID0gX3RoaXMzLl9vYnNlcnZhYmxlc1trZXldOwogICAgICAgIHZhciBpZHggPSBhcnJheS5pbmRleE9mKGFycmF5SW5kZXgub2JqKTsKICAgICAgICBpZiAoYXJyYXlJbmRleC5pZHggIT0gaWR4KSB7CiAgICAgICAgICAvL2NvbnNvbGUubG9nKCdSRS1JTkRFWDogJyArIGtleSArICctPicgKyBpZHgpOwogICAgICAgICAgYXJyYXlJbmRleC5pZHggPSBpZHg7CiAgICAgICAgICBkZWxldGUgX3RoaXMzLl9vYnNlcnZhYmxlc1trZXldOwogICAgICAgICAgX3RoaXMzLl9vYnNlcnZhYmxlc1tpZHhdID0gYXJyYXlJbmRleDsKICAgICAgICB9CiAgICAgIH0pOwogICAgfQogIH0sIHsKICAgIGtleTogJ25ldycsCiAgICB2YWx1ZTogZnVuY3Rpb24gX25ldyhpZHgpIHsKICAgICAgaWYgKGlkeC5jb25zdHJ1Y3RvciA9PSBBcnJheUluZGV4KSB7CiAgICAgICAgLy9jb25zb2xlLmxvZygnUEFUSC1PQlNFUlY6ICcsIGlkeCk7CiAgICAgICAgdGhpcy5fb2JzZXJ2YWJsZXNbaWR4LmlkeF0gPSBpZHg7CiAgICAgIH0KCiAgICAgIHZhciBuUGF0aCA9IHRoaXMuY2xvbmUoKTsKICAgICAgblBhdGguX3BhdGgucHVzaChpZHgpOwoKICAgICAgcmV0dXJuIG5QYXRoOwogICAgfQogIH0sIHsKICAgIGtleTogJ2Nsb25lJywKICAgIHZhbHVlOiBmdW5jdGlvbiBjbG9uZSgpIHsKICAgICAgdmFyIG5QYXRoID0gbmV3IFBhdGgoKTsKICAgICAgdGhpcy5fcGF0aC5mb3JFYWNoKGZ1bmN0aW9uICh2YWx1ZSkgewogICAgICAgIG5QYXRoLl9wYXRoLnB1c2godmFsdWUpOwogICAgICB9KTsKCiAgICAgIHJldHVybiBuUGF0aDsKICAgIH0KICB9LCB7CiAgICBrZXk6ICd0b1N0cmluZycsCiAgICB2YWx1ZTogZnVuY3Rpb24gdG9TdHJpbmcoKSB7CiAgICAgIC8vVE9ETzogb3B0aW1pemUhIQogICAgICB2YXIgc3RyID0gJyc7CiAgICAgIHRoaXMuX3BhdGguZm9yRWFjaChmdW5jdGlvbiAodmFsdWUsIGluZGV4KSB7CiAgICAgICAgaWYgKGluZGV4ID09PSAwKSB7CiAgICAgICAgICBzdHIgPSB2YWx1ZS50b1N0cmluZygpOwogICAgICAgIH0gZWxzZSB7CiAgICAgICAgICBzdHIgKz0gJy4nICsgdmFsdWUudG9TdHJpbmcoKTsKICAgICAgICB9CiAgICAgIH0pOwoKICAgICAgcmV0dXJuIHN0cjsKICAgIH0KICB9XSk7CgogIHJldHVybiBQYXRoOwp9KSgpOwoKdmFyIEFycmF5SW5kZXggPSAoZnVuY3Rpb24gKCkgewogIGZ1bmN0aW9uIEFycmF5SW5kZXgob2JqLCBpZHgpIHsKICAgIF9jbGFzc0NhbGxDaGVjayh0aGlzLCBBcnJheUluZGV4KTsKCiAgICB0aGlzLm9iaiA9IG9iajsKICAgIHRoaXMuaWR4ID0gaWR4OwogIH0KCiAgX2NyZWF0ZUNsYXNzKEFycmF5SW5kZXgsIFt7CiAgICBrZXk6ICd0b1N0cmluZycsCiAgICB2YWx1ZTogZnVuY3Rpb24gdG9TdHJpbmcoKSB7CiAgICAgIHJldHVybiB0aGlzLmlkeC50b1N0cmluZygpOwogICAgfQogIH1dKTsKCiAgcmV0dXJuIEFycmF5SW5kZXg7Cn0pKCk7Cgp2YXIgQ2hhbmdlVHlwZSA9IHsgVVBEQVRFOiAndXBkYXRlJywgQUREOiAnYWRkJywgUkVNT1ZFOiAncmVtb3ZlJyB9OwpleHBvcnRzLkNoYW5nZVR5cGUgPSBDaGFuZ2VUeXBlOwp2YXIgT2JqZWN0VHlwZSA9IHsgT0JKRUNUOiAnb2JqZWN0JywgQVJSQVk6ICdhcnJheScgfTsKZXhwb3J0cy5PYmplY3RUeXBlID0gT2JqZWN0VHlwZTsKZXhwb3J0c1snZGVmYXVsdCddID0gU3luY09iamVjdDsKCn0seyIuLi91dGlscy91dGlscy5qcyI6MjR9XSwyMjpbZnVuY3Rpb24ocmVxdWlyZSxtb2R1bGUsZXhwb3J0cyl7Cid1c2Ugc3RyaWN0JzsKCk9iamVjdC5kZWZpbmVQcm9wZXJ0eShleHBvcnRzLCAnX19lc01vZHVsZScsIHsKICB2YWx1ZTogdHJ1ZQp9KTsKCnZhciBfY3JlYXRlQ2xhc3MgPSAoZnVuY3Rpb24gKCkgeyBmdW5jdGlvbiBkZWZpbmVQcm9wZXJ0aWVzKHRhcmdldCwgcHJvcHMpIHsgZm9yICh2YXIgaSA9IDA7IGkgPCBwcm9wcy5sZW5ndGg7IGkrKykgeyB2YXIgZGVzY3JpcHRvciA9IHByb3BzW2ldOyBkZXNjcmlwdG9yLmVudW1lcmFibGUgPSBkZXNjcmlwdG9yLmVudW1lcmFibGUgfHwgZmFsc2U7IGRlc2NyaXB0b3IuY29uZmlndXJhYmxlID0gdHJ1ZTsgaWYgKCd2YWx1ZScgaW4gZGVzY3JpcHRvcikgZGVzY3JpcHRvci53cml0YWJsZSA9IHRydWU7IE9iamVjdC5kZWZpbmVQcm9wZXJ0eSh0YXJnZXQsIGRlc2NyaXB0b3Iua2V5LCBkZXNjcmlwdG9yKTsgfSB9IHJldHVybiBmdW5jdGlvbiAoQ29uc3RydWN0b3IsIHByb3RvUHJvcHMsIHN0YXRpY1Byb3BzKSB7IGlmIChwcm90b1Byb3BzKSBkZWZpbmVQcm9wZXJ0aWVzKENvbnN0cnVjdG9yLnByb3RvdHlwZSwgcHJvdG9Qcm9wcyk7IGlmIChzdGF0aWNQcm9wcykgZGVmaW5lUHJvcGVydGllcyhDb25zdHJ1Y3Rvciwgc3RhdGljUHJvcHMpOyByZXR1cm4gQ29uc3RydWN0b3I7IH07IH0pKCk7CgpmdW5jdGlvbiBfaW50ZXJvcFJlcXVpcmVEZWZhdWx0KG9iaikgeyByZXR1cm4gb2JqICYmIG9iai5fX2VzTW9kdWxlID8gb2JqIDogeyAnZGVmYXVsdCc6IG9iaiB9OyB9CgpmdW5jdGlvbiBfY2xhc3NDYWxsQ2hlY2soaW5zdGFuY2UsIENvbnN0cnVjdG9yKSB7IGlmICghKGluc3RhbmNlIGluc3RhbmNlb2YgQ29uc3RydWN0b3IpKSB7IHRocm93IG5ldyBUeXBlRXJyb3IoJ0Nhbm5vdCBjYWxsIGEgY2xhc3MgYXMgYSBmdW5jdGlvbicpOyB9IH0KCnZhciBfRGF0YU9iamVjdFJlcG9ydGVyID0gcmVxdWlyZSgnLi9EYXRhT2JqZWN0UmVwb3J0ZXInKTsKCnZhciBfRGF0YU9iamVjdFJlcG9ydGVyMiA9IF9pbnRlcm9wUmVxdWlyZURlZmF1bHQoX0RhdGFPYmplY3RSZXBvcnRlcik7Cgp2YXIgX0RhdGFPYmplY3RPYnNlcnZlciA9IHJlcXVpcmUoJy4vRGF0YU9iamVjdE9ic2VydmVyJyk7Cgp2YXIgX0RhdGFPYmplY3RPYnNlcnZlcjIgPSBfaW50ZXJvcFJlcXVpcmVEZWZhdWx0KF9EYXRhT2JqZWN0T2JzZXJ2ZXIpOwoKLyoqCiAqIEBhdXRob3IgbWljYWVscGVkcm9zYUBnbWFpbC5jb20KICogQ2xpZW50IEFQSSBTeW5jcm9uaXphdGlvbiBzeXN0ZW0uCiAqLwoKdmFyIFN5bmNoZXIgPSAoZnVuY3Rpb24gKCkgewogIC8qIHByaXZhdGUKICBfb3duZXI6IFVSTAogIF9idXM6IE1pbmlCdXMKICAgX3N1YlVSTDogVVJMCiAgIF9yZXBvcnRlcnM6IDx1cmw6IERhdGFPYmplY3RSZXBvcnRlcj4KICBfb2JzZXJ2ZXJzOiA8dXJsOiBEYXRhT2JqZWN0T2JzZXJ2ZXI+CiAgIC0tLS1ldmVudCBoYW5kbGVycy0tLS0KICBfb25SZXNwb25zZUhhbmRsZXI6IChldmVudCkgPT4gdm9pZAogIF9vbk5vdGlmaWNhdGlvbkhhbmRsZXI6IChldmVudCkgPT4gdm9pZAogICovCgogIGZ1bmN0aW9uIFN5bmNoZXIob3duZXIsIGJ1cywgY29uZmlnKSB7CiAgICBfY2xhc3NDYWxsQ2hlY2sodGhpcywgU3luY2hlcik7CgogICAgdmFyIF90aGlzID0gdGhpczsKCiAgICBfdGhpcy5fb3duZXIgPSBvd25lcjsKICAgIF90aGlzLl9idXMgPSBidXM7CgogICAgX3RoaXMuX3N1YlVSTCA9IGNvbmZpZy5ydW50aW1lVVJMICsgJy9zbSc7CgogICAgX3RoaXMuX3JlcG9ydGVycyA9IHt9OwogICAgX3RoaXMuX29ic2VydmVycyA9IHt9OwoKICAgIGJ1cy5hZGRMaXN0ZW5lcihvd25lciwgZnVuY3Rpb24gKG1zZykgewogICAgICBjb25zb2xlLmxvZygnU3luY2hlci1SQ1Y6ICcsIG1zZyk7CiAgICAgIHN3aXRjaCAobXNnLnR5cGUpIHsKICAgICAgICBjYXNlICdyZXNwb25zZSc6CiAgICAgICAgICBfdGhpcy5fb25SZXNwb25zZShtc2cpO2JyZWFrOwogICAgICAgIGNhc2UgJ2ZvcndhcmQnOgogICAgICAgICAgX3RoaXMuX29uRm9yd2FyZChtc2cpO2JyZWFrOwogICAgICAgIGNhc2UgJ2NyZWF0ZSc6CiAgICAgICAgICBfdGhpcy5fb25DcmVhdGUobXNnKTticmVhazsKICAgICAgICBjYXNlICd1cGRhdGUnOgogICAgICAgICAgX3RoaXMuX29uQ2hhbmdlKG1zZyk7YnJlYWs7CiAgICAgICAgY2FzZSAnYWRkJzoKICAgICAgICAgIF90aGlzLl9vbkNoYW5nZShtc2cpO2JyZWFrOwogICAgICAgIGNhc2UgJ3JlbW92ZSc6CiAgICAgICAgICBfdGhpcy5fb25DaGFuZ2UobXNnKTticmVhazsKICAgICAgfQogICAgfSk7CiAgfQoKICBfY3JlYXRlQ2xhc3MoU3luY2hlciwgW3sKICAgIGtleTogJ2NyZWF0ZScsCgogICAgLyoqCiAgICAgKiBSZXF1ZXN0IGEgRGF0YU9iamVjdFJlcG9ydGVyIGNyZWF0aW9uLiBUaGUgVVJMIHdpbGwgYmUgYmUgcmVxdWVzdGVkIGJ5IHRoZSBhbGxvY2F0aW9uIG1lY2hhbmlzbS4KICAgICAqIEBwYXJhbSAge1NjaGVtYX0gc2NoZW1hIFNjaGVtYSBvZiB0aGUgb2JqZWN0CiAgICAgKiBAcGFyYW0gIHtIeXBlcnR5VVJMW119IExpc3Qgb2YgaHlwZXJ0aWVzIHRvIHNlbmQgdGhlIGNyZWF0ZQogICAgICogQHBhcmFtICB7SlNPTn0gaW5pdGlhbERhdGEgT2JqZWN0IGluaXRpYWwgZGF0YQogICAgICogQHJldHVybiB7UHJvbWlzZTxEYXRhT2JqZWN0UmVwb3J0ZXI+fSBSZXR1cm4gUHJvbWlzZSB0byBhIG5ldyBSZXBvcnRlci4gVGhlIHJlcG9ydGVyIGNhbiBiZSBhY2NlcHRlZCBvciByZWplY3RlZCBieSB0aGUgUEVQCiAgICAgKi8KICAgIHZhbHVlOiBmdW5jdGlvbiBjcmVhdGUoc2NoZW1hLCBvYnNlcnZlcnMsIGluaXRpYWxEYXRhKSB7CiAgICAgIHZhciBfdGhpcyA9IHRoaXM7CgogICAgICAvL1RPRE86IHdoYXQgdG8gZG8gd2l0aCBzY2hlbWE/CgogICAgICB2YXIgcmVxdWVzdE1zZyA9IHsKICAgICAgICB0eXBlOiAnY3JlYXRlJywgZnJvbTogX3RoaXMuX293bmVyLCB0bzogX3RoaXMuX3N1YlVSTCwKICAgICAgICBib2R5OiB7IHNjaGVtYTogc2NoZW1hLCB2YWx1ZTogaW5pdGlhbERhdGEsIGF1dGhvcmlzZTogb2JzZXJ2ZXJzIH0KICAgICAgfTsKCiAgICAgIHJldHVybiBuZXcgUHJvbWlzZShmdW5jdGlvbiAocmVzb2x2ZSwgcmVqZWN0KSB7CiAgICAgICAgLy9yZXF1ZXN0IGNyZWF0ZSB0byB0aGUgQWxsb2NhdGlvbiBzeXN0ZW0/IENhbiBiZSByZWplY3RlZCBieSB0aGUgUG9saWN5RW5naW5lLgogICAgICAgIF90aGlzLl9idXMucG9zdE1lc3NhZ2UocmVxdWVzdE1zZywgZnVuY3Rpb24gKHJlcGx5KSB7CiAgICAgICAgICBjb25zb2xlLmxvZygnY3JlYXRlLXJlc3BvbnNlOiAnLCByZXBseSk7CiAgICAgICAgICBpZiAocmVwbHkuYm9keS5jb2RlID09PSAyMDApIHsKICAgICAgICAgICAgdmFyIG9ialVybCA9IHJlcGx5LmJvZHkucmVzb3VyY2U7CgogICAgICAgICAgICAvL3JlcG9ydGVyIGNyZWF0aW9uIGFjY2VwdGVkCiAgICAgICAgICAgIHZhciBuZXdPYmogPSBuZXcgX0RhdGFPYmplY3RSZXBvcnRlcjJbJ2RlZmF1bHQnXShfdGhpcy5fb3duZXIsIG9ialVybCwgc2NoZW1hLCBfdGhpcy5fYnVzLCAnb24nLCBpbml0aWFsRGF0YSk7CiAgICAgICAgICAgIF90aGlzLl9yZXBvcnRlcnNbb2JqVXJsXSA9IG5ld09iajsKICAgICAgICAgICAgcmVzb2x2ZShuZXdPYmopOwogICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgLy9yZXBvcnRlciBjcmVhdGlvbiByZWplY3RlZAogICAgICAgICAgICByZWplY3QocmVwbHkuYm9keS5kZXNjKTsKICAgICAgICAgIH0KICAgICAgICB9KTsKICAgICAgfSk7CiAgICB9CgogICAgLyoqCiAgICAgKiBSZXF1ZXN0IGEgc3Vic2NyaXB0aW9uIHRvIGFuIGV4aXN0ZW50IG9iamVjdC4KICAgICAqIEBwYXJhbSAge09iamVjdFVSTH0gb2JqVVJMIEFkZHJlc3Mgb2YgdGhlIGV4aXN0ZW50IG9iamVjdC4KICAgICAqIEByZXR1cm4ge1Byb21pc2U8RGF0YU9iamVjdE9ic2VydmVyPn0gUmV0dXJuIFByb21pc2UgdG8gYSBuZXcgT2JzZXJ2ZXIuCiAgICAgKi8KICB9LCB7CiAgICBrZXk6ICdzdWJzY3JpYmUnLAogICAgdmFsdWU6IGZ1bmN0aW9uIHN1YnNjcmliZShvYmpVUkwpIHsKICAgICAgdmFyIF90aGlzID0gdGhpczsKICAgICAgdmFyIG9ialN1YnNjcmlwdG9yVVJMID0gb2JqVVJMICsgJy9zdWJzY3JpcHRpb24nOwoKICAgICAgLy9UT0RPOiB2YWxpZGF0ZSBpZiBzdWJzY3JpcHRpb24gYWxyZWFkeSBleGlzdHMgPwogICAgICAvL1RPRE86IHJlbW92ZSBmcm9tIGJvZHkgaHlwZXJ0eVVSTCAod2FzIGFkZGVkIGJlY2F1c2UgdGhlIFBvbGljeUVuZ2luZSkKICAgICAgdmFyIHN1YnNjcmliZU1zZyA9IHsKICAgICAgICB0eXBlOiAnc3Vic2NyaWJlJywgZnJvbTogX3RoaXMuX293bmVyLCB0bzogb2JqU3Vic2NyaXB0b3JVUkwKICAgICAgfTsKCiAgICAgIHJldHVybiBuZXcgUHJvbWlzZShmdW5jdGlvbiAocmVzb2x2ZSwgcmVqZWN0KSB7CiAgICAgICAgLy9yZXF1ZXN0IHN1YnNjcmlwdGlvbgogICAgICAgIF90aGlzLl9idXMucG9zdE1lc3NhZ2Uoc3Vic2NyaWJlTXNnLCBmdW5jdGlvbiAocmVwbHkpIHsKICAgICAgICAgIGNvbnNvbGUubG9nKCdzdWJzY3JpYmUtcmVzcG9uc2U6ICcsIHJlcGx5KTsKICAgICAgICAgIGlmIChyZXBseS5ib2R5LmNvZGUgPT09IDIwMCkgewogICAgICAgICAgICAvL3N1YnNjcmlwdGlvbiBhY2NlcHRlZAogICAgICAgICAgICB2YXIgbmV3T2JqID0gX3RoaXMuX2FkZE9ic2VydmVyKG9ialVSTCwgcmVwbHkuYm9keS5zY2hlbWEsIHJlcGx5LmJvZHkudmFsdWUpOwogICAgICAgICAgICByZXNvbHZlKG5ld09iaik7CiAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAvL3N1YnNjcmlwdGlvbiByZWplY3RlZAogICAgICAgICAgICByZWplY3QocmVwbHkuYm9keS5kZXNjKTsKICAgICAgICAgIH0KICAgICAgICB9KTsKICAgICAgfSk7CiAgICB9CiAgfSwgewogICAga2V5OiAnb25SZXNwb25zZScsCiAgICB2YWx1ZTogZnVuY3Rpb24gb25SZXNwb25zZShjYWxsYmFjaykgewogICAgICB0aGlzLl9vblJlc3BvbnNlSGFuZGxlciA9IGNhbGxiYWNrOwogICAgfQogIH0sIHsKICAgIGtleTogJ29uTm90aWZpY2F0aW9uJywKICAgIHZhbHVlOiBmdW5jdGlvbiBvbk5vdGlmaWNhdGlvbihjYWxsYmFjaykgewogICAgICB0aGlzLl9vbk5vdGlmaWNhdGlvbkhhbmRsZXIgPSBjYWxsYmFjazsKICAgIH0KICB9LCB7CiAgICBrZXk6ICdfb25SZXNwb25zZScsCiAgICB2YWx1ZTogZnVuY3Rpb24gX29uUmVzcG9uc2UobXNnKSB7CiAgICAgIHZhciBfdGhpcyA9IHRoaXM7CgogICAgICAvL1RPRE86IHByb2Nlc3Mgbm90aWZpY2F0aW9uIHJlcG9uc2VzIQogICAgICBjb25zb2xlLmxvZygnb25SZXNwb25zZTonLCBtc2cpOwogICAgfQogIH0sIHsKICAgIGtleTogJ19vbkZvcndhcmQnLAogICAgdmFsdWU6IGZ1bmN0aW9uIF9vbkZvcndhcmQobXNnKSB7CiAgICAgIHZhciBfdGhpcyA9IHRoaXM7CgogICAgICB2YXIgcmVwb3J0ZXIgPSBfdGhpcy5fcmVwb3J0ZXJzW21zZy5ib2R5LnRvXTsKICAgICAgcmVwb3J0ZXIuX29uRm9yd2FyZChtc2cpOwogICAgfQogIH0sIHsKICAgIGtleTogJ19vbkNyZWF0ZScsCiAgICB2YWx1ZTogZnVuY3Rpb24gX29uQ3JlYXRlKG1zZykgewogICAgICB2YXIgX3RoaXMgPSB0aGlzOwoKICAgICAgdmFyIGV2ZW50ID0gewogICAgICAgIHR5cGU6IG1zZy50eXBlLAogICAgICAgIGZyb206IG1zZy5mcm9tLAogICAgICAgIHVybDogbXNnLmJvZHkucmVzb3VyY2UsCiAgICAgICAgc2NoZW1hOiBtc2cuYm9keS5zY2hlbWEsCiAgICAgICAgdmFsdWU6IG1zZy5ib2R5LnZhbHVlLAoKICAgICAgICBhY2s6IGZ1bmN0aW9uIGFjaygpIHsKICAgICAgICAgIC8vc2VuZCBhY2sgcmVzcG9uc2UgbWVzc2FnZQogICAgICAgICAgX3RoaXMuX2J1cy5wb3N0TWVzc2FnZSh7CiAgICAgICAgICAgIGlkOiBtc2cuaWQsIHR5cGU6ICdyZXNwb25zZScsIGZyb206IG1zZy50bywgdG86IG1zZy5mcm9tLAogICAgICAgICAgICBib2R5OiB7IGNvZGU6IDIwMCB9CiAgICAgICAgICB9KTsKICAgICAgICB9CiAgICAgIH07CgogICAgICBpZiAoX3RoaXMuX29uTm90aWZpY2F0aW9uSGFuZGxlcikgewogICAgICAgIF90aGlzLl9vbk5vdGlmaWNhdGlvbkhhbmRsZXIoZXZlbnQpOwogICAgICB9CiAgICB9CiAgfSwgewogICAga2V5OiAnX29uQ2hhbmdlJywKICAgIHZhbHVlOiBmdW5jdGlvbiBfb25DaGFuZ2UobXNnKSB7CiAgICAgIHZhciBfdGhpcyA9IHRoaXM7CgogICAgICB2YXIgb2JzZXJ2ZXIgPSBfdGhpcy5fb2JzZXJ2ZXJzW21zZy5mcm9tXTsKICAgICAgb2JzZXJ2ZXIuX2NoYW5nZU9iamVjdChtc2cpOwogICAgfQogIH0sIHsKICAgIGtleTogJ19hZGRPYnNlcnZlcicsCiAgICB2YWx1ZTogZnVuY3Rpb24gX2FkZE9ic2VydmVyKG9ialVSTCwgc2NoZW1hVVJMLCBpbml0aWFsRGF0YSkgewogICAgICB2YXIgX3RoaXMgPSB0aGlzOwoKICAgICAgdmFyIG5ld09iaiA9IG5ldyBfRGF0YU9iamVjdE9ic2VydmVyMlsnZGVmYXVsdCddKF90aGlzLl9vd25lciwgb2JqVVJMLCBzY2hlbWFVUkwsICdvbicsIGluaXRpYWxEYXRhKTsKICAgICAgX3RoaXMuX29ic2VydmVyc1tvYmpVUkxdID0gbmV3T2JqOwoKICAgICAgcmV0dXJuIG5ld09iajsKICAgIH0KICB9LCB7CiAgICBrZXk6ICdvd25lcicsCiAgICBnZXQ6IGZ1bmN0aW9uIGdldCgpIHsKICAgICAgcmV0dXJuIHRoaXMuX293bmVyOwogICAgfQogIH0sIHsKICAgIGtleTogJ3JlcG9ydGVycycsCiAgICBnZXQ6IGZ1bmN0aW9uIGdldCgpIHsKICAgICAgcmV0dXJuIHRoaXMuX3JlcG9ydGVyczsKICAgIH0KICB9LCB7CiAgICBrZXk6ICdvYnNlcnZlcnMnLAogICAgZ2V0OiBmdW5jdGlvbiBnZXQoKSB7CiAgICAgIHJldHVybiB0aGlzLl9vYnNlcnZlcnM7CiAgICB9CiAgfV0pOwoKICByZXR1cm4gU3luY2hlcjsKfSkoKTsKCmV4cG9ydHNbJ2RlZmF1bHQnXSA9IFN5bmNoZXI7Cm1vZHVsZS5leHBvcnRzID0gZXhwb3J0c1snZGVmYXVsdCddOwoKfSx7Ii4vRGF0YU9iamVjdE9ic2VydmVyIjoxOSwiLi9EYXRhT2JqZWN0UmVwb3J0ZXIiOjIwfV0sMjM6W2Z1bmN0aW9uKHJlcXVpcmUsbW9kdWxlLGV4cG9ydHMpewovKioKICogRXZlbnRFbWl0dGVyCiAqIEFsbCBjbGFzc2VzIHdoaWNoIGV4dGVuZHMgdGhpcywgY2FuIGhhdmUgYWRkRXZlbnRMaXN0ZW5lciBhbmQgdHJpZ2dlciBldmVudHM7CiAqLwoidXNlIHN0cmljdCI7CgpPYmplY3QuZGVmaW5lUHJvcGVydHkoZXhwb3J0cywgIl9fZXNNb2R1bGUiLCB7CiAgdmFsdWU6IHRydWUKfSk7Cgp2YXIgX2NyZWF0ZUNsYXNzID0gKGZ1bmN0aW9uICgpIHsgZnVuY3Rpb24gZGVmaW5lUHJvcGVydGllcyh0YXJnZXQsIHByb3BzKSB7IGZvciAodmFyIGkgPSAwOyBpIDwgcHJvcHMubGVuZ3RoOyBpKyspIHsgdmFyIGRlc2NyaXB0b3IgPSBwcm9wc1tpXTsgZGVzY3JpcHRvci5lbnVtZXJhYmxlID0gZGVzY3JpcHRvci5lbnVtZXJhYmxlIHx8IGZhbHNlOyBkZXNjcmlwdG9yLmNvbmZpZ3VyYWJsZSA9IHRydWU7IGlmICgidmFsdWUiIGluIGRlc2NyaXB0b3IpIGRlc2NyaXB0b3Iud3JpdGFibGUgPSB0cnVlOyBPYmplY3QuZGVmaW5lUHJvcGVydHkodGFyZ2V0LCBkZXNjcmlwdG9yLmtleSwgZGVzY3JpcHRvcik7IH0gfSByZXR1cm4gZnVuY3Rpb24gKENvbnN0cnVjdG9yLCBwcm90b1Byb3BzLCBzdGF0aWNQcm9wcykgeyBpZiAocHJvdG9Qcm9wcykgZGVmaW5lUHJvcGVydGllcyhDb25zdHJ1Y3Rvci5wcm90b3R5cGUsIHByb3RvUHJvcHMpOyBpZiAoc3RhdGljUHJvcHMpIGRlZmluZVByb3BlcnRpZXMoQ29uc3RydWN0b3IsIHN0YXRpY1Byb3BzKTsgcmV0dXJuIENvbnN0cnVjdG9yOyB9OyB9KSgpOwoKZnVuY3Rpb24gX2NsYXNzQ2FsbENoZWNrKGluc3RhbmNlLCBDb25zdHJ1Y3RvcikgeyBpZiAoIShpbnN0YW5jZSBpbnN0YW5jZW9mIENvbnN0cnVjdG9yKSkgeyB0aHJvdyBuZXcgVHlwZUVycm9yKCJDYW5ub3QgY2FsbCBhIGNsYXNzIGFzIGEgZnVuY3Rpb24iKTsgfSB9Cgp2YXIgRXZlbnRFbWl0dGVyID0gKGZ1bmN0aW9uICgpIHsKICBmdW5jdGlvbiBFdmVudEVtaXR0ZXIoKSB7CiAgICBfY2xhc3NDYWxsQ2hlY2sodGhpcywgRXZlbnRFbWl0dGVyKTsKICB9CgogIF9jcmVhdGVDbGFzcyhFdmVudEVtaXR0ZXIsIFt7CiAgICBrZXk6ICJhZGRFdmVudExpc3RlbmVyIiwKCiAgICAvKioKICAgICAqIGFkZEV2ZW50TGlzdGVuZXIgbGlzdGVuIGZvciBhbiBldmVudFR5cGUKICAgICAqIEBwYXJhbSAge3N0cmluZ30gICAgICAgICBldmVudFR5cGUgLSBsaXN0ZW5pbmcgZm9yIHRoaXMgdHlwZSBvZiBldmVudAogICAgICogQHBhcmFtICB7RnVuY3Rpb259ICAgICAgIGNiICAgICAgICAtIGNhbGxiYWNrIGZ1bmN0aW9uIHdpbGwgYmUgZXhlY3V0ZWQgd2hlbiB0aGUgZXZlbnQgaXQgaXMgaW52b2tlZAogICAgICovCiAgICB2YWx1ZTogZnVuY3Rpb24gYWRkRXZlbnRMaXN0ZW5lcihldmVudFR5cGUsIGNiKSB7CiAgICAgIHZhciBfdGhpcyA9IHRoaXM7CiAgICAgIF90aGlzW2V2ZW50VHlwZV0gPSBjYjsKICAgIH0KCiAgICAvKioKICAgICAqIEludm9rZSB0aGUgZXZlbnRUeXBlCiAgICAgKiBAcGFyYW0gIHtzdHJpbmd9IGV2ZW50VHlwZSAtIGV2ZW50IHdpbGwgYmUgaW52b2tlZAogICAgICogQHBhcmFtICB7b2JqZWN0fSBwYXJhbXMgLSBwYXJhbWV0ZXJzIHdpbGwgYmUgcGFzc2VkIHRvIHRoZSBhZGRFdmVudExpc3RlbmVyCiAgICAgKi8KICB9LCB7CiAgICBrZXk6ICJ0cmlnZ2VyIiwKICAgIHZhbHVlOiBmdW5jdGlvbiB0cmlnZ2VyKGV2ZW50VHlwZSwgcGFyYW1zKSB7CiAgICAgIHZhciBfdGhpcyA9IHRoaXM7CgogICAgICBpZiAoX3RoaXNbZXZlbnRUeXBlXSkgewogICAgICAgIF90aGlzW2V2ZW50VHlwZV0ocGFyYW1zKTsKICAgICAgfQogICAgfQogIH1dKTsKCiAgcmV0dXJuIEV2ZW50RW1pdHRlcjsKfSkoKTsKCmV4cG9ydHNbImRlZmF1bHQiXSA9IEV2ZW50RW1pdHRlcjsKbW9kdWxlLmV4cG9ydHMgPSBleHBvcnRzWyJkZWZhdWx0Il07Cgp9LHt9XSwyNDpbZnVuY3Rpb24ocmVxdWlyZSxtb2R1bGUsZXhwb3J0cyl7Ci8qKgogKiBTdXBwb3J0IG1vZHVsZSB3aXRoIHNvbWUgZnVuY3Rpb25zIHdpbGwgYmUgdXNlZnVsCiAqIEBtb2R1bGUgdXRpbHMKICovCgovKioKICogQHR5cGVkZWYgZGl2aWRlVVJMCiAqIEB0eXBlIE9iamVjdAogKiBAcHJvcGVydHkge3N0cmluZ30gdHlwZSBUaGUgdHlwZSBvZiBVUkwKICogQHByb3BlcnR5IHtzdHJpbmd9IGRvbWFpbiBUaGUgZG9tYWluIG9mIFVSTAogKiBAcHJvcGVydHkge3N0cmluZ30gaWRlbnRpdHkgVGhlIGlkZW50aXR5IG9mIFVSTAogKi8KCi8qKgogKiBEaXZpZGUgYW4gdXJsIGluIHR5cGUsIGRvbWFpbiBhbmQgaWRlbnRpdHkKICogQHBhcmFtICB7VVJMLlVSTH0gdXJsIC0gdXJsIGFkZHJlc3MKICogQHJldHVybiB7ZGl2aWRlVVJMfSB0aGUgcmVzdWx0IG9mIGRpdmlkZVVSTAogKi8KJ3VzZSBzdHJpY3QnOwoKT2JqZWN0LmRlZmluZVByb3BlcnR5KGV4cG9ydHMsICdfX2VzTW9kdWxlJywgewogIHZhbHVlOiB0cnVlCn0pOwpleHBvcnRzLmRpdmlkZVVSTCA9IGRpdmlkZVVSTDsKZXhwb3J0cy5kZWVwQ2xvbmUgPSBkZWVwQ2xvbmU7CgpmdW5jdGlvbiBkaXZpZGVVUkwodXJsKSB7CgogIC8vIGxldCByZSA9IC8oW2EtekEtWi1dKik/OlwvXC8oPzpcLik/KFstYS16QS1aMC05QDolLl9cK34jPV17MiwyNTZ9XC5bYS16XXsyLDZ9XGIpKihcL1tcL1xkXHdcLi1dKikqKD86W1w/XSkqKC4rKSovZ2k7CiAgdmFyIHJlID0gLyhbYS16QS1aLV0qKTpcL1wvKD86XC4pPyhbLWEtekEtWjAtOUA6JS5fXCt+Iz1dezIsMjU2fSkoWy1hLXpBLVowLTlAOiUuX1wrfiM9XC9dKikvZ2k7CiAgdmFyIHN1YnN0ID0gJyQxLCQyLCQzJzsKICB2YXIgcGFydHMgPSB1cmwucmVwbGFjZShyZSwgc3Vic3QpLnNwbGl0KCcsJyk7CiAgdmFyIHJlc3VsdCA9IHsKICAgIHR5cGU6IHBhcnRzWzBdLAogICAgZG9tYWluOiBwYXJ0c1sxXSwKICAgIGlkZW50aXR5OiBwYXJ0c1syXQogIH07CgogIHJldHVybiByZXN1bHQ7Cn0KCi8qKgogKiBNYWtlIGEgQ09QWSBvZiB0aGUgb3JpZ2luYWwgZGF0YQogKiBAcGFyYW0gIHtPYmplY3R9ICBvYmogLSBvYmplY3QgdG8gYmUgY2xvbmVkCiAqIEByZXR1cm4ge09iamVjdH0KICovCgpmdW5jdGlvbiBkZWVwQ2xvbmUob2JqKSB7CiAgLy9UT0RPOiBzaW1wbGUgYnV0IGluZWZmaWNpZW50IEpTT04gZGVlcCBjbG9uZS4uLgogIHJldHVybiBKU09OLnBhcnNlKEpTT04uc3RyaW5naWZ5KG9iaikpOwp9Cgp9LHt9XX0se30sWzNdKSgzKQp9KTs=",
      "sourceCodeClassname": "HelloHyperty",
      "encoding": "Base64",
      "signature": ""
    },
    "language": "Javascript ECMA5",
    "signature": "",
    "messageSchemas": "",
    "configuration": "",
    "constraints": "",
    "hypertyCapabilities": "",
    "protocolCapabilities": "",
    "policies": "",
    "dataObjects": []
  },
  "WorldHyperty": {
    "cguid": "2",
    "type": "0",
    "version": "0.1",
    "description": "description of World Hyperty",
    "objectName": "WorldHyperty",
    "sourcePackageURL": "/sourcePackage",
    "sourcePackage": {},
    "language": "Javascript ECMA5",
    "signature": "",
    "messageSchemas": "",
    "configuration": "",
    "constraints": "",
    "hypertyCapabilities": "",
    "protocolCapabilities": "",
    "policies": "",
    "dataObjects": []
  },
  "HypertyChat": {
    "sourcePackage": {
      "sourceCode": "KGZ1bmN0aW9uKGYpe2lmKHR5cGVvZiBleHBvcnRzPT09Im9iamVjdCImJnR5cGVvZiBtb2R1bGUhPT0idW5kZWZpbmVkIil7bW9kdWxlLmV4cG9ydHM9ZigpfWVsc2UgaWYodHlwZW9mIGRlZmluZT09PSJmdW5jdGlvbiImJmRlZmluZS5hbWQpe2RlZmluZShbXSxmKX1lbHNle3ZhciBnO2lmKHR5cGVvZiB3aW5kb3chPT0idW5kZWZpbmVkIil7Zz13aW5kb3d9ZWxzZSBpZih0eXBlb2YgZ2xvYmFsIT09InVuZGVmaW5lZCIpe2c9Z2xvYmFsfWVsc2UgaWYodHlwZW9mIHNlbGYhPT0idW5kZWZpbmVkIil7Zz1zZWxmfWVsc2V7Zz10aGlzfWcuYWN0aXZhdGUgPSBmKCl9fSkoZnVuY3Rpb24oKXt2YXIgZGVmaW5lLG1vZHVsZSxleHBvcnRzO3JldHVybiAoZnVuY3Rpb24gZSh0LG4scil7ZnVuY3Rpb24gcyhvLHUpe2lmKCFuW29dKXtpZighdFtvXSl7dmFyIGE9dHlwZW9mIHJlcXVpcmU9PSJmdW5jdGlvbiImJnJlcXVpcmU7aWYoIXUmJmEpcmV0dXJuIGEobywhMCk7aWYoaSlyZXR1cm4gaShvLCEwKTt2YXIgZj1uZXcgRXJyb3IoIkNhbm5vdCBmaW5kIG1vZHVsZSAnIitvKyInIik7dGhyb3cgZi5jb2RlPSJNT0RVTEVfTk9UX0ZPVU5EIixmfXZhciBsPW5bb109e2V4cG9ydHM6e319O3Rbb11bMF0uY2FsbChsLmV4cG9ydHMsZnVuY3Rpb24oZSl7dmFyIG49dFtvXVsxXVtlXTtyZXR1cm4gcyhuP246ZSl9LGwsbC5leHBvcnRzLGUsdCxuLHIpfXJldHVybiBuW29dLmV4cG9ydHN9dmFyIGk9dHlwZW9mIHJlcXVpcmU9PSJmdW5jdGlvbiImJnJlcXVpcmU7Zm9yKHZhciBvPTA7bzxyLmxlbmd0aDtvKyspcyhyW29dKTtyZXR1cm4gc30pKHsxOltmdW5jdGlvbihyZXF1aXJlLG1vZHVsZSxleHBvcnRzKXsKbW9kdWxlLmV4cG9ydHMgPSB7ICJkZWZhdWx0IjogcmVxdWlyZSgiY29yZS1qcy9saWJyYXJ5L2ZuL29iamVjdC9jcmVhdGUiKSwgX19lc01vZHVsZTogdHJ1ZSB9Owp9LHsiY29yZS1qcy9saWJyYXJ5L2ZuL29iamVjdC9jcmVhdGUiOjE5fV0sMjpbZnVuY3Rpb24ocmVxdWlyZSxtb2R1bGUsZXhwb3J0cyl7Cm1vZHVsZS5leHBvcnRzID0geyAiZGVmYXVsdCI6IHJlcXVpcmUoImNvcmUtanMvbGlicmFyeS9mbi9vYmplY3QvZGVmaW5lLXByb3BlcnR5IiksIF9fZXNNb2R1bGU6IHRydWUgfTsKfSx7ImNvcmUtanMvbGlicmFyeS9mbi9vYmplY3QvZGVmaW5lLXByb3BlcnR5IjoyMH1dLDM6W2Z1bmN0aW9uKHJlcXVpcmUsbW9kdWxlLGV4cG9ydHMpewptb2R1bGUuZXhwb3J0cyA9IHsgImRlZmF1bHQiOiByZXF1aXJlKCJjb3JlLWpzL2xpYnJhcnkvZm4vb2JqZWN0L2dldC1vd24tcHJvcGVydHktZGVzY3JpcHRvciIpLCBfX2VzTW9kdWxlOiB0cnVlIH07Cn0seyJjb3JlLWpzL2xpYnJhcnkvZm4vb2JqZWN0L2dldC1vd24tcHJvcGVydHktZGVzY3JpcHRvciI6MjF9XSw0OltmdW5jdGlvbihyZXF1aXJlLG1vZHVsZSxleHBvcnRzKXsKbW9kdWxlLmV4cG9ydHMgPSB7ICJkZWZhdWx0IjogcmVxdWlyZSgiY29yZS1qcy9saWJyYXJ5L2ZuL29iamVjdC9nZXQtcHJvdG90eXBlLW9mIiksIF9fZXNNb2R1bGU6IHRydWUgfTsKfSx7ImNvcmUtanMvbGlicmFyeS9mbi9vYmplY3QvZ2V0LXByb3RvdHlwZS1vZiI6MjJ9XSw1OltmdW5jdGlvbihyZXF1aXJlLG1vZHVsZSxleHBvcnRzKXsKbW9kdWxlLmV4cG9ydHMgPSB7ICJkZWZhdWx0IjogcmVxdWlyZSgiY29yZS1qcy9saWJyYXJ5L2ZuL29iamVjdC9rZXlzIiksIF9fZXNNb2R1bGU6IHRydWUgfTsKfSx7ImNvcmUtanMvbGlicmFyeS9mbi9vYmplY3Qva2V5cyI6MjN9XSw2OltmdW5jdGlvbihyZXF1aXJlLG1vZHVsZSxleHBvcnRzKXsKbW9kdWxlLmV4cG9ydHMgPSB7ICJkZWZhdWx0IjogcmVxdWlyZSgiY29yZS1qcy9saWJyYXJ5L2ZuL29iamVjdC9zZXQtcHJvdG90eXBlLW9mIiksIF9fZXNNb2R1bGU6IHRydWUgfTsKfSx7ImNvcmUtanMvbGlicmFyeS9mbi9vYmplY3Qvc2V0LXByb3RvdHlwZS1vZiI6MjR9XSw3OltmdW5jdGlvbihyZXF1aXJlLG1vZHVsZSxleHBvcnRzKXsKbW9kdWxlLmV4cG9ydHMgPSB7ICJkZWZhdWx0IjogcmVxdWlyZSgiY29yZS1qcy9saWJyYXJ5L2ZuL3Byb21pc2UiKSwgX19lc01vZHVsZTogdHJ1ZSB9Owp9LHsiY29yZS1qcy9saWJyYXJ5L2ZuL3Byb21pc2UiOjI1fV0sODpbZnVuY3Rpb24ocmVxdWlyZSxtb2R1bGUsZXhwb3J0cyl7Cm1vZHVsZS5leHBvcnRzID0geyAiZGVmYXVsdCI6IHJlcXVpcmUoImNvcmUtanMvbGlicmFyeS9mbi9zeW1ib2wiKSwgX19lc01vZHVsZTogdHJ1ZSB9Owp9LHsiY29yZS1qcy9saWJyYXJ5L2ZuL3N5bWJvbCI6MjZ9XSw5OltmdW5jdGlvbihyZXF1aXJlLG1vZHVsZSxleHBvcnRzKXsKbW9kdWxlLmV4cG9ydHMgPSB7ICJkZWZhdWx0IjogcmVxdWlyZSgiY29yZS1qcy9saWJyYXJ5L2ZuL3N5bWJvbC9pdGVyYXRvciIpLCBfX2VzTW9kdWxlOiB0cnVlIH07Cn0seyJjb3JlLWpzL2xpYnJhcnkvZm4vc3ltYm9sL2l0ZXJhdG9yIjoyN31dLDEwOltmdW5jdGlvbihyZXF1aXJlLG1vZHVsZSxleHBvcnRzKXsKbW9kdWxlLmV4cG9ydHMgPSByZXF1aXJlKCIuL2NsYXNzQ2FsbENoZWNrLmpzIik7Cn0seyIuL2NsYXNzQ2FsbENoZWNrLmpzIjoxMX1dLDExOltmdW5jdGlvbihyZXF1aXJlLG1vZHVsZSxleHBvcnRzKXsKInVzZSBzdHJpY3QiOwoKZXhwb3J0cy5fX2VzTW9kdWxlID0gdHJ1ZTsKCmV4cG9ydHMuZGVmYXVsdCA9IGZ1bmN0aW9uIChpbnN0YW5jZSwgQ29uc3RydWN0b3IpIHsKICBpZiAoIShpbnN0YW5jZSBpbnN0YW5jZW9mIENvbnN0cnVjdG9yKSkgewogICAgdGhyb3cgbmV3IFR5cGVFcnJvcigiQ2Fubm90IGNhbGwgYSBjbGFzcyBhcyBhIGZ1bmN0aW9uIik7CiAgfQp9Owp9LHt9XSwxMjpbZnVuY3Rpb24ocmVxdWlyZSxtb2R1bGUsZXhwb3J0cyl7Cm1vZHVsZS5leHBvcnRzID0gcmVxdWlyZSgiLi9jcmVhdGVDbGFzcy5qcyIpOwp9LHsiLi9jcmVhdGVDbGFzcy5qcyI6MTN9XSwxMzpbZnVuY3Rpb24ocmVxdWlyZSxtb2R1bGUsZXhwb3J0cyl7CiJ1c2Ugc3RyaWN0IjsKCmV4cG9ydHMuX19lc01vZHVsZSA9IHRydWU7Cgp2YXIgX2RlZmluZVByb3BlcnR5ID0gcmVxdWlyZSgiLi4vY29yZS1qcy9vYmplY3QvZGVmaW5lLXByb3BlcnR5Iik7Cgp2YXIgX2RlZmluZVByb3BlcnR5MiA9IF9pbnRlcm9wUmVxdWlyZURlZmF1bHQoX2RlZmluZVByb3BlcnR5KTsKCmZ1bmN0aW9uIF9pbnRlcm9wUmVxdWlyZURlZmF1bHQob2JqKSB7IHJldHVybiBvYmogJiYgb2JqLl9fZXNNb2R1bGUgPyBvYmogOiB7IGRlZmF1bHQ6IG9iaiB9OyB9CgpleHBvcnRzLmRlZmF1bHQgPSBmdW5jdGlvbiAoKSB7CiAgZnVuY3Rpb24gZGVmaW5lUHJvcGVydGllcyh0YXJnZXQsIHByb3BzKSB7CiAgICBmb3IgKHZhciBpID0gMDsgaSA8IHByb3BzLmxlbmd0aDsgaSsrKSB7CiAgICAgIHZhciBkZXNjcmlwdG9yID0gcHJvcHNbaV07CiAgICAgIGRlc2NyaXB0b3IuZW51bWVyYWJsZSA9IGRlc2NyaXB0b3IuZW51bWVyYWJsZSB8fCBmYWxzZTsKICAgICAgZGVzY3JpcHRvci5jb25maWd1cmFibGUgPSB0cnVlOwogICAgICBpZiAoInZhbHVlIiBpbiBkZXNjcmlwdG9yKSBkZXNjcmlwdG9yLndyaXRhYmxlID0gdHJ1ZTsKICAgICAgKDAsIF9kZWZpbmVQcm9wZXJ0eTIuZGVmYXVsdCkodGFyZ2V0LCBkZXNjcmlwdG9yLmtleSwgZGVzY3JpcHRvcik7CiAgICB9CiAgfQoKICByZXR1cm4gZnVuY3Rpb24gKENvbnN0cnVjdG9yLCBwcm90b1Byb3BzLCBzdGF0aWNQcm9wcykgewogICAgaWYgKHByb3RvUHJvcHMpIGRlZmluZVByb3BlcnRpZXMoQ29uc3RydWN0b3IucHJvdG90eXBlLCBwcm90b1Byb3BzKTsKICAgIGlmIChzdGF0aWNQcm9wcykgZGVmaW5lUHJvcGVydGllcyhDb25zdHJ1Y3Rvciwgc3RhdGljUHJvcHMpOwogICAgcmV0dXJuIENvbnN0cnVjdG9yOwogIH07Cn0oKTsKfSx7Ii4uL2NvcmUtanMvb2JqZWN0L2RlZmluZS1wcm9wZXJ0eSI6Mn1dLDE0OltmdW5jdGlvbihyZXF1aXJlLG1vZHVsZSxleHBvcnRzKXsKInVzZSBzdHJpY3QiOwoKZXhwb3J0cy5fX2VzTW9kdWxlID0gdHJ1ZTsKCnZhciBfZ2V0UHJvdG90eXBlT2YgPSByZXF1aXJlKCIuLi9jb3JlLWpzL29iamVjdC9nZXQtcHJvdG90eXBlLW9mIik7Cgp2YXIgX2dldFByb3RvdHlwZU9mMiA9IF9pbnRlcm9wUmVxdWlyZURlZmF1bHQoX2dldFByb3RvdHlwZU9mKTsKCnZhciBfZ2V0T3duUHJvcGVydHlEZXNjcmlwdG9yID0gcmVxdWlyZSgiLi4vY29yZS1qcy9vYmplY3QvZ2V0LW93bi1wcm9wZXJ0eS1kZXNjcmlwdG9yIik7Cgp2YXIgX2dldE93blByb3BlcnR5RGVzY3JpcHRvcjIgPSBfaW50ZXJvcFJlcXVpcmVEZWZhdWx0KF9nZXRPd25Qcm9wZXJ0eURlc2NyaXB0b3IpOwoKZnVuY3Rpb24gX2ludGVyb3BSZXF1aXJlRGVmYXVsdChvYmopIHsgcmV0dXJuIG9iaiAmJiBvYmouX19lc01vZHVsZSA/IG9iaiA6IHsgZGVmYXVsdDogb2JqIH07IH0KCmV4cG9ydHMuZGVmYXVsdCA9IGZ1bmN0aW9uIGdldChvYmplY3QsIHByb3BlcnR5LCByZWNlaXZlcikgewogIGlmIChvYmplY3QgPT09IG51bGwpIG9iamVjdCA9IEZ1bmN0aW9uLnByb3RvdHlwZTsKICB2YXIgZGVzYyA9ICgwLCBfZ2V0T3duUHJvcGVydHlEZXNjcmlwdG9yMi5kZWZhdWx0KShvYmplY3QsIHByb3BlcnR5KTsKCiAgaWYgKGRlc2MgPT09IHVuZGVmaW5lZCkgewogICAgdmFyIHBhcmVudCA9ICgwLCBfZ2V0UHJvdG90eXBlT2YyLmRlZmF1bHQpKG9iamVjdCk7CgogICAgaWYgKHBhcmVudCA9PT0gbnVsbCkgewogICAgICByZXR1cm4gdW5kZWZpbmVkOwogICAgfSBlbHNlIHsKICAgICAgcmV0dXJuIGdldChwYXJlbnQsIHByb3BlcnR5LCByZWNlaXZlcik7CiAgICB9CiAgfSBlbHNlIGlmICgidmFsdWUiIGluIGRlc2MpIHsKICAgIHJldHVybiBkZXNjLnZhbHVlOwogIH0gZWxzZSB7CiAgICB2YXIgZ2V0dGVyID0gZGVzYy5nZXQ7CgogICAgaWYgKGdldHRlciA9PT0gdW5kZWZpbmVkKSB7CiAgICAgIHJldHVybiB1bmRlZmluZWQ7CiAgICB9CgogICAgcmV0dXJuIGdldHRlci5jYWxsKHJlY2VpdmVyKTsKICB9Cn07Cn0seyIuLi9jb3JlLWpzL29iamVjdC9nZXQtb3duLXByb3BlcnR5LWRlc2NyaXB0b3IiOjMsIi4uL2NvcmUtanMvb2JqZWN0L2dldC1wcm90b3R5cGUtb2YiOjR9XSwxNTpbZnVuY3Rpb24ocmVxdWlyZSxtb2R1bGUsZXhwb3J0cyl7CiJ1c2Ugc3RyaWN0IjsKCmV4cG9ydHMuX19lc01vZHVsZSA9IHRydWU7Cgp2YXIgX3NldFByb3RvdHlwZU9mID0gcmVxdWlyZSgiLi4vY29yZS1qcy9vYmplY3Qvc2V0LXByb3RvdHlwZS1vZiIpOwoKdmFyIF9zZXRQcm90b3R5cGVPZjIgPSBfaW50ZXJvcFJlcXVpcmVEZWZhdWx0KF9zZXRQcm90b3R5cGVPZik7Cgp2YXIgX2NyZWF0ZSA9IHJlcXVpcmUoIi4uL2NvcmUtanMvb2JqZWN0L2NyZWF0ZSIpOwoKdmFyIF9jcmVhdGUyID0gX2ludGVyb3BSZXF1aXJlRGVmYXVsdChfY3JlYXRlKTsKCnZhciBfdHlwZW9mMiA9IHJlcXVpcmUoIi4uL2hlbHBlcnMvdHlwZW9mIik7Cgp2YXIgX3R5cGVvZjMgPSBfaW50ZXJvcFJlcXVpcmVEZWZhdWx0KF90eXBlb2YyKTsKCmZ1bmN0aW9uIF9pbnRlcm9wUmVxdWlyZURlZmF1bHQob2JqKSB7IHJldHVybiBvYmogJiYgb2JqLl9fZXNNb2R1bGUgPyBvYmogOiB7IGRlZmF1bHQ6IG9iaiB9OyB9CgpleHBvcnRzLmRlZmF1bHQgPSBmdW5jdGlvbiAoc3ViQ2xhc3MsIHN1cGVyQ2xhc3MpIHsKICBpZiAodHlwZW9mIHN1cGVyQ2xhc3MgIT09ICJmdW5jdGlvbiIgJiYgc3VwZXJDbGFzcyAhPT0gbnVsbCkgewogICAgdGhyb3cgbmV3IFR5cGVFcnJvcigiU3VwZXIgZXhwcmVzc2lvbiBtdXN0IGVpdGhlciBiZSBudWxsIG9yIGEgZnVuY3Rpb24sIG5vdCAiICsgKHR5cGVvZiBzdXBlckNsYXNzID09PSAidW5kZWZpbmVkIiA/ICJ1bmRlZmluZWQiIDogKDAsIF90eXBlb2YzLmRlZmF1bHQpKHN1cGVyQ2xhc3MpKSk7CiAgfQoKICBzdWJDbGFzcy5wcm90b3R5cGUgPSAoMCwgX2NyZWF0ZTIuZGVmYXVsdCkoc3VwZXJDbGFzcyAmJiBzdXBlckNsYXNzLnByb3RvdHlwZSwgewogICAgY29uc3RydWN0b3I6IHsKICAgICAgdmFsdWU6IHN1YkNsYXNzLAogICAgICBlbnVtZXJhYmxlOiBmYWxzZSwKICAgICAgd3JpdGFibGU6IHRydWUsCiAgICAgIGNvbmZpZ3VyYWJsZTogdHJ1ZQogICAgfQogIH0pOwogIGlmIChzdXBlckNsYXNzKSBfc2V0UHJvdG90eXBlT2YyLmRlZmF1bHQgPyAoMCwgX3NldFByb3RvdHlwZU9mMi5kZWZhdWx0KShzdWJDbGFzcywgc3VwZXJDbGFzcykgOiBzdWJDbGFzcy5fX3Byb3RvX18gPSBzdXBlckNsYXNzOwp9Owp9LHsiLi4vY29yZS1qcy9vYmplY3QvY3JlYXRlIjoxLCIuLi9jb3JlLWpzL29iamVjdC9zZXQtcHJvdG90eXBlLW9mIjo2LCIuLi9oZWxwZXJzL3R5cGVvZiI6MTh9XSwxNjpbZnVuY3Rpb24ocmVxdWlyZSxtb2R1bGUsZXhwb3J0cyl7Cm1vZHVsZS5leHBvcnRzID0gcmVxdWlyZSgiLi9pbnRlcm9wUmVxdWlyZURlZmF1bHQuanMiKTsKfSx7Ii4vaW50ZXJvcFJlcXVpcmVEZWZhdWx0LmpzIjoxN31dLDE3OltmdW5jdGlvbihyZXF1aXJlLG1vZHVsZSxleHBvcnRzKXsKInVzZSBzdHJpY3QiOwoKZXhwb3J0cy5fX2VzTW9kdWxlID0gdHJ1ZTsKCmV4cG9ydHMuZGVmYXVsdCA9IGZ1bmN0aW9uIChvYmopIHsKICByZXR1cm4gb2JqICYmIG9iai5fX2VzTW9kdWxlID8gb2JqIDogewogICAgZGVmYXVsdDogb2JqCiAgfTsKfTsKfSx7fV0sMTg6W2Z1bmN0aW9uKHJlcXVpcmUsbW9kdWxlLGV4cG9ydHMpewoidXNlIHN0cmljdCI7Cgp2YXIgX3R5cGVvZiA9IHR5cGVvZiBfU3ltYm9sID09PSAiZnVuY3Rpb24iICYmIHR5cGVvZiBfU3ltYm9sJGl0ZXJhdG9yID09PSAic3ltYm9sIiA/IGZ1bmN0aW9uIChvYmopIHsgcmV0dXJuIHR5cGVvZiBvYmo7IH0gOiBmdW5jdGlvbiAob2JqKSB7IHJldHVybiBvYmogJiYgdHlwZW9mIF9TeW1ib2wgPT09ICJmdW5jdGlvbiIgJiYgb2JqLmNvbnN0cnVjdG9yID09PSBfU3ltYm9sID8gInN5bWJvbCIgOiB0eXBlb2Ygb2JqOyB9OwoKZXhwb3J0cy5fX2VzTW9kdWxlID0gdHJ1ZTsKCnZhciBfaXRlcmF0b3IgPSByZXF1aXJlKCIuLi9jb3JlLWpzL3N5bWJvbC9pdGVyYXRvciIpOwoKdmFyIF9pdGVyYXRvcjIgPSBfaW50ZXJvcFJlcXVpcmVEZWZhdWx0KF9pdGVyYXRvcik7Cgp2YXIgX3N5bWJvbCA9IHJlcXVpcmUoIi4uL2NvcmUtanMvc3ltYm9sIik7Cgp2YXIgX3N5bWJvbDIgPSBfaW50ZXJvcFJlcXVpcmVEZWZhdWx0KF9zeW1ib2wpOwoKZnVuY3Rpb24gX2ludGVyb3BSZXF1aXJlRGVmYXVsdChvYmopIHsgcmV0dXJuIG9iaiAmJiBvYmouX19lc01vZHVsZSA/IG9iaiA6IHsgZGVmYXVsdDogb2JqIH07IH0KCmV4cG9ydHMuZGVmYXVsdCA9IHR5cGVvZiBfc3ltYm9sMi5kZWZhdWx0ID09PSAiZnVuY3Rpb24iICYmIF90eXBlb2YoX2l0ZXJhdG9yMi5kZWZhdWx0KSA9PT0gInN5bWJvbCIgPyBmdW5jdGlvbiAob2JqKSB7CiAgcmV0dXJuIHR5cGVvZiBvYmogPT09ICJ1bmRlZmluZWQiID8gInVuZGVmaW5lZCIgOiBfdHlwZW9mKG9iaik7Cn0gOiBmdW5jdGlvbiAob2JqKSB7CiAgcmV0dXJuIG9iaiAmJiB0eXBlb2YgX3N5bWJvbDIuZGVmYXVsdCA9PT0gImZ1bmN0aW9uIiAmJiBvYmouY29uc3RydWN0b3IgPT09IF9zeW1ib2wyLmRlZmF1bHQgPyAic3ltYm9sIiA6IHR5cGVvZiBvYmogPT09ICJ1bmRlZmluZWQiID8gInVuZGVmaW5lZCIgOiBfdHlwZW9mKG9iaik7Cn07Cn0seyIuLi9jb3JlLWpzL3N5bWJvbCI6OCwiLi4vY29yZS1qcy9zeW1ib2wvaXRlcmF0b3IiOjl9XSwxOTpbZnVuY3Rpb24ocmVxdWlyZSxtb2R1bGUsZXhwb3J0cyl7CnZhciAkID0gcmVxdWlyZSgnLi4vLi4vbW9kdWxlcy8kJyk7Cm1vZHVsZS5leHBvcnRzID0gZnVuY3Rpb24gY3JlYXRlKFAsIEQpewogIHJldHVybiAkLmNyZWF0ZShQLCBEKTsKfTsKfSx7Ii4uLy4uL21vZHVsZXMvJCI6NTh9XSwyMDpbZnVuY3Rpb24ocmVxdWlyZSxtb2R1bGUsZXhwb3J0cyl7CnZhciAkID0gcmVxdWlyZSgnLi4vLi4vbW9kdWxlcy8kJyk7Cm1vZHVsZS5leHBvcnRzID0gZnVuY3Rpb24gZGVmaW5lUHJvcGVydHkoaXQsIGtleSwgZGVzYyl7CiAgcmV0dXJuICQuc2V0RGVzYyhpdCwga2V5LCBkZXNjKTsKfTsKfSx7Ii4uLy4uL21vZHVsZXMvJCI6NTh9XSwyMTpbZnVuY3Rpb24ocmVxdWlyZSxtb2R1bGUsZXhwb3J0cyl7CnZhciAkID0gcmVxdWlyZSgnLi4vLi4vbW9kdWxlcy8kJyk7CnJlcXVpcmUoJy4uLy4uL21vZHVsZXMvZXM2Lm9iamVjdC5nZXQtb3duLXByb3BlcnR5LWRlc2NyaXB0b3InKTsKbW9kdWxlLmV4cG9ydHMgPSBmdW5jdGlvbiBnZXRPd25Qcm9wZXJ0eURlc2NyaXB0b3IoaXQsIGtleSl7CiAgcmV0dXJuICQuZ2V0RGVzYyhpdCwga2V5KTsKfTsKfSx7Ii4uLy4uL21vZHVsZXMvJCI6NTgsIi4uLy4uL21vZHVsZXMvZXM2Lm9iamVjdC5nZXQtb3duLXByb3BlcnR5LWRlc2NyaXB0b3IiOjgzfV0sMjI6W2Z1bmN0aW9uKHJlcXVpcmUsbW9kdWxlLGV4cG9ydHMpewpyZXF1aXJlKCcuLi8uLi9tb2R1bGVzL2VzNi5vYmplY3QuZ2V0LXByb3RvdHlwZS1vZicpOwptb2R1bGUuZXhwb3J0cyA9IHJlcXVpcmUoJy4uLy4uL21vZHVsZXMvJC5jb3JlJykuT2JqZWN0LmdldFByb3RvdHlwZU9mOwp9LHsiLi4vLi4vbW9kdWxlcy8kLmNvcmUiOjMzLCIuLi8uLi9tb2R1bGVzL2VzNi5vYmplY3QuZ2V0LXByb3RvdHlwZS1vZiI6ODR9XSwyMzpbZnVuY3Rpb24ocmVxdWlyZSxtb2R1bGUsZXhwb3J0cyl7CnJlcXVpcmUoJy4uLy4uL21vZHVsZXMvZXM2Lm9iamVjdC5rZXlzJyk7Cm1vZHVsZS5leHBvcnRzID0gcmVxdWlyZSgnLi4vLi4vbW9kdWxlcy8kLmNvcmUnKS5PYmplY3Qua2V5czsKfSx7Ii4uLy4uL21vZHVsZXMvJC5jb3JlIjozMywiLi4vLi4vbW9kdWxlcy9lczYub2JqZWN0LmtleXMiOjg1fV0sMjQ6W2Z1bmN0aW9uKHJlcXVpcmUsbW9kdWxlLGV4cG9ydHMpewpyZXF1aXJlKCcuLi8uLi9tb2R1bGVzL2VzNi5vYmplY3Quc2V0LXByb3RvdHlwZS1vZicpOwptb2R1bGUuZXhwb3J0cyA9IHJlcXVpcmUoJy4uLy4uL21vZHVsZXMvJC5jb3JlJykuT2JqZWN0LnNldFByb3RvdHlwZU9mOwp9LHsiLi4vLi4vbW9kdWxlcy8kLmNvcmUiOjMzLCIuLi8uLi9tb2R1bGVzL2VzNi5vYmplY3Quc2V0LXByb3RvdHlwZS1vZiI6ODZ9XSwyNTpbZnVuY3Rpb24ocmVxdWlyZSxtb2R1bGUsZXhwb3J0cyl7CnJlcXVpcmUoJy4uL21vZHVsZXMvZXM2Lm9iamVjdC50by1zdHJpbmcnKTsKcmVxdWlyZSgnLi4vbW9kdWxlcy9lczYuc3RyaW5nLml0ZXJhdG9yJyk7CnJlcXVpcmUoJy4uL21vZHVsZXMvd2ViLmRvbS5pdGVyYWJsZScpOwpyZXF1aXJlKCcuLi9tb2R1bGVzL2VzNi5wcm9taXNlJyk7Cm1vZHVsZS5leHBvcnRzID0gcmVxdWlyZSgnLi4vbW9kdWxlcy8kLmNvcmUnKS5Qcm9taXNlOwp9LHsiLi4vbW9kdWxlcy8kLmNvcmUiOjMzLCIuLi9tb2R1bGVzL2VzNi5vYmplY3QudG8tc3RyaW5nIjo4NywiLi4vbW9kdWxlcy9lczYucHJvbWlzZSI6ODgsIi4uL21vZHVsZXMvZXM2LnN0cmluZy5pdGVyYXRvciI6ODksIi4uL21vZHVsZXMvd2ViLmRvbS5pdGVyYWJsZSI6OTF9XSwyNjpbZnVuY3Rpb24ocmVxdWlyZSxtb2R1bGUsZXhwb3J0cyl7CnJlcXVpcmUoJy4uLy4uL21vZHVsZXMvZXM2LnN5bWJvbCcpOwpyZXF1aXJlKCcuLi8uLi9tb2R1bGVzL2VzNi5vYmplY3QudG8tc3RyaW5nJyk7Cm1vZHVsZS5leHBvcnRzID0gcmVxdWlyZSgnLi4vLi4vbW9kdWxlcy8kLmNvcmUnKS5TeW1ib2w7Cn0seyIuLi8uLi9tb2R1bGVzLyQuY29yZSI6MzMsIi4uLy4uL21vZHVsZXMvZXM2Lm9iamVjdC50by1zdHJpbmciOjg3LCIuLi8uLi9tb2R1bGVzL2VzNi5zeW1ib2wiOjkwfV0sMjc6W2Z1bmN0aW9uKHJlcXVpcmUsbW9kdWxlLGV4cG9ydHMpewpyZXF1aXJlKCcuLi8uLi9tb2R1bGVzL2VzNi5zdHJpbmcuaXRlcmF0b3InKTsKcmVxdWlyZSgnLi4vLi4vbW9kdWxlcy93ZWIuZG9tLml0ZXJhYmxlJyk7Cm1vZHVsZS5leHBvcnRzID0gcmVxdWlyZSgnLi4vLi4vbW9kdWxlcy8kLndrcycpKCdpdGVyYXRvcicpOwp9LHsiLi4vLi4vbW9kdWxlcy8kLndrcyI6ODAsIi4uLy4uL21vZHVsZXMvZXM2LnN0cmluZy5pdGVyYXRvciI6ODksIi4uLy4uL21vZHVsZXMvd2ViLmRvbS5pdGVyYWJsZSI6OTF9XSwyODpbZnVuY3Rpb24ocmVxdWlyZSxtb2R1bGUsZXhwb3J0cyl7Cm1vZHVsZS5leHBvcnRzID0gZnVuY3Rpb24oaXQpewogIGlmKHR5cGVvZiBpdCAhPSAnZnVuY3Rpb24nKXRocm93IFR5cGVFcnJvcihpdCArICcgaXMgbm90IGEgZnVuY3Rpb24hJyk7CiAgcmV0dXJuIGl0Owp9Owp9LHt9XSwyOTpbZnVuY3Rpb24ocmVxdWlyZSxtb2R1bGUsZXhwb3J0cyl7Cm1vZHVsZS5leHBvcnRzID0gZnVuY3Rpb24oKXsgLyogZW1wdHkgKi8gfTsKfSx7fV0sMzA6W2Z1bmN0aW9uKHJlcXVpcmUsbW9kdWxlLGV4cG9ydHMpewp2YXIgaXNPYmplY3QgPSByZXF1aXJlKCcuLyQuaXMtb2JqZWN0Jyk7Cm1vZHVsZS5leHBvcnRzID0gZnVuY3Rpb24oaXQpewogIGlmKCFpc09iamVjdChpdCkpdGhyb3cgVHlwZUVycm9yKGl0ICsgJyBpcyBub3QgYW4gb2JqZWN0IScpOwogIHJldHVybiBpdDsKfTsKfSx7Ii4vJC5pcy1vYmplY3QiOjUxfV0sMzE6W2Z1bmN0aW9uKHJlcXVpcmUsbW9kdWxlLGV4cG9ydHMpewovLyBnZXR0aW5nIHRhZyBmcm9tIDE5LjEuMy42IE9iamVjdC5wcm90b3R5cGUudG9TdHJpbmcoKQp2YXIgY29mID0gcmVxdWlyZSgnLi8kLmNvZicpCiAgLCBUQUcgPSByZXF1aXJlKCcuLyQud2tzJykoJ3RvU3RyaW5nVGFnJykKICAvLyBFUzMgd3JvbmcgaGVyZQogICwgQVJHID0gY29mKGZ1bmN0aW9uKCl7IHJldHVybiBhcmd1bWVudHM7IH0oKSkgPT0gJ0FyZ3VtZW50cyc7Cgptb2R1bGUuZXhwb3J0cyA9IGZ1bmN0aW9uKGl0KXsKICB2YXIgTywgVCwgQjsKICByZXR1cm4gaXQgPT09IHVuZGVmaW5lZCA/ICdVbmRlZmluZWQnIDogaXQgPT09IG51bGwgPyAnTnVsbCcKICAgIC8vIEBAdG9TdHJpbmdUYWcgY2FzZQogICAgOiB0eXBlb2YgKFQgPSAoTyA9IE9iamVjdChpdCkpW1RBR10pID09ICdzdHJpbmcnID8gVAogICAgLy8gYnVpbHRpblRhZyBjYXNlCiAgICA6IEFSRyA/IGNvZihPKQogICAgLy8gRVMzIGFyZ3VtZW50cyBmYWxsYmFjawogICAgOiAoQiA9IGNvZihPKSkgPT0gJ09iamVjdCcgJiYgdHlwZW9mIE8uY2FsbGVlID09ICdmdW5jdGlvbicgPyAnQXJndW1lbnRzJyA6IEI7Cn07Cn0seyIuLyQuY29mIjozMiwiLi8kLndrcyI6ODB9XSwzMjpbZnVuY3Rpb24ocmVxdWlyZSxtb2R1bGUsZXhwb3J0cyl7CnZhciB0b1N0cmluZyA9IHt9LnRvU3RyaW5nOwoKbW9kdWxlLmV4cG9ydHMgPSBmdW5jdGlvbihpdCl7CiAgcmV0dXJuIHRvU3RyaW5nLmNhbGwoaXQpLnNsaWNlKDgsIC0xKTsKfTsKfSx7fV0sMzM6W2Z1bmN0aW9uKHJlcXVpcmUsbW9kdWxlLGV4cG9ydHMpewp2YXIgY29yZSA9IG1vZHVsZS5leHBvcnRzID0ge3ZlcnNpb246ICcxLjIuNid9OwppZih0eXBlb2YgX19lID09ICdudW1iZXInKV9fZSA9IGNvcmU7IC8vIGVzbGludC1kaXNhYmxlLWxpbmUgbm8tdW5kZWYKfSx7fV0sMzQ6W2Z1bmN0aW9uKHJlcXVpcmUsbW9kdWxlLGV4cG9ydHMpewovLyBvcHRpb25hbCAvIHNpbXBsZSBjb250ZXh0IGJpbmRpbmcKdmFyIGFGdW5jdGlvbiA9IHJlcXVpcmUoJy4vJC5hLWZ1bmN0aW9uJyk7Cm1vZHVsZS5leHBvcnRzID0gZnVuY3Rpb24oZm4sIHRoYXQsIGxlbmd0aCl7CiAgYUZ1bmN0aW9uKGZuKTsKICBpZih0aGF0ID09PSB1bmRlZmluZWQpcmV0dXJuIGZuOwogIHN3aXRjaChsZW5ndGgpewogICAgY2FzZSAxOiByZXR1cm4gZnVuY3Rpb24oYSl7CiAgICAgIHJldHVybiBmbi5jYWxsKHRoYXQsIGEpOwogICAgfTsKICAgIGNhc2UgMjogcmV0dXJuIGZ1bmN0aW9uKGEsIGIpewogICAgICByZXR1cm4gZm4uY2FsbCh0aGF0LCBhLCBiKTsKICAgIH07CiAgICBjYXNlIDM6IHJldHVybiBmdW5jdGlvbihhLCBiLCBjKXsKICAgICAgcmV0dXJuIGZuLmNhbGwodGhhdCwgYSwgYiwgYyk7CiAgICB9OwogIH0KICByZXR1cm4gZnVuY3Rpb24oLyogLi4uYXJncyAqLyl7CiAgICByZXR1cm4gZm4uYXBwbHkodGhhdCwgYXJndW1lbnRzKTsKICB9Owp9Owp9LHsiLi8kLmEtZnVuY3Rpb24iOjI4fV0sMzU6W2Z1bmN0aW9uKHJlcXVpcmUsbW9kdWxlLGV4cG9ydHMpewovLyA3LjIuMSBSZXF1aXJlT2JqZWN0Q29lcmNpYmxlKGFyZ3VtZW50KQptb2R1bGUuZXhwb3J0cyA9IGZ1bmN0aW9uKGl0KXsKICBpZihpdCA9PSB1bmRlZmluZWQpdGhyb3cgVHlwZUVycm9yKCJDYW4ndCBjYWxsIG1ldGhvZCBvbiAgIiArIGl0KTsKICByZXR1cm4gaXQ7Cn07Cn0se31dLDM2OltmdW5jdGlvbihyZXF1aXJlLG1vZHVsZSxleHBvcnRzKXsKLy8gVGhhbmsncyBJRTggZm9yIGhpcyBmdW5ueSBkZWZpbmVQcm9wZXJ0eQptb2R1bGUuZXhwb3J0cyA9ICFyZXF1aXJlKCcuLyQuZmFpbHMnKShmdW5jdGlvbigpewogIHJldHVybiBPYmplY3QuZGVmaW5lUHJvcGVydHkoe30sICdhJywge2dldDogZnVuY3Rpb24oKXsgcmV0dXJuIDc7IH19KS5hICE9IDc7Cn0pOwp9LHsiLi8kLmZhaWxzIjo0MH1dLDM3OltmdW5jdGlvbihyZXF1aXJlLG1vZHVsZSxleHBvcnRzKXsKdmFyIGlzT2JqZWN0ID0gcmVxdWlyZSgnLi8kLmlzLW9iamVjdCcpCiAgLCBkb2N1bWVudCA9IHJlcXVpcmUoJy4vJC5nbG9iYWwnKS5kb2N1bWVudAogIC8vIGluIG9sZCBJRSB0eXBlb2YgZG9jdW1lbnQuY3JlYXRlRWxlbWVudCBpcyAnb2JqZWN0JwogICwgaXMgPSBpc09iamVjdChkb2N1bWVudCkgJiYgaXNPYmplY3QoZG9jdW1lbnQuY3JlYXRlRWxlbWVudCk7Cm1vZHVsZS5leHBvcnRzID0gZnVuY3Rpb24oaXQpewogIHJldHVybiBpcyA/IGRvY3VtZW50LmNyZWF0ZUVsZW1lbnQoaXQpIDoge307Cn07Cn0seyIuLyQuZ2xvYmFsIjo0MywiLi8kLmlzLW9iamVjdCI6NTF9XSwzODpbZnVuY3Rpb24ocmVxdWlyZSxtb2R1bGUsZXhwb3J0cyl7Ci8vIGFsbCBlbnVtZXJhYmxlIG9iamVjdCBrZXlzLCBpbmNsdWRlcyBzeW1ib2xzCnZhciAkID0gcmVxdWlyZSgnLi8kJyk7Cm1vZHVsZS5leHBvcnRzID0gZnVuY3Rpb24oaXQpewogIHZhciBrZXlzICAgICAgID0gJC5nZXRLZXlzKGl0KQogICAgLCBnZXRTeW1ib2xzID0gJC5nZXRTeW1ib2xzOwogIGlmKGdldFN5bWJvbHMpewogICAgdmFyIHN5bWJvbHMgPSBnZXRTeW1ib2xzKGl0KQogICAgICAsIGlzRW51bSAgPSAkLmlzRW51bQogICAgICAsIGkgICAgICAgPSAwCiAgICAgICwga2V5OwogICAgd2hpbGUoc3ltYm9scy5sZW5ndGggPiBpKWlmKGlzRW51bS5jYWxsKGl0LCBrZXkgPSBzeW1ib2xzW2krK10pKWtleXMucHVzaChrZXkpOwogIH0KICByZXR1cm4ga2V5czsKfTsKfSx7Ii4vJCI6NTh9XSwzOTpbZnVuY3Rpb24ocmVxdWlyZSxtb2R1bGUsZXhwb3J0cyl7CnZhciBnbG9iYWwgICAgPSByZXF1aXJlKCcuLyQuZ2xvYmFsJykKICAsIGNvcmUgICAgICA9IHJlcXVpcmUoJy4vJC5jb3JlJykKICAsIGN0eCAgICAgICA9IHJlcXVpcmUoJy4vJC5jdHgnKQogICwgUFJPVE9UWVBFID0gJ3Byb3RvdHlwZSc7Cgp2YXIgJGV4cG9ydCA9IGZ1bmN0aW9uKHR5cGUsIG5hbWUsIHNvdXJjZSl7CiAgdmFyIElTX0ZPUkNFRCA9IHR5cGUgJiAkZXhwb3J0LkYKICAgICwgSVNfR0xPQkFMID0gdHlwZSAmICRleHBvcnQuRwogICAgLCBJU19TVEFUSUMgPSB0eXBlICYgJGV4cG9ydC5TCiAgICAsIElTX1BST1RPICA9IHR5cGUgJiAkZXhwb3J0LlAKICAgICwgSVNfQklORCAgID0gdHlwZSAmICRleHBvcnQuQgogICAgLCBJU19XUkFQICAgPSB0eXBlICYgJGV4cG9ydC5XCiAgICAsIGV4cG9ydHMgICA9IElTX0dMT0JBTCA/IGNvcmUgOiBjb3JlW25hbWVdIHx8IChjb3JlW25hbWVdID0ge30pCiAgICAsIHRhcmdldCAgICA9IElTX0dMT0JBTCA/IGdsb2JhbCA6IElTX1NUQVRJQyA/IGdsb2JhbFtuYW1lXSA6IChnbG9iYWxbbmFtZV0gfHwge30pW1BST1RPVFlQRV0KICAgICwga2V5LCBvd24sIG91dDsKICBpZihJU19HTE9CQUwpc291cmNlID0gbmFtZTsKICBmb3Ioa2V5IGluIHNvdXJjZSl7CiAgICAvLyBjb250YWlucyBpbiBuYXRpdmUKICAgIG93biA9ICFJU19GT1JDRUQgJiYgdGFyZ2V0ICYmIGtleSBpbiB0YXJnZXQ7CiAgICBpZihvd24gJiYga2V5IGluIGV4cG9ydHMpY29udGludWU7CiAgICAvLyBleHBvcnQgbmF0aXZlIG9yIHBhc3NlZAogICAgb3V0ID0gb3duID8gdGFyZ2V0W2tleV0gOiBzb3VyY2Vba2V5XTsKICAgIC8vIHByZXZlbnQgZ2xvYmFsIHBvbGx1dGlvbiBmb3IgbmFtZXNwYWNlcwogICAgZXhwb3J0c1trZXldID0gSVNfR0xPQkFMICYmIHR5cGVvZiB0YXJnZXRba2V5XSAhPSAnZnVuY3Rpb24nID8gc291cmNlW2tleV0KICAgIC8vIGJpbmQgdGltZXJzIHRvIGdsb2JhbCBmb3IgY2FsbCBmcm9tIGV4cG9ydCBjb250ZXh0CiAgICA6IElTX0JJTkQgJiYgb3duID8gY3R4KG91dCwgZ2xvYmFsKQogICAgLy8gd3JhcCBnbG9iYWwgY29uc3RydWN0b3JzIGZvciBwcmV2ZW50IGNoYW5nZSB0aGVtIGluIGxpYnJhcnkKICAgIDogSVNfV1JBUCAmJiB0YXJnZXRba2V5XSA9PSBvdXQgPyAoZnVuY3Rpb24oQyl7CiAgICAgIHZhciBGID0gZnVuY3Rpb24ocGFyYW0pewogICAgICAgIHJldHVybiB0aGlzIGluc3RhbmNlb2YgQyA/IG5ldyBDKHBhcmFtKSA6IEMocGFyYW0pOwogICAgICB9OwogICAgICBGW1BST1RPVFlQRV0gPSBDW1BST1RPVFlQRV07CiAgICAgIHJldHVybiBGOwogICAgLy8gbWFrZSBzdGF0aWMgdmVyc2lvbnMgZm9yIHByb3RvdHlwZSBtZXRob2RzCiAgICB9KShvdXQpIDogSVNfUFJPVE8gJiYgdHlwZW9mIG91dCA9PSAnZnVuY3Rpb24nID8gY3R4KEZ1bmN0aW9uLmNhbGwsIG91dCkgOiBvdXQ7CiAgICBpZihJU19QUk9UTykoZXhwb3J0c1tQUk9UT1RZUEVdIHx8IChleHBvcnRzW1BST1RPVFlQRV0gPSB7fSkpW2tleV0gPSBvdXQ7CiAgfQp9OwovLyB0eXBlIGJpdG1hcAokZXhwb3J0LkYgPSAxOyAgLy8gZm9yY2VkCiRleHBvcnQuRyA9IDI7ICAvLyBnbG9iYWwKJGV4cG9ydC5TID0gNDsgIC8vIHN0YXRpYwokZXhwb3J0LlAgPSA4OyAgLy8gcHJvdG8KJGV4cG9ydC5CID0gMTY7IC8vIGJpbmQKJGV4cG9ydC5XID0gMzI7IC8vIHdyYXAKbW9kdWxlLmV4cG9ydHMgPSAkZXhwb3J0Owp9LHsiLi8kLmNvcmUiOjMzLCIuLyQuY3R4IjozNCwiLi8kLmdsb2JhbCI6NDN9XSw0MDpbZnVuY3Rpb24ocmVxdWlyZSxtb2R1bGUsZXhwb3J0cyl7Cm1vZHVsZS5leHBvcnRzID0gZnVuY3Rpb24oZXhlYyl7CiAgdHJ5IHsKICAgIHJldHVybiAhIWV4ZWMoKTsKICB9IGNhdGNoKGUpewogICAgcmV0dXJuIHRydWU7CiAgfQp9Owp9LHt9XSw0MTpbZnVuY3Rpb24ocmVxdWlyZSxtb2R1bGUsZXhwb3J0cyl7CnZhciBjdHggICAgICAgICA9IHJlcXVpcmUoJy4vJC5jdHgnKQogICwgY2FsbCAgICAgICAgPSByZXF1aXJlKCcuLyQuaXRlci1jYWxsJykKICAsIGlzQXJyYXlJdGVyID0gcmVxdWlyZSgnLi8kLmlzLWFycmF5LWl0ZXInKQogICwgYW5PYmplY3QgICAgPSByZXF1aXJlKCcuLyQuYW4tb2JqZWN0JykKICAsIHRvTGVuZ3RoICAgID0gcmVxdWlyZSgnLi8kLnRvLWxlbmd0aCcpCiAgLCBnZXRJdGVyRm4gICA9IHJlcXVpcmUoJy4vY29yZS5nZXQtaXRlcmF0b3ItbWV0aG9kJyk7Cm1vZHVsZS5leHBvcnRzID0gZnVuY3Rpb24oaXRlcmFibGUsIGVudHJpZXMsIGZuLCB0aGF0KXsKICB2YXIgaXRlckZuID0gZ2V0SXRlckZuKGl0ZXJhYmxlKQogICAgLCBmICAgICAgPSBjdHgoZm4sIHRoYXQsIGVudHJpZXMgPyAyIDogMSkKICAgICwgaW5kZXggID0gMAogICAgLCBsZW5ndGgsIHN0ZXAsIGl0ZXJhdG9yOwogIGlmKHR5cGVvZiBpdGVyRm4gIT0gJ2Z1bmN0aW9uJyl0aHJvdyBUeXBlRXJyb3IoaXRlcmFibGUgKyAnIGlzIG5vdCBpdGVyYWJsZSEnKTsKICAvLyBmYXN0IGNhc2UgZm9yIGFycmF5cyB3aXRoIGRlZmF1bHQgaXRlcmF0b3IKICBpZihpc0FycmF5SXRlcihpdGVyRm4pKWZvcihsZW5ndGggPSB0b0xlbmd0aChpdGVyYWJsZS5sZW5ndGgpOyBsZW5ndGggPiBpbmRleDsgaW5kZXgrKyl7CiAgICBlbnRyaWVzID8gZihhbk9iamVjdChzdGVwID0gaXRlcmFibGVbaW5kZXhdKVswXSwgc3RlcFsxXSkgOiBmKGl0ZXJhYmxlW2luZGV4XSk7CiAgfSBlbHNlIGZvcihpdGVyYXRvciA9IGl0ZXJGbi5jYWxsKGl0ZXJhYmxlKTsgIShzdGVwID0gaXRlcmF0b3IubmV4dCgpKS5kb25lOyApewogICAgY2FsbChpdGVyYXRvciwgZiwgc3RlcC52YWx1ZSwgZW50cmllcyk7CiAgfQp9Owp9LHsiLi8kLmFuLW9iamVjdCI6MzAsIi4vJC5jdHgiOjM0LCIuLyQuaXMtYXJyYXktaXRlciI6NDksIi4vJC5pdGVyLWNhbGwiOjUyLCIuLyQudG8tbGVuZ3RoIjo3NywiLi9jb3JlLmdldC1pdGVyYXRvci1tZXRob2QiOjgxfV0sNDI6W2Z1bmN0aW9uKHJlcXVpcmUsbW9kdWxlLGV4cG9ydHMpewovLyBmYWxsYmFjayBmb3IgSUUxMSBidWdneSBPYmplY3QuZ2V0T3duUHJvcGVydHlOYW1lcyB3aXRoIGlmcmFtZSBhbmQgd2luZG93CnZhciB0b0lPYmplY3QgPSByZXF1aXJlKCcuLyQudG8taW9iamVjdCcpCiAgLCBnZXROYW1lcyAgPSByZXF1aXJlKCcuLyQnKS5nZXROYW1lcwogICwgdG9TdHJpbmcgID0ge30udG9TdHJpbmc7Cgp2YXIgd2luZG93TmFtZXMgPSB0eXBlb2Ygd2luZG93ID09ICdvYmplY3QnICYmIE9iamVjdC5nZXRPd25Qcm9wZXJ0eU5hbWVzCiAgPyBPYmplY3QuZ2V0T3duUHJvcGVydHlOYW1lcyh3aW5kb3cpIDogW107Cgp2YXIgZ2V0V2luZG93TmFtZXMgPSBmdW5jdGlvbihpdCl7CiAgdHJ5IHsKICAgIHJldHVybiBnZXROYW1lcyhpdCk7CiAgfSBjYXRjaChlKXsKICAgIHJldHVybiB3aW5kb3dOYW1lcy5zbGljZSgpOwogIH0KfTsKCm1vZHVsZS5leHBvcnRzLmdldCA9IGZ1bmN0aW9uIGdldE93blByb3BlcnR5TmFtZXMoaXQpewogIGlmKHdpbmRvd05hbWVzICYmIHRvU3RyaW5nLmNhbGwoaXQpID09ICdbb2JqZWN0IFdpbmRvd10nKXJldHVybiBnZXRXaW5kb3dOYW1lcyhpdCk7CiAgcmV0dXJuIGdldE5hbWVzKHRvSU9iamVjdChpdCkpOwp9Owp9LHsiLi8kIjo1OCwiLi8kLnRvLWlvYmplY3QiOjc2fV0sNDM6W2Z1bmN0aW9uKHJlcXVpcmUsbW9kdWxlLGV4cG9ydHMpewovLyBodHRwczovL2dpdGh1Yi5jb20vemxvaXJvY2svY29yZS1qcy9pc3N1ZXMvODYjaXNzdWVjb21tZW50LTExNTc1OTAyOAp2YXIgZ2xvYmFsID0gbW9kdWxlLmV4cG9ydHMgPSB0eXBlb2Ygd2luZG93ICE9ICd1bmRlZmluZWQnICYmIHdpbmRvdy5NYXRoID09IE1hdGgKICA/IHdpbmRvdyA6IHR5cGVvZiBzZWxmICE9ICd1bmRlZmluZWQnICYmIHNlbGYuTWF0aCA9PSBNYXRoID8gc2VsZiA6IEZ1bmN0aW9uKCdyZXR1cm4gdGhpcycpKCk7CmlmKHR5cGVvZiBfX2cgPT0gJ251bWJlcicpX19nID0gZ2xvYmFsOyAvLyBlc2xpbnQtZGlzYWJsZS1saW5lIG5vLXVuZGVmCn0se31dLDQ0OltmdW5jdGlvbihyZXF1aXJlLG1vZHVsZSxleHBvcnRzKXsKdmFyIGhhc093blByb3BlcnR5ID0ge30uaGFzT3duUHJvcGVydHk7Cm1vZHVsZS5leHBvcnRzID0gZnVuY3Rpb24oaXQsIGtleSl7CiAgcmV0dXJuIGhhc093blByb3BlcnR5LmNhbGwoaXQsIGtleSk7Cn07Cn0se31dLDQ1OltmdW5jdGlvbihyZXF1aXJlLG1vZHVsZSxleHBvcnRzKXsKdmFyICQgICAgICAgICAgPSByZXF1aXJlKCcuLyQnKQogICwgY3JlYXRlRGVzYyA9IHJlcXVpcmUoJy4vJC5wcm9wZXJ0eS1kZXNjJyk7Cm1vZHVsZS5leHBvcnRzID0gcmVxdWlyZSgnLi8kLmRlc2NyaXB0b3JzJykgPyBmdW5jdGlvbihvYmplY3QsIGtleSwgdmFsdWUpewogIHJldHVybiAkLnNldERlc2Mob2JqZWN0LCBrZXksIGNyZWF0ZURlc2MoMSwgdmFsdWUpKTsKfSA6IGZ1bmN0aW9uKG9iamVjdCwga2V5LCB2YWx1ZSl7CiAgb2JqZWN0W2tleV0gPSB2YWx1ZTsKICByZXR1cm4gb2JqZWN0Owp9Owp9LHsiLi8kIjo1OCwiLi8kLmRlc2NyaXB0b3JzIjozNiwiLi8kLnByb3BlcnR5LWRlc2MiOjYzfV0sNDY6W2Z1bmN0aW9uKHJlcXVpcmUsbW9kdWxlLGV4cG9ydHMpewptb2R1bGUuZXhwb3J0cyA9IHJlcXVpcmUoJy4vJC5nbG9iYWwnKS5kb2N1bWVudCAmJiBkb2N1bWVudC5kb2N1bWVudEVsZW1lbnQ7Cn0seyIuLyQuZ2xvYmFsIjo0M31dLDQ3OltmdW5jdGlvbihyZXF1aXJlLG1vZHVsZSxleHBvcnRzKXsKLy8gZmFzdCBhcHBseSwgaHR0cDovL2pzcGVyZi5sbmtpdC5jb20vZmFzdC1hcHBseS81Cm1vZHVsZS5leHBvcnRzID0gZnVuY3Rpb24oZm4sIGFyZ3MsIHRoYXQpewogIHZhciB1biA9IHRoYXQgPT09IHVuZGVmaW5lZDsKICBzd2l0Y2goYXJncy5sZW5ndGgpewogICAgY2FzZSAwOiByZXR1cm4gdW4gPyBmbigpCiAgICAgICAgICAgICAgICAgICAgICA6IGZuLmNhbGwodGhhdCk7CiAgICBjYXNlIDE6IHJldHVybiB1biA/IGZuKGFyZ3NbMF0pCiAgICAgICAgICAgICAgICAgICAgICA6IGZuLmNhbGwodGhhdCwgYXJnc1swXSk7CiAgICBjYXNlIDI6IHJldHVybiB1biA/IGZuKGFyZ3NbMF0sIGFyZ3NbMV0pCiAgICAgICAgICAgICAgICAgICAgICA6IGZuLmNhbGwodGhhdCwgYXJnc1swXSwgYXJnc1sxXSk7CiAgICBjYXNlIDM6IHJldHVybiB1biA/IGZuKGFyZ3NbMF0sIGFyZ3NbMV0sIGFyZ3NbMl0pCiAgICAgICAgICAgICAgICAgICAgICA6IGZuLmNhbGwodGhhdCwgYXJnc1swXSwgYXJnc1sxXSwgYXJnc1syXSk7CiAgICBjYXNlIDQ6IHJldHVybiB1biA/IGZuKGFyZ3NbMF0sIGFyZ3NbMV0sIGFyZ3NbMl0sIGFyZ3NbM10pCiAgICAgICAgICAgICAgICAgICAgICA6IGZuLmNhbGwodGhhdCwgYXJnc1swXSwgYXJnc1sxXSwgYXJnc1syXSwgYXJnc1szXSk7CiAgfSByZXR1cm4gICAgICAgICAgICAgIGZuLmFwcGx5KHRoYXQsIGFyZ3MpOwp9Owp9LHt9XSw0ODpbZnVuY3Rpb24ocmVxdWlyZSxtb2R1bGUsZXhwb3J0cyl7Ci8vIGZhbGxiYWNrIGZvciBub24tYXJyYXktbGlrZSBFUzMgYW5kIG5vbi1lbnVtZXJhYmxlIG9sZCBWOCBzdHJpbmdzCnZhciBjb2YgPSByZXF1aXJlKCcuLyQuY29mJyk7Cm1vZHVsZS5leHBvcnRzID0gT2JqZWN0KCd6JykucHJvcGVydHlJc0VudW1lcmFibGUoMCkgPyBPYmplY3QgOiBmdW5jdGlvbihpdCl7CiAgcmV0dXJuIGNvZihpdCkgPT0gJ1N0cmluZycgPyBpdC5zcGxpdCgnJykgOiBPYmplY3QoaXQpOwp9Owp9LHsiLi8kLmNvZiI6MzJ9XSw0OTpbZnVuY3Rpb24ocmVxdWlyZSxtb2R1bGUsZXhwb3J0cyl7Ci8vIGNoZWNrIG9uIGRlZmF1bHQgQXJyYXkgaXRlcmF0b3IKdmFyIEl0ZXJhdG9ycyAgPSByZXF1aXJlKCcuLyQuaXRlcmF0b3JzJykKICAsIElURVJBVE9SICAgPSByZXF1aXJlKCcuLyQud2tzJykoJ2l0ZXJhdG9yJykKICAsIEFycmF5UHJvdG8gPSBBcnJheS5wcm90b3R5cGU7Cgptb2R1bGUuZXhwb3J0cyA9IGZ1bmN0aW9uKGl0KXsKICByZXR1cm4gaXQgIT09IHVuZGVmaW5lZCAmJiAoSXRlcmF0b3JzLkFycmF5ID09PSBpdCB8fCBBcnJheVByb3RvW0lURVJBVE9SXSA9PT0gaXQpOwp9Owp9LHsiLi8kLml0ZXJhdG9ycyI6NTcsIi4vJC53a3MiOjgwfV0sNTA6W2Z1bmN0aW9uKHJlcXVpcmUsbW9kdWxlLGV4cG9ydHMpewovLyA3LjIuMiBJc0FycmF5KGFyZ3VtZW50KQp2YXIgY29mID0gcmVxdWlyZSgnLi8kLmNvZicpOwptb2R1bGUuZXhwb3J0cyA9IEFycmF5LmlzQXJyYXkgfHwgZnVuY3Rpb24oYXJnKXsKICByZXR1cm4gY29mKGFyZykgPT0gJ0FycmF5JzsKfTsKfSx7Ii4vJC5jb2YiOjMyfV0sNTE6W2Z1bmN0aW9uKHJlcXVpcmUsbW9kdWxlLGV4cG9ydHMpewptb2R1bGUuZXhwb3J0cyA9IGZ1bmN0aW9uKGl0KXsKICByZXR1cm4gdHlwZW9mIGl0ID09PSAnb2JqZWN0JyA/IGl0ICE9PSBudWxsIDogdHlwZW9mIGl0ID09PSAnZnVuY3Rpb24nOwp9Owp9LHt9XSw1MjpbZnVuY3Rpb24ocmVxdWlyZSxtb2R1bGUsZXhwb3J0cyl7Ci8vIGNhbGwgc29tZXRoaW5nIG9uIGl0ZXJhdG9yIHN0ZXAgd2l0aCBzYWZlIGNsb3Npbmcgb24gZXJyb3IKdmFyIGFuT2JqZWN0ID0gcmVxdWlyZSgnLi8kLmFuLW9iamVjdCcpOwptb2R1bGUuZXhwb3J0cyA9IGZ1bmN0aW9uKGl0ZXJhdG9yLCBmbiwgdmFsdWUsIGVudHJpZXMpewogIHRyeSB7CiAgICByZXR1cm4gZW50cmllcyA/IGZuKGFuT2JqZWN0KHZhbHVlKVswXSwgdmFsdWVbMV0pIDogZm4odmFsdWUpOwogIC8vIDcuNC42IEl0ZXJhdG9yQ2xvc2UoaXRlcmF0b3IsIGNvbXBsZXRpb24pCiAgfSBjYXRjaChlKXsKICAgIHZhciByZXQgPSBpdGVyYXRvclsncmV0dXJuJ107CiAgICBpZihyZXQgIT09IHVuZGVmaW5lZClhbk9iamVjdChyZXQuY2FsbChpdGVyYXRvcikpOwogICAgdGhyb3cgZTsKICB9Cn07Cn0seyIuLyQuYW4tb2JqZWN0IjozMH1dLDUzOltmdW5jdGlvbihyZXF1aXJlLG1vZHVsZSxleHBvcnRzKXsKJ3VzZSBzdHJpY3QnOwp2YXIgJCAgICAgICAgICAgICAgPSByZXF1aXJlKCcuLyQnKQogICwgZGVzY3JpcHRvciAgICAgPSByZXF1aXJlKCcuLyQucHJvcGVydHktZGVzYycpCiAgLCBzZXRUb1N0cmluZ1RhZyA9IHJlcXVpcmUoJy4vJC5zZXQtdG8tc3RyaW5nLXRhZycpCiAgLCBJdGVyYXRvclByb3RvdHlwZSA9IHt9OwoKLy8gMjUuMS4yLjEuMSAlSXRlcmF0b3JQcm90b3R5cGUlW0BAaXRlcmF0b3JdKCkKcmVxdWlyZSgnLi8kLmhpZGUnKShJdGVyYXRvclByb3RvdHlwZSwgcmVxdWlyZSgnLi8kLndrcycpKCdpdGVyYXRvcicpLCBmdW5jdGlvbigpeyByZXR1cm4gdGhpczsgfSk7Cgptb2R1bGUuZXhwb3J0cyA9IGZ1bmN0aW9uKENvbnN0cnVjdG9yLCBOQU1FLCBuZXh0KXsKICBDb25zdHJ1Y3Rvci5wcm90b3R5cGUgPSAkLmNyZWF0ZShJdGVyYXRvclByb3RvdHlwZSwge25leHQ6IGRlc2NyaXB0b3IoMSwgbmV4dCl9KTsKICBzZXRUb1N0cmluZ1RhZyhDb25zdHJ1Y3RvciwgTkFNRSArICcgSXRlcmF0b3InKTsKfTsKfSx7Ii4vJCI6NTgsIi4vJC5oaWRlIjo0NSwiLi8kLnByb3BlcnR5LWRlc2MiOjYzLCIuLyQuc2V0LXRvLXN0cmluZy10YWciOjY5LCIuLyQud2tzIjo4MH1dLDU0OltmdW5jdGlvbihyZXF1aXJlLG1vZHVsZSxleHBvcnRzKXsKJ3VzZSBzdHJpY3QnOwp2YXIgTElCUkFSWSAgICAgICAgPSByZXF1aXJlKCcuLyQubGlicmFyeScpCiAgLCAkZXhwb3J0ICAgICAgICA9IHJlcXVpcmUoJy4vJC5leHBvcnQnKQogICwgcmVkZWZpbmUgICAgICAgPSByZXF1aXJlKCcuLyQucmVkZWZpbmUnKQogICwgaGlkZSAgICAgICAgICAgPSByZXF1aXJlKCcuLyQuaGlkZScpCiAgLCBoYXMgICAgICAgICAgICA9IHJlcXVpcmUoJy4vJC5oYXMnKQogICwgSXRlcmF0b3JzICAgICAgPSByZXF1aXJlKCcuLyQuaXRlcmF0b3JzJykKICAsICRpdGVyQ3JlYXRlICAgID0gcmVxdWlyZSgnLi8kLml0ZXItY3JlYXRlJykKICAsIHNldFRvU3RyaW5nVGFnID0gcmVxdWlyZSgnLi8kLnNldC10by1zdHJpbmctdGFnJykKICAsIGdldFByb3RvICAgICAgID0gcmVxdWlyZSgnLi8kJykuZ2V0UHJvdG8KICAsIElURVJBVE9SICAgICAgID0gcmVxdWlyZSgnLi8kLndrcycpKCdpdGVyYXRvcicpCiAgLCBCVUdHWSAgICAgICAgICA9ICEoW10ua2V5cyAmJiAnbmV4dCcgaW4gW10ua2V5cygpKSAvLyBTYWZhcmkgaGFzIGJ1Z2d5IGl0ZXJhdG9ycyB3L28gYG5leHRgCiAgLCBGRl9JVEVSQVRPUiAgICA9ICdAQGl0ZXJhdG9yJwogICwgS0VZUyAgICAgICAgICAgPSAna2V5cycKICAsIFZBTFVFUyAgICAgICAgID0gJ3ZhbHVlcyc7Cgp2YXIgcmV0dXJuVGhpcyA9IGZ1bmN0aW9uKCl7IHJldHVybiB0aGlzOyB9OwoKbW9kdWxlLmV4cG9ydHMgPSBmdW5jdGlvbihCYXNlLCBOQU1FLCBDb25zdHJ1Y3RvciwgbmV4dCwgREVGQVVMVCwgSVNfU0VULCBGT1JDRUQpewogICRpdGVyQ3JlYXRlKENvbnN0cnVjdG9yLCBOQU1FLCBuZXh0KTsKICB2YXIgZ2V0TWV0aG9kID0gZnVuY3Rpb24oa2luZCl7CiAgICBpZighQlVHR1kgJiYga2luZCBpbiBwcm90bylyZXR1cm4gcHJvdG9ba2luZF07CiAgICBzd2l0Y2goa2luZCl7CiAgICAgIGNhc2UgS0VZUzogcmV0dXJuIGZ1bmN0aW9uIGtleXMoKXsgcmV0dXJuIG5ldyBDb25zdHJ1Y3Rvcih0aGlzLCBraW5kKTsgfTsKICAgICAgY2FzZSBWQUxVRVM6IHJldHVybiBmdW5jdGlvbiB2YWx1ZXMoKXsgcmV0dXJuIG5ldyBDb25zdHJ1Y3Rvcih0aGlzLCBraW5kKTsgfTsKICAgIH0gcmV0dXJuIGZ1bmN0aW9uIGVudHJpZXMoKXsgcmV0dXJuIG5ldyBDb25zdHJ1Y3Rvcih0aGlzLCBraW5kKTsgfTsKICB9OwogIHZhciBUQUcgICAgICAgID0gTkFNRSArICcgSXRlcmF0b3InCiAgICAsIERFRl9WQUxVRVMgPSBERUZBVUxUID09IFZBTFVFUwogICAgLCBWQUxVRVNfQlVHID0gZmFsc2UKICAgICwgcHJvdG8gICAgICA9IEJhc2UucHJvdG90eXBlCiAgICAsICRuYXRpdmUgICAgPSBwcm90b1tJVEVSQVRPUl0gfHwgcHJvdG9bRkZfSVRFUkFUT1JdIHx8IERFRkFVTFQgJiYgcHJvdG9bREVGQVVMVF0KICAgICwgJGRlZmF1bHQgICA9ICRuYXRpdmUgfHwgZ2V0TWV0aG9kKERFRkFVTFQpCiAgICAsIG1ldGhvZHMsIGtleTsKICAvLyBGaXggbmF0aXZlCiAgaWYoJG5hdGl2ZSl7CiAgICB2YXIgSXRlcmF0b3JQcm90b3R5cGUgPSBnZXRQcm90bygkZGVmYXVsdC5jYWxsKG5ldyBCYXNlKSk7CiAgICAvLyBTZXQgQEB0b1N0cmluZ1RhZyB0byBuYXRpdmUgaXRlcmF0b3JzCiAgICBzZXRUb1N0cmluZ1RhZyhJdGVyYXRvclByb3RvdHlwZSwgVEFHLCB0cnVlKTsKICAgIC8vIEZGIGZpeAogICAgaWYoIUxJQlJBUlkgJiYgaGFzKHByb3RvLCBGRl9JVEVSQVRPUikpaGlkZShJdGVyYXRvclByb3RvdHlwZSwgSVRFUkFUT1IsIHJldHVyblRoaXMpOwogICAgLy8gZml4IEFycmF5I3t2YWx1ZXMsIEBAaXRlcmF0b3J9Lm5hbWUgaW4gVjggLyBGRgogICAgaWYoREVGX1ZBTFVFUyAmJiAkbmF0aXZlLm5hbWUgIT09IFZBTFVFUyl7CiAgICAgIFZBTFVFU19CVUcgPSB0cnVlOwogICAgICAkZGVmYXVsdCA9IGZ1bmN0aW9uIHZhbHVlcygpeyByZXR1cm4gJG5hdGl2ZS5jYWxsKHRoaXMpOyB9OwogICAgfQogIH0KICAvLyBEZWZpbmUgaXRlcmF0b3IKICBpZigoIUxJQlJBUlkgfHwgRk9SQ0VEKSAmJiAoQlVHR1kgfHwgVkFMVUVTX0JVRyB8fCAhcHJvdG9bSVRFUkFUT1JdKSl7CiAgICBoaWRlKHByb3RvLCBJVEVSQVRPUiwgJGRlZmF1bHQpOwogIH0KICAvLyBQbHVnIGZvciBsaWJyYXJ5CiAgSXRlcmF0b3JzW05BTUVdID0gJGRlZmF1bHQ7CiAgSXRlcmF0b3JzW1RBR10gID0gcmV0dXJuVGhpczsKICBpZihERUZBVUxUKXsKICAgIG1ldGhvZHMgPSB7CiAgICAgIHZhbHVlczogIERFRl9WQUxVRVMgID8gJGRlZmF1bHQgOiBnZXRNZXRob2QoVkFMVUVTKSwKICAgICAga2V5czogICAgSVNfU0VUICAgICAgPyAkZGVmYXVsdCA6IGdldE1ldGhvZChLRVlTKSwKICAgICAgZW50cmllczogIURFRl9WQUxVRVMgPyAkZGVmYXVsdCA6IGdldE1ldGhvZCgnZW50cmllcycpCiAgICB9OwogICAgaWYoRk9SQ0VEKWZvcihrZXkgaW4gbWV0aG9kcyl7CiAgICAgIGlmKCEoa2V5IGluIHByb3RvKSlyZWRlZmluZShwcm90bywga2V5LCBtZXRob2RzW2tleV0pOwogICAgfSBlbHNlICRleHBvcnQoJGV4cG9ydC5QICsgJGV4cG9ydC5GICogKEJVR0dZIHx8IFZBTFVFU19CVUcpLCBOQU1FLCBtZXRob2RzKTsKICB9CiAgcmV0dXJuIG1ldGhvZHM7Cn07Cn0seyIuLyQiOjU4LCIuLyQuZXhwb3J0IjozOSwiLi8kLmhhcyI6NDQsIi4vJC5oaWRlIjo0NSwiLi8kLml0ZXItY3JlYXRlIjo1MywiLi8kLml0ZXJhdG9ycyI6NTcsIi4vJC5saWJyYXJ5Ijo2MCwiLi8kLnJlZGVmaW5lIjo2NSwiLi8kLnNldC10by1zdHJpbmctdGFnIjo2OSwiLi8kLndrcyI6ODB9XSw1NTpbZnVuY3Rpb24ocmVxdWlyZSxtb2R1bGUsZXhwb3J0cyl7CnZhciBJVEVSQVRPUiAgICAgPSByZXF1aXJlKCcuLyQud2tzJykoJ2l0ZXJhdG9yJykKICAsIFNBRkVfQ0xPU0lORyA9IGZhbHNlOwoKdHJ5IHsKICB2YXIgcml0ZXIgPSBbN11bSVRFUkFUT1JdKCk7CiAgcml0ZXJbJ3JldHVybiddID0gZnVuY3Rpb24oKXsgU0FGRV9DTE9TSU5HID0gdHJ1ZTsgfTsKICBBcnJheS5mcm9tKHJpdGVyLCBmdW5jdGlvbigpeyB0aHJvdyAyOyB9KTsKfSBjYXRjaChlKXsgLyogZW1wdHkgKi8gfQoKbW9kdWxlLmV4cG9ydHMgPSBmdW5jdGlvbihleGVjLCBza2lwQ2xvc2luZyl7CiAgaWYoIXNraXBDbG9zaW5nICYmICFTQUZFX0NMT1NJTkcpcmV0dXJuIGZhbHNlOwogIHZhciBzYWZlID0gZmFsc2U7CiAgdHJ5IHsKICAgIHZhciBhcnIgID0gWzddCiAgICAgICwgaXRlciA9IGFycltJVEVSQVRPUl0oKTsKICAgIGl0ZXIubmV4dCA9IGZ1bmN0aW9uKCl7IHNhZmUgPSB0cnVlOyB9OwogICAgYXJyW0lURVJBVE9SXSA9IGZ1bmN0aW9uKCl7IHJldHVybiBpdGVyOyB9OwogICAgZXhlYyhhcnIpOwogIH0gY2F0Y2goZSl7IC8qIGVtcHR5ICovIH0KICByZXR1cm4gc2FmZTsKfTsKfSx7Ii4vJC53a3MiOjgwfV0sNTY6W2Z1bmN0aW9uKHJlcXVpcmUsbW9kdWxlLGV4cG9ydHMpewptb2R1bGUuZXhwb3J0cyA9IGZ1bmN0aW9uKGRvbmUsIHZhbHVlKXsKICByZXR1cm4ge3ZhbHVlOiB2YWx1ZSwgZG9uZTogISFkb25lfTsKfTsKfSx7fV0sNTc6W2Z1bmN0aW9uKHJlcXVpcmUsbW9kdWxlLGV4cG9ydHMpewptb2R1bGUuZXhwb3J0cyA9IHt9Owp9LHt9XSw1ODpbZnVuY3Rpb24ocmVxdWlyZSxtb2R1bGUsZXhwb3J0cyl7CnZhciAkT2JqZWN0ID0gT2JqZWN0Owptb2R1bGUuZXhwb3J0cyA9IHsKICBjcmVhdGU6ICAgICAkT2JqZWN0LmNyZWF0ZSwKICBnZXRQcm90bzogICAkT2JqZWN0LmdldFByb3RvdHlwZU9mLAogIGlzRW51bTogICAgIHt9LnByb3BlcnR5SXNFbnVtZXJhYmxlLAogIGdldERlc2M6ICAgICRPYmplY3QuZ2V0T3duUHJvcGVydHlEZXNjcmlwdG9yLAogIHNldERlc2M6ICAgICRPYmplY3QuZGVmaW5lUHJvcGVydHksCiAgc2V0RGVzY3M6ICAgJE9iamVjdC5kZWZpbmVQcm9wZXJ0aWVzLAogIGdldEtleXM6ICAgICRPYmplY3Qua2V5cywKICBnZXROYW1lczogICAkT2JqZWN0LmdldE93blByb3BlcnR5TmFtZXMsCiAgZ2V0U3ltYm9sczogJE9iamVjdC5nZXRPd25Qcm9wZXJ0eVN5bWJvbHMsCiAgZWFjaDogICAgICAgW10uZm9yRWFjaAp9Owp9LHt9XSw1OTpbZnVuY3Rpb24ocmVxdWlyZSxtb2R1bGUsZXhwb3J0cyl7CnZhciAkICAgICAgICAgPSByZXF1aXJlKCcuLyQnKQogICwgdG9JT2JqZWN0ID0gcmVxdWlyZSgnLi8kLnRvLWlvYmplY3QnKTsKbW9kdWxlLmV4cG9ydHMgPSBmdW5jdGlvbihvYmplY3QsIGVsKXsKICB2YXIgTyAgICAgID0gdG9JT2JqZWN0KG9iamVjdCkKICAgICwga2V5cyAgID0gJC5nZXRLZXlzKE8pCiAgICAsIGxlbmd0aCA9IGtleXMubGVuZ3RoCiAgICAsIGluZGV4ICA9IDAKICAgICwga2V5OwogIHdoaWxlKGxlbmd0aCA+IGluZGV4KWlmKE9ba2V5ID0ga2V5c1tpbmRleCsrXV0gPT09IGVsKXJldHVybiBrZXk7Cn07Cn0seyIuLyQiOjU4LCIuLyQudG8taW9iamVjdCI6NzZ9XSw2MDpbZnVuY3Rpb24ocmVxdWlyZSxtb2R1bGUsZXhwb3J0cyl7Cm1vZHVsZS5leHBvcnRzID0gdHJ1ZTsKfSx7fV0sNjE6W2Z1bmN0aW9uKHJlcXVpcmUsbW9kdWxlLGV4cG9ydHMpewp2YXIgZ2xvYmFsICAgID0gcmVxdWlyZSgnLi8kLmdsb2JhbCcpCiAgLCBtYWNyb3Rhc2sgPSByZXF1aXJlKCcuLyQudGFzaycpLnNldAogICwgT2JzZXJ2ZXIgID0gZ2xvYmFsLk11dGF0aW9uT2JzZXJ2ZXIgfHwgZ2xvYmFsLldlYktpdE11dGF0aW9uT2JzZXJ2ZXIKICAsIHByb2Nlc3MgICA9IGdsb2JhbC5wcm9jZXNzCiAgLCBQcm9taXNlICAgPSBnbG9iYWwuUHJvbWlzZQogICwgaXNOb2RlICAgID0gcmVxdWlyZSgnLi8kLmNvZicpKHByb2Nlc3MpID09ICdwcm9jZXNzJwogICwgaGVhZCwgbGFzdCwgbm90aWZ5OwoKdmFyIGZsdXNoID0gZnVuY3Rpb24oKXsKICB2YXIgcGFyZW50LCBkb21haW4sIGZuOwogIGlmKGlzTm9kZSAmJiAocGFyZW50ID0gcHJvY2Vzcy5kb21haW4pKXsKICAgIHByb2Nlc3MuZG9tYWluID0gbnVsbDsKICAgIHBhcmVudC5leGl0KCk7CiAgfQogIHdoaWxlKGhlYWQpewogICAgZG9tYWluID0gaGVhZC5kb21haW47CiAgICBmbiAgICAgPSBoZWFkLmZuOwogICAgaWYoZG9tYWluKWRvbWFpbi5lbnRlcigpOwogICAgZm4oKTsgLy8gPC0gY3VycmVudGx5IHdlIHVzZSBpdCBvbmx5IGZvciBQcm9taXNlIC0gdHJ5IC8gY2F0Y2ggbm90IHJlcXVpcmVkCiAgICBpZihkb21haW4pZG9tYWluLmV4aXQoKTsKICAgIGhlYWQgPSBoZWFkLm5leHQ7CiAgfSBsYXN0ID0gdW5kZWZpbmVkOwogIGlmKHBhcmVudClwYXJlbnQuZW50ZXIoKTsKfTsKCi8vIE5vZGUuanMKaWYoaXNOb2RlKXsKICBub3RpZnkgPSBmdW5jdGlvbigpewogICAgcHJvY2Vzcy5uZXh0VGljayhmbHVzaCk7CiAgfTsKLy8gYnJvd3NlcnMgd2l0aCBNdXRhdGlvbk9ic2VydmVyCn0gZWxzZSBpZihPYnNlcnZlcil7CiAgdmFyIHRvZ2dsZSA9IDEKICAgICwgbm9kZSAgID0gZG9jdW1lbnQuY3JlYXRlVGV4dE5vZGUoJycpOwogIG5ldyBPYnNlcnZlcihmbHVzaCkub2JzZXJ2ZShub2RlLCB7Y2hhcmFjdGVyRGF0YTogdHJ1ZX0pOyAvLyBlc2xpbnQtZGlzYWJsZS1saW5lIG5vLW5ldwogIG5vdGlmeSA9IGZ1bmN0aW9uKCl7CiAgICBub2RlLmRhdGEgPSB0b2dnbGUgPSAtdG9nZ2xlOwogIH07Ci8vIGVudmlyb25tZW50cyB3aXRoIG1heWJlIG5vbi1jb21wbGV0ZWx5IGNvcnJlY3QsIGJ1dCBleGlzdGVudCBQcm9taXNlCn0gZWxzZSBpZihQcm9taXNlICYmIFByb21pc2UucmVzb2x2ZSl7CiAgbm90aWZ5ID0gZnVuY3Rpb24oKXsKICAgIFByb21pc2UucmVzb2x2ZSgpLnRoZW4oZmx1c2gpOwogIH07Ci8vIGZvciBvdGhlciBlbnZpcm9ubWVudHMgLSBtYWNyb3Rhc2sgYmFzZWQgb246Ci8vIC0gc2V0SW1tZWRpYXRlCi8vIC0gTWVzc2FnZUNoYW5uZWwKLy8gLSB3aW5kb3cucG9zdE1lc3NhZwovLyAtIG9ucmVhZHlzdGF0ZWNoYW5nZQovLyAtIHNldFRpbWVvdXQKfSBlbHNlIHsKICBub3RpZnkgPSBmdW5jdGlvbigpewogICAgLy8gc3RyYW5nZSBJRSArIHdlYnBhY2sgZGV2IHNlcnZlciBidWcgLSB1c2UgLmNhbGwoZ2xvYmFsKQogICAgbWFjcm90YXNrLmNhbGwoZ2xvYmFsLCBmbHVzaCk7CiAgfTsKfQoKbW9kdWxlLmV4cG9ydHMgPSBmdW5jdGlvbiBhc2FwKGZuKXsKICB2YXIgdGFzayA9IHtmbjogZm4sIG5leHQ6IHVuZGVmaW5lZCwgZG9tYWluOiBpc05vZGUgJiYgcHJvY2Vzcy5kb21haW59OwogIGlmKGxhc3QpbGFzdC5uZXh0ID0gdGFzazsKICBpZighaGVhZCl7CiAgICBoZWFkID0gdGFzazsKICAgIG5vdGlmeSgpOwogIH0gbGFzdCA9IHRhc2s7Cn07Cn0seyIuLyQuY29mIjozMiwiLi8kLmdsb2JhbCI6NDMsIi4vJC50YXNrIjo3NH1dLDYyOltmdW5jdGlvbihyZXF1aXJlLG1vZHVsZSxleHBvcnRzKXsKLy8gbW9zdCBPYmplY3QgbWV0aG9kcyBieSBFUzYgc2hvdWxkIGFjY2VwdCBwcmltaXRpdmVzCnZhciAkZXhwb3J0ID0gcmVxdWlyZSgnLi8kLmV4cG9ydCcpCiAgLCBjb3JlICAgID0gcmVxdWlyZSgnLi8kLmNvcmUnKQogICwgZmFpbHMgICA9IHJlcXVpcmUoJy4vJC5mYWlscycpOwptb2R1bGUuZXhwb3J0cyA9IGZ1bmN0aW9uKEtFWSwgZXhlYyl7CiAgdmFyIGZuICA9IChjb3JlLk9iamVjdCB8fCB7fSlbS0VZXSB8fCBPYmplY3RbS0VZXQogICAgLCBleHAgPSB7fTsKICBleHBbS0VZXSA9IGV4ZWMoZm4pOwogICRleHBvcnQoJGV4cG9ydC5TICsgJGV4cG9ydC5GICogZmFpbHMoZnVuY3Rpb24oKXsgZm4oMSk7IH0pLCAnT2JqZWN0JywgZXhwKTsKfTsKfSx7Ii4vJC5jb3JlIjozMywiLi8kLmV4cG9ydCI6MzksIi4vJC5mYWlscyI6NDB9XSw2MzpbZnVuY3Rpb24ocmVxdWlyZSxtb2R1bGUsZXhwb3J0cyl7Cm1vZHVsZS5leHBvcnRzID0gZnVuY3Rpb24oYml0bWFwLCB2YWx1ZSl7CiAgcmV0dXJuIHsKICAgIGVudW1lcmFibGUgIDogIShiaXRtYXAgJiAxKSwKICAgIGNvbmZpZ3VyYWJsZTogIShiaXRtYXAgJiAyKSwKICAgIHdyaXRhYmxlICAgIDogIShiaXRtYXAgJiA0KSwKICAgIHZhbHVlICAgICAgIDogdmFsdWUKICB9Owp9Owp9LHt9XSw2NDpbZnVuY3Rpb24ocmVxdWlyZSxtb2R1bGUsZXhwb3J0cyl7CnZhciByZWRlZmluZSA9IHJlcXVpcmUoJy4vJC5yZWRlZmluZScpOwptb2R1bGUuZXhwb3J0cyA9IGZ1bmN0aW9uKHRhcmdldCwgc3JjKXsKICBmb3IodmFyIGtleSBpbiBzcmMpcmVkZWZpbmUodGFyZ2V0LCBrZXksIHNyY1trZXldKTsKICByZXR1cm4gdGFyZ2V0Owp9Owp9LHsiLi8kLnJlZGVmaW5lIjo2NX1dLDY1OltmdW5jdGlvbihyZXF1aXJlLG1vZHVsZSxleHBvcnRzKXsKbW9kdWxlLmV4cG9ydHMgPSByZXF1aXJlKCcuLyQuaGlkZScpOwp9LHsiLi8kLmhpZGUiOjQ1fV0sNjY6W2Z1bmN0aW9uKHJlcXVpcmUsbW9kdWxlLGV4cG9ydHMpewovLyA3LjIuOSBTYW1lVmFsdWUoeCwgeSkKbW9kdWxlLmV4cG9ydHMgPSBPYmplY3QuaXMgfHwgZnVuY3Rpb24gaXMoeCwgeSl7CiAgcmV0dXJuIHggPT09IHkgPyB4ICE9PSAwIHx8IDEgLyB4ID09PSAxIC8geSA6IHggIT0geCAmJiB5ICE9IHk7Cn07Cn0se31dLDY3OltmdW5jdGlvbihyZXF1aXJlLG1vZHVsZSxleHBvcnRzKXsKLy8gV29ya3Mgd2l0aCBfX3Byb3RvX18gb25seS4gT2xkIHY4IGNhbid0IHdvcmsgd2l0aCBudWxsIHByb3RvIG9iamVjdHMuCi8qIGVzbGludC1kaXNhYmxlIG5vLXByb3RvICovCnZhciBnZXREZXNjICA9IHJlcXVpcmUoJy4vJCcpLmdldERlc2MKICAsIGlzT2JqZWN0ID0gcmVxdWlyZSgnLi8kLmlzLW9iamVjdCcpCiAgLCBhbk9iamVjdCA9IHJlcXVpcmUoJy4vJC5hbi1vYmplY3QnKTsKdmFyIGNoZWNrID0gZnVuY3Rpb24oTywgcHJvdG8pewogIGFuT2JqZWN0KE8pOwogIGlmKCFpc09iamVjdChwcm90bykgJiYgcHJvdG8gIT09IG51bGwpdGhyb3cgVHlwZUVycm9yKHByb3RvICsgIjogY2FuJ3Qgc2V0IGFzIHByb3RvdHlwZSEiKTsKfTsKbW9kdWxlLmV4cG9ydHMgPSB7CiAgc2V0OiBPYmplY3Quc2V0UHJvdG90eXBlT2YgfHwgKCdfX3Byb3RvX18nIGluIHt9ID8gLy8gZXNsaW50LWRpc2FibGUtbGluZQogICAgZnVuY3Rpb24odGVzdCwgYnVnZ3ksIHNldCl7CiAgICAgIHRyeSB7CiAgICAgICAgc2V0ID0gcmVxdWlyZSgnLi8kLmN0eCcpKEZ1bmN0aW9uLmNhbGwsIGdldERlc2MoT2JqZWN0LnByb3RvdHlwZSwgJ19fcHJvdG9fXycpLnNldCwgMik7CiAgICAgICAgc2V0KHRlc3QsIFtdKTsKICAgICAgICBidWdneSA9ICEodGVzdCBpbnN0YW5jZW9mIEFycmF5KTsKICAgICAgfSBjYXRjaChlKXsgYnVnZ3kgPSB0cnVlOyB9CiAgICAgIHJldHVybiBmdW5jdGlvbiBzZXRQcm90b3R5cGVPZihPLCBwcm90byl7CiAgICAgICAgY2hlY2soTywgcHJvdG8pOwogICAgICAgIGlmKGJ1Z2d5KU8uX19wcm90b19fID0gcHJvdG87CiAgICAgICAgZWxzZSBzZXQoTywgcHJvdG8pOwogICAgICAgIHJldHVybiBPOwogICAgICB9OwogICAgfSh7fSwgZmFsc2UpIDogdW5kZWZpbmVkKSwKICBjaGVjazogY2hlY2sKfTsKfSx7Ii4vJCI6NTgsIi4vJC5hbi1vYmplY3QiOjMwLCIuLyQuY3R4IjozNCwiLi8kLmlzLW9iamVjdCI6NTF9XSw2ODpbZnVuY3Rpb24ocmVxdWlyZSxtb2R1bGUsZXhwb3J0cyl7Cid1c2Ugc3RyaWN0JzsKdmFyIGNvcmUgICAgICAgID0gcmVxdWlyZSgnLi8kLmNvcmUnKQogICwgJCAgICAgICAgICAgPSByZXF1aXJlKCcuLyQnKQogICwgREVTQ1JJUFRPUlMgPSByZXF1aXJlKCcuLyQuZGVzY3JpcHRvcnMnKQogICwgU1BFQ0lFUyAgICAgPSByZXF1aXJlKCcuLyQud2tzJykoJ3NwZWNpZXMnKTsKCm1vZHVsZS5leHBvcnRzID0gZnVuY3Rpb24oS0VZKXsKICB2YXIgQyA9IGNvcmVbS0VZXTsKICBpZihERVNDUklQVE9SUyAmJiBDICYmICFDW1NQRUNJRVNdKSQuc2V0RGVzYyhDLCBTUEVDSUVTLCB7CiAgICBjb25maWd1cmFibGU6IHRydWUsCiAgICBnZXQ6IGZ1bmN0aW9uKCl7IHJldHVybiB0aGlzOyB9CiAgfSk7Cn07Cn0seyIuLyQiOjU4LCIuLyQuY29yZSI6MzMsIi4vJC5kZXNjcmlwdG9ycyI6MzYsIi4vJC53a3MiOjgwfV0sNjk6W2Z1bmN0aW9uKHJlcXVpcmUsbW9kdWxlLGV4cG9ydHMpewp2YXIgZGVmID0gcmVxdWlyZSgnLi8kJykuc2V0RGVzYwogICwgaGFzID0gcmVxdWlyZSgnLi8kLmhhcycpCiAgLCBUQUcgPSByZXF1aXJlKCcuLyQud2tzJykoJ3RvU3RyaW5nVGFnJyk7Cgptb2R1bGUuZXhwb3J0cyA9IGZ1bmN0aW9uKGl0LCB0YWcsIHN0YXQpewogIGlmKGl0ICYmICFoYXMoaXQgPSBzdGF0ID8gaXQgOiBpdC5wcm90b3R5cGUsIFRBRykpZGVmKGl0LCBUQUcsIHtjb25maWd1cmFibGU6IHRydWUsIHZhbHVlOiB0YWd9KTsKfTsKfSx7Ii4vJCI6NTgsIi4vJC5oYXMiOjQ0LCIuLyQud2tzIjo4MH1dLDcwOltmdW5jdGlvbihyZXF1aXJlLG1vZHVsZSxleHBvcnRzKXsKdmFyIGdsb2JhbCA9IHJlcXVpcmUoJy4vJC5nbG9iYWwnKQogICwgU0hBUkVEID0gJ19fY29yZS1qc19zaGFyZWRfXycKICAsIHN0b3JlICA9IGdsb2JhbFtTSEFSRURdIHx8IChnbG9iYWxbU0hBUkVEXSA9IHt9KTsKbW9kdWxlLmV4cG9ydHMgPSBmdW5jdGlvbihrZXkpewogIHJldHVybiBzdG9yZVtrZXldIHx8IChzdG9yZVtrZXldID0ge30pOwp9Owp9LHsiLi8kLmdsb2JhbCI6NDN9XSw3MTpbZnVuY3Rpb24ocmVxdWlyZSxtb2R1bGUsZXhwb3J0cyl7Ci8vIDcuMy4yMCBTcGVjaWVzQ29uc3RydWN0b3IoTywgZGVmYXVsdENvbnN0cnVjdG9yKQp2YXIgYW5PYmplY3QgID0gcmVxdWlyZSgnLi8kLmFuLW9iamVjdCcpCiAgLCBhRnVuY3Rpb24gPSByZXF1aXJlKCcuLyQuYS1mdW5jdGlvbicpCiAgLCBTUEVDSUVTICAgPSByZXF1aXJlKCcuLyQud2tzJykoJ3NwZWNpZXMnKTsKbW9kdWxlLmV4cG9ydHMgPSBmdW5jdGlvbihPLCBEKXsKICB2YXIgQyA9IGFuT2JqZWN0KE8pLmNvbnN0cnVjdG9yLCBTOwogIHJldHVybiBDID09PSB1bmRlZmluZWQgfHwgKFMgPSBhbk9iamVjdChDKVtTUEVDSUVTXSkgPT0gdW5kZWZpbmVkID8gRCA6IGFGdW5jdGlvbihTKTsKfTsKfSx7Ii4vJC5hLWZ1bmN0aW9uIjoyOCwiLi8kLmFuLW9iamVjdCI6MzAsIi4vJC53a3MiOjgwfV0sNzI6W2Z1bmN0aW9uKHJlcXVpcmUsbW9kdWxlLGV4cG9ydHMpewptb2R1bGUuZXhwb3J0cyA9IGZ1bmN0aW9uKGl0LCBDb25zdHJ1Y3RvciwgbmFtZSl7CiAgaWYoIShpdCBpbnN0YW5jZW9mIENvbnN0cnVjdG9yKSl0aHJvdyBUeXBlRXJyb3IobmFtZSArICI6IHVzZSB0aGUgJ25ldycgb3BlcmF0b3IhIik7CiAgcmV0dXJuIGl0Owp9Owp9LHt9XSw3MzpbZnVuY3Rpb24ocmVxdWlyZSxtb2R1bGUsZXhwb3J0cyl7CnZhciB0b0ludGVnZXIgPSByZXF1aXJlKCcuLyQudG8taW50ZWdlcicpCiAgLCBkZWZpbmVkICAgPSByZXF1aXJlKCcuLyQuZGVmaW5lZCcpOwovLyB0cnVlICAtPiBTdHJpbmcjYXQKLy8gZmFsc2UgLT4gU3RyaW5nI2NvZGVQb2ludEF0Cm1vZHVsZS5leHBvcnRzID0gZnVuY3Rpb24oVE9fU1RSSU5HKXsKICByZXR1cm4gZnVuY3Rpb24odGhhdCwgcG9zKXsKICAgIHZhciBzID0gU3RyaW5nKGRlZmluZWQodGhhdCkpCiAgICAgICwgaSA9IHRvSW50ZWdlcihwb3MpCiAgICAgICwgbCA9IHMubGVuZ3RoCiAgICAgICwgYSwgYjsKICAgIGlmKGkgPCAwIHx8IGkgPj0gbClyZXR1cm4gVE9fU1RSSU5HID8gJycgOiB1bmRlZmluZWQ7CiAgICBhID0gcy5jaGFyQ29kZUF0KGkpOwogICAgcmV0dXJuIGEgPCAweGQ4MDAgfHwgYSA+IDB4ZGJmZiB8fCBpICsgMSA9PT0gbCB8fCAoYiA9IHMuY2hhckNvZGVBdChpICsgMSkpIDwgMHhkYzAwIHx8IGIgPiAweGRmZmYKICAgICAgPyBUT19TVFJJTkcgPyBzLmNoYXJBdChpKSA6IGEKICAgICAgOiBUT19TVFJJTkcgPyBzLnNsaWNlKGksIGkgKyAyKSA6IChhIC0gMHhkODAwIDw8IDEwKSArIChiIC0gMHhkYzAwKSArIDB4MTAwMDA7CiAgfTsKfTsKfSx7Ii4vJC5kZWZpbmVkIjozNSwiLi8kLnRvLWludGVnZXIiOjc1fV0sNzQ6W2Z1bmN0aW9uKHJlcXVpcmUsbW9kdWxlLGV4cG9ydHMpewp2YXIgY3R4ICAgICAgICAgICAgICAgID0gcmVxdWlyZSgnLi8kLmN0eCcpCiAgLCBpbnZva2UgICAgICAgICAgICAgPSByZXF1aXJlKCcuLyQuaW52b2tlJykKICAsIGh0bWwgICAgICAgICAgICAgICA9IHJlcXVpcmUoJy4vJC5odG1sJykKICAsIGNlbCAgICAgICAgICAgICAgICA9IHJlcXVpcmUoJy4vJC5kb20tY3JlYXRlJykKICAsIGdsb2JhbCAgICAgICAgICAgICA9IHJlcXVpcmUoJy4vJC5nbG9iYWwnKQogICwgcHJvY2VzcyAgICAgICAgICAgID0gZ2xvYmFsLnByb2Nlc3MKICAsIHNldFRhc2sgICAgICAgICAgICA9IGdsb2JhbC5zZXRJbW1lZGlhdGUKICAsIGNsZWFyVGFzayAgICAgICAgICA9IGdsb2JhbC5jbGVhckltbWVkaWF0ZQogICwgTWVzc2FnZUNoYW5uZWwgICAgID0gZ2xvYmFsLk1lc3NhZ2VDaGFubmVsCiAgLCBjb3VudGVyICAgICAgICAgICAgPSAwCiAgLCBxdWV1ZSAgICAgICAgICAgICAgPSB7fQogICwgT05SRUFEWVNUQVRFQ0hBTkdFID0gJ29ucmVhZHlzdGF0ZWNoYW5nZScKICAsIGRlZmVyLCBjaGFubmVsLCBwb3J0Owp2YXIgcnVuID0gZnVuY3Rpb24oKXsKICB2YXIgaWQgPSArdGhpczsKICBpZihxdWV1ZS5oYXNPd25Qcm9wZXJ0eShpZCkpewogICAgdmFyIGZuID0gcXVldWVbaWRdOwogICAgZGVsZXRlIHF1ZXVlW2lkXTsKICAgIGZuKCk7CiAgfQp9Owp2YXIgbGlzdG5lciA9IGZ1bmN0aW9uKGV2ZW50KXsKICBydW4uY2FsbChldmVudC5kYXRhKTsKfTsKLy8gTm9kZS5qcyAwLjkrICYgSUUxMCsgaGFzIHNldEltbWVkaWF0ZSwgb3RoZXJ3aXNlOgppZighc2V0VGFzayB8fCAhY2xlYXJUYXNrKXsKICBzZXRUYXNrID0gZnVuY3Rpb24gc2V0SW1tZWRpYXRlKGZuKXsKICAgIHZhciBhcmdzID0gW10sIGkgPSAxOwogICAgd2hpbGUoYXJndW1lbnRzLmxlbmd0aCA+IGkpYXJncy5wdXNoKGFyZ3VtZW50c1tpKytdKTsKICAgIHF1ZXVlWysrY291bnRlcl0gPSBmdW5jdGlvbigpewogICAgICBpbnZva2UodHlwZW9mIGZuID09ICdmdW5jdGlvbicgPyBmbiA6IEZ1bmN0aW9uKGZuKSwgYXJncyk7CiAgICB9OwogICAgZGVmZXIoY291bnRlcik7CiAgICByZXR1cm4gY291bnRlcjsKICB9OwogIGNsZWFyVGFzayA9IGZ1bmN0aW9uIGNsZWFySW1tZWRpYXRlKGlkKXsKICAgIGRlbGV0ZSBxdWV1ZVtpZF07CiAgfTsKICAvLyBOb2RlLmpzIDAuOC0KICBpZihyZXF1aXJlKCcuLyQuY29mJykocHJvY2VzcykgPT0gJ3Byb2Nlc3MnKXsKICAgIGRlZmVyID0gZnVuY3Rpb24oaWQpewogICAgICBwcm9jZXNzLm5leHRUaWNrKGN0eChydW4sIGlkLCAxKSk7CiAgICB9OwogIC8vIEJyb3dzZXJzIHdpdGggTWVzc2FnZUNoYW5uZWwsIGluY2x1ZGVzIFdlYldvcmtlcnMKICB9IGVsc2UgaWYoTWVzc2FnZUNoYW5uZWwpewogICAgY2hhbm5lbCA9IG5ldyBNZXNzYWdlQ2hhbm5lbDsKICAgIHBvcnQgICAgPSBjaGFubmVsLnBvcnQyOwogICAgY2hhbm5lbC5wb3J0MS5vbm1lc3NhZ2UgPSBsaXN0bmVyOwogICAgZGVmZXIgPSBjdHgocG9ydC5wb3N0TWVzc2FnZSwgcG9ydCwgMSk7CiAgLy8gQnJvd3NlcnMgd2l0aCBwb3N0TWVzc2FnZSwgc2tpcCBXZWJXb3JrZXJzCiAgLy8gSUU4IGhhcyBwb3N0TWVzc2FnZSwgYnV0IGl0J3Mgc3luYyAmIHR5cGVvZiBpdHMgcG9zdE1lc3NhZ2UgaXMgJ29iamVjdCcKICB9IGVsc2UgaWYoZ2xvYmFsLmFkZEV2ZW50TGlzdGVuZXIgJiYgdHlwZW9mIHBvc3RNZXNzYWdlID09ICdmdW5jdGlvbicgJiYgIWdsb2JhbC5pbXBvcnRTY3JpcHRzKXsKICAgIGRlZmVyID0gZnVuY3Rpb24oaWQpewogICAgICBnbG9iYWwucG9zdE1lc3NhZ2UoaWQgKyAnJywgJyonKTsKICAgIH07CiAgICBnbG9iYWwuYWRkRXZlbnRMaXN0ZW5lcignbWVzc2FnZScsIGxpc3RuZXIsIGZhbHNlKTsKICAvLyBJRTgtCiAgfSBlbHNlIGlmKE9OUkVBRFlTVEFURUNIQU5HRSBpbiBjZWwoJ3NjcmlwdCcpKXsKICAgIGRlZmVyID0gZnVuY3Rpb24oaWQpewogICAgICBodG1sLmFwcGVuZENoaWxkKGNlbCgnc2NyaXB0JykpW09OUkVBRFlTVEFURUNIQU5HRV0gPSBmdW5jdGlvbigpewogICAgICAgIGh0bWwucmVtb3ZlQ2hpbGQodGhpcyk7CiAgICAgICAgcnVuLmNhbGwoaWQpOwogICAgICB9OwogICAgfTsKICAvLyBSZXN0IG9sZCBicm93c2VycwogIH0gZWxzZSB7CiAgICBkZWZlciA9IGZ1bmN0aW9uKGlkKXsKICAgICAgc2V0VGltZW91dChjdHgocnVuLCBpZCwgMSksIDApOwogICAgfTsKICB9Cn0KbW9kdWxlLmV4cG9ydHMgPSB7CiAgc2V0OiAgIHNldFRhc2ssCiAgY2xlYXI6IGNsZWFyVGFzawp9Owp9LHsiLi8kLmNvZiI6MzIsIi4vJC5jdHgiOjM0LCIuLyQuZG9tLWNyZWF0ZSI6MzcsIi4vJC5nbG9iYWwiOjQzLCIuLyQuaHRtbCI6NDYsIi4vJC5pbnZva2UiOjQ3fV0sNzU6W2Z1bmN0aW9uKHJlcXVpcmUsbW9kdWxlLGV4cG9ydHMpewovLyA3LjEuNCBUb0ludGVnZXIKdmFyIGNlaWwgID0gTWF0aC5jZWlsCiAgLCBmbG9vciA9IE1hdGguZmxvb3I7Cm1vZHVsZS5leHBvcnRzID0gZnVuY3Rpb24oaXQpewogIHJldHVybiBpc05hTihpdCA9ICtpdCkgPyAwIDogKGl0ID4gMCA/IGZsb29yIDogY2VpbCkoaXQpOwp9Owp9LHt9XSw3NjpbZnVuY3Rpb24ocmVxdWlyZSxtb2R1bGUsZXhwb3J0cyl7Ci8vIHRvIGluZGV4ZWQgb2JqZWN0LCB0b09iamVjdCB3aXRoIGZhbGxiYWNrIGZvciBub24tYXJyYXktbGlrZSBFUzMgc3RyaW5ncwp2YXIgSU9iamVjdCA9IHJlcXVpcmUoJy4vJC5pb2JqZWN0JykKICAsIGRlZmluZWQgPSByZXF1aXJlKCcuLyQuZGVmaW5lZCcpOwptb2R1bGUuZXhwb3J0cyA9IGZ1bmN0aW9uKGl0KXsKICByZXR1cm4gSU9iamVjdChkZWZpbmVkKGl0KSk7Cn07Cn0seyIuLyQuZGVmaW5lZCI6MzUsIi4vJC5pb2JqZWN0Ijo0OH1dLDc3OltmdW5jdGlvbihyZXF1aXJlLG1vZHVsZSxleHBvcnRzKXsKLy8gNy4xLjE1IFRvTGVuZ3RoCnZhciB0b0ludGVnZXIgPSByZXF1aXJlKCcuLyQudG8taW50ZWdlcicpCiAgLCBtaW4gICAgICAgPSBNYXRoLm1pbjsKbW9kdWxlLmV4cG9ydHMgPSBmdW5jdGlvbihpdCl7CiAgcmV0dXJuIGl0ID4gMCA/IG1pbih0b0ludGVnZXIoaXQpLCAweDFmZmZmZmZmZmZmZmZmKSA6IDA7IC8vIHBvdygyLCA1MykgLSAxID09IDkwMDcxOTkyNTQ3NDA5OTEKfTsKfSx7Ii4vJC50by1pbnRlZ2VyIjo3NX1dLDc4OltmdW5jdGlvbihyZXF1aXJlLG1vZHVsZSxleHBvcnRzKXsKLy8gNy4xLjEzIFRvT2JqZWN0KGFyZ3VtZW50KQp2YXIgZGVmaW5lZCA9IHJlcXVpcmUoJy4vJC5kZWZpbmVkJyk7Cm1vZHVsZS5leHBvcnRzID0gZnVuY3Rpb24oaXQpewogIHJldHVybiBPYmplY3QoZGVmaW5lZChpdCkpOwp9Owp9LHsiLi8kLmRlZmluZWQiOjM1fV0sNzk6W2Z1bmN0aW9uKHJlcXVpcmUsbW9kdWxlLGV4cG9ydHMpewp2YXIgaWQgPSAwCiAgLCBweCA9IE1hdGgucmFuZG9tKCk7Cm1vZHVsZS5leHBvcnRzID0gZnVuY3Rpb24oa2V5KXsKICByZXR1cm4gJ1N5bWJvbCgnLmNvbmNhdChrZXkgPT09IHVuZGVmaW5lZCA/ICcnIDoga2V5LCAnKV8nLCAoKytpZCArIHB4KS50b1N0cmluZygzNikpOwp9Owp9LHt9XSw4MDpbZnVuY3Rpb24ocmVxdWlyZSxtb2R1bGUsZXhwb3J0cyl7CnZhciBzdG9yZSAgPSByZXF1aXJlKCcuLyQuc2hhcmVkJykoJ3drcycpCiAgLCB1aWQgICAgPSByZXF1aXJlKCcuLyQudWlkJykKICAsIFN5bWJvbCA9IHJlcXVpcmUoJy4vJC5nbG9iYWwnKS5TeW1ib2w7Cm1vZHVsZS5leHBvcnRzID0gZnVuY3Rpb24obmFtZSl7CiAgcmV0dXJuIHN0b3JlW25hbWVdIHx8IChzdG9yZVtuYW1lXSA9CiAgICBTeW1ib2wgJiYgU3ltYm9sW25hbWVdIHx8IChTeW1ib2wgfHwgdWlkKSgnU3ltYm9sLicgKyBuYW1lKSk7Cn07Cn0seyIuLyQuZ2xvYmFsIjo0MywiLi8kLnNoYXJlZCI6NzAsIi4vJC51aWQiOjc5fV0sODE6W2Z1bmN0aW9uKHJlcXVpcmUsbW9kdWxlLGV4cG9ydHMpewp2YXIgY2xhc3NvZiAgID0gcmVxdWlyZSgnLi8kLmNsYXNzb2YnKQogICwgSVRFUkFUT1IgID0gcmVxdWlyZSgnLi8kLndrcycpKCdpdGVyYXRvcicpCiAgLCBJdGVyYXRvcnMgPSByZXF1aXJlKCcuLyQuaXRlcmF0b3JzJyk7Cm1vZHVsZS5leHBvcnRzID0gcmVxdWlyZSgnLi8kLmNvcmUnKS5nZXRJdGVyYXRvck1ldGhvZCA9IGZ1bmN0aW9uKGl0KXsKICBpZihpdCAhPSB1bmRlZmluZWQpcmV0dXJuIGl0W0lURVJBVE9SXQogICAgfHwgaXRbJ0BAaXRlcmF0b3InXQogICAgfHwgSXRlcmF0b3JzW2NsYXNzb2YoaXQpXTsKfTsKfSx7Ii4vJC5jbGFzc29mIjozMSwiLi8kLmNvcmUiOjMzLCIuLyQuaXRlcmF0b3JzIjo1NywiLi8kLndrcyI6ODB9XSw4MjpbZnVuY3Rpb24ocmVxdWlyZSxtb2R1bGUsZXhwb3J0cyl7Cid1c2Ugc3RyaWN0JzsKdmFyIGFkZFRvVW5zY29wYWJsZXMgPSByZXF1aXJlKCcuLyQuYWRkLXRvLXVuc2NvcGFibGVzJykKICAsIHN0ZXAgICAgICAgICAgICAgPSByZXF1aXJlKCcuLyQuaXRlci1zdGVwJykKICAsIEl0ZXJhdG9ycyAgICAgICAgPSByZXF1aXJlKCcuLyQuaXRlcmF0b3JzJykKICAsIHRvSU9iamVjdCAgICAgICAgPSByZXF1aXJlKCcuLyQudG8taW9iamVjdCcpOwoKLy8gMjIuMS4zLjQgQXJyYXkucHJvdG90eXBlLmVudHJpZXMoKQovLyAyMi4xLjMuMTMgQXJyYXkucHJvdG90eXBlLmtleXMoKQovLyAyMi4xLjMuMjkgQXJyYXkucHJvdG90eXBlLnZhbHVlcygpCi8vIDIyLjEuMy4zMCBBcnJheS5wcm90b3R5cGVbQEBpdGVyYXRvcl0oKQptb2R1bGUuZXhwb3J0cyA9IHJlcXVpcmUoJy4vJC5pdGVyLWRlZmluZScpKEFycmF5LCAnQXJyYXknLCBmdW5jdGlvbihpdGVyYXRlZCwga2luZCl7CiAgdGhpcy5fdCA9IHRvSU9iamVjdChpdGVyYXRlZCk7IC8vIHRhcmdldAogIHRoaXMuX2kgPSAwOyAgICAgICAgICAgICAgICAgICAvLyBuZXh0IGluZGV4CiAgdGhpcy5fayA9IGtpbmQ7ICAgICAgICAgICAgICAgIC8vIGtpbmQKLy8gMjIuMS41LjIuMSAlQXJyYXlJdGVyYXRvclByb3RvdHlwZSUubmV4dCgpCn0sIGZ1bmN0aW9uKCl7CiAgdmFyIE8gICAgID0gdGhpcy5fdAogICAgLCBraW5kICA9IHRoaXMuX2sKICAgICwgaW5kZXggPSB0aGlzLl9pKys7CiAgaWYoIU8gfHwgaW5kZXggPj0gTy5sZW5ndGgpewogICAgdGhpcy5fdCA9IHVuZGVmaW5lZDsKICAgIHJldHVybiBzdGVwKDEpOwogIH0KICBpZihraW5kID09ICdrZXlzJyAgKXJldHVybiBzdGVwKDAsIGluZGV4KTsKICBpZihraW5kID09ICd2YWx1ZXMnKXJldHVybiBzdGVwKDAsIE9baW5kZXhdKTsKICByZXR1cm4gc3RlcCgwLCBbaW5kZXgsIE9baW5kZXhdXSk7Cn0sICd2YWx1ZXMnKTsKCi8vIGFyZ3VtZW50c0xpc3RbQEBpdGVyYXRvcl0gaXMgJUFycmF5UHJvdG9fdmFsdWVzJSAoOS40LjQuNiwgOS40LjQuNykKSXRlcmF0b3JzLkFyZ3VtZW50cyA9IEl0ZXJhdG9ycy5BcnJheTsKCmFkZFRvVW5zY29wYWJsZXMoJ2tleXMnKTsKYWRkVG9VbnNjb3BhYmxlcygndmFsdWVzJyk7CmFkZFRvVW5zY29wYWJsZXMoJ2VudHJpZXMnKTsKfSx7Ii4vJC5hZGQtdG8tdW5zY29wYWJsZXMiOjI5LCIuLyQuaXRlci1kZWZpbmUiOjU0LCIuLyQuaXRlci1zdGVwIjo1NiwiLi8kLml0ZXJhdG9ycyI6NTcsIi4vJC50by1pb2JqZWN0Ijo3Nn1dLDgzOltmdW5jdGlvbihyZXF1aXJlLG1vZHVsZSxleHBvcnRzKXsKLy8gMTkuMS4yLjYgT2JqZWN0LmdldE93blByb3BlcnR5RGVzY3JpcHRvcihPLCBQKQp2YXIgdG9JT2JqZWN0ID0gcmVxdWlyZSgnLi8kLnRvLWlvYmplY3QnKTsKCnJlcXVpcmUoJy4vJC5vYmplY3Qtc2FwJykoJ2dldE93blByb3BlcnR5RGVzY3JpcHRvcicsIGZ1bmN0aW9uKCRnZXRPd25Qcm9wZXJ0eURlc2NyaXB0b3IpewogIHJldHVybiBmdW5jdGlvbiBnZXRPd25Qcm9wZXJ0eURlc2NyaXB0b3IoaXQsIGtleSl7CiAgICByZXR1cm4gJGdldE93blByb3BlcnR5RGVzY3JpcHRvcih0b0lPYmplY3QoaXQpLCBrZXkpOwogIH07Cn0pOwp9LHsiLi8kLm9iamVjdC1zYXAiOjYyLCIuLyQudG8taW9iamVjdCI6NzZ9XSw4NDpbZnVuY3Rpb24ocmVxdWlyZSxtb2R1bGUsZXhwb3J0cyl7Ci8vIDE5LjEuMi45IE9iamVjdC5nZXRQcm90b3R5cGVPZihPKQp2YXIgdG9PYmplY3QgPSByZXF1aXJlKCcuLyQudG8tb2JqZWN0Jyk7CgpyZXF1aXJlKCcuLyQub2JqZWN0LXNhcCcpKCdnZXRQcm90b3R5cGVPZicsIGZ1bmN0aW9uKCRnZXRQcm90b3R5cGVPZil7CiAgcmV0dXJuIGZ1bmN0aW9uIGdldFByb3RvdHlwZU9mKGl0KXsKICAgIHJldHVybiAkZ2V0UHJvdG90eXBlT2YodG9PYmplY3QoaXQpKTsKICB9Owp9KTsKfSx7Ii4vJC5vYmplY3Qtc2FwIjo2MiwiLi8kLnRvLW9iamVjdCI6Nzh9XSw4NTpbZnVuY3Rpb24ocmVxdWlyZSxtb2R1bGUsZXhwb3J0cyl7Ci8vIDE5LjEuMi4xNCBPYmplY3Qua2V5cyhPKQp2YXIgdG9PYmplY3QgPSByZXF1aXJlKCcuLyQudG8tb2JqZWN0Jyk7CgpyZXF1aXJlKCcuLyQub2JqZWN0LXNhcCcpKCdrZXlzJywgZnVuY3Rpb24oJGtleXMpewogIHJldHVybiBmdW5jdGlvbiBrZXlzKGl0KXsKICAgIHJldHVybiAka2V5cyh0b09iamVjdChpdCkpOwogIH07Cn0pOwp9LHsiLi8kLm9iamVjdC1zYXAiOjYyLCIuLyQudG8tb2JqZWN0Ijo3OH1dLDg2OltmdW5jdGlvbihyZXF1aXJlLG1vZHVsZSxleHBvcnRzKXsKLy8gMTkuMS4zLjE5IE9iamVjdC5zZXRQcm90b3R5cGVPZihPLCBwcm90bykKdmFyICRleHBvcnQgPSByZXF1aXJlKCcuLyQuZXhwb3J0Jyk7CiRleHBvcnQoJGV4cG9ydC5TLCAnT2JqZWN0Jywge3NldFByb3RvdHlwZU9mOiByZXF1aXJlKCcuLyQuc2V0LXByb3RvJykuc2V0fSk7Cn0seyIuLyQuZXhwb3J0IjozOSwiLi8kLnNldC1wcm90byI6Njd9XSw4NzpbZnVuY3Rpb24ocmVxdWlyZSxtb2R1bGUsZXhwb3J0cyl7Cgp9LHt9XSw4ODpbZnVuY3Rpb24ocmVxdWlyZSxtb2R1bGUsZXhwb3J0cyl7Cid1c2Ugc3RyaWN0JzsKdmFyICQgICAgICAgICAgPSByZXF1aXJlKCcuLyQnKQogICwgTElCUkFSWSAgICA9IHJlcXVpcmUoJy4vJC5saWJyYXJ5JykKICAsIGdsb2JhbCAgICAgPSByZXF1aXJlKCcuLyQuZ2xvYmFsJykKICAsIGN0eCAgICAgICAgPSByZXF1aXJlKCcuLyQuY3R4JykKICAsIGNsYXNzb2YgICAgPSByZXF1aXJlKCcuLyQuY2xhc3NvZicpCiAgLCAkZXhwb3J0ICAgID0gcmVxdWlyZSgnLi8kLmV4cG9ydCcpCiAgLCBpc09iamVjdCAgID0gcmVxdWlyZSgnLi8kLmlzLW9iamVjdCcpCiAgLCBhbk9iamVjdCAgID0gcmVxdWlyZSgnLi8kLmFuLW9iamVjdCcpCiAgLCBhRnVuY3Rpb24gID0gcmVxdWlyZSgnLi8kLmEtZnVuY3Rpb24nKQogICwgc3RyaWN0TmV3ICA9IHJlcXVpcmUoJy4vJC5zdHJpY3QtbmV3JykKICAsIGZvck9mICAgICAgPSByZXF1aXJlKCcuLyQuZm9yLW9mJykKICAsIHNldFByb3RvICAgPSByZXF1aXJlKCcuLyQuc2V0LXByb3RvJykuc2V0CiAgLCBzYW1lICAgICAgID0gcmVxdWlyZSgnLi8kLnNhbWUtdmFsdWUnKQogICwgU1BFQ0lFUyAgICA9IHJlcXVpcmUoJy4vJC53a3MnKSgnc3BlY2llcycpCiAgLCBzcGVjaWVzQ29uc3RydWN0b3IgPSByZXF1aXJlKCcuLyQuc3BlY2llcy1jb25zdHJ1Y3RvcicpCiAgLCBhc2FwICAgICAgID0gcmVxdWlyZSgnLi8kLm1pY3JvdGFzaycpCiAgLCBQUk9NSVNFICAgID0gJ1Byb21pc2UnCiAgLCBwcm9jZXNzICAgID0gZ2xvYmFsLnByb2Nlc3MKICAsIGlzTm9kZSAgICAgPSBjbGFzc29mKHByb2Nlc3MpID09ICdwcm9jZXNzJwogICwgUCAgICAgICAgICA9IGdsb2JhbFtQUk9NSVNFXQogICwgV3JhcHBlcjsKCnZhciB0ZXN0UmVzb2x2ZSA9IGZ1bmN0aW9uKHN1Yil7CiAgdmFyIHRlc3QgPSBuZXcgUChmdW5jdGlvbigpe30pOwogIGlmKHN1Yil0ZXN0LmNvbnN0cnVjdG9yID0gT2JqZWN0OwogIHJldHVybiBQLnJlc29sdmUodGVzdCkgPT09IHRlc3Q7Cn07Cgp2YXIgVVNFX05BVElWRSA9IGZ1bmN0aW9uKCl7CiAgdmFyIHdvcmtzID0gZmFsc2U7CiAgZnVuY3Rpb24gUDIoeCl7CiAgICB2YXIgc2VsZiA9IG5ldyBQKHgpOwogICAgc2V0UHJvdG8oc2VsZiwgUDIucHJvdG90eXBlKTsKICAgIHJldHVybiBzZWxmOwogIH0KICB0cnkgewogICAgd29ya3MgPSBQICYmIFAucmVzb2x2ZSAmJiB0ZXN0UmVzb2x2ZSgpOwogICAgc2V0UHJvdG8oUDIsIFApOwogICAgUDIucHJvdG90eXBlID0gJC5jcmVhdGUoUC5wcm90b3R5cGUsIHtjb25zdHJ1Y3Rvcjoge3ZhbHVlOiBQMn19KTsKICAgIC8vIGFjdHVhbCBGaXJlZm94IGhhcyBicm9rZW4gc3ViY2xhc3Mgc3VwcG9ydCwgdGVzdCB0aGF0CiAgICBpZighKFAyLnJlc29sdmUoNSkudGhlbihmdW5jdGlvbigpe30pIGluc3RhbmNlb2YgUDIpKXsKICAgICAgd29ya3MgPSBmYWxzZTsKICAgIH0KICAgIC8vIGFjdHVhbCBWOCBidWcsIGh0dHBzOi8vY29kZS5nb29nbGUuY29tL3AvdjgvaXNzdWVzL2RldGFpbD9pZD00MTYyCiAgICBpZih3b3JrcyAmJiByZXF1aXJlKCcuLyQuZGVzY3JpcHRvcnMnKSl7CiAgICAgIHZhciB0aGVuYWJsZVRoZW5Hb3R0ZW4gPSBmYWxzZTsKICAgICAgUC5yZXNvbHZlKCQuc2V0RGVzYyh7fSwgJ3RoZW4nLCB7CiAgICAgICAgZ2V0OiBmdW5jdGlvbigpeyB0aGVuYWJsZVRoZW5Hb3R0ZW4gPSB0cnVlOyB9CiAgICAgIH0pKTsKICAgICAgd29ya3MgPSB0aGVuYWJsZVRoZW5Hb3R0ZW47CiAgICB9CiAgfSBjYXRjaChlKXsgd29ya3MgPSBmYWxzZTsgfQogIHJldHVybiB3b3JrczsKfSgpOwoKLy8gaGVscGVycwp2YXIgc2FtZUNvbnN0cnVjdG9yID0gZnVuY3Rpb24oYSwgYil7CiAgLy8gbGlicmFyeSB3cmFwcGVyIHNwZWNpYWwgY2FzZQogIGlmKExJQlJBUlkgJiYgYSA9PT0gUCAmJiBiID09PSBXcmFwcGVyKXJldHVybiB0cnVlOwogIHJldHVybiBzYW1lKGEsIGIpOwp9Owp2YXIgZ2V0Q29uc3RydWN0b3IgPSBmdW5jdGlvbihDKXsKICB2YXIgUyA9IGFuT2JqZWN0KEMpW1NQRUNJRVNdOwogIHJldHVybiBTICE9IHVuZGVmaW5lZCA/IFMgOiBDOwp9Owp2YXIgaXNUaGVuYWJsZSA9IGZ1bmN0aW9uKGl0KXsKICB2YXIgdGhlbjsKICByZXR1cm4gaXNPYmplY3QoaXQpICYmIHR5cGVvZiAodGhlbiA9IGl0LnRoZW4pID09ICdmdW5jdGlvbicgPyB0aGVuIDogZmFsc2U7Cn07CnZhciBQcm9taXNlQ2FwYWJpbGl0eSA9IGZ1bmN0aW9uKEMpewogIHZhciByZXNvbHZlLCByZWplY3Q7CiAgdGhpcy5wcm9taXNlID0gbmV3IEMoZnVuY3Rpb24oJCRyZXNvbHZlLCAkJHJlamVjdCl7CiAgICBpZihyZXNvbHZlICE9PSB1bmRlZmluZWQgfHwgcmVqZWN0ICE9PSB1bmRlZmluZWQpdGhyb3cgVHlwZUVycm9yKCdCYWQgUHJvbWlzZSBjb25zdHJ1Y3RvcicpOwogICAgcmVzb2x2ZSA9ICQkcmVzb2x2ZTsKICAgIHJlamVjdCAgPSAkJHJlamVjdDsKICB9KTsKICB0aGlzLnJlc29sdmUgPSBhRnVuY3Rpb24ocmVzb2x2ZSksCiAgdGhpcy5yZWplY3QgID0gYUZ1bmN0aW9uKHJlamVjdCkKfTsKdmFyIHBlcmZvcm0gPSBmdW5jdGlvbihleGVjKXsKICB0cnkgewogICAgZXhlYygpOwogIH0gY2F0Y2goZSl7CiAgICByZXR1cm4ge2Vycm9yOiBlfTsKICB9Cn07CnZhciBub3RpZnkgPSBmdW5jdGlvbihyZWNvcmQsIGlzUmVqZWN0KXsKICBpZihyZWNvcmQubilyZXR1cm47CiAgcmVjb3JkLm4gPSB0cnVlOwogIHZhciBjaGFpbiA9IHJlY29yZC5jOwogIGFzYXAoZnVuY3Rpb24oKXsKICAgIHZhciB2YWx1ZSA9IHJlY29yZC52CiAgICAgICwgb2sgICAgPSByZWNvcmQucyA9PSAxCiAgICAgICwgaSAgICAgPSAwOwogICAgdmFyIHJ1biA9IGZ1bmN0aW9uKHJlYWN0aW9uKXsKICAgICAgdmFyIGhhbmRsZXIgPSBvayA/IHJlYWN0aW9uLm9rIDogcmVhY3Rpb24uZmFpbAogICAgICAgICwgcmVzb2x2ZSA9IHJlYWN0aW9uLnJlc29sdmUKICAgICAgICAsIHJlamVjdCAgPSByZWFjdGlvbi5yZWplY3QKICAgICAgICAsIHJlc3VsdCwgdGhlbjsKICAgICAgdHJ5IHsKICAgICAgICBpZihoYW5kbGVyKXsKICAgICAgICAgIGlmKCFvaylyZWNvcmQuaCA9IHRydWU7CiAgICAgICAgICByZXN1bHQgPSBoYW5kbGVyID09PSB0cnVlID8gdmFsdWUgOiBoYW5kbGVyKHZhbHVlKTsKICAgICAgICAgIGlmKHJlc3VsdCA9PT0gcmVhY3Rpb24ucHJvbWlzZSl7CiAgICAgICAgICAgIHJlamVjdChUeXBlRXJyb3IoJ1Byb21pc2UtY2hhaW4gY3ljbGUnKSk7CiAgICAgICAgICB9IGVsc2UgaWYodGhlbiA9IGlzVGhlbmFibGUocmVzdWx0KSl7CiAgICAgICAgICAgIHRoZW4uY2FsbChyZXN1bHQsIHJlc29sdmUsIHJlamVjdCk7CiAgICAgICAgICB9IGVsc2UgcmVzb2x2ZShyZXN1bHQpOwogICAgICAgIH0gZWxzZSByZWplY3QodmFsdWUpOwogICAgICB9IGNhdGNoKGUpewogICAgICAgIHJlamVjdChlKTsKICAgICAgfQogICAgfTsKICAgIHdoaWxlKGNoYWluLmxlbmd0aCA+IGkpcnVuKGNoYWluW2krK10pOyAvLyB2YXJpYWJsZSBsZW5ndGggLSBjYW4ndCB1c2UgZm9yRWFjaAogICAgY2hhaW4ubGVuZ3RoID0gMDsKICAgIHJlY29yZC5uID0gZmFsc2U7CiAgICBpZihpc1JlamVjdClzZXRUaW1lb3V0KGZ1bmN0aW9uKCl7CiAgICAgIHZhciBwcm9taXNlID0gcmVjb3JkLnAKICAgICAgICAsIGhhbmRsZXIsIGNvbnNvbGU7CiAgICAgIGlmKGlzVW5oYW5kbGVkKHByb21pc2UpKXsKICAgICAgICBpZihpc05vZGUpewogICAgICAgICAgcHJvY2Vzcy5lbWl0KCd1bmhhbmRsZWRSZWplY3Rpb24nLCB2YWx1ZSwgcHJvbWlzZSk7CiAgICAgICAgfSBlbHNlIGlmKGhhbmRsZXIgPSBnbG9iYWwub251bmhhbmRsZWRyZWplY3Rpb24pewogICAgICAgICAgaGFuZGxlcih7cHJvbWlzZTogcHJvbWlzZSwgcmVhc29uOiB2YWx1ZX0pOwogICAgICAgIH0gZWxzZSBpZigoY29uc29sZSA9IGdsb2JhbC5jb25zb2xlKSAmJiBjb25zb2xlLmVycm9yKXsKICAgICAgICAgIGNvbnNvbGUuZXJyb3IoJ1VuaGFuZGxlZCBwcm9taXNlIHJlamVjdGlvbicsIHZhbHVlKTsKICAgICAgICB9CiAgICAgIH0gcmVjb3JkLmEgPSB1bmRlZmluZWQ7CiAgICB9LCAxKTsKICB9KTsKfTsKdmFyIGlzVW5oYW5kbGVkID0gZnVuY3Rpb24ocHJvbWlzZSl7CiAgdmFyIHJlY29yZCA9IHByb21pc2UuX2QKICAgICwgY2hhaW4gID0gcmVjb3JkLmEgfHwgcmVjb3JkLmMKICAgICwgaSAgICAgID0gMAogICAgLCByZWFjdGlvbjsKICBpZihyZWNvcmQuaClyZXR1cm4gZmFsc2U7CiAgd2hpbGUoY2hhaW4ubGVuZ3RoID4gaSl7CiAgICByZWFjdGlvbiA9IGNoYWluW2krK107CiAgICBpZihyZWFjdGlvbi5mYWlsIHx8ICFpc1VuaGFuZGxlZChyZWFjdGlvbi5wcm9taXNlKSlyZXR1cm4gZmFsc2U7CiAgfSByZXR1cm4gdHJ1ZTsKfTsKdmFyICRyZWplY3QgPSBmdW5jdGlvbih2YWx1ZSl7CiAgdmFyIHJlY29yZCA9IHRoaXM7CiAgaWYocmVjb3JkLmQpcmV0dXJuOwogIHJlY29yZC5kID0gdHJ1ZTsKICByZWNvcmQgPSByZWNvcmQuciB8fCByZWNvcmQ7IC8vIHVud3JhcAogIHJlY29yZC52ID0gdmFsdWU7CiAgcmVjb3JkLnMgPSAyOwogIHJlY29yZC5hID0gcmVjb3JkLmMuc2xpY2UoKTsKICBub3RpZnkocmVjb3JkLCB0cnVlKTsKfTsKdmFyICRyZXNvbHZlID0gZnVuY3Rpb24odmFsdWUpewogIHZhciByZWNvcmQgPSB0aGlzCiAgICAsIHRoZW47CiAgaWYocmVjb3JkLmQpcmV0dXJuOwogIHJlY29yZC5kID0gdHJ1ZTsKICByZWNvcmQgPSByZWNvcmQuciB8fCByZWNvcmQ7IC8vIHVud3JhcAogIHRyeSB7CiAgICBpZihyZWNvcmQucCA9PT0gdmFsdWUpdGhyb3cgVHlwZUVycm9yKCJQcm9taXNlIGNhbid0IGJlIHJlc29sdmVkIGl0c2VsZiIpOwogICAgaWYodGhlbiA9IGlzVGhlbmFibGUodmFsdWUpKXsKICAgICAgYXNhcChmdW5jdGlvbigpewogICAgICAgIHZhciB3cmFwcGVyID0ge3I6IHJlY29yZCwgZDogZmFsc2V9OyAvLyB3cmFwCiAgICAgICAgdHJ5IHsKICAgICAgICAgIHRoZW4uY2FsbCh2YWx1ZSwgY3R4KCRyZXNvbHZlLCB3cmFwcGVyLCAxKSwgY3R4KCRyZWplY3QsIHdyYXBwZXIsIDEpKTsKICAgICAgICB9IGNhdGNoKGUpewogICAgICAgICAgJHJlamVjdC5jYWxsKHdyYXBwZXIsIGUpOwogICAgICAgIH0KICAgICAgfSk7CiAgICB9IGVsc2UgewogICAgICByZWNvcmQudiA9IHZhbHVlOwogICAgICByZWNvcmQucyA9IDE7CiAgICAgIG5vdGlmeShyZWNvcmQsIGZhbHNlKTsKICAgIH0KICB9IGNhdGNoKGUpewogICAgJHJlamVjdC5jYWxsKHtyOiByZWNvcmQsIGQ6IGZhbHNlfSwgZSk7IC8vIHdyYXAKICB9Cn07CgovLyBjb25zdHJ1Y3RvciBwb2x5ZmlsbAppZighVVNFX05BVElWRSl7CiAgLy8gMjUuNC4zLjEgUHJvbWlzZShleGVjdXRvcikKICBQID0gZnVuY3Rpb24gUHJvbWlzZShleGVjdXRvcil7CiAgICBhRnVuY3Rpb24oZXhlY3V0b3IpOwogICAgdmFyIHJlY29yZCA9IHRoaXMuX2QgPSB7CiAgICAgIHA6IHN0cmljdE5ldyh0aGlzLCBQLCBQUk9NSVNFKSwgICAgICAgICAvLyA8LSBwcm9taXNlCiAgICAgIGM6IFtdLCAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAvLyA8LSBhd2FpdGluZyByZWFjdGlvbnMKICAgICAgYTogdW5kZWZpbmVkLCAgICAgICAgICAgICAgICAgICAgICAgICAgIC8vIDwtIGNoZWNrZWQgaW4gaXNVbmhhbmRsZWQgcmVhY3Rpb25zCiAgICAgIHM6IDAsICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAvLyA8LSBzdGF0ZQogICAgICBkOiBmYWxzZSwgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgLy8gPC0gZG9uZQogICAgICB2OiB1bmRlZmluZWQsICAgICAgICAgICAgICAgICAgICAgICAgICAgLy8gPC0gdmFsdWUKICAgICAgaDogZmFsc2UsICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIC8vIDwtIGhhbmRsZWQgcmVqZWN0aW9uCiAgICAgIG46IGZhbHNlICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAvLyA8LSBub3RpZnkKICAgIH07CiAgICB0cnkgewogICAgICBleGVjdXRvcihjdHgoJHJlc29sdmUsIHJlY29yZCwgMSksIGN0eCgkcmVqZWN0LCByZWNvcmQsIDEpKTsKICAgIH0gY2F0Y2goZXJyKXsKICAgICAgJHJlamVjdC5jYWxsKHJlY29yZCwgZXJyKTsKICAgIH0KICB9OwogIHJlcXVpcmUoJy4vJC5yZWRlZmluZS1hbGwnKShQLnByb3RvdHlwZSwgewogICAgLy8gMjUuNC41LjMgUHJvbWlzZS5wcm90b3R5cGUudGhlbihvbkZ1bGZpbGxlZCwgb25SZWplY3RlZCkKICAgIHRoZW46IGZ1bmN0aW9uIHRoZW4ob25GdWxmaWxsZWQsIG9uUmVqZWN0ZWQpewogICAgICB2YXIgcmVhY3Rpb24gPSBuZXcgUHJvbWlzZUNhcGFiaWxpdHkoc3BlY2llc0NvbnN0cnVjdG9yKHRoaXMsIFApKQogICAgICAgICwgcHJvbWlzZSAgPSByZWFjdGlvbi5wcm9taXNlCiAgICAgICAgLCByZWNvcmQgICA9IHRoaXMuX2Q7CiAgICAgIHJlYWN0aW9uLm9rICAgPSB0eXBlb2Ygb25GdWxmaWxsZWQgPT0gJ2Z1bmN0aW9uJyA/IG9uRnVsZmlsbGVkIDogdHJ1ZTsKICAgICAgcmVhY3Rpb24uZmFpbCA9IHR5cGVvZiBvblJlamVjdGVkID09ICdmdW5jdGlvbicgJiYgb25SZWplY3RlZDsKICAgICAgcmVjb3JkLmMucHVzaChyZWFjdGlvbik7CiAgICAgIGlmKHJlY29yZC5hKXJlY29yZC5hLnB1c2gocmVhY3Rpb24pOwogICAgICBpZihyZWNvcmQucylub3RpZnkocmVjb3JkLCBmYWxzZSk7CiAgICAgIHJldHVybiBwcm9taXNlOwogICAgfSwKICAgIC8vIDI1LjQuNS4xIFByb21pc2UucHJvdG90eXBlLmNhdGNoKG9uUmVqZWN0ZWQpCiAgICAnY2F0Y2gnOiBmdW5jdGlvbihvblJlamVjdGVkKXsKICAgICAgcmV0dXJuIHRoaXMudGhlbih1bmRlZmluZWQsIG9uUmVqZWN0ZWQpOwogICAgfQogIH0pOwp9CgokZXhwb3J0KCRleHBvcnQuRyArICRleHBvcnQuVyArICRleHBvcnQuRiAqICFVU0VfTkFUSVZFLCB7UHJvbWlzZTogUH0pOwpyZXF1aXJlKCcuLyQuc2V0LXRvLXN0cmluZy10YWcnKShQLCBQUk9NSVNFKTsKcmVxdWlyZSgnLi8kLnNldC1zcGVjaWVzJykoUFJPTUlTRSk7CldyYXBwZXIgPSByZXF1aXJlKCcuLyQuY29yZScpW1BST01JU0VdOwoKLy8gc3RhdGljcwokZXhwb3J0KCRleHBvcnQuUyArICRleHBvcnQuRiAqICFVU0VfTkFUSVZFLCBQUk9NSVNFLCB7CiAgLy8gMjUuNC40LjUgUHJvbWlzZS5yZWplY3QocikKICByZWplY3Q6IGZ1bmN0aW9uIHJlamVjdChyKXsKICAgIHZhciBjYXBhYmlsaXR5ID0gbmV3IFByb21pc2VDYXBhYmlsaXR5KHRoaXMpCiAgICAgICwgJCRyZWplY3QgICA9IGNhcGFiaWxpdHkucmVqZWN0OwogICAgJCRyZWplY3Qocik7CiAgICByZXR1cm4gY2FwYWJpbGl0eS5wcm9taXNlOwogIH0KfSk7CiRleHBvcnQoJGV4cG9ydC5TICsgJGV4cG9ydC5GICogKCFVU0VfTkFUSVZFIHx8IHRlc3RSZXNvbHZlKHRydWUpKSwgUFJPTUlTRSwgewogIC8vIDI1LjQuNC42IFByb21pc2UucmVzb2x2ZSh4KQogIHJlc29sdmU6IGZ1bmN0aW9uIHJlc29sdmUoeCl7CiAgICAvLyBpbnN0YW5jZW9mIGluc3RlYWQgb2YgaW50ZXJuYWwgc2xvdCBjaGVjayBiZWNhdXNlIHdlIHNob3VsZCBmaXggaXQgd2l0aG91dCByZXBsYWNlbWVudCBuYXRpdmUgUHJvbWlzZSBjb3JlCiAgICBpZih4IGluc3RhbmNlb2YgUCAmJiBzYW1lQ29uc3RydWN0b3IoeC5jb25zdHJ1Y3RvciwgdGhpcykpcmV0dXJuIHg7CiAgICB2YXIgY2FwYWJpbGl0eSA9IG5ldyBQcm9taXNlQ2FwYWJpbGl0eSh0aGlzKQogICAgICAsICQkcmVzb2x2ZSAgPSBjYXBhYmlsaXR5LnJlc29sdmU7CiAgICAkJHJlc29sdmUoeCk7CiAgICByZXR1cm4gY2FwYWJpbGl0eS5wcm9taXNlOwogIH0KfSk7CiRleHBvcnQoJGV4cG9ydC5TICsgJGV4cG9ydC5GICogIShVU0VfTkFUSVZFICYmIHJlcXVpcmUoJy4vJC5pdGVyLWRldGVjdCcpKGZ1bmN0aW9uKGl0ZXIpewogIFAuYWxsKGl0ZXIpWydjYXRjaCddKGZ1bmN0aW9uKCl7fSk7Cn0pKSwgUFJPTUlTRSwgewogIC8vIDI1LjQuNC4xIFByb21pc2UuYWxsKGl0ZXJhYmxlKQogIGFsbDogZnVuY3Rpb24gYWxsKGl0ZXJhYmxlKXsKICAgIHZhciBDICAgICAgICAgID0gZ2V0Q29uc3RydWN0b3IodGhpcykKICAgICAgLCBjYXBhYmlsaXR5ID0gbmV3IFByb21pc2VDYXBhYmlsaXR5KEMpCiAgICAgICwgcmVzb2x2ZSAgICA9IGNhcGFiaWxpdHkucmVzb2x2ZQogICAgICAsIHJlamVjdCAgICAgPSBjYXBhYmlsaXR5LnJlamVjdAogICAgICAsIHZhbHVlcyAgICAgPSBbXTsKICAgIHZhciBhYnJ1cHQgPSBwZXJmb3JtKGZ1bmN0aW9uKCl7CiAgICAgIGZvck9mKGl0ZXJhYmxlLCBmYWxzZSwgdmFsdWVzLnB1c2gsIHZhbHVlcyk7CiAgICAgIHZhciByZW1haW5pbmcgPSB2YWx1ZXMubGVuZ3RoCiAgICAgICAgLCByZXN1bHRzICAgPSBBcnJheShyZW1haW5pbmcpOwogICAgICBpZihyZW1haW5pbmcpJC5lYWNoLmNhbGwodmFsdWVzLCBmdW5jdGlvbihwcm9taXNlLCBpbmRleCl7CiAgICAgICAgdmFyIGFscmVhZHlDYWxsZWQgPSBmYWxzZTsKICAgICAgICBDLnJlc29sdmUocHJvbWlzZSkudGhlbihmdW5jdGlvbih2YWx1ZSl7CiAgICAgICAgICBpZihhbHJlYWR5Q2FsbGVkKXJldHVybjsKICAgICAgICAgIGFscmVhZHlDYWxsZWQgPSB0cnVlOwogICAgICAgICAgcmVzdWx0c1tpbmRleF0gPSB2YWx1ZTsKICAgICAgICAgIC0tcmVtYWluaW5nIHx8IHJlc29sdmUocmVzdWx0cyk7CiAgICAgICAgfSwgcmVqZWN0KTsKICAgICAgfSk7CiAgICAgIGVsc2UgcmVzb2x2ZShyZXN1bHRzKTsKICAgIH0pOwogICAgaWYoYWJydXB0KXJlamVjdChhYnJ1cHQuZXJyb3IpOwogICAgcmV0dXJuIGNhcGFiaWxpdHkucHJvbWlzZTsKICB9LAogIC8vIDI1LjQuNC40IFByb21pc2UucmFjZShpdGVyYWJsZSkKICByYWNlOiBmdW5jdGlvbiByYWNlKGl0ZXJhYmxlKXsKICAgIHZhciBDICAgICAgICAgID0gZ2V0Q29uc3RydWN0b3IodGhpcykKICAgICAgLCBjYXBhYmlsaXR5ID0gbmV3IFByb21pc2VDYXBhYmlsaXR5KEMpCiAgICAgICwgcmVqZWN0ICAgICA9IGNhcGFiaWxpdHkucmVqZWN0OwogICAgdmFyIGFicnVwdCA9IHBlcmZvcm0oZnVuY3Rpb24oKXsKICAgICAgZm9yT2YoaXRlcmFibGUsIGZhbHNlLCBmdW5jdGlvbihwcm9taXNlKXsKICAgICAgICBDLnJlc29sdmUocHJvbWlzZSkudGhlbihjYXBhYmlsaXR5LnJlc29sdmUsIHJlamVjdCk7CiAgICAgIH0pOwogICAgfSk7CiAgICBpZihhYnJ1cHQpcmVqZWN0KGFicnVwdC5lcnJvcik7CiAgICByZXR1cm4gY2FwYWJpbGl0eS5wcm9taXNlOwogIH0KfSk7Cn0seyIuLyQiOjU4LCIuLyQuYS1mdW5jdGlvbiI6MjgsIi4vJC5hbi1vYmplY3QiOjMwLCIuLyQuY2xhc3NvZiI6MzEsIi4vJC5jb3JlIjozMywiLi8kLmN0eCI6MzQsIi4vJC5kZXNjcmlwdG9ycyI6MzYsIi4vJC5leHBvcnQiOjM5LCIuLyQuZm9yLW9mIjo0MSwiLi8kLmdsb2JhbCI6NDMsIi4vJC5pcy1vYmplY3QiOjUxLCIuLyQuaXRlci1kZXRlY3QiOjU1LCIuLyQubGlicmFyeSI6NjAsIi4vJC5taWNyb3Rhc2siOjYxLCIuLyQucmVkZWZpbmUtYWxsIjo2NCwiLi8kLnNhbWUtdmFsdWUiOjY2LCIuLyQuc2V0LXByb3RvIjo2NywiLi8kLnNldC1zcGVjaWVzIjo2OCwiLi8kLnNldC10by1zdHJpbmctdGFnIjo2OSwiLi8kLnNwZWNpZXMtY29uc3RydWN0b3IiOjcxLCIuLyQuc3RyaWN0LW5ldyI6NzIsIi4vJC53a3MiOjgwfV0sODk6W2Z1bmN0aW9uKHJlcXVpcmUsbW9kdWxlLGV4cG9ydHMpewondXNlIHN0cmljdCc7CnZhciAkYXQgID0gcmVxdWlyZSgnLi8kLnN0cmluZy1hdCcpKHRydWUpOwoKLy8gMjEuMS4zLjI3IFN0cmluZy5wcm90b3R5cGVbQEBpdGVyYXRvcl0oKQpyZXF1aXJlKCcuLyQuaXRlci1kZWZpbmUnKShTdHJpbmcsICdTdHJpbmcnLCBmdW5jdGlvbihpdGVyYXRlZCl7CiAgdGhpcy5fdCA9IFN0cmluZyhpdGVyYXRlZCk7IC8vIHRhcmdldAogIHRoaXMuX2kgPSAwOyAgICAgICAgICAgICAgICAvLyBuZXh0IGluZGV4Ci8vIDIxLjEuNS4yLjEgJVN0cmluZ0l0ZXJhdG9yUHJvdG90eXBlJS5uZXh0KCkKfSwgZnVuY3Rpb24oKXsKICB2YXIgTyAgICAgPSB0aGlzLl90CiAgICAsIGluZGV4ID0gdGhpcy5faQogICAgLCBwb2ludDsKICBpZihpbmRleCA+PSBPLmxlbmd0aClyZXR1cm4ge3ZhbHVlOiB1bmRlZmluZWQsIGRvbmU6IHRydWV9OwogIHBvaW50ID0gJGF0KE8sIGluZGV4KTsKICB0aGlzLl9pICs9IHBvaW50Lmxlbmd0aDsKICByZXR1cm4ge3ZhbHVlOiBwb2ludCwgZG9uZTogZmFsc2V9Owp9KTsKfSx7Ii4vJC5pdGVyLWRlZmluZSI6NTQsIi4vJC5zdHJpbmctYXQiOjczfV0sOTA6W2Z1bmN0aW9uKHJlcXVpcmUsbW9kdWxlLGV4cG9ydHMpewondXNlIHN0cmljdCc7Ci8vIEVDTUFTY3JpcHQgNiBzeW1ib2xzIHNoaW0KdmFyICQgICAgICAgICAgICAgID0gcmVxdWlyZSgnLi8kJykKICAsIGdsb2JhbCAgICAgICAgID0gcmVxdWlyZSgnLi8kLmdsb2JhbCcpCiAgLCBoYXMgICAgICAgICAgICA9IHJlcXVpcmUoJy4vJC5oYXMnKQogICwgREVTQ1JJUFRPUlMgICAgPSByZXF1aXJlKCcuLyQuZGVzY3JpcHRvcnMnKQogICwgJGV4cG9ydCAgICAgICAgPSByZXF1aXJlKCcuLyQuZXhwb3J0JykKICAsIHJlZGVmaW5lICAgICAgID0gcmVxdWlyZSgnLi8kLnJlZGVmaW5lJykKICAsICRmYWlscyAgICAgICAgID0gcmVxdWlyZSgnLi8kLmZhaWxzJykKICAsIHNoYXJlZCAgICAgICAgID0gcmVxdWlyZSgnLi8kLnNoYXJlZCcpCiAgLCBzZXRUb1N0cmluZ1RhZyA9IHJlcXVpcmUoJy4vJC5zZXQtdG8tc3RyaW5nLXRhZycpCiAgLCB1aWQgICAgICAgICAgICA9IHJlcXVpcmUoJy4vJC51aWQnKQogICwgd2tzICAgICAgICAgICAgPSByZXF1aXJlKCcuLyQud2tzJykKICAsIGtleU9mICAgICAgICAgID0gcmVxdWlyZSgnLi8kLmtleW9mJykKICAsICRuYW1lcyAgICAgICAgID0gcmVxdWlyZSgnLi8kLmdldC1uYW1lcycpCiAgLCBlbnVtS2V5cyAgICAgICA9IHJlcXVpcmUoJy4vJC5lbnVtLWtleXMnKQogICwgaXNBcnJheSAgICAgICAgPSByZXF1aXJlKCcuLyQuaXMtYXJyYXknKQogICwgYW5PYmplY3QgICAgICAgPSByZXF1aXJlKCcuLyQuYW4tb2JqZWN0JykKICAsIHRvSU9iamVjdCAgICAgID0gcmVxdWlyZSgnLi8kLnRvLWlvYmplY3QnKQogICwgY3JlYXRlRGVzYyAgICAgPSByZXF1aXJlKCcuLyQucHJvcGVydHktZGVzYycpCiAgLCBnZXREZXNjICAgICAgICA9ICQuZ2V0RGVzYwogICwgc2V0RGVzYyAgICAgICAgPSAkLnNldERlc2MKICAsIF9jcmVhdGUgICAgICAgID0gJC5jcmVhdGUKICAsIGdldE5hbWVzICAgICAgID0gJG5hbWVzLmdldAogICwgJFN5bWJvbCAgICAgICAgPSBnbG9iYWwuU3ltYm9sCiAgLCAkSlNPTiAgICAgICAgICA9IGdsb2JhbC5KU09OCiAgLCBfc3RyaW5naWZ5ICAgICA9ICRKU09OICYmICRKU09OLnN0cmluZ2lmeQogICwgc2V0dGVyICAgICAgICAgPSBmYWxzZQogICwgSElEREVOICAgICAgICAgPSB3a3MoJ19oaWRkZW4nKQogICwgaXNFbnVtICAgICAgICAgPSAkLmlzRW51bQogICwgU3ltYm9sUmVnaXN0cnkgPSBzaGFyZWQoJ3N5bWJvbC1yZWdpc3RyeScpCiAgLCBBbGxTeW1ib2xzICAgICA9IHNoYXJlZCgnc3ltYm9scycpCiAgLCB1c2VOYXRpdmUgICAgICA9IHR5cGVvZiAkU3ltYm9sID09ICdmdW5jdGlvbicKICAsIE9iamVjdFByb3RvICAgID0gT2JqZWN0LnByb3RvdHlwZTsKCi8vIGZhbGxiYWNrIGZvciBvbGQgQW5kcm9pZCwgaHR0cHM6Ly9jb2RlLmdvb2dsZS5jb20vcC92OC9pc3N1ZXMvZGV0YWlsP2lkPTY4Nwp2YXIgc2V0U3ltYm9sRGVzYyA9IERFU0NSSVBUT1JTICYmICRmYWlscyhmdW5jdGlvbigpewogIHJldHVybiBfY3JlYXRlKHNldERlc2Moe30sICdhJywgewogICAgZ2V0OiBmdW5jdGlvbigpeyByZXR1cm4gc2V0RGVzYyh0aGlzLCAnYScsIHt2YWx1ZTogN30pLmE7IH0KICB9KSkuYSAhPSA3Owp9KSA/IGZ1bmN0aW9uKGl0LCBrZXksIEQpewogIHZhciBwcm90b0Rlc2MgPSBnZXREZXNjKE9iamVjdFByb3RvLCBrZXkpOwogIGlmKHByb3RvRGVzYylkZWxldGUgT2JqZWN0UHJvdG9ba2V5XTsKICBzZXREZXNjKGl0LCBrZXksIEQpOwogIGlmKHByb3RvRGVzYyAmJiBpdCAhPT0gT2JqZWN0UHJvdG8pc2V0RGVzYyhPYmplY3RQcm90bywga2V5LCBwcm90b0Rlc2MpOwp9IDogc2V0RGVzYzsKCnZhciB3cmFwID0gZnVuY3Rpb24odGFnKXsKICB2YXIgc3ltID0gQWxsU3ltYm9sc1t0YWddID0gX2NyZWF0ZSgkU3ltYm9sLnByb3RvdHlwZSk7CiAgc3ltLl9rID0gdGFnOwogIERFU0NSSVBUT1JTICYmIHNldHRlciAmJiBzZXRTeW1ib2xEZXNjKE9iamVjdFByb3RvLCB0YWcsIHsKICAgIGNvbmZpZ3VyYWJsZTogdHJ1ZSwKICAgIHNldDogZnVuY3Rpb24odmFsdWUpewogICAgICBpZihoYXModGhpcywgSElEREVOKSAmJiBoYXModGhpc1tISURERU5dLCB0YWcpKXRoaXNbSElEREVOXVt0YWddID0gZmFsc2U7CiAgICAgIHNldFN5bWJvbERlc2ModGhpcywgdGFnLCBjcmVhdGVEZXNjKDEsIHZhbHVlKSk7CiAgICB9CiAgfSk7CiAgcmV0dXJuIHN5bTsKfTsKCnZhciBpc1N5bWJvbCA9IGZ1bmN0aW9uKGl0KXsKICByZXR1cm4gdHlwZW9mIGl0ID09ICdzeW1ib2wnOwp9OwoKdmFyICRkZWZpbmVQcm9wZXJ0eSA9IGZ1bmN0aW9uIGRlZmluZVByb3BlcnR5KGl0LCBrZXksIEQpewogIGlmKEQgJiYgaGFzKEFsbFN5bWJvbHMsIGtleSkpewogICAgaWYoIUQuZW51bWVyYWJsZSl7CiAgICAgIGlmKCFoYXMoaXQsIEhJRERFTikpc2V0RGVzYyhpdCwgSElEREVOLCBjcmVhdGVEZXNjKDEsIHt9KSk7CiAgICAgIGl0W0hJRERFTl1ba2V5XSA9IHRydWU7CiAgICB9IGVsc2UgewogICAgICBpZihoYXMoaXQsIEhJRERFTikgJiYgaXRbSElEREVOXVtrZXldKWl0W0hJRERFTl1ba2V5XSA9IGZhbHNlOwogICAgICBEID0gX2NyZWF0ZShELCB7ZW51bWVyYWJsZTogY3JlYXRlRGVzYygwLCBmYWxzZSl9KTsKICAgIH0gcmV0dXJuIHNldFN5bWJvbERlc2MoaXQsIGtleSwgRCk7CiAgfSByZXR1cm4gc2V0RGVzYyhpdCwga2V5LCBEKTsKfTsKdmFyICRkZWZpbmVQcm9wZXJ0aWVzID0gZnVuY3Rpb24gZGVmaW5lUHJvcGVydGllcyhpdCwgUCl7CiAgYW5PYmplY3QoaXQpOwogIHZhciBrZXlzID0gZW51bUtleXMoUCA9IHRvSU9iamVjdChQKSkKICAgICwgaSAgICA9IDAKICAgICwgbCA9IGtleXMubGVuZ3RoCiAgICAsIGtleTsKICB3aGlsZShsID4gaSkkZGVmaW5lUHJvcGVydHkoaXQsIGtleSA9IGtleXNbaSsrXSwgUFtrZXldKTsKICByZXR1cm4gaXQ7Cn07CnZhciAkY3JlYXRlID0gZnVuY3Rpb24gY3JlYXRlKGl0LCBQKXsKICByZXR1cm4gUCA9PT0gdW5kZWZpbmVkID8gX2NyZWF0ZShpdCkgOiAkZGVmaW5lUHJvcGVydGllcyhfY3JlYXRlKGl0KSwgUCk7Cn07CnZhciAkcHJvcGVydHlJc0VudW1lcmFibGUgPSBmdW5jdGlvbiBwcm9wZXJ0eUlzRW51bWVyYWJsZShrZXkpewogIHZhciBFID0gaXNFbnVtLmNhbGwodGhpcywga2V5KTsKICByZXR1cm4gRSB8fCAhaGFzKHRoaXMsIGtleSkgfHwgIWhhcyhBbGxTeW1ib2xzLCBrZXkpIHx8IGhhcyh0aGlzLCBISURERU4pICYmIHRoaXNbSElEREVOXVtrZXldCiAgICA/IEUgOiB0cnVlOwp9Owp2YXIgJGdldE93blByb3BlcnR5RGVzY3JpcHRvciA9IGZ1bmN0aW9uIGdldE93blByb3BlcnR5RGVzY3JpcHRvcihpdCwga2V5KXsKICB2YXIgRCA9IGdldERlc2MoaXQgPSB0b0lPYmplY3QoaXQpLCBrZXkpOwogIGlmKEQgJiYgaGFzKEFsbFN5bWJvbHMsIGtleSkgJiYgIShoYXMoaXQsIEhJRERFTikgJiYgaXRbSElEREVOXVtrZXldKSlELmVudW1lcmFibGUgPSB0cnVlOwogIHJldHVybiBEOwp9Owp2YXIgJGdldE93blByb3BlcnR5TmFtZXMgPSBmdW5jdGlvbiBnZXRPd25Qcm9wZXJ0eU5hbWVzKGl0KXsKICB2YXIgbmFtZXMgID0gZ2V0TmFtZXModG9JT2JqZWN0KGl0KSkKICAgICwgcmVzdWx0ID0gW10KICAgICwgaSAgICAgID0gMAogICAgLCBrZXk7CiAgd2hpbGUobmFtZXMubGVuZ3RoID4gaSlpZighaGFzKEFsbFN5bWJvbHMsIGtleSA9IG5hbWVzW2krK10pICYmIGtleSAhPSBISURERU4pcmVzdWx0LnB1c2goa2V5KTsKICByZXR1cm4gcmVzdWx0Owp9Owp2YXIgJGdldE93blByb3BlcnR5U3ltYm9scyA9IGZ1bmN0aW9uIGdldE93blByb3BlcnR5U3ltYm9scyhpdCl7CiAgdmFyIG5hbWVzICA9IGdldE5hbWVzKHRvSU9iamVjdChpdCkpCiAgICAsIHJlc3VsdCA9IFtdCiAgICAsIGkgICAgICA9IDAKICAgICwga2V5OwogIHdoaWxlKG5hbWVzLmxlbmd0aCA+IGkpaWYoaGFzKEFsbFN5bWJvbHMsIGtleSA9IG5hbWVzW2krK10pKXJlc3VsdC5wdXNoKEFsbFN5bWJvbHNba2V5XSk7CiAgcmV0dXJuIHJlc3VsdDsKfTsKdmFyICRzdHJpbmdpZnkgPSBmdW5jdGlvbiBzdHJpbmdpZnkoaXQpewogIGlmKGl0ID09PSB1bmRlZmluZWQgfHwgaXNTeW1ib2woaXQpKXJldHVybjsgLy8gSUU4IHJldHVybnMgc3RyaW5nIG9uIHVuZGVmaW5lZAogIHZhciBhcmdzID0gW2l0XQogICAgLCBpICAgID0gMQogICAgLCAkJCAgID0gYXJndW1lbnRzCiAgICAsIHJlcGxhY2VyLCAkcmVwbGFjZXI7CiAgd2hpbGUoJCQubGVuZ3RoID4gaSlhcmdzLnB1c2goJCRbaSsrXSk7CiAgcmVwbGFjZXIgPSBhcmdzWzFdOwogIGlmKHR5cGVvZiByZXBsYWNlciA9PSAnZnVuY3Rpb24nKSRyZXBsYWNlciA9IHJlcGxhY2VyOwogIGlmKCRyZXBsYWNlciB8fCAhaXNBcnJheShyZXBsYWNlcikpcmVwbGFjZXIgPSBmdW5jdGlvbihrZXksIHZhbHVlKXsKICAgIGlmKCRyZXBsYWNlcil2YWx1ZSA9ICRyZXBsYWNlci5jYWxsKHRoaXMsIGtleSwgdmFsdWUpOwogICAgaWYoIWlzU3ltYm9sKHZhbHVlKSlyZXR1cm4gdmFsdWU7CiAgfTsKICBhcmdzWzFdID0gcmVwbGFjZXI7CiAgcmV0dXJuIF9zdHJpbmdpZnkuYXBwbHkoJEpTT04sIGFyZ3MpOwp9Owp2YXIgYnVnZ3lKU09OID0gJGZhaWxzKGZ1bmN0aW9uKCl7CiAgdmFyIFMgPSAkU3ltYm9sKCk7CiAgLy8gTVMgRWRnZSBjb252ZXJ0cyBzeW1ib2wgdmFsdWVzIHRvIEpTT04gYXMge30KICAvLyBXZWJLaXQgY29udmVydHMgc3ltYm9sIHZhbHVlcyB0byBKU09OIGFzIG51bGwKICAvLyBWOCB0aHJvd3Mgb24gYm94ZWQgc3ltYm9scwogIHJldHVybiBfc3RyaW5naWZ5KFtTXSkgIT0gJ1tudWxsXScgfHwgX3N0cmluZ2lmeSh7YTogU30pICE9ICd7fScgfHwgX3N0cmluZ2lmeShPYmplY3QoUykpICE9ICd7fSc7Cn0pOwoKLy8gMTkuNC4xLjEgU3ltYm9sKFtkZXNjcmlwdGlvbl0pCmlmKCF1c2VOYXRpdmUpewogICRTeW1ib2wgPSBmdW5jdGlvbiBTeW1ib2woKXsKICAgIGlmKGlzU3ltYm9sKHRoaXMpKXRocm93IFR5cGVFcnJvcignU3ltYm9sIGlzIG5vdCBhIGNvbnN0cnVjdG9yJyk7CiAgICByZXR1cm4gd3JhcCh1aWQoYXJndW1lbnRzLmxlbmd0aCA+IDAgPyBhcmd1bWVudHNbMF0gOiB1bmRlZmluZWQpKTsKICB9OwogIHJlZGVmaW5lKCRTeW1ib2wucHJvdG90eXBlLCAndG9TdHJpbmcnLCBmdW5jdGlvbiB0b1N0cmluZygpewogICAgcmV0dXJuIHRoaXMuX2s7CiAgfSk7CgogIGlzU3ltYm9sID0gZnVuY3Rpb24oaXQpewogICAgcmV0dXJuIGl0IGluc3RhbmNlb2YgJFN5bWJvbDsKICB9OwoKICAkLmNyZWF0ZSAgICAgPSAkY3JlYXRlOwogICQuaXNFbnVtICAgICA9ICRwcm9wZXJ0eUlzRW51bWVyYWJsZTsKICAkLmdldERlc2MgICAgPSAkZ2V0T3duUHJvcGVydHlEZXNjcmlwdG9yOwogICQuc2V0RGVzYyAgICA9ICRkZWZpbmVQcm9wZXJ0eTsKICAkLnNldERlc2NzICAgPSAkZGVmaW5lUHJvcGVydGllczsKICAkLmdldE5hbWVzICAgPSAkbmFtZXMuZ2V0ID0gJGdldE93blByb3BlcnR5TmFtZXM7CiAgJC5nZXRTeW1ib2xzID0gJGdldE93blByb3BlcnR5U3ltYm9sczsKCiAgaWYoREVTQ1JJUFRPUlMgJiYgIXJlcXVpcmUoJy4vJC5saWJyYXJ5JykpewogICAgcmVkZWZpbmUoT2JqZWN0UHJvdG8sICdwcm9wZXJ0eUlzRW51bWVyYWJsZScsICRwcm9wZXJ0eUlzRW51bWVyYWJsZSwgdHJ1ZSk7CiAgfQp9Cgp2YXIgc3ltYm9sU3RhdGljcyA9IHsKICAvLyAxOS40LjIuMSBTeW1ib2wuZm9yKGtleSkKICAnZm9yJzogZnVuY3Rpb24oa2V5KXsKICAgIHJldHVybiBoYXMoU3ltYm9sUmVnaXN0cnksIGtleSArPSAnJykKICAgICAgPyBTeW1ib2xSZWdpc3RyeVtrZXldCiAgICAgIDogU3ltYm9sUmVnaXN0cnlba2V5XSA9ICRTeW1ib2woa2V5KTsKICB9LAogIC8vIDE5LjQuMi41IFN5bWJvbC5rZXlGb3Ioc3ltKQogIGtleUZvcjogZnVuY3Rpb24ga2V5Rm9yKGtleSl7CiAgICByZXR1cm4ga2V5T2YoU3ltYm9sUmVnaXN0cnksIGtleSk7CiAgfSwKICB1c2VTZXR0ZXI6IGZ1bmN0aW9uKCl7IHNldHRlciA9IHRydWU7IH0sCiAgdXNlU2ltcGxlOiBmdW5jdGlvbigpeyBzZXR0ZXIgPSBmYWxzZTsgfQp9OwovLyAxOS40LjIuMiBTeW1ib2wuaGFzSW5zdGFuY2UKLy8gMTkuNC4yLjMgU3ltYm9sLmlzQ29uY2F0U3ByZWFkYWJsZQovLyAxOS40LjIuNCBTeW1ib2wuaXRlcmF0b3IKLy8gMTkuNC4yLjYgU3ltYm9sLm1hdGNoCi8vIDE5LjQuMi44IFN5bWJvbC5yZXBsYWNlCi8vIDE5LjQuMi45IFN5bWJvbC5zZWFyY2gKLy8gMTkuNC4yLjEwIFN5bWJvbC5zcGVjaWVzCi8vIDE5LjQuMi4xMSBTeW1ib2wuc3BsaXQKLy8gMTkuNC4yLjEyIFN5bWJvbC50b1ByaW1pdGl2ZQovLyAxOS40LjIuMTMgU3ltYm9sLnRvU3RyaW5nVGFnCi8vIDE5LjQuMi4xNCBTeW1ib2wudW5zY29wYWJsZXMKJC5lYWNoLmNhbGwoKAogICdoYXNJbnN0YW5jZSxpc0NvbmNhdFNwcmVhZGFibGUsaXRlcmF0b3IsbWF0Y2gscmVwbGFjZSxzZWFyY2gsJyArCiAgJ3NwZWNpZXMsc3BsaXQsdG9QcmltaXRpdmUsdG9TdHJpbmdUYWcsdW5zY29wYWJsZXMnCikuc3BsaXQoJywnKSwgZnVuY3Rpb24oaXQpewogIHZhciBzeW0gPSB3a3MoaXQpOwogIHN5bWJvbFN0YXRpY3NbaXRdID0gdXNlTmF0aXZlID8gc3ltIDogd3JhcChzeW0pOwp9KTsKCnNldHRlciA9IHRydWU7CgokZXhwb3J0KCRleHBvcnQuRyArICRleHBvcnQuVywge1N5bWJvbDogJFN5bWJvbH0pOwoKJGV4cG9ydCgkZXhwb3J0LlMsICdTeW1ib2wnLCBzeW1ib2xTdGF0aWNzKTsKCiRleHBvcnQoJGV4cG9ydC5TICsgJGV4cG9ydC5GICogIXVzZU5hdGl2ZSwgJ09iamVjdCcsIHsKICAvLyAxOS4xLjIuMiBPYmplY3QuY3JlYXRlKE8gWywgUHJvcGVydGllc10pCiAgY3JlYXRlOiAkY3JlYXRlLAogIC8vIDE5LjEuMi40IE9iamVjdC5kZWZpbmVQcm9wZXJ0eShPLCBQLCBBdHRyaWJ1dGVzKQogIGRlZmluZVByb3BlcnR5OiAkZGVmaW5lUHJvcGVydHksCiAgLy8gMTkuMS4yLjMgT2JqZWN0LmRlZmluZVByb3BlcnRpZXMoTywgUHJvcGVydGllcykKICBkZWZpbmVQcm9wZXJ0aWVzOiAkZGVmaW5lUHJvcGVydGllcywKICAvLyAxOS4xLjIuNiBPYmplY3QuZ2V0T3duUHJvcGVydHlEZXNjcmlwdG9yKE8sIFApCiAgZ2V0T3duUHJvcGVydHlEZXNjcmlwdG9yOiAkZ2V0T3duUHJvcGVydHlEZXNjcmlwdG9yLAogIC8vIDE5LjEuMi43IE9iamVjdC5nZXRPd25Qcm9wZXJ0eU5hbWVzKE8pCiAgZ2V0T3duUHJvcGVydHlOYW1lczogJGdldE93blByb3BlcnR5TmFtZXMsCiAgLy8gMTkuMS4yLjggT2JqZWN0LmdldE93blByb3BlcnR5U3ltYm9scyhPKQogIGdldE93blByb3BlcnR5U3ltYm9sczogJGdldE93blByb3BlcnR5U3ltYm9scwp9KTsKCi8vIDI0LjMuMiBKU09OLnN0cmluZ2lmeSh2YWx1ZSBbLCByZXBsYWNlciBbLCBzcGFjZV1dKQokSlNPTiAmJiAkZXhwb3J0KCRleHBvcnQuUyArICRleHBvcnQuRiAqICghdXNlTmF0aXZlIHx8IGJ1Z2d5SlNPTiksICdKU09OJywge3N0cmluZ2lmeTogJHN0cmluZ2lmeX0pOwoKLy8gMTkuNC4zLjUgU3ltYm9sLnByb3RvdHlwZVtAQHRvU3RyaW5nVGFnXQpzZXRUb1N0cmluZ1RhZygkU3ltYm9sLCAnU3ltYm9sJyk7Ci8vIDIwLjIuMS45IE1hdGhbQEB0b1N0cmluZ1RhZ10Kc2V0VG9TdHJpbmdUYWcoTWF0aCwgJ01hdGgnLCB0cnVlKTsKLy8gMjQuMy4zIEpTT05bQEB0b1N0cmluZ1RhZ10Kc2V0VG9TdHJpbmdUYWcoZ2xvYmFsLkpTT04sICdKU09OJywgdHJ1ZSk7Cn0seyIuLyQiOjU4LCIuLyQuYW4tb2JqZWN0IjozMCwiLi8kLmRlc2NyaXB0b3JzIjozNiwiLi8kLmVudW0ta2V5cyI6MzgsIi4vJC5leHBvcnQiOjM5LCIuLyQuZmFpbHMiOjQwLCIuLyQuZ2V0LW5hbWVzIjo0MiwiLi8kLmdsb2JhbCI6NDMsIi4vJC5oYXMiOjQ0LCIuLyQuaXMtYXJyYXkiOjUwLCIuLyQua2V5b2YiOjU5LCIuLyQubGlicmFyeSI6NjAsIi4vJC5wcm9wZXJ0eS1kZXNjIjo2MywiLi8kLnJlZGVmaW5lIjo2NSwiLi8kLnNldC10by1zdHJpbmctdGFnIjo2OSwiLi8kLnNoYXJlZCI6NzAsIi4vJC50by1pb2JqZWN0Ijo3NiwiLi8kLnVpZCI6NzksIi4vJC53a3MiOjgwfV0sOTE6W2Z1bmN0aW9uKHJlcXVpcmUsbW9kdWxlLGV4cG9ydHMpewpyZXF1aXJlKCcuL2VzNi5hcnJheS5pdGVyYXRvcicpOwp2YXIgSXRlcmF0b3JzID0gcmVxdWlyZSgnLi8kLml0ZXJhdG9ycycpOwpJdGVyYXRvcnMuTm9kZUxpc3QgPSBJdGVyYXRvcnMuSFRNTENvbGxlY3Rpb24gPSBJdGVyYXRvcnMuQXJyYXk7Cn0seyIuLyQuaXRlcmF0b3JzIjo1NywiLi9lczYuYXJyYXkuaXRlcmF0b3IiOjgyfV0sOTI6W2Z1bmN0aW9uKHJlcXVpcmUsbW9kdWxlLGV4cG9ydHMpewondXNlIHN0cmljdCc7Cgp2YXIgX2dldCA9IHJlcXVpcmUoJ2JhYmVsLXJ1bnRpbWUvaGVscGVycy9nZXQnKVsnZGVmYXVsdCddOwoKdmFyIF9pbmhlcml0cyA9IHJlcXVpcmUoJ2JhYmVsLXJ1bnRpbWUvaGVscGVycy9pbmhlcml0cycpWydkZWZhdWx0J107Cgp2YXIgX2NyZWF0ZUNsYXNzID0gcmVxdWlyZSgnYmFiZWwtcnVudGltZS9oZWxwZXJzL2NyZWF0ZS1jbGFzcycpWydkZWZhdWx0J107Cgp2YXIgX2NsYXNzQ2FsbENoZWNrID0gcmVxdWlyZSgnYmFiZWwtcnVudGltZS9oZWxwZXJzL2NsYXNzLWNhbGwtY2hlY2snKVsnZGVmYXVsdCddOwoKdmFyIF9Qcm9taXNlID0gcmVxdWlyZSgnYmFiZWwtcnVudGltZS9jb3JlLWpzL3Byb21pc2UnKVsnZGVmYXVsdCddOwoKdmFyIF9pbnRlcm9wUmVxdWlyZURlZmF1bHQgPSByZXF1aXJlKCdiYWJlbC1ydW50aW1lL2hlbHBlcnMvaW50ZXJvcC1yZXF1aXJlLWRlZmF1bHQnKVsnZGVmYXVsdCddOwoKT2JqZWN0LmRlZmluZVByb3BlcnR5KGV4cG9ydHMsICdfX2VzTW9kdWxlJywgewogIHZhbHVlOiB0cnVlCn0pOwoKdmFyIF91dGlsc0V2ZW50RW1pdHRlciA9IHJlcXVpcmUoJy4uL3V0aWxzL0V2ZW50RW1pdHRlcicpOwoKdmFyIF91dGlsc0V2ZW50RW1pdHRlcjIgPSBfaW50ZXJvcFJlcXVpcmVEZWZhdWx0KF91dGlsc0V2ZW50RW1pdHRlcik7Cgp2YXIgX3BhcnRpY2lwYW50ID0gcmVxdWlyZSgnLi9wYXJ0aWNpcGFudCcpOwoKdmFyIF9wYXJ0aWNpcGFudDIgPSBfaW50ZXJvcFJlcXVpcmVEZWZhdWx0KF9wYXJ0aWNpcGFudCk7Cgp2YXIgQ2hhdEdyb3VwID0gKGZ1bmN0aW9uIChfRXZlbnRFbWl0dGVyKSB7CiAgX2luaGVyaXRzKENoYXRHcm91cCwgX0V2ZW50RW1pdHRlcik7CgogIGZ1bmN0aW9uIENoYXRHcm91cChzeW5jaGVyLCBoeXBlcnR5RGlzY292ZXJ5LCBkb21haW4pIHsKICAgIF9jbGFzc0NhbGxDaGVjayh0aGlzLCBDaGF0R3JvdXApOwoKICAgIGlmICghc3luY2hlcikgdGhyb3cgRXJyb3IoJ1N5bmNoZXIgaXMgYSBuZWNlc3NhcnkgZGVwZW5kZWN5Jyk7CiAgICBpZiAoIWh5cGVydHlEaXNjb3ZlcnkpIHRocm93IEVycm9yKCdIeXBlcnR5IGRpc2NvdmVyIGlzIGEgbmVjZXNzYXJ5IGRlcGVuZGVjeScpOwoKICAgIF9nZXQoT2JqZWN0LmdldFByb3RvdHlwZU9mKENoYXRHcm91cC5wcm90b3R5cGUpLCAnY29uc3RydWN0b3InLCB0aGlzKS5jYWxsKHRoaXMsIHN5bmNoZXIsIGh5cGVydHlEaXNjb3ZlcnkpOwoKICAgIHZhciBfdGhpcyA9IHRoaXM7CiAgICBfdGhpcy5fc3luY2hlciA9IHN5bmNoZXI7CiAgICBfdGhpcy5faHlwZXJ0eURpc2NvdmVyeSA9IGh5cGVydHlEaXNjb3Zlcnk7CgogICAgX3RoaXMuX29iamVjdERlc2NVUkwgPSAnaHlwZXJ0eS1jYXRhbG9ndWU6Ly8nICsgZG9tYWluICsgJy8ud2VsbC1rbm93bi9kYXRhc2NoZW1hcy9GYWtlRGF0YVNjaGVtYSc7CiAgfQoKICBfY3JlYXRlQ2xhc3MoQ2hhdEdyb3VwLCBbewogICAga2V5OiAncHJvY2Vzc1BhcnRpcGFudHMnLAogICAgdmFsdWU6IGZ1bmN0aW9uIHByb2Nlc3NQYXJ0aXBhbnRzKGRhdGFPYmplY3QpIHsKICAgICAgdmFyIF90aGlzID0gdGhpczsKICAgICAgdmFyIHBhcnRpY2lwYW50cyA9IGRhdGFPYmplY3QuZGF0YS5jb21tdW5pY2F0aW9uLnBhcnRpY2lwYW50czsKCiAgICAgIGNvbnNvbGUubG9nKCdQcm9jZXNzIFBhcnRpY2lwYW50czogJywgcGFydGljaXBhbnRzKTsKCiAgICAgIHBhcnRpY2lwYW50cy5mb3JFYWNoKGZ1bmN0aW9uIChwYXJ0aWNpcGFudCkgewogICAgICAgIGlmIChkYXRhT2JqZWN0Ll9vd25lciAhPT0gcGFydGljaXBhbnQuaHlwZXJ0eVJlc291cmNlKSB7CiAgICAgICAgICBjb25zb2xlLmxvZygnRWFjaCBQYXJ0aWNpcGFudCB3aWxsIGJlIHRyaWdnZXI6ICcsIHBhcnRpY2lwYW50KTsKICAgICAgICAgIF90aGlzLnRyaWdnZXIoJ3BhcnRpY2lwYW50OmFkZGVkJywgcGFydGljaXBhbnQpOwogICAgICAgIH0KICAgICAgfSk7CiAgICB9CgogICAgLyoqCiAgICAgKiBQcm9jZXNzIGNoaWxkcmVuIG1lc3NhZ2VzCiAgICAgKiBAcGFyYW0gIHtbdHlwZV19IGNoaWxkcmVuIFtkZXNjcmlwdGlvbl0KICAgICAqIEByZXR1cm4ge1t0eXBlXX0gICAgICAgICAgW2Rlc2NyaXB0aW9uXQogICAgICovCiAgfSwgewogICAga2V5OiAnX3Byb2Nlc3NDaGlsZHJlbicsCiAgICB2YWx1ZTogZnVuY3Rpb24gX3Byb2Nlc3NDaGlsZHJlbihjaGlsZHJlbikgewogICAgICB2YXIgX3RoaXMgPSB0aGlzOwoKICAgICAgY29uc29sZS5pbmZvKCdQcm9jZXNzIE1lc3NhZ2U6JywgY2hpbGRyZW4pOwoKICAgICAgX3RoaXMudHJpZ2dlcignbmV3Om1lc3NhZ2U6cmVjaXZlZCcsIGNoaWxkcmVuKTsKICAgIH0KCiAgICAvKioKICAgICAqIFRoaXMgZnVuY3Rpb24gaXMgdXNlZCB0byBzZW5kIGEgY2hhdCBtZXNzYWdlLgogICAgICogQHBhcmFtICB7TWVzc2FnZX0gbWVzc2FnZSB0ZXh0IHRvIGJlIHNlbmQKICAgICAqLwogIH0sIHsKICAgIGtleTogJ3NlbmQnLAogICAgdmFsdWU6IGZ1bmN0aW9uIHNlbmQobWVzc2FnZSkgewogICAgICBjb25zb2xlLmxvZyhtZXNzYWdlLCB0aGlzKTsKICAgICAgdmFyIF90aGlzID0gdGhpczsKICAgICAgdmFyIGRhdGFPYmplY3QgPSBfdGhpcy5kYXRhT2JqZWN0UmVwb3J0ZXIgPyBfdGhpcy5kYXRhT2JqZWN0UmVwb3J0ZXIgOiBfdGhpcy5kYXRhT2JqZWN0T2JzZXJ2ZXI7CgogICAgICByZXR1cm4gbmV3IF9Qcm9taXNlKGZ1bmN0aW9uIChyZXNvbHZlLCByZWplY3QpIHsKCiAgICAgICAgZGF0YU9iamVjdC5hZGRDaGlsZHJlbignbWVzc2FnZScsIHsgY2hhdE1lc3NhZ2U6IG1lc3NhZ2UgfSkudGhlbihmdW5jdGlvbiAoZGF0YU9iamVjdENoaWxkKSB7CiAgICAgICAgICBjb25zb2xlLmluZm8oZGF0YU9iamVjdENoaWxkKTsKICAgICAgICAgIHZhciBtc2cgPSB7CiAgICAgICAgICAgIGNoaWxkSWQ6IGRhdGFPYmplY3RDaGlsZC5fY2hpbGRJZCwKICAgICAgICAgICAgZnJvbTogZGF0YU9iamVjdENoaWxkLl9vd25lciwKICAgICAgICAgICAgdmFsdWU6IGRhdGFPYmplY3RDaGlsZC5kYXRhCiAgICAgICAgICB9OwoKICAgICAgICAgIF90aGlzLl9wcm9jZXNzQ2hpbGRyZW4obXNnKTsKICAgICAgICAgIHJlc29sdmUoZGF0YU9iamVjdENoaWxkKTsKICAgICAgICB9KVsnY2F0Y2gnXShmdW5jdGlvbiAocmVhc29uKSB7CiAgICAgICAgICBjb25zb2xlLmVycm9yKCdSZWFzb246JywgcmVhc29uKTsKICAgICAgICAgIHJlamVjdChyZWFzb24pOwogICAgICAgIH0pOwogICAgICB9KTsKICAgIH0KCiAgICAvKioKICAgICAqIFRoaXMgZnVuY3Rpb24gaXMgdXNlZCB0byBjbG9zZSBhbiBleGlzdGluZyBHcm91cCBDaGF0IGluc3RhbmNlLgogICAgICoKICAgICAqLwogIH0sIHsKICAgIGtleTogJ2Nsb3NlJywKICAgIHZhbHVlOiBmdW5jdGlvbiBjbG9zZSgpIHt9CiAgfSwgewogICAga2V5OiAnam9pbicsCiAgICB2YWx1ZTogZnVuY3Rpb24gam9pbihyZXNvdXJjZSkgewoKICAgICAgdmFyIF90aGlzID0gdGhpczsKCiAgICAgIHJldHVybiBuZXcgX1Byb21pc2UoZnVuY3Rpb24gKHJlc29sdmUsIHJlamVjdCkgewoKICAgICAgICBfdGhpcy5hZGRQYXJ0aWNpcGFudChyZXNvdXJjZSkudGhlbihmdW5jdGlvbiAocmVzdWx0KSB7CiAgICAgICAgICByZXNvbHZlKCdqb2luZWQ6ICcsIHJlc3VsdCk7CiAgICAgICAgfSlbJ2NhdGNoJ10oZnVuY3Rpb24gKHJlYXNvbikgewogICAgICAgICAgcmVqZWN0KHJlYXNvbik7CiAgICAgICAgfSk7CiAgICAgIH0pOwogICAgfQoKICAgIC8vIFRPRE86IGltcHJvdmUgdGhpcyB3aXRoIGFuIGludml0ZTsKICAgIC8qKgogICAgICogVGhpcyBmdW5jdGlvbiBpcyB1c2VkIHRvIGFkZCAvIGludml0ZSBuZXcgcGFydGljaXBhbnQgb24gYW4gZXhpc3RpbmcgR3JvdXAgQ2hhdCBpbnN0YW5jZS4KICAgICAqIEByZXR1cm4ge1Byb21pc2V9IFByb21pc2Ugd2l0aCB0aGUgc3RhdHVzCiAgICAgKi8KICB9LCB7CiAgICBrZXk6ICdhZGRQYXJ0aWNpcGFudCcsCiAgICB2YWx1ZTogZnVuY3Rpb24gYWRkUGFydGljaXBhbnQoZW1haWwpIHsKCiAgICAgIHZhciBfdGhpcyA9IHRoaXM7CiAgICAgIHZhciBzeW5jaGVyID0gX3RoaXMuX3N5bmNoZXI7CgogICAgICByZXR1cm4gbmV3IF9Qcm9taXNlKGZ1bmN0aW9uIChyZXNvbHZlLCByZWplY3QpIHt9KTsKICAgIH0KCiAgICAvKioKICAgICAqIFRoaXMgZnVuY3Rpb24gaXMgdXNlZCB0byByZW1vdmUgYSBwYXJ0aWNpcGFudCBmcm9tIGFuIGV4aXN0aW5nIEdyb3VwIENoYXQgaW5zdGFuY2UuCiAgICAgKiBAcmV0dXJuIHtQcm9taXNlfSBQcm9taXNlIHdpdGggdGhlIHN0YXR1cwogICAgICovCiAgfSwgewogICAga2V5OiAncmVtb3ZlUGFydGljaXBhbnQnLAogICAgdmFsdWU6IGZ1bmN0aW9uIHJlbW92ZVBhcnRpY2lwYW50KCkgewogICAgICByZXR1cm4gbmV3IF9Qcm9taXNlKGZ1bmN0aW9uIChyZXNvbHZlLCByZWplY3QpIHsKCiAgICAgICAgdHJ5IHsKICAgICAgICAgIHJlc29sdmUoJ3BhcnRpY2lwYW50IHJlbW92ZWQnKTsKICAgICAgICB9IGNhdGNoIChlKSB7CiAgICAgICAgICByZWplY3QoJ3JlbW92ZSBwYXJ0aWNpcGFudCBmYWlsJyk7CiAgICAgICAgfQogICAgICB9KTsKICAgIH0KCiAgICAvKioKICAgICAqIFRoaXMgZnVuY3Rpb24gaXMgdXNlZCB0byBvcGVuIGEgR3JvdXAgQ2hhdCBpbnN0YW5jZSB0aGF0IHdhcyBwcmV2aW91c2x5IGNsb3NlZC4KICAgICAqIEByZXR1cm4ge1t0eXBlXX0gW2Rlc2NyaXB0aW9uXQogICAgICovCiAgfSwgewogICAga2V5OiAnb3BlbicsCiAgICB2YWx1ZTogZnVuY3Rpb24gb3BlbigpIHt9CiAgfSwgewogICAga2V5OiAnZGF0YU9iamVjdFJlcG9ydGVyJywKICAgIHNldDogZnVuY3Rpb24gc2V0KGRhdGFPYmplY3RSZXBvcnRlcikgewoKICAgICAgaWYgKCFkYXRhT2JqZWN0UmVwb3J0ZXIpIHRocm93IG5ldyBFcnJvcignVGhlIGRhdGEgb2JqZWN0IHJlcG9ydGVyIGlzIG5lY2Vzc2FyeSBwYXJhbWV0ZXInKTsKCiAgICAgIHZhciBfdGhpcyA9IHRoaXM7CiAgICAgIF90aGlzLl9kYXRhT2JqZWN0UmVwb3J0ZXIgPSBkYXRhT2JqZWN0UmVwb3J0ZXI7CgogICAgICBjb25zb2xlLmluZm8oJ1NldCBkYXRhIG9iamVjdCByZXBvcnRlcjogJywgZGF0YU9iamVjdFJlcG9ydGVyKTsKCiAgICAgIGRhdGFPYmplY3RSZXBvcnRlci5vblN1YnNjcmlwdGlvbihmdW5jdGlvbiAoZXZlbnQpIHsKCiAgICAgICAgZXZlbnQuYWNjZXB0KCk7CgogICAgICAgIC8vIFNldCB0aGUgb3RoZXIgc3Vic2NyaXB0aW9uIGxpa2UgYSBwYXJ0aWNpcGFudAogICAgICAgIF9wYXJ0aWNpcGFudDJbJ2RlZmF1bHQnXS5oeXBlcnR5UmVzb3VyY2UgPSBldmVudC51cmw7CiAgICAgICAgZGF0YU9iamVjdFJlcG9ydGVyLmRhdGEuY29tbXVuaWNhdGlvbi5wYXJ0aWNpcGFudHMucHVzaChfcGFydGljaXBhbnQyWydkZWZhdWx0J10pOwoKICAgICAgICBfdGhpcy50cmlnZ2VyKCdwYXJ0aWNpcGFudDphZGRlZCcsIF9wYXJ0aWNpcGFudDJbJ2RlZmF1bHQnXSk7CiAgICAgIH0pOwoKICAgICAgZGF0YU9iamVjdFJlcG9ydGVyLm9uQWRkQ2hpbGRyZW4oZnVuY3Rpb24gKGNoaWxkcmVuKSB7CiAgICAgICAgX3RoaXMuX3Byb2Nlc3NDaGlsZHJlbihjaGlsZHJlbik7CiAgICAgIH0pOwogICAgfSwKICAgIGdldDogZnVuY3Rpb24gZ2V0KCkgewogICAgICB2YXIgX3RoaXMgPSB0aGlzOwogICAgICByZXR1cm4gX3RoaXMuX2RhdGFPYmplY3RSZXBvcnRlcjsKICAgIH0KICB9LCB7CiAgICBrZXk6ICdkYXRhT2JqZWN0T2JzZXJ2ZXInLAogICAgc2V0OiBmdW5jdGlvbiBzZXQoZGF0YU9iamVjdE9ic2VydmVyKSB7CiAgICAgIHZhciBfdGhpcyA9IHRoaXM7CgogICAgICBfdGhpcy5fZGF0YU9iamVjdE9ic2VydmVyID0gZGF0YU9iamVjdE9ic2VydmVyOwoKICAgICAgX3RoaXMucHJvY2Vzc1BhcnRpcGFudHMoZGF0YU9iamVjdE9ic2VydmVyKTsKCiAgICAgIGRhdGFPYmplY3RPYnNlcnZlci5vbkNoYW5nZSgnKicsIGZ1bmN0aW9uIChldmVudCkgewogICAgICAgIGNvbnNvbGUuaW5mbygnQ2hhbmdlIEV2ZW50OiAnLCBldmVudCk7CiAgICAgICAgX3RoaXMucHJvY2Vzc1BhcnRpcGFudHMoZGF0YU9iamVjdE9ic2VydmVyKTsKICAgICAgfSk7CgogICAgICBkYXRhT2JqZWN0T2JzZXJ2ZXIub25BZGRDaGlsZHJlbihmdW5jdGlvbiAoY2hpbGRyZW4pIHsKICAgICAgICBfdGhpcy5fcHJvY2Vzc0NoaWxkcmVuKGNoaWxkcmVuKTsKICAgICAgfSk7CiAgICB9LAogICAgZ2V0OiBmdW5jdGlvbiBnZXQoKSB7CiAgICAgIHZhciBfdGhpcyA9IHRoaXM7CiAgICAgIHJldHVybiBfdGhpcy5fZGF0YU9iamVjdE9ic2VydmVyOwogICAgfQogIH0sIHsKICAgIGtleTogJ2RhdGFPYmplY3QnLAogICAgZ2V0OiBmdW5jdGlvbiBnZXQoKSB7CiAgICAgIHZhciBfdGhpcyA9IHRoaXM7CiAgICAgIHJldHVybiBfdGhpcy5fZGF0YU9iamVjdFJlcG9ydGVyID8gX3RoaXMuZGF0YU9iamVjdFJlcG9ydGVyIDogX3RoaXMuZGF0YU9iamVjdE9ic2VydmVyOwogICAgfQogIH1dKTsKCiAgcmV0dXJuIENoYXRHcm91cDsKfSkoX3V0aWxzRXZlbnRFbWl0dGVyMlsnZGVmYXVsdCddKTsKCmV4cG9ydHNbJ2RlZmF1bHQnXSA9IENoYXRHcm91cDsKbW9kdWxlLmV4cG9ydHMgPSBleHBvcnRzWydkZWZhdWx0J107Cgp9LHsiLi4vdXRpbHMvRXZlbnRFbWl0dGVyIjoxMDQsIi4vcGFydGljaXBhbnQiOjk1LCJiYWJlbC1ydW50aW1lL2NvcmUtanMvcHJvbWlzZSI6NywiYmFiZWwtcnVudGltZS9oZWxwZXJzL2NsYXNzLWNhbGwtY2hlY2siOjEwLCJiYWJlbC1ydW50aW1lL2hlbHBlcnMvY3JlYXRlLWNsYXNzIjoxMiwiYmFiZWwtcnVudGltZS9oZWxwZXJzL2dldCI6MTQsImJhYmVsLXJ1bnRpbWUvaGVscGVycy9pbmhlcml0cyI6MTUsImJhYmVsLXJ1bnRpbWUvaGVscGVycy9pbnRlcm9wLXJlcXVpcmUtZGVmYXVsdCI6MTZ9XSw5MzpbZnVuY3Rpb24ocmVxdWlyZSxtb2R1bGUsZXhwb3J0cyl7Cid1c2Ugc3RyaWN0JzsKCnZhciBfZ2V0ID0gcmVxdWlyZSgnYmFiZWwtcnVudGltZS9oZWxwZXJzL2dldCcpWydkZWZhdWx0J107Cgp2YXIgX2luaGVyaXRzID0gcmVxdWlyZSgnYmFiZWwtcnVudGltZS9oZWxwZXJzL2luaGVyaXRzJylbJ2RlZmF1bHQnXTsKCnZhciBfY3JlYXRlQ2xhc3MgPSByZXF1aXJlKCdiYWJlbC1ydW50aW1lL2hlbHBlcnMvY3JlYXRlLWNsYXNzJylbJ2RlZmF1bHQnXTsKCnZhciBfY2xhc3NDYWxsQ2hlY2sgPSByZXF1aXJlKCdiYWJlbC1ydW50aW1lL2hlbHBlcnMvY2xhc3MtY2FsbC1jaGVjaycpWydkZWZhdWx0J107Cgp2YXIgX1Byb21pc2UgPSByZXF1aXJlKCdiYWJlbC1ydW50aW1lL2NvcmUtanMvcHJvbWlzZScpWydkZWZhdWx0J107Cgp2YXIgX2ludGVyb3BSZXF1aXJlRGVmYXVsdCA9IHJlcXVpcmUoJ2JhYmVsLXJ1bnRpbWUvaGVscGVycy9pbnRlcm9wLXJlcXVpcmUtZGVmYXVsdCcpWydkZWZhdWx0J107CgpPYmplY3QuZGVmaW5lUHJvcGVydHkoZXhwb3J0cywgJ19fZXNNb2R1bGUnLCB7CiAgdmFsdWU6IHRydWUKfSk7CmV4cG9ydHNbJ2RlZmF1bHQnXSA9IGFjdGl2YXRlOwoKdmFyIF9oeXBlcnR5RGlzY292ZXJ5SHlwZXJ0eURpc2NvdmVyeSA9IHJlcXVpcmUoJy4uL2h5cGVydHktZGlzY292ZXJ5L0h5cGVydHlEaXNjb3ZlcnknKTsKCnZhciBfaHlwZXJ0eURpc2NvdmVyeUh5cGVydHlEaXNjb3ZlcnkyID0gX2ludGVyb3BSZXF1aXJlRGVmYXVsdChfaHlwZXJ0eURpc2NvdmVyeUh5cGVydHlEaXNjb3ZlcnkpOwoKdmFyIF91dGlsc0V2ZW50RW1pdHRlciA9IHJlcXVpcmUoJy4uL3V0aWxzL0V2ZW50RW1pdHRlcicpOwoKdmFyIF91dGlsc0V2ZW50RW1pdHRlcjIgPSBfaW50ZXJvcFJlcXVpcmVEZWZhdWx0KF91dGlsc0V2ZW50RW1pdHRlcik7Cgp2YXIgX2NvbW11bmljYXRpb24gPSByZXF1aXJlKCcuL2NvbW11bmljYXRpb24nKTsKCnZhciBfY29tbXVuaWNhdGlvbjIgPSBfaW50ZXJvcFJlcXVpcmVEZWZhdWx0KF9jb21tdW5pY2F0aW9uKTsKCnZhciBfdXRpbHNVdGlscyA9IHJlcXVpcmUoJy4uL3V0aWxzL3V0aWxzJyk7Cgp2YXIgX3N5bmNoZXJTeW5jaGVyID0gcmVxdWlyZSgnLi4vc3luY2hlci9TeW5jaGVyJyk7Cgp2YXIgX3N5bmNoZXJTeW5jaGVyMiA9IF9pbnRlcm9wUmVxdWlyZURlZmF1bHQoX3N5bmNoZXJTeW5jaGVyKTsKCnZhciBfcGFydGljaXBhbnQgPSByZXF1aXJlKCcuL3BhcnRpY2lwYW50Jyk7Cgp2YXIgX3BhcnRpY2lwYW50MiA9IF9pbnRlcm9wUmVxdWlyZURlZmF1bHQoX3BhcnRpY2lwYW50KTsKCnZhciBfQ2hhdCA9IHJlcXVpcmUoJy4vQ2hhdCcpOwoKdmFyIF9DaGF0MiA9IF9pbnRlcm9wUmVxdWlyZURlZmF1bHQoX0NoYXQpOwoKLyoqCiogSHlwZXJ0eSBDaGF0OwoqIEBhdXRob3IgVml0b3IgU2lsdmEgW3ZpdG9yLXQtc2lsdmFAdGVsZWNvbS5wdF0KKiBAdmVyc2lvbiAwLjEuMAoqLwoKdmFyIEh5cGVydHlDaGF0ID0gKGZ1bmN0aW9uIChfRXZlbnRFbWl0dGVyKSB7CiAgX2luaGVyaXRzKEh5cGVydHlDaGF0LCBfRXZlbnRFbWl0dGVyKTsKCiAgZnVuY3Rpb24gSHlwZXJ0eUNoYXQoaHlwZXJ0eVVSTCwgYnVzLCBjb25maWd1cmF0aW9uKSB7CiAgICBfY2xhc3NDYWxsQ2hlY2sodGhpcywgSHlwZXJ0eUNoYXQpOwoKICAgIGlmICghaHlwZXJ0eVVSTCkgdGhyb3cgbmV3IEVycm9yKCdUaGUgaHlwZXJ0eVVSTCBpcyBhIG5lZWRlZCBwYXJhbWV0ZXInKTsKICAgIGlmICghYnVzKSB0aHJvdyBuZXcgRXJyb3IoJ1RoZSBNaW5pQnVzIGlzIGEgbmVlZGVkIHBhcmFtZXRlcicpOwogICAgaWYgKCFjb25maWd1cmF0aW9uKSB0aHJvdyBuZXcgRXJyb3IoJ1RoZSBjb25maWd1cmF0aW9uIGlzIGEgbmVlZGVkIHBhcmFtZXRlcicpOwoKICAgIF9nZXQoT2JqZWN0LmdldFByb3RvdHlwZU9mKEh5cGVydHlDaGF0LnByb3RvdHlwZSksICdjb25zdHJ1Y3RvcicsIHRoaXMpLmNhbGwodGhpcywgaHlwZXJ0eVVSTCwgYnVzLCBjb25maWd1cmF0aW9uKTsKCiAgICB2YXIgX3RoaXMgPSB0aGlzOwogICAgdmFyIHN5bmNoZXIgPSBuZXcgX3N5bmNoZXJTeW5jaGVyMlsnZGVmYXVsdCddKGh5cGVydHlVUkwsIGJ1cywgY29uZmlndXJhdGlvbik7CgogICAgdmFyIGRvbWFpbiA9ICgwLCBfdXRpbHNVdGlscy5kaXZpZGVVUkwpKGh5cGVydHlVUkwpLmRvbWFpbjsKICAgIHZhciBoeXBlcnR5RGlzY292ZXJ5ID0gbmV3IF9oeXBlcnR5RGlzY292ZXJ5SHlwZXJ0eURpc2NvdmVyeTJbJ2RlZmF1bHQnXShkb21haW4sIGJ1cyk7CgogICAgX3RoaXMuX29iamVjdERlc2NVUkwgPSAnaHlwZXJ0eS1jYXRhbG9ndWU6Ly8nICsgZG9tYWluICsgJy8ud2VsbC1rbm93bi9kYXRhc2NoZW1hcy9GYWtlRGF0YVNjaGVtYSc7CgogICAgX3RoaXMuX2h5cGVydHlVUkwgPSBoeXBlcnR5VVJMOwogICAgX3RoaXMuX3N5bmNoZXIgPSBzeW5jaGVyOwogICAgX3RoaXMuX2h5cGVydHlEaXNjb3ZlcnkgPSBoeXBlcnR5RGlzY292ZXJ5OwoKICAgIHN5bmNoZXIub25Ob3RpZmljYXRpb24oZnVuY3Rpb24gKGV2ZW50KSB7CiAgICAgIGNvbnNvbGUubG9nKCdOb3RpZmljYXRpb246ICcsIGV2ZW50KTsKICAgICAgX3RoaXMuX2F1dG9TdWJzY3JpYmUoZXZlbnQudXJsKTsKICAgIH0pOwogIH0KCiAgX2NyZWF0ZUNsYXNzKEh5cGVydHlDaGF0LCBbewogICAga2V5OiAnX2F1dG9TdWJzY3JpYmUnLAogICAgdmFsdWU6IGZ1bmN0aW9uIF9hdXRvU3Vic2NyaWJlKHJlc291cmNlKSB7CiAgICAgIHZhciBfdGhpcyA9IHRoaXM7CiAgICAgIF90aGlzLmpvaW4ocmVzb3VyY2UpLnRoZW4oZnVuY3Rpb24gKGNoYXRHcm91cCkgewogICAgICAgIF90aGlzLnRyaWdnZXIoJ2NoYXQ6c3Vic2NyaWJlJywgY2hhdEdyb3VwKTsKICAgICAgfSlbJ2NhdGNoJ10oZnVuY3Rpb24gKHJlYXNvbikgewogICAgICAgIGNvbnNvbGUuZXJyb3IocmVhc29uKTsKICAgICAgfSk7CiAgICB9CgogICAgLyoqCiAgICAgKiBUaGlzIGZ1bmN0aW9uIGlzIHVzZWQgdG8gY3JlYXRlIGEgbmV3IEdyb3VwIENoYXQgcHJvdmlkaW5nIHRoZSBpZGVudGlmaWVyIG9mIHRoZSBHcm91cCB0byBiZSBub3RpZmllZC4KICAgICAqIEBwYXJhbSAge1N0cmluZ30gbmFtZSAgICAgICAgICAgICBjaGF0IG5hbWUKICAgICAqIEBwYXJhbSAge1VSTC5Vc2VyVVJMfSBVc2VyVVJMTGlzdCBMaXN0IG9mIFVzZXIgYWxsb3dlZAogICAgICogQHJldHVybiB7UHJvbWlzZX0KICAgICAqLwogIH0sIHsKICAgIGtleTogJ2NyZWF0ZScsCiAgICB2YWx1ZTogZnVuY3Rpb24gY3JlYXRlKG5hbWUsIHBhcnRpY2lwYW50cykgewoKICAgICAgdmFyIF90aGlzID0gdGhpczsKICAgICAgdmFyIHN5bmNoZXIgPSBfdGhpcy5fc3luY2hlcjsKICAgICAgdmFyIGh5cGVydHlEaXNjb3ZlcnkgPSBfdGhpcy5faHlwZXJ0eURpc2NvdmVyeTsKCiAgICAgIHJldHVybiBuZXcgX1Byb21pc2UoZnVuY3Rpb24gKHJlc29sdmUsIHJlamVjdCkgewoKICAgICAgICAvLyBDcmVhdGUgb3duZXIgcGFydGljaXBhbnQKICAgICAgICAvLyBUT0RPOiBjcmVhdGUgYWxsIGluZm9ybWF0aW9uIHRvIGNvbW11bmljYXRpb247CiAgICAgICAgX2NvbW11bmljYXRpb24yWydkZWZhdWx0J10ub3duZXIgPSBfdGhpcy5faHlwZXJ0eVVSTDsKICAgICAgICBfY29tbXVuaWNhdGlvbjJbJ2RlZmF1bHQnXS5pZCA9IG5hbWU7CgogICAgICAgIC8vIFNldCB0aGUgb3RoZXIgc3Vic2NyaXB0aW9uIGxpa2UgYSBwYXJ0aWNpcGFudAogICAgICAgIF9wYXJ0aWNpcGFudDJbJ2RlZmF1bHQnXS5oeXBlcnR5UmVzb3VyY2UgPSBfdGhpcy5faHlwZXJ0eVVSTDsKICAgICAgICBfY29tbXVuaWNhdGlvbjJbJ2RlZmF1bHQnXS5wYXJ0aWNpcGFudHMucHVzaChfcGFydGljaXBhbnQyWydkZWZhdWx0J10pOwoKICAgICAgICBjb25zb2xlLmluZm8oJy0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tIE1hcHBpbmcgUGFydGljcGFudHMgLS0tLS0tLS0tLS0tLS0tLS0tLS0gXG4nKTsKICAgICAgICBfdGhpcy5fbWFwcGluZ1VzZXIocGFydGljaXBhbnRzKS50aGVuKGZ1bmN0aW9uIChoeXBlcnRpZXMpIHsKICAgICAgICAgIGNvbnNvbGUuaW5mbygnLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tIFN5bmNoZXIgQ3JlYXRlIC0tLS0tLS0tLS0tLS0tLS0tLS0tLS0gXG4nKTsKICAgICAgICAgIHJldHVybiBzeW5jaGVyLmNyZWF0ZShfdGhpcy5fb2JqZWN0RGVzY1VSTCwgaHlwZXJ0aWVzLCB7IGNvbW11bmljYXRpb246IF9jb21tdW5pY2F0aW9uMlsnZGVmYXVsdCddIH0pOwogICAgICAgIH0pLnRoZW4oZnVuY3Rpb24gKGRhdGFPYmplY3RSZXBvcnRlcikgewogICAgICAgICAgY29uc29sZS5pbmZvKCczLiBSZXR1cm4gQ3JlYXRlIERhdGEgT2JqZWN0IFJlcG9ydGVyJywgZGF0YU9iamVjdFJlcG9ydGVyKTsKCiAgICAgICAgICB2YXIgY2hhdCA9IG5ldyBfQ2hhdDJbJ2RlZmF1bHQnXShzeW5jaGVyLCBoeXBlcnR5RGlzY292ZXJ5LCBfdGhpcy5fZG9tYWluKTsKICAgICAgICAgIGNoYXQuZGF0YU9iamVjdFJlcG9ydGVyID0gZGF0YU9iamVjdFJlcG9ydGVyOwoKICAgICAgICAgIHJlc29sdmUoY2hhdCk7CiAgICAgICAgfSlbJ2NhdGNoJ10oZnVuY3Rpb24gKHJlYXNvbikgewogICAgICAgICAgcmVqZWN0KHJlYXNvbik7CiAgICAgICAgfSk7CiAgICAgIH0pOwogICAgfQogIH0sIHsKICAgIGtleTogJ2pvaW4nLAogICAgdmFsdWU6IGZ1bmN0aW9uIGpvaW4ocmVzb3VyY2UpIHsKICAgICAgdmFyIF90aGlzID0gdGhpczsKICAgICAgdmFyIHN5bmNoZXIgPSBfdGhpcy5fc3luY2hlcjsKCiAgICAgIHJldHVybiBuZXcgX1Byb21pc2UoZnVuY3Rpb24gKHJlc29sdmUsIHJlamVjdCkgewoKICAgICAgICBjb25zb2xlLmluZm8oJy0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLSBTeW5jaGVyIHN1YnNjcmliZSAtLS0tLS0tLS0tLS0tLS0tLS0tLS0tIFxuJyk7CiAgICAgICAgY29uc29sZS5pbmZvKHJlc291cmNlKTsKCiAgICAgICAgc3luY2hlci5zdWJzY3JpYmUoX3RoaXMuX29iamVjdERlc2NVUkwsIHJlc291cmNlKS50aGVuKGZ1bmN0aW9uIChkYXRhT2JqZWN0T2JzZXJ2ZXIpIHsKICAgICAgICAgIGNvbnNvbGUuaW5mbygnRGF0YSBPYmplY3QgT2JzZXJ2ZXI6ICcsIGRhdGFPYmplY3RPYnNlcnZlcik7CiAgICAgICAgICB2YXIgY2hhdCA9IG5ldyBfQ2hhdDJbJ2RlZmF1bHQnXShzeW5jaGVyLCBfdGhpcy5faHlwZXJ0eURpc2NvdmVyeSwgX3RoaXMuX2RvbWFpbik7CiAgICAgICAgICBjaGF0LmRhdGFPYmplY3RPYnNlcnZlciA9IGRhdGFPYmplY3RPYnNlcnZlcjsKCiAgICAgICAgICByZXNvbHZlKGNoYXQpOwogICAgICAgIH0pWydjYXRjaCddKGZ1bmN0aW9uIChyZWFzb24pIHsKICAgICAgICAgIHJlamVjdChyZWFzb24pOwogICAgICAgIH0pOwogICAgICB9KTsKICAgIH0KICB9LCB7CiAgICBrZXk6ICdfbWFwcGluZ1VzZXInLAogICAgdmFsdWU6IGZ1bmN0aW9uIF9tYXBwaW5nVXNlcih1c2VyTGlzdCkgewoKICAgICAgdmFyIF90aGlzID0gdGhpczsKCiAgICAgIHJldHVybiBuZXcgX1Byb21pc2UoZnVuY3Rpb24gKHJlc29sdmUsIHJlamVjdCkgewogICAgICAgIHZhciBwcm9taXNlTGlzdCA9IFtdOwoKICAgICAgICB1c2VyTGlzdC5mb3JFYWNoKGZ1bmN0aW9uIChlbWFpbCkgewogICAgICAgICAgaWYgKGVtYWlsLmxlbmd0aCkgewogICAgICAgICAgICBwcm9taXNlTGlzdC5wdXNoKF90aGlzLl9oeXBlcnR5RGlzY292ZXJ5LmRpc2NvdmVySHlwZXJ0eVBlclVzZXIoZW1haWwpKTsKICAgICAgICAgIH0KICAgICAgICB9KTsKCiAgICAgICAgX1Byb21pc2UuYWxsKHByb21pc2VMaXN0KS50aGVuKGZ1bmN0aW9uICh2YWx1ZXMpIHsKICAgICAgICAgIHZhciBoeXBlcnRpZXMgPSBbXTsKCiAgICAgICAgICB2YWx1ZXMuZm9yRWFjaChmdW5jdGlvbiAodmFsdWUpIHsKICAgICAgICAgICAgaHlwZXJ0aWVzLnB1c2godmFsdWUuaHlwZXJ0eVVSTCk7CiAgICAgICAgICB9KTsKCiAgICAgICAgICByZXNvbHZlKGh5cGVydGllcyk7CiAgICAgICAgfSlbJ2NhdGNoJ10oZnVuY3Rpb24gKHJlYXNvbikgewogICAgICAgICAgcmVqZWN0KHJlYXNvbik7CiAgICAgICAgfSk7CiAgICAgIH0pOwogICAgfQogIH1dKTsKCiAgcmV0dXJuIEh5cGVydHlDaGF0Owp9KShfdXRpbHNFdmVudEVtaXR0ZXIyWydkZWZhdWx0J10pOwoKZnVuY3Rpb24gYWN0aXZhdGUoaHlwZXJ0eVVSTCwgYnVzLCBjb25maWd1cmF0aW9uKSB7CgogIHJldHVybiB7CiAgICBuYW1lOiAnSHlwZXJ0eUNoYXQnLAogICAgaW5zdGFuY2U6IG5ldyBIeXBlcnR5Q2hhdChoeXBlcnR5VVJMLCBidXMsIGNvbmZpZ3VyYXRpb24pCiAgfTsKfQoKbW9kdWxlLmV4cG9ydHMgPSBleHBvcnRzWydkZWZhdWx0J107Cgp9LHsiLi4vaHlwZXJ0eS1kaXNjb3ZlcnkvSHlwZXJ0eURpc2NvdmVyeSI6OTYsIi4uL3N5bmNoZXIvU3luY2hlciI6MTAzLCIuLi91dGlscy9FdmVudEVtaXR0ZXIiOjEwNCwiLi4vdXRpbHMvdXRpbHMiOjEwNSwiLi9DaGF0Ijo5MiwiLi9jb21tdW5pY2F0aW9uIjo5NCwiLi9wYXJ0aWNpcGFudCI6OTUsImJhYmVsLXJ1bnRpbWUvY29yZS1qcy9wcm9taXNlIjo3LCJiYWJlbC1ydW50aW1lL2hlbHBlcnMvY2xhc3MtY2FsbC1jaGVjayI6MTAsImJhYmVsLXJ1bnRpbWUvaGVscGVycy9jcmVhdGUtY2xhc3MiOjEyLCJiYWJlbC1ydW50aW1lL2hlbHBlcnMvZ2V0IjoxNCwiYmFiZWwtcnVudGltZS9oZWxwZXJzL2luaGVyaXRzIjoxNSwiYmFiZWwtcnVudGltZS9oZWxwZXJzL2ludGVyb3AtcmVxdWlyZS1kZWZhdWx0IjoxNn1dLDk0OltmdW5jdGlvbihyZXF1aXJlLG1vZHVsZSxleHBvcnRzKXsKJ3VzZSBzdHJpY3QnOwoKT2JqZWN0LmRlZmluZVByb3BlcnR5KGV4cG9ydHMsICdfX2VzTW9kdWxlJywgewogIHZhbHVlOiB0cnVlCn0pOwp2YXIgQ29tbXVuaWNhdGlvblN0YXR1cyA9IHsKICBPUEVOOiAnb3BlbicsCiAgUEVORElORzogJ3BlbmRpbmcnLAogIENMT1NFRDogJ2Nsb3NlZCcsCiAgUEFVU0VEOiAncGF1c2VkJywKICBGQUlMRUQ6ICdmYWlsZWQnCn07CgpleHBvcnRzLkNvbW11bmljYXRpb25TdGF0dXMgPSBDb21tdW5pY2F0aW9uU3RhdHVzOwp2YXIgY29tbXVuaWNhdGlvbiA9IHsKICBpZDogJycsCiAgaG9zdDogJycsCiAgb3duZXI6ICcnLAogIHN0YXJ0aW5nVGltZTogJycsCiAgbGFzdE1vZGlmaWVkOiAnJywKICBkdXJhdGlvbjogJycsCiAgY29tbXVuaWNhdGlvblN0YXR1czogJycsCiAgY29tbXVuaWNhdGlvblF1YWxpdHk6ICcnLAogIHBhcnRpY2lwYW50czogW10sCiAgY2hhdE1lc3NhZ2U6IHt9Cn07CgpleHBvcnRzWydkZWZhdWx0J10gPSBjb21tdW5pY2F0aW9uOwoKfSx7fV0sOTU6W2Z1bmN0aW9uKHJlcXVpcmUsbW9kdWxlLGV4cG9ydHMpewondXNlIHN0cmljdCc7CgpPYmplY3QuZGVmaW5lUHJvcGVydHkoZXhwb3J0cywgJ19fZXNNb2R1bGUnLCB7CiAgdmFsdWU6IHRydWUKfSk7CnZhciBwYXJ0aWNpcGFudCA9IHsKICBwYXJ0aWNpcGFudFN0YXR1czogJycsCiAgaHlwZXJ0eVJlc291cmNlOiAnJywKICBpZGVudGl0eTogJycKfTsKCmV4cG9ydHNbJ2RlZmF1bHQnXSA9IHBhcnRpY2lwYW50Owptb2R1bGUuZXhwb3J0cyA9IGV4cG9ydHNbJ2RlZmF1bHQnXTsKCn0se31dLDk2OltmdW5jdGlvbihyZXF1aXJlLG1vZHVsZSxleHBvcnRzKXsKLyoqCiogQ29yZSBIeXBlcnR5RGlzY292ZXJ5IGludGVyZmFjZQoqIENsYXNzIHRvIGFsbG93IGFwcGxpY2F0aW9ucyB0byBzZWFyY2ggZm9yIGh5cGVydGllcyB1c2luZyB0aGUgbWVzc2FnZSBidXMKKi8KJ3VzZSBzdHJpY3QnOwoKdmFyIF9jcmVhdGVDbGFzcyA9IHJlcXVpcmUoJ2JhYmVsLXJ1bnRpbWUvaGVscGVycy9jcmVhdGUtY2xhc3MnKVsnZGVmYXVsdCddOwoKdmFyIF9jbGFzc0NhbGxDaGVjayA9IHJlcXVpcmUoJ2JhYmVsLXJ1bnRpbWUvaGVscGVycy9jbGFzcy1jYWxsLWNoZWNrJylbJ2RlZmF1bHQnXTsKCnZhciBfUHJvbWlzZSA9IHJlcXVpcmUoJ2JhYmVsLXJ1bnRpbWUvY29yZS1qcy9wcm9taXNlJylbJ2RlZmF1bHQnXTsKCk9iamVjdC5kZWZpbmVQcm9wZXJ0eShleHBvcnRzLCAnX19lc01vZHVsZScsIHsKICB2YWx1ZTogdHJ1ZQp9KTsKCnZhciBIeXBlcnR5RGlzY292ZXJ5ID0gKGZ1bmN0aW9uICgpIHsKCiAgLyoqCiAgKiBUbyBpbml0aWFsaXNlIHRoZSBIeXBlcnR5RGlzY292ZXIsIHdoaWNoIHdpbGwgcHJvdmlkZSB0aGUgc3VwcG9ydCBmb3IgaHlwZXJ0aWVzIHRvCiAgKiBxdWVyeSB1c2VycyByZWdpc3RlcmVkIGluIG91dHNpZGUgdGhlIGludGVybmFsIGNvcmUuCiAgKiBAcGFyYW0gIHtNZXNzYWdlQnVzfSAgICAgICAgICBtc2didXMgICAgICAgICAgICAgICAgbXNnYnVzCiAgKiBAcGFyYW0gIHtSdW50aW1lVVJMfSAgICAgICAgICBydW50aW1lVVJMICAgICAgICAgICAgcnVudGltZVVSTAogICovCgogIGZ1bmN0aW9uIEh5cGVydHlEaXNjb3ZlcnkoZG9tYWluLCBtc2dCdXMpIHsKICAgIF9jbGFzc0NhbGxDaGVjayh0aGlzLCBIeXBlcnR5RGlzY292ZXJ5KTsKCiAgICB2YXIgX3RoaXMgPSB0aGlzOwogICAgX3RoaXMubWVzc2FnZUJ1cyA9IG1zZ0J1czsKCiAgICBfdGhpcy5kb21haW4gPSBkb21haW47CiAgICBfdGhpcy5kaXNjb3ZlcnlVUkwgPSAnaHlwZXJ0eTovLycgKyBkb21haW4gKyAnL2h5cGVydHlEaXNjb3ZlcnknOwogIH0KCiAgLyoqCiAgKiBmdW5jdGlvbiB0byByZXF1ZXN0IGFib3V0IHVzZXJzIHJlZ2lzdGVyZWQgaW4gZG9tYWluIHJlZ2lzdHJ5LCBhbmQKICAqIHJldHVybiB0aGUgaHlwZXJ0eSBpbnN0YW5jZSBpZiBmb3VuZC4KICAqIEBwYXJhbSAge2VtYWlsfSAgICAgICAgICAgICAgZW1haWwKICAqIEByZXR1cm4ge1Byb21pc2V9ICAgICAgICAgIFByb21pc2UKICAqLwoKICBfY3JlYXRlQ2xhc3MoSHlwZXJ0eURpc2NvdmVyeSwgW3sKICAgIGtleTogJ2Rpc2NvdmVySHlwZXJ0eVBlclVzZXInLAogICAgdmFsdWU6IGZ1bmN0aW9uIGRpc2NvdmVySHlwZXJ0eVBlclVzZXIoZW1haWwpIHsKICAgICAgdmFyIF90aGlzID0gdGhpczsKICAgICAgdmFyIGlkZW50aXR5VVJMID0gJ3VzZXI6Ly8nICsgZW1haWwuc3Vic3RyaW5nKGVtYWlsLmluZGV4T2YoJ0AnKSArIDEsIGVtYWlsLmxlbmd0aCkgKyAnLycgKyBlbWFpbC5zdWJzdHJpbmcoMCwgZW1haWwuaW5kZXhPZignQCcpKTsKCiAgICAgIC8vIG1lc3NhZ2UgdG8gcXVlcnkgZG9tYWluIHJlZ2lzdHJ5LCBhc2tpbmcgZm9yIGEgdXNlciBoeXBlcnR5LgogICAgICB2YXIgbWVzc2FnZSA9IHsKICAgICAgICB0eXBlOiAnUkVBRCcsIGZyb206IF90aGlzLmRpc2NvdmVyeVVSTCwgdG86ICdkb21haW46Ly9yZWdpc3RyeS4nICsgX3RoaXMuZG9tYWluICsgJy8nLCBib2R5OiB7IHJlc291cmNlOiBpZGVudGl0eVVSTCB9CiAgICAgIH07CgogICAgICByZXR1cm4gbmV3IF9Qcm9taXNlKGZ1bmN0aW9uIChyZXNvbHZlLCByZWplY3QpIHsKCiAgICAgICAgX3RoaXMubWVzc2FnZUJ1cy5wb3N0TWVzc2FnZShtZXNzYWdlLCBmdW5jdGlvbiAocmVwbHkpIHsKICAgICAgICAgIC8vY29uc29sZS5sb2coJ01FU1NBR0UnLCByZXBseSk7CgogICAgICAgICAgdmFyIGh5cGVydHkgPSB1bmRlZmluZWQ7CiAgICAgICAgICB2YXIgbW9zdFJlY2VudCA9IHVuZGVmaW5lZDsKICAgICAgICAgIHZhciBsYXN0SHlwZXJ0eSA9IHVuZGVmaW5lZDsKICAgICAgICAgIHZhciB2YWx1ZSA9IHJlcGx5LmJvZHkudmFsdWU7CgogICAgICAgICAgY29uc29sZS5sb2cocmVwbHkpOwoKICAgICAgICAgIC8vY29uc29sZS5sb2coJ3ZhbHVlUGFyc2VkJywgdmFsdWVQYXJzZWQpOwogICAgICAgICAgZm9yIChoeXBlcnR5IGluIHZhbHVlKSB7CiAgICAgICAgICAgIGlmICh2YWx1ZVtoeXBlcnR5XS5sYXN0TW9kaWZpZWQgIT09IHVuZGVmaW5lZCkgewogICAgICAgICAgICAgIGlmIChtb3N0UmVjZW50ID09PSB1bmRlZmluZWQpIHsKICAgICAgICAgICAgICAgIG1vc3RSZWNlbnQgPSBuZXcgRGF0ZSh2YWx1ZVtoeXBlcnR5XS5sYXN0TW9kaWZpZWQpOwogICAgICAgICAgICAgICAgbGFzdEh5cGVydHkgPSBoeXBlcnR5OwogICAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICB2YXIgaHlwZXJ0eURhdGUgPSBuZXcgRGF0ZSh2YWx1ZVtoeXBlcnR5XS5sYXN0TW9kaWZpZWQpOwogICAgICAgICAgICAgICAgaWYgKG1vc3RSZWNlbnQuZ2V0VGltZSgpIDwgaHlwZXJ0eURhdGUuZ2V0VGltZSgpKSB7CiAgICAgICAgICAgICAgICAgIG1vc3RSZWNlbnQgPSBoeXBlcnR5RGF0ZTsKICAgICAgICAgICAgICAgICAgbGFzdEh5cGVydHkgPSBoeXBlcnR5OwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQogICAgICAgICAgfQogICAgICAgICAgdmFyIGh5cGVydHlVUkwgPSBsYXN0SHlwZXJ0eTsKCiAgICAgICAgICBpZiAoaHlwZXJ0eVVSTCA9PT0gdW5kZWZpbmVkKSB7CiAgICAgICAgICAgIHJldHVybiByZWplY3QoJ1VzZXIgSHlwZXJ0eSBub3QgZm91bmQnKTsKICAgICAgICAgIH0KCiAgICAgICAgICB2YXIgaWRQYWNrYWdlID0gewogICAgICAgICAgICBpZDogZW1haWwsCiAgICAgICAgICAgIGRlc2NyaXB0b3I6IHZhbHVlW2h5cGVydHlVUkxdLmRlc2NyaXB0b3IsCiAgICAgICAgICAgIGh5cGVydHlVUkw6IGh5cGVydHlVUkwKICAgICAgICAgIH07CgogICAgICAgICAgY29uc29sZS5sb2coJz09PT4gUmVnaXN0ZXJIeXBlcnR5IG1lc3NhZ2VCdW5kbGU6ICcsIGlkUGFja2FnZSk7CiAgICAgICAgICByZXNvbHZlKGlkUGFja2FnZSk7CiAgICAgICAgfSk7CiAgICAgIH0pOwogICAgfQogIH1dKTsKCiAgcmV0dXJuIEh5cGVydHlEaXNjb3Zlcnk7Cn0pKCk7CgpleHBvcnRzWydkZWZhdWx0J10gPSBIeXBlcnR5RGlzY292ZXJ5Owptb2R1bGUuZXhwb3J0cyA9IGV4cG9ydHNbJ2RlZmF1bHQnXTsKCn0seyJiYWJlbC1ydW50aW1lL2NvcmUtanMvcHJvbWlzZSI6NywiYmFiZWwtcnVudGltZS9oZWxwZXJzL2NsYXNzLWNhbGwtY2hlY2siOjEwLCJiYWJlbC1ydW50aW1lL2hlbHBlcnMvY3JlYXRlLWNsYXNzIjoxMn1dLDk3OltmdW5jdGlvbihyZXF1aXJlLG1vZHVsZSxleHBvcnRzKXsKJ3VzZSBzdHJpY3QnOwoKdmFyIF9jcmVhdGVDbGFzcyA9IHJlcXVpcmUoJ2JhYmVsLXJ1bnRpbWUvaGVscGVycy9jcmVhdGUtY2xhc3MnKVsnZGVmYXVsdCddOwoKdmFyIF9jbGFzc0NhbGxDaGVjayA9IHJlcXVpcmUoJ2JhYmVsLXJ1bnRpbWUvaGVscGVycy9jbGFzcy1jYWxsLWNoZWNrJylbJ2RlZmF1bHQnXTsKCnZhciBfUHJvbWlzZSA9IHJlcXVpcmUoJ2JhYmVsLXJ1bnRpbWUvY29yZS1qcy9wcm9taXNlJylbJ2RlZmF1bHQnXTsKCnZhciBfaW50ZXJvcFJlcXVpcmVEZWZhdWx0ID0gcmVxdWlyZSgnYmFiZWwtcnVudGltZS9oZWxwZXJzL2ludGVyb3AtcmVxdWlyZS1kZWZhdWx0JylbJ2RlZmF1bHQnXTsKCk9iamVjdC5kZWZpbmVQcm9wZXJ0eShleHBvcnRzLCAnX19lc01vZHVsZScsIHsKICB2YWx1ZTogdHJ1ZQp9KTsKCnZhciBfU3luY09iamVjdCA9IHJlcXVpcmUoJy4vU3luY09iamVjdCcpOwoKdmFyIF9TeW5jT2JqZWN0MiA9IF9pbnRlcm9wUmVxdWlyZURlZmF1bHQoX1N5bmNPYmplY3QpOwoKdmFyIF9EYXRhT2JqZWN0Q2hpbGQgPSByZXF1aXJlKCcuL0RhdGFPYmplY3RDaGlsZCcpOwoKdmFyIF9EYXRhT2JqZWN0Q2hpbGQyID0gX2ludGVyb3BSZXF1aXJlRGVmYXVsdChfRGF0YU9iamVjdENoaWxkKTsKCnZhciBfdXRpbHNVdGlsc0pzID0gcmVxdWlyZSgnLi4vdXRpbHMvdXRpbHMuanMnKTsKCnZhciBEYXRhT2JqZWN0ID0gKGZ1bmN0aW9uICgpIHsKICAvKiBwcml2YXRlCiAgX3ZlcnNpb246IG51bWJlcgogICBfb3duZXI6IEh5cGVydHlVUkwKICBfdXJsOiBPYmplY3RVUkwKICBfc2NoZW1hOiBTY2hlbWEKICBfYnVzOiBNaW5pQnVzCiAgX3N0YXR1czogb24gfCBwYXVzZWQKICBfc3luY09iajogU3luY0RhdGEKICAgX2NoaWxkcmVuOiB7IGlkOiBEYXRhT2JqZWN0Q2hpbGQgfQogICAtLS0tZXZlbnQgaGFuZGxlcnMtLS0tCiAgX29uQWRkQ2hpbGRyZW5IYW5kbGVyOiAoZXZlbnQpID0+IHZvaWQKICAqLwoKICAvKioKICAgKiBAaWdub3JlCiAgICogU2hvdWxkIG5vdCBiZSB1c2VkIGRpcmVjdGx5IGJ5IEh5cGVydGllcy4gSXQncyBjYWxsZWQgYnkgdGhlIFN5bmNoZXIgY3JlYXRlIG9yIHN1YnNjcmliZSBtZXRob2QncwogICAqLwoKICBmdW5jdGlvbiBEYXRhT2JqZWN0KG93bmVyLCB1cmwsIHNjaGVtYSwgYnVzLCBpbml0aWFsU3RhdHVzLCBpbml0aWFsRGF0YSwgY2hpbGRyZW4pIHsKICAgIHZhciBfdGhpczIgPSB0aGlzOwoKICAgIF9jbGFzc0NhbGxDaGVjayh0aGlzLCBEYXRhT2JqZWN0KTsKCiAgICB2YXIgX3RoaXMgPSB0aGlzOwoKICAgIF90aGlzLl92ZXJzaW9uID0gMDsKCiAgICBfdGhpcy5fb3duZXIgPSBvd25lcjsKICAgIF90aGlzLl91cmwgPSB1cmw7CiAgICBfdGhpcy5fc2NoZW1hID0gc2NoZW1hOwogICAgX3RoaXMuX2J1cyA9IGJ1czsKICAgIF90aGlzLl9zdGF0dXMgPSBpbml0aWFsU3RhdHVzOwogICAgX3RoaXMuX3N5bmNPYmogPSBuZXcgX1N5bmNPYmplY3QyWydkZWZhdWx0J10oaW5pdGlhbERhdGEpOwoKICAgIF90aGlzLl9jaGlsZElkID0gMDsKICAgIF90aGlzLl9jaGlsZHJlbiA9IHt9OwoKICAgIHZhciBjaGlsZEJhc2VVUkwgPSB1cmwgKyAnL2NoaWxkcmVuLyc7CgogICAgaWYgKGNoaWxkcmVuKSB7CiAgICAgIGNoaWxkcmVuLmZvckVhY2goZnVuY3Rpb24gKGNoaWxkKSB7CiAgICAgICAgdmFyIGNoaWxkVVJMID0gY2hpbGRCYXNlVVJMICsgY2hpbGQ7CiAgICAgICAgYnVzLmFkZExpc3RlbmVyKGNoaWxkVVJMLCBmdW5jdGlvbiAobXNnKSB7CiAgICAgICAgICAvL2lnbm9yZSBtc2cgc2VudCBieSBoaW1zZWxmCiAgICAgICAgICBpZiAobXNnLmZyb20gIT09IF90aGlzMi5fb3duZXIpIHsKICAgICAgICAgICAgc3dpdGNoIChtc2cudHlwZSkgewogICAgICAgICAgICAgIGNhc2UgJ2NyZWF0ZSc6CiAgICAgICAgICAgICAgICBfdGhpcy5fb25DaGlsZHJlbkNyZWF0ZShtc2cpO2JyZWFrOwogICAgICAgICAgICAgIGNhc2UgJ2RlbGV0ZSc6CiAgICAgICAgICAgICAgICBjb25zb2xlLmxvZyhtc2cpO2JyZWFrOwogICAgICAgICAgICAgIGRlZmF1bHQ6CiAgICAgICAgICAgICAgICBfdGhpcy5fY2hhbmdlQ2hpbGRyZW4obXNnKTticmVhazsKICAgICAgICAgICAgfQogICAgICAgICAgfQogICAgICAgIH0pOwogICAgICB9KTsKICAgIH0KICB9CgogIC8qKgogICAqIE9iamVjdCBVUkwgb2YgcmVwb3J0ZXIgb3Igb2JzZXJ2ZXIKICAgKiBAdHlwZSB7T2JqZWN0VVJMfQogICAqLwoKICBfY3JlYXRlQ2xhc3MoRGF0YU9iamVjdCwgW3sKICAgIGtleTogJ3BhdXNlJywKCiAgICAvKioKICAgICAqIEBpZ25vcmUKICAgICAqLwogICAgdmFsdWU6IGZ1bmN0aW9uIHBhdXNlKCkgewogICAgICAvL1RPRE86IHRoaXMgZmVhdHVyZSBuZWVkcyBtb3JlIGFuYWxpc2UKICAgICAgdGhyb3cgJ05vdCBpbXBsZW1lbnRlZCc7CiAgICB9CgogICAgLyoqCiAgICAgKiBAaWdub3JlCiAgICAgKi8KICB9LCB7CiAgICBrZXk6ICdyZXN1bWUnLAogICAgdmFsdWU6IGZ1bmN0aW9uIHJlc3VtZSgpIHsKICAgICAgLy9UT0RPOiB0aGlzIGZlYXR1cmUgbmVlZHMgbW9yZSBhbmFsaXNlCiAgICAgIHRocm93ICdOb3QgaW1wbGVtZW50ZWQnOwogICAgfQoKICAgIC8qKgogICAgICogQGlnbm9yZQogICAgICovCiAgfSwgewogICAga2V5OiAnc3RvcCcsCiAgICB2YWx1ZTogZnVuY3Rpb24gc3RvcCgpIHsKICAgICAgLy9UT0RPOiBzaG91bGQgcmVtb3ZlIHRoZSBzdWJzY3JpcHRpb24gYW5kIHNlbmQgbWVzc2FnZSB1bnN1YnNjcmliZT8KICAgICAgdGhyb3cgJ05vdCBpbXBsZW1lbnRlZCc7CiAgICB9CgogICAgLyoqCiAgICAgKiBAaWdub3JlCiAgICAgKi8KICB9LCB7CiAgICBrZXk6ICdyZWxlYXNlJywKICAgIHZhbHVlOiBmdW5jdGlvbiByZWxlYXNlKCkge30KICAgIC8vVE9ETzogcmVtb3ZlIGFsbCBsaXN0ZW5lcnMgZm9yIHRoaXMgb2JqZWN0CgogICAgLyoqCiAgICAgKiBDcmVhdGUgYW5kIGFkZCBhIGNoaWxkcmVuIHRvIHRoZSBzdWJzY3JpcHRpb24gZ3JvdXAuCiAgICAgKiBAcGFyYW0ge1N0cmluZ30gcmVzb3VyY2UgLSBSZXNvdXJjZSBuYW1lLCBvbmUgb2YgdGhlIGl0ZW1zIGluIHRoZSBzY2hlbWEucHJvcGVydGllcy5zY2hlbWUgb2YgdGhlIHBhcmVudCBvYmplY3QuCiAgICAgKiBAcGFyYW0ge0pTT059IGluaXRpYWxEYXRhIC0gSW5pdGlhbCBkYXRhIG9mIHRoZSBjaGlsZAogICAgICogQHJldHVybiB7UHJvbWlzZTxEYXRhT2JqZWN0Q2hpbGQ+fSAtIFJldHVybiBQcm9taXNlIHRvIGEgbmV3IENoaWxkcmVuLgogICAgICovCgogIH0sIHsKICAgIGtleTogJ2FkZENoaWxkcmVuJywKICAgIHZhbHVlOiBmdW5jdGlvbiBhZGRDaGlsZHJlbihyZXNvdXJjZSwgaW5pdGlhbERhdGEpIHsKICAgICAgdmFyIF90aGlzID0gdGhpczsKCiAgICAgIC8vY3JlYXRlIG5ldyBjaGlsZCB1bmlxdWUgSUQsIGJhc2VkIG9uIGh5cGVydHlVUkwKICAgICAgX3RoaXMuX2NoaWxkSWQrKzsKICAgICAgdmFyIG1zZ0NoaWxkSWQgPSBfdGhpcy5fb3duZXIgKyAnIycgKyBfdGhpcy5fY2hpbGRJZDsKICAgICAgdmFyIG1zZ0NoaWxkUGF0aCA9IF90aGlzLl91cmwgKyAnL2NoaWxkcmVuLycgKyByZXNvdXJjZTsKCiAgICAgIHZhciByZXF1ZXN0TXNnID0gewogICAgICAgIHR5cGU6ICdjcmVhdGUnLCBmcm9tOiBfdGhpcy5fb3duZXIsIHRvOiBtc2dDaGlsZFBhdGgsCiAgICAgICAgYm9keTogeyByZXNvdXJjZTogbXNnQ2hpbGRJZCwgdmFsdWU6IGluaXRpYWxEYXRhIH0KICAgICAgfTsKCiAgICAgIC8vcmV0dXJucyBwcm9taXNlLCBpbiB0aGUgZnV0dXJlLCB0aGUgQVBJIG1heSBjaGFuZ2UgdG8gYXN5bmNocm9ub3VzIGNhbGwKICAgICAgcmV0dXJuIG5ldyBfUHJvbWlzZShmdW5jdGlvbiAocmVzb2x2ZSkgewogICAgICAgIHZhciBtc2dJZCA9IF90aGlzLl9idXMucG9zdE1lc3NhZ2UocmVxdWVzdE1zZyk7CgogICAgICAgIGNvbnNvbGUubG9nKCdjcmVhdGUtcmVwb3J0ZXItY2hpbGQoICcgKyBfdGhpcy5fb3duZXIgKyAnICk6ICcsIHJlcXVlc3RNc2cpOwogICAgICAgIHZhciBuZXdDaGlsZCA9IG5ldyBfRGF0YU9iamVjdENoaWxkMlsnZGVmYXVsdCddKF90aGlzLl9vd25lciwgbXNnQ2hpbGRJZCwgbXNnSWQsIF90aGlzLl9idXMsIGluaXRpYWxEYXRhKTsKICAgICAgICBuZXdDaGlsZC5vbkNoYW5nZShmdW5jdGlvbiAoZXZlbnQpIHsKICAgICAgICAgIF90aGlzLl9vbkNoYW5nZShldmVudCwgeyBwYXRoOiBtc2dDaGlsZFBhdGgsIGNoaWxkSWQ6IG1zZ0NoaWxkSWQgfSk7CiAgICAgICAgfSk7CgogICAgICAgIF90aGlzLl9jaGlsZHJlblttc2dDaGlsZElkXSA9IG5ld0NoaWxkOwoKICAgICAgICByZXNvbHZlKG5ld0NoaWxkKTsKICAgICAgfSk7CiAgICB9CgogICAgLyoqCiAgICAgKiBTZXR1cCB0aGUgY2FsbGJhY2sgdG8gcHJvY2VzcyBjcmVhdGUgYW5kIGRlbGV0ZSBjaGlsZHJlbnMKICAgICAqIEBwYXJhbSB7ZnVuY3Rpb24oZXZlbnQ6IE1zZ0V2ZW50KX0gY2FsbGJhY2sKICAgICAqLwogIH0sIHsKICAgIGtleTogJ29uQWRkQ2hpbGRyZW4nLAogICAgdmFsdWU6IGZ1bmN0aW9uIG9uQWRkQ2hpbGRyZW4oY2FsbGJhY2spIHsKICAgICAgdGhpcy5fb25BZGRDaGlsZHJlbkhhbmRsZXIgPSBjYWxsYmFjazsKICAgIH0KICB9LCB7CiAgICBrZXk6ICdfb25DaGlsZHJlbkNyZWF0ZScsCiAgICB2YWx1ZTogZnVuY3Rpb24gX29uQ2hpbGRyZW5DcmVhdGUobXNnKSB7CiAgICAgIHZhciBfdGhpcyA9IHRoaXM7CiAgICAgIHZhciBtc2dDaGlsZElkID0gbXNnLmJvZHkucmVzb3VyY2U7CgogICAgICBjb25zb2xlLmxvZygnY3JlYXRlLW9ic2VydmVyLWNoaWxkKCAnICsgX3RoaXMuX293bmVyICsgJyApOiAnLCBtc2cpOwogICAgICB2YXIgbmV3Q2hpbGQgPSBuZXcgX0RhdGFPYmplY3RDaGlsZDJbJ2RlZmF1bHQnXShtc2cuZnJvbSwgbXNnQ2hpbGRJZCwgMCwgX3RoaXMuX2J1cywgbXNnLmJvZHkudmFsdWUpOwogICAgICBfdGhpcy5fY2hpbGRyZW5bbXNnQ2hpbGRJZF0gPSBuZXdDaGlsZDsKCiAgICAgIHNldFRpbWVvdXQoZnVuY3Rpb24gKCkgewogICAgICAgIF90aGlzLl9idXMucG9zdE1lc3NhZ2UoewogICAgICAgICAgaWQ6IG1zZy5pZCwgdHlwZTogJ3Jlc3BvbnNlJywgZnJvbTogbXNnLnRvLCB0bzogbXNnLmZyb20sCiAgICAgICAgICBib2R5OiB7IGNvZGU6IDIwMCwgc291cmNlOiBfdGhpcy5fb3duZXIgfQogICAgICAgIH0pOwogICAgICB9KTsKCiAgICAgIHZhciBldmVudCA9IHsKICAgICAgICB0eXBlOiBtc2cudHlwZSwKICAgICAgICBmcm9tOiBtc2cuZnJvbSwKICAgICAgICB1cmw6IG1zZy50bywKICAgICAgICB2YWx1ZTogbXNnLmJvZHkudmFsdWUsCiAgICAgICAgY2hpbGRJZDogbXNnQ2hpbGRJZAogICAgICB9OwoKICAgICAgaWYgKF90aGlzLl9vbkFkZENoaWxkcmVuSGFuZGxlcikgewogICAgICAgIF90aGlzLl9vbkFkZENoaWxkcmVuSGFuZGxlcihldmVudCk7CiAgICAgIH0KICAgIH0KCiAgICAvL3NlbmQgZGVsdGEgbWVzc2FnZXMgdG8gc3Vic2NyaXB0aW9ucwogIH0sIHsKICAgIGtleTogJ19vbkNoYW5nZScsCiAgICB2YWx1ZTogZnVuY3Rpb24gX29uQ2hhbmdlKGV2ZW50LCBjaGlsZEluZm8pIHsKICAgICAgdmFyIF90aGlzID0gdGhpczsKCiAgICAgIF90aGlzLl92ZXJzaW9uKys7CgogICAgICBpZiAoX3RoaXMuX3N0YXR1cyA9PT0gJ29uJykgewogICAgICAgIHZhciBjaGFuZ2VNc2cgPSB7CiAgICAgICAgICB0eXBlOiBldmVudC5jVHlwZSwgZnJvbTogX3RoaXMuX293bmVyLCB0bzogX3RoaXMuX3VybCwKICAgICAgICAgIGJvZHk6IHsgdmVyc2lvbjogX3RoaXMuX3ZlcnNpb24sIG9UeXBlOiBldmVudC5vVHlwZSwgYXR0cmliOiBldmVudC5maWVsZCwgdmFsdWU6IGV2ZW50LmRhdGEgfQogICAgICAgIH07CgogICAgICAgIC8vY2hpbGRJbmZvIG11c3QgaGF2ZSAocGF0aCwgY2hpbGRJZCkKICAgICAgICBpZiAoY2hpbGRJbmZvKSB7CiAgICAgICAgICBjaGFuZ2VNc2cudG8gPSBjaGlsZEluZm8ucGF0aDsKICAgICAgICAgIGNoYW5nZU1zZy5ib2R5LmNoaWxkSWQgPSBjaGlsZEluZm8uY2hpbGRJZDsKICAgICAgICB9CgogICAgICAgIF90aGlzLl9idXMucG9zdE1lc3NhZ2UoY2hhbmdlTXNnKTsKICAgICAgfQogICAgfQoKICAgIC8vcmVjZWl2ZSBhbmQgcHJvY2VzcyBkZWx0YSBtZXNzYWdlcwogIH0sIHsKICAgIGtleTogJ19jaGFuZ2VPYmplY3QnLAogICAgdmFsdWU6IGZ1bmN0aW9uIF9jaGFuZ2VPYmplY3Qoc3luY09iaiwgbXNnKSB7CiAgICAgIHZhciBfdGhpcyA9IHRoaXM7CgogICAgICAvL1RPRE86IHVwZGF0ZSB2ZXJzaW9uID8KICAgICAgLy9ob3cgdG8gaGFuZGxlIGFuIGluY29ycmVjdCB2ZXJzaW9uID8gRXhhbXBsZTogcmVjZWl2ZSBhIHZlcnNpb24gMyB3aGVuIHRoZSBvYnNlcnZlciBpcyBpbiB2ZXJzaW9uIDEsIHdoZXJlIGlzIHRoZSB2ZXJzaW9uIDIgPwogICAgICAvL3dpbGwgd2UgbmVlZCB0byBjb25maXJtIHRoZSByZWNlcHRpb24gPwogICAgICBpZiAoX3RoaXMuX3ZlcnNpb24gKyAxID09PSBtc2cuYm9keS52ZXJzaW9uKSB7CiAgICAgICAgX3RoaXMuX3ZlcnNpb24rKzsKICAgICAgICB2YXIgcGF0aCA9IG1zZy5ib2R5LmF0dHJpYjsKICAgICAgICB2YXIgdmFsdWUgPSAoMCwgX3V0aWxzVXRpbHNKcy5kZWVwQ2xvbmUpKG1zZy5ib2R5LnZhbHVlKTsKICAgICAgICB2YXIgZmluZFJlc3VsdCA9IHN5bmNPYmouZmluZEJlZm9yZShwYXRoKTsKCiAgICAgICAgaWYgKG1zZy50eXBlID09PSBfU3luY09iamVjdC5DaGFuZ2VUeXBlLlVQREFURSkgewogICAgICAgICAgZmluZFJlc3VsdC5vYmpbZmluZFJlc3VsdC5sYXN0XSA9IHZhbHVlOwogICAgICAgIH0gZWxzZSB7CiAgICAgICAgICBpZiAobXNnLnR5cGUgPT09IF9TeW5jT2JqZWN0LkNoYW5nZVR5cGUuQUREKSB7CiAgICAgICAgICAgIGlmIChtc2cuYm9keS5vVHlwZSA9PT0gX1N5bmNPYmplY3QuT2JqZWN0VHlwZS5PQkpFQ1QpIHsKICAgICAgICAgICAgICBmaW5kUmVzdWx0Lm9ialtmaW5kUmVzdWx0Lmxhc3RdID0gdmFsdWU7CiAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgLy9BUlJBWQogICAgICAgICAgICAgIHZhciBhcnIgPSBmaW5kUmVzdWx0Lm9iajsKICAgICAgICAgICAgICB2YXIgaW5kZXggPSBmaW5kUmVzdWx0Lmxhc3Q7CiAgICAgICAgICAgICAgQXJyYXkucHJvdG90eXBlLnNwbGljZS5hcHBseShhcnIsIFtpbmRleCwgMF0uY29uY2F0KHZhbHVlKSk7CiAgICAgICAgICAgIH0KICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgIC8vUkVNT1ZFCiAgICAgICAgICAgIGlmIChtc2cuYm9keS5vVHlwZSA9PT0gX1N5bmNPYmplY3QuT2JqZWN0VHlwZS5PQkpFQ1QpIHsKICAgICAgICAgICAgICBkZWxldGUgZmluZFJlc3VsdC5vYmpbZmluZFJlc3VsdC5sYXN0XTsKICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAvL0FSUkFZCiAgICAgICAgICAgICAgdmFyIGFyciA9IGZpbmRSZXN1bHQub2JqOwogICAgICAgICAgICAgIHZhciBpbmRleCA9IGZpbmRSZXN1bHQubGFzdDsKICAgICAgICAgICAgICBhcnIuc3BsaWNlKGluZGV4LCB2YWx1ZSk7CiAgICAgICAgICAgIH0KICAgICAgICAgIH0KICAgICAgICB9CiAgICAgIH0gZWxzZSB7CiAgICAgICAgLy9UT0RPOiBob3cgdG8gaGFuZGxlIHVuc3luY2hyb25pemVkIHZlcnNpb25zPwogICAgICAgIGNvbnNvbGUubG9nKCdVTlNZTkNIUk9OSVpFRCBWRVJTSU9OOiAoZGF0YSA9PiAnICsgX3RoaXMuX3ZlcnNpb24gKyAnLCBtc2cgPT4gJyArIG1zZy5ib2R5LnZlcnNpb24gKyAnKScpOwogICAgICB9CiAgICB9CiAgfSwgewogICAga2V5OiAnX2NoYW5nZUNoaWxkcmVuJywKICAgIHZhbHVlOiBmdW5jdGlvbiBfY2hhbmdlQ2hpbGRyZW4obXNnKSB7CiAgICAgIHZhciBfdGhpcyA9IHRoaXM7CiAgICAgIGNvbnNvbGUubG9nKCdDaGFuZ2UgY2hpbGRyZW46ICcsIF90aGlzLl9vd25lciwgbXNnKTsKCiAgICAgIHZhciBjaGlsZElkID0gbXNnLmJvZHkuY2hpbGRJZDsKICAgICAgdmFyIGNoaWxkcmVuID0gX3RoaXMuX2NoaWxkcmVuW2NoaWxkSWRdOwoKICAgICAgaWYgKGNoaWxkcmVuKSB7CiAgICAgICAgX3RoaXMuX2NoYW5nZU9iamVjdChjaGlsZHJlbi5fc3luY09iaiwgbXNnKTsKICAgICAgfSBlbHNlIHsKICAgICAgICBjb25zb2xlLmxvZygnTm8gY2hpbGRyZW4gZm91bmQgZm9yOiAnLCBjaGlsZElkKTsKICAgICAgfQogICAgfQogIH0sIHsKICAgIGtleTogJ3VybCcsCiAgICBnZXQ6IGZ1bmN0aW9uIGdldCgpIHsKICAgICAgcmV0dXJuIHRoaXMuX3VybDsKICAgIH0KCiAgICAvKioKICAgICAqIE9iamVjdCBzY2hlbWEgVVJMICh0aGlzIGZpZWxkIGlzIG5vdCB5ZXQgc3RhYmxlLCBhbmQgaXMgc3Vic2plY3QgdG8gY2hhbmdlKQogICAgICogQHR5cGUge1NjaGVtYVVSTH0KICAgICAqLwogIH0sIHsKICAgIGtleTogJ3NjaGVtYScsCiAgICBnZXQ6IGZ1bmN0aW9uIGdldCgpIHsKICAgICAgcmV0dXJuIHRoaXMuX3NjaGVtYTsKICAgIH0KCiAgICAvKioKICAgICAqIFN0YXR1cyBvZiB0aGUgcmVwb3J0ZXIgb3Igb2JzZXJ2ZXIgY29ubmVjdGlvbiAodGhpcyBmaWVsZCBpcyBub3QgeWV0IHN0YWJsZSwgYW5kIGlzIHN1YnNqZWN0IHRvIGNoYW5nZSkKICAgICAqIEB0eXBlIHtTdGF0dXN9IC0gRW51bSBvZjogb24gfCBwYXVzZWQKICAgICAqLwogIH0sIHsKICAgIGtleTogJ3N0YXR1cycsCiAgICBnZXQ6IGZ1bmN0aW9uIGdldCgpIHsKICAgICAgcmV0dXJuIHRoaXMuX3N0YXR1czsKICAgIH0KCiAgICAvKioKICAgICAqIERhdGEgc3RydWN0dXJlIHRvIGJlIHN5bmNocm9uaXplZC4KICAgICAqIEB0eXBlIHtKU09OfSAtIEpTT04gc3RydWN0dXJlIHRoYXQgc2hvdWxkIGZvbGxvdyB0aGUgZGVmaW5lZCBzY2hlbWEsIGlmIGFueS4KICAgICAqLwogIH0sIHsKICAgIGtleTogJ2RhdGEnLAogICAgZ2V0OiBmdW5jdGlvbiBnZXQoKSB7CiAgICAgIHJldHVybiB0aGlzLl9zeW5jT2JqLmRhdGE7CiAgICB9CgogICAgLyoqCiAgICAgKiBBbGwgY3JlYXRlZCBjaGlsZHJlbidzIHNpbmNlIHRoZSBzdWJzY3JpcHRpb24sIGRvZXNuJ3QgY29udGFpbiBhbGwgY2hpbGRyZW4ncyBzaW5jZSByZXBvcnRlciBjcmVhdGlvbi4KICAgICAqIEB0eXBlIHtPYmplY3Q8Q2hpbGRJZCwgRGF0YU9iamVjdENoaWxkPn0KICAgICAqLwogIH0sIHsKICAgIGtleTogJ2NoaWxkcmVuJywKICAgIGdldDogZnVuY3Rpb24gZ2V0KCkgewogICAgICByZXR1cm4gdGhpcy5fY2hpbGRyZW47CiAgICB9CiAgfV0pOwoKICByZXR1cm4gRGF0YU9iamVjdDsKfSkoKTsKCmV4cG9ydHNbJ2RlZmF1bHQnXSA9IERhdGFPYmplY3Q7Cm1vZHVsZS5leHBvcnRzID0gZXhwb3J0c1snZGVmYXVsdCddOwoKfSx7Ii4uL3V0aWxzL3V0aWxzLmpzIjoxMDUsIi4vRGF0YU9iamVjdENoaWxkIjo5OCwiLi9TeW5jT2JqZWN0IjoxMDIsImJhYmVsLXJ1bnRpbWUvY29yZS1qcy9wcm9taXNlIjo3LCJiYWJlbC1ydW50aW1lL2hlbHBlcnMvY2xhc3MtY2FsbC1jaGVjayI6MTAsImJhYmVsLXJ1bnRpbWUvaGVscGVycy9jcmVhdGUtY2xhc3MiOjEyLCJiYWJlbC1ydW50aW1lL2hlbHBlcnMvaW50ZXJvcC1yZXF1aXJlLWRlZmF1bHQiOjE2fV0sOTg6W2Z1bmN0aW9uKHJlcXVpcmUsbW9kdWxlLGV4cG9ydHMpewondXNlIHN0cmljdCc7Cgp2YXIgX2NyZWF0ZUNsYXNzID0gcmVxdWlyZSgnYmFiZWwtcnVudGltZS9oZWxwZXJzL2NyZWF0ZS1jbGFzcycpWydkZWZhdWx0J107Cgp2YXIgX2NsYXNzQ2FsbENoZWNrID0gcmVxdWlyZSgnYmFiZWwtcnVudGltZS9oZWxwZXJzL2NsYXNzLWNhbGwtY2hlY2snKVsnZGVmYXVsdCddOwoKdmFyIF9pbnRlcm9wUmVxdWlyZURlZmF1bHQgPSByZXF1aXJlKCdiYWJlbC1ydW50aW1lL2hlbHBlcnMvaW50ZXJvcC1yZXF1aXJlLWRlZmF1bHQnKVsnZGVmYXVsdCddOwoKT2JqZWN0LmRlZmluZVByb3BlcnR5KGV4cG9ydHMsICdfX2VzTW9kdWxlJywgewogIHZhbHVlOiB0cnVlCn0pOwoKdmFyIF9TeW5jT2JqZWN0ID0gcmVxdWlyZSgnLi9TeW5jT2JqZWN0Jyk7Cgp2YXIgX1N5bmNPYmplY3QyID0gX2ludGVyb3BSZXF1aXJlRGVmYXVsdChfU3luY09iamVjdCk7Cgp2YXIgRGF0YU9iamVjdENoaWxkIC8qIGltcGxlbWVudHMgU3luY1N0YXR1cyAqLyA9IChmdW5jdGlvbiAoKSB7CiAgLyogcHJpdmF0ZQogICAtLS0tZXZlbnQgaGFuZGxlcnMtLS0tCiAgX29uUmVzcG9uc2VIYW5kbGVyOiAoZXZlbnQpID0+IHZvaWQKICAqLwoKICAvKioKICAgKiBAaWdub3JlCiAgICogU2hvdWxkIG5vdCBiZSB1c2VkIGRpcmVjdGx5IGJ5IEh5cGVydGllcy4gSXQncyBjYWxsZWQgYnkgdGhlIERhdGFPYmplY3QuYWRkQ2hpbGRyZW4KICAgKi8KCiAgZnVuY3Rpb24gRGF0YU9iamVjdENoaWxkKG93bmVyLCBjaGlsZElkLCBtc2dJZCwgYnVzLCBpbml0aWFsRGF0YSkgewogICAgX2NsYXNzQ2FsbENoZWNrKHRoaXMsIERhdGFPYmplY3RDaGlsZCk7CgogICAgdmFyIF90aGlzID0gdGhpczsKCiAgICBfdGhpcy5fb3duZXIgPSBvd25lcjsKICAgIF90aGlzLl9jaGlsZElkID0gY2hpbGRJZDsKICAgIF90aGlzLl9idXMgPSBidXM7CiAgICBfdGhpcy5fc3luY09iaiA9IG5ldyBfU3luY09iamVjdDJbJ2RlZmF1bHQnXShpbml0aWFsRGF0YSk7CgogICAgYnVzLmFkZExpc3RlbmVyKG93bmVyLCBmdW5jdGlvbiAobXNnKSB7CiAgICAgIGlmIChtc2cudHlwZSA9PT0gJ3Jlc3BvbnNlJyAmJiBtc2cuaWQgPT09IG1zZ0lkKSB7CiAgICAgICAgY29uc29sZS5sb2coJ0RhdGFPYmplY3RDaGlsZC5vblJlc3BvbnNlOicsIG1zZyk7CiAgICAgICAgX3RoaXMuX29uUmVzcG9uc2UobXNnKTsKICAgICAgfQogICAgfSk7CiAgfQoKICAvKioKICAgKiBDaGlsZHJlbiBJRCBnZW5lcmF0ZWQgb24gYWRkQ2hpbGRyZW4uIFVuaXF1ZSBpZGVudGlmaWVyCiAgICogQHR5cGUge1VSTH0gLSBVUkwgb2YgdGhlIGZvcm1hdCA8SHlwZXJ0eVVSTD4jPG51bWVyaWMtc2VxdWVuY2U+CiAgICovCgogIF9jcmVhdGVDbGFzcyhEYXRhT2JqZWN0Q2hpbGQsIFt7CiAgICBrZXk6ICdvbkNoYW5nZScsCgogICAgLyoqCiAgICAgKiBSZWdpc3RlciB0aGUgY2hhbmdlIGxpc3RlbmVycyBzZW50IGJ5IHRoZSByZXBvcnRlciBjaGlsZAogICAgICogQHBhcmFtIHtmdW5jdGlvbihldmVudDogTXNnRXZlbnQpfSBjYWxsYmFjawogICAgICovCiAgICB2YWx1ZTogZnVuY3Rpb24gb25DaGFuZ2UoY2FsbGJhY2spIHsKICAgICAgdGhpcy5fc3luY09iai5vYnNlcnZlKGZ1bmN0aW9uIChldmVudCkgewogICAgICAgIGNhbGxiYWNrKGV2ZW50KTsKICAgICAgfSk7CiAgICB9CgogICAgLyoqCiAgICAgKiBTZXR1cCB0aGUgY2FsbGJhY2sgdG8gcHJvY2VzcyByZXNwb25zZSBub3RpZmljYXRpb25zIG9mIHRoZSBjcmVhdGVzCiAgICAgKiBAcGFyYW0ge2Z1bmN0aW9uKGV2ZW50OiBNc2dFdmVudCl9IGNhbGxiYWNrCiAgICAgKi8KICB9LCB7CiAgICBrZXk6ICdvblJlc3BvbnNlJywKICAgIHZhbHVlOiBmdW5jdGlvbiBvblJlc3BvbnNlKGNhbGxiYWNrKSB7CiAgICAgIHRoaXMuX29uUmVzcG9uc2VIYW5kbGVyID0gY2FsbGJhY2s7CiAgICB9CiAgfSwgewogICAga2V5OiAnX29uUmVzcG9uc2UnLAogICAgdmFsdWU6IGZ1bmN0aW9uIF9vblJlc3BvbnNlKG1zZykgewogICAgICB2YXIgX3RoaXMgPSB0aGlzOwoKICAgICAgdmFyIGV2ZW50ID0gewogICAgICAgIHR5cGU6IG1zZy50eXBlLAogICAgICAgIHVybDogbXNnLmJvZHkuc291cmNlLAogICAgICAgIGNvZGU6IG1zZy5ib2R5LmNvZGUKICAgICAgfTsKCiAgICAgIGlmIChfdGhpcy5fb25SZXNwb25zZUhhbmRsZXIpIHsKICAgICAgICBfdGhpcy5fb25SZXNwb25zZUhhbmRsZXIoZXZlbnQpOwogICAgICB9CiAgICB9CiAgfSwgewogICAga2V5OiAnY2hpbGRJZCcsCiAgICBnZXQ6IGZ1bmN0aW9uIGdldCgpIHsKICAgICAgcmV0dXJuIHRoaXMuX2NoaWxkSWQ7CiAgICB9CgogICAgLyoqCiAgICAgKiBEYXRhIFN0cnVjdHVyZSB0byBiZSBzeW5jaHJvbml6ZWQuCiAgICAgKiBAdHlwZSB7SlNPTn0gLSBKU09OIHN0cnVjdHVyZSB0aGF0IHNob3VsZCBmb2xsb3cgdGhlIGRlZmluZWQgc2NoZW1hLCBpZiBhbnkuCiAgICAgKi8KICB9LCB7CiAgICBrZXk6ICdkYXRhJywKICAgIGdldDogZnVuY3Rpb24gZ2V0KCkgewogICAgICByZXR1cm4gdGhpcy5fc3luY09iai5kYXRhOwogICAgfQogIH1dKTsKCiAgcmV0dXJuIERhdGFPYmplY3RDaGlsZDsKfSkoKTsKCmV4cG9ydHNbJ2RlZmF1bHQnXSA9IERhdGFPYmplY3RDaGlsZDsKbW9kdWxlLmV4cG9ydHMgPSBleHBvcnRzWydkZWZhdWx0J107Cgp9LHsiLi9TeW5jT2JqZWN0IjoxMDIsImJhYmVsLXJ1bnRpbWUvaGVscGVycy9jbGFzcy1jYWxsLWNoZWNrIjoxMCwiYmFiZWwtcnVudGltZS9oZWxwZXJzL2NyZWF0ZS1jbGFzcyI6MTIsImJhYmVsLXJ1bnRpbWUvaGVscGVycy9pbnRlcm9wLXJlcXVpcmUtZGVmYXVsdCI6MTZ9XSw5OTpbZnVuY3Rpb24ocmVxdWlyZSxtb2R1bGUsZXhwb3J0cyl7Cid1c2Ugc3RyaWN0JzsKCnZhciBfZ2V0ID0gcmVxdWlyZSgnYmFiZWwtcnVudGltZS9oZWxwZXJzL2dldCcpWydkZWZhdWx0J107Cgp2YXIgX2luaGVyaXRzID0gcmVxdWlyZSgnYmFiZWwtcnVudGltZS9oZWxwZXJzL2luaGVyaXRzJylbJ2RlZmF1bHQnXTsKCnZhciBfY3JlYXRlQ2xhc3MgPSByZXF1aXJlKCdiYWJlbC1ydW50aW1lL2hlbHBlcnMvY3JlYXRlLWNsYXNzJylbJ2RlZmF1bHQnXTsKCnZhciBfY2xhc3NDYWxsQ2hlY2sgPSByZXF1aXJlKCdiYWJlbC1ydW50aW1lL2hlbHBlcnMvY2xhc3MtY2FsbC1jaGVjaycpWydkZWZhdWx0J107Cgp2YXIgX09iamVjdCRrZXlzID0gcmVxdWlyZSgnYmFiZWwtcnVudGltZS9jb3JlLWpzL29iamVjdC9rZXlzJylbJ2RlZmF1bHQnXTsKCnZhciBfaW50ZXJvcFJlcXVpcmVEZWZhdWx0ID0gcmVxdWlyZSgnYmFiZWwtcnVudGltZS9oZWxwZXJzL2ludGVyb3AtcmVxdWlyZS1kZWZhdWx0JylbJ2RlZmF1bHQnXTsKCk9iamVjdC5kZWZpbmVQcm9wZXJ0eShleHBvcnRzLCAnX19lc01vZHVsZScsIHsKICB2YWx1ZTogdHJ1ZQp9KTsKCnZhciBfRGF0YU9iamVjdDIgPSByZXF1aXJlKCcuL0RhdGFPYmplY3QnKTsKCnZhciBfRGF0YU9iamVjdDMgPSBfaW50ZXJvcFJlcXVpcmVEZWZhdWx0KF9EYXRhT2JqZWN0Mik7Cgp2YXIgRmlsdGVyVHlwZSA9IHsgQU5ZOiAnYW55JywgU1RBUlQ6ICdzdGFydCcsIEVYQUNUOiAnZXhhY3QnIH07Cgp2YXIgRGF0YU9iamVjdE9ic2VydmVyID0gKGZ1bmN0aW9uIChfRGF0YU9iamVjdCkgewogIF9pbmhlcml0cyhEYXRhT2JqZWN0T2JzZXJ2ZXIsIF9EYXRhT2JqZWN0KTsKCiAgLyogcHJpdmF0ZQogICAtLS0tZXZlbnQgaGFuZGxlcnMtLS0tCiAgX2ZpbHRlcnM6IHs8ZmlsdGVyPjoge3R5cGU6IDxzdGFydCwgZXhhY3Q+LCBjYWxsYmFjazogPGZ1bmN0aW9uPn0gfQogICovCgogIC8qKgogICAqIEBpZ25vcmUKICAgKiBTaG91bGQgbm90IGJlIHVzZWQgZGlyZWN0bHkgYnkgSHlwZXJ0aWVzLiBJdCdzIGNhbGxlZCBieSB0aGUgU3luY2hlci5zdWJzY3JpYmUgbWV0aG9kCiAgICovCgogIGZ1bmN0aW9uIERhdGFPYmplY3RPYnNlcnZlcihvd25lciwgdXJsLCBzY2hlbWEsIGJ1cywgaW5pdGlhbFN0YXR1cywgaW5pdGlhbERhdGEsIGNoaWxkcmVuLCBpbml0aWFsVmVyc2lvbikgewogICAgX2NsYXNzQ2FsbENoZWNrKHRoaXMsIERhdGFPYmplY3RPYnNlcnZlcik7CgogICAgX2dldChPYmplY3QuZ2V0UHJvdG90eXBlT2YoRGF0YU9iamVjdE9ic2VydmVyLnByb3RvdHlwZSksICdjb25zdHJ1Y3RvcicsIHRoaXMpLmNhbGwodGhpcywgb3duZXIsIHVybCwgc2NoZW1hLCBidXMsIGluaXRpYWxTdGF0dXMsIGluaXRpYWxEYXRhLCBjaGlsZHJlbik7CiAgICB2YXIgX3RoaXMgPSB0aGlzOwoKICAgIF90aGlzLl92ZXJzaW9uID0gaW5pdGlhbFZlcnNpb247CgogICAgLy9hZGQgbGlzdGVuZXIgZm9yIG9ialVSTAogICAgYnVzLmFkZExpc3RlbmVyKHVybCwgZnVuY3Rpb24gKG1zZykgewogICAgICBjb25zb2xlLmxvZygnRGF0YU9iamVjdE9ic2VydmVyLScgKyB1cmwgKyAnLVJDVjogJywgbXNnKTsKICAgICAgX3RoaXMuX2NoYW5nZU9iamVjdChfdGhpcy5fc3luY09iaiwgbXNnKTsKICAgIH0pOwoKICAgIF90aGlzLl9zeW5jT2JqLm9ic2VydmUoZnVuY3Rpb24gKGV2ZW50KSB7CiAgICAgIF90aGlzLl9vbkZpbHRlcihldmVudCk7CiAgICB9KTsKCiAgICBfdGhpcy5fZmlsdGVycyA9IHt9OwogIH0KCiAgLyoqCiAgICogUmVnaXN0ZXIgdGhlIGNoYW5nZSBsaXN0ZW5lcnMgc2VudCBieSB0aGUgcmVwb3J0ZXIKICAgKiBAcGFyYW0ge3N0cmluZ30gZmlsdGVyIC0gRmlsdGVyIHRoYXQgaWRlbnRpZmllcyB0aGUgZmllbGQgKHNlcGFyZXRlZCBkb3QgcGF0aCkuIEFjY2VwdHMgKiBhdCB0aGUgZW5kIGZvciBhIG1vcmUgdW5yZXN0cmljdGVkIGZpbHRlcmluZy4KICAgKiBAcGFyYW0ge2Z1bmN0aW9uKGV2ZW50OiBNc2dFdmVudCl9IGNhbGxiYWNrCiAgICovCgogIF9jcmVhdGVDbGFzcyhEYXRhT2JqZWN0T2JzZXJ2ZXIsIFt7CiAgICBrZXk6ICdvbkNoYW5nZScsCiAgICB2YWx1ZTogZnVuY3Rpb24gb25DaGFuZ2UoZmlsdGVyLCBjYWxsYmFjaykgewogICAgICB2YXIga2V5ID0gZmlsdGVyOwogICAgICB2YXIgZmlsdGVyT2JqID0gewogICAgICAgIHR5cGU6IEZpbHRlclR5cGUuRVhBQ1QsCiAgICAgICAgY2FsbGJhY2s6IGNhbGxiYWNrCiAgICAgIH07CgogICAgICB2YXIgaWR4ID0gZmlsdGVyLmluZGV4T2YoJyonKTsKICAgICAgaWYgKGlkeCA9PT0gZmlsdGVyLmxlbmd0aCAtIDEpIHsKICAgICAgICBpZiAoaWR4ID09PSAwKSB7CiAgICAgICAgICBmaWx0ZXJPYmoudHlwZSA9IEZpbHRlclR5cGUuQU5ZOwogICAgICAgIH0gZWxzZSB7CiAgICAgICAgICBmaWx0ZXJPYmoudHlwZSA9IEZpbHRlclR5cGUuU1RBUlQ7CiAgICAgICAgICBrZXkgPSBmaWx0ZXIuc3Vic3RyKDAsIGZpbHRlci5sZW5ndGggLSAxKTsKICAgICAgICB9CiAgICAgIH0KCiAgICAgIHRoaXMuX2ZpbHRlcnNba2V5XSA9IGZpbHRlck9iajsKICAgIH0KICB9LCB7CiAgICBrZXk6ICdfb25GaWx0ZXInLAogICAgdmFsdWU6IGZ1bmN0aW9uIF9vbkZpbHRlcihldmVudCkgewogICAgICB2YXIgX3RoaXMgPSB0aGlzOwoKICAgICAgX09iamVjdCRrZXlzKF90aGlzLl9maWx0ZXJzKS5mb3JFYWNoKGZ1bmN0aW9uIChrZXkpIHsKICAgICAgICB2YXIgZmlsdGVyID0gX3RoaXMuX2ZpbHRlcnNba2V5XTsKICAgICAgICBpZiAoZmlsdGVyLnR5cGUgPT09IEZpbHRlclR5cGUuQU5ZKSB7CiAgICAgICAgICAvL21hdGNoIGFueXRoaW5nCiAgICAgICAgICBmaWx0ZXIuY2FsbGJhY2soZXZlbnQpOwogICAgICAgIH0gZWxzZSBpZiAoZmlsdGVyLnR5cGUgPT09IEZpbHRlclR5cGUuU1RBUlQpIHsKICAgICAgICAgIC8vaWYgc3RhcnRzIHdpdGggZmlsdGVyLi4uCiAgICAgICAgICBpZiAoZXZlbnQuZmllbGQuaW5kZXhPZihrZXkpID09PSAwKSB7CiAgICAgICAgICAgIGZpbHRlci5jYWxsYmFjayhldmVudCk7CiAgICAgICAgICB9CiAgICAgICAgfSBlbHNlIGlmIChmaWx0ZXIudHlwZSA9PT0gRmlsdGVyVHlwZS5FWEFDVCkgewogICAgICAgICAgLy9leGFjdCBtYXRjaAogICAgICAgICAgaWYgKGV2ZW50LmZpZWxkID09PSBrZXkpIHsKICAgICAgICAgICAgZmlsdGVyLmNhbGxiYWNrKGV2ZW50KTsKICAgICAgICAgIH0KICAgICAgICB9CiAgICAgIH0pOwogICAgfQogIH1dKTsKCiAgcmV0dXJuIERhdGFPYmplY3RPYnNlcnZlcjsKfSkoX0RhdGFPYmplY3QzWydkZWZhdWx0J10gLyogaW1wbGVtZW50cyBTeW5jU3RhdHVzICovKTsKCmV4cG9ydHNbJ2RlZmF1bHQnXSA9IERhdGFPYmplY3RPYnNlcnZlcjsKbW9kdWxlLmV4cG9ydHMgPSBleHBvcnRzWydkZWZhdWx0J107Cgp9LHsiLi9EYXRhT2JqZWN0Ijo5NywiYmFiZWwtcnVudGltZS9jb3JlLWpzL29iamVjdC9rZXlzIjo1LCJiYWJlbC1ydW50aW1lL2hlbHBlcnMvY2xhc3MtY2FsbC1jaGVjayI6MTAsImJhYmVsLXJ1bnRpbWUvaGVscGVycy9jcmVhdGUtY2xhc3MiOjEyLCJiYWJlbC1ydW50aW1lL2hlbHBlcnMvZ2V0IjoxNCwiYmFiZWwtcnVudGltZS9oZWxwZXJzL2luaGVyaXRzIjoxNSwiYmFiZWwtcnVudGltZS9oZWxwZXJzL2ludGVyb3AtcmVxdWlyZS1kZWZhdWx0IjoxNn1dLDEwMDpbZnVuY3Rpb24ocmVxdWlyZSxtb2R1bGUsZXhwb3J0cyl7Cid1c2Ugc3RyaWN0JzsKCnZhciBfZ2V0ID0gcmVxdWlyZSgnYmFiZWwtcnVudGltZS9oZWxwZXJzL2dldCcpWydkZWZhdWx0J107Cgp2YXIgX2luaGVyaXRzID0gcmVxdWlyZSgnYmFiZWwtcnVudGltZS9oZWxwZXJzL2luaGVyaXRzJylbJ2RlZmF1bHQnXTsKCnZhciBfY3JlYXRlQ2xhc3MgPSByZXF1aXJlKCdiYWJlbC1ydW50aW1lL2hlbHBlcnMvY3JlYXRlLWNsYXNzJylbJ2RlZmF1bHQnXTsKCnZhciBfY2xhc3NDYWxsQ2hlY2sgPSByZXF1aXJlKCdiYWJlbC1ydW50aW1lL2hlbHBlcnMvY2xhc3MtY2FsbC1jaGVjaycpWydkZWZhdWx0J107Cgp2YXIgX2ludGVyb3BSZXF1aXJlRGVmYXVsdCA9IHJlcXVpcmUoJ2JhYmVsLXJ1bnRpbWUvaGVscGVycy9pbnRlcm9wLXJlcXVpcmUtZGVmYXVsdCcpWydkZWZhdWx0J107CgpPYmplY3QuZGVmaW5lUHJvcGVydHkoZXhwb3J0cywgJ19fZXNNb2R1bGUnLCB7CiAgdmFsdWU6IHRydWUKfSk7Cgp2YXIgX0RhdGFPYmplY3QyID0gcmVxdWlyZSgnLi9EYXRhT2JqZWN0Jyk7Cgp2YXIgX0RhdGFPYmplY3QzID0gX2ludGVyb3BSZXF1aXJlRGVmYXVsdChfRGF0YU9iamVjdDIpOwoKdmFyIF91dGlsc1V0aWxzSnMgPSByZXF1aXJlKCcuLi91dGlscy91dGlscy5qcycpOwoKdmFyIERhdGFPYmplY3RSZXBvcnRlciA9IChmdW5jdGlvbiAoX0RhdGFPYmplY3QpIHsKICBfaW5oZXJpdHMoRGF0YU9iamVjdFJlcG9ydGVyLCBfRGF0YU9iamVjdCk7CgogIC8qIHByaXZhdGUKICBfc3Vic2NyaXB0aW9uczogPGh5cGVydHlVcmw6IHsgc3RhdHVzOiBzdHJpbmcgfSB9PgogICAtLS0tZXZlbnQgaGFuZGxlcnMtLS0tCiAgX29uU3Vic2NyaXB0aW9uSGFuZGxlcjogKGV2ZW50KSA9PiB2b2lkCiAgX29uUmVzcG9uc2VIYW5kbGVyOiAoZXZlbnQpID0+IHZvaWQKICAqLwoKICAvKioKICAgKiBAaWdub3JlCiAgICogU2hvdWxkIG5vdCBiZSB1c2VkIGRpcmVjdGx5IGJ5IEh5cGVydGllcy4gSXQncyBjYWxsZWQgYnkgdGhlIFN5bmNoZXIuY3JlYXRlIG1ldGhvZAogICAqLwoKICBmdW5jdGlvbiBEYXRhT2JqZWN0UmVwb3J0ZXIob3duZXIsIHVybCwgc2NoZW1hLCBidXMsIGluaXRpYWxTdGF0dXMsIGluaXRpYWxEYXRhLCBjaGlsZHJlbikgewogICAgX2NsYXNzQ2FsbENoZWNrKHRoaXMsIERhdGFPYmplY3RSZXBvcnRlcik7CgogICAgX2dldChPYmplY3QuZ2V0UHJvdG90eXBlT2YoRGF0YU9iamVjdFJlcG9ydGVyLnByb3RvdHlwZSksICdjb25zdHJ1Y3RvcicsIHRoaXMpLmNhbGwodGhpcywgb3duZXIsIHVybCwgc2NoZW1hLCBidXMsIGluaXRpYWxTdGF0dXMsIGluaXRpYWxEYXRhLCBjaGlsZHJlbik7CiAgICB2YXIgX3RoaXMgPSB0aGlzOwoKICAgIGJ1cy5hZGRMaXN0ZW5lcihvd25lciwgZnVuY3Rpb24gKG1zZykgewogICAgICBpZiAobXNnLnR5cGUgPT09ICdyZXNwb25zZScgJiYgbXNnLmJvZHkuc291cmNlID09PSB1cmwpIHsKICAgICAgICBfdGhpcy5fb25SZXNwb25zZShtc2cpOwogICAgICB9CiAgICB9KTsKCiAgICBfdGhpcy5fc3luY09iai5vYnNlcnZlKGZ1bmN0aW9uIChldmVudCkgewogICAgICBjb25zb2xlLmxvZygnRGF0YU9iamVjdFJlcG9ydGVyLScgKyB1cmwgKyAnLVNFTkQ6ICcsIGV2ZW50KTsKICAgICAgX3RoaXMuX29uQ2hhbmdlKGV2ZW50KTsKICAgIH0pOwoKICAgIF90aGlzLl9zdWJzY3JpcHRpb25zID0ge307CiAgfQoKICAvKioKICAgKiBTdWJzY3JpcHRpb25zIHJlcXVlc3RlZCBhbmQgYWNjZXB0ZWQgdG8gdGhpcyByZXBvcnRlcgogICAqIEB0eXBlIHtPYmplY3Q8SHlwZXJ0eVVSTCwgU3luY1N1YnNjcmlwdGlvbj59CiAgICovCgogIF9jcmVhdGVDbGFzcyhEYXRhT2JqZWN0UmVwb3J0ZXIsIFt7CiAgICBrZXk6ICdvblN1YnNjcmlwdGlvbicsCgogICAgLyoqCiAgICAgKiBTZXR1cCB0aGUgY2FsbGJhY2sgdG8gcHJvY2VzcyBzdWJzY3JpYmUgYW5kIHVuc3Vic2NyaWJlIG5vdGlmaWNhdGlvbnMKICAgICAqIEBwYXJhbSB7ZnVuY3Rpb24oZXZlbnQ6IE1zZ0V2ZW50KX0gY2FsbGJhY2sKICAgICAqLwogICAgdmFsdWU6IGZ1bmN0aW9uIG9uU3Vic2NyaXB0aW9uKGNhbGxiYWNrKSB7CiAgICAgIHRoaXMuX29uU3Vic2NyaXB0aW9uSGFuZGxlciA9IGNhbGxiYWNrOwogICAgfQoKICAgIC8qKgogICAgICogU2V0dXAgdGhlIGNhbGxiYWNrIHRvIHByb2Nlc3MgcmVzcG9uc2Ugbm90aWZpY2F0aW9ucyBvZiB0aGUgY3JlYXRlJ3MKICAgICAqIEBwYXJhbSB7ZnVuY3Rpb24oZXZlbnQ6IE1zZ0V2ZW50KX0gY2FsbGJhY2sKICAgICAqLwogIH0sIHsKICAgIGtleTogJ29uUmVzcG9uc2UnLAogICAgdmFsdWU6IGZ1bmN0aW9uIG9uUmVzcG9uc2UoY2FsbGJhY2spIHsKICAgICAgdGhpcy5fb25SZXNwb25zZUhhbmRsZXIgPSBjYWxsYmFjazsKICAgIH0KICB9LCB7CiAgICBrZXk6ICdfb25Gb3J3YXJkJywKICAgIHZhbHVlOiBmdW5jdGlvbiBfb25Gb3J3YXJkKG1zZykgewogICAgICB2YXIgX3RoaXMgPSB0aGlzOwoKICAgICAgY29uc29sZS5sb2coJ0RhdGFPYmplY3RSZXBvcnRlci1SQ1Y6ICcsIG1zZyk7CiAgICAgIHN3aXRjaCAobXNnLmJvZHkudHlwZSkgewogICAgICAgIGNhc2UgJ3N1YnNjcmliZSc6CiAgICAgICAgICBfdGhpcy5fb25TdWJzY3JpYmUobXNnKTticmVhazsKICAgICAgICBjYXNlICd1bnN1YnNjcmliZSc6CiAgICAgICAgICBfdGhpcy5fb25VblN1YnNjcmliZShtc2cpO2JyZWFrOwogICAgICB9CiAgICB9CiAgfSwgewogICAga2V5OiAnX29uU3Vic2NyaWJlJywKICAgIHZhbHVlOiBmdW5jdGlvbiBfb25TdWJzY3JpYmUobXNnKSB7CiAgICAgIHZhciBfdGhpcyA9IHRoaXM7CiAgICAgIHZhciBoeXBlcnR5VXJsID0gbXNnLmJvZHkuZnJvbTsKCiAgICAgIHZhciBldmVudCA9IHsKICAgICAgICB0eXBlOiBtc2cuYm9keS50eXBlLAogICAgICAgIHVybDogaHlwZXJ0eVVybCwKCiAgICAgICAgYWNjZXB0OiBmdW5jdGlvbiBhY2NlcHQoKSB7CiAgICAgICAgICAvL2NyZWF0ZSBuZXcgc3Vic2NyaXB0aW9uCiAgICAgICAgICB2YXIgc3ViID0geyB1cmw6IGh5cGVydHlVcmwsIHN0YXR1czogJ29uJyB9OwogICAgICAgICAgX3RoaXMuX3N1YnNjcmlwdGlvbnNbaHlwZXJ0eVVybF0gPSBzdWI7CgogICAgICAgICAgLy9zZW5kIG9rIHJlc3BvbnNlIG1lc3NhZ2UKICAgICAgICAgIF90aGlzLl9idXMucG9zdE1lc3NhZ2UoewogICAgICAgICAgICBpZDogbXNnLmlkLCB0eXBlOiAncmVzcG9uc2UnLCBmcm9tOiBtc2cudG8sIHRvOiBtc2cuZnJvbSwKICAgICAgICAgICAgYm9keTogeyBjb2RlOiAyMDAsIHNjaGVtYTogX3RoaXMuX3NjaGVtYSwgdmVyc2lvbjogX3RoaXMuX3ZlcnNpb24sIHZhbHVlOiAoMCwgX3V0aWxzVXRpbHNKcy5kZWVwQ2xvbmUpKF90aGlzLmRhdGEpIH0KICAgICAgICAgIH0pOwoKICAgICAgICAgIHJldHVybiBzdWI7CiAgICAgICAgfSwKCiAgICAgICAgcmVqZWN0OiBmdW5jdGlvbiByZWplY3QocmVhc29uKSB7CiAgICAgICAgICAvL3NlbmQgcmVqZWN0IHJlc3BvbnNlIG1lc3NhZ2UKICAgICAgICAgIF90aGlzLl9idXMucG9zdE1lc3NhZ2UoewogICAgICAgICAgICBpZDogbXNnLmlkLCB0eXBlOiAncmVzcG9uc2UnLCBmcm9tOiBtc2cudG8sIHRvOiBtc2cuZnJvbSwKICAgICAgICAgICAgYm9keTogeyBjb2RlOiA0MDMsIGRlc2M6IHJlYXNvbiB9CiAgICAgICAgICB9KTsKICAgICAgICB9CiAgICAgIH07CgogICAgICBpZiAoX3RoaXMuX29uU3Vic2NyaXB0aW9uSGFuZGxlcikgewogICAgICAgIF90aGlzLl9vblN1YnNjcmlwdGlvbkhhbmRsZXIoZXZlbnQpOwogICAgICB9CiAgICB9CiAgfSwgewogICAga2V5OiAnX29uVW5TdWJzY3JpYmUnLAogICAgdmFsdWU6IGZ1bmN0aW9uIF9vblVuU3Vic2NyaWJlKG1zZykgewogICAgICB2YXIgX3RoaXMgPSB0aGlzOwogICAgICB2YXIgaHlwZXJ0eVVybCA9IG1zZy5ib2R5LmZyb207CgogICAgICB2YXIgc3ViID0gX3RoaXMuX3N1YnNjcmlwdGlvbnNbaHlwZXJ0eVVybF07CiAgICAgIGRlbGV0ZSBfdGhpcy5fc3Vic2NyaXB0aW9uc1toeXBlcnR5VXJsXTsKCiAgICAgIHZhciBldmVudCA9IHsKICAgICAgICB0eXBlOiBtc2cuYm9keS50eXBlLAogICAgICAgIHVybDogaHlwZXJ0eVVybCwKICAgICAgICBvYmplY3Q6IHN1YgogICAgICB9OwoKICAgICAgaWYgKF90aGlzLl9vblN1YnNjcmlwdGlvbkhhbmRsZXIpIHsKICAgICAgICBfdGhpcy5fb25TdWJzY3JpcHRpb25IYW5kbGVyKGV2ZW50KTsKICAgICAgfQogICAgfQogIH0sIHsKICAgIGtleTogJ19vblJlc3BvbnNlJywKICAgIHZhbHVlOiBmdW5jdGlvbiBfb25SZXNwb25zZShtc2cpIHsKICAgICAgdmFyIF90aGlzID0gdGhpczsKCiAgICAgIHZhciBldmVudCA9IHsKICAgICAgICB0eXBlOiBtc2cudHlwZSwKICAgICAgICB1cmw6IG1zZy5mcm9tLAogICAgICAgIGNvZGU6IG1zZy5ib2R5LmNvZGUKICAgICAgfTsKCiAgICAgIGlmIChfdGhpcy5fb25SZXNwb25zZUhhbmRsZXIpIHsKICAgICAgICBfdGhpcy5fb25SZXNwb25zZUhhbmRsZXIoZXZlbnQpOwogICAgICB9CiAgICB9CiAgfSwgewogICAga2V5OiAnc3Vic2NyaXB0aW9ucycsCiAgICBnZXQ6IGZ1bmN0aW9uIGdldCgpIHsKICAgICAgcmV0dXJuIHRoaXMuX3N1YnNjcmlwdGlvbnM7CiAgICB9CiAgfV0pOwoKICByZXR1cm4gRGF0YU9iamVjdFJlcG9ydGVyOwp9KShfRGF0YU9iamVjdDNbJ2RlZmF1bHQnXSAvKiBpbXBsZW1lbnRzIFN5bmNTdGF0dXMgKi8pOwoKZXhwb3J0c1snZGVmYXVsdCddID0gRGF0YU9iamVjdFJlcG9ydGVyOwptb2R1bGUuZXhwb3J0cyA9IGV4cG9ydHNbJ2RlZmF1bHQnXTsKCn0seyIuLi91dGlscy91dGlscy5qcyI6MTA1LCIuL0RhdGFPYmplY3QiOjk3LCJiYWJlbC1ydW50aW1lL2hlbHBlcnMvY2xhc3MtY2FsbC1jaGVjayI6MTAsImJhYmVsLXJ1bnRpbWUvaGVscGVycy9jcmVhdGUtY2xhc3MiOjEyLCJiYWJlbC1ydW50aW1lL2hlbHBlcnMvZ2V0IjoxNCwiYmFiZWwtcnVudGltZS9oZWxwZXJzL2luaGVyaXRzIjoxNSwiYmFiZWwtcnVudGltZS9oZWxwZXJzL2ludGVyb3AtcmVxdWlyZS1kZWZhdWx0IjoxNn1dLDEwMTpbZnVuY3Rpb24ocmVxdWlyZSxtb2R1bGUsZXhwb3J0cyl7Ci8qKgogKiBAYWNjZXNzIHByaXZhdGUKICovCid1c2Ugc3RyaWN0JzsKCnZhciBfY3JlYXRlQ2xhc3MgPSByZXF1aXJlKCdiYWJlbC1ydW50aW1lL2hlbHBlcnMvY3JlYXRlLWNsYXNzJylbJ2RlZmF1bHQnXTsKCnZhciBfY2xhc3NDYWxsQ2hlY2sgPSByZXF1aXJlKCdiYWJlbC1ydW50aW1lL2hlbHBlcnMvY2xhc3MtY2FsbC1jaGVjaycpWydkZWZhdWx0J107CgpPYmplY3QuZGVmaW5lUHJvcGVydHkoZXhwb3J0cywgJ19fZXNNb2R1bGUnLCB7CiAgdmFsdWU6IHRydWUKfSk7Cgp2YXIgRGF0YVByb3Zpc2lvbmFsID0gKGZ1bmN0aW9uICgpIHsKICAvKiBwcml2YXRlCiAgX2NoaWxkcmVuTGlzdGVuZXJzOiBbTXNnTGlzdGVuZXJdCiAgX2xpc3RlbmVyOiBNc2dMaXN0ZW5lcgogICBfY2hhbmdlczogW10KICAqLwoKICBmdW5jdGlvbiBEYXRhUHJvdmlzaW9uYWwob3duZXIsIHVybCwgYnVzLCBjaGlsZHJlbikgewogICAgX2NsYXNzQ2FsbENoZWNrKHRoaXMsIERhdGFQcm92aXNpb25hbCk7CgogICAgdmFyIF90aGlzID0gdGhpczsKCiAgICBfdGhpcy5fY2hhbmdlcyA9IFtdOwogICAgX3RoaXMuX2NoaWxkcmVuID0gY2hpbGRyZW47CiAgICBfdGhpcy5fY2hpbGRyZW5MaXN0ZW5lcnMgPSBbXTsKCiAgICBfdGhpcy5fbGlzdGVuZXIgPSBidXMuYWRkTGlzdGVuZXIodXJsLCBmdW5jdGlvbiAobXNnKSB7CiAgICAgIGNvbnNvbGUubG9nKCdEYXRhUHJvdmlzaW9uYWwtJyArIHVybCArICctUkNWOiAnLCBtc2cpOwogICAgICBfdGhpcy5fY2hhbmdlcy5wdXNoKG1zZyk7CiAgICB9KTsKCiAgICAvKmlmIChjaGlsZHJlbikgewogICAgICBsZXQgY2hpbGRCYXNlVVJMID0gdXJsICsgJy9jaGlsZHJlbi8nOwogICAgICBjaGlsZHJlbi5mb3JFYWNoKChjaGlsZCkgPT4gewogICAgICAgIGxldCBjaGlsZFVSTCA9IGNoaWxkQmFzZVVSTCArIGNoaWxkOwogICAgICAgIGxldCBsaXN0ZW5lciA9IGJ1cy5hZGRMaXN0ZW5lcihjaGlsZFVSTCwgKG1zZykgPT4gewogICAgICAgICAgLy9pZ25vcmUgbXNnIHNlbnQgYnkgaGltc2VsZgogICAgICAgICAgaWYgKG1zZy5mcm9tICE9PSBvd25lcikgewogICAgICAgICAgICBjb25zb2xlLmxvZyhtc2cpOwogICAgICAgICAgfQogICAgICAgIH0pOwogICAgICAgICBfdGhpcy5fY2hpbGRyZW5MaXN0ZW5lcnMucHVzaChsaXN0ZW5lcik7CiAgICAgIH0pOwogICAgfSovCiAgfQoKICBfY3JlYXRlQ2xhc3MoRGF0YVByb3Zpc2lvbmFsLCBbewogICAga2V5OiAnYXBwbHknLAogICAgdmFsdWU6IGZ1bmN0aW9uIGFwcGx5KG9ic2VydmVyKSB7CiAgICAgIHZhciBfdGhpcyA9IHRoaXM7CiAgICAgIF90aGlzLl9jaGFuZ2VzLmZvckVhY2goZnVuY3Rpb24gKGNoYW5nZSkgewogICAgICAgIG9ic2VydmVyLl9jaGFuZ2VPYmplY3Qob2JzZXJ2ZXIuX3N5bmNPYmosIGNoYW5nZSk7CiAgICAgIH0pOwogICAgfQogIH0sIHsKICAgIGtleTogJ3JlbGVhc2UnLAogICAgdmFsdWU6IGZ1bmN0aW9uIHJlbGVhc2UoKSB7CiAgICAgIHRoaXMuX2xpc3RlbmVyLnJlbW92ZSgpOwoKICAgICAgLyp0aGlzLl9jaGlsZHJlbkxpc3RlbmVycy5mb3JFYWNoKChsaXN0ZW5lcikgPT4gewogICAgICAgIGxpc3RlbmVyLnJlbW92ZSgpOwogICAgICB9KTsqLwogICAgfQogIH0sIHsKICAgIGtleTogJ2NoaWxkcmVuJywKICAgIGdldDogZnVuY3Rpb24gZ2V0KCkgewogICAgICByZXR1cm4gdGhpcy5fY2hpbGRyZW47CiAgICB9CiAgfV0pOwoKICByZXR1cm4gRGF0YVByb3Zpc2lvbmFsOwp9KSgpOwoKZXhwb3J0c1snZGVmYXVsdCddID0gRGF0YVByb3Zpc2lvbmFsOwptb2R1bGUuZXhwb3J0cyA9IGV4cG9ydHNbJ2RlZmF1bHQnXTsKCn0seyJiYWJlbC1ydW50aW1lL2hlbHBlcnMvY2xhc3MtY2FsbC1jaGVjayI6MTAsImJhYmVsLXJ1bnRpbWUvaGVscGVycy9jcmVhdGUtY2xhc3MiOjEyfV0sMTAyOltmdW5jdGlvbihyZXF1aXJlLG1vZHVsZSxleHBvcnRzKXsKJ3VzZSBzdHJpY3QnOwoKdmFyIF9jcmVhdGVDbGFzcyA9IHJlcXVpcmUoJ2JhYmVsLXJ1bnRpbWUvaGVscGVycy9jcmVhdGUtY2xhc3MnKVsnZGVmYXVsdCddOwoKdmFyIF9jbGFzc0NhbGxDaGVjayA9IHJlcXVpcmUoJ2JhYmVsLXJ1bnRpbWUvaGVscGVycy9jbGFzcy1jYWxsLWNoZWNrJylbJ2RlZmF1bHQnXTsKCnZhciBfT2JqZWN0JGtleXMgPSByZXF1aXJlKCdiYWJlbC1ydW50aW1lL2NvcmUtanMvb2JqZWN0L2tleXMnKVsnZGVmYXVsdCddOwoKT2JqZWN0LmRlZmluZVByb3BlcnR5KGV4cG9ydHMsICdfX2VzTW9kdWxlJywgewogIHZhbHVlOiB0cnVlCn0pOwoKdmFyIF91dGlsc1V0aWxzSnMgPSByZXF1aXJlKCcuLi91dGlscy91dGlscy5qcycpOwoKLyoqCiAqIEBhY2Nlc3MgcHJpdmF0ZQogKi8KCnZhciBTeW5jT2JqZWN0ID0gKGZ1bmN0aW9uICgpIHsKICAvKiBwcml2YXRlCiAgICBfZGF0YTogYW55OwogICAgX29ic2VydmVyczogKChldmVudDogQ2hhbmdlRXZlbnQpID0+IHZvaWQpW10KICAqLwoKICBmdW5jdGlvbiBTeW5jT2JqZWN0KGluaXRpYWxEYXRhKSB7CiAgICBfY2xhc3NDYWxsQ2hlY2sodGhpcywgU3luY09iamVjdCk7CgogICAgdmFyIF90aGlzID0gdGhpczsKCiAgICBfdGhpcy5fb2JzZXJ2ZXJzID0gW107CiAgICBfdGhpcy5fZmlsdGVycyA9IHt9OwoKICAgIGlmIChpbml0aWFsRGF0YSkgewogICAgICBfdGhpcy5fZGF0YSA9ICgwLCBfdXRpbHNVdGlsc0pzLmRlZXBDbG9uZSkoaW5pdGlhbERhdGEpOwogICAgfSBlbHNlIHsKICAgICAgX3RoaXMuX2RhdGEgPSB7fTsKICAgIH0KCiAgICBfdGhpcy5faW50ZXJuYWxPYnNlcnZlKG5ldyBQYXRoKCksIF90aGlzLl9kYXRhKTsKICB9CgogIC8vZHluYW1pYyBwYXRoIGZvciBBcnJheSBpbmRleC4uLgoKICBfY3JlYXRlQ2xhc3MoU3luY09iamVjdCwgW3sKICAgIGtleTogJ29ic2VydmUnLAogICAgdmFsdWU6IGZ1bmN0aW9uIG9ic2VydmUoY2FsbGJhY2spIHsKICAgICAgdGhpcy5fb2JzZXJ2ZXJzLnB1c2goY2FsbGJhY2spOwogICAgfQogIH0sIHsKICAgIGtleTogJ2ZpbmQnLAogICAgdmFsdWU6IGZ1bmN0aW9uIGZpbmQocGF0aCkgewogICAgICB2YXIgbGlzdCA9IHBhdGguc3BsaXQoJy4nKTsKCiAgICAgIHJldHVybiB0aGlzLl9maW5kV2l0aFNwbGl0KGxpc3QpOwogICAgfQogIH0sIHsKICAgIGtleTogJ2ZpbmRCZWZvcmUnLAogICAgdmFsdWU6IGZ1bmN0aW9uIGZpbmRCZWZvcmUocGF0aCkgewogICAgICB2YXIgcmVzdWx0ID0ge307CiAgICAgIHZhciBsaXN0ID0gcGF0aC5zcGxpdCgnLicpOwogICAgICByZXN1bHQubGFzdCA9IGxpc3QucG9wKCk7CiAgICAgIHJlc3VsdC5vYmogPSB0aGlzLl9maW5kV2l0aFNwbGl0KGxpc3QpOwoKICAgICAgcmV0dXJuIHJlc3VsdDsKICAgIH0KICB9LCB7CiAgICBrZXk6ICdfZmluZFdpdGhTcGxpdCcsCiAgICB2YWx1ZTogZnVuY3Rpb24gX2ZpbmRXaXRoU3BsaXQobGlzdCkgewogICAgICB2YXIgb2JqID0gdGhpcy5fZGF0YTsKICAgICAgbGlzdC5mb3JFYWNoKGZ1bmN0aW9uICh2YWx1ZSkgewogICAgICAgIG9iaiA9IG9ialt2YWx1ZV07CiAgICAgIH0pOwoKICAgICAgcmV0dXJuIG9iajsKICAgIH0KICB9LCB7CiAgICBrZXk6ICdfZmlyZUV2ZW50JywKICAgIHZhbHVlOiBmdW5jdGlvbiBfZmlyZUV2ZW50KGV2ZW50KSB7CiAgICAgIHRoaXMuX29ic2VydmVycy5mb3JFYWNoKGZ1bmN0aW9uIChjYWxsYmFjaykgewogICAgICAgIGNhbGxiYWNrKGV2ZW50KTsKICAgICAgfSk7CiAgICB9CiAgfSwgewogICAga2V5OiAnX2lzT2JzZXJ2YWJsZScsCiAgICB2YWx1ZTogZnVuY3Rpb24gX2lzT2JzZXJ2YWJsZShvYmopIHsKICAgICAgaWYgKG9iai5jb25zdHJ1Y3RvciA9PT0gT2JqZWN0IHx8IG9iai5jb25zdHJ1Y3RvciA9PT0gQXJyYXkpIHsKICAgICAgICByZXR1cm4gdHJ1ZTsKICAgICAgfQoKICAgICAgcmV0dXJuIGZhbHNlOwogICAgfQogIH0sIHsKICAgIGtleTogJ19pbnRlcm5hbE9ic2VydmUnLAogICAgdmFsdWU6IGZ1bmN0aW9uIF9pbnRlcm5hbE9ic2VydmUocGF0aCwgb2JqKSB7CiAgICAgIHZhciBfdGhpcyA9IHRoaXM7CgogICAgICBpZiAoX3RoaXMuX2lzT2JzZXJ2YWJsZShvYmopKSB7CiAgICAgICAgdmFyIGhhbmRsZXIgPSBmdW5jdGlvbiBoYW5kbGVyKGNoYW5nZXMpIHsKICAgICAgICAgIF90aGlzLl9vbkNoYW5nZXMocGF0aCwgY2hhbmdlcyk7CiAgICAgICAgfTsKCiAgICAgICAgaWYgKG9iai5jb25zdHJ1Y3RvciA9PT0gT2JqZWN0KSB7CiAgICAgICAgICBPYmplY3Qub2JzZXJ2ZShvYmosIGhhbmRsZXIpOwogICAgICAgICAgZm9yICh2YXIgcHJvcCBpbiBvYmopIHsKICAgICAgICAgICAgaWYgKF90aGlzLl9pc09ic2VydmFibGUob2JqW3Byb3BdKSkgewogICAgICAgICAgICAgIF90aGlzLl9pbnRlcm5hbE9ic2VydmUocGF0aFsnbmV3J10ocHJvcCksIG9ialtwcm9wXSk7CiAgICAgICAgICAgIH0KICAgICAgICAgIH0KICAgICAgICB9IGVsc2UgaWYgKG9iai5jb25zdHJ1Y3RvciA9PT0gQXJyYXkpIHsKICAgICAgICAgIEFycmF5Lm9ic2VydmUob2JqLCBoYW5kbGVyKTsKICAgICAgICAgIGZvciAodmFyIHByb3AgaW4gb2JqKSB7CiAgICAgICAgICAgIGlmIChfdGhpcy5faXNPYnNlcnZhYmxlKG9ialtwcm9wXSkpIHsKICAgICAgICAgICAgICB2YXIgbnAgPSBwYXRoWyduZXcnXShuZXcgQXJyYXlJbmRleChvYmpbcHJvcF0sIHByb3ApKTsKICAgICAgICAgICAgICBfdGhpcy5faW50ZXJuYWxPYnNlcnZlKG5wLCBvYmpbcHJvcF0pOwogICAgICAgICAgICB9CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICB9CiAgICB9CiAgfSwgewogICAga2V5OiAnX29uQ2hhbmdlcycsCiAgICB2YWx1ZTogZnVuY3Rpb24gX29uQ2hhbmdlcyhwYXRoLCBjaGFuZ2VzKSB7CiAgICAgIHZhciBfdGhpczIgPSB0aGlzOwoKICAgICAgZm9yICh2YXIgaSBpbiBjaGFuZ2VzKSB7CiAgICAgICAgdmFyIG9iaiA9IGNoYW5nZXNbaV0ub2JqZWN0OwogICAgICAgIHZhciBvYmpUeXBlID0gdW5kZWZpbmVkOwoKICAgICAgICBpZiAob2JqLmNvbnN0cnVjdG9yID09PSBPYmplY3QpIHsKICAgICAgICAgIG9ialR5cGUgPSBPYmplY3RUeXBlLk9CSkVDVDsKICAgICAgICB9CgogICAgICAgIGlmIChvYmouY29uc3RydWN0b3IgPT09IEFycmF5KSB7CiAgICAgICAgICBvYmpUeXBlID0gT2JqZWN0VHlwZS5BUlJBWTsKICAgICAgICB9CgogICAgICAgIGlmIChjaGFuZ2VzW2ldLnR5cGUgPT09ICdzcGxpY2UnKSB7CiAgICAgICAgICAoZnVuY3Rpb24gKCkgewogICAgICAgICAgICB2YXIgaWR4ID0gY2hhbmdlc1tpXS5pbmRleDsKICAgICAgICAgICAgdmFyIGZpZWxkID0gcGF0aFsnbmV3J10oJycgKyBpZHgpOwogICAgICAgICAgICB2YXIgZmllbGRTdHJpbmcgPSBmaWVsZC50b1N0cmluZygpOwoKICAgICAgICAgICAgdmFyIHJlbW92ZVNpemUgPSBjaGFuZ2VzW2ldLnJlbW92ZWQubGVuZ3RoOwogICAgICAgICAgICBpZiAocmVtb3ZlU2l6ZSAhPT0gMCkgewogICAgICAgICAgICAgIHZhciByZW1vdmVWYWx1ZXMgPSBjaGFuZ2VzW2ldLnJlbW92ZWQ7CiAgICAgICAgICAgICAgcmVtb3ZlVmFsdWVzLmZvckVhY2goZnVuY3Rpb24gKHZhbHVlLCBpbmRleCkgewogICAgICAgICAgICAgICAgaWYgKF90aGlzMi5faXNPYnNlcnZhYmxlKHZhbHVlKSkgewogICAgICAgICAgICAgICAgICBwYXRoLnJlbW92ZUluZGV4KGlkeCArIGluZGV4KTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICB9KTsKCiAgICAgICAgICAgICAgX3RoaXMyLl9maXJlRXZlbnQoewogICAgICAgICAgICAgICAgY1R5cGU6IENoYW5nZVR5cGUuUkVNT1ZFLAogICAgICAgICAgICAgICAgb1R5cGU6IG9ialR5cGUsCiAgICAgICAgICAgICAgICBmaWVsZDogZmllbGRTdHJpbmcsCiAgICAgICAgICAgICAgICBkYXRhOiByZW1vdmVTaXplCiAgICAgICAgICAgICAgfSk7CiAgICAgICAgICAgIH0KCiAgICAgICAgICAgIHZhciBhZGRTaXplID0gY2hhbmdlc1tpXS5hZGRlZENvdW50OwogICAgICAgICAgICBpZiAoYWRkU2l6ZSAhPT0gMCkgewogICAgICAgICAgICAgIHZhciBhZGRWYWx1ZXMgPSBvYmouc2xpY2UoaWR4LCBpZHggKyBhZGRTaXplKTsKICAgICAgICAgICAgICBhZGRWYWx1ZXMuZm9yRWFjaChmdW5jdGlvbiAodmFsdWUsIGluZGV4KSB7CiAgICAgICAgICAgICAgICBpZiAoX3RoaXMyLl9pc09ic2VydmFibGUodmFsdWUpKSB7CiAgICAgICAgICAgICAgICAgIHZhciBucCA9IHBhdGhbJ25ldyddKG5ldyBBcnJheUluZGV4KHZhbHVlLCBpZHggKyBpbmRleCkpOwogICAgICAgICAgICAgICAgICBfdGhpczIuX2ludGVybmFsT2JzZXJ2ZShucCwgdmFsdWUpOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIH0pOwoKICAgICAgICAgICAgICBfdGhpczIuX2ZpcmVFdmVudCh7CiAgICAgICAgICAgICAgICBjVHlwZTogQ2hhbmdlVHlwZS5BREQsCiAgICAgICAgICAgICAgICBvVHlwZTogb2JqVHlwZSwKICAgICAgICAgICAgICAgIGZpZWxkOiBmaWVsZFN0cmluZywKICAgICAgICAgICAgICAgIGRhdGE6ICgwLCBfdXRpbHNVdGlsc0pzLmRlZXBDbG9uZSkoYWRkVmFsdWVzKQogICAgICAgICAgICAgIH0pOwogICAgICAgICAgICB9CgogICAgICAgICAgICAvL3JlLWRlZmluZSBwYXRocy4uLgogICAgICAgICAgICBpZiAoaWR4ICE9PSBvYmoubGVuZ3RoIC0gMSkgewogICAgICAgICAgICAgIHBhdGgucmVJbmRleEZyb20ob2JqKTsKICAgICAgICAgICAgfQogICAgICAgICAgfSkoKTsKICAgICAgICB9IGVsc2UgewogICAgICAgICAgdmFyIGZpZWxkID0gcGF0aFsnbmV3J10oY2hhbmdlc1tpXS5uYW1lKTsKICAgICAgICAgIHZhciBmaWVsZFN0cmluZyA9IGZpZWxkLnRvU3RyaW5nKCk7CgogICAgICAgICAgaWYgKGZpZWxkU3RyaW5nLmluZGV4T2YoJ1N5bWJvbCcpICE9PSAtMSkgewogICAgICAgICAgICAvL2hhY2sgZm9yIFBoYW50b21KUzIKICAgICAgICAgICAgLy9jb25zb2xlLmxvZygnU1lNQk9MOiAnLCBjaGFuZ2VzW2ldKTsKICAgICAgICAgICAgY29udGludWU7CiAgICAgICAgICB9CgogICAgICAgICAgLy9sZXQgb2xkVmFsdWUgPSBjaGFuZ2VzW2ldLm9sZFZhbHVlOwogICAgICAgICAgdmFyIG5ld1ZhbHVlID0gb2JqW2NoYW5nZXNbaV0ubmFtZV07CiAgICAgICAgICBpZiAoY2hhbmdlc1tpXS50eXBlID09PSAndXBkYXRlJykgewogICAgICAgICAgICB0aGlzLl9maXJlRXZlbnQoewogICAgICAgICAgICAgIGNUeXBlOiBDaGFuZ2VUeXBlLlVQREFURSwKICAgICAgICAgICAgICBvVHlwZTogb2JqVHlwZSwKICAgICAgICAgICAgICBmaWVsZDogZmllbGRTdHJpbmcsCiAgICAgICAgICAgICAgZGF0YTogKDAsIF91dGlsc1V0aWxzSnMuZGVlcENsb25lKShuZXdWYWx1ZSkKICAgICAgICAgICAgfSk7CiAgICAgICAgICB9CgogICAgICAgICAgaWYgKGNoYW5nZXNbaV0udHlwZSA9PT0gJ2FkZCcpIHsKICAgICAgICAgICAgdGhpcy5faW50ZXJuYWxPYnNlcnZlKGZpZWxkLCBuZXdWYWx1ZSk7CiAgICAgICAgICAgIHRoaXMuX2ZpcmVFdmVudCh7CiAgICAgICAgICAgICAgY1R5cGU6IENoYW5nZVR5cGUuQURELAogICAgICAgICAgICAgIG9UeXBlOiBvYmpUeXBlLAogICAgICAgICAgICAgIGZpZWxkOiBmaWVsZFN0cmluZywKICAgICAgICAgICAgICBkYXRhOiAoMCwgX3V0aWxzVXRpbHNKcy5kZWVwQ2xvbmUpKG5ld1ZhbHVlKQogICAgICAgICAgICB9KTsKICAgICAgICAgIH0KCiAgICAgICAgICBpZiAoY2hhbmdlc1tpXS50eXBlID09PSAnZGVsZXRlJykgewogICAgICAgICAgICB0aGlzLl9maXJlRXZlbnQoewogICAgICAgICAgICAgIGNUeXBlOiBDaGFuZ2VUeXBlLlJFTU9WRSwKICAgICAgICAgICAgICBvVHlwZTogb2JqVHlwZSwKICAgICAgICAgICAgICBmaWVsZDogZmllbGRTdHJpbmcKICAgICAgICAgICAgfSk7CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICB9CiAgICB9CiAgfSwgewogICAga2V5OiAnZGF0YScsCiAgICBnZXQ6IGZ1bmN0aW9uIGdldCgpIHsKICAgICAgcmV0dXJuIHRoaXMuX2RhdGE7CiAgICB9CiAgfV0pOwoKICByZXR1cm4gU3luY09iamVjdDsKfSkoKTsKCnZhciBQYXRoID0gKGZ1bmN0aW9uICgpIHsKICBmdW5jdGlvbiBQYXRoKCkgewogICAgX2NsYXNzQ2FsbENoZWNrKHRoaXMsIFBhdGgpOwoKICAgIHRoaXMuX3BhdGggPSBbXTsKICAgIHRoaXMuX29ic2VydmFibGVzID0ge307IC8vPGluZGV4OkFycmF5SW5kZXg+CiAgfQoKICBfY3JlYXRlQ2xhc3MoUGF0aCwgW3sKICAgIGtleTogJ3JlbW92ZUluZGV4JywKICAgIHZhbHVlOiBmdW5jdGlvbiByZW1vdmVJbmRleChpZHgpIHsKICAgICAgLy9jb25zb2xlLmxvZygnUkVNT1ZFLVBBVEggJyArIGlkeCk7CiAgICAgIGRlbGV0ZSB0aGlzLl9vYnNlcnZhYmxlc1tpZHhdOwogICAgfQogIH0sIHsKICAgIGtleTogJ3JlSW5kZXhGcm9tJywKICAgIHZhbHVlOiBmdW5jdGlvbiByZUluZGV4RnJvbShhcnJheSkgewogICAgICB2YXIgX3RoaXMzID0gdGhpczsKCiAgICAgIF9PYmplY3Qka2V5cyh0aGlzLl9vYnNlcnZhYmxlcykuZm9yRWFjaChmdW5jdGlvbiAoa2V5KSB7CiAgICAgICAgdmFyIGFycmF5SW5kZXggPSBfdGhpczMuX29ic2VydmFibGVzW2tleV07CiAgICAgICAgdmFyIGlkeCA9IGFycmF5LmluZGV4T2YoYXJyYXlJbmRleC5vYmopOwogICAgICAgIGlmIChhcnJheUluZGV4LmlkeCAhPSBpZHgpIHsKICAgICAgICAgIC8vY29uc29sZS5sb2coJ1JFLUlOREVYOiAnICsga2V5ICsgJy0+JyArIGlkeCk7CiAgICAgICAgICBhcnJheUluZGV4LmlkeCA9IGlkeDsKICAgICAgICAgIGRlbGV0ZSBfdGhpczMuX29ic2VydmFibGVzW2tleV07CiAgICAgICAgICBfdGhpczMuX29ic2VydmFibGVzW2lkeF0gPSBhcnJheUluZGV4OwogICAgICAgIH0KICAgICAgfSk7CiAgICB9CiAgfSwgewogICAga2V5OiAnbmV3JywKICAgIHZhbHVlOiBmdW5jdGlvbiBfbmV3KGlkeCkgewogICAgICBpZiAoaWR4LmNvbnN0cnVjdG9yID09IEFycmF5SW5kZXgpIHsKICAgICAgICAvL2NvbnNvbGUubG9nKCdQQVRILU9CU0VSVjogJywgaWR4KTsKICAgICAgICB0aGlzLl9vYnNlcnZhYmxlc1tpZHguaWR4XSA9IGlkeDsKICAgICAgfQoKICAgICAgdmFyIG5QYXRoID0gdGhpcy5jbG9uZSgpOwogICAgICBuUGF0aC5fcGF0aC5wdXNoKGlkeCk7CgogICAgICByZXR1cm4gblBhdGg7CiAgICB9CiAgfSwgewogICAga2V5OiAnY2xvbmUnLAogICAgdmFsdWU6IGZ1bmN0aW9uIGNsb25lKCkgewogICAgICB2YXIgblBhdGggPSBuZXcgUGF0aCgpOwogICAgICB0aGlzLl9wYXRoLmZvckVhY2goZnVuY3Rpb24gKHZhbHVlKSB7CiAgICAgICAgblBhdGguX3BhdGgucHVzaCh2YWx1ZSk7CiAgICAgIH0pOwoKICAgICAgcmV0dXJuIG5QYXRoOwogICAgfQogIH0sIHsKICAgIGtleTogJ3RvU3RyaW5nJywKICAgIHZhbHVlOiBmdW5jdGlvbiB0b1N0cmluZygpIHsKICAgICAgLy9UT0RPOiBvcHRpbWl6ZSEhCiAgICAgIHZhciBzdHIgPSAnJzsKICAgICAgdGhpcy5fcGF0aC5mb3JFYWNoKGZ1bmN0aW9uICh2YWx1ZSwgaW5kZXgpIHsKICAgICAgICBpZiAoaW5kZXggPT09IDApIHsKICAgICAgICAgIHN0ciA9IHZhbHVlLnRvU3RyaW5nKCk7CiAgICAgICAgfSBlbHNlIHsKICAgICAgICAgIHN0ciArPSAnLicgKyB2YWx1ZS50b1N0cmluZygpOwogICAgICAgIH0KICAgICAgfSk7CgogICAgICByZXR1cm4gc3RyOwogICAgfQogIH1dKTsKCiAgcmV0dXJuIFBhdGg7Cn0pKCk7Cgp2YXIgQXJyYXlJbmRleCA9IChmdW5jdGlvbiAoKSB7CiAgZnVuY3Rpb24gQXJyYXlJbmRleChvYmosIGlkeCkgewogICAgX2NsYXNzQ2FsbENoZWNrKHRoaXMsIEFycmF5SW5kZXgpOwoKICAgIHRoaXMub2JqID0gb2JqOwogICAgdGhpcy5pZHggPSBpZHg7CiAgfQoKICBfY3JlYXRlQ2xhc3MoQXJyYXlJbmRleCwgW3sKICAgIGtleTogJ3RvU3RyaW5nJywKICAgIHZhbHVlOiBmdW5jdGlvbiB0b1N0cmluZygpIHsKICAgICAgcmV0dXJuIHRoaXMuaWR4LnRvU3RyaW5nKCk7CiAgICB9CiAgfV0pOwoKICByZXR1cm4gQXJyYXlJbmRleDsKfSkoKTsKCnZhciBDaGFuZ2VUeXBlID0geyBVUERBVEU6ICd1cGRhdGUnLCBBREQ6ICdhZGQnLCBSRU1PVkU6ICdyZW1vdmUnIH07CmV4cG9ydHMuQ2hhbmdlVHlwZSA9IENoYW5nZVR5cGU7CnZhciBPYmplY3RUeXBlID0geyBPQkpFQ1Q6ICdvYmplY3QnLCBBUlJBWTogJ2FycmF5JyB9OwpleHBvcnRzLk9iamVjdFR5cGUgPSBPYmplY3RUeXBlOwpleHBvcnRzWydkZWZhdWx0J10gPSBTeW5jT2JqZWN0OwoKfSx7Ii4uL3V0aWxzL3V0aWxzLmpzIjoxMDUsImJhYmVsLXJ1bnRpbWUvY29yZS1qcy9vYmplY3Qva2V5cyI6NSwiYmFiZWwtcnVudGltZS9oZWxwZXJzL2NsYXNzLWNhbGwtY2hlY2siOjEwLCJiYWJlbC1ydW50aW1lL2hlbHBlcnMvY3JlYXRlLWNsYXNzIjoxMn1dLDEwMzpbZnVuY3Rpb24ocmVxdWlyZSxtb2R1bGUsZXhwb3J0cyl7Cid1c2Ugc3RyaWN0JzsKCnZhciBfY3JlYXRlQ2xhc3MgPSByZXF1aXJlKCdiYWJlbC1ydW50aW1lL2hlbHBlcnMvY3JlYXRlLWNsYXNzJylbJ2RlZmF1bHQnXTsKCnZhciBfY2xhc3NDYWxsQ2hlY2sgPSByZXF1aXJlKCdiYWJlbC1ydW50aW1lL2hlbHBlcnMvY2xhc3MtY2FsbC1jaGVjaycpWydkZWZhdWx0J107Cgp2YXIgX1Byb21pc2UgPSByZXF1aXJlKCdiYWJlbC1ydW50aW1lL2NvcmUtanMvcHJvbWlzZScpWydkZWZhdWx0J107Cgp2YXIgX2ludGVyb3BSZXF1aXJlRGVmYXVsdCA9IHJlcXVpcmUoJ2JhYmVsLXJ1bnRpbWUvaGVscGVycy9pbnRlcm9wLXJlcXVpcmUtZGVmYXVsdCcpWydkZWZhdWx0J107CgpPYmplY3QuZGVmaW5lUHJvcGVydHkoZXhwb3J0cywgJ19fZXNNb2R1bGUnLCB7CiAgdmFsdWU6IHRydWUKfSk7Cgp2YXIgX0RhdGFPYmplY3RSZXBvcnRlciA9IHJlcXVpcmUoJy4vRGF0YU9iamVjdFJlcG9ydGVyJyk7Cgp2YXIgX0RhdGFPYmplY3RSZXBvcnRlcjIgPSBfaW50ZXJvcFJlcXVpcmVEZWZhdWx0KF9EYXRhT2JqZWN0UmVwb3J0ZXIpOwoKdmFyIF9EYXRhT2JqZWN0T2JzZXJ2ZXIgPSByZXF1aXJlKCcuL0RhdGFPYmplY3RPYnNlcnZlcicpOwoKdmFyIF9EYXRhT2JqZWN0T2JzZXJ2ZXIyID0gX2ludGVyb3BSZXF1aXJlRGVmYXVsdChfRGF0YU9iamVjdE9ic2VydmVyKTsKCnZhciBfRGF0YVByb3Zpc2lvbmFsID0gcmVxdWlyZSgnLi9EYXRhUHJvdmlzaW9uYWwnKTsKCnZhciBfRGF0YVByb3Zpc2lvbmFsMiA9IF9pbnRlcm9wUmVxdWlyZURlZmF1bHQoX0RhdGFQcm92aXNpb25hbCk7CgovKioKICogQGF1dGhvciBtaWNhZWxwZWRyb3NhQGdtYWlsLmNvbQogKiBDbGllbnQgQVBJIFN5bmNyb25pemF0aW9uIHN5c3RlbS4KICovCgp2YXIgU3luY2hlciA9IChmdW5jdGlvbiAoKSB7CiAgLyogcHJpdmF0ZQogIF9vd25lcjogVVJMCiAgX2J1czogTWluaUJ1cwogICBfc3ViVVJMOiBVUkwKICAgX3JlcG9ydGVyczogPHVybDogRGF0YU9iamVjdFJlcG9ydGVyPgogIF9vYnNlcnZlcnM6IDx1cmw6IERhdGFPYmplY3RPYnNlcnZlcj4KICBfcHJvdmlzaW9uYWxzOiA8dXJsOiBEYXRhUHJvdmlzaW9uYWw+CiAgIC0tLS1ldmVudCBoYW5kbGVycy0tLS0KICBfb25Ob3RpZmljYXRpb25IYW5kbGVyOiAoZXZlbnQpID0+IHZvaWQKICAqLwoKICAvKioKICAgKiBDb25zdHJ1Y3RvciB0aGF0IHNob3VsZCBiZSB1c2VkIGJ5IHRoZSBIeXBlcnR5IG93bmVyCiAgICogQHBhcmFtIHtIeXBlcnR5VVJMfSBvd25lciAtIEh5cGVydHkgVVJMIG93bmVyCiAgICogQHBhcmFtIHtNaW5pQnVzfSBidXMgLSBUaGUgaW50ZXJuYWwgc2FuZGJveCBNaW5pQnVzIHVzZWQgYnkgdGhlIEh5cGVydHkKICAgKiBAcGFyYW0ge0pTT059IGNvbmZpZyAtIFRoZSBvbmx5IHJlcXVpcmVkIGZpZWxkIGZvciBub3cgaXMgcnVudGltZVVSTAogICAqLwoKICBmdW5jdGlvbiBTeW5jaGVyKG93bmVyLCBidXMsIGNvbmZpZykgewogICAgX2NsYXNzQ2FsbENoZWNrKHRoaXMsIFN5bmNoZXIpOwoKICAgIHZhciBfdGhpcyA9IHRoaXM7CgogICAgX3RoaXMuX293bmVyID0gb3duZXI7CiAgICBfdGhpcy5fYnVzID0gYnVzOwoKICAgIF90aGlzLl9zdWJVUkwgPSBjb25maWcucnVudGltZVVSTCArICcvc20nOwoKICAgIF90aGlzLl9yZXBvcnRlcnMgPSB7fTsKICAgIF90aGlzLl9vYnNlcnZlcnMgPSB7fTsKICAgIF90aGlzLl9wcm92aXNpb25hbHMgPSB7fTsKCiAgICBidXMuYWRkTGlzdGVuZXIob3duZXIsIGZ1bmN0aW9uIChtc2cpIHsKICAgICAgY29uc29sZS5sb2coJ1N5bmNoZXItUkNWOiAnLCBtc2cpOwogICAgICBzd2l0Y2ggKG1zZy50eXBlKSB7CiAgICAgICAgY2FzZSAnZm9yd2FyZCc6CiAgICAgICAgICBfdGhpcy5fb25Gb3J3YXJkKG1zZyk7YnJlYWs7CiAgICAgICAgY2FzZSAnY3JlYXRlJzoKICAgICAgICAgIF90aGlzLl9vblJlbW90ZUNyZWF0ZShtc2cpO2JyZWFrOwogICAgICB9CiAgICB9KTsKICB9CgogIC8qKgogICAqIFRoZSBvd25lciBvZiB0aGUgU3luY2hlciBhbmQgYWxsIGNyZWF0ZWQgcmVwb3J0ZXJzLgogICAqIEB0eXBlIHtIeXBlcnR5VVJMfQogICAqLwoKICBfY3JlYXRlQ2xhc3MoU3luY2hlciwgW3sKICAgIGtleTogJ2NyZWF0ZScsCgogICAgLyoqCiAgICAgKiBSZXF1ZXN0IGEgRGF0YU9iamVjdFJlcG9ydGVyIGNyZWF0aW9uLiBUaGUgVVJMIHdpbGwgYmUgYmUgcmVxdWVzdGVkIGJ5IHRoZSBhbGxvY2F0aW9uIG1lY2hhbmlzbS4KICAgICAqIEBwYXJhbSAge1NjaGVtYVVSTH0gc2NoZW1hIC0gVVJMIG9mIHRoZSBvYmplY3QgZGVzY3JpcHRvcgogICAgICogQHBhcmFtICB7SHlwZXJ0eVVSTFtdfSBvYnNlcnZlcnMgLSBMaXN0IG9mIGh5cGVydGllcyB0aGF0IGFyZSBwcmUtYXV0aG9yaXplZCBmb3Igc3Vic2NyaXB0aW9uCiAgICAgKiBAcGFyYW0gIHtKU09OfSBpbml0aWFsRGF0YSAtIEluaXRpYWwgZGF0YSBvZiB0aGUgcmVwb3J0ZXIKICAgICAqIEByZXR1cm4ge1Byb21pc2U8RGF0YU9iamVjdFJlcG9ydGVyPn0gUmV0dXJuIFByb21pc2UgdG8gYSBuZXcgUmVwb3J0ZXIuIFRoZSByZXBvcnRlciBjYW4gYmUgYWNjZXB0ZWQgb3IgcmVqZWN0ZWQgYnkgdGhlIFBFUAogICAgICovCiAgICB2YWx1ZTogZnVuY3Rpb24gY3JlYXRlKHNjaGVtYSwgb2JzZXJ2ZXJzLCBpbml0aWFsRGF0YSkgewogICAgICB2YXIgX3RoaXMgPSB0aGlzOwoKICAgICAgdmFyIHJlcXVlc3RNc2cgPSB7CiAgICAgICAgdHlwZTogJ2NyZWF0ZScsIGZyb206IF90aGlzLl9vd25lciwgdG86IF90aGlzLl9zdWJVUkwsCiAgICAgICAgYm9keTogeyBzY2hlbWE6IHNjaGVtYSwgdmFsdWU6IGluaXRpYWxEYXRhLCBhdXRob3Jpc2U6IG9ic2VydmVycyB9CiAgICAgIH07CgogICAgICByZXR1cm4gbmV3IF9Qcm9taXNlKGZ1bmN0aW9uIChyZXNvbHZlLCByZWplY3QpIHsKICAgICAgICAvL3JlcXVlc3QgY3JlYXRlIHRvIHRoZSBBbGxvY2F0aW9uIHN5c3RlbT8gQ2FuIGJlIHJlamVjdGVkIGJ5IHRoZSBQb2xpY3lFbmdpbmUuCiAgICAgICAgX3RoaXMuX2J1cy5wb3N0TWVzc2FnZShyZXF1ZXN0TXNnLCBmdW5jdGlvbiAocmVwbHkpIHsKICAgICAgICAgIGNvbnNvbGUubG9nKCdjcmVhdGUtcmVzcG9uc2U6ICcsIHJlcGx5KTsKICAgICAgICAgIGlmIChyZXBseS5ib2R5LmNvZGUgPT09IDIwMCkgewogICAgICAgICAgICB2YXIgb2JqVVJMID0gcmVwbHkuYm9keS5yZXNvdXJjZTsKCiAgICAgICAgICAgIC8vcmVwb3J0ZXIgY3JlYXRpb24gYWNjZXB0ZWQKICAgICAgICAgICAgdmFyIG5ld09iaiA9IG5ldyBfRGF0YU9iamVjdFJlcG9ydGVyMlsnZGVmYXVsdCddKF90aGlzLl9vd25lciwgb2JqVVJMLCBzY2hlbWEsIF90aGlzLl9idXMsICdvbicsIGluaXRpYWxEYXRhLCByZXBseS5ib2R5LmNoaWxkcmVuKTsKICAgICAgICAgICAgX3RoaXMuX3JlcG9ydGVyc1tvYmpVUkxdID0gbmV3T2JqOwoKICAgICAgICAgICAgcmVzb2x2ZShuZXdPYmopOwogICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgLy9yZXBvcnRlciBjcmVhdGlvbiByZWplY3RlZAogICAgICAgICAgICByZWplY3QocmVwbHkuYm9keS5kZXNjKTsKICAgICAgICAgIH0KICAgICAgICB9KTsKICAgICAgfSk7CiAgICB9CgogICAgLyoqCiAgICAgKiBSZXF1ZXN0IGEgc3Vic2NyaXB0aW9uIHRvIGFuIGV4aXN0ZW50IG9iamVjdC4KICAgICAqIEBwYXJhbSB7U2NoZW1hVVJMfSBzY2hlbWEgLSBVUkwgb2YgdGhlIG9iamVjdCBkZXNjcmlwdG9yCiAgICAgKiBAcGFyYW0ge09iamVjdFVSTH0gb2JqVVJMIC0gQWRkcmVzcyBvZiB0aGUgZXhpc3RlbnQgcmVwb3J0ZXIgb2JqZWN0CiAgICAgKiBAcmV0dXJuIHtQcm9taXNlPERhdGFPYmplY3RPYnNlcnZlcj59IFJldHVybiBQcm9taXNlIHRvIGEgbmV3IG9ic2VydmVyLgogICAgICovCiAgfSwgewogICAga2V5OiAnc3Vic2NyaWJlJywKICAgIHZhbHVlOiBmdW5jdGlvbiBzdWJzY3JpYmUoc2NoZW1hLCBvYmpVUkwpIHsKICAgICAgdmFyIF90aGlzID0gdGhpczsKCiAgICAgIC8vVE9ETzogdmFsaWRhdGUgaWYgc3Vic2NyaXB0aW9uIGFscmVhZHkgZXhpc3RzID8KICAgICAgdmFyIHN1YnNjcmliZU1zZyA9IHsKICAgICAgICB0eXBlOiAnc3Vic2NyaWJlJywgZnJvbTogX3RoaXMuX293bmVyLCB0bzogX3RoaXMuX3N1YlVSTCwKICAgICAgICBib2R5OiB7IHNjaGVtYTogc2NoZW1hLCByZXNvdXJjZTogb2JqVVJMIH0KICAgICAgfTsKCiAgICAgIHJldHVybiBuZXcgX1Byb21pc2UoZnVuY3Rpb24gKHJlc29sdmUsIHJlamVjdCkgewogICAgICAgIC8vcmVxdWVzdCBzdWJzY3JpcHRpb24KICAgICAgICBfdGhpcy5fYnVzLnBvc3RNZXNzYWdlKHN1YnNjcmliZU1zZywgZnVuY3Rpb24gKHJlcGx5KSB7CiAgICAgICAgICBjb25zb2xlLmxvZygnc3Vic2NyaWJlLXJlc3BvbnNlOiAnLCByZXBseSk7CiAgICAgICAgICB2YXIgbmV3UHJvdmlzaW9uYWwgPSBfdGhpcy5fcHJvdmlzaW9uYWxzW29ialVSTF07CiAgICAgICAgICBkZWxldGUgX3RoaXMuX3Byb3Zpc2lvbmFsc1tvYmpVUkxdOwogICAgICAgICAgaWYgKG5ld1Byb3Zpc2lvbmFsKSBuZXdQcm92aXNpb25hbC5yZWxlYXNlKCk7CgogICAgICAgICAgaWYgKHJlcGx5LmJvZHkuY29kZSA8IDIwMCkgewogICAgICAgICAgICBuZXdQcm92aXNpb25hbCA9IG5ldyBfRGF0YVByb3Zpc2lvbmFsMlsnZGVmYXVsdCddKF90aGlzLl9vd25lciwgb2JqVVJMLCBfdGhpcy5fYnVzLCByZXBseS5ib2R5LmNoaWxkcmVuUmVzb3VyY2VzKTsKICAgICAgICAgICAgX3RoaXMuX3Byb3Zpc2lvbmFsc1tvYmpVUkxdID0gbmV3UHJvdmlzaW9uYWw7CiAgICAgICAgICB9IGVsc2UgaWYgKHJlcGx5LmJvZHkuY29kZSA9PT0gMjAwKSB7CiAgICAgICAgICAgIHZhciBuZXdPYmogPSBuZXcgX0RhdGFPYmplY3RPYnNlcnZlcjJbJ2RlZmF1bHQnXShfdGhpcy5fb3duZXIsIG9ialVSTCwgc2NoZW1hLCBfdGhpcy5fYnVzLCAnb24nLCByZXBseS5ib2R5LnZhbHVlLCBuZXdQcm92aXNpb25hbC5jaGlsZHJlbiwgcmVwbHkuYm9keS52ZXJzaW9uKTsKCiAgICAgICAgICAgIHJlc29sdmUobmV3T2JqKTsKICAgICAgICAgICAgbmV3UHJvdmlzaW9uYWwuYXBwbHkobmV3T2JqKTsKICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgIHJlamVjdChyZXBseS5ib2R5LmRlc2MpOwogICAgICAgICAgfQogICAgICAgIH0pOwogICAgICB9KTsKICAgIH0KCiAgICAvKioKICAgICAqIFNldHVwIHRoZSBjYWxsYmFjayB0byBwcm9jZXNzIGNyZWF0ZSBhbmQgZGVsZXRlIGV2ZW50cyBvZiByZW1vdmUgUmVwb3J0ZXIgb2JqZWN0cy4KICAgICAqIFRoaXMgaXMgcmVsZWF0ZWQgdG8gdGhlIG1lc3NhZ2VucyBzZW50IGJ5IGNyZWF0ZSB0byB0aGUgb2JzZXJ2ZXJzIEh5cGVydHkgYXJyYXkuCiAgICAgKiBAcGFyYW0ge2Z1bmN0aW9uKGV2ZW50OiBNc2dFdmVudCl9IGNhbGxiYWNrCiAgICAgKi8KICB9LCB7CiAgICBrZXk6ICdvbk5vdGlmaWNhdGlvbicsCiAgICB2YWx1ZTogZnVuY3Rpb24gb25Ob3RpZmljYXRpb24oY2FsbGJhY2spIHsKICAgICAgdGhpcy5fb25Ob3RpZmljYXRpb25IYW5kbGVyID0gY2FsbGJhY2s7CiAgICB9CiAgfSwgewogICAga2V5OiAnX29uRm9yd2FyZCcsCiAgICB2YWx1ZTogZnVuY3Rpb24gX29uRm9yd2FyZChtc2cpIHsKICAgICAgdmFyIF90aGlzID0gdGhpczsKCiAgICAgIHZhciByZXBvcnRlciA9IF90aGlzLl9yZXBvcnRlcnNbbXNnLmJvZHkudG9dOwogICAgICByZXBvcnRlci5fb25Gb3J3YXJkKG1zZyk7CiAgICB9CiAgfSwgewogICAga2V5OiAnX29uUmVtb3RlQ3JlYXRlJywKICAgIHZhbHVlOiBmdW5jdGlvbiBfb25SZW1vdGVDcmVhdGUobXNnKSB7CiAgICAgIHZhciBfdGhpcyA9IHRoaXM7CgogICAgICB2YXIgZXZlbnQgPSB7CiAgICAgICAgdHlwZTogbXNnLnR5cGUsCiAgICAgICAgZnJvbTogbXNnLmZyb20sCiAgICAgICAgdXJsOiBtc2cuYm9keS5yZXNvdXJjZSwKICAgICAgICBzY2hlbWE6IG1zZy5ib2R5LnNjaGVtYSwKICAgICAgICB2YWx1ZTogbXNnLmJvZHkudmFsdWUsCiAgICAgICAgaWRlbnRpdHk6IG1zZy5ib2R5LmlkVG9rZW4sCgogICAgICAgIGFjazogZnVuY3Rpb24gYWNrKHR5cGUpIHsKICAgICAgICAgIHZhciBsVHlwZSA9IDIwMDsKICAgICAgICAgIGlmICh0eXBlKSB7CiAgICAgICAgICAgIGxUeXBlID0gdHlwZTsKICAgICAgICAgIH0KCiAgICAgICAgICAvL3NlbmQgYWNrIHJlc3BvbnNlIG1lc3NhZ2UKICAgICAgICAgIF90aGlzLl9idXMucG9zdE1lc3NhZ2UoewogICAgICAgICAgICBpZDogbXNnLmlkLCB0eXBlOiAncmVzcG9uc2UnLCBmcm9tOiBtc2cudG8sIHRvOiBtc2cuZnJvbSwKICAgICAgICAgICAgYm9keTogeyBjb2RlOiBsVHlwZSwgc291cmNlOiBtc2cuYm9keS5yZXNvdXJjZSB9CiAgICAgICAgICB9KTsKICAgICAgICB9CiAgICAgIH07CgogICAgICBpZiAoX3RoaXMuX29uTm90aWZpY2F0aW9uSGFuZGxlcikgewogICAgICAgIF90aGlzLl9vbk5vdGlmaWNhdGlvbkhhbmRsZXIoZXZlbnQpOwogICAgICB9CiAgICB9CiAgfSwgewogICAga2V5OiAnb3duZXInLAogICAgZ2V0OiBmdW5jdGlvbiBnZXQoKSB7CiAgICAgIHJldHVybiB0aGlzLl9vd25lcjsKICAgIH0KCiAgICAvKioKICAgICAqIEFsbCBvd25lZCByZXBvcnRlcnMsIHRoZSBvbmVzIHRoYXQgd2VyZSBjcmVhdGVkIGJ5IGEgY3JlYXRlCiAgICAgKiBAdHlwZSB7T2JqZWN0PFVSTCwgRGF0YU9iamVjdFJlcG9ydGVyPn0KICAgICAqLwogIH0sIHsKICAgIGtleTogJ3JlcG9ydGVycycsCiAgICBnZXQ6IGZ1bmN0aW9uIGdldCgpIHsKICAgICAgcmV0dXJuIHRoaXMuX3JlcG9ydGVyczsKICAgIH0KCiAgICAvKioKICAgICAqIEFsbCBvd25lZCBvYnNlcnZlcnMsIHRoZSBvbmVzIHRoYXQgd2VyZSBjcmVhdGVkIGJ5IGEgbG9jYWwgc3Vic2NyaXB0aW9uCiAgICAgKiBAdHlwZSB7T2JqZWN0PFVSTCwgRGF0YU9iamVjdE9ic2VydmVyPn0KICAgICAqLwogIH0sIHsKICAgIGtleTogJ29ic2VydmVycycsCiAgICBnZXQ6IGZ1bmN0aW9uIGdldCgpIHsKICAgICAgcmV0dXJuIHRoaXMuX29ic2VydmVyczsKICAgIH0KICB9XSk7CgogIHJldHVybiBTeW5jaGVyOwp9KSgpOwoKZXhwb3J0c1snZGVmYXVsdCddID0gU3luY2hlcjsKbW9kdWxlLmV4cG9ydHMgPSBleHBvcnRzWydkZWZhdWx0J107Cgp9LHsiLi9EYXRhT2JqZWN0T2JzZXJ2ZXIiOjk5LCIuL0RhdGFPYmplY3RSZXBvcnRlciI6MTAwLCIuL0RhdGFQcm92aXNpb25hbCI6MTAxLCJiYWJlbC1ydW50aW1lL2NvcmUtanMvcHJvbWlzZSI6NywiYmFiZWwtcnVudGltZS9oZWxwZXJzL2NsYXNzLWNhbGwtY2hlY2siOjEwLCJiYWJlbC1ydW50aW1lL2hlbHBlcnMvY3JlYXRlLWNsYXNzIjoxMiwiYmFiZWwtcnVudGltZS9oZWxwZXJzL2ludGVyb3AtcmVxdWlyZS1kZWZhdWx0IjoxNn1dLDEwNDpbZnVuY3Rpb24ocmVxdWlyZSxtb2R1bGUsZXhwb3J0cyl7Ci8qKgogKiBFdmVudEVtaXR0ZXIKICogQWxsIGNsYXNzZXMgd2hpY2ggZXh0ZW5kcyB0aGlzLCBjYW4gaGF2ZSBhZGRFdmVudExpc3RlbmVyIGFuZCB0cmlnZ2VyIGV2ZW50czsKICovCiJ1c2Ugc3RyaWN0IjsKCnZhciBfY3JlYXRlQ2xhc3MgPSByZXF1aXJlKCJiYWJlbC1ydW50aW1lL2hlbHBlcnMvY3JlYXRlLWNsYXNzIilbImRlZmF1bHQiXTsKCnZhciBfY2xhc3NDYWxsQ2hlY2sgPSByZXF1aXJlKCJiYWJlbC1ydW50aW1lL2hlbHBlcnMvY2xhc3MtY2FsbC1jaGVjayIpWyJkZWZhdWx0Il07CgpPYmplY3QuZGVmaW5lUHJvcGVydHkoZXhwb3J0cywgIl9fZXNNb2R1bGUiLCB7CiAgdmFsdWU6IHRydWUKfSk7Cgp2YXIgRXZlbnRFbWl0dGVyID0gKGZ1bmN0aW9uICgpIHsKICBmdW5jdGlvbiBFdmVudEVtaXR0ZXIoKSB7CiAgICBfY2xhc3NDYWxsQ2hlY2sodGhpcywgRXZlbnRFbWl0dGVyKTsKICB9CgogIF9jcmVhdGVDbGFzcyhFdmVudEVtaXR0ZXIsIFt7CiAgICBrZXk6ICJhZGRFdmVudExpc3RlbmVyIiwKCiAgICAvKioKICAgICAqIGFkZEV2ZW50TGlzdGVuZXIgbGlzdGVuIGZvciBhbiBldmVudFR5cGUKICAgICAqIEBwYXJhbSAge3N0cmluZ30gICAgICAgICBldmVudFR5cGUgLSBsaXN0ZW5pbmcgZm9yIHRoaXMgdHlwZSBvZiBldmVudAogICAgICogQHBhcmFtICB7RnVuY3Rpb259ICAgICAgIGNiICAgICAgICAtIGNhbGxiYWNrIGZ1bmN0aW9uIHdpbGwgYmUgZXhlY3V0ZWQgd2hlbiB0aGUgZXZlbnQgaXQgaXMgaW52b2tlZAogICAgICovCiAgICB2YWx1ZTogZnVuY3Rpb24gYWRkRXZlbnRMaXN0ZW5lcihldmVudFR5cGUsIGNiKSB7CiAgICAgIHZhciBfdGhpcyA9IHRoaXM7CiAgICAgIF90aGlzW2V2ZW50VHlwZV0gPSBjYjsKICAgIH0KCiAgICAvKioKICAgICAqIEludm9rZSB0aGUgZXZlbnRUeXBlCiAgICAgKiBAcGFyYW0gIHtzdHJpbmd9IGV2ZW50VHlwZSAtIGV2ZW50IHdpbGwgYmUgaW52b2tlZAogICAgICogQHBhcmFtICB7b2JqZWN0fSBwYXJhbXMgLSBwYXJhbWV0ZXJzIHdpbGwgYmUgcGFzc2VkIHRvIHRoZSBhZGRFdmVudExpc3RlbmVyCiAgICAgKi8KICB9LCB7CiAgICBrZXk6ICJ0cmlnZ2VyIiwKICAgIHZhbHVlOiBmdW5jdGlvbiB0cmlnZ2VyKGV2ZW50VHlwZSwgcGFyYW1zKSB7CiAgICAgIHZhciBfdGhpcyA9IHRoaXM7CgogICAgICBpZiAoX3RoaXNbZXZlbnRUeXBlXSkgewogICAgICAgIF90aGlzW2V2ZW50VHlwZV0ocGFyYW1zKTsKICAgICAgfQogICAgfQogIH1dKTsKCiAgcmV0dXJuIEV2ZW50RW1pdHRlcjsKfSkoKTsKCmV4cG9ydHNbImRlZmF1bHQiXSA9IEV2ZW50RW1pdHRlcjsKbW9kdWxlLmV4cG9ydHMgPSBleHBvcnRzWyJkZWZhdWx0Il07Cgp9LHsiYmFiZWwtcnVudGltZS9oZWxwZXJzL2NsYXNzLWNhbGwtY2hlY2siOjEwLCJiYWJlbC1ydW50aW1lL2hlbHBlcnMvY3JlYXRlLWNsYXNzIjoxMn1dLDEwNTpbZnVuY3Rpb24ocmVxdWlyZSxtb2R1bGUsZXhwb3J0cyl7Ci8qKgogKiBTdXBwb3J0IG1vZHVsZSB3aXRoIHNvbWUgZnVuY3Rpb25zIHdpbGwgYmUgdXNlZnVsCiAqIEBtb2R1bGUgdXRpbHMKICovCgovKioKICogQHR5cGVkZWYgZGl2aWRlVVJMCiAqIEB0eXBlIE9iamVjdAogKiBAcHJvcGVydHkge3N0cmluZ30gdHlwZSBUaGUgdHlwZSBvZiBVUkwKICogQHByb3BlcnR5IHtzdHJpbmd9IGRvbWFpbiBUaGUgZG9tYWluIG9mIFVSTAogKiBAcHJvcGVydHkge3N0cmluZ30gaWRlbnRpdHkgVGhlIGlkZW50aXR5IG9mIFVSTAogKi8KCi8qKgogKiBEaXZpZGUgYW4gdXJsIGluIHR5cGUsIGRvbWFpbiBhbmQgaWRlbnRpdHkKICogQHBhcmFtICB7VVJMLlVSTH0gdXJsIC0gdXJsIGFkZHJlc3MKICogQHJldHVybiB7ZGl2aWRlVVJMfSB0aGUgcmVzdWx0IG9mIGRpdmlkZVVSTAogKi8KJ3VzZSBzdHJpY3QnOwoKT2JqZWN0LmRlZmluZVByb3BlcnR5KGV4cG9ydHMsICdfX2VzTW9kdWxlJywgewogIHZhbHVlOiB0cnVlCn0pOwpleHBvcnRzLmRpdmlkZVVSTCA9IGRpdmlkZVVSTDsKZXhwb3J0cy5kZWVwQ2xvbmUgPSBkZWVwQ2xvbmU7CgpmdW5jdGlvbiBkaXZpZGVVUkwodXJsKSB7CgogIC8vIGxldCByZSA9IC8oW2EtekEtWi1dKik/OlwvXC8oPzpcLik/KFstYS16QS1aMC05QDolLl9cK34jPV17MiwyNTZ9XC5bYS16XXsyLDZ9XGIpKihcL1tcL1xkXHdcLi1dKikqKD86W1w/XSkqKC4rKSovZ2k7CiAgdmFyIHJlID0gLyhbYS16QS1aLV0qKTpcL1wvKD86XC4pPyhbLWEtekEtWjAtOUA6JS5fXCt+Iz1dezIsMjU2fSkoWy1hLXpBLVowLTlAOiUuX1wrfiM9XC9dKikvZ2k7CiAgdmFyIHN1YnN0ID0gJyQxLCQyLCQzJzsKICB2YXIgcGFydHMgPSB1cmwucmVwbGFjZShyZSwgc3Vic3QpLnNwbGl0KCcsJyk7CiAgdmFyIHJlc3VsdCA9IHsKICAgIHR5cGU6IHBhcnRzWzBdLAogICAgZG9tYWluOiBwYXJ0c1sxXSwKICAgIGlkZW50aXR5OiBwYXJ0c1syXQogIH07CgogIHJldHVybiByZXN1bHQ7Cn0KCi8qKgogKiBNYWtlIGEgQ09QWSBvZiB0aGUgb3JpZ2luYWwgZGF0YQogKiBAcGFyYW0gIHtPYmplY3R9ICBvYmogLSBvYmplY3QgdG8gYmUgY2xvbmVkCiAqIEByZXR1cm4ge09iamVjdH0KICovCgpmdW5jdGlvbiBkZWVwQ2xvbmUob2JqKSB7CiAgLy9UT0RPOiBzaW1wbGUgYnV0IGluZWZmaWNpZW50IEpTT04gZGVlcCBjbG9uZS4uLgogIGlmIChvYmopIHJldHVybiBKU09OLnBhcnNlKEpTT04uc3RyaW5naWZ5KG9iaikpOwp9Cgp9LHt9XX0se30sWzkzXSkoOTMpCn0pOw==",
      "sourceCodeClassname": "HypertyChat",
      "encoding": "base64",
      "signature": ""
    },
    "cguid": 1,
    "type": "Hyperties",
    "version": "0.1",
    "description": "Description of HypertyChat",
    "objectName": "HypertyChat",
    "sourcePackageURL": "/sourcePackage",
    "language": "javascript",
    "signature": "",
    "messageSchemas": "",
    "dataObjects": [],
    "accessControlPolicy": "somePolicy"
  },
  "HypertyConnector": {
    "sourcePackage": {
      "sourceCode": "KGZ1bmN0aW9uKGYpe2lmKHR5cGVvZiBleHBvcnRzPT09Im9iamVjdCImJnR5cGVvZiBtb2R1bGUhPT0idW5kZWZpbmVkIil7bW9kdWxlLmV4cG9ydHM9ZigpfWVsc2UgaWYodHlwZW9mIGRlZmluZT09PSJmdW5jdGlvbiImJmRlZmluZS5hbWQpe2RlZmluZShbXSxmKX1lbHNle3ZhciBnO2lmKHR5cGVvZiB3aW5kb3chPT0idW5kZWZpbmVkIil7Zz13aW5kb3d9ZWxzZSBpZih0eXBlb2YgZ2xvYmFsIT09InVuZGVmaW5lZCIpe2c9Z2xvYmFsfWVsc2UgaWYodHlwZW9mIHNlbGYhPT0idW5kZWZpbmVkIil7Zz1zZWxmfWVsc2V7Zz10aGlzfWcuYWN0aXZhdGUgPSBmKCl9fSkoZnVuY3Rpb24oKXt2YXIgZGVmaW5lLG1vZHVsZSxleHBvcnRzO3JldHVybiAoZnVuY3Rpb24gZSh0LG4scil7ZnVuY3Rpb24gcyhvLHUpe2lmKCFuW29dKXtpZighdFtvXSl7dmFyIGE9dHlwZW9mIHJlcXVpcmU9PSJmdW5jdGlvbiImJnJlcXVpcmU7aWYoIXUmJmEpcmV0dXJuIGEobywhMCk7aWYoaSlyZXR1cm4gaShvLCEwKTt2YXIgZj1uZXcgRXJyb3IoIkNhbm5vdCBmaW5kIG1vZHVsZSAnIitvKyInIik7dGhyb3cgZi5jb2RlPSJNT0RVTEVfTk9UX0ZPVU5EIixmfXZhciBsPW5bb109e2V4cG9ydHM6e319O3Rbb11bMF0uY2FsbChsLmV4cG9ydHMsZnVuY3Rpb24oZSl7dmFyIG49dFtvXVsxXVtlXTtyZXR1cm4gcyhuP246ZSl9LGwsbC5leHBvcnRzLGUsdCxuLHIpfXJldHVybiBuW29dLmV4cG9ydHN9dmFyIGk9dHlwZW9mIHJlcXVpcmU9PSJmdW5jdGlvbiImJnJlcXVpcmU7Zm9yKHZhciBvPTA7bzxyLmxlbmd0aDtvKyspcyhyW29dKTtyZXR1cm4gc30pKHsxOltmdW5jdGlvbihyZXF1aXJlLG1vZHVsZSxleHBvcnRzKXsKLyoKICogIENvcHlyaWdodCAoYykgMjAxNiBUaGUgV2ViUlRDIHByb2plY3QgYXV0aG9ycy4gQWxsIFJpZ2h0cyBSZXNlcnZlZC4KICoKICogIFVzZSBvZiB0aGlzIHNvdXJjZSBjb2RlIGlzIGdvdmVybmVkIGJ5IGEgQlNELXN0eWxlIGxpY2Vuc2UKICogIHRoYXQgY2FuIGJlIGZvdW5kIGluIHRoZSBMSUNFTlNFIGZpbGUgaW4gdGhlIHJvb3Qgb2YgdGhlIHNvdXJjZQogKiAgdHJlZS4KICovCgovKiBNb3JlIGluZm9ybWF0aW9uIGFib3V0IHRoZXNlIG9wdGlvbnMgYXQganNoaW50LmNvbS9kb2NzL29wdGlvbnMgKi8KLyoganNoaW50IGJyb3dzZXI6IHRydWUsIGNhbWVsY2FzZTogdHJ1ZSwgY3VybHk6IHRydWUsIGRldmVsOiB0cnVlLAogICBlcWVxZXE6IHRydWUsIGZvcmluOiBmYWxzZSwgZ2xvYmFsc3RyaWN0OiB0cnVlLCBub2RlOiB0cnVlLAogICBxdW90bWFyazogc2luZ2xlLCB1bmRlZjogdHJ1ZSwgdW51c2VkOiBzdHJpY3QgKi8KLyogZ2xvYmFsIG1velJUQ0ljZUNhbmRpZGF0ZSwgbW96UlRDUGVlckNvbm5lY3Rpb24sIFByb21pc2UsCm1velJUQ1Nlc3Npb25EZXNjcmlwdGlvbiwgd2Via2l0UlRDUGVlckNvbm5lY3Rpb24sIE1lZGlhU3RyZWFtVHJhY2ssCk1lZGlhU3RyZWFtLCBSVENJY2VHYXRoZXJlciwgUlRDSWNlVHJhbnNwb3J0LCBSVENEdGxzVHJhbnNwb3J0LApSVENSdHBTZW5kZXIsIFJUQ1J0cFJlY2VpdmVyKi8KLyogZXhwb3J0ZWQgdHJhY2UscmVxdWVzdFVzZXJNZWRpYSAqLwoKJ3VzZSBzdHJpY3QnOwoKdmFyIGdldFVzZXJNZWRpYSA9IG51bGw7CnZhciBhdHRhY2hNZWRpYVN0cmVhbSA9IG51bGw7CnZhciByZWF0dGFjaE1lZGlhU3RyZWFtID0gbnVsbDsKdmFyIHdlYnJ0Y0RldGVjdGVkQnJvd3NlciA9IG51bGw7CnZhciB3ZWJydGNEZXRlY3RlZFZlcnNpb24gPSBudWxsOwp2YXIgd2VicnRjTWluaW11bVZlcnNpb24gPSBudWxsOwp2YXIgd2VicnRjVXRpbHMgPSB7CiAgbG9nOiBmdW5jdGlvbiBsb2coKSB7CiAgICAvLyBzdXBwcmVzcyBjb25zb2xlLmxvZyBvdXRwdXQgd2hlbiBiZWluZyBpbmNsdWRlZCBhcyBhIG1vZHVsZS4KICAgIGlmICh0eXBlb2YgbW9kdWxlICE9PSAndW5kZWZpbmVkJyB8fCB0eXBlb2YgcmVxdWlyZSA9PT0gJ2Z1bmN0aW9uJyAmJiB0eXBlb2YgZGVmaW5lID09PSAnZnVuY3Rpb24nKSB7CiAgICAgIHJldHVybjsKICAgIH0KICAgIGNvbnNvbGUubG9nLmFwcGx5KGNvbnNvbGUsIGFyZ3VtZW50cyk7CiAgfSwKICBleHRyYWN0VmVyc2lvbjogZnVuY3Rpb24gZXh0cmFjdFZlcnNpb24odWFzdHJpbmcsIGV4cHIsIHBvcykgewogICAgdmFyIG1hdGNoID0gdWFzdHJpbmcubWF0Y2goZXhwcik7CiAgICByZXR1cm4gbWF0Y2ggJiYgbWF0Y2gubGVuZ3RoID49IHBvcyAmJiBwYXJzZUludChtYXRjaFtwb3NdLCAxMCk7CiAgfQp9OwoKZnVuY3Rpb24gdHJhY2UodGV4dCkgewogIC8vIFRoaXMgZnVuY3Rpb24gaXMgdXNlZCBmb3IgbG9nZ2luZy4KICBpZiAodGV4dFt0ZXh0Lmxlbmd0aCAtIDFdID09PSAnXG4nKSB7CiAgICB0ZXh0ID0gdGV4dC5zdWJzdHJpbmcoMCwgdGV4dC5sZW5ndGggLSAxKTsKICB9CiAgaWYgKHdpbmRvdy5wZXJmb3JtYW5jZSkgewogICAgdmFyIG5vdyA9ICh3aW5kb3cucGVyZm9ybWFuY2Uubm93KCkgLyAxMDAwKS50b0ZpeGVkKDMpOwogICAgd2VicnRjVXRpbHMubG9nKG5vdyArICc6ICcgKyB0ZXh0KTsKICB9IGVsc2UgewogICAgd2VicnRjVXRpbHMubG9nKHRleHQpOwogIH0KfQoKaWYgKHR5cGVvZiB3aW5kb3cgPT09ICdvYmplY3QnKSB7CiAgaWYgKHdpbmRvdy5IVE1MTWVkaWFFbGVtZW50ICYmICEoJ3NyY09iamVjdCcgaW4gd2luZG93LkhUTUxNZWRpYUVsZW1lbnQucHJvdG90eXBlKSkgewogICAgLy8gU2hpbSB0aGUgc3JjT2JqZWN0IHByb3BlcnR5LCBvbmNlLCB3aGVuIEhUTUxNZWRpYUVsZW1lbnQgaXMgZm91bmQuCiAgICBPYmplY3QuZGVmaW5lUHJvcGVydHkod2luZG93LkhUTUxNZWRpYUVsZW1lbnQucHJvdG90eXBlLCAnc3JjT2JqZWN0JywgewogICAgICBnZXQ6IGZ1bmN0aW9uIGdldCgpIHsKICAgICAgICAvLyBJZiBwcmVmaXhlZCBzcmNPYmplY3QgcHJvcGVydHkgZXhpc3RzLCByZXR1cm4gaXQuCiAgICAgICAgLy8gT3RoZXJ3aXNlIHVzZSB0aGUgc2hpbW1lZCBwcm9wZXJ0eSwgX3NyY09iamVjdAogICAgICAgIHJldHVybiAnbW96U3JjT2JqZWN0JyBpbiB0aGlzID8gdGhpcy5tb3pTcmNPYmplY3QgOiB0aGlzLl9zcmNPYmplY3Q7CiAgICAgIH0sCiAgICAgIHNldDogZnVuY3Rpb24gc2V0KHN0cmVhbSkgewogICAgICAgIGlmICgnbW96U3JjT2JqZWN0JyBpbiB0aGlzKSB7CiAgICAgICAgICB0aGlzLm1velNyY09iamVjdCA9IHN0cmVhbTsKICAgICAgICB9IGVsc2UgewogICAgICAgICAgLy8gVXNlIF9zcmNPYmplY3QgYXMgYSBwcml2YXRlIHByb3BlcnR5IGZvciB0aGlzIHNoaW0KICAgICAgICAgIHRoaXMuX3NyY09iamVjdCA9IHN0cmVhbTsKICAgICAgICAgIC8vIFRPRE86IHJldm9rZU9iamVjdFVybCh0aGlzLnNyYykgd2hlbiAhc3RyZWFtIHRvIHJlbGVhc2UgcmVzb3VyY2VzPwogICAgICAgICAgdGhpcy5zcmMgPSBVUkwuY3JlYXRlT2JqZWN0VVJMKHN0cmVhbSk7CiAgICAgICAgfQogICAgICB9CiAgICB9KTsKICB9CiAgLy8gUHJveHkgZXhpc3RpbmcgZ2xvYmFscwogIGdldFVzZXJNZWRpYSA9IHdpbmRvdy5uYXZpZ2F0b3IgJiYgd2luZG93Lm5hdmlnYXRvci5nZXRVc2VyTWVkaWE7Cn0KCi8vIEF0dGFjaCBhIG1lZGlhIHN0cmVhbSB0byBhbiBlbGVtZW50LgphdHRhY2hNZWRpYVN0cmVhbSA9IGZ1bmN0aW9uIChlbGVtZW50LCBzdHJlYW0pIHsKICBlbGVtZW50LnNyY09iamVjdCA9IHN0cmVhbTsKfTsKCnJlYXR0YWNoTWVkaWFTdHJlYW0gPSBmdW5jdGlvbiAodG8sIGZyb20pIHsKICB0by5zcmNPYmplY3QgPSBmcm9tLnNyY09iamVjdDsKfTsKCmlmICh0eXBlb2Ygd2luZG93ID09PSAndW5kZWZpbmVkJyB8fCAhd2luZG93Lm5hdmlnYXRvcikgewogIHdlYnJ0Y1V0aWxzLmxvZygnVGhpcyBkb2VzIG5vdCBhcHBlYXIgdG8gYmUgYSBicm93c2VyJyk7CiAgd2VicnRjRGV0ZWN0ZWRCcm93c2VyID0gJ25vdCBhIGJyb3dzZXInOwp9IGVsc2UgaWYgKG5hdmlnYXRvci5tb3pHZXRVc2VyTWVkaWEpIHsKICB3ZWJydGNVdGlscy5sb2coJ1RoaXMgYXBwZWFycyB0byBiZSBGaXJlZm94Jyk7CgogIHdlYnJ0Y0RldGVjdGVkQnJvd3NlciA9ICdmaXJlZm94JzsKCiAgLy8gdGhlIGRldGVjdGVkIGZpcmVmb3ggdmVyc2lvbi4KICB3ZWJydGNEZXRlY3RlZFZlcnNpb24gPSB3ZWJydGNVdGlscy5leHRyYWN0VmVyc2lvbihuYXZpZ2F0b3IudXNlckFnZW50LCAvRmlyZWZveFwvKFswLTldKylcLi8sIDEpOwoKICAvLyB0aGUgbWluaW11bSBmaXJlZm94IHZlcnNpb24gc3RpbGwgc3VwcG9ydGVkIGJ5IGFkYXB0ZXIuCiAgd2VicnRjTWluaW11bVZlcnNpb24gPSAzMTsKCiAgLy8gU2hpbSBmb3IgUlRDUGVlckNvbm5lY3Rpb24gb24gb2xkZXIgdmVyc2lvbnMuCiAgaWYgKCF3aW5kb3cuUlRDUGVlckNvbm5lY3Rpb24pIHsKICAgIHdpbmRvdy5SVENQZWVyQ29ubmVjdGlvbiA9IGZ1bmN0aW9uIChwY0NvbmZpZywgcGNDb25zdHJhaW50cykgewogICAgICBpZiAod2VicnRjRGV0ZWN0ZWRWZXJzaW9uIDwgMzgpIHsKICAgICAgICAvLyAudXJscyBpcyBub3Qgc3VwcG9ydGVkIGluIEZGIDwgMzguCiAgICAgICAgLy8gY3JlYXRlIFJUQ0ljZVNlcnZlcnMgd2l0aCBhIHNpbmdsZSB1cmwuCiAgICAgICAgaWYgKHBjQ29uZmlnICYmIHBjQ29uZmlnLmljZVNlcnZlcnMpIHsKICAgICAgICAgIHZhciBuZXdJY2VTZXJ2ZXJzID0gW107CiAgICAgICAgICBmb3IgKHZhciBpID0gMDsgaSA8IHBjQ29uZmlnLmljZVNlcnZlcnMubGVuZ3RoOyBpKyspIHsKICAgICAgICAgICAgdmFyIHNlcnZlciA9IHBjQ29uZmlnLmljZVNlcnZlcnNbaV07CiAgICAgICAgICAgIGlmIChzZXJ2ZXIuaGFzT3duUHJvcGVydHkoJ3VybHMnKSkgewogICAgICAgICAgICAgIGZvciAodmFyIGogPSAwOyBqIDwgc2VydmVyLnVybHMubGVuZ3RoOyBqKyspIHsKICAgICAgICAgICAgICAgIHZhciBuZXdTZXJ2ZXIgPSB7CiAgICAgICAgICAgICAgICAgIHVybDogc2VydmVyLnVybHNbal0KICAgICAgICAgICAgICAgIH07CiAgICAgICAgICAgICAgICBpZiAoc2VydmVyLnVybHNbal0uaW5kZXhPZigndHVybicpID09PSAwKSB7CiAgICAgICAgICAgICAgICAgIG5ld1NlcnZlci51c2VybmFtZSA9IHNlcnZlci51c2VybmFtZTsKICAgICAgICAgICAgICAgICAgbmV3U2VydmVyLmNyZWRlbnRpYWwgPSBzZXJ2ZXIuY3JlZGVudGlhbDsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIG5ld0ljZVNlcnZlcnMucHVzaChuZXdTZXJ2ZXIpOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICBuZXdJY2VTZXJ2ZXJzLnB1c2gocGNDb25maWcuaWNlU2VydmVyc1tpXSk7CiAgICAgICAgICAgIH0KICAgICAgICAgIH0KICAgICAgICAgIHBjQ29uZmlnLmljZVNlcnZlcnMgPSBuZXdJY2VTZXJ2ZXJzOwogICAgICAgIH0KICAgICAgfQogICAgICByZXR1cm4gbmV3IG1velJUQ1BlZXJDb25uZWN0aW9uKHBjQ29uZmlnLCBwY0NvbnN0cmFpbnRzKTsgLy8ganNjczppZ25vcmUgcmVxdWlyZUNhcGl0YWxpemVkQ29uc3RydWN0b3JzCiAgICB9OwogICAgd2luZG93LlJUQ1BlZXJDb25uZWN0aW9uLnByb3RvdHlwZSA9IG1velJUQ1BlZXJDb25uZWN0aW9uLnByb3RvdHlwZTsKCiAgICAvLyB3cmFwIHN0YXRpYyBtZXRob2RzLiBDdXJyZW50bHkganVzdCBnZW5lcmF0ZUNlcnRpZmljYXRlLgogICAgaWYgKG1velJUQ1BlZXJDb25uZWN0aW9uLmdlbmVyYXRlQ2VydGlmaWNhdGUpIHsKICAgICAgT2JqZWN0LmRlZmluZVByb3BlcnR5KHdpbmRvdy5SVENQZWVyQ29ubmVjdGlvbiwgJ2dlbmVyYXRlQ2VydGlmaWNhdGUnLCB7CiAgICAgICAgZ2V0OiBmdW5jdGlvbiBnZXQoKSB7CiAgICAgICAgICBpZiAoYXJndW1lbnRzLmxlbmd0aCkgewogICAgICAgICAgICByZXR1cm4gbW96UlRDUGVlckNvbm5lY3Rpb24uZ2VuZXJhdGVDZXJ0aWZpY2F0ZS5hcHBseShudWxsLCBhcmd1bWVudHMpOwogICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgcmV0dXJuIG1velJUQ1BlZXJDb25uZWN0aW9uLmdlbmVyYXRlQ2VydGlmaWNhdGU7CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICB9KTsKICAgIH0KCiAgICB3aW5kb3cuUlRDU2Vzc2lvbkRlc2NyaXB0aW9uID0gbW96UlRDU2Vzc2lvbkRlc2NyaXB0aW9uOwogICAgd2luZG93LlJUQ0ljZUNhbmRpZGF0ZSA9IG1velJUQ0ljZUNhbmRpZGF0ZTsKICB9CgogIC8vIGdldFVzZXJNZWRpYSBjb25zdHJhaW50cyBzaGltLgogIGdldFVzZXJNZWRpYSA9IGZ1bmN0aW9uIChjb25zdHJhaW50cywgb25TdWNjZXNzLCBvbkVycm9yKSB7CiAgICB2YXIgY29uc3RyYWludHNUb0ZGMzcgPSBmdW5jdGlvbiBjb25zdHJhaW50c1RvRkYzNyhjKSB7CiAgICAgIGlmICh0eXBlb2YgYyAhPT0gJ29iamVjdCcgfHwgYy5yZXF1aXJlKSB7CiAgICAgICAgcmV0dXJuIGM7CiAgICAgIH0KICAgICAgdmFyIHJlcXVpcmUgPSBbXTsKICAgICAgT2JqZWN0LmtleXMoYykuZm9yRWFjaChmdW5jdGlvbiAoa2V5KSB7CiAgICAgICAgaWYgKGtleSA9PT0gJ3JlcXVpcmUnIHx8IGtleSA9PT0gJ2FkdmFuY2VkJyB8fCBrZXkgPT09ICdtZWRpYVNvdXJjZScpIHsKICAgICAgICAgIHJldHVybjsKICAgICAgICB9CiAgICAgICAgdmFyIHIgPSBjW2tleV0gPSB0eXBlb2YgY1trZXldID09PSAnb2JqZWN0JyA/IGNba2V5XSA6IHsgaWRlYWw6IGNba2V5XSB9OwogICAgICAgIGlmIChyLm1pbiAhPT0gdW5kZWZpbmVkIHx8IHIubWF4ICE9PSB1bmRlZmluZWQgfHwgci5leGFjdCAhPT0gdW5kZWZpbmVkKSB7CiAgICAgICAgICByZXF1aXJlLnB1c2goa2V5KTsKICAgICAgICB9CiAgICAgICAgaWYgKHIuZXhhY3QgIT09IHVuZGVmaW5lZCkgewogICAgICAgICAgaWYgKHR5cGVvZiByLmV4YWN0ID09PSAnbnVtYmVyJykgewogICAgICAgICAgICByLm1pbiA9IHIubWF4ID0gci5leGFjdDsKICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgIGNba2V5XSA9IHIuZXhhY3Q7CiAgICAgICAgICB9CiAgICAgICAgICBkZWxldGUgci5leGFjdDsKICAgICAgICB9CiAgICAgICAgaWYgKHIuaWRlYWwgIT09IHVuZGVmaW5lZCkgewogICAgICAgICAgYy5hZHZhbmNlZCA9IGMuYWR2YW5jZWQgfHwgW107CiAgICAgICAgICB2YXIgb2MgPSB7fTsKICAgICAgICAgIGlmICh0eXBlb2Ygci5pZGVhbCA9PT0gJ251bWJlcicpIHsKICAgICAgICAgICAgb2Nba2V5XSA9IHsgbWluOiByLmlkZWFsLCBtYXg6IHIuaWRlYWwgfTsKICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgIG9jW2tleV0gPSByLmlkZWFsOwogICAgICAgICAgfQogICAgICAgICAgYy5hZHZhbmNlZC5wdXNoKG9jKTsKICAgICAgICAgIGRlbGV0ZSByLmlkZWFsOwogICAgICAgICAgaWYgKCFPYmplY3Qua2V5cyhyKS5sZW5ndGgpIHsKICAgICAgICAgICAgZGVsZXRlIGNba2V5XTsKICAgICAgICAgIH0KICAgICAgICB9CiAgICAgIH0pOwogICAgICBpZiAocmVxdWlyZS5sZW5ndGgpIHsKICAgICAgICBjLnJlcXVpcmUgPSByZXF1aXJlOwogICAgICB9CiAgICAgIHJldHVybiBjOwogICAgfTsKICAgIGlmICh3ZWJydGNEZXRlY3RlZFZlcnNpb24gPCAzOCkgewogICAgICB3ZWJydGNVdGlscy5sb2coJ3NwZWM6ICcgKyBKU09OLnN0cmluZ2lmeShjb25zdHJhaW50cykpOwogICAgICBpZiAoY29uc3RyYWludHMuYXVkaW8pIHsKICAgICAgICBjb25zdHJhaW50cy5hdWRpbyA9IGNvbnN0cmFpbnRzVG9GRjM3KGNvbnN0cmFpbnRzLmF1ZGlvKTsKICAgICAgfQogICAgICBpZiAoY29uc3RyYWludHMudmlkZW8pIHsKICAgICAgICBjb25zdHJhaW50cy52aWRlbyA9IGNvbnN0cmFpbnRzVG9GRjM3KGNvbnN0cmFpbnRzLnZpZGVvKTsKICAgICAgfQogICAgICB3ZWJydGNVdGlscy5sb2coJ2ZmMzc6ICcgKyBKU09OLnN0cmluZ2lmeShjb25zdHJhaW50cykpOwogICAgfQogICAgcmV0dXJuIG5hdmlnYXRvci5tb3pHZXRVc2VyTWVkaWEoY29uc3RyYWludHMsIG9uU3VjY2Vzcywgb25FcnJvcik7CiAgfTsKCiAgbmF2aWdhdG9yLmdldFVzZXJNZWRpYSA9IGdldFVzZXJNZWRpYTsKCiAgLy8gU2hpbSBmb3IgbWVkaWFEZXZpY2VzIG9uIG9sZGVyIHZlcnNpb25zLgogIGlmICghbmF2aWdhdG9yLm1lZGlhRGV2aWNlcykgewogICAgbmF2aWdhdG9yLm1lZGlhRGV2aWNlcyA9IHsgZ2V0VXNlck1lZGlhOiByZXF1ZXN0VXNlck1lZGlhLAogICAgICBhZGRFdmVudExpc3RlbmVyOiBmdW5jdGlvbiBhZGRFdmVudExpc3RlbmVyKCkge30sCiAgICAgIHJlbW92ZUV2ZW50TGlzdGVuZXI6IGZ1bmN0aW9uIHJlbW92ZUV2ZW50TGlzdGVuZXIoKSB7fQogICAgfTsKICB9CiAgbmF2aWdhdG9yLm1lZGlhRGV2aWNlcy5lbnVtZXJhdGVEZXZpY2VzID0gbmF2aWdhdG9yLm1lZGlhRGV2aWNlcy5lbnVtZXJhdGVEZXZpY2VzIHx8IGZ1bmN0aW9uICgpIHsKICAgIHJldHVybiBuZXcgUHJvbWlzZShmdW5jdGlvbiAocmVzb2x2ZSkgewogICAgICB2YXIgaW5mb3MgPSBbeyBraW5kOiAnYXVkaW9pbnB1dCcsIGRldmljZUlkOiAnZGVmYXVsdCcsIGxhYmVsOiAnJywgZ3JvdXBJZDogJycgfSwgeyBraW5kOiAndmlkZW9pbnB1dCcsIGRldmljZUlkOiAnZGVmYXVsdCcsIGxhYmVsOiAnJywgZ3JvdXBJZDogJycgfV07CiAgICAgIHJlc29sdmUoaW5mb3MpOwogICAgfSk7CiAgfTsKCiAgaWYgKHdlYnJ0Y0RldGVjdGVkVmVyc2lvbiA8IDQxKSB7CiAgICAvLyBXb3JrIGFyb3VuZCBodHRwOi8vYnVnemlsLmxhLzExNjk2NjUKICAgIHZhciBvcmdFbnVtZXJhdGVEZXZpY2VzID0gbmF2aWdhdG9yLm1lZGlhRGV2aWNlcy5lbnVtZXJhdGVEZXZpY2VzLmJpbmQobmF2aWdhdG9yLm1lZGlhRGV2aWNlcyk7CiAgICBuYXZpZ2F0b3IubWVkaWFEZXZpY2VzLmVudW1lcmF0ZURldmljZXMgPSBmdW5jdGlvbiAoKSB7CiAgICAgIHJldHVybiBvcmdFbnVtZXJhdGVEZXZpY2VzKCkudGhlbih1bmRlZmluZWQsIGZ1bmN0aW9uIChlKSB7CiAgICAgICAgaWYgKGUubmFtZSA9PT0gJ05vdEZvdW5kRXJyb3InKSB7CiAgICAgICAgICByZXR1cm4gW107CiAgICAgICAgfQogICAgICAgIHRocm93IGU7CiAgICAgIH0pOwogICAgfTsKICB9Cn0gZWxzZSBpZiAobmF2aWdhdG9yLndlYmtpdEdldFVzZXJNZWRpYSAmJiB3aW5kb3cud2Via2l0UlRDUGVlckNvbm5lY3Rpb24pIHsKICB3ZWJydGNVdGlscy5sb2coJ1RoaXMgYXBwZWFycyB0byBiZSBDaHJvbWUnKTsKCiAgd2VicnRjRGV0ZWN0ZWRCcm93c2VyID0gJ2Nocm9tZSc7CgogIC8vIHRoZSBkZXRlY3RlZCBjaHJvbWUgdmVyc2lvbi4KICB3ZWJydGNEZXRlY3RlZFZlcnNpb24gPSB3ZWJydGNVdGlscy5leHRyYWN0VmVyc2lvbihuYXZpZ2F0b3IudXNlckFnZW50LCAvQ2hyb20oZXxpdW0pXC8oWzAtOV0rKVwuLywgMik7CgogIC8vIHRoZSBtaW5pbXVtIGNocm9tZSB2ZXJzaW9uIHN0aWxsIHN1cHBvcnRlZCBieSBhZGFwdGVyLgogIHdlYnJ0Y01pbmltdW1WZXJzaW9uID0gMzg7CgogIC8vIFRoZSBSVENQZWVyQ29ubmVjdGlvbiBvYmplY3QuCiAgd2luZG93LlJUQ1BlZXJDb25uZWN0aW9uID0gZnVuY3Rpb24gKHBjQ29uZmlnLCBwY0NvbnN0cmFpbnRzKSB7CiAgICAvLyBUcmFuc2xhdGUgaWNlVHJhbnNwb3J0UG9saWN5IHRvIGljZVRyYW5zcG9ydHMsCiAgICAvLyBzZWUgaHR0cHM6Ly9jb2RlLmdvb2dsZS5jb20vcC93ZWJydGMvaXNzdWVzL2RldGFpbD9pZD00ODY5CiAgICBpZiAocGNDb25maWcgJiYgcGNDb25maWcuaWNlVHJhbnNwb3J0UG9saWN5KSB7CiAgICAgIHBjQ29uZmlnLmljZVRyYW5zcG9ydHMgPSBwY0NvbmZpZy5pY2VUcmFuc3BvcnRQb2xpY3k7CiAgICB9CgogICAgdmFyIHBjID0gbmV3IHdlYmtpdFJUQ1BlZXJDb25uZWN0aW9uKHBjQ29uZmlnLCBwY0NvbnN0cmFpbnRzKTsgLy8ganNjczppZ25vcmUgcmVxdWlyZUNhcGl0YWxpemVkQ29uc3RydWN0b3JzCiAgICB2YXIgb3JpZ0dldFN0YXRzID0gcGMuZ2V0U3RhdHMuYmluZChwYyk7CiAgICBwYy5nZXRTdGF0cyA9IGZ1bmN0aW9uIChzZWxlY3Rvciwgc3VjY2Vzc0NhbGxiYWNrLCBlcnJvckNhbGxiYWNrKSB7CiAgICAgIC8vIGpzaGludCBpZ25vcmU6IGxpbmUKICAgICAgdmFyIHNlbGYgPSB0aGlzOwogICAgICB2YXIgYXJncyA9IGFyZ3VtZW50czsKCiAgICAgIC8vIElmIHNlbGVjdG9yIGlzIGEgZnVuY3Rpb24gdGhlbiB3ZSBhcmUgaW4gdGhlIG9sZCBzdHlsZSBzdGF0cyBzbyBqdXN0CiAgICAgIC8vIHBhc3MgYmFjayB0aGUgb3JpZ2luYWwgZ2V0U3RhdHMgZm9ybWF0IHRvIGF2b2lkIGJyZWFraW5nIG9sZCB1c2Vycy4KICAgICAgaWYgKGFyZ3VtZW50cy5sZW5ndGggPiAwICYmIHR5cGVvZiBzZWxlY3RvciA9PT0gJ2Z1bmN0aW9uJykgewogICAgICAgIHJldHVybiBvcmlnR2V0U3RhdHMoc2VsZWN0b3IsIHN1Y2Nlc3NDYWxsYmFjayk7CiAgICAgIH0KCiAgICAgIHZhciBmaXhDaHJvbWVTdGF0cyA9IGZ1bmN0aW9uIGZpeENocm9tZVN0YXRzKHJlc3BvbnNlKSB7CiAgICAgICAgdmFyIHN0YW5kYXJkUmVwb3J0ID0ge307CiAgICAgICAgdmFyIHJlcG9ydHMgPSByZXNwb25zZS5yZXN1bHQoKTsKICAgICAgICByZXBvcnRzLmZvckVhY2goZnVuY3Rpb24gKHJlcG9ydCkgewogICAgICAgICAgdmFyIHN0YW5kYXJkU3RhdHMgPSB7CiAgICAgICAgICAgIGlkOiByZXBvcnQuaWQsCiAgICAgICAgICAgIHRpbWVzdGFtcDogcmVwb3J0LnRpbWVzdGFtcCwKICAgICAgICAgICAgdHlwZTogcmVwb3J0LnR5cGUKICAgICAgICAgIH07CiAgICAgICAgICByZXBvcnQubmFtZXMoKS5mb3JFYWNoKGZ1bmN0aW9uIChuYW1lKSB7CiAgICAgICAgICAgIHN0YW5kYXJkU3RhdHNbbmFtZV0gPSByZXBvcnQuc3RhdChuYW1lKTsKICAgICAgICAgIH0pOwogICAgICAgICAgc3RhbmRhcmRSZXBvcnRbc3RhbmRhcmRTdGF0cy5pZF0gPSBzdGFuZGFyZFN0YXRzOwogICAgICAgIH0pOwoKICAgICAgICByZXR1cm4gc3RhbmRhcmRSZXBvcnQ7CiAgICAgIH07CgogICAgICBpZiAoYXJndW1lbnRzLmxlbmd0aCA+PSAyKSB7CiAgICAgICAgdmFyIHN1Y2Nlc3NDYWxsYmFja1dyYXBwZXIgPSBmdW5jdGlvbiBzdWNjZXNzQ2FsbGJhY2tXcmFwcGVyKHJlc3BvbnNlKSB7CiAgICAgICAgICBhcmdzWzFdKGZpeENocm9tZVN0YXRzKHJlc3BvbnNlKSk7CiAgICAgICAgfTsKCiAgICAgICAgcmV0dXJuIG9yaWdHZXRTdGF0cy5hcHBseSh0aGlzLCBbc3VjY2Vzc0NhbGxiYWNrV3JhcHBlciwgYXJndW1lbnRzWzBdXSk7CiAgICAgIH0KCiAgICAgIC8vIHByb21pc2Utc3VwcG9ydAogICAgICByZXR1cm4gbmV3IFByb21pc2UoZnVuY3Rpb24gKHJlc29sdmUsIHJlamVjdCkgewogICAgICAgIGlmIChhcmdzLmxlbmd0aCA9PT0gMSAmJiBzZWxlY3RvciA9PT0gbnVsbCkgewogICAgICAgICAgb3JpZ0dldFN0YXRzLmFwcGx5KHNlbGYsIFtmdW5jdGlvbiAocmVzcG9uc2UpIHsKICAgICAgICAgICAgcmVzb2x2ZS5hcHBseShudWxsLCBbZml4Q2hyb21lU3RhdHMocmVzcG9uc2UpXSk7CiAgICAgICAgICB9LCByZWplY3RdKTsKICAgICAgICB9IGVsc2UgewogICAgICAgICAgb3JpZ0dldFN0YXRzLmFwcGx5KHNlbGYsIFtyZXNvbHZlLCByZWplY3RdKTsKICAgICAgICB9CiAgICAgIH0pOwogICAgfTsKCiAgICByZXR1cm4gcGM7CiAgfTsKICB3aW5kb3cuUlRDUGVlckNvbm5lY3Rpb24ucHJvdG90eXBlID0gd2Via2l0UlRDUGVlckNvbm5lY3Rpb24ucHJvdG90eXBlOwoKICAvLyB3cmFwIHN0YXRpYyBtZXRob2RzLiBDdXJyZW50bHkganVzdCBnZW5lcmF0ZUNlcnRpZmljYXRlLgogIGlmICh3ZWJraXRSVENQZWVyQ29ubmVjdGlvbi5nZW5lcmF0ZUNlcnRpZmljYXRlKSB7CiAgICBPYmplY3QuZGVmaW5lUHJvcGVydHkod2luZG93LlJUQ1BlZXJDb25uZWN0aW9uLCAnZ2VuZXJhdGVDZXJ0aWZpY2F0ZScsIHsKICAgICAgZ2V0OiBmdW5jdGlvbiBnZXQoKSB7CiAgICAgICAgaWYgKGFyZ3VtZW50cy5sZW5ndGgpIHsKICAgICAgICAgIHJldHVybiB3ZWJraXRSVENQZWVyQ29ubmVjdGlvbi5nZW5lcmF0ZUNlcnRpZmljYXRlLmFwcGx5KG51bGwsIGFyZ3VtZW50cyk7CiAgICAgICAgfSBlbHNlIHsKICAgICAgICAgIHJldHVybiB3ZWJraXRSVENQZWVyQ29ubmVjdGlvbi5nZW5lcmF0ZUNlcnRpZmljYXRlOwogICAgICAgIH0KICAgICAgfQogICAgfSk7CiAgfQoKICAvLyBhZGQgcHJvbWlzZSBzdXBwb3J0CiAgWydjcmVhdGVPZmZlcicsICdjcmVhdGVBbnN3ZXInXS5mb3JFYWNoKGZ1bmN0aW9uIChtZXRob2QpIHsKICAgIHZhciBuYXRpdmVNZXRob2QgPSB3ZWJraXRSVENQZWVyQ29ubmVjdGlvbi5wcm90b3R5cGVbbWV0aG9kXTsKICAgIHdlYmtpdFJUQ1BlZXJDb25uZWN0aW9uLnByb3RvdHlwZVttZXRob2RdID0gZnVuY3Rpb24gKCkgewogICAgICB2YXIgc2VsZiA9IHRoaXM7CiAgICAgIGlmIChhcmd1bWVudHMubGVuZ3RoIDwgMSB8fCBhcmd1bWVudHMubGVuZ3RoID09PSAxICYmIHR5cGVvZiBhcmd1bWVudHNbMF0gPT09ICdvYmplY3QnKSB7CiAgICAgICAgdmFyIG9wdHMgPSBhcmd1bWVudHMubGVuZ3RoID09PSAxID8gYXJndW1lbnRzWzBdIDogdW5kZWZpbmVkOwogICAgICAgIHJldHVybiBuZXcgUHJvbWlzZShmdW5jdGlvbiAocmVzb2x2ZSwgcmVqZWN0KSB7CiAgICAgICAgICBuYXRpdmVNZXRob2QuYXBwbHkoc2VsZiwgW3Jlc29sdmUsIHJlamVjdCwgb3B0c10pOwogICAgICAgIH0pOwogICAgICB9IGVsc2UgewogICAgICAgIHJldHVybiBuYXRpdmVNZXRob2QuYXBwbHkodGhpcywgYXJndW1lbnRzKTsKICAgICAgfQogICAgfTsKICB9KTsKCiAgWydzZXRMb2NhbERlc2NyaXB0aW9uJywgJ3NldFJlbW90ZURlc2NyaXB0aW9uJywgJ2FkZEljZUNhbmRpZGF0ZSddLmZvckVhY2goZnVuY3Rpb24gKG1ldGhvZCkgewogICAgdmFyIG5hdGl2ZU1ldGhvZCA9IHdlYmtpdFJUQ1BlZXJDb25uZWN0aW9uLnByb3RvdHlwZVttZXRob2RdOwogICAgd2Via2l0UlRDUGVlckNvbm5lY3Rpb24ucHJvdG90eXBlW21ldGhvZF0gPSBmdW5jdGlvbiAoKSB7CiAgICAgIHZhciBhcmdzID0gYXJndW1lbnRzOwogICAgICB2YXIgc2VsZiA9IHRoaXM7CiAgICAgIHJldHVybiBuZXcgUHJvbWlzZShmdW5jdGlvbiAocmVzb2x2ZSwgcmVqZWN0KSB7CiAgICAgICAgbmF0aXZlTWV0aG9kLmFwcGx5KHNlbGYsIFthcmdzWzBdLCBmdW5jdGlvbiAoKSB7CiAgICAgICAgICByZXNvbHZlKCk7CiAgICAgICAgICBpZiAoYXJncy5sZW5ndGggPj0gMikgewogICAgICAgICAgICBhcmdzWzFdLmFwcGx5KG51bGwsIFtdKTsKICAgICAgICAgIH0KICAgICAgICB9LCBmdW5jdGlvbiAoZXJyKSB7CiAgICAgICAgICByZWplY3QoZXJyKTsKICAgICAgICAgIGlmIChhcmdzLmxlbmd0aCA+PSAzKSB7CiAgICAgICAgICAgIGFyZ3NbMl0uYXBwbHkobnVsbCwgW2Vycl0pOwogICAgICAgICAgfQogICAgICAgIH1dKTsKICAgICAgfSk7CiAgICB9OwogIH0pOwoKICAvLyBnZXRVc2VyTWVkaWEgY29uc3RyYWludHMgc2hpbS4KICB2YXIgY29uc3RyYWludHNUb0Nocm9tZSA9IGZ1bmN0aW9uIGNvbnN0cmFpbnRzVG9DaHJvbWUoYykgewogICAgaWYgKHR5cGVvZiBjICE9PSAnb2JqZWN0JyB8fCBjLm1hbmRhdG9yeSB8fCBjLm9wdGlvbmFsKSB7CiAgICAgIHJldHVybiBjOwogICAgfQogICAgdmFyIGNjID0ge307CiAgICBPYmplY3Qua2V5cyhjKS5mb3JFYWNoKGZ1bmN0aW9uIChrZXkpIHsKICAgICAgaWYgKGtleSA9PT0gJ3JlcXVpcmUnIHx8IGtleSA9PT0gJ2FkdmFuY2VkJyB8fCBrZXkgPT09ICdtZWRpYVNvdXJjZScpIHsKICAgICAgICByZXR1cm47CiAgICAgIH0KICAgICAgdmFyIHIgPSB0eXBlb2YgY1trZXldID09PSAnb2JqZWN0JyA/IGNba2V5XSA6IHsgaWRlYWw6IGNba2V5XSB9OwogICAgICBpZiAoci5leGFjdCAhPT0gdW5kZWZpbmVkICYmIHR5cGVvZiByLmV4YWN0ID09PSAnbnVtYmVyJykgewogICAgICAgIHIubWluID0gci5tYXggPSByLmV4YWN0OwogICAgICB9CiAgICAgIHZhciBvbGRuYW1lID0gZnVuY3Rpb24gb2xkbmFtZShwcmVmaXgsIG5hbWUpIHsKICAgICAgICBpZiAocHJlZml4KSB7CiAgICAgICAgICByZXR1cm4gcHJlZml4ICsgbmFtZS5jaGFyQXQoMCkudG9VcHBlckNhc2UoKSArIG5hbWUuc2xpY2UoMSk7CiAgICAgICAgfQogICAgICAgIHJldHVybiBuYW1lID09PSAnZGV2aWNlSWQnID8gJ3NvdXJjZUlkJyA6IG5hbWU7CiAgICAgIH07CiAgICAgIGlmIChyLmlkZWFsICE9PSB1bmRlZmluZWQpIHsKICAgICAgICBjYy5vcHRpb25hbCA9IGNjLm9wdGlvbmFsIHx8IFtdOwogICAgICAgIHZhciBvYyA9IHt9OwogICAgICAgIGlmICh0eXBlb2Ygci5pZGVhbCA9PT0gJ251bWJlcicpIHsKICAgICAgICAgIG9jW29sZG5hbWUoJ21pbicsIGtleSldID0gci5pZGVhbDsKICAgICAgICAgIGNjLm9wdGlvbmFsLnB1c2gob2MpOwogICAgICAgICAgb2MgPSB7fTsKICAgICAgICAgIG9jW29sZG5hbWUoJ21heCcsIGtleSldID0gci5pZGVhbDsKICAgICAgICAgIGNjLm9wdGlvbmFsLnB1c2gob2MpOwogICAgICAgIH0gZWxzZSB7CiAgICAgICAgICBvY1tvbGRuYW1lKCcnLCBrZXkpXSA9IHIuaWRlYWw7CiAgICAgICAgICBjYy5vcHRpb25hbC5wdXNoKG9jKTsKICAgICAgICB9CiAgICAgIH0KICAgICAgaWYgKHIuZXhhY3QgIT09IHVuZGVmaW5lZCAmJiB0eXBlb2Ygci5leGFjdCAhPT0gJ251bWJlcicpIHsKICAgICAgICBjYy5tYW5kYXRvcnkgPSBjYy5tYW5kYXRvcnkgfHwge307CiAgICAgICAgY2MubWFuZGF0b3J5W29sZG5hbWUoJycsIGtleSldID0gci5leGFjdDsKICAgICAgfSBlbHNlIHsKICAgICAgICBbJ21pbicsICdtYXgnXS5mb3JFYWNoKGZ1bmN0aW9uIChtaXgpIHsKICAgICAgICAgIGlmIChyW21peF0gIT09IHVuZGVmaW5lZCkgewogICAgICAgICAgICBjYy5tYW5kYXRvcnkgPSBjYy5tYW5kYXRvcnkgfHwge307CiAgICAgICAgICAgIGNjLm1hbmRhdG9yeVtvbGRuYW1lKG1peCwga2V5KV0gPSByW21peF07CiAgICAgICAgICB9CiAgICAgICAgfSk7CiAgICAgIH0KICAgIH0pOwogICAgaWYgKGMuYWR2YW5jZWQpIHsKICAgICAgY2Mub3B0aW9uYWwgPSAoY2Mub3B0aW9uYWwgfHwgW10pLmNvbmNhdChjLmFkdmFuY2VkKTsKICAgIH0KICAgIHJldHVybiBjYzsKICB9OwoKICBnZXRVc2VyTWVkaWEgPSBmdW5jdGlvbiAoY29uc3RyYWludHMsIG9uU3VjY2Vzcywgb25FcnJvcikgewogICAgaWYgKGNvbnN0cmFpbnRzLmF1ZGlvKSB7CiAgICAgIGNvbnN0cmFpbnRzLmF1ZGlvID0gY29uc3RyYWludHNUb0Nocm9tZShjb25zdHJhaW50cy5hdWRpbyk7CiAgICB9CiAgICBpZiAoY29uc3RyYWludHMudmlkZW8pIHsKICAgICAgY29uc3RyYWludHMudmlkZW8gPSBjb25zdHJhaW50c1RvQ2hyb21lKGNvbnN0cmFpbnRzLnZpZGVvKTsKICAgIH0KICAgIHdlYnJ0Y1V0aWxzLmxvZygnY2hyb21lOiAnICsgSlNPTi5zdHJpbmdpZnkoY29uc3RyYWludHMpKTsKICAgIHJldHVybiBuYXZpZ2F0b3Iud2Via2l0R2V0VXNlck1lZGlhKGNvbnN0cmFpbnRzLCBvblN1Y2Nlc3MsIG9uRXJyb3IpOwogIH07CiAgbmF2aWdhdG9yLmdldFVzZXJNZWRpYSA9IGdldFVzZXJNZWRpYTsKCiAgaWYgKCFuYXZpZ2F0b3IubWVkaWFEZXZpY2VzKSB7CiAgICBuYXZpZ2F0b3IubWVkaWFEZXZpY2VzID0geyBnZXRVc2VyTWVkaWE6IHJlcXVlc3RVc2VyTWVkaWEsCiAgICAgIGVudW1lcmF0ZURldmljZXM6IGZ1bmN0aW9uIGVudW1lcmF0ZURldmljZXMoKSB7CiAgICAgICAgcmV0dXJuIG5ldyBQcm9taXNlKGZ1bmN0aW9uIChyZXNvbHZlKSB7CiAgICAgICAgICB2YXIga2luZHMgPSB7IGF1ZGlvOiAnYXVkaW9pbnB1dCcsIHZpZGVvOiAndmlkZW9pbnB1dCcgfTsKICAgICAgICAgIHJldHVybiBNZWRpYVN0cmVhbVRyYWNrLmdldFNvdXJjZXMoZnVuY3Rpb24gKGRldmljZXMpIHsKICAgICAgICAgICAgcmVzb2x2ZShkZXZpY2VzLm1hcChmdW5jdGlvbiAoZGV2aWNlKSB7CiAgICAgICAgICAgICAgcmV0dXJuIHsgbGFiZWw6IGRldmljZS5sYWJlbCwKICAgICAgICAgICAgICAgIGtpbmQ6IGtpbmRzW2RldmljZS5raW5kXSwKICAgICAgICAgICAgICAgIGRldmljZUlkOiBkZXZpY2UuaWQsCiAgICAgICAgICAgICAgICBncm91cElkOiAnJyB9OwogICAgICAgICAgICB9KSk7CiAgICAgICAgICB9KTsKICAgICAgICB9KTsKICAgICAgfSB9OwogIH0KCiAgLy8gQSBzaGltIGZvciBnZXRVc2VyTWVkaWEgbWV0aG9kIG9uIHRoZSBtZWRpYURldmljZXMgb2JqZWN0LgogIC8vIFRPRE8oS2FwdGVuSmFuc3NvbikgcmVtb3ZlIG9uY2UgaW1wbGVtZW50ZWQgaW4gQ2hyb21lIHN0YWJsZS4KICBpZiAoIW5hdmlnYXRvci5tZWRpYURldmljZXMuZ2V0VXNlck1lZGlhKSB7CiAgICBuYXZpZ2F0b3IubWVkaWFEZXZpY2VzLmdldFVzZXJNZWRpYSA9IGZ1bmN0aW9uIChjb25zdHJhaW50cykgewogICAgICByZXR1cm4gcmVxdWVzdFVzZXJNZWRpYShjb25zdHJhaW50cyk7CiAgICB9OwogIH0gZWxzZSB7CiAgICAvLyBFdmVuIHRob3VnaCBDaHJvbWUgNDUgaGFzIG5hdmlnYXRvci5tZWRpYURldmljZXMgYW5kIGEgZ2V0VXNlck1lZGlhCiAgICAvLyBmdW5jdGlvbiB3aGljaCByZXR1cm5zIGEgUHJvbWlzZSwgaXQgZG9lcyBub3QgYWNjZXB0IHNwZWMtc3R5bGUKICAgIC8vIGNvbnN0cmFpbnRzLgogICAgdmFyIG9yaWdHZXRVc2VyTWVkaWEgPSBuYXZpZ2F0b3IubWVkaWFEZXZpY2VzLmdldFVzZXJNZWRpYS5iaW5kKG5hdmlnYXRvci5tZWRpYURldmljZXMpOwogICAgbmF2aWdhdG9yLm1lZGlhRGV2aWNlcy5nZXRVc2VyTWVkaWEgPSBmdW5jdGlvbiAoYykgewogICAgICB3ZWJydGNVdGlscy5sb2coJ3NwZWM6ICAgJyArIEpTT04uc3RyaW5naWZ5KGMpKTsgLy8gd2hpdGVzcGFjZSBmb3IgYWxpZ25tZW50CiAgICAgIGMuYXVkaW8gPSBjb25zdHJhaW50c1RvQ2hyb21lKGMuYXVkaW8pOwogICAgICBjLnZpZGVvID0gY29uc3RyYWludHNUb0Nocm9tZShjLnZpZGVvKTsKICAgICAgd2VicnRjVXRpbHMubG9nKCdjaHJvbWU6ICcgKyBKU09OLnN0cmluZ2lmeShjKSk7CiAgICAgIHJldHVybiBvcmlnR2V0VXNlck1lZGlhKGMpOwogICAgfTsKICB9CgogIC8vIER1bW15IGRldmljZWNoYW5nZSBldmVudCBtZXRob2RzLgogIC8vIFRPRE8oS2FwdGVuSmFuc3NvbikgcmVtb3ZlIG9uY2UgaW1wbGVtZW50ZWQgaW4gQ2hyb21lIHN0YWJsZS4KICBpZiAodHlwZW9mIG5hdmlnYXRvci5tZWRpYURldmljZXMuYWRkRXZlbnRMaXN0ZW5lciA9PT0gJ3VuZGVmaW5lZCcpIHsKICAgIG5hdmlnYXRvci5tZWRpYURldmljZXMuYWRkRXZlbnRMaXN0ZW5lciA9IGZ1bmN0aW9uICgpIHsKICAgICAgd2VicnRjVXRpbHMubG9nKCdEdW1teSBtZWRpYURldmljZXMuYWRkRXZlbnRMaXN0ZW5lciBjYWxsZWQuJyk7CiAgICB9OwogIH0KICBpZiAodHlwZW9mIG5hdmlnYXRvci5tZWRpYURldmljZXMucmVtb3ZlRXZlbnRMaXN0ZW5lciA9PT0gJ3VuZGVmaW5lZCcpIHsKICAgIG5hdmlnYXRvci5tZWRpYURldmljZXMucmVtb3ZlRXZlbnRMaXN0ZW5lciA9IGZ1bmN0aW9uICgpIHsKICAgICAgd2VicnRjVXRpbHMubG9nKCdEdW1teSBtZWRpYURldmljZXMucmVtb3ZlRXZlbnRMaXN0ZW5lciBjYWxsZWQuJyk7CiAgICB9OwogIH0KCiAgLy8gQXR0YWNoIGEgbWVkaWEgc3RyZWFtIHRvIGFuIGVsZW1lbnQuCiAgYXR0YWNoTWVkaWFTdHJlYW0gPSBmdW5jdGlvbiAoZWxlbWVudCwgc3RyZWFtKSB7CiAgICBpZiAod2VicnRjRGV0ZWN0ZWRWZXJzaW9uID49IDQzKSB7CiAgICAgIGVsZW1lbnQuc3JjT2JqZWN0ID0gc3RyZWFtOwogICAgfSBlbHNlIGlmICh0eXBlb2YgZWxlbWVudC5zcmMgIT09ICd1bmRlZmluZWQnKSB7CiAgICAgIGVsZW1lbnQuc3JjID0gVVJMLmNyZWF0ZU9iamVjdFVSTChzdHJlYW0pOwogICAgfSBlbHNlIHsKICAgICAgd2VicnRjVXRpbHMubG9nKCdFcnJvciBhdHRhY2hpbmcgc3RyZWFtIHRvIGVsZW1lbnQuJyk7CiAgICB9CiAgfTsKICByZWF0dGFjaE1lZGlhU3RyZWFtID0gZnVuY3Rpb24gKHRvLCBmcm9tKSB7CiAgICBpZiAod2VicnRjRGV0ZWN0ZWRWZXJzaW9uID49IDQzKSB7CiAgICAgIHRvLnNyY09iamVjdCA9IGZyb20uc3JjT2JqZWN0OwogICAgfSBlbHNlIHsKICAgICAgdG8uc3JjID0gZnJvbS5zcmM7CiAgICB9CiAgfTsKfSBlbHNlIGlmIChuYXZpZ2F0b3IubWVkaWFEZXZpY2VzICYmIG5hdmlnYXRvci51c2VyQWdlbnQubWF0Y2goL0VkZ2VcLyhcZCspLihcZCspJC8pKSB7CiAgd2VicnRjVXRpbHMubG9nKCdUaGlzIGFwcGVhcnMgdG8gYmUgRWRnZScpOwogIHdlYnJ0Y0RldGVjdGVkQnJvd3NlciA9ICdlZGdlJzsKCiAgd2VicnRjRGV0ZWN0ZWRWZXJzaW9uID0gd2VicnRjVXRpbHMuZXh0cmFjdFZlcnNpb24obmF2aWdhdG9yLnVzZXJBZ2VudCwgL0VkZ2VcLyhcZCspLihcZCspJC8sIDIpOwoKICAvLyBUaGUgbWluaW11bSB2ZXJzaW9uIHN0aWxsIHN1cHBvcnRlZCBieSBhZGFwdGVyLgogIC8vIFRoaXMgaXMgdGhlIGJ1aWxkIG51bWJlciBmb3IgRWRnZS4KICB3ZWJydGNNaW5pbXVtVmVyc2lvbiA9IDEwNTQ3OwoKICBpZiAod2luZG93LlJUQ0ljZUdhdGhlcmVyKSB7CiAgICAvLyBHZW5lcmF0ZSBhbiBhbHBoYW51bWVyaWMgaWRlbnRpZmllciBmb3IgY25hbWUgb3IgbWlkcy4KICAgIC8vIFRPRE86IHVzZSBVVUlEcyBpbnN0ZWFkPyBodHRwczovL2dpc3QuZ2l0aHViLmNvbS9qZWQvOTgyODgzCiAgICB2YXIgZ2VuZXJhdGVJZGVudGlmaWVyID0gZnVuY3Rpb24gZ2VuZXJhdGVJZGVudGlmaWVyKCkgewogICAgICByZXR1cm4gTWF0aC5yYW5kb20oKS50b1N0cmluZygzNikuc3Vic3RyKDIsIDEwKTsKICAgIH07CgogICAgLy8gVGhlIFJUQ1AgQ05BTUUgdXNlZCBieSBhbGwgcGVlcmNvbm5lY3Rpb25zIGZyb20gdGhlIHNhbWUgSlMuCiAgICB2YXIgbG9jYWxDTmFtZSA9IGdlbmVyYXRlSWRlbnRpZmllcigpOwoKICAgIC8vIFNEUCBoZWxwZXJzIC0gdG8gYmUgbW92ZWQgaW50byBzZXBhcmF0ZSBtb2R1bGUuCiAgICB2YXIgU0RQVXRpbHMgPSB7fTsKCiAgICAvLyBTcGxpdHMgU0RQIGludG8gbGluZXMsIGRlYWxpbmcgd2l0aCBib3RoIENSTEYgYW5kIExGLgogICAgU0RQVXRpbHMuc3BsaXRMaW5lcyA9IGZ1bmN0aW9uIChibG9iKSB7CiAgICAgIHJldHVybiBibG9iLnRyaW0oKS5zcGxpdCgnXG4nKS5tYXAoZnVuY3Rpb24gKGxpbmUpIHsKICAgICAgICByZXR1cm4gbGluZS50cmltKCk7CiAgICAgIH0pOwogICAgfTsKCiAgICAvLyBTcGxpdHMgU0RQIGludG8gc2Vzc2lvbnBhcnQgYW5kIG1lZGlhc2VjdGlvbnMuIEVuc3VyZXMgQ1JMRi4KICAgIFNEUFV0aWxzLnNwbGl0U2VjdGlvbnMgPSBmdW5jdGlvbiAoYmxvYikgewogICAgICB2YXIgcGFydHMgPSBibG9iLnNwbGl0KCdcclxubT0nKTsKICAgICAgcmV0dXJuIHBhcnRzLm1hcChmdW5jdGlvbiAocGFydCwgaW5kZXgpIHsKICAgICAgICByZXR1cm4gKGluZGV4ID4gMCA/ICdtPScgKyBwYXJ0IDogcGFydCkudHJpbSgpICsgJ1xyXG4nOwogICAgICB9KTsKICAgIH07CgogICAgLy8gUmV0dXJucyBsaW5lcyB0aGF0IHN0YXJ0IHdpdGggYSBjZXJ0YWluIHByZWZpeC4KICAgIFNEUFV0aWxzLm1hdGNoUHJlZml4ID0gZnVuY3Rpb24gKGJsb2IsIHByZWZpeCkgewogICAgICByZXR1cm4gU0RQVXRpbHMuc3BsaXRMaW5lcyhibG9iKS5maWx0ZXIoZnVuY3Rpb24gKGxpbmUpIHsKICAgICAgICByZXR1cm4gbGluZS5pbmRleE9mKHByZWZpeCkgPT09IDA7CiAgICAgIH0pOwogICAgfTsKCiAgICAvLyBQYXJzZXMgYW4gSUNFIGNhbmRpZGF0ZSBsaW5lLiBTYW1wbGUgaW5wdXQ6CiAgICAvLyBjYW5kaWRhdGU6NzAyNzg2MzUwIDIgdWRwIDQxODE5OTAyIDguOC44LjggNjA3NjkgdHlwIHJlbGF5IHJhZGRyIDguOC44LjggcnBvcnQgNTU5OTYiCiAgICBTRFBVdGlscy5wYXJzZUNhbmRpZGF0ZSA9IGZ1bmN0aW9uIChsaW5lKSB7CiAgICAgIHZhciBwYXJ0czsKICAgICAgLy8gUGFyc2UgYm90aCB2YXJpYW50cy4KICAgICAgaWYgKGxpbmUuaW5kZXhPZignYT1jYW5kaWRhdGU6JykgPT09IDApIHsKICAgICAgICBwYXJ0cyA9IGxpbmUuc3Vic3RyaW5nKDEyKS5zcGxpdCgnICcpOwogICAgICB9IGVsc2UgewogICAgICAgIHBhcnRzID0gbGluZS5zdWJzdHJpbmcoMTApLnNwbGl0KCcgJyk7CiAgICAgIH0KCiAgICAgIHZhciBjYW5kaWRhdGUgPSB7CiAgICAgICAgZm91bmRhdGlvbjogcGFydHNbMF0sCiAgICAgICAgY29tcG9uZW50OiBwYXJ0c1sxXSwKICAgICAgICBwcm90b2NvbDogcGFydHNbMl0udG9Mb3dlckNhc2UoKSwKICAgICAgICBwcmlvcml0eTogcGFyc2VJbnQocGFydHNbM10sIDEwKSwKICAgICAgICBpcDogcGFydHNbNF0sCiAgICAgICAgcG9ydDogcGFyc2VJbnQocGFydHNbNV0sIDEwKSwKICAgICAgICAvLyBza2lwIHBhcnRzWzZdID09ICd0eXAnCiAgICAgICAgdHlwZTogcGFydHNbN10KICAgICAgfTsKCiAgICAgIGZvciAodmFyIGkgPSA4OyBpIDwgcGFydHMubGVuZ3RoOyBpICs9IDIpIHsKICAgICAgICBzd2l0Y2ggKHBhcnRzW2ldKSB7CiAgICAgICAgICBjYXNlICdyYWRkcic6CiAgICAgICAgICAgIGNhbmRpZGF0ZS5yZWxhdGVkQWRkcmVzcyA9IHBhcnRzW2kgKyAxXTsKICAgICAgICAgICAgYnJlYWs7CiAgICAgICAgICBjYXNlICdycG9ydCc6CiAgICAgICAgICAgIGNhbmRpZGF0ZS5yZWxhdGVkUG9ydCA9IHBhcnNlSW50KHBhcnRzW2kgKyAxXSwgMTApOwogICAgICAgICAgICBicmVhazsKICAgICAgICAgIGNhc2UgJ3RjcHR5cGUnOgogICAgICAgICAgICBjYW5kaWRhdGUudGNwVHlwZSA9IHBhcnRzW2kgKyAxXTsKICAgICAgICAgICAgYnJlYWs7CiAgICAgICAgICBkZWZhdWx0OgogICAgICAgICAgICAvLyBVbmtub3duIGV4dGVuc2lvbnMgYXJlIHNpbGVudGx5IGlnbm9yZWQuCiAgICAgICAgICAgIGJyZWFrOwogICAgICAgIH0KICAgICAgfQogICAgICByZXR1cm4gY2FuZGlkYXRlOwogICAgfTsKCiAgICAvLyBUcmFuc2xhdGVzIGEgY2FuZGlkYXRlIG9iamVjdCBpbnRvIFNEUCBjYW5kaWRhdGUgYXR0cmlidXRlLgogICAgU0RQVXRpbHMud3JpdGVDYW5kaWRhdGUgPSBmdW5jdGlvbiAoY2FuZGlkYXRlKSB7CiAgICAgIHZhciBzZHAgPSBbXTsKICAgICAgc2RwLnB1c2goY2FuZGlkYXRlLmZvdW5kYXRpb24pOwogICAgICBzZHAucHVzaChjYW5kaWRhdGUuY29tcG9uZW50KTsKICAgICAgc2RwLnB1c2goY2FuZGlkYXRlLnByb3RvY29sLnRvVXBwZXJDYXNlKCkpOwogICAgICBzZHAucHVzaChjYW5kaWRhdGUucHJpb3JpdHkpOwogICAgICBzZHAucHVzaChjYW5kaWRhdGUuaXApOwogICAgICBzZHAucHVzaChjYW5kaWRhdGUucG9ydCk7CgogICAgICB2YXIgdHlwZSA9IGNhbmRpZGF0ZS50eXBlOwogICAgICBzZHAucHVzaCgndHlwJyk7CiAgICAgIHNkcC5wdXNoKHR5cGUpOwogICAgICBpZiAodHlwZSAhPT0gJ2hvc3QnICYmIGNhbmRpZGF0ZS5yZWxhdGVkQWRkcmVzcyAmJiBjYW5kaWRhdGUucmVsYXRlZFBvcnQpIHsKICAgICAgICBzZHAucHVzaCgncmFkZHInKTsKICAgICAgICBzZHAucHVzaChjYW5kaWRhdGUucmVsYXRlZEFkZHJlc3MpOyAvLyB3YXM6IHJlbEFkZHIKICAgICAgICBzZHAucHVzaCgncnBvcnQnKTsKICAgICAgICBzZHAucHVzaChjYW5kaWRhdGUucmVsYXRlZFBvcnQpOyAvLyB3YXM6IHJlbFBvcnQKICAgICAgfQogICAgICBpZiAoY2FuZGlkYXRlLnRjcFR5cGUgJiYgY2FuZGlkYXRlLnByb3RvY29sLnRvTG93ZXJDYXNlKCkgPT09ICd0Y3AnKSB7CiAgICAgICAgc2RwLnB1c2goJ3RjcHR5cGUnKTsKICAgICAgICBzZHAucHVzaChjYW5kaWRhdGUudGNwVHlwZSk7CiAgICAgIH0KICAgICAgcmV0dXJuICdjYW5kaWRhdGU6JyArIHNkcC5qb2luKCcgJyk7CiAgICB9OwoKICAgIC8vIFBhcnNlcyBhbiBydHBtYXAgbGluZSwgcmV0dXJucyBSVENSdHBDb2RkZWNQYXJhbWV0ZXJzLiBTYW1wbGUgaW5wdXQ6CiAgICAvLyBhPXJ0cG1hcDoxMTEgb3B1cy80ODAwMC8yCiAgICBTRFBVdGlscy5wYXJzZVJ0cE1hcCA9IGZ1bmN0aW9uIChsaW5lKSB7CiAgICAgIHZhciBwYXJ0cyA9IGxpbmUuc3Vic3RyKDkpLnNwbGl0KCcgJyk7CiAgICAgIHZhciBwYXJzZWQgPSB7CiAgICAgICAgcGF5bG9hZFR5cGU6IHBhcnNlSW50KHBhcnRzLnNoaWZ0KCksIDEwKSAvLyB3YXM6IGlkCiAgICAgIH07CgogICAgICBwYXJ0cyA9IHBhcnRzWzBdLnNwbGl0KCcvJyk7CgogICAgICBwYXJzZWQubmFtZSA9IHBhcnRzWzBdOwogICAgICBwYXJzZWQuY2xvY2tSYXRlID0gcGFyc2VJbnQocGFydHNbMV0sIDEwKTsgLy8gd2FzOiBjbG9ja3JhdGUKICAgICAgcGFyc2VkLm51bUNoYW5uZWxzID0gcGFydHMubGVuZ3RoID09PSAzID8gcGFyc2VJbnQocGFydHNbMl0sIDEwKSA6IDE7IC8vIHdhczogY2hhbm5lbHMKICAgICAgcmV0dXJuIHBhcnNlZDsKICAgIH07CgogICAgLy8gR2VuZXJhdGUgYW4gYT1ydHBtYXAgbGluZSBmcm9tIFJUQ1J0cENvZGVjQ2FwYWJpbGl0eSBvciBSVENSdHBDb2RlY1BhcmFtZXRlcnMuCiAgICBTRFBVdGlscy53cml0ZVJ0cE1hcCA9IGZ1bmN0aW9uIChjb2RlYykgewogICAgICB2YXIgcHQgPSBjb2RlYy5wYXlsb2FkVHlwZTsKICAgICAgaWYgKGNvZGVjLnByZWZlcnJlZFBheWxvYWRUeXBlICE9PSB1bmRlZmluZWQpIHsKICAgICAgICBwdCA9IGNvZGVjLnByZWZlcnJlZFBheWxvYWRUeXBlOwogICAgICB9CiAgICAgIHJldHVybiAnYT1ydHBtYXA6JyArIHB0ICsgJyAnICsgY29kZWMubmFtZSArICcvJyArIGNvZGVjLmNsb2NrUmF0ZSArIChjb2RlYy5udW1DaGFubmVscyAhPT0gMSA/ICcvJyArIGNvZGVjLm51bUNoYW5uZWxzIDogJycpICsgJ1xyXG4nOwogICAgfTsKCiAgICAvLyBQYXJzZXMgYW4gZnRtcCBsaW5lLCByZXR1cm5zIGRpY3Rpb25hcnkuIFNhbXBsZSBpbnB1dDoKICAgIC8vIGE9Zm10cDo5NiB2YnI9b247Y25nPW9uCiAgICAvLyBBbHNvIGRlYWxzIHdpdGggdmJyPW9uOyBjbmc9b24KICAgIFNEUFV0aWxzLnBhcnNlRm10cCA9IGZ1bmN0aW9uIChsaW5lKSB7CiAgICAgIHZhciBwYXJzZWQgPSB7fTsKICAgICAgdmFyIGt2OwogICAgICB2YXIgcGFydHMgPSBsaW5lLnN1YnN0cihsaW5lLmluZGV4T2YoJyAnKSArIDEpLnNwbGl0KCc7Jyk7CiAgICAgIGZvciAodmFyIGogPSAwOyBqIDwgcGFydHMubGVuZ3RoOyBqKyspIHsKICAgICAgICBrdiA9IHBhcnRzW2pdLnRyaW0oKS5zcGxpdCgnPScpOwogICAgICAgIHBhcnNlZFtrdlswXS50cmltKCldID0ga3ZbMV07CiAgICAgIH0KICAgICAgcmV0dXJuIHBhcnNlZDsKICAgIH07CgogICAgLy8gR2VuZXJhdGVzIGFuIGE9ZnRtcCBsaW5lIGZyb20gUlRDUnRwQ29kZWNDYXBhYmlsaXR5IG9yIFJUQ1J0cENvZGVjUGFyYW1ldGVycy4KICAgIFNEUFV0aWxzLndyaXRlRnRtcCA9IGZ1bmN0aW9uIChjb2RlYykgewogICAgICB2YXIgbGluZSA9ICcnOwogICAgICB2YXIgcHQgPSBjb2RlYy5wYXlsb2FkVHlwZTsKICAgICAgaWYgKGNvZGVjLnByZWZlcnJlZFBheWxvYWRUeXBlICE9PSB1bmRlZmluZWQpIHsKICAgICAgICBwdCA9IGNvZGVjLnByZWZlcnJlZFBheWxvYWRUeXBlOwogICAgICB9CiAgICAgIGlmIChjb2RlYy5wYXJhbWV0ZXJzICYmIGNvZGVjLnBhcmFtZXRlcnMubGVuZ3RoKSB7CiAgICAgICAgdmFyIHBhcmFtcyA9IFtdOwogICAgICAgIE9iamVjdC5rZXlzKGNvZGVjLnBhcmFtZXRlcnMpLmZvckVhY2goZnVuY3Rpb24gKHBhcmFtKSB7CiAgICAgICAgICBwYXJhbXMucHVzaChwYXJhbSArICc9JyArIGNvZGVjLnBhcmFtZXRlcnNbcGFyYW1dKTsKICAgICAgICB9KTsKICAgICAgICBsaW5lICs9ICdhPWZtdHA6JyArIHB0ICsgJyAnICsgcGFyYW1zLmpvaW4oJzsnKSArICdcclxuJzsKICAgICAgfQogICAgICByZXR1cm4gbGluZTsKICAgIH07CgogICAgLy8gUGFyc2VzIGFuIHJ0Y3AtZmIgbGluZSwgcmV0dXJucyBSVENQUnRjcEZlZWRiYWNrIG9iamVjdC4gU2FtcGxlIGlucHV0OgogICAgLy8gYT1ydGNwLWZiOjk4IG5hY2sgcnBzaQogICAgU0RQVXRpbHMucGFyc2VSdGNwRmIgPSBmdW5jdGlvbiAobGluZSkgewogICAgICB2YXIgcGFydHMgPSBsaW5lLnN1YnN0cihsaW5lLmluZGV4T2YoJyAnKSArIDEpLnNwbGl0KCcgJyk7CiAgICAgIHJldHVybiB7CiAgICAgICAgdHlwZTogcGFydHMuc2hpZnQoKSwKICAgICAgICBwYXJhbWV0ZXI6IHBhcnRzLmpvaW4oJyAnKQogICAgICB9OwogICAgfTsKICAgIC8vIEdlbmVyYXRlIGE9cnRjcC1mYiBsaW5lcyBmcm9tIFJUQ1J0cENvZGVjQ2FwYWJpbGl0eSBvciBSVENSdHBDb2RlY1BhcmFtZXRlcnMuCiAgICBTRFBVdGlscy53cml0ZVJ0Y3BGYiA9IGZ1bmN0aW9uIChjb2RlYykgewogICAgICB2YXIgbGluZXMgPSAnJzsKICAgICAgdmFyIHB0ID0gY29kZWMucGF5bG9hZFR5cGU7CiAgICAgIGlmIChjb2RlYy5wcmVmZXJyZWRQYXlsb2FkVHlwZSAhPT0gdW5kZWZpbmVkKSB7CiAgICAgICAgcHQgPSBjb2RlYy5wcmVmZXJyZWRQYXlsb2FkVHlwZTsKICAgICAgfQogICAgICBpZiAoY29kZWMucnRjcEZlZWRiYWNrICYmIGNvZGVjLnJ0Y3BGZWVkYmFjay5sZW5ndGgpIHsKICAgICAgICAvLyBGSVhNRTogc3BlY2lhbCBoYW5kbGluZyBmb3IgdHJyLWludD8KICAgICAgICBjb2RlYy5ydGNwRmVlZGJhY2suZm9yRWFjaChmdW5jdGlvbiAoZmIpIHsKICAgICAgICAgIGxpbmVzICs9ICdhPXJ0Y3AtZmI6JyArIHB0ICsgJyAnICsgZmIudHlwZSArICcgJyArIGZiLnBhcmFtZXRlciArICdcclxuJzsKICAgICAgICB9KTsKICAgICAgfQogICAgICByZXR1cm4gbGluZXM7CiAgICB9OwoKICAgIC8vIFBhcnNlcyBhbiBSRkMgNTU3NiBzc3JjIG1lZGlhIGF0dHJpYnV0ZS4gU2FtcGxlIGlucHV0OgogICAgLy8gYT1zc3JjOjM3MzU5Mjg1NTkgY25hbWU6c29tZXRoaW5nCiAgICBTRFBVdGlscy5wYXJzZVNzcmNNZWRpYSA9IGZ1bmN0aW9uIChsaW5lKSB7CiAgICAgIHZhciBzcCA9IGxpbmUuaW5kZXhPZignICcpOwogICAgICB2YXIgcGFydHMgPSB7CiAgICAgICAgc3NyYzogbGluZS5zdWJzdHIoNywgc3AgLSA3KQogICAgICB9OwogICAgICB2YXIgY29sb24gPSBsaW5lLmluZGV4T2YoJzonLCBzcCk7CiAgICAgIGlmIChjb2xvbiA+IC0xKSB7CiAgICAgICAgcGFydHMuYXR0cmlidXRlID0gbGluZS5zdWJzdHIoc3AgKyAxLCBjb2xvbiAtIHNwIC0gMSk7CiAgICAgICAgcGFydHMudmFsdWUgPSBsaW5lLnN1YnN0cihjb2xvbiArIDEpOwogICAgICB9IGVsc2UgewogICAgICAgIHBhcnRzLmF0dHJpYnV0ZSA9IGxpbmUuc3Vic3RyKHNwICsgMSk7CiAgICAgIH0KICAgICAgcmV0dXJuIHBhcnRzOwogICAgfTsKCiAgICAvLyBFeHRyYWN0cyBEVExTIHBhcmFtZXRlcnMgZnJvbSBTRFAgbWVkaWEgc2VjdGlvbiBvciBzZXNzaW9ucGFydC4KICAgIC8vIEZJWE1FOiBmb3IgY29uc2lzdGVuY3kgd2l0aCBvdGhlciBmdW5jdGlvbnMgdGhpcyBzaG91bGQgb25seQogICAgLy8gICBnZXQgdGhlIGZpbmdlcnByaW50IGxpbmUgYXMgaW5wdXQuIFNlZSBhbHNvIGdldEljZVBhcmFtZXRlcnMuCiAgICBTRFBVdGlscy5nZXREdGxzUGFyYW1ldGVycyA9IGZ1bmN0aW9uIChtZWRpYVNlY3Rpb24sIHNlc3Npb25wYXJ0KSB7CiAgICAgIHZhciBsaW5lcyA9IFNEUFV0aWxzLnNwbGl0TGluZXMobWVkaWFTZWN0aW9uKTsKICAgICAgbGluZXMgPSBsaW5lcy5jb25jYXQoU0RQVXRpbHMuc3BsaXRMaW5lcyhzZXNzaW9ucGFydCkpOyAvLyBTZWFyY2ggaW4gc2Vzc2lvbiBwYXJ0LCB0b28uCiAgICAgIHZhciBmcExpbmUgPSBsaW5lcy5maWx0ZXIoZnVuY3Rpb24gKGxpbmUpIHsKICAgICAgICByZXR1cm4gbGluZS5pbmRleE9mKCdhPWZpbmdlcnByaW50OicpID09PSAwOwogICAgICB9KVswXS5zdWJzdHIoMTQpOwogICAgICAvLyBOb3RlOiBhPXNldHVwIGxpbmUgaXMgaWdub3JlZCBzaW5jZSB3ZSB1c2UgdGhlICdhdXRvJyByb2xlLgogICAgICB2YXIgZHRsc1BhcmFtZXRlcnMgPSB7CiAgICAgICAgcm9sZTogJ2F1dG8nLAogICAgICAgIGZpbmdlcnByaW50czogW3sKICAgICAgICAgIGFsZ29yaXRobTogZnBMaW5lLnNwbGl0KCcgJylbMF0sCiAgICAgICAgICB2YWx1ZTogZnBMaW5lLnNwbGl0KCcgJylbMV0KICAgICAgICB9XQogICAgICB9OwogICAgICByZXR1cm4gZHRsc1BhcmFtZXRlcnM7CiAgICB9OwoKICAgIC8vIFNlcmlhbGl6ZXMgRFRMUyBwYXJhbWV0ZXJzIHRvIFNEUC4KICAgIFNEUFV0aWxzLndyaXRlRHRsc1BhcmFtZXRlcnMgPSBmdW5jdGlvbiAocGFyYW1zLCBzZXR1cFR5cGUpIHsKICAgICAgdmFyIHNkcCA9ICdhPXNldHVwOicgKyBzZXR1cFR5cGUgKyAnXHJcbic7CiAgICAgIHBhcmFtcy5maW5nZXJwcmludHMuZm9yRWFjaChmdW5jdGlvbiAoZnApIHsKICAgICAgICBzZHAgKz0gJ2E9ZmluZ2VycHJpbnQ6JyArIGZwLmFsZ29yaXRobSArICcgJyArIGZwLnZhbHVlICsgJ1xyXG4nOwogICAgICB9KTsKICAgICAgcmV0dXJuIHNkcDsKICAgIH07CiAgICAvLyBQYXJzZXMgSUNFIGluZm9ybWF0aW9uIGZyb20gU0RQIG1lZGlhIHNlY3Rpb24gb3Igc2Vzc2lvbnBhcnQuCiAgICAvLyBGSVhNRTogZm9yIGNvbnNpc3RlbmN5IHdpdGggb3RoZXIgZnVuY3Rpb25zIHRoaXMgc2hvdWxkIG9ubHkKICAgIC8vICAgZ2V0IHRoZSBpY2UtdWZyYWcgYW5kIGljZS1wd2QgbGluZXMgYXMgaW5wdXQuCiAgICBTRFBVdGlscy5nZXRJY2VQYXJhbWV0ZXJzID0gZnVuY3Rpb24gKG1lZGlhU2VjdGlvbiwgc2Vzc2lvbnBhcnQpIHsKICAgICAgdmFyIGxpbmVzID0gU0RQVXRpbHMuc3BsaXRMaW5lcyhtZWRpYVNlY3Rpb24pOwogICAgICBsaW5lcyA9IGxpbmVzLmNvbmNhdChTRFBVdGlscy5zcGxpdExpbmVzKHNlc3Npb25wYXJ0KSk7IC8vIFNlYXJjaCBpbiBzZXNzaW9uIHBhcnQsIHRvby4KICAgICAgdmFyIGljZVBhcmFtZXRlcnMgPSB7CiAgICAgICAgdXNlcm5hbWVGcmFnbWVudDogbGluZXMuZmlsdGVyKGZ1bmN0aW9uIChsaW5lKSB7CiAgICAgICAgICByZXR1cm4gbGluZS5pbmRleE9mKCdhPWljZS11ZnJhZzonKSA9PT0gMDsKICAgICAgICB9KVswXS5zdWJzdHIoMTIpLAogICAgICAgIHBhc3N3b3JkOiBsaW5lcy5maWx0ZXIoZnVuY3Rpb24gKGxpbmUpIHsKICAgICAgICAgIHJldHVybiBsaW5lLmluZGV4T2YoJ2E9aWNlLXB3ZDonKSA9PT0gMDsKICAgICAgICB9KVswXS5zdWJzdHIoMTApCiAgICAgIH07CiAgICAgIHJldHVybiBpY2VQYXJhbWV0ZXJzOwogICAgfTsKCiAgICAvLyBTZXJpYWxpemVzIElDRSBwYXJhbWV0ZXJzIHRvIFNEUC4KICAgIFNEUFV0aWxzLndyaXRlSWNlUGFyYW1ldGVycyA9IGZ1bmN0aW9uIChwYXJhbXMpIHsKICAgICAgcmV0dXJuICdhPWljZS11ZnJhZzonICsgcGFyYW1zLnVzZXJuYW1lRnJhZ21lbnQgKyAnXHJcbicgKyAnYT1pY2UtcHdkOicgKyBwYXJhbXMucGFzc3dvcmQgKyAnXHJcbic7CiAgICB9OwoKICAgIC8vIFBhcnNlcyB0aGUgU0RQIG1lZGlhIHNlY3Rpb24gYW5kIHJldHVybnMgUlRDUnRwUGFyYW1ldGVycy4KICAgIFNEUFV0aWxzLnBhcnNlUnRwUGFyYW1ldGVycyA9IGZ1bmN0aW9uIChtZWRpYVNlY3Rpb24pIHsKICAgICAgdmFyIGRlc2NyaXB0aW9uID0gewogICAgICAgIGNvZGVjczogW10sCiAgICAgICAgaGVhZGVyRXh0ZW5zaW9uczogW10sCiAgICAgICAgZmVjTWVjaGFuaXNtczogW10sCiAgICAgICAgcnRjcDogW10KICAgICAgfTsKICAgICAgdmFyIGxpbmVzID0gU0RQVXRpbHMuc3BsaXRMaW5lcyhtZWRpYVNlY3Rpb24pOwogICAgICB2YXIgbWxpbmUgPSBsaW5lc1swXS5zcGxpdCgnICcpOwogICAgICBmb3IgKHZhciBpID0gMzsgaSA8IG1saW5lLmxlbmd0aDsgaSsrKSB7CiAgICAgICAgLy8gZmluZCBhbGwgY29kZWNzIGZyb20gbWxpbmVbMy4uXQogICAgICAgIHZhciBwdCA9IG1saW5lW2ldOwogICAgICAgIHZhciBydHBtYXBsaW5lID0gU0RQVXRpbHMubWF0Y2hQcmVmaXgobWVkaWFTZWN0aW9uLCAnYT1ydHBtYXA6JyArIHB0ICsgJyAnKVswXTsKICAgICAgICBpZiAocnRwbWFwbGluZSkgewogICAgICAgICAgdmFyIGNvZGVjID0gU0RQVXRpbHMucGFyc2VSdHBNYXAocnRwbWFwbGluZSk7CiAgICAgICAgICB2YXIgZm10cHMgPSBTRFBVdGlscy5tYXRjaFByZWZpeChtZWRpYVNlY3Rpb24sICdhPWZtdHA6JyArIHB0ICsgJyAnKTsKICAgICAgICAgIC8vIE9ubHkgdGhlIGZpcnN0IGE9Zm10cDo8cHQ+IGlzIGNvbnNpZGVyZWQuCiAgICAgICAgICBjb2RlYy5wYXJhbWV0ZXJzID0gZm10cHMubGVuZ3RoID8gU0RQVXRpbHMucGFyc2VGbXRwKGZtdHBzWzBdKSA6IHt9OwogICAgICAgICAgY29kZWMucnRjcEZlZWRiYWNrID0gU0RQVXRpbHMubWF0Y2hQcmVmaXgobWVkaWFTZWN0aW9uLCAnYT1ydGNwLWZiOicgKyBwdCArICcgJykubWFwKFNEUFV0aWxzLnBhcnNlUnRjcEZiKTsKICAgICAgICAgIGRlc2NyaXB0aW9uLmNvZGVjcy5wdXNoKGNvZGVjKTsKICAgICAgICB9CiAgICAgIH0KICAgICAgLy8gRklYTUU6IHBhcnNlIGhlYWRlckV4dGVuc2lvbnMsIGZlY01lY2hhbmlzbXMgYW5kIHJ0Y3AuCiAgICAgIHJldHVybiBkZXNjcmlwdGlvbjsKICAgIH07CgogICAgLy8gR2VuZXJhdGVzIHBhcnRzIG9mIHRoZSBTRFAgbWVkaWEgc2VjdGlvbiBkZXNjcmliaW5nIHRoZSBjYXBhYmlsaXRpZXMgLyBwYXJhbWV0ZXJzLgogICAgU0RQVXRpbHMud3JpdGVSdHBEZXNjcmlwdGlvbiA9IGZ1bmN0aW9uIChraW5kLCBjYXBzKSB7CiAgICAgIHZhciBzZHAgPSAnJzsKCiAgICAgIC8vIEJ1aWxkIHRoZSBtbGluZS4KICAgICAgc2RwICs9ICdtPScgKyBraW5kICsgJyAnOwogICAgICBzZHAgKz0gY2Fwcy5jb2RlY3MubGVuZ3RoID4gMCA/ICc5JyA6ICcwJzsgLy8gcmVqZWN0IGlmIG5vIGNvZGVjcy4KICAgICAgc2RwICs9ICcgVURQL1RMUy9SVFAvU0FWUEYgJzsKICAgICAgc2RwICs9IGNhcHMuY29kZWNzLm1hcChmdW5jdGlvbiAoY29kZWMpIHsKICAgICAgICBpZiAoY29kZWMucHJlZmVycmVkUGF5bG9hZFR5cGUgIT09IHVuZGVmaW5lZCkgewogICAgICAgICAgcmV0dXJuIGNvZGVjLnByZWZlcnJlZFBheWxvYWRUeXBlOwogICAgICAgIH0KICAgICAgICByZXR1cm4gY29kZWMucGF5bG9hZFR5cGU7CiAgICAgIH0pLmpvaW4oJyAnKSArICdcclxuJzsKCiAgICAgIHNkcCArPSAnYz1JTiBJUDQgMC4wLjAuMFxyXG4nOwogICAgICBzZHAgKz0gJ2E9cnRjcDo5IElOIElQNCAwLjAuMC4wXHJcbic7CgogICAgICAvLyBBZGQgYT1ydHBtYXAgbGluZXMgZm9yIGVhY2ggY29kZWMuIEFsc28gZm10cCBhbmQgcnRjcC1mYi4KICAgICAgY2Fwcy5jb2RlY3MuZm9yRWFjaChmdW5jdGlvbiAoY29kZWMpIHsKICAgICAgICBzZHAgKz0gU0RQVXRpbHMud3JpdGVSdHBNYXAoY29kZWMpOwogICAgICAgIHNkcCArPSBTRFBVdGlscy53cml0ZUZ0bXAoY29kZWMpOwogICAgICAgIHNkcCArPSBTRFBVdGlscy53cml0ZVJ0Y3BGYihjb2RlYyk7CiAgICAgIH0pOwogICAgICAvLyBGSVhNRTogYWRkIGhlYWRlckV4dGVuc2lvbnMsIGZlY01lY2hhbmlzbcWfIGFuZCBydGNwLgogICAgICBzZHAgKz0gJ2E9cnRjcC1tdXhcclxuJzsKICAgICAgcmV0dXJuIHNkcDsKICAgIH07CgogICAgU0RQVXRpbHMud3JpdGVTZXNzaW9uQm9pbGVycGxhdGUgPSBmdW5jdGlvbiAoKSB7CiAgICAgIC8vIEZJWE1FOiBzZXNzLWlkIHNob3VsZCBiZSBhbiBOVFAgdGltZXN0YW1wLgogICAgICByZXR1cm4gJ3Y9MFxyXG4nICsgJ289dGhpc2lzYWRhcHRlcm9ydGMgODE2OTYzOTkxNTY0Njk0MzEzNyAyIElOIElQNCAxMjcuMC4wLjFcclxuJyArICdzPS1cclxuJyArICd0PTAgMFxyXG4nOwogICAgfTsKCiAgICBTRFBVdGlscy53cml0ZU1lZGlhU2VjdGlvbiA9IGZ1bmN0aW9uICh0cmFuc2NlaXZlciwgY2FwcywgdHlwZSwgc3RyZWFtKSB7CiAgICAgIHZhciBzZHAgPSBTRFBVdGlscy53cml0ZVJ0cERlc2NyaXB0aW9uKHRyYW5zY2VpdmVyLmtpbmQsIGNhcHMpOwoKICAgICAgLy8gTWFwIElDRSBwYXJhbWV0ZXJzICh1ZnJhZywgcHdkKSB0byBTRFAuCiAgICAgIHNkcCArPSBTRFBVdGlscy53cml0ZUljZVBhcmFtZXRlcnModHJhbnNjZWl2ZXIuaWNlR2F0aGVyZXIuZ2V0TG9jYWxQYXJhbWV0ZXJzKCkpOwoKICAgICAgLy8gTWFwIERUTFMgcGFyYW1ldGVycyB0byBTRFAuCiAgICAgIHNkcCArPSBTRFBVdGlscy53cml0ZUR0bHNQYXJhbWV0ZXJzKHRyYW5zY2VpdmVyLmR0bHNUcmFuc3BvcnQuZ2V0TG9jYWxQYXJhbWV0ZXJzKCksIHR5cGUgPT09ICdvZmZlcicgPyAnYWN0cGFzcycgOiAnYWN0aXZlJyk7CgogICAgICBzZHAgKz0gJ2E9bWlkOicgKyB0cmFuc2NlaXZlci5taWQgKyAnXHJcbic7CgogICAgICBpZiAodHJhbnNjZWl2ZXIucnRwU2VuZGVyICYmIHRyYW5zY2VpdmVyLnJ0cFJlY2VpdmVyKSB7CiAgICAgICAgc2RwICs9ICdhPXNlbmRyZWN2XHJcbic7CiAgICAgIH0gZWxzZSBpZiAodHJhbnNjZWl2ZXIucnRwU2VuZGVyKSB7CiAgICAgICAgc2RwICs9ICdhPXNlbmRvbmx5XHJcbic7CiAgICAgIH0gZWxzZSBpZiAodHJhbnNjZWl2ZXIucnRwUmVjZWl2ZXIpIHsKICAgICAgICBzZHAgKz0gJ2E9cmVjdm9ubHlcclxuJzsKICAgICAgfSBlbHNlIHsKICAgICAgICBzZHAgKz0gJ2E9aW5hY3RpdmVcclxuJzsKICAgICAgfQoKICAgICAgLy8gRklYTUU6IGZvciBSVFggdGhlcmUgbWlnaHQgYmUgbXVsdGlwbGUgU1NSQ3MuIE5vdCBpbXBsZW1lbnRlZCBpbiBFZGdlIHlldC4KICAgICAgaWYgKHRyYW5zY2VpdmVyLnJ0cFNlbmRlcikgewogICAgICAgIHZhciBtc2lkID0gJ21zaWQ6JyArIHN0cmVhbS5pZCArICcgJyArIHRyYW5zY2VpdmVyLnJ0cFNlbmRlci50cmFjay5pZCArICdcclxuJzsKICAgICAgICBzZHAgKz0gJ2E9JyArIG1zaWQ7CiAgICAgICAgc2RwICs9ICdhPXNzcmM6JyArIHRyYW5zY2VpdmVyLnNlbmRTc3JjICsgJyAnICsgbXNpZDsKICAgICAgfQogICAgICAvLyBGSVhNRTogdGhpcyBzaG91bGQgYmUgd3JpdHRlbiBieSB3cml0ZVJ0cERlc2NyaXB0aW9uLgogICAgICBzZHAgKz0gJ2E9c3NyYzonICsgdHJhbnNjZWl2ZXIuc2VuZFNzcmMgKyAnIGNuYW1lOicgKyBsb2NhbENOYW1lICsgJ1xyXG4nOwogICAgICByZXR1cm4gc2RwOwogICAgfTsKCiAgICAvLyBHZXRzIHRoZSBkaXJlY3Rpb24gZnJvbSB0aGUgbWVkaWFTZWN0aW9uIG9yIHRoZSBzZXNzaW9ucGFydC4KICAgIFNEUFV0aWxzLmdldERpcmVjdGlvbiA9IGZ1bmN0aW9uIChtZWRpYVNlY3Rpb24sIHNlc3Npb25wYXJ0KSB7CiAgICAgIC8vIExvb2sgZm9yIHNlbmRyZWN2LCBzZW5kb25seSwgcmVjdm9ubHksIGluYWN0aXZlLCBkZWZhdWx0IHRvIHNlbmRyZWN2LgogICAgICB2YXIgbGluZXMgPSBTRFBVdGlscy5zcGxpdExpbmVzKG1lZGlhU2VjdGlvbik7CiAgICAgIGZvciAodmFyIGkgPSAwOyBpIDwgbGluZXMubGVuZ3RoOyBpKyspIHsKICAgICAgICBzd2l0Y2ggKGxpbmVzW2ldKSB7CiAgICAgICAgICBjYXNlICdhPXNlbmRyZWN2JzoKICAgICAgICAgIGNhc2UgJ2E9c2VuZG9ubHknOgogICAgICAgICAgY2FzZSAnYT1yZWN2b25seSc6CiAgICAgICAgICBjYXNlICdhPWluYWN0aXZlJzoKICAgICAgICAgICAgcmV0dXJuIGxpbmVzW2ldLnN1YnN0cigyKTsKICAgICAgICB9CiAgICAgIH0KICAgICAgaWYgKHNlc3Npb25wYXJ0KSB7CiAgICAgICAgcmV0dXJuIFNEUFV0aWxzLmdldERpcmVjdGlvbihzZXNzaW9ucGFydCk7CiAgICAgIH0KICAgICAgcmV0dXJuICdzZW5kcmVjdic7CiAgICB9OwoKICAgIC8vIE9SVEMgZGVmaW5lcyBhbiBSVENJY2VDYW5kaWRhdGUgb2JqZWN0IGJ1dCBubyBjb25zdHJ1Y3Rvci4KICAgIC8vIE5vdCBpbXBsZW1lbnRlZCBpbiBFZGdlLgogICAgaWYgKCF3aW5kb3cuUlRDSWNlQ2FuZGlkYXRlKSB7CiAgICAgIHdpbmRvdy5SVENJY2VDYW5kaWRhdGUgPSBmdW5jdGlvbiAoYXJncykgewogICAgICAgIHJldHVybiBhcmdzOwogICAgICB9OwogICAgfQogICAgLy8gT1JUQyBkb2VzIG5vdCBoYXZlIGEgc2Vzc2lvbiBkZXNjcmlwdGlvbiBvYmplY3QgYnV0CiAgICAvLyBvdGhlciBicm93c2VycyAoaS5lLiBDaHJvbWUpIHRoYXQgd2lsbCBzdXBwb3J0IGJvdGggUEMgYW5kIE9SVEMKICAgIC8vIGluIHRoZSBmdXR1cmUgbWlnaHQgaGF2ZSB0aGlzIGRlZmluZWQgYWxyZWFkeS4KICAgIGlmICghd2luZG93LlJUQ1Nlc3Npb25EZXNjcmlwdGlvbikgewogICAgICB3aW5kb3cuUlRDU2Vzc2lvbkRlc2NyaXB0aW9uID0gZnVuY3Rpb24gKGFyZ3MpIHsKICAgICAgICByZXR1cm4gYXJnczsKICAgICAgfTsKICAgIH0KCiAgICB3aW5kb3cuUlRDUGVlckNvbm5lY3Rpb24gPSBmdW5jdGlvbiAoY29uZmlnKSB7CiAgICAgIHZhciBzZWxmID0gdGhpczsKCiAgICAgIHRoaXMub25pY2VjYW5kaWRhdGUgPSBudWxsOwogICAgICB0aGlzLm9uYWRkc3RyZWFtID0gbnVsbDsKICAgICAgdGhpcy5vbnJlbW92ZXN0cmVhbSA9IG51bGw7CiAgICAgIHRoaXMub25zaWduYWxpbmdzdGF0ZWNoYW5nZSA9IG51bGw7CiAgICAgIHRoaXMub25pY2Vjb25uZWN0aW9uc3RhdGVjaGFuZ2UgPSBudWxsOwogICAgICB0aGlzLm9ubmVnb3RpYXRpb25uZWVkZWQgPSBudWxsOwogICAgICB0aGlzLm9uZGF0YWNoYW5uZWwgPSBudWxsOwoKICAgICAgdGhpcy5sb2NhbFN0cmVhbXMgPSBbXTsKICAgICAgdGhpcy5yZW1vdGVTdHJlYW1zID0gW107CiAgICAgIHRoaXMuZ2V0TG9jYWxTdHJlYW1zID0gZnVuY3Rpb24gKCkgewogICAgICAgIHJldHVybiBzZWxmLmxvY2FsU3RyZWFtczsKICAgICAgfTsKICAgICAgdGhpcy5nZXRSZW1vdGVTdHJlYW1zID0gZnVuY3Rpb24gKCkgewogICAgICAgIHJldHVybiBzZWxmLnJlbW90ZVN0cmVhbXM7CiAgICAgIH07CgogICAgICB0aGlzLmxvY2FsRGVzY3JpcHRpb24gPSBuZXcgUlRDU2Vzc2lvbkRlc2NyaXB0aW9uKHsKICAgICAgICB0eXBlOiAnJywKICAgICAgICBzZHA6ICcnCiAgICAgIH0pOwogICAgICB0aGlzLnJlbW90ZURlc2NyaXB0aW9uID0gbmV3IFJUQ1Nlc3Npb25EZXNjcmlwdGlvbih7CiAgICAgICAgdHlwZTogJycsCiAgICAgICAgc2RwOiAnJwogICAgICB9KTsKICAgICAgdGhpcy5zaWduYWxpbmdTdGF0ZSA9ICdzdGFibGUnOwogICAgICB0aGlzLmljZUNvbm5lY3Rpb25TdGF0ZSA9ICduZXcnOwoKICAgICAgdGhpcy5pY2VPcHRpb25zID0gewogICAgICAgIGdhdGhlclBvbGljeTogJ2FsbCcsCiAgICAgICAgaWNlU2VydmVyczogW10KICAgICAgfTsKICAgICAgaWYgKGNvbmZpZyAmJiBjb25maWcuaWNlVHJhbnNwb3J0UG9saWN5KSB7CiAgICAgICAgc3dpdGNoIChjb25maWcuaWNlVHJhbnNwb3J0UG9saWN5KSB7CiAgICAgICAgICBjYXNlICdhbGwnOgogICAgICAgICAgY2FzZSAncmVsYXknOgogICAgICAgICAgICB0aGlzLmljZU9wdGlvbnMuZ2F0aGVyUG9saWN5ID0gY29uZmlnLmljZVRyYW5zcG9ydFBvbGljeTsKICAgICAgICAgICAgYnJlYWs7CiAgICAgICAgICBjYXNlICdub25lJzoKICAgICAgICAgICAgLy8gRklYTUU6IHJlbW92ZSBvbmNlIGltcGxlbWVudGF0aW9uIGFuZCBzcGVjIGhhdmUgYWRkZWQgdGhpcy4KICAgICAgICAgICAgdGhyb3cgbmV3IFR5cGVFcnJvcignaWNlVHJhbnNwb3J0UG9saWN5ICJub25lIiBub3Qgc3VwcG9ydGVkJyk7CiAgICAgICAgfQogICAgICB9CiAgICAgIGlmIChjb25maWcgJiYgY29uZmlnLmljZVNlcnZlcnMpIHsKICAgICAgICAvLyBFZGdlIGRvZXMgbm90IGxpa2UKICAgICAgICAvLyAxKSBzdHVuOgogICAgICAgIC8vIDIpIHR1cm46IHRoYXQgZG9lcyBub3QgaGF2ZSBhbGwgb2YgdHVybjpob3N0OnBvcnQ/dHJhbnNwb3J0PXVkcAogICAgICAgIC8vIDMpIGFuIGFycmF5IG9mIHVybHMKICAgICAgICBjb25maWcuaWNlU2VydmVycy5mb3JFYWNoKGZ1bmN0aW9uIChzZXJ2ZXIpIHsKICAgICAgICAgIGlmIChzZXJ2ZXIudXJscykgewogICAgICAgICAgICB2YXIgdXJsOwogICAgICAgICAgICBpZiAodHlwZW9mIHNlcnZlci51cmxzID09PSAnc3RyaW5nJykgewogICAgICAgICAgICAgIHVybCA9IHNlcnZlci51cmxzOwogICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgIHVybCA9IHNlcnZlci51cmxzWzBdOwogICAgICAgICAgICB9CiAgICAgICAgICAgIGlmICh1cmwuaW5kZXhPZigndHJhbnNwb3J0PXVkcCcpICE9PSAtMSkgewogICAgICAgICAgICAgIHNlbGYuaWNlU2VydmVycy5wdXNoKHsKICAgICAgICAgICAgICAgIHVzZXJuYW1lOiBzZXJ2ZXIudXNlcm5hbWUsCiAgICAgICAgICAgICAgICBjcmVkZW50aWFsOiBzZXJ2ZXIuY3JlZGVudGlhbCwKICAgICAgICAgICAgICAgIHVybHM6IHVybAogICAgICAgICAgICAgIH0pOwogICAgICAgICAgICB9CiAgICAgICAgICB9CiAgICAgICAgfSk7CiAgICAgIH0KCiAgICAgIC8vIHBlci10cmFjayBpY2VHYXRoZXJzLCBpY2VUcmFuc3BvcnRzLCBkdGxzVHJhbnNwb3J0cywgcnRwU2VuZGVycywgLi4uCiAgICAgIC8vIGV2ZXJ5dGhpbmcgdGhhdCBpcyBuZWVkZWQgdG8gZGVzY3JpYmUgYSBTRFAgbS1saW5lLgogICAgICB0aGlzLnRyYW5zY2VpdmVycyA9IFtdOwoKICAgICAgLy8gc2luY2UgdGhlIGljZUdhdGhlcmVyIGlzIGN1cnJlbnRseSBjcmVhdGVkIGluIGNyZWF0ZU9mZmVyIGJ1dCB3ZQogICAgICAvLyBtdXN0IG5vdCBlbWl0IGNhbmRpZGF0ZXMgdW50aWwgYWZ0ZXIgc2V0TG9jYWxEZXNjcmlwdGlvbiB3ZSBidWZmZXIKICAgICAgLy8gdGhlbSBpbiB0aGlzIGFycmF5LgogICAgICB0aGlzLl9sb2NhbEljZUNhbmRpZGF0ZXNCdWZmZXIgPSBbXTsKICAgIH07CgogICAgd2luZG93LlJUQ1BlZXJDb25uZWN0aW9uLnByb3RvdHlwZS5fZW1pdEJ1ZmZlcmVkQ2FuZGlkYXRlcyA9IGZ1bmN0aW9uICgpIHsKICAgICAgdmFyIHNlbGYgPSB0aGlzOwogICAgICAvLyBGSVhNRTogbmVlZCB0byBhcHBseSBpY2UgY2FuZGlkYXRlcyBpbiBhIHdheSB3aGljaCBpcyBhc3luYyBidXQgaW4tb3JkZXIKICAgICAgdGhpcy5fbG9jYWxJY2VDYW5kaWRhdGVzQnVmZmVyLmZvckVhY2goZnVuY3Rpb24gKGV2ZW50KSB7CiAgICAgICAgaWYgKHNlbGYub25pY2VjYW5kaWRhdGUgIT09IG51bGwpIHsKICAgICAgICAgIHNlbGYub25pY2VjYW5kaWRhdGUoZXZlbnQpOwogICAgICAgIH0KICAgICAgfSk7CiAgICAgIHRoaXMuX2xvY2FsSWNlQ2FuZGlkYXRlc0J1ZmZlciA9IFtdOwogICAgfTsKCiAgICB3aW5kb3cuUlRDUGVlckNvbm5lY3Rpb24ucHJvdG90eXBlLmFkZFN0cmVhbSA9IGZ1bmN0aW9uIChzdHJlYW0pIHsKICAgICAgLy8gQ2xvbmUgaXMgbmVjZXNzYXJ5IGZvciBsb2NhbCBkZW1vcyBtb3N0bHksIGF0dGFjaGluZyBkaXJlY3RseQogICAgICAvLyB0byB0d28gZGlmZmVyZW50IHNlbmRlcnMgZG9lcyBub3Qgd29yayAoYnVpbGQgMTA1NDcpLgogICAgICB0aGlzLmxvY2FsU3RyZWFtcy5wdXNoKHN0cmVhbS5jbG9uZSgpKTsKICAgICAgdGhpcy5fbWF5YmVGaXJlTmVnb3RpYXRpb25OZWVkZWQoKTsKICAgIH07CgogICAgd2luZG93LlJUQ1BlZXJDb25uZWN0aW9uLnByb3RvdHlwZS5yZW1vdmVTdHJlYW0gPSBmdW5jdGlvbiAoc3RyZWFtKSB7CiAgICAgIHZhciBpZHggPSB0aGlzLmxvY2FsU3RyZWFtcy5pbmRleE9mKHN0cmVhbSk7CiAgICAgIGlmIChpZHggPiAtMSkgewogICAgICAgIHRoaXMubG9jYWxTdHJlYW1zLnNwbGljZShpZHgsIDEpOwogICAgICAgIHRoaXMuX21heWJlRmlyZU5lZ290aWF0aW9uTmVlZGVkKCk7CiAgICAgIH0KICAgIH07CgogICAgLy8gRGV0ZXJtaW5lcyB0aGUgaW50ZXJzZWN0aW9uIG9mIGxvY2FsIGFuZCByZW1vdGUgY2FwYWJpbGl0aWVzLgogICAgd2luZG93LlJUQ1BlZXJDb25uZWN0aW9uLnByb3RvdHlwZS5fZ2V0Q29tbW9uQ2FwYWJpbGl0aWVzID0gZnVuY3Rpb24gKGxvY2FsQ2FwYWJpbGl0aWVzLCByZW1vdGVDYXBhYmlsaXRpZXMpIHsKICAgICAgdmFyIGNvbW1vbkNhcGFiaWxpdGllcyA9IHsKICAgICAgICBjb2RlY3M6IFtdLAogICAgICAgIGhlYWRlckV4dGVuc2lvbnM6IFtdLAogICAgICAgIGZlY01lY2hhbmlzbXM6IFtdCiAgICAgIH07CiAgICAgIGxvY2FsQ2FwYWJpbGl0aWVzLmNvZGVjcy5mb3JFYWNoKGZ1bmN0aW9uIChsQ29kZWMpIHsKICAgICAgICBmb3IgKHZhciBpID0gMDsgaSA8IHJlbW90ZUNhcGFiaWxpdGllcy5jb2RlY3MubGVuZ3RoOyBpKyspIHsKICAgICAgICAgIHZhciByQ29kZWMgPSByZW1vdGVDYXBhYmlsaXRpZXMuY29kZWNzW2ldOwogICAgICAgICAgaWYgKGxDb2RlYy5uYW1lLnRvTG93ZXJDYXNlKCkgPT09IHJDb2RlYy5uYW1lLnRvTG93ZXJDYXNlKCkgJiYgbENvZGVjLmNsb2NrUmF0ZSA9PT0gckNvZGVjLmNsb2NrUmF0ZSAmJiBsQ29kZWMubnVtQ2hhbm5lbHMgPT09IHJDb2RlYy5udW1DaGFubmVscykgewogICAgICAgICAgICAvLyBwdXNoIHJDb2RlYyBzbyB3ZSByZXBseSB3aXRoIG9mZmVyZXIgcGF5bG9hZCB0eXBlCiAgICAgICAgICAgIGNvbW1vbkNhcGFiaWxpdGllcy5jb2RlY3MucHVzaChyQ29kZWMpOwoKICAgICAgICAgICAgLy8gRklYTUU6IGFsc28gbmVlZCB0byBkZXRlcm1pbmUgaW50ZXJzZWN0aW9uIGJldHdlZW4KICAgICAgICAgICAgLy8gLnJ0Y3BGZWVkYmFjayBhbmQgLnBhcmFtZXRlcnMKICAgICAgICAgICAgYnJlYWs7CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICB9KTsKCiAgICAgIGxvY2FsQ2FwYWJpbGl0aWVzLmhlYWRlckV4dGVuc2lvbnMuZm9yRWFjaChmdW5jdGlvbiAobEhlYWRlckV4dGVuc2lvbikgewogICAgICAgIGZvciAodmFyIGkgPSAwOyBpIDwgcmVtb3RlQ2FwYWJpbGl0aWVzLmhlYWRlckV4dGVuc2lvbnMubGVuZ3RoOyBpKyspIHsKICAgICAgICAgIHZhciBySGVhZGVyRXh0ZW5zaW9uID0gcmVtb3RlQ2FwYWJpbGl0aWVzLmhlYWRlckV4dGVuc2lvbnNbaV07CiAgICAgICAgICBpZiAobEhlYWRlckV4dGVuc2lvbi51cmkgPT09IHJIZWFkZXJFeHRlbnNpb24udXJpKSB7CiAgICAgICAgICAgIGNvbW1vbkNhcGFiaWxpdGllcy5oZWFkZXJFeHRlbnNpb25zLnB1c2gockhlYWRlckV4dGVuc2lvbik7CiAgICAgICAgICAgIGJyZWFrOwogICAgICAgICAgfQogICAgICAgIH0KICAgICAgfSk7CgogICAgICAvLyBGSVhNRTogZmVjTWVjaGFuaXNtcwogICAgICByZXR1cm4gY29tbW9uQ2FwYWJpbGl0aWVzOwogICAgfTsKCiAgICAvLyBDcmVhdGUgSUNFIGdhdGhlcmVyLCBJQ0UgdHJhbnNwb3J0IGFuZCBEVExTIHRyYW5zcG9ydC4KICAgIHdpbmRvdy5SVENQZWVyQ29ubmVjdGlvbi5wcm90b3R5cGUuX2NyZWF0ZUljZUFuZER0bHNUcmFuc3BvcnRzID0gZnVuY3Rpb24gKG1pZCwgc2RwTUxpbmVJbmRleCkgewogICAgICB2YXIgc2VsZiA9IHRoaXM7CiAgICAgIHZhciBpY2VHYXRoZXJlciA9IG5ldyBSVENJY2VHYXRoZXJlcihzZWxmLmljZU9wdGlvbnMpOwogICAgICB2YXIgaWNlVHJhbnNwb3J0ID0gbmV3IFJUQ0ljZVRyYW5zcG9ydChpY2VHYXRoZXJlcik7CiAgICAgIGljZUdhdGhlcmVyLm9ubG9jYWxjYW5kaWRhdGUgPSBmdW5jdGlvbiAoZXZ0KSB7CiAgICAgICAgdmFyIGV2ZW50ID0ge307CiAgICAgICAgZXZlbnQuY2FuZGlkYXRlID0geyBzZHBNaWQ6IG1pZCwgc2RwTUxpbmVJbmRleDogc2RwTUxpbmVJbmRleCB9OwoKICAgICAgICB2YXIgY2FuZCA9IGV2dC5jYW5kaWRhdGU7CiAgICAgICAgLy8gRWRnZSBlbWl0cyBhbiBlbXB0eSBvYmplY3QgZm9yIFJUQ0ljZUNhbmRpZGF0ZUNvbXBsZXRl4oClCiAgICAgICAgaWYgKCFjYW5kIHx8IE9iamVjdC5rZXlzKGNhbmQpLmxlbmd0aCA9PT0gMCkgewogICAgICAgICAgLy8gcG9seWZpbGwgc2luY2UgUlRDSWNlR2F0aGVyZXIuc3RhdGUgaXMgbm90IGltcGxlbWVudGVkIGluIEVkZ2UgMTA1NDcgeWV0LgogICAgICAgICAgaWYgKGljZUdhdGhlcmVyLnN0YXRlID09PSB1bmRlZmluZWQpIHsKICAgICAgICAgICAgaWNlR2F0aGVyZXIuc3RhdGUgPSAnY29tcGxldGVkJzsKICAgICAgICAgIH0KCiAgICAgICAgICAvLyBFbWl0IGEgY2FuZGlkYXRlIHdpdGggdHlwZSBlbmRPZkNhbmRpZGF0ZXMgdG8gbWFrZSB0aGUgc2FtcGxlcyB3b3JrLgogICAgICAgICAgLy8gRWRnZSByZXF1aXJlcyBhZGRJY2VDYW5kaWRhdGUgd2l0aCB0aGlzIGVtcHR5IGNhbmRpZGF0ZSB0byBzdGFydCBjaGVja2luZy4KICAgICAgICAgIC8vIFRoZSByZWFsIHNvbHV0aW9uIGlzIHRvIHNpZ25hbCBlbmQtb2YtY2FuZGlkYXRlcyB0byB0aGUgb3RoZXIgc2lkZSB3aGVuCiAgICAgICAgICAvLyBnZXR0aW5nIHRoZSBudWxsIGNhbmRpZGF0ZSBidXQgc29tZSBhcHBzIChsaWtlIHRoZSBzYW1wbGVzKSBkb24ndCBkbyB0aGF0LgogICAgICAgICAgZXZlbnQuY2FuZGlkYXRlLmNhbmRpZGF0ZSA9ICdjYW5kaWRhdGU6MSAxIHVkcCAxIDAuMC4wLjAgOSB0eXAgZW5kT2ZDYW5kaWRhdGVzJzsKICAgICAgICB9IGVsc2UgewogICAgICAgICAgLy8gUlRDSWNlQ2FuZGlkYXRlIGRvZXNuJ3QgaGF2ZSBhIGNvbXBvbmVudCwgbmVlZHMgdG8gYmUgYWRkZWQKICAgICAgICAgIGNhbmQuY29tcG9uZW50ID0gaWNlVHJhbnNwb3J0LmNvbXBvbmVudCA9PT0gJ1JUQ1AnID8gMiA6IDE7CiAgICAgICAgICBldmVudC5jYW5kaWRhdGUuY2FuZGlkYXRlID0gU0RQVXRpbHMud3JpdGVDYW5kaWRhdGUoY2FuZCk7CiAgICAgICAgfQoKICAgICAgICB2YXIgY29tcGxldGUgPSBzZWxmLnRyYW5zY2VpdmVycy5ldmVyeShmdW5jdGlvbiAodHJhbnNjZWl2ZXIpIHsKICAgICAgICAgIHJldHVybiB0cmFuc2NlaXZlci5pY2VHYXRoZXJlciAmJiB0cmFuc2NlaXZlci5pY2VHYXRoZXJlci5zdGF0ZSA9PT0gJ2NvbXBsZXRlZCc7CiAgICAgICAgfSk7CiAgICAgICAgLy8gRklYTUU6IHVwZGF0ZSAubG9jYWxEZXNjcmlwdGlvbiB3aXRoIGNhbmRpZGF0ZSBhbmQgKHBvdGVudGlhbGx5KSBlbmQtb2YtY2FuZGlkYXRlcy4KICAgICAgICAvLyAgICAgVG8gbWFrZSB0aGlzIGhhcmRlciwgdGhlIGdhdGhlcmVyIG1pZ2h0IGVtaXQgY2FuZGlkYXRlcyBiZWZvcmUgbG9jYWxkZXNjcmlwdGlvbgogICAgICAgIC8vICAgICBpcyBzZXQuIFRvIG1ha2UgdGhpbmdzIHdvcnNlLCBnYXRoZXIuZ2V0TG9jYWxDYW5kaWRhdGVzIHN0aWxsIGVycm9ycyBpbgogICAgICAgIC8vICAgICBFZGdlIDEwNTQ3IHdoZW4gbm8gY2FuZGlkYXRlcyBoYXZlIGJlZW4gZ2F0aGVyZWQgeWV0LgoKICAgICAgICBpZiAoc2VsZi5vbmljZWNhbmRpZGF0ZSAhPT0gbnVsbCkgewogICAgICAgICAgLy8gRW1pdCBjYW5kaWRhdGUgaWYgbG9jYWxEZXNjcmlwdGlvbiBpcyBzZXQuCiAgICAgICAgICAvLyBBbHNvIGVtaXRzIG51bGwgY2FuZGlkYXRlIHdoZW4gYWxsIGdhdGhlcmVycyBhcmUgY29tcGxldGUuCiAgICAgICAgICBpZiAoc2VsZi5sb2NhbERlc2NyaXB0aW9uICYmIHNlbGYubG9jYWxEZXNjcmlwdGlvbi50eXBlID09PSAnJykgewogICAgICAgICAgICBzZWxmLl9sb2NhbEljZUNhbmRpZGF0ZXNCdWZmZXIucHVzaChldmVudCk7CiAgICAgICAgICAgIGlmIChjb21wbGV0ZSkgewogICAgICAgICAgICAgIHNlbGYuX2xvY2FsSWNlQ2FuZGlkYXRlc0J1ZmZlci5wdXNoKHt9KTsKICAgICAgICAgICAgfQogICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgc2VsZi5vbmljZWNhbmRpZGF0ZShldmVudCk7CiAgICAgICAgICAgIGlmIChjb21wbGV0ZSkgewogICAgICAgICAgICAgIHNlbGYub25pY2VjYW5kaWRhdGUoe30pOwogICAgICAgICAgICB9CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICB9OwogICAgICBpY2VUcmFuc3BvcnQub25pY2VzdGF0ZWNoYW5nZSA9IGZ1bmN0aW9uICgpIHsKICAgICAgICBzZWxmLl91cGRhdGVDb25uZWN0aW9uU3RhdGUoKTsKICAgICAgfTsKCiAgICAgIHZhciBkdGxzVHJhbnNwb3J0ID0gbmV3IFJUQ0R0bHNUcmFuc3BvcnQoaWNlVHJhbnNwb3J0KTsKICAgICAgZHRsc1RyYW5zcG9ydC5vbmR0bHNzdGF0ZWNoYW5nZSA9IGZ1bmN0aW9uICgpIHsKICAgICAgICBzZWxmLl91cGRhdGVDb25uZWN0aW9uU3RhdGUoKTsKICAgICAgfTsKICAgICAgZHRsc1RyYW5zcG9ydC5vbmVycm9yID0gZnVuY3Rpb24gKCkgewogICAgICAgIC8vIG9uZXJyb3IgZG9lcyBub3Qgc2V0IHN0YXRlIHRvIGZhaWxlZCBieSBpdHNlbGYuCiAgICAgICAgZHRsc1RyYW5zcG9ydC5zdGF0ZSA9ICdmYWlsZWQnOwogICAgICAgIHNlbGYuX3VwZGF0ZUNvbm5lY3Rpb25TdGF0ZSgpOwogICAgICB9OwoKICAgICAgcmV0dXJuIHsKICAgICAgICBpY2VHYXRoZXJlcjogaWNlR2F0aGVyZXIsCiAgICAgICAgaWNlVHJhbnNwb3J0OiBpY2VUcmFuc3BvcnQsCiAgICAgICAgZHRsc1RyYW5zcG9ydDogZHRsc1RyYW5zcG9ydAogICAgICB9OwogICAgfTsKCiAgICAvLyBTdGFydCB0aGUgUlRQIFNlbmRlciBhbmQgUmVjZWl2ZXIgZm9yIGEgdHJhbnNjZWl2ZXIuCiAgICB3aW5kb3cuUlRDUGVlckNvbm5lY3Rpb24ucHJvdG90eXBlLl90cmFuc2NlaXZlID0gZnVuY3Rpb24gKHRyYW5zY2VpdmVyLCBzZW5kLCByZWN2KSB7CiAgICAgIHZhciBwYXJhbXMgPSB0aGlzLl9nZXRDb21tb25DYXBhYmlsaXRpZXModHJhbnNjZWl2ZXIubG9jYWxDYXBhYmlsaXRpZXMsIHRyYW5zY2VpdmVyLnJlbW90ZUNhcGFiaWxpdGllcyk7CiAgICAgIGlmIChzZW5kICYmIHRyYW5zY2VpdmVyLnJ0cFNlbmRlcikgewogICAgICAgIHBhcmFtcy5lbmNvZGluZ3MgPSBbewogICAgICAgICAgc3NyYzogdHJhbnNjZWl2ZXIuc2VuZFNzcmMKICAgICAgICB9XTsKICAgICAgICBwYXJhbXMucnRjcCA9IHsKICAgICAgICAgIGNuYW1lOiBsb2NhbENOYW1lLAogICAgICAgICAgc3NyYzogdHJhbnNjZWl2ZXIucmVjdlNzcmMKICAgICAgICB9OwogICAgICAgIHRyYW5zY2VpdmVyLnJ0cFNlbmRlci5zZW5kKHBhcmFtcyk7CiAgICAgIH0KICAgICAgaWYgKHJlY3YgJiYgdHJhbnNjZWl2ZXIucnRwUmVjZWl2ZXIpIHsKICAgICAgICBwYXJhbXMuZW5jb2RpbmdzID0gW3sKICAgICAgICAgIHNzcmM6IHRyYW5zY2VpdmVyLnJlY3ZTc3JjCiAgICAgICAgfV07CiAgICAgICAgcGFyYW1zLnJ0Y3AgPSB7CiAgICAgICAgICBjbmFtZTogdHJhbnNjZWl2ZXIuY25hbWUsCiAgICAgICAgICBzc3JjOiB0cmFuc2NlaXZlci5zZW5kU3NyYwogICAgICAgIH07CiAgICAgICAgdHJhbnNjZWl2ZXIucnRwUmVjZWl2ZXIucmVjZWl2ZShwYXJhbXMpOwogICAgICB9CiAgICB9OwoKICAgIHdpbmRvdy5SVENQZWVyQ29ubmVjdGlvbi5wcm90b3R5cGUuc2V0TG9jYWxEZXNjcmlwdGlvbiA9IGZ1bmN0aW9uIChkZXNjcmlwdGlvbikgewogICAgICB2YXIgc2VsZiA9IHRoaXM7CiAgICAgIGlmIChkZXNjcmlwdGlvbi50eXBlID09PSAnb2ZmZXInKSB7CiAgICAgICAgaWYgKCF0aGlzLl9wZW5kaW5nT2ZmZXIpIHt9IGVsc2UgewogICAgICAgICAgdGhpcy50cmFuc2NlaXZlcnMgPSB0aGlzLl9wZW5kaW5nT2ZmZXI7CiAgICAgICAgICBkZWxldGUgdGhpcy5fcGVuZGluZ09mZmVyOwogICAgICAgIH0KICAgICAgfSBlbHNlIGlmIChkZXNjcmlwdGlvbi50eXBlID09PSAnYW5zd2VyJykgewogICAgICAgIHZhciBzZWN0aW9ucyA9IFNEUFV0aWxzLnNwbGl0U2VjdGlvbnMoc2VsZi5yZW1vdGVEZXNjcmlwdGlvbi5zZHApOwogICAgICAgIHZhciBzZXNzaW9ucGFydCA9IHNlY3Rpb25zLnNoaWZ0KCk7CiAgICAgICAgc2VjdGlvbnMuZm9yRWFjaChmdW5jdGlvbiAobWVkaWFTZWN0aW9uLCBzZHBNTGluZUluZGV4KSB7CiAgICAgICAgICB2YXIgdHJhbnNjZWl2ZXIgPSBzZWxmLnRyYW5zY2VpdmVyc1tzZHBNTGluZUluZGV4XTsKICAgICAgICAgIHZhciBpY2VHYXRoZXJlciA9IHRyYW5zY2VpdmVyLmljZUdhdGhlcmVyOwogICAgICAgICAgdmFyIGljZVRyYW5zcG9ydCA9IHRyYW5zY2VpdmVyLmljZVRyYW5zcG9ydDsKICAgICAgICAgIHZhciBkdGxzVHJhbnNwb3J0ID0gdHJhbnNjZWl2ZXIuZHRsc1RyYW5zcG9ydDsKICAgICAgICAgIHZhciBsb2NhbENhcGFiaWxpdGllcyA9IHRyYW5zY2VpdmVyLmxvY2FsQ2FwYWJpbGl0aWVzOwogICAgICAgICAgdmFyIHJlbW90ZUNhcGFiaWxpdGllcyA9IHRyYW5zY2VpdmVyLnJlbW90ZUNhcGFiaWxpdGllczsKICAgICAgICAgIHZhciByZWplY3RlZCA9IG1lZGlhU2VjdGlvbi5zcGxpdCgnXG4nLCAxKVswXS5zcGxpdCgnICcsIDIpWzFdID09PSAnMCc7CgogICAgICAgICAgaWYgKCFyZWplY3RlZCkgewogICAgICAgICAgICB2YXIgcmVtb3RlSWNlUGFyYW1ldGVycyA9IFNEUFV0aWxzLmdldEljZVBhcmFtZXRlcnMobWVkaWFTZWN0aW9uLCBzZXNzaW9ucGFydCk7CiAgICAgICAgICAgIGljZVRyYW5zcG9ydC5zdGFydChpY2VHYXRoZXJlciwgcmVtb3RlSWNlUGFyYW1ldGVycywgJ2NvbnRyb2xsZWQnKTsKCiAgICAgICAgICAgIHZhciByZW1vdGVEdGxzUGFyYW1ldGVycyA9IFNEUFV0aWxzLmdldER0bHNQYXJhbWV0ZXJzKG1lZGlhU2VjdGlvbiwgc2Vzc2lvbnBhcnQpOwogICAgICAgICAgICBkdGxzVHJhbnNwb3J0LnN0YXJ0KHJlbW90ZUR0bHNQYXJhbWV0ZXJzKTsKCiAgICAgICAgICAgIC8vIENhbGN1bGF0ZSBpbnRlcnNlY3Rpb24gb2YgY2FwYWJpbGl0aWVzLgogICAgICAgICAgICB2YXIgcGFyYW1zID0gc2VsZi5fZ2V0Q29tbW9uQ2FwYWJpbGl0aWVzKGxvY2FsQ2FwYWJpbGl0aWVzLCByZW1vdGVDYXBhYmlsaXRpZXMpOwoKICAgICAgICAgICAgLy8gU3RhcnQgdGhlIFJUQ1J0cFNlbmRlci4gVGhlIFJUQ1J0cFJlY2VpdmVyIGZvciB0aGlzIHRyYW5zY2VpdmVyCiAgICAgICAgICAgIC8vIGhhcyBhbHJlYWR5IGJlZW4gc3RhcnRlZCBpbiBzZXRSZW1vdGVEZXNjcmlwdGlvbi4KICAgICAgICAgICAgc2VsZi5fdHJhbnNjZWl2ZSh0cmFuc2NlaXZlciwgcGFyYW1zLmNvZGVjcy5sZW5ndGggPiAwLCBmYWxzZSk7CiAgICAgICAgICB9CiAgICAgICAgfSk7CiAgICAgIH0KCiAgICAgIHRoaXMubG9jYWxEZXNjcmlwdGlvbiA9IGRlc2NyaXB0aW9uOwogICAgICBzd2l0Y2ggKGRlc2NyaXB0aW9uLnR5cGUpIHsKICAgICAgICBjYXNlICdvZmZlcic6CiAgICAgICAgICB0aGlzLl91cGRhdGVTaWduYWxpbmdTdGF0ZSgnaGF2ZS1sb2NhbC1vZmZlcicpOwogICAgICAgICAgYnJlYWs7CiAgICAgICAgY2FzZSAnYW5zd2VyJzoKICAgICAgICAgIHRoaXMuX3VwZGF0ZVNpZ25hbGluZ1N0YXRlKCdzdGFibGUnKTsKICAgICAgICAgIGJyZWFrOwogICAgICAgIGRlZmF1bHQ6CiAgICAgICAgICB0aHJvdyBuZXcgVHlwZUVycm9yKCd1bnN1cHBvcnRlZCB0eXBlICInICsgZGVzY3JpcHRpb24udHlwZSArICciJyk7CiAgICAgIH0KCiAgICAgIC8vIElmIGEgc3VjY2VzcyBjYWxsYmFjayB3YXMgcHJvdmlkZWQsIGVtaXQgSUNFIGNhbmRpZGF0ZXMgYWZ0ZXIgaXQgaGFzIGJlZW4KICAgICAgLy8gZXhlY3V0ZWQuIE90aGVyd2lzZSwgZW1pdCBjYWxsYmFjayBhZnRlciB0aGUgUHJvbWlzZSBpcyByZXNvbHZlZC4KICAgICAgdmFyIGhhc0NhbGxiYWNrID0gYXJndW1lbnRzLmxlbmd0aCA+IDEgJiYgdHlwZW9mIGFyZ3VtZW50c1sxXSA9PT0gJ2Z1bmN0aW9uJzsKICAgICAgaWYgKGhhc0NhbGxiYWNrKSB7CiAgICAgICAgdmFyIGNiID0gYXJndW1lbnRzWzFdOwogICAgICAgIHdpbmRvdy5zZXRUaW1lb3V0KGZ1bmN0aW9uICgpIHsKICAgICAgICAgIGNiKCk7CiAgICAgICAgICBzZWxmLl9lbWl0QnVmZmVyZWRDYW5kaWRhdGVzKCk7CiAgICAgICAgfSwgMCk7CiAgICAgIH0KICAgICAgdmFyIHAgPSBQcm9taXNlLnJlc29sdmUoKTsKICAgICAgcC50aGVuKGZ1bmN0aW9uICgpIHsKICAgICAgICBpZiAoIWhhc0NhbGxiYWNrKSB7CiAgICAgICAgICB3aW5kb3cuc2V0VGltZW91dChzZWxmLl9lbWl0QnVmZmVyZWRDYW5kaWRhdGVzLmJpbmQoc2VsZiksIDApOwogICAgICAgIH0KICAgICAgfSk7CiAgICAgIHJldHVybiBwOwogICAgfTsKCiAgICB3aW5kb3cuUlRDUGVlckNvbm5lY3Rpb24ucHJvdG90eXBlLnNldFJlbW90ZURlc2NyaXB0aW9uID0gZnVuY3Rpb24gKGRlc2NyaXB0aW9uKSB7CiAgICAgIHZhciBzZWxmID0gdGhpczsKICAgICAgdmFyIHN0cmVhbSA9IG5ldyBNZWRpYVN0cmVhbSgpOwogICAgICB2YXIgc2VjdGlvbnMgPSBTRFBVdGlscy5zcGxpdFNlY3Rpb25zKGRlc2NyaXB0aW9uLnNkcCk7CiAgICAgIHZhciBzZXNzaW9ucGFydCA9IHNlY3Rpb25zLnNoaWZ0KCk7CiAgICAgIHNlY3Rpb25zLmZvckVhY2goZnVuY3Rpb24gKG1lZGlhU2VjdGlvbiwgc2RwTUxpbmVJbmRleCkgewogICAgICAgIHZhciBsaW5lcyA9IFNEUFV0aWxzLnNwbGl0TGluZXMobWVkaWFTZWN0aW9uKTsKICAgICAgICB2YXIgbWxpbmUgPSBsaW5lc1swXS5zdWJzdHIoMikuc3BsaXQoJyAnKTsKICAgICAgICB2YXIga2luZCA9IG1saW5lWzBdOwogICAgICAgIHZhciByZWplY3RlZCA9IG1saW5lWzFdID09PSAnMCc7CiAgICAgICAgdmFyIGRpcmVjdGlvbiA9IFNEUFV0aWxzLmdldERpcmVjdGlvbihtZWRpYVNlY3Rpb24sIHNlc3Npb25wYXJ0KTsKCiAgICAgICAgdmFyIHRyYW5zY2VpdmVyOwogICAgICAgIHZhciBpY2VHYXRoZXJlcjsKICAgICAgICB2YXIgaWNlVHJhbnNwb3J0OwogICAgICAgIHZhciBkdGxzVHJhbnNwb3J0OwogICAgICAgIHZhciBydHBTZW5kZXI7CiAgICAgICAgdmFyIHJ0cFJlY2VpdmVyOwogICAgICAgIHZhciBzZW5kU3NyYzsKICAgICAgICB2YXIgcmVjdlNzcmM7CiAgICAgICAgdmFyIGxvY2FsQ2FwYWJpbGl0aWVzOwoKICAgICAgICAvLyBGSVhNRTogZW5zdXJlIHRoZSBtZWRpYVNlY3Rpb24gaGFzIHJ0Y3AtbXV4IHNldC4KICAgICAgICB2YXIgcmVtb3RlQ2FwYWJpbGl0aWVzID0gU0RQVXRpbHMucGFyc2VSdHBQYXJhbWV0ZXJzKG1lZGlhU2VjdGlvbik7CiAgICAgICAgdmFyIHJlbW90ZUljZVBhcmFtZXRlcnM7CiAgICAgICAgdmFyIHJlbW90ZUR0bHNQYXJhbWV0ZXJzOwogICAgICAgIGlmICghcmVqZWN0ZWQpIHsKICAgICAgICAgIHJlbW90ZUljZVBhcmFtZXRlcnMgPSBTRFBVdGlscy5nZXRJY2VQYXJhbWV0ZXJzKG1lZGlhU2VjdGlvbiwgc2Vzc2lvbnBhcnQpOwogICAgICAgICAgcmVtb3RlRHRsc1BhcmFtZXRlcnMgPSBTRFBVdGlscy5nZXREdGxzUGFyYW1ldGVycyhtZWRpYVNlY3Rpb24sIHNlc3Npb25wYXJ0KTsKICAgICAgICB9CiAgICAgICAgdmFyIG1pZCA9IFNEUFV0aWxzLm1hdGNoUHJlZml4KG1lZGlhU2VjdGlvbiwgJ2E9bWlkOicpWzBdLnN1YnN0cig2KTsKCiAgICAgICAgdmFyIGNuYW1lOwogICAgICAgIC8vIEdldHMgdGhlIGZpcnN0IFNTUkMuIE5vdGUgdGhhdCB3aXRoIFJUWCB0aGVyZSBtaWdodCBiZSBtdWx0aXBsZSBTU1JDcy4KICAgICAgICB2YXIgcmVtb3RlU3NyYyA9IFNEUFV0aWxzLm1hdGNoUHJlZml4KG1lZGlhU2VjdGlvbiwgJ2E9c3NyYzonKS5tYXAoZnVuY3Rpb24gKGxpbmUpIHsKICAgICAgICAgIHJldHVybiBTRFBVdGlscy5wYXJzZVNzcmNNZWRpYShsaW5lKTsKICAgICAgICB9KS5maWx0ZXIoZnVuY3Rpb24gKG9iaikgewogICAgICAgICAgcmV0dXJuIG9iai5hdHRyaWJ1dGUgPT09ICdjbmFtZSc7CiAgICAgICAgfSlbMF07CiAgICAgICAgaWYgKHJlbW90ZVNzcmMpIHsKICAgICAgICAgIHJlY3ZTc3JjID0gcGFyc2VJbnQocmVtb3RlU3NyYy5zc3JjLCAxMCk7CiAgICAgICAgICBjbmFtZSA9IHJlbW90ZVNzcmMudmFsdWU7CiAgICAgICAgfQoKICAgICAgICBpZiAoZGVzY3JpcHRpb24udHlwZSA9PT0gJ29mZmVyJykgewogICAgICAgICAgdmFyIHRyYW5zcG9ydHMgPSBzZWxmLl9jcmVhdGVJY2VBbmREdGxzVHJhbnNwb3J0cyhtaWQsIHNkcE1MaW5lSW5kZXgpOwoKICAgICAgICAgIGxvY2FsQ2FwYWJpbGl0aWVzID0gUlRDUnRwUmVjZWl2ZXIuZ2V0Q2FwYWJpbGl0aWVzKGtpbmQpOwogICAgICAgICAgc2VuZFNzcmMgPSAoMiAqIHNkcE1MaW5lSW5kZXggKyAyKSAqIDEwMDE7CgogICAgICAgICAgcnRwUmVjZWl2ZXIgPSBuZXcgUlRDUnRwUmVjZWl2ZXIodHJhbnNwb3J0cy5kdGxzVHJhbnNwb3J0LCBraW5kKTsKCiAgICAgICAgICAvLyBGSVhNRTogbm90IGNvcnJlY3Qgd2hlbiB0aGVyZSBhcmUgbXVsdGlwbGUgc3RyZWFtcyBidXQgdGhhdCBpcwogICAgICAgICAgLy8gbm90IGN1cnJlbnRseSBzdXBwb3J0ZWQgaW4gdGhpcyBzaGltLgogICAgICAgICAgc3RyZWFtLmFkZFRyYWNrKHJ0cFJlY2VpdmVyLnRyYWNrKTsKCiAgICAgICAgICAvLyBGSVhNRTogbG9vayBhdCBkaXJlY3Rpb24uCiAgICAgICAgICBpZiAoc2VsZi5sb2NhbFN0cmVhbXMubGVuZ3RoID4gMCAmJiBzZWxmLmxvY2FsU3RyZWFtc1swXS5nZXRUcmFja3MoKS5sZW5ndGggPj0gc2RwTUxpbmVJbmRleCkgewogICAgICAgICAgICAvLyBGSVhNRTogYWN0dWFsbHkgbW9yZSBjb21wbGljYXRlZCwgbmVlZHMgdG8gbWF0Y2ggdHlwZXMgZXRjCiAgICAgICAgICAgIHZhciBsb2NhbHRyYWNrID0gc2VsZi5sb2NhbFN0cmVhbXNbMF0uZ2V0VHJhY2tzKClbc2RwTUxpbmVJbmRleF07CiAgICAgICAgICAgIHJ0cFNlbmRlciA9IG5ldyBSVENSdHBTZW5kZXIobG9jYWx0cmFjaywgdHJhbnNwb3J0cy5kdGxzVHJhbnNwb3J0KTsKICAgICAgICAgIH0KCiAgICAgICAgICBzZWxmLnRyYW5zY2VpdmVyc1tzZHBNTGluZUluZGV4XSA9IHsKICAgICAgICAgICAgaWNlR2F0aGVyZXI6IHRyYW5zcG9ydHMuaWNlR2F0aGVyZXIsCiAgICAgICAgICAgIGljZVRyYW5zcG9ydDogdHJhbnNwb3J0cy5pY2VUcmFuc3BvcnQsCiAgICAgICAgICAgIGR0bHNUcmFuc3BvcnQ6IHRyYW5zcG9ydHMuZHRsc1RyYW5zcG9ydCwKICAgICAgICAgICAgbG9jYWxDYXBhYmlsaXRpZXM6IGxvY2FsQ2FwYWJpbGl0aWVzLAogICAgICAgICAgICByZW1vdGVDYXBhYmlsaXRpZXM6IHJlbW90ZUNhcGFiaWxpdGllcywKICAgICAgICAgICAgcnRwU2VuZGVyOiBydHBTZW5kZXIsCiAgICAgICAgICAgIHJ0cFJlY2VpdmVyOiBydHBSZWNlaXZlciwKICAgICAgICAgICAga2luZDoga2luZCwKICAgICAgICAgICAgbWlkOiBtaWQsCiAgICAgICAgICAgIGNuYW1lOiBjbmFtZSwKICAgICAgICAgICAgc2VuZFNzcmM6IHNlbmRTc3JjLAogICAgICAgICAgICByZWN2U3NyYzogcmVjdlNzcmMKICAgICAgICAgIH07CiAgICAgICAgICAvLyBTdGFydCB0aGUgUlRDUnRwUmVjZWl2ZXIgbm93LiBUaGUgUlRQU2VuZGVyIGlzIHN0YXJ0ZWQgaW4gc2V0TG9jYWxEZXNjcmlwdGlvbi4KICAgICAgICAgIHNlbGYuX3RyYW5zY2VpdmUoc2VsZi50cmFuc2NlaXZlcnNbc2RwTUxpbmVJbmRleF0sIGZhbHNlLCBkaXJlY3Rpb24gPT09ICdzZW5kcmVjdicgfHwgZGlyZWN0aW9uID09PSAnc2VuZG9ubHknKTsKICAgICAgICB9IGVsc2UgaWYgKGRlc2NyaXB0aW9uLnR5cGUgPT09ICdhbnN3ZXInICYmICFyZWplY3RlZCkgewogICAgICAgICAgdHJhbnNjZWl2ZXIgPSBzZWxmLnRyYW5zY2VpdmVyc1tzZHBNTGluZUluZGV4XTsKICAgICAgICAgIGljZUdhdGhlcmVyID0gdHJhbnNjZWl2ZXIuaWNlR2F0aGVyZXI7CiAgICAgICAgICBpY2VUcmFuc3BvcnQgPSB0cmFuc2NlaXZlci5pY2VUcmFuc3BvcnQ7CiAgICAgICAgICBkdGxzVHJhbnNwb3J0ID0gdHJhbnNjZWl2ZXIuZHRsc1RyYW5zcG9ydDsKICAgICAgICAgIHJ0cFNlbmRlciA9IHRyYW5zY2VpdmVyLnJ0cFNlbmRlcjsKICAgICAgICAgIHJ0cFJlY2VpdmVyID0gdHJhbnNjZWl2ZXIucnRwUmVjZWl2ZXI7CiAgICAgICAgICBzZW5kU3NyYyA9IHRyYW5zY2VpdmVyLnNlbmRTc3JjOwogICAgICAgICAgLy9yZWN2U3NyYyA9IHRyYW5zY2VpdmVyLnJlY3ZTc3JjOwogICAgICAgICAgbG9jYWxDYXBhYmlsaXRpZXMgPSB0cmFuc2NlaXZlci5sb2NhbENhcGFiaWxpdGllczsKCiAgICAgICAgICBzZWxmLnRyYW5zY2VpdmVyc1tzZHBNTGluZUluZGV4XS5yZWN2U3NyYyA9IHJlY3ZTc3JjOwogICAgICAgICAgc2VsZi50cmFuc2NlaXZlcnNbc2RwTUxpbmVJbmRleF0ucmVtb3RlQ2FwYWJpbGl0aWVzID0gcmVtb3RlQ2FwYWJpbGl0aWVzOwogICAgICAgICAgc2VsZi50cmFuc2NlaXZlcnNbc2RwTUxpbmVJbmRleF0uY25hbWUgPSBjbmFtZTsKCiAgICAgICAgICBpY2VUcmFuc3BvcnQuc3RhcnQoaWNlR2F0aGVyZXIsIHJlbW90ZUljZVBhcmFtZXRlcnMsICdjb250cm9sbGluZycpOwogICAgICAgICAgZHRsc1RyYW5zcG9ydC5zdGFydChyZW1vdGVEdGxzUGFyYW1ldGVycyk7CgogICAgICAgICAgc2VsZi5fdHJhbnNjZWl2ZSh0cmFuc2NlaXZlciwgZGlyZWN0aW9uID09PSAnc2VuZHJlY3YnIHx8IGRpcmVjdGlvbiA9PT0gJ3JlY3Zvbmx5JywgZGlyZWN0aW9uID09PSAnc2VuZHJlY3YnIHx8IGRpcmVjdGlvbiA9PT0gJ3NlbmRvbmx5Jyk7CgogICAgICAgICAgaWYgKHJ0cFJlY2VpdmVyICYmIChkaXJlY3Rpb24gPT09ICdzZW5kcmVjdicgfHwgZGlyZWN0aW9uID09PSAnc2VuZG9ubHknKSkgewogICAgICAgICAgICBzdHJlYW0uYWRkVHJhY2socnRwUmVjZWl2ZXIudHJhY2spOwogICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgLy8gRklYTUU6IGFjdHVhbGx5IHRoZSByZWNlaXZlciBzaG91bGQgYmUgY3JlYXRlZCBsYXRlci4KICAgICAgICAgICAgZGVsZXRlIHRyYW5zY2VpdmVyLnJ0cFJlY2VpdmVyOwogICAgICAgICAgfQogICAgICAgIH0KICAgICAgfSk7CgogICAgICB0aGlzLnJlbW90ZURlc2NyaXB0aW9uID0gZGVzY3JpcHRpb247CiAgICAgIHN3aXRjaCAoZGVzY3JpcHRpb24udHlwZSkgewogICAgICAgIGNhc2UgJ29mZmVyJzoKICAgICAgICAgIHRoaXMuX3VwZGF0ZVNpZ25hbGluZ1N0YXRlKCdoYXZlLXJlbW90ZS1vZmZlcicpOwogICAgICAgICAgYnJlYWs7CiAgICAgICAgY2FzZSAnYW5zd2VyJzoKICAgICAgICAgIHRoaXMuX3VwZGF0ZVNpZ25hbGluZ1N0YXRlKCdzdGFibGUnKTsKICAgICAgICAgIGJyZWFrOwogICAgICAgIGRlZmF1bHQ6CiAgICAgICAgICB0aHJvdyBuZXcgVHlwZUVycm9yKCd1bnN1cHBvcnRlZCB0eXBlICInICsgZGVzY3JpcHRpb24udHlwZSArICciJyk7CiAgICAgIH0KICAgICAgd2luZG93LnNldFRpbWVvdXQoZnVuY3Rpb24gKCkgewogICAgICAgIGlmIChzZWxmLm9uYWRkc3RyZWFtICE9PSBudWxsICYmIHN0cmVhbS5nZXRUcmFja3MoKS5sZW5ndGgpIHsKICAgICAgICAgIHNlbGYucmVtb3RlU3RyZWFtcy5wdXNoKHN0cmVhbSk7CiAgICAgICAgICB3aW5kb3cuc2V0VGltZW91dChmdW5jdGlvbiAoKSB7CiAgICAgICAgICAgIHNlbGYub25hZGRzdHJlYW0oeyBzdHJlYW06IHN0cmVhbSB9KTsKICAgICAgICAgIH0sIDApOwogICAgICAgIH0KICAgICAgfSwgMCk7CiAgICAgIGlmIChhcmd1bWVudHMubGVuZ3RoID4gMSAmJiB0eXBlb2YgYXJndW1lbnRzWzFdID09PSAnZnVuY3Rpb24nKSB7CiAgICAgICAgd2luZG93LnNldFRpbWVvdXQoYXJndW1lbnRzWzFdLCAwKTsKICAgICAgfQogICAgICByZXR1cm4gUHJvbWlzZS5yZXNvbHZlKCk7CiAgICB9OwoKICAgIHdpbmRvdy5SVENQZWVyQ29ubmVjdGlvbi5wcm90b3R5cGUuY2xvc2UgPSBmdW5jdGlvbiAoKSB7CiAgICAgIHRoaXMudHJhbnNjZWl2ZXJzLmZvckVhY2goZnVuY3Rpb24gKHRyYW5zY2VpdmVyKSB7CiAgICAgICAgLyogbm90IHlldAogICAgICAgIGlmICh0cmFuc2NlaXZlci5pY2VHYXRoZXJlcikgewogICAgICAgICAgdHJhbnNjZWl2ZXIuaWNlR2F0aGVyZXIuY2xvc2UoKTsKICAgICAgICB9CiAgICAgICAgKi8KICAgICAgICBpZiAodHJhbnNjZWl2ZXIuaWNlVHJhbnNwb3J0KSB7CiAgICAgICAgICB0cmFuc2NlaXZlci5pY2VUcmFuc3BvcnQuc3RvcCgpOwogICAgICAgIH0KICAgICAgICBpZiAodHJhbnNjZWl2ZXIuZHRsc1RyYW5zcG9ydCkgewogICAgICAgICAgdHJhbnNjZWl2ZXIuZHRsc1RyYW5zcG9ydC5zdG9wKCk7CiAgICAgICAgfQogICAgICAgIGlmICh0cmFuc2NlaXZlci5ydHBTZW5kZXIpIHsKICAgICAgICAgIHRyYW5zY2VpdmVyLnJ0cFNlbmRlci5zdG9wKCk7CiAgICAgICAgfQogICAgICAgIGlmICh0cmFuc2NlaXZlci5ydHBSZWNlaXZlcikgewogICAgICAgICAgdHJhbnNjZWl2ZXIucnRwUmVjZWl2ZXIuc3RvcCgpOwogICAgICAgIH0KICAgICAgfSk7CiAgICAgIC8vIEZJWE1FOiBjbGVhbiB1cCB0cmFja3MsIGxvY2FsIHN0cmVhbXMsIHJlbW90ZSBzdHJlYW1zLCBldGMKICAgICAgdGhpcy5fdXBkYXRlU2lnbmFsaW5nU3RhdGUoJ2Nsb3NlZCcpOwogICAgfTsKCiAgICAvLyBVcGRhdGUgdGhlIHNpZ25hbGluZyBzdGF0ZS4KICAgIHdpbmRvdy5SVENQZWVyQ29ubmVjdGlvbi5wcm90b3R5cGUuX3VwZGF0ZVNpZ25hbGluZ1N0YXRlID0gZnVuY3Rpb24gKG5ld1N0YXRlKSB7CiAgICAgIHRoaXMuc2lnbmFsaW5nU3RhdGUgPSBuZXdTdGF0ZTsKICAgICAgaWYgKHRoaXMub25zaWduYWxpbmdzdGF0ZWNoYW5nZSAhPT0gbnVsbCkgewogICAgICAgIHRoaXMub25zaWduYWxpbmdzdGF0ZWNoYW5nZSgpOwogICAgICB9CiAgICB9OwoKICAgIC8vIERldGVybWluZSB3aGV0aGVyIHRvIGZpcmUgdGhlIG5lZ290aWF0aW9ubmVlZGVkIGV2ZW50LgogICAgd2luZG93LlJUQ1BlZXJDb25uZWN0aW9uLnByb3RvdHlwZS5fbWF5YmVGaXJlTmVnb3RpYXRpb25OZWVkZWQgPSBmdW5jdGlvbiAoKSB7CiAgICAgIC8vIEZpcmUgYXdheSAoZm9yIG5vdykuCiAgICAgIGlmICh0aGlzLm9ubmVnb3RpYXRpb25uZWVkZWQgIT09IG51bGwpIHsKICAgICAgICB0aGlzLm9ubmVnb3RpYXRpb25uZWVkZWQoKTsKICAgICAgfQogICAgfTsKCiAgICAvLyBVcGRhdGUgdGhlIGNvbm5lY3Rpb24gc3RhdGUuCiAgICB3aW5kb3cuUlRDUGVlckNvbm5lY3Rpb24ucHJvdG90eXBlLl91cGRhdGVDb25uZWN0aW9uU3RhdGUgPSBmdW5jdGlvbiAoKSB7CiAgICAgIHZhciBzZWxmID0gdGhpczsKICAgICAgdmFyIG5ld1N0YXRlOwogICAgICB2YXIgc3RhdGVzID0gewogICAgICAgICduZXcnOiAwLAogICAgICAgIGNsb3NlZDogMCwKICAgICAgICBjb25uZWN0aW5nOiAwLAogICAgICAgIGNoZWNraW5nOiAwLAogICAgICAgIGNvbm5lY3RlZDogMCwKICAgICAgICBjb21wbGV0ZWQ6IDAsCiAgICAgICAgZmFpbGVkOiAwCiAgICAgIH07CiAgICAgIHRoaXMudHJhbnNjZWl2ZXJzLmZvckVhY2goZnVuY3Rpb24gKHRyYW5zY2VpdmVyKSB7CiAgICAgICAgc3RhdGVzW3RyYW5zY2VpdmVyLmljZVRyYW5zcG9ydC5zdGF0ZV0rKzsKICAgICAgICBzdGF0ZXNbdHJhbnNjZWl2ZXIuZHRsc1RyYW5zcG9ydC5zdGF0ZV0rKzsKICAgICAgfSk7CiAgICAgIC8vIElDRVRyYW5zcG9ydC5jb21wbGV0ZWQgYW5kIGNvbm5lY3RlZCBhcmUgdGhlIHNhbWUgZm9yIHRoaXMgcHVycG9zZS4KICAgICAgc3RhdGVzLmNvbm5lY3RlZCArPSBzdGF0ZXMuY29tcGxldGVkOwoKICAgICAgbmV3U3RhdGUgPSAnbmV3JzsKICAgICAgaWYgKHN0YXRlcy5mYWlsZWQgPiAwKSB7CiAgICAgICAgbmV3U3RhdGUgPSAnZmFpbGVkJzsKICAgICAgfSBlbHNlIGlmIChzdGF0ZXMuY29ubmVjdGluZyA+IDAgfHwgc3RhdGVzLmNoZWNraW5nID4gMCkgewogICAgICAgIG5ld1N0YXRlID0gJ2Nvbm5lY3RpbmcnOwogICAgICB9IGVsc2UgaWYgKHN0YXRlcy5kaXNjb25uZWN0ZWQgPiAwKSB7CiAgICAgICAgbmV3U3RhdGUgPSAnZGlzY29ubmVjdGVkJzsKICAgICAgfSBlbHNlIGlmIChzdGF0ZXNbJ25ldyddID4gMCkgewogICAgICAgIG5ld1N0YXRlID0gJ25ldyc7CiAgICAgIH0gZWxzZSBpZiAoc3RhdGVzLmNvbm5lY3RpbmcgPiAwIHx8IHN0YXRlcy5jb21wbGV0ZWQgPiAwKSB7CiAgICAgICAgbmV3U3RhdGUgPSAnY29ubmVjdGVkJzsKICAgICAgfQoKICAgICAgaWYgKG5ld1N0YXRlICE9PSBzZWxmLmljZUNvbm5lY3Rpb25TdGF0ZSkgewogICAgICAgIHNlbGYuaWNlQ29ubmVjdGlvblN0YXRlID0gbmV3U3RhdGU7CiAgICAgICAgaWYgKHRoaXMub25pY2Vjb25uZWN0aW9uc3RhdGVjaGFuZ2UgIT09IG51bGwpIHsKICAgICAgICAgIHRoaXMub25pY2Vjb25uZWN0aW9uc3RhdGVjaGFuZ2UoKTsKICAgICAgICB9CiAgICAgIH0KICAgIH07CgogICAgd2luZG93LlJUQ1BlZXJDb25uZWN0aW9uLnByb3RvdHlwZS5jcmVhdGVPZmZlciA9IGZ1bmN0aW9uICgpIHsKICAgICAgdmFyIHNlbGYgPSB0aGlzOwogICAgICBpZiAodGhpcy5fcGVuZGluZ09mZmVyKSB7CiAgICAgICAgdGhyb3cgbmV3IEVycm9yKCdjcmVhdGVPZmZlciBjYWxsZWQgd2hpbGUgdGhlcmUgaXMgYSBwZW5kaW5nIG9mZmVyLicpOwogICAgICB9CiAgICAgIHZhciBvZmZlck9wdGlvbnM7CiAgICAgIGlmIChhcmd1bWVudHMubGVuZ3RoID09PSAxICYmIHR5cGVvZiBhcmd1bWVudHNbMF0gIT09ICdmdW5jdGlvbicpIHsKICAgICAgICBvZmZlck9wdGlvbnMgPSBhcmd1bWVudHNbMF07CiAgICAgIH0gZWxzZSBpZiAoYXJndW1lbnRzLmxlbmd0aCA9PT0gMykgewogICAgICAgIG9mZmVyT3B0aW9ucyA9IGFyZ3VtZW50c1syXTsKICAgICAgfQoKICAgICAgdmFyIHRyYWNrcyA9IFtdOwogICAgICB2YXIgbnVtQXVkaW9UcmFja3MgPSAwOwogICAgICB2YXIgbnVtVmlkZW9UcmFja3MgPSAwOwogICAgICAvLyBEZWZhdWx0IHRvIHNlbmRyZWN2LgogICAgICBpZiAodGhpcy5sb2NhbFN0cmVhbXMubGVuZ3RoKSB7CiAgICAgICAgbnVtQXVkaW9UcmFja3MgPSB0aGlzLmxvY2FsU3RyZWFtc1swXS5nZXRBdWRpb1RyYWNrcygpLmxlbmd0aDsKICAgICAgICBudW1WaWRlb1RyYWNrcyA9IHRoaXMubG9jYWxTdHJlYW1zWzBdLmdldFZpZGVvVHJhY2tzKCkubGVuZ3RoOwogICAgICB9CiAgICAgIC8vIERldGVybWluZSBudW1iZXIgb2YgYXVkaW8gYW5kIHZpZGVvIHRyYWNrcyB3ZSBuZWVkIHRvIHNlbmQvcmVjdi4KICAgICAgaWYgKG9mZmVyT3B0aW9ucykgewogICAgICAgIC8vIFJlamVjdCBDaHJvbWUgbGVnYWN5IGNvbnN0cmFpbnRzLgogICAgICAgIGlmIChvZmZlck9wdGlvbnMubWFuZGF0b3J5IHx8IG9mZmVyT3B0aW9ucy5vcHRpb25hbCkgewogICAgICAgICAgdGhyb3cgbmV3IFR5cGVFcnJvcignTGVnYWN5IG1hbmRhdG9yeS9vcHRpb25hbCBjb25zdHJhaW50cyBub3Qgc3VwcG9ydGVkLicpOwogICAgICAgIH0KICAgICAgICBpZiAob2ZmZXJPcHRpb25zLm9mZmVyVG9SZWNlaXZlQXVkaW8gIT09IHVuZGVmaW5lZCkgewogICAgICAgICAgbnVtQXVkaW9UcmFja3MgPSBvZmZlck9wdGlvbnMub2ZmZXJUb1JlY2VpdmVBdWRpbzsKICAgICAgICB9CiAgICAgICAgaWYgKG9mZmVyT3B0aW9ucy5vZmZlclRvUmVjZWl2ZVZpZGVvICE9PSB1bmRlZmluZWQpIHsKICAgICAgICAgIG51bVZpZGVvVHJhY2tzID0gb2ZmZXJPcHRpb25zLm9mZmVyVG9SZWNlaXZlVmlkZW87CiAgICAgICAgfQogICAgICB9CiAgICAgIGlmICh0aGlzLmxvY2FsU3RyZWFtcy5sZW5ndGgpIHsKICAgICAgICAvLyBQdXNoIGxvY2FsIHN0cmVhbXMuCiAgICAgICAgdGhpcy5sb2NhbFN0cmVhbXNbMF0uZ2V0VHJhY2tzKCkuZm9yRWFjaChmdW5jdGlvbiAodHJhY2spIHsKICAgICAgICAgIHRyYWNrcy5wdXNoKHsKICAgICAgICAgICAga2luZDogdHJhY2sua2luZCwKICAgICAgICAgICAgdHJhY2s6IHRyYWNrLAogICAgICAgICAgICB3YW50UmVjZWl2ZTogdHJhY2sua2luZCA9PT0gJ2F1ZGlvJyA/IG51bUF1ZGlvVHJhY2tzID4gMCA6IG51bVZpZGVvVHJhY2tzID4gMAogICAgICAgICAgfSk7CiAgICAgICAgICBpZiAodHJhY2sua2luZCA9PT0gJ2F1ZGlvJykgewogICAgICAgICAgICBudW1BdWRpb1RyYWNrcy0tOwogICAgICAgICAgfSBlbHNlIGlmICh0cmFjay5raW5kID09PSAndmlkZW8nKSB7CiAgICAgICAgICAgIG51bVZpZGVvVHJhY2tzLS07CiAgICAgICAgICB9CiAgICAgICAgfSk7CiAgICAgIH0KICAgICAgLy8gQ3JlYXRlIE0tbGluZXMgZm9yIHJlY3Zvbmx5IHN0cmVhbXMuCiAgICAgIHdoaWxlIChudW1BdWRpb1RyYWNrcyA+IDAgfHwgbnVtVmlkZW9UcmFja3MgPiAwKSB7CiAgICAgICAgaWYgKG51bUF1ZGlvVHJhY2tzID4gMCkgewogICAgICAgICAgdHJhY2tzLnB1c2goewogICAgICAgICAgICBraW5kOiAnYXVkaW8nLAogICAgICAgICAgICB3YW50UmVjZWl2ZTogdHJ1ZQogICAgICAgICAgfSk7CiAgICAgICAgICBudW1BdWRpb1RyYWNrcy0tOwogICAgICAgIH0KICAgICAgICBpZiAobnVtVmlkZW9UcmFja3MgPiAwKSB7CiAgICAgICAgICB0cmFja3MucHVzaCh7CiAgICAgICAgICAgIGtpbmQ6ICd2aWRlbycsCiAgICAgICAgICAgIHdhbnRSZWNlaXZlOiB0cnVlCiAgICAgICAgICB9KTsKICAgICAgICAgIG51bVZpZGVvVHJhY2tzLS07CiAgICAgICAgfQogICAgICB9CgogICAgICB2YXIgc2RwID0gU0RQVXRpbHMud3JpdGVTZXNzaW9uQm9pbGVycGxhdGUoKTsKICAgICAgdmFyIHRyYW5zY2VpdmVycyA9IFtdOwogICAgICB0cmFja3MuZm9yRWFjaChmdW5jdGlvbiAobWxpbmUsIHNkcE1MaW5lSW5kZXgpIHsKICAgICAgICAvLyBGb3IgZWFjaCB0cmFjaywgY3JlYXRlIGFuIGljZSBnYXRoZXJlciwgaWNlIHRyYW5zcG9ydCwgZHRscyB0cmFuc3BvcnQsCiAgICAgICAgLy8gcG90ZW50aWFsbHkgcnRwc2VuZGVyIGFuZCBydHByZWNlaXZlci4KICAgICAgICB2YXIgdHJhY2sgPSBtbGluZS50cmFjazsKICAgICAgICB2YXIga2luZCA9IG1saW5lLmtpbmQ7CiAgICAgICAgdmFyIG1pZCA9IGdlbmVyYXRlSWRlbnRpZmllcigpOwoKICAgICAgICB2YXIgdHJhbnNwb3J0cyA9IHNlbGYuX2NyZWF0ZUljZUFuZER0bHNUcmFuc3BvcnRzKG1pZCwgc2RwTUxpbmVJbmRleCk7CgogICAgICAgIHZhciBsb2NhbENhcGFiaWxpdGllcyA9IFJUQ1J0cFNlbmRlci5nZXRDYXBhYmlsaXRpZXMoa2luZCk7CiAgICAgICAgdmFyIHJ0cFNlbmRlcjsKICAgICAgICB2YXIgcnRwUmVjZWl2ZXI7CgogICAgICAgIC8vIGdlbmVyYXRlIGFuIHNzcmMgbm93LCB0byBiZSB1c2VkIGxhdGVyIGluIHJ0cFNlbmRlci5zZW5kCiAgICAgICAgdmFyIHNlbmRTc3JjID0gKDIgKiBzZHBNTGluZUluZGV4ICsgMSkgKiAxMDAxOwogICAgICAgIGlmICh0cmFjaykgewogICAgICAgICAgcnRwU2VuZGVyID0gbmV3IFJUQ1J0cFNlbmRlcih0cmFjaywgdHJhbnNwb3J0cy5kdGxzVHJhbnNwb3J0KTsKICAgICAgICB9CgogICAgICAgIGlmIChtbGluZS53YW50UmVjZWl2ZSkgewogICAgICAgICAgcnRwUmVjZWl2ZXIgPSBuZXcgUlRDUnRwUmVjZWl2ZXIodHJhbnNwb3J0cy5kdGxzVHJhbnNwb3J0LCBraW5kKTsKICAgICAgICB9CgogICAgICAgIHRyYW5zY2VpdmVyc1tzZHBNTGluZUluZGV4XSA9IHsKICAgICAgICAgIGljZUdhdGhlcmVyOiB0cmFuc3BvcnRzLmljZUdhdGhlcmVyLAogICAgICAgICAgaWNlVHJhbnNwb3J0OiB0cmFuc3BvcnRzLmljZVRyYW5zcG9ydCwKICAgICAgICAgIGR0bHNUcmFuc3BvcnQ6IHRyYW5zcG9ydHMuZHRsc1RyYW5zcG9ydCwKICAgICAgICAgIGxvY2FsQ2FwYWJpbGl0aWVzOiBsb2NhbENhcGFiaWxpdGllcywKICAgICAgICAgIHJlbW90ZUNhcGFiaWxpdGllczogbnVsbCwKICAgICAgICAgIHJ0cFNlbmRlcjogcnRwU2VuZGVyLAogICAgICAgICAgcnRwUmVjZWl2ZXI6IHJ0cFJlY2VpdmVyLAogICAgICAgICAga2luZDoga2luZCwKICAgICAgICAgIG1pZDogbWlkLAogICAgICAgICAgc2VuZFNzcmM6IHNlbmRTc3JjLAogICAgICAgICAgcmVjdlNzcmM6IG51bGwKICAgICAgICB9OwogICAgICAgIHZhciB0cmFuc2NlaXZlciA9IHRyYW5zY2VpdmVyc1tzZHBNTGluZUluZGV4XTsKICAgICAgICBzZHAgKz0gU0RQVXRpbHMud3JpdGVNZWRpYVNlY3Rpb24odHJhbnNjZWl2ZXIsIHRyYW5zY2VpdmVyLmxvY2FsQ2FwYWJpbGl0aWVzLCAnb2ZmZXInLCBzZWxmLmxvY2FsU3RyZWFtc1swXSk7CiAgICAgIH0pOwoKICAgICAgdGhpcy5fcGVuZGluZ09mZmVyID0gdHJhbnNjZWl2ZXJzOwogICAgICB2YXIgZGVzYyA9IG5ldyBSVENTZXNzaW9uRGVzY3JpcHRpb24oewogICAgICAgIHR5cGU6ICdvZmZlcicsCiAgICAgICAgc2RwOiBzZHAKICAgICAgfSk7CiAgICAgIGlmIChhcmd1bWVudHMubGVuZ3RoICYmIHR5cGVvZiBhcmd1bWVudHNbMF0gPT09ICdmdW5jdGlvbicpIHsKICAgICAgICB3aW5kb3cuc2V0VGltZW91dChhcmd1bWVudHNbMF0sIDAsIGRlc2MpOwogICAgICB9CiAgICAgIHJldHVybiBQcm9taXNlLnJlc29sdmUoZGVzYyk7CiAgICB9OwoKICAgIHdpbmRvdy5SVENQZWVyQ29ubmVjdGlvbi5wcm90b3R5cGUuY3JlYXRlQW5zd2VyID0gZnVuY3Rpb24gKCkgewogICAgICB2YXIgc2VsZiA9IHRoaXM7CiAgICAgIHZhciBhbnN3ZXJPcHRpb25zOwogICAgICBpZiAoYXJndW1lbnRzLmxlbmd0aCA9PT0gMSAmJiB0eXBlb2YgYXJndW1lbnRzWzBdICE9PSAnZnVuY3Rpb24nKSB7CiAgICAgICAgYW5zd2VyT3B0aW9ucyA9IGFyZ3VtZW50c1swXTsKICAgICAgfSBlbHNlIGlmIChhcmd1bWVudHMubGVuZ3RoID09PSAzKSB7CiAgICAgICAgYW5zd2VyT3B0aW9ucyA9IGFyZ3VtZW50c1syXTsKICAgICAgfQoKICAgICAgdmFyIHNkcCA9IFNEUFV0aWxzLndyaXRlU2Vzc2lvbkJvaWxlcnBsYXRlKCk7CiAgICAgIHRoaXMudHJhbnNjZWl2ZXJzLmZvckVhY2goZnVuY3Rpb24gKHRyYW5zY2VpdmVyKSB7CiAgICAgICAgLy8gQ2FsY3VsYXRlIGludGVyc2VjdGlvbiBvZiBjYXBhYmlsaXRpZXMuCiAgICAgICAgdmFyIGNvbW1vbkNhcGFiaWxpdGllcyA9IHNlbGYuX2dldENvbW1vbkNhcGFiaWxpdGllcyh0cmFuc2NlaXZlci5sb2NhbENhcGFiaWxpdGllcywgdHJhbnNjZWl2ZXIucmVtb3RlQ2FwYWJpbGl0aWVzKTsKCiAgICAgICAgc2RwICs9IFNEUFV0aWxzLndyaXRlTWVkaWFTZWN0aW9uKHRyYW5zY2VpdmVyLCBjb21tb25DYXBhYmlsaXRpZXMsICdhbnN3ZXInLCBzZWxmLmxvY2FsU3RyZWFtc1swXSk7CiAgICAgIH0pOwoKICAgICAgdmFyIGRlc2MgPSBuZXcgUlRDU2Vzc2lvbkRlc2NyaXB0aW9uKHsKICAgICAgICB0eXBlOiAnYW5zd2VyJywKICAgICAgICBzZHA6IHNkcAogICAgICB9KTsKICAgICAgaWYgKGFyZ3VtZW50cy5sZW5ndGggJiYgdHlwZW9mIGFyZ3VtZW50c1swXSA9PT0gJ2Z1bmN0aW9uJykgewogICAgICAgIHdpbmRvdy5zZXRUaW1lb3V0KGFyZ3VtZW50c1swXSwgMCwgZGVzYyk7CiAgICAgIH0KICAgICAgcmV0dXJuIFByb21pc2UucmVzb2x2ZShkZXNjKTsKICAgIH07CgogICAgd2luZG93LlJUQ1BlZXJDb25uZWN0aW9uLnByb3RvdHlwZS5hZGRJY2VDYW5kaWRhdGUgPSBmdW5jdGlvbiAoY2FuZGlkYXRlKSB7CiAgICAgIHZhciBtTGluZUluZGV4ID0gY2FuZGlkYXRlLnNkcE1MaW5lSW5kZXg7CiAgICAgIGlmIChjYW5kaWRhdGUuc2RwTWlkKSB7CiAgICAgICAgZm9yICh2YXIgaSA9IDA7IGkgPCB0aGlzLnRyYW5zY2VpdmVycy5sZW5ndGg7IGkrKykgewogICAgICAgICAgaWYgKHRoaXMudHJhbnNjZWl2ZXJzW2ldLm1pZCA9PT0gY2FuZGlkYXRlLnNkcE1pZCkgewogICAgICAgICAgICBtTGluZUluZGV4ID0gaTsKICAgICAgICAgICAgYnJlYWs7CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICB9CiAgICAgIHZhciB0cmFuc2NlaXZlciA9IHRoaXMudHJhbnNjZWl2ZXJzW21MaW5lSW5kZXhdOwogICAgICBpZiAodHJhbnNjZWl2ZXIpIHsKICAgICAgICB2YXIgY2FuZCA9IE9iamVjdC5rZXlzKGNhbmRpZGF0ZS5jYW5kaWRhdGUpLmxlbmd0aCA+IDAgPyBTRFBVdGlscy5wYXJzZUNhbmRpZGF0ZShjYW5kaWRhdGUuY2FuZGlkYXRlKSA6IHt9OwogICAgICAgIC8vIElnbm9yZSBDaHJvbWUncyBpbnZhbGlkIGNhbmRpZGF0ZXMgc2luY2UgRWRnZSBkb2VzIG5vdCBsaWtlIHRoZW0uCiAgICAgICAgaWYgKGNhbmQucHJvdG9jb2wgPT09ICd0Y3AnICYmIGNhbmQucG9ydCA9PT0gMCkgewogICAgICAgICAgcmV0dXJuOwogICAgICAgIH0KICAgICAgICAvLyBJZ25vcmUgUlRDUCBjYW5kaWRhdGVzLCB3ZSBhc3N1bWUgUlRDUC1NVVguCiAgICAgICAgaWYgKGNhbmQuY29tcG9uZW50ICE9PSAnMScpIHsKICAgICAgICAgIHJldHVybjsKICAgICAgICB9CiAgICAgICAgLy8gQSBkaXJ0eSBoYWNrIHRvIG1ha2Ugc2FtcGxlcyB3b3JrLgogICAgICAgIGlmIChjYW5kLnR5cGUgPT09ICdlbmRPZkNhbmRpZGF0ZXMnKSB7CiAgICAgICAgICBjYW5kID0ge307CiAgICAgICAgfQogICAgICAgIHRyYW5zY2VpdmVyLmljZVRyYW5zcG9ydC5hZGRSZW1vdGVDYW5kaWRhdGUoY2FuZCk7CiAgICAgIH0KICAgICAgaWYgKGFyZ3VtZW50cy5sZW5ndGggPiAxICYmIHR5cGVvZiBhcmd1bWVudHNbMV0gPT09ICdmdW5jdGlvbicpIHsKICAgICAgICB3aW5kb3cuc2V0VGltZW91dChhcmd1bWVudHNbMV0sIDApOwogICAgICB9CiAgICAgIHJldHVybiBQcm9taXNlLnJlc29sdmUoKTsKICAgIH07CgogICAgd2luZG93LlJUQ1BlZXJDb25uZWN0aW9uLnByb3RvdHlwZS5nZXRTdGF0cyA9IGZ1bmN0aW9uICgpIHsKICAgICAgdmFyIHByb21pc2VzID0gW107CiAgICAgIHRoaXMudHJhbnNjZWl2ZXJzLmZvckVhY2goZnVuY3Rpb24gKHRyYW5zY2VpdmVyKSB7CiAgICAgICAgWydydHBTZW5kZXInLCAncnRwUmVjZWl2ZXInLCAnaWNlR2F0aGVyZXInLCAnaWNlVHJhbnNwb3J0JywgJ2R0bHNUcmFuc3BvcnQnXS5mb3JFYWNoKGZ1bmN0aW9uIChtZXRob2QpIHsKICAgICAgICAgIGlmICh0cmFuc2NlaXZlclttZXRob2RdKSB7CiAgICAgICAgICAgIHByb21pc2VzLnB1c2godHJhbnNjZWl2ZXJbbWV0aG9kXS5nZXRTdGF0cygpKTsKICAgICAgICAgIH0KICAgICAgICB9KTsKICAgICAgfSk7CiAgICAgIHZhciBjYiA9IGFyZ3VtZW50cy5sZW5ndGggPiAxICYmIHR5cGVvZiBhcmd1bWVudHNbMV0gPT09ICdmdW5jdGlvbicgJiYgYXJndW1lbnRzWzFdOwogICAgICByZXR1cm4gbmV3IFByb21pc2UoZnVuY3Rpb24gKHJlc29sdmUpIHsKICAgICAgICB2YXIgcmVzdWx0cyA9IHt9OwogICAgICAgIFByb21pc2UuYWxsKHByb21pc2VzKS50aGVuKGZ1bmN0aW9uIChyZXMpIHsKICAgICAgICAgIHJlcy5mb3JFYWNoKGZ1bmN0aW9uIChyZXN1bHQpIHsKICAgICAgICAgICAgT2JqZWN0LmtleXMocmVzdWx0KS5mb3JFYWNoKGZ1bmN0aW9uIChpZCkgewogICAgICAgICAgICAgIHJlc3VsdHNbaWRdID0gcmVzdWx0W2lkXTsKICAgICAgICAgICAgfSk7CiAgICAgICAgICB9KTsKICAgICAgICAgIGlmIChjYikgewogICAgICAgICAgICB3aW5kb3cuc2V0VGltZW91dChjYiwgMCwgcmVzdWx0cyk7CiAgICAgICAgICB9CiAgICAgICAgICByZXNvbHZlKHJlc3VsdHMpOwogICAgICAgIH0pOwogICAgICB9KTsKICAgIH07CiAgfQp9IGVsc2UgewogIHdlYnJ0Y1V0aWxzLmxvZygnQnJvd3NlciBkb2VzIG5vdCBhcHBlYXIgdG8gYmUgV2ViUlRDLWNhcGFibGUnKTsKfQoKLy8gUG9seWZpbGwgb250cmFjayBvbiBicm93c2VycyB0aGF0IGRvbid0IHlldCBoYXZlIGl0CmlmICh0eXBlb2Ygd2luZG93ID09PSAnb2JqZWN0JyAmJiB3aW5kb3cuUlRDUGVlckNvbm5lY3Rpb24gJiYgISgnb250cmFjaycgaW4gd2luZG93LlJUQ1BlZXJDb25uZWN0aW9uLnByb3RvdHlwZSkpIHsKICBPYmplY3QuZGVmaW5lUHJvcGVydHkod2luZG93LlJUQ1BlZXJDb25uZWN0aW9uLnByb3RvdHlwZSwgJ29udHJhY2snLCB7CiAgICBnZXQ6IGZ1bmN0aW9uIGdldCgpIHsKICAgICAgcmV0dXJuIHRoaXMuX29udHJhY2s7CiAgICB9LAogICAgc2V0OiBmdW5jdGlvbiBzZXQoZikgewogICAgICB2YXIgc2VsZiA9IHRoaXM7CiAgICAgIGlmICh0aGlzLl9vbnRyYWNrKSB7CiAgICAgICAgdGhpcy5yZW1vdmVFdmVudExpc3RlbmVyKCd0cmFjaycsIHRoaXMuX29udHJhY2spOwogICAgICAgIHRoaXMucmVtb3ZlRXZlbnRMaXN0ZW5lcignYWRkc3RyZWFtJywgdGhpcy5fb250cmFja3BvbHkpOwogICAgICB9CiAgICAgIHRoaXMuYWRkRXZlbnRMaXN0ZW5lcigndHJhY2snLCB0aGlzLl9vbnRyYWNrID0gZik7CiAgICAgIHRoaXMuYWRkRXZlbnRMaXN0ZW5lcignYWRkc3RyZWFtJywgdGhpcy5fb250cmFja3BvbHkgPSAoZnVuY3Rpb24gKGUpIHsKICAgICAgICBpZiAod2VicnRjRGV0ZWN0ZWRCcm93c2VyID09PSAnY2hyb21lJykgewogICAgICAgICAgLy8gb25hZGRzdHJlYW0gZG9lcyBub3QgZmlyZSB3aGVuIGEgdHJhY2sgaXMgYWRkZWQgdG8gYW4gZXhpc3Rpbmcgc3RyZWFtLgogICAgICAgICAgLy8gYnV0IHN0cmVhbS5vbmFkZHRyYWNrIGlzIGltcGxlbWVudGVkIHNvIHdlIHVzZSB0aOOBn3QKICAgICAgICAgIGUuc3RyZWFtLmFkZEV2ZW50TGlzdGVuZXIoJ2FkZHRyYWNrJywgZnVuY3Rpb24gKHRlKSB7CiAgICAgICAgICAgIHZhciBldmVudCA9IG5ldyBFdmVudCgndHJhY2snKTsKICAgICAgICAgICAgZXZlbnQudHJhY2sgPSB0ZS50cmFjazsKICAgICAgICAgICAgZXZlbnQucmVjZWl2ZXIgPSB7IHRyYWNrOiB0ZS50cmFjayB9OwogICAgICAgICAgICBldmVudC5zdHJlYW1zID0gW2Uuc3RyZWFtXTsKICAgICAgICAgICAgc2VsZi5kaXNwYXRjaEV2ZW50KGV2ZW50KTsKICAgICAgICAgIH0pOwogICAgICAgIH0KICAgICAgICBlLnN0cmVhbS5nZXRUcmFja3MoKS5mb3JFYWNoKChmdW5jdGlvbiAodHJhY2spIHsKICAgICAgICAgIHZhciBldmVudCA9IG5ldyBFdmVudCgndHJhY2snKTsKICAgICAgICAgIGV2ZW50LnRyYWNrID0gdHJhY2s7CiAgICAgICAgICBldmVudC5yZWNlaXZlciA9IHsgdHJhY2s6IHRyYWNrIH07CiAgICAgICAgICBldmVudC5zdHJlYW1zID0gW2Uuc3RyZWFtXTsKICAgICAgICAgIHRoaXMuZGlzcGF0Y2hFdmVudChldmVudCk7CiAgICAgICAgfSkuYmluZCh0aGlzKSk7CiAgICAgIH0pLmJpbmQodGhpcykpOwogICAgfQogIH0pOwp9CgovLyBSZXR1cm5zIHRoZSByZXN1bHQgb2YgZ2V0VXNlck1lZGlhIGFzIGEgUHJvbWlzZS4KZnVuY3Rpb24gcmVxdWVzdFVzZXJNZWRpYShjb25zdHJhaW50cykgewogIHJldHVybiBuZXcgUHJvbWlzZShmdW5jdGlvbiAocmVzb2x2ZSwgcmVqZWN0KSB7CiAgICBnZXRVc2VyTWVkaWEoY29uc3RyYWludHMsIHJlc29sdmUsIHJlamVjdCk7CiAgfSk7Cn0KCnZhciB3ZWJydGNUZXN0aW5nID0ge307CnRyeSB7CiAgT2JqZWN0LmRlZmluZVByb3BlcnR5KHdlYnJ0Y1Rlc3RpbmcsICd2ZXJzaW9uJywgewogICAgc2V0OiBmdW5jdGlvbiBzZXQodmVyc2lvbikgewogICAgICB3ZWJydGNEZXRlY3RlZFZlcnNpb24gPSB2ZXJzaW9uOwogICAgfQogIH0pOwp9IGNhdGNoIChlKSB7fQoKaWYgKHR5cGVvZiBtb2R1bGUgIT09ICd1bmRlZmluZWQnKSB7CiAgdmFyIFJUQ1BlZXJDb25uZWN0aW9uOwogIHZhciBSVENJY2VDYW5kaWRhdGU7CiAgdmFyIFJUQ1Nlc3Npb25EZXNjcmlwdGlvbjsKICBpZiAodHlwZW9mIHdpbmRvdyAhPT0gJ3VuZGVmaW5lZCcpIHsKICAgIFJUQ1BlZXJDb25uZWN0aW9uID0gd2luZG93LlJUQ1BlZXJDb25uZWN0aW9uOwogICAgUlRDSWNlQ2FuZGlkYXRlID0gd2luZG93LlJUQ0ljZUNhbmRpZGF0ZTsKICAgIFJUQ1Nlc3Npb25EZXNjcmlwdGlvbiA9IHdpbmRvdy5SVENTZXNzaW9uRGVzY3JpcHRpb247CiAgfQogIG1vZHVsZS5leHBvcnRzID0gewogICAgUlRDUGVlckNvbm5lY3Rpb246IFJUQ1BlZXJDb25uZWN0aW9uLAogICAgUlRDSWNlQ2FuZGlkYXRlOiBSVENJY2VDYW5kaWRhdGUsCiAgICBSVENTZXNzaW9uRGVzY3JpcHRpb246IFJUQ1Nlc3Npb25EZXNjcmlwdGlvbiwKICAgIGdldFVzZXJNZWRpYTogZ2V0VXNlck1lZGlhLAogICAgYXR0YWNoTWVkaWFTdHJlYW06IGF0dGFjaE1lZGlhU3RyZWFtLAogICAgcmVhdHRhY2hNZWRpYVN0cmVhbTogcmVhdHRhY2hNZWRpYVN0cmVhbSwKICAgIHdlYnJ0Y0RldGVjdGVkQnJvd3Nlcjogd2VicnRjRGV0ZWN0ZWRCcm93c2VyLAogICAgd2VicnRjRGV0ZWN0ZWRWZXJzaW9uOiB3ZWJydGNEZXRlY3RlZFZlcnNpb24sCiAgICB3ZWJydGNNaW5pbXVtVmVyc2lvbjogd2VicnRjTWluaW11bVZlcnNpb24sCiAgICB3ZWJydGNUZXN0aW5nOiB3ZWJydGNUZXN0aW5nLAogICAgd2VicnRjVXRpbHM6IHdlYnJ0Y1V0aWxzCiAgICAvL3JlcXVlc3RVc2VyTWVkaWE6IG5vdCBleHBvc2VkIG9uIHB1cnBvc2UuCiAgICAvL3RyYWNlOiBub3QgZXhwb3NlZCBvbiBwdXJwb3NlLgogIH07Cn0gZWxzZSBpZiAodHlwZW9mIHJlcXVpcmUgPT09ICdmdW5jdGlvbicgJiYgdHlwZW9mIGRlZmluZSA9PT0gJ2Z1bmN0aW9uJykgewogICAgLy8gRXhwb3NlIG9iamVjdHMgYW5kIGZ1bmN0aW9ucyB3aGVuIFJlcXVpcmVKUyBpcyBkb2luZyB0aGUgbG9hZGluZy4KICAgIGRlZmluZShbXSwgZnVuY3Rpb24gKCkgewogICAgICByZXR1cm4gewogICAgICAgIFJUQ1BlZXJDb25uZWN0aW9uOiB3aW5kb3cuUlRDUGVlckNvbm5lY3Rpb24sCiAgICAgICAgUlRDSWNlQ2FuZGlkYXRlOiB3aW5kb3cuUlRDSWNlQ2FuZGlkYXRlLAogICAgICAgIFJUQ1Nlc3Npb25EZXNjcmlwdGlvbjogd2luZG93LlJUQ1Nlc3Npb25EZXNjcmlwdGlvbiwKICAgICAgICBnZXRVc2VyTWVkaWE6IGdldFVzZXJNZWRpYSwKICAgICAgICBhdHRhY2hNZWRpYVN0cmVhbTogYXR0YWNoTWVkaWFTdHJlYW0sCiAgICAgICAgcmVhdHRhY2hNZWRpYVN0cmVhbTogcmVhdHRhY2hNZWRpYVN0cmVhbSwKICAgICAgICB3ZWJydGNEZXRlY3RlZEJyb3dzZXI6IHdlYnJ0Y0RldGVjdGVkQnJvd3NlciwKICAgICAgICB3ZWJydGNEZXRlY3RlZFZlcnNpb246IHdlYnJ0Y0RldGVjdGVkVmVyc2lvbiwKICAgICAgICB3ZWJydGNNaW5pbXVtVmVyc2lvbjogd2VicnRjTWluaW11bVZlcnNpb24sCiAgICAgICAgd2VicnRjVGVzdGluZzogd2VicnRjVGVzdGluZywKICAgICAgICB3ZWJydGNVdGlsczogd2VicnRjVXRpbHMKICAgICAgICAvL3JlcXVlc3RVc2VyTWVkaWE6IG5vdCBleHBvc2VkIG9uIHB1cnBvc2UuCiAgICAgICAgLy90cmFjZTogbm90IGV4cG9zZWQgb24gcHVycG9zZS4KICAgICAgfTsKICAgIH0pOwogIH0KCn0se31dLDI6W2Z1bmN0aW9uKHJlcXVpcmUsbW9kdWxlLGV4cG9ydHMpewovKiBqc2hpbnQgdW5kZWY6IHRydWUgKi8KLyogZ2xvYmFscyBSVENQZWVyQ29ubmVjdGlvbiAqLwovKiBnbG9iYWxzIFJUQ1Nlc3Npb25EZXNjcmlwdGlvbiAqLwovKiBnbG9iYWxzIFJUQ0ljZUNhbmRpZGF0ZSAqLwoKJ3VzZSBzdHJpY3QnOwoKT2JqZWN0LmRlZmluZVByb3BlcnR5KGV4cG9ydHMsICdfX2VzTW9kdWxlJywgewogIHZhbHVlOiB0cnVlCn0pOwoKdmFyIF9jcmVhdGVDbGFzcyA9IChmdW5jdGlvbiAoKSB7IGZ1bmN0aW9uIGRlZmluZVByb3BlcnRpZXModGFyZ2V0LCBwcm9wcykgeyBmb3IgKHZhciBpID0gMDsgaSA8IHByb3BzLmxlbmd0aDsgaSsrKSB7IHZhciBkZXNjcmlwdG9yID0gcHJvcHNbaV07IGRlc2NyaXB0b3IuZW51bWVyYWJsZSA9IGRlc2NyaXB0b3IuZW51bWVyYWJsZSB8fCBmYWxzZTsgZGVzY3JpcHRvci5jb25maWd1cmFibGUgPSB0cnVlOyBpZiAoJ3ZhbHVlJyBpbiBkZXNjcmlwdG9yKSBkZXNjcmlwdG9yLndyaXRhYmxlID0gdHJ1ZTsgT2JqZWN0LmRlZmluZVByb3BlcnR5KHRhcmdldCwgZGVzY3JpcHRvci5rZXksIGRlc2NyaXB0b3IpOyB9IH0gcmV0dXJuIGZ1bmN0aW9uIChDb25zdHJ1Y3RvciwgcHJvdG9Qcm9wcywgc3RhdGljUHJvcHMpIHsgaWYgKHByb3RvUHJvcHMpIGRlZmluZVByb3BlcnRpZXMoQ29uc3RydWN0b3IucHJvdG90eXBlLCBwcm90b1Byb3BzKTsgaWYgKHN0YXRpY1Byb3BzKSBkZWZpbmVQcm9wZXJ0aWVzKENvbnN0cnVjdG9yLCBzdGF0aWNQcm9wcyk7IHJldHVybiBDb25zdHJ1Y3RvcjsgfTsgfSkoKTsKCnZhciBfZ2V0ID0gZnVuY3Rpb24gZ2V0KF94LCBfeDIsIF94MykgeyB2YXIgX2FnYWluID0gdHJ1ZTsgX2Z1bmN0aW9uOiB3aGlsZSAoX2FnYWluKSB7IHZhciBvYmplY3QgPSBfeCwgcHJvcGVydHkgPSBfeDIsIHJlY2VpdmVyID0gX3gzOyBfYWdhaW4gPSBmYWxzZTsgaWYgKG9iamVjdCA9PT0gbnVsbCkgb2JqZWN0ID0gRnVuY3Rpb24ucHJvdG90eXBlOyB2YXIgZGVzYyA9IE9iamVjdC5nZXRPd25Qcm9wZXJ0eURlc2NyaXB0b3Iob2JqZWN0LCBwcm9wZXJ0eSk7IGlmIChkZXNjID09PSB1bmRlZmluZWQpIHsgdmFyIHBhcmVudCA9IE9iamVjdC5nZXRQcm90b3R5cGVPZihvYmplY3QpOyBpZiAocGFyZW50ID09PSBudWxsKSB7IHJldHVybiB1bmRlZmluZWQ7IH0gZWxzZSB7IF94ID0gcGFyZW50OyBfeDIgPSBwcm9wZXJ0eTsgX3gzID0gcmVjZWl2ZXI7IF9hZ2FpbiA9IHRydWU7IGRlc2MgPSBwYXJlbnQgPSB1bmRlZmluZWQ7IGNvbnRpbnVlIF9mdW5jdGlvbjsgfSB9IGVsc2UgaWYgKCd2YWx1ZScgaW4gZGVzYykgeyByZXR1cm4gZGVzYy52YWx1ZTsgfSBlbHNlIHsgdmFyIGdldHRlciA9IGRlc2MuZ2V0OyBpZiAoZ2V0dGVyID09PSB1bmRlZmluZWQpIHsgcmV0dXJuIHVuZGVmaW5lZDsgfSByZXR1cm4gZ2V0dGVyLmNhbGwocmVjZWl2ZXIpOyB9IH0gfTsKCmZ1bmN0aW9uIF9pbnRlcm9wUmVxdWlyZURlZmF1bHQob2JqKSB7IHJldHVybiBvYmogJiYgb2JqLl9fZXNNb2R1bGUgPyBvYmogOiB7ICdkZWZhdWx0Jzogb2JqIH07IH0KCmZ1bmN0aW9uIF9jbGFzc0NhbGxDaGVjayhpbnN0YW5jZSwgQ29uc3RydWN0b3IpIHsgaWYgKCEoaW5zdGFuY2UgaW5zdGFuY2VvZiBDb25zdHJ1Y3RvcikpIHsgdGhyb3cgbmV3IFR5cGVFcnJvcignQ2Fubm90IGNhbGwgYSBjbGFzcyBhcyBhIGZ1bmN0aW9uJyk7IH0gfQoKZnVuY3Rpb24gX2luaGVyaXRzKHN1YkNsYXNzLCBzdXBlckNsYXNzKSB7IGlmICh0eXBlb2Ygc3VwZXJDbGFzcyAhPT0gJ2Z1bmN0aW9uJyAmJiBzdXBlckNsYXNzICE9PSBudWxsKSB7IHRocm93IG5ldyBUeXBlRXJyb3IoJ1N1cGVyIGV4cHJlc3Npb24gbXVzdCBlaXRoZXIgYmUgbnVsbCBvciBhIGZ1bmN0aW9uLCBub3QgJyArIHR5cGVvZiBzdXBlckNsYXNzKTsgfSBzdWJDbGFzcy5wcm90b3R5cGUgPSBPYmplY3QuY3JlYXRlKHN1cGVyQ2xhc3MgJiYgc3VwZXJDbGFzcy5wcm90b3R5cGUsIHsgY29uc3RydWN0b3I6IHsgdmFsdWU6IHN1YkNsYXNzLCBlbnVtZXJhYmxlOiBmYWxzZSwgd3JpdGFibGU6IHRydWUsIGNvbmZpZ3VyYWJsZTogdHJ1ZSB9IH0pOyBpZiAoc3VwZXJDbGFzcykgT2JqZWN0LnNldFByb3RvdHlwZU9mID8gT2JqZWN0LnNldFByb3RvdHlwZU9mKHN1YkNsYXNzLCBzdXBlckNsYXNzKSA6IHN1YkNsYXNzLl9fcHJvdG9fXyA9IHN1cGVyQ2xhc3M7IH0KCnJlcXVpcmUoJ3dlYnJ0Yy1hZGFwdGVyLXRlc3QnKTsKCnZhciBfdXRpbHNFdmVudEVtaXR0ZXIgPSByZXF1aXJlKCcuLi91dGlscy9FdmVudEVtaXR0ZXInKTsKCnZhciBfdXRpbHNFdmVudEVtaXR0ZXIyID0gX2ludGVyb3BSZXF1aXJlRGVmYXVsdChfdXRpbHNFdmVudEVtaXR0ZXIpOwoKdmFyIF9jb25uZWN0aW9uID0gcmVxdWlyZSgnLi9jb25uZWN0aW9uJyk7Cgp2YXIgX2Nvbm5lY3Rpb24yID0gX2ludGVyb3BSZXF1aXJlRGVmYXVsdChfY29ubmVjdGlvbik7Cgp2YXIgX3BlZXIgPSByZXF1aXJlKCcuL3BlZXInKTsKCnZhciBfcGVlcjIgPSBfaW50ZXJvcFJlcXVpcmVEZWZhdWx0KF9wZWVyKTsKCnZhciBDb25uZWN0aW9uQ29udHJvbGxlciA9IChmdW5jdGlvbiAoX0V2ZW50RW1pdHRlcikgewogIF9pbmhlcml0cyhDb25uZWN0aW9uQ29udHJvbGxlciwgX0V2ZW50RW1pdHRlcik7CgogIGZ1bmN0aW9uIENvbm5lY3Rpb25Db250cm9sbGVyKHN5bmNoZXIsIGRvbWFpbiwgY29uZmlndXJhdGlvbikgewogICAgX2NsYXNzQ2FsbENoZWNrKHRoaXMsIENvbm5lY3Rpb25Db250cm9sbGVyKTsKCiAgICBfZ2V0KE9iamVjdC5nZXRQcm90b3R5cGVPZihDb25uZWN0aW9uQ29udHJvbGxlci5wcm90b3R5cGUpLCAnY29uc3RydWN0b3InLCB0aGlzKS5jYWxsKHRoaXMsIHN5bmNoZXIsIGRvbWFpbiwgY29uZmlndXJhdGlvbik7CgogICAgdmFyIF90aGlzID0gdGhpczsKCiAgICBfdGhpcy5zeW5jaGVyID0gc3luY2hlcjsKICAgIF90aGlzLm1vZGUgPSAnb2ZmZXInOwoKICAgIF90aGlzLl9vYmplY3REZXNjVVJMID0gJ2h5cGVydHktY2F0YWxvZ3VlOi8vJyArIGRvbWFpbiArICcvLndlbGwta25vd24vZGF0YXNjaGVtYXMvRmFrZURhdGFTY2hlbWEnOwoKICAgIGNvbnNvbGUuaW5mbyhjb25maWd1cmF0aW9uKTsKCiAgICBfdGhpcy5tZWRpYUNvbnN0cmFpbnRzID0gY29uZmlndXJhdGlvbi5tZWRpYUNvbnN0cmFpbnRzOwogICAgX3RoaXMuY29uZmlndXJhdGlvbiA9IGNvbmZpZ3VyYXRpb24ud2VicnRjOwoKICAgIC8vIFByZXBhcmUgdGhlIFBlZXJDb25uZWN0aW9uCiAgICB2YXIgcGVlckNvbm5lY3Rpb24gPSBuZXcgUlRDUGVlckNvbm5lY3Rpb24oX3RoaXMuY29uZmlndXJhdGlvbik7CgogICAgcGVlckNvbm5lY3Rpb24uYWRkRXZlbnRMaXN0ZW5lcignc2lnbmFsaW5nc3RhdGVjaGFuZ2UnLCBmdW5jdGlvbiAoZXZlbnQpIHsKCiAgICAgIGNvbnNvbGUuaW5mbygnc2lnbmFsaW5nc3RhdGVjaGFuZ2UnLCBldmVudC5jdXJyZW50VGFyZ2V0LnNpZ25hbGluZ1N0YXRlKTsKCiAgICAgIGlmIChldmVudC5jdXJyZW50VGFyZ2V0LnNpZ25hbGluZ1N0YXRlID09PSAnaGF2ZS1sb2NhbC1vZmZlcicpIHsKICAgICAgICBfdGhpcy50cmlnZ2VyKCdjb250cm9sbGVyOnN0YXRlOmNoYW5nZScsIF90aGlzLm1vZGUpOwogICAgICB9CgogICAgICBpZiAoZXZlbnQuY3VycmVudFRhcmdldC5zaWduYWxpbmdTdGF0ZSA9PT0gJ2hhdmUtcmVtb3RlLW9mZmVyJykgewogICAgICAgIF90aGlzLm1vZGUgPSAnYW5zd2VyJzsKICAgICAgICBfdGhpcy50cmlnZ2VyKCdjb250cm9sbGVyOnN0YXRlOmNoYW5nZScsIF90aGlzLm1vZGUpOwogICAgICB9CiAgICB9KTsKCiAgICBwZWVyQ29ubmVjdGlvbi5hZGRFdmVudExpc3RlbmVyKCdpY2Vjb25uZWN0aW9uc3RhdGVjaGFuZ2UnLCBmdW5jdGlvbiAoZXZlbnQpIHsKICAgICAgY29uc29sZS5pbmZvKCdpY2Vjb25uZWN0aW9uc3RhdGVjaGFuZ2UnLCBldmVudC5jdXJyZW50VGFyZ2V0LmljZUNvbm5lY3Rpb25TdGF0ZSk7CiAgICAgIHZhciBkYXRhID0gX3RoaXMuX2RhdGFPYmplY3RSZXBvcnRlci5kYXRhOwogICAgICBpZiAoZGF0YS5oYXNPd25Qcm9wZXJ0eSgnY29ubmVjdGlvbicpKSB7CiAgICAgICAgZGF0YS5jb25uZWN0aW9uLnN0YXR1cyA9IGV2ZW50LmN1cnJlbnRUYXJnZXQuaWNlQ29ubmVjdGlvblN0YXRlOwogICAgICB9CiAgICB9KTsKCiAgICBwZWVyQ29ubmVjdGlvbi5hZGRFdmVudExpc3RlbmVyKCdpY2VjYW5kaWRhdGUnLCBmdW5jdGlvbiAoZXZlbnQpIHsKCiAgICAgIGlmICghZXZlbnQuY2FuZGlkYXRlKSByZXR1cm47CgogICAgICB2YXIgaWNlY2FuZGlkYXRlID0gewogICAgICAgIHR5cGU6ICdjYW5kaWRhdGUnLAogICAgICAgIGNhbmRpZGF0ZTogZXZlbnQuY2FuZGlkYXRlLmNhbmRpZGF0ZSwKICAgICAgICBzZHBNaWQ6IGV2ZW50LmNhbmRpZGF0ZS5zZHBNaWQsCiAgICAgICAgc2RwTUxpbmVJbmRleDogZXZlbnQuY2FuZGlkYXRlLnNkcE1MaW5lSW5kZXgKICAgICAgfTsKCiAgICAgIHZhciBkYXRhID0gX3RoaXMuX2RhdGFPYmplY3RSZXBvcnRlci5kYXRhOwoKICAgICAgaWYgKF90aGlzLm1vZGUgPT09ICdvZmZlcicpIHsKICAgICAgICBkYXRhLmNvbm5lY3Rpb24ub3duZXJQZWVyLmljZUNhbmRpZGF0ZXMucHVzaChpY2VjYW5kaWRhdGUpOwogICAgICB9IGVsc2UgewogICAgICAgIGRhdGEucGVlci5pY2VDYW5kaWRhdGVzLnB1c2goaWNlY2FuZGlkYXRlKTsKICAgICAgfQogICAgfSk7CgogICAgLy8gQWRkIHN0cmVhbSB0byBQZWVyQ29ubmVjdGlvbgogICAgcGVlckNvbm5lY3Rpb24uYWRkRXZlbnRMaXN0ZW5lcignYWRkc3RyZWFtJywgZnVuY3Rpb24gKGV2ZW50KSB7CiAgICAgIF90aGlzLnRyaWdnZXIoJ3N0cmVhbTphZGRlZCcsIFVSTC5jcmVhdGVPYmplY3RVUkwoZXZlbnQuc3RyZWFtKSwgX3RoaXMuZGF0YU9iamVjdFJlcG9ydGVyLCBfdGhpcy5kYXRhT2JqZWN0T2JzZXJ2ZXIpOwogICAgfSk7CgogICAgX3RoaXMucGVlckNvbm5lY3Rpb24gPSBwZWVyQ29ubmVjdGlvbjsKICB9CgogIC8vIFRPRE86IGNoZWNrIGlmIGl0IGlzIHJlYWx5IG5lY2Vzc2FyeSB0aGlzIHJlbW90ZVBlZXJJbmZvcm1hdGlvbjsKICAvKioKICAgKiBTZXQgUmVtb3RlIHBlZXIgaW5mb3JtYXRpb24sIGxpa2UgSHlwZXJ0eS4KICAgKiBAcGFyYW0gIHtPYmplY3R9IHJlbW90ZVBlZXJJbmZvcm1hdGlvbiBpbmZvcm1hdGlvbiBhYm91dCB0aGUgcGVlcjsKICAgKi8KCiAgX2NyZWF0ZUNsYXNzKENvbm5lY3Rpb25Db250cm9sbGVyLCBbewogICAga2V5OiAnZ2V0VXNlck1lZGlhJywKCiAgICAvKioKICAgICAqIEdldCBXZWJSVEMgQVBJIHJlc291cmNlcwogICAgICogQHBhcmFtICB7T2JqZWN0fSAgICAgb3B0aW9ucyBPYmplY3QgY29udGFpbmluZyB0aGUgaW5mb3JtYXRpb24gdGhhdCByZXNvdXJjZXMgd2lsbCBiZSB1c2VkIChjYW1lcmEsIG1pYywgcmVzb2x1dGlvbiwgZXRjKTsKICAgICAqIEByZXR1cm4ge1Byb21pc2V9CiAgICAgKi8KICAgIHZhbHVlOiBmdW5jdGlvbiBnZXRVc2VyTWVkaWEoY29uc3RyYWludHMpIHsKCiAgICAgIHZhciBfdGhpcyA9IHRoaXM7CgogICAgICByZXR1cm4gbmV3IFByb21pc2UoZnVuY3Rpb24gKHJlc29sdmUsIHJlamVjdCkgewoKICAgICAgICBuYXZpZ2F0b3IubWVkaWFEZXZpY2VzLmdldFVzZXJNZWRpYShjb25zdHJhaW50cykudGhlbihmdW5jdGlvbiAobWVkaWFTdHJlYW0pIHsKICAgICAgICAgIF90aGlzLnBlZXJDb25uZWN0aW9uLmFkZFN0cmVhbShtZWRpYVN0cmVhbSk7CiAgICAgICAgICByZXNvbHZlKG1lZGlhU3RyZWFtKTsKICAgICAgICB9KVsnY2F0Y2gnXShmdW5jdGlvbiAocmVhc29uKSB7CiAgICAgICAgICByZWplY3QocmVhc29uKTsKICAgICAgICB9KTsKICAgICAgfSk7CiAgICB9CiAgfSwgewogICAga2V5OiAnY2hhbmdlUGVlckluZm9ybWF0aW9uJywKICAgIHZhbHVlOiBmdW5jdGlvbiBjaGFuZ2VQZWVySW5mb3JtYXRpb24oZGF0YU9iamVjdE9ic2VydmVyKSB7CgogICAgICB2YXIgX3RoaXMgPSB0aGlzOwoKICAgICAgY29uc29sZS5pbmZvKEpTT04uc3RyaW5naWZ5KGRhdGFPYmplY3RPYnNlcnZlci5kYXRhKSk7CgogICAgICBfdGhpcy5wcm9jZXNzUGVlckluZm9ybWF0aW9uKGRhdGFPYmplY3RPYnNlcnZlci5kYXRhKTsKCiAgICAgIGRhdGFPYmplY3RPYnNlcnZlci5vbkNoYW5nZSgnKicsIGZ1bmN0aW9uIChldmVudCkgewogICAgICAgIGNvbnNvbGUuaW5mbygnT2JzZXJ2ZXIgb24gY2hhbmdlIG1lc3NhZ2U6ICcsIGV2ZW50KTsKICAgICAgICBfdGhpcy5wcm9jZXNzUGVlckluZm9ybWF0aW9uKGRhdGFPYmplY3RPYnNlcnZlci5kYXRhKTsKICAgICAgfSk7CiAgICB9CiAgfSwgewogICAga2V5OiAncHJvY2Vzc1BlZXJJbmZvcm1hdGlvbicsCiAgICB2YWx1ZTogZnVuY3Rpb24gcHJvY2Vzc1BlZXJJbmZvcm1hdGlvbihkYXRhKSB7CiAgICAgIHZhciBfdGhpcyA9IHRoaXM7CgogICAgICBjb25zb2xlLmRlYnVnKEpTT04uc3RyaW5naWZ5KGRhdGEpKTsKCiAgICAgIHZhciBpc093bmVyID0gZGF0YS5oYXNPd25Qcm9wZXJ0eSgnY29ubmVjdGlvbicpOwoKICAgICAgdmFyIGNvbm5lY3Rpb25EZXNjcmlwdGlvbiA9IGlzT3duZXIgPyBkYXRhLmNvbm5lY3Rpb24ub3duZXJQZWVyLmNvbm5lY3Rpb25EZXNjcmlwdGlvbiA6IGRhdGEucGVlci5jb25uZWN0aW9uRGVzY3JpcHRpb247CiAgICAgIHZhciBpY2VDYW5kaWRhdGVzID0gaXNPd25lciA/IGRhdGEuY29ubmVjdGlvbi5vd25lclBlZXIuaWNlQ2FuZGlkYXRlcyA6IGRhdGEucGVlci5pY2VDYW5kaWRhdGVzOwoKICAgICAgY29uc29sZS5sb2coY29ubmVjdGlvbkRlc2NyaXB0aW9uLCBpY2VDYW5kaWRhdGVzKTsKCiAgICAgIGlmIChjb25uZWN0aW9uRGVzY3JpcHRpb24udHlwZSA9PT0gJ29mZmVyJyB8fCBjb25uZWN0aW9uRGVzY3JpcHRpb24udHlwZSA9PT0gJ2Fuc3dlcicpIHsKICAgICAgICBjb25zb2xlLmluZm8oJ1Byb2Nlc3MgQ29ubmVjdGlvbiBEZXNjcmlwdGlvbjogJywgY29ubmVjdGlvbkRlc2NyaXB0aW9uKTsKICAgICAgICBfdGhpcy5wZWVyQ29ubmVjdGlvbi5zZXRSZW1vdGVEZXNjcmlwdGlvbihuZXcgUlRDU2Vzc2lvbkRlc2NyaXB0aW9uKGNvbm5lY3Rpb25EZXNjcmlwdGlvbiksIF90aGlzLnJlbW90ZURlc2NyaXB0aW9uU3VjY2VzcywgX3RoaXMucmVtb3RlRGVzY3JpcHRpb25FcnJvcik7CiAgICAgIH0KCiAgICAgIGlmIChpY2VDYW5kaWRhdGVzKSB7CiAgICAgICAgaWNlQ2FuZGlkYXRlcy5mb3JFYWNoKGZ1bmN0aW9uIChpY2UpIHsKICAgICAgICAgIGlmIChpY2UudHlwZSA9PT0gJ2NhbmRpZGF0ZScpIHsKICAgICAgICAgICAgY29uc29sZS5pbmZvKCdQcm9jZXNzIEljZSBDYW5kaWRhdGU6ICcsIGljZSk7CiAgICAgICAgICAgIF90aGlzLnBlZXJDb25uZWN0aW9uLmFkZEljZUNhbmRpZGF0ZShuZXcgUlRDSWNlQ2FuZGlkYXRlKHsgY2FuZGlkYXRlOiBpY2UuY2FuZGlkYXRlIH0pLCBfdGhpcy5yZW1vdGVEZXNjcmlwdGlvblN1Y2Nlc3MsIF90aGlzLnJlbW90ZURlc2NyaXB0aW9uRXJyb3IpOwogICAgICAgICAgfQogICAgICAgIH0pOwogICAgICB9CiAgICB9CiAgfSwgewogICAga2V5OiAncmVtb3RlRGVzY3JpcHRpb25TdWNjZXNzJywKICAgIHZhbHVlOiBmdW5jdGlvbiByZW1vdGVEZXNjcmlwdGlvblN1Y2Nlc3MoKSB7CiAgICAgIGNvbnNvbGUuaW5mbygncmVtb3RlIHN1Y2Nlc3MnKTsKICAgIH0KICB9LCB7CiAgICBrZXk6ICdyZW1vdGVEZXNjcmlwdGlvbkVycm9yJywKICAgIHZhbHVlOiBmdW5jdGlvbiByZW1vdGVEZXNjcmlwdGlvbkVycm9yKGVycm9yKSB7CiAgICAgIGNvbnNvbGUuZXJyb3IoJ2Vycm9yOiAnLCBlcnJvcik7CiAgICB9CiAgfSwgewogICAga2V5OiAnY3JlYXRlT2ZmZXInLAogICAgdmFsdWU6IGZ1bmN0aW9uIGNyZWF0ZU9mZmVyKCkgewogICAgICB2YXIgX3RoaXMgPSB0aGlzOwoKICAgICAgX3RoaXMucGVlckNvbm5lY3Rpb24uY3JlYXRlT2ZmZXIoZnVuY3Rpb24gKGRlc2NyaXB0aW9uKSB7CiAgICAgICAgX3RoaXMub25Mb2NhbFNlc3Npb25DcmVhdGVkKGRlc2NyaXB0aW9uKTsKICAgICAgfSwgX3RoaXMuaW5mb0Vycm9yLCBfdGhpcy5tZWRpYUNvbnN0cmFpbnRzKTsKICAgIH0KICB9LCB7CiAgICBrZXk6ICdjcmVhdGVBbnN3ZXInLAogICAgdmFsdWU6IGZ1bmN0aW9uIGNyZWF0ZUFuc3dlcigpIHsKICAgICAgdmFyIF90aGlzID0gdGhpczsKCiAgICAgIF90aGlzLnBlZXJDb25uZWN0aW9uLmNyZWF0ZUFuc3dlcihmdW5jdGlvbiAoZGVzY3JpcHRpb24pIHsKICAgICAgICBfdGhpcy5vbkxvY2FsU2Vzc2lvbkNyZWF0ZWQoZGVzY3JpcHRpb24pOwogICAgICB9LCBfdGhpcy5pbmZvRXJyb3IpOwogICAgfQogIH0sIHsKICAgIGtleTogJ29uTG9jYWxTZXNzaW9uQ3JlYXRlZCcsCiAgICB2YWx1ZTogZnVuY3Rpb24gb25Mb2NhbFNlc3Npb25DcmVhdGVkKGRlc2NyaXB0aW9uKSB7CgogICAgICB2YXIgX3RoaXMgPSB0aGlzOwoKICAgICAgX3RoaXMucGVlckNvbm5lY3Rpb24uc2V0TG9jYWxEZXNjcmlwdGlvbihkZXNjcmlwdGlvbiwgZnVuY3Rpb24gKCkgewoKICAgICAgICB2YXIgZGF0YSA9IF90aGlzLl9kYXRhT2JqZWN0UmVwb3J0ZXIuZGF0YTsKICAgICAgICB2YXIgc2RwQ29ubmVjdGlvbiA9IHsKICAgICAgICAgIHNkcDogZGVzY3JpcHRpb24uc2RwLAogICAgICAgICAgdHlwZTogZGVzY3JpcHRpb24udHlwZQogICAgICAgIH07CgogICAgICAgIGlmIChfdGhpcy5tb2RlID09PSAnb2ZmZXInKSB7CiAgICAgICAgICBkYXRhLmNvbm5lY3Rpb24ub3duZXJQZWVyLmNvbm5lY3Rpb25EZXNjcmlwdGlvbiA9IHNkcENvbm5lY3Rpb247CiAgICAgICAgfSBlbHNlIHsKICAgICAgICAgIGRhdGEucGVlci5jb25uZWN0aW9uRGVzY3JpcHRpb24gPSBzZHBDb25uZWN0aW9uOwogICAgICAgIH0KICAgICAgfSwgX3RoaXMuaW5mb0Vycm9yKTsKICAgIH0KICB9LCB7CiAgICBrZXk6ICdpbmZvRXJyb3InLAogICAgdmFsdWU6IGZ1bmN0aW9uIGluZm9FcnJvcihlcnIpIHsKICAgICAgY29uc29sZS5lcnJvcihlcnIudG9TdHJpbmcoKSwgZXJyKTsKICAgIH0KCiAgICAvKioKICAgICAqIFVzZWQgdG8gYWNjZXB0IGFuIGluY29taW5nIGNvbm5lY3Rpb24gcmVxdWVzdC4KICAgICAqIEBtZXRob2QgYWNjZXB0CiAgICAgKiBAcmV0dXJuIHtQcm9taXNlfQogICAgICovCiAgfSwgewogICAga2V5OiAnYWNjZXB0JywKICAgIHZhbHVlOiBmdW5jdGlvbiBhY2NlcHQob3B0aW9ucykgewoKICAgICAgdmFyIF90aGlzID0gdGhpczsKICAgICAgdmFyIHN5bmNoZXIgPSBfdGhpcy5zeW5jaGVyOwoKICAgICAgb3B0aW9ucyA9IG9wdGlvbnMgfHwgeyB2aWRlbzogdHJ1ZSwgYXVkaW86IHRydWUgfTsKCiAgICAgIGNvbnNvbGUubG9nKCdSZW1vdGUgUGVlciBJbmZvcm1hdGlvbjogJywgX3RoaXMuX3JlbW90ZVBlZXJJbmZvcm1hdGlvbik7CiAgICAgIHZhciByZW1vdGVQZWVyID0gX3RoaXMuX3JlbW90ZVBlZXJJbmZvcm1hdGlvbi5mcm9tOwoKICAgICAgcmV0dXJuIG5ldyBQcm9taXNlKGZ1bmN0aW9uIChyZXNvbHZlLCByZWplY3QpIHsKCiAgICAgICAgdHJ5IHsKCiAgICAgICAgICBjb25zb2xlLmluZm8oJy0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLSBTeW5jaGVyIENyZWF0ZSAtLS0tLS0tLS0tLS0tLS0tLS0tLS0tIFxuJyk7CiAgICAgICAgICBfdGhpcy5nZXRVc2VyTWVkaWEob3B0aW9ucykudGhlbihmdW5jdGlvbiAobWVkaWFDb25zdHJhaW50cykgewogICAgICAgICAgICBjb25zb2xlLmluZm8oJzEuIFJldHVybiBtZWRpYSBjb25zdHJhaW50cyAnLCBtZWRpYUNvbnN0cmFpbnRzKTsKICAgICAgICAgICAgcmV0dXJuIHN5bmNoZXIuY3JlYXRlKF90aGlzLl9vYmplY3REZXNjVVJMLCBbcmVtb3RlUGVlcl0sIHt9KTsKICAgICAgICAgIH0pLnRoZW4oZnVuY3Rpb24gKGRhdGFPYmplY3RSZXBvcnRlcikgewogICAgICAgICAgICBjb25zb2xlLmluZm8oJzIuIFJldHVybiB0aGUgRGF0YSBPYmplY3QgUmVwb3J0ZXIgJywgZGF0YU9iamVjdFJlcG9ydGVyKTsKICAgICAgICAgICAgX3RoaXMuZGF0YU9iamVjdFJlcG9ydGVyID0gZGF0YU9iamVjdFJlcG9ydGVyOwogICAgICAgICAgICByZXNvbHZlKCdhY2NlcHRlZCcpOwogICAgICAgICAgfSlbJ2NhdGNoJ10oZnVuY3Rpb24gKHJlYXNvbikgewogICAgICAgICAgICByZWplY3QocmVhc29uKTsKICAgICAgICAgIH0pOwogICAgICAgIH0gY2F0Y2ggKGUpIHsKICAgICAgICAgIHJlamVjdCgnZXJyb3IgYWNjZXB0aW5nIGNvbm5lY3Rpb24nKTsKICAgICAgICB9CiAgICAgIH0pOwogICAgfQoKICAgIC8qKgogICAgKiBVc2VkIHRvIGRlY2xpbmUgYW4gaW5jb21pbmcgY29ubmVjdGlvbiByZXF1ZXN0LgogICAgKiBAbWV0aG9kIGRlY2xpbmUKICAgICogQHJldHVybiB7UHJvbWlzZX0KICAgICovCiAgfSwgewogICAga2V5OiAnZGVjbGluZScsCiAgICB2YWx1ZTogZnVuY3Rpb24gZGVjbGluZSgpIHsKCiAgICAgIHZhciBfdGhpcyA9IHRoaXM7CiAgICAgIHZhciBzeW5jaGVyID0gX3RoaXMuc3luY2hlcjsKCiAgICAgIHJldHVybiBuZXcgUHJvbWlzZShmdW5jdGlvbiAocmVzb2x2ZSwgcmVqZWN0KSB7CgogICAgICAgIHRyeSB7CiAgICAgICAgICBjb25zb2xlLmxvZygnc3luY2hlcjogJywgc3luY2hlcik7CiAgICAgICAgICByZXNvbHZlKCdEZWNsaW5lZCcpOwogICAgICAgIH0gY2F0Y2ggKGUpIHsKICAgICAgICAgIHJlamVjdChlKTsKICAgICAgICB9CiAgICAgIH0pOwogICAgfQoKICAgIC8qKgogICAgICogVXNlZCB0byBjbG9zZSBhbiBleGlzdGluZyBjb25uZWN0aW9uIGluc3RhbmNlLgogICAgICogQG1ldGhvZCBkaXNjb25uZWN0CiAgICAgKiBAcmV0dXJuIHtQcm9taXNlfQogICAgICovCiAgfSwgewogICAga2V5OiAnZGlzY29ubmVjdCcsCiAgICB2YWx1ZTogZnVuY3Rpb24gZGlzY29ubmVjdCgpIHsKCiAgICAgIC8vIFRPRE86IG9wdGltaXplIHRoZSBkaXNjb25uZWN0IGZ1bmN0aW9uCgogICAgICB2YXIgX3RoaXMgPSB0aGlzOwoKICAgICAgcmV0dXJuIG5ldyBQcm9taXNlKGZ1bmN0aW9uIChyZXNvbHZlLCByZWplY3QpIHsKCiAgICAgICAgdHJ5IHsKCiAgICAgICAgICBfdGhpcy5wZWVyQ29ubmVjdGlvbi5jbG9zZSgpOwoKICAgICAgICAgIHJlc29sdmUodHJ1ZSk7CiAgICAgICAgfSBjYXRjaCAoZSkgewogICAgICAgICAgcmVqZWN0KCdlcnJvciBkaXNjb25uZWN0aW5nIGNvbm5lY3Rpb24nKTsKICAgICAgICB9CiAgICAgIH0pOwogICAgfQoKICAgIC8qKgogICAgICogVXNlZCB0byBhZGQvaW52aXRlIG5ldyBwZWVycyBvbiBhbiBleGlzdGluZyBjb25uZWN0aW9uIGluc3RhbmNlIChmb3IgbXVsdGlwYXJ0eSBjb25uZWN0aW9ucykuCiAgICAgKiBAbWV0aG9kIGFkZFBlZXIKICAgICAqIEByZXR1cm4ge1Byb21pc2V9CiAgICAgKi8KICB9LCB7CiAgICBrZXk6ICdhZGRQZWVyJywKICAgIHZhbHVlOiBmdW5jdGlvbiBhZGRQZWVyKCkge30KCiAgICAvKioKICAgICAqIFVzZWQgdG8gcmVtb3ZlIGEgcGVlciBmcm9tIGFuIGV4aXN0aW5nIGNvbm5lY3Rpb24gaW5zdGFuY2UuCiAgICAgKiBAbWV0aG9kIHJlbW92ZVBlZXIKICAgICAqIEByZXR1cm4ge1Byb21pc2V9CiAgICAgKi8KICB9LCB7CiAgICBrZXk6ICdyZW1vdmVQZWVyJywKICAgIHZhbHVlOiBmdW5jdGlvbiByZW1vdmVQZWVyKCkge30KCiAgICAvLyBQZWVyIEFjdGlvbnMKICB9LCB7CiAgICBrZXk6ICdkaXNhYmxlTWljJywKICAgIHZhbHVlOiBmdW5jdGlvbiBkaXNhYmxlTWljKCkgewogICAgICB2YXIgX3RoaXMgPSB0aGlzOwoKICAgICAgcmV0dXJuIG5ldyBQcm9taXNlKGZ1bmN0aW9uIChyZXNvbHZlLCByZWplY3QpIHsKCiAgICAgICAgdHJ5IHsKICAgICAgICAgIHZhciBsb2NhbFN0cmVhbSA9IF90aGlzLnBlZXJDb25uZWN0aW9uLmdldExvY2FsU3RyZWFtcygpWzBdOwogICAgICAgICAgdmFyIGF1ZGlvVHJhY2sgPSBsb2NhbFN0cmVhbS5nZXRBdWRpb1RyYWNrcygpWzBdOwoKICAgICAgICAgIGF1ZGlvVHJhY2suZW5hYmxlZCA9IGF1ZGlvVHJhY2suZW5hYmxlZCA/IGZhbHNlIDogdHJ1ZTsKICAgICAgICAgIHJlc29sdmUoYXVkaW9UcmFjay5lbmFibGVkKTsKICAgICAgICB9IGNhdGNoIChlKSB7CiAgICAgICAgICByZWplY3QoZSk7CiAgICAgICAgfQogICAgICB9KTsKICAgIH0KICB9LCB7CiAgICBrZXk6ICdkaXNhYmxlQ2FtJywKICAgIHZhbHVlOiBmdW5jdGlvbiBkaXNhYmxlQ2FtKCkgewogICAgICB2YXIgX3RoaXMgPSB0aGlzOwoKICAgICAgcmV0dXJuIG5ldyBQcm9taXNlKGZ1bmN0aW9uIChyZXNvbHZlLCByZWplY3QpIHsKCiAgICAgICAgdHJ5IHsKICAgICAgICAgIHZhciBsb2NhbFN0cmVhbSA9IF90aGlzLnBlZXJDb25uZWN0aW9uLmdldExvY2FsU3RyZWFtcygpWzBdOwogICAgICAgICAgdmFyIHZpZGVvVHJhY2sgPSBsb2NhbFN0cmVhbS5nZXRWaWRlb1RyYWNrcygpWzBdOwoKICAgICAgICAgIHZpZGVvVHJhY2suZW5hYmxlZCA9IHZpZGVvVHJhY2suZW5hYmxlZCA/IGZhbHNlIDogdHJ1ZTsKCiAgICAgICAgICByZXNvbHZlKHZpZGVvVHJhY2suZW5hYmxlZCk7CiAgICAgICAgfSBjYXRjaCAoZSkgewogICAgICAgICAgcmVqZWN0KGUpOwogICAgICAgIH0KICAgICAgfSk7CiAgICB9CiAgfSwgewogICAga2V5OiAnbXV0ZScsCiAgICB2YWx1ZTogZnVuY3Rpb24gbXV0ZSgpIHsKCiAgICAgIHZhciBfdGhpcyA9IHRoaXM7CgogICAgICByZXR1cm4gbmV3IFByb21pc2UoZnVuY3Rpb24gKHJlc29sdmUsIHJlamVjdCkgewoKICAgICAgICB0cnkgewogICAgICAgICAgdmFyIHJlbW90ZVN0cmVhbSA9IF90aGlzLnBlZXJDb25uZWN0aW9uLmdldFJlbW90ZVN0cmVhbXMoKVswXTsKICAgICAgICAgIHZhciBhdWRpb1RyYWNrID0gcmVtb3RlU3RyZWFtLmdldEF1ZGlvVHJhY2tzKClbMF07CgogICAgICAgICAgYXVkaW9UcmFjay5lbmFibGVkID0gYXVkaW9UcmFjay5lbmFibGVkID8gZmFsc2UgOiB0cnVlOwoKICAgICAgICAgIHJlc29sdmUoYXVkaW9UcmFjay5lbmFibGVkKTsKICAgICAgICB9IGNhdGNoIChlKSB7CiAgICAgICAgICByZWplY3QoZSk7CiAgICAgICAgfQogICAgICB9KTsKICAgIH0KICB9LCB7CiAgICBrZXk6ICdyZW1vdGVQZWVySW5mb3JtYXRpb24nLAogICAgc2V0OiBmdW5jdGlvbiBzZXQocmVtb3RlUGVlckluZm9ybWF0aW9uKSB7CiAgICAgIHZhciBfdGhpcyA9IHRoaXM7CiAgICAgIF90aGlzLl9yZW1vdGVQZWVySW5mb3JtYXRpb24gPSByZW1vdGVQZWVySW5mb3JtYXRpb247CiAgICB9LAoKICAgIC8qKgogICAgICogR2V0IGluZm9ybWF0aW9uIHJlbGF0aXZlIHRvIHRoZSBSZW1vdGUgUGVlcjsKICAgICAqIEByZXR1cm4ge09iamVjdH0gcmVtb3RlUGVlckluZm9ybWF0aW9uOwogICAgICovCiAgICBnZXQ6IGZ1bmN0aW9uIGdldCgpIHsKICAgICAgdmFyIF90aGlzID0gdGhpczsKICAgICAgcmV0dXJuIF90aGlzLl9yZW1vdGVQZWVySW5mb3JtYXRpb247CiAgICB9CgogICAgLyoqCiAgICAqIFNldCB0aGUgZGF0YU9iamVjdCBpbiB0aGUgY29udHJvbGxlcgogICAgKiBAcGFyYW0ge0Nvbm5lY3Rpb25EYXRhT2JqZWN0fSBkYXRhT2JqZWN0IC0gaGF2ZSBhbGwgaW5mb3JtYXRpb24gYWJvdXQgdGhlIHN5bmNoZXIgb2JqZWN0OwogICAgKi8KICB9LCB7CiAgICBrZXk6ICdkYXRhT2JqZWN0UmVwb3J0ZXInLAogICAgc2V0OiBmdW5jdGlvbiBzZXQoZGF0YU9iamVjdFJlcG9ydGVyKSB7CiAgICAgIGlmICghZGF0YU9iamVjdFJlcG9ydGVyKSB0aHJvdyBuZXcgRXJyb3IoJ1RoZSBEYXRhIE9iamVjdCBSZXBvcnRlciBpcyBhIG5lZWRlZCBwYXJhbWV0ZXInKTsKCiAgICAgIHZhciBfdGhpcyA9IHRoaXM7CiAgICAgIF90aGlzLl9kYXRhT2JqZWN0UmVwb3J0ZXIgPSBkYXRhT2JqZWN0UmVwb3J0ZXI7CgogICAgICB2YXIgZGF0YSA9IF90aGlzLl9kYXRhT2JqZWN0UmVwb3J0ZXIuZGF0YTsKCiAgICAgIGRhdGFPYmplY3RSZXBvcnRlci5vblN1YnNjcmlwdGlvbihmdW5jdGlvbiAoZXZlbnQpIHsKICAgICAgICBldmVudC5hY2NlcHQoKTsKICAgICAgfSk7CgogICAgICBpZiAoX3RoaXMubW9kZSA9PT0gJ29mZmVyJykgewogICAgICAgIGRhdGEuY29ubmVjdGlvbiA9IF9jb25uZWN0aW9uMlsnZGVmYXVsdCddOwoKICAgICAgICBfdGhpcy5jcmVhdGVPZmZlcigpOwogICAgICB9IGVsc2UgewogICAgICAgIGRhdGEucGVlciA9IF9wZWVyMlsnZGVmYXVsdCddOwoKICAgICAgICBfdGhpcy5jcmVhdGVBbnN3ZXIoKTsKICAgICAgfQoKICAgICAgY29uc29sZS5kZWJ1ZyhfdGhpcy5fZGF0YU9iamVjdFJlcG9ydGVyKTsKICAgIH0sCgogICAgLyoqCiAgICAqIHJldHVybiB0aGUgZGF0YU9iamVjdCBpbiB0aGUgY29udHJvbGxlcgogICAgKiBAcmV0dXJuIHtDb25uZWN0aW9uRGF0YU9iamVjdH0gZGF0YU9iamVjdAogICAgKi8KICAgIGdldDogZnVuY3Rpb24gZ2V0KCkgewogICAgICB2YXIgX3RoaXMgPSB0aGlzOwogICAgICByZXR1cm4gX3RoaXMuX2RhdGFPYmplY3RSZXBvcnRlcjsKICAgIH0KCiAgICAvKioKICAgICogU2V0IHRoZSBkYXRhT2JqZWN0IGluIHRoZSBjb250cm9sbGVyCiAgICAqIEBwYXJhbSB7Q29ubmVjdGlvbkRhdGFPYmplY3R9IGRhdGFPYmplY3QgLSBoYXZlIGFsbCBpbmZvcm1hdGlvbiBhYm91dCB0aGUgc3luY2hlciBvYmplY3Q7CiAgICAqLwogIH0sIHsKICAgIGtleTogJ2RhdGFPYmplY3RPYnNlcnZlcicsCiAgICBzZXQ6IGZ1bmN0aW9uIHNldChkYXRhT2JqZWN0T2JzZXJ2ZXIpIHsKICAgICAgaWYgKCFkYXRhT2JqZWN0T2JzZXJ2ZXIpIHRocm93IG5ldyBFcnJvcignVGhlIERhdGEgT2JqZWN0IE9ic2VydmVyIGlzIGEgbmVlZGVkIHBhcmFtZXRlcicpOwoKICAgICAgdmFyIF90aGlzID0gdGhpczsKICAgICAgX3RoaXMuX2RhdGFPYmplY3RPYnNlcnZlciA9IGRhdGFPYmplY3RPYnNlcnZlcjsKICAgICAgX3RoaXMuY2hhbmdlUGVlckluZm9ybWF0aW9uKGRhdGFPYmplY3RPYnNlcnZlcik7CiAgICB9LAoKICAgIC8qKgogICAgKiByZXR1cm4gdGhlIGRhdGFPYmplY3QgaW4gdGhlIGNvbnRyb2xsZXIKICAgICogQHJldHVybiB7Q29ubmVjdGlvbkRhdGFPYmplY3R9IGRhdGFPYmplY3QKICAgICovCiAgICBnZXQ6IGZ1bmN0aW9uIGdldCgpIHsKICAgICAgdmFyIF90aGlzID0gdGhpczsKICAgICAgcmV0dXJuIF90aGlzLl9kYXRhT2JqZWN0T2JzZXJ2ZXI7CiAgICB9CiAgfV0pOwoKICByZXR1cm4gQ29ubmVjdGlvbkNvbnRyb2xsZXI7Cn0pKF91dGlsc0V2ZW50RW1pdHRlcjJbJ2RlZmF1bHQnXSk7CgpleHBvcnRzWydkZWZhdWx0J10gPSBDb25uZWN0aW9uQ29udHJvbGxlcjsKbW9kdWxlLmV4cG9ydHMgPSBleHBvcnRzWydkZWZhdWx0J107Cgp9LHsiLi4vdXRpbHMvRXZlbnRFbWl0dGVyIjoxNCwiLi9jb25uZWN0aW9uIjo0LCIuL3BlZXIiOjUsIndlYnJ0Yy1hZGFwdGVyLXRlc3QiOjF9XSwzOltmdW5jdGlvbihyZXF1aXJlLG1vZHVsZSxleHBvcnRzKXsKLyoganNoaW50IHVuZGVmOiB0cnVlICovCgondXNlIHN0cmljdCc7CgpPYmplY3QuZGVmaW5lUHJvcGVydHkoZXhwb3J0cywgJ19fZXNNb2R1bGUnLCB7CiAgdmFsdWU6IHRydWUKfSk7Cgp2YXIgX2NyZWF0ZUNsYXNzID0gKGZ1bmN0aW9uICgpIHsgZnVuY3Rpb24gZGVmaW5lUHJvcGVydGllcyh0YXJnZXQsIHByb3BzKSB7IGZvciAodmFyIGkgPSAwOyBpIDwgcHJvcHMubGVuZ3RoOyBpKyspIHsgdmFyIGRlc2NyaXB0b3IgPSBwcm9wc1tpXTsgZGVzY3JpcHRvci5lbnVtZXJhYmxlID0gZGVzY3JpcHRvci5lbnVtZXJhYmxlIHx8IGZhbHNlOyBkZXNjcmlwdG9yLmNvbmZpZ3VyYWJsZSA9IHRydWU7IGlmICgndmFsdWUnIGluIGRlc2NyaXB0b3IpIGRlc2NyaXB0b3Iud3JpdGFibGUgPSB0cnVlOyBPYmplY3QuZGVmaW5lUHJvcGVydHkodGFyZ2V0LCBkZXNjcmlwdG9yLmtleSwgZGVzY3JpcHRvcik7IH0gfSByZXR1cm4gZnVuY3Rpb24gKENvbnN0cnVjdG9yLCBwcm90b1Byb3BzLCBzdGF0aWNQcm9wcykgeyBpZiAocHJvdG9Qcm9wcykgZGVmaW5lUHJvcGVydGllcyhDb25zdHJ1Y3Rvci5wcm90b3R5cGUsIHByb3RvUHJvcHMpOyBpZiAoc3RhdGljUHJvcHMpIGRlZmluZVByb3BlcnRpZXMoQ29uc3RydWN0b3IsIHN0YXRpY1Byb3BzKTsgcmV0dXJuIENvbnN0cnVjdG9yOyB9OyB9KSgpOwoKdmFyIF9nZXQgPSBmdW5jdGlvbiBnZXQoX3gsIF94MiwgX3gzKSB7IHZhciBfYWdhaW4gPSB0cnVlOyBfZnVuY3Rpb246IHdoaWxlIChfYWdhaW4pIHsgdmFyIG9iamVjdCA9IF94LCBwcm9wZXJ0eSA9IF94MiwgcmVjZWl2ZXIgPSBfeDM7IF9hZ2FpbiA9IGZhbHNlOyBpZiAob2JqZWN0ID09PSBudWxsKSBvYmplY3QgPSBGdW5jdGlvbi5wcm90b3R5cGU7IHZhciBkZXNjID0gT2JqZWN0LmdldE93blByb3BlcnR5RGVzY3JpcHRvcihvYmplY3QsIHByb3BlcnR5KTsgaWYgKGRlc2MgPT09IHVuZGVmaW5lZCkgeyB2YXIgcGFyZW50ID0gT2JqZWN0LmdldFByb3RvdHlwZU9mKG9iamVjdCk7IGlmIChwYXJlbnQgPT09IG51bGwpIHsgcmV0dXJuIHVuZGVmaW5lZDsgfSBlbHNlIHsgX3ggPSBwYXJlbnQ7IF94MiA9IHByb3BlcnR5OyBfeDMgPSByZWNlaXZlcjsgX2FnYWluID0gdHJ1ZTsgZGVzYyA9IHBhcmVudCA9IHVuZGVmaW5lZDsgY29udGludWUgX2Z1bmN0aW9uOyB9IH0gZWxzZSBpZiAoJ3ZhbHVlJyBpbiBkZXNjKSB7IHJldHVybiBkZXNjLnZhbHVlOyB9IGVsc2UgeyB2YXIgZ2V0dGVyID0gZGVzYy5nZXQ7IGlmIChnZXR0ZXIgPT09IHVuZGVmaW5lZCkgeyByZXR1cm4gdW5kZWZpbmVkOyB9IHJldHVybiBnZXR0ZXIuY2FsbChyZWNlaXZlcik7IH0gfSB9OwoKZXhwb3J0c1snZGVmYXVsdCddID0gYWN0aXZhdGU7CgpmdW5jdGlvbiBfaW50ZXJvcFJlcXVpcmVEZWZhdWx0KG9iaikgeyByZXR1cm4gb2JqICYmIG9iai5fX2VzTW9kdWxlID8gb2JqIDogeyAnZGVmYXVsdCc6IG9iaiB9OyB9CgpmdW5jdGlvbiBfY2xhc3NDYWxsQ2hlY2soaW5zdGFuY2UsIENvbnN0cnVjdG9yKSB7IGlmICghKGluc3RhbmNlIGluc3RhbmNlb2YgQ29uc3RydWN0b3IpKSB7IHRocm93IG5ldyBUeXBlRXJyb3IoJ0Nhbm5vdCBjYWxsIGEgY2xhc3MgYXMgYSBmdW5jdGlvbicpOyB9IH0KCmZ1bmN0aW9uIF9pbmhlcml0cyhzdWJDbGFzcywgc3VwZXJDbGFzcykgeyBpZiAodHlwZW9mIHN1cGVyQ2xhc3MgIT09ICdmdW5jdGlvbicgJiYgc3VwZXJDbGFzcyAhPT0gbnVsbCkgeyB0aHJvdyBuZXcgVHlwZUVycm9yKCdTdXBlciBleHByZXNzaW9uIG11c3QgZWl0aGVyIGJlIG51bGwgb3IgYSBmdW5jdGlvbiwgbm90ICcgKyB0eXBlb2Ygc3VwZXJDbGFzcyk7IH0gc3ViQ2xhc3MucHJvdG90eXBlID0gT2JqZWN0LmNyZWF0ZShzdXBlckNsYXNzICYmIHN1cGVyQ2xhc3MucHJvdG90eXBlLCB7IGNvbnN0cnVjdG9yOiB7IHZhbHVlOiBzdWJDbGFzcywgZW51bWVyYWJsZTogZmFsc2UsIHdyaXRhYmxlOiB0cnVlLCBjb25maWd1cmFibGU6IHRydWUgfSB9KTsgaWYgKHN1cGVyQ2xhc3MpIE9iamVjdC5zZXRQcm90b3R5cGVPZiA/IE9iamVjdC5zZXRQcm90b3R5cGVPZihzdWJDbGFzcywgc3VwZXJDbGFzcykgOiBzdWJDbGFzcy5fX3Byb3RvX18gPSBzdXBlckNsYXNzOyB9Cgp2YXIgX2h5cGVydHlEaXNjb3ZlcnlIeXBlcnR5RGlzY292ZXJ5ID0gcmVxdWlyZSgnLi4vaHlwZXJ0eS1kaXNjb3ZlcnkvSHlwZXJ0eURpc2NvdmVyeScpOwoKdmFyIF9oeXBlcnR5RGlzY292ZXJ5SHlwZXJ0eURpc2NvdmVyeTIgPSBfaW50ZXJvcFJlcXVpcmVEZWZhdWx0KF9oeXBlcnR5RGlzY292ZXJ5SHlwZXJ0eURpc2NvdmVyeSk7Cgp2YXIgX0Nvbm5lY3Rpb25Db250cm9sbGVyID0gcmVxdWlyZSgnLi9Db25uZWN0aW9uQ29udHJvbGxlcicpOwoKdmFyIF9Db25uZWN0aW9uQ29udHJvbGxlcjIgPSBfaW50ZXJvcFJlcXVpcmVEZWZhdWx0KF9Db25uZWN0aW9uQ29udHJvbGxlcik7Cgp2YXIgX3V0aWxzRXZlbnRFbWl0dGVyID0gcmVxdWlyZSgnLi4vdXRpbHMvRXZlbnRFbWl0dGVyJyk7Cgp2YXIgX3V0aWxzRXZlbnRFbWl0dGVyMiA9IF9pbnRlcm9wUmVxdWlyZURlZmF1bHQoX3V0aWxzRXZlbnRFbWl0dGVyKTsKCnZhciBfc3luY2hlclN5bmNoZXIgPSByZXF1aXJlKCcuLi9zeW5jaGVyL1N5bmNoZXInKTsKCnZhciBfc3luY2hlclN5bmNoZXIyID0gX2ludGVyb3BSZXF1aXJlRGVmYXVsdChfc3luY2hlclN5bmNoZXIpOwoKdmFyIF91dGlsc1V0aWxzID0gcmVxdWlyZSgnLi4vdXRpbHMvdXRpbHMnKTsKCi8qKgoqIEh5cGVydHkgQ29ubmVjdG9yOwoqIEBhdXRob3IgVml0b3IgU2lsdmEgW3ZpdG9yLXQtc2lsdmFAdGVsZWNvbS5wdF0KKiBAdmVyc2lvbiAwLjEuMAoqLwoKdmFyIEh5cGVydHlDb25uZWN0b3IgPSAoZnVuY3Rpb24gKF9FdmVudEVtaXR0ZXIpIHsKICBfaW5oZXJpdHMoSHlwZXJ0eUNvbm5lY3RvciwgX0V2ZW50RW1pdHRlcik7CgogIC8qKgogICogQ3JlYXRlIGEgbmV3IEh5cGVydHkgQ29ubmVjdG9yCiAgKiBAcGFyYW0gIHtTeW5jaGVyfSBzeW5jaGVyIC0gU3luY2hlciBwcm92aWRlZCBmcm9tIHRoZSBydW50aW1lIGNvcmUKICAqLwoKICBmdW5jdGlvbiBIeXBlcnR5Q29ubmVjdG9yKGh5cGVydHlVUkwsIGJ1cywgY29uZmlndXJhdGlvbikgewogICAgX2NsYXNzQ2FsbENoZWNrKHRoaXMsIEh5cGVydHlDb25uZWN0b3IpOwoKICAgIGlmICghaHlwZXJ0eVVSTCkgdGhyb3cgbmV3IEVycm9yKCdUaGUgaHlwZXJ0eVVSTCBpcyBhIG5lZWRlZCBwYXJhbWV0ZXInKTsKICAgIGlmICghYnVzKSB0aHJvdyBuZXcgRXJyb3IoJ1RoZSBNaW5pQnVzIGlzIGEgbmVlZGVkIHBhcmFtZXRlcicpOwogICAgaWYgKCFjb25maWd1cmF0aW9uKSB0aHJvdyBuZXcgRXJyb3IoJ1RoZSBjb25maWd1cmF0aW9uIGlzIGEgbmVlZGVkIHBhcmFtZXRlcicpOwoKICAgIF9nZXQoT2JqZWN0LmdldFByb3RvdHlwZU9mKEh5cGVydHlDb25uZWN0b3IucHJvdG90eXBlKSwgJ2NvbnN0cnVjdG9yJywgdGhpcykuY2FsbCh0aGlzLCBoeXBlcnR5VVJMLCBidXMsIGNvbmZpZ3VyYXRpb24pOwoKICAgIHZhciBfdGhpcyA9IHRoaXM7CiAgICBfdGhpcy5faHlwZXJ0eVVSTCA9IGh5cGVydHlVUkw7CiAgICBfdGhpcy5fYnVzID0gYnVzOwogICAgX3RoaXMuX2NvbmZpZ3VyYXRpb24gPSBjb25maWd1cmF0aW9uOwogICAgX3RoaXMuX2RvbWFpbiA9ICgwLCBfdXRpbHNVdGlscy5kaXZpZGVVUkwpKGh5cGVydHlVUkwpLmRvbWFpbjsKCiAgICBfdGhpcy5fb2JqZWN0RGVzY1VSTCA9ICdoeXBlcnR5LWNhdGFsb2d1ZTovLycgKyBfdGhpcy5fZG9tYWluICsgJy8ud2VsbC1rbm93bi9kYXRhc2NoZW1hcy9GYWtlRGF0YVNjaGVtYSc7CgogICAgX3RoaXMuX2NvbnRyb2xsZXJzID0ge307CgogICAgdmFyIGRvbWFpbiA9ICgwLCBfdXRpbHNVdGlscy5kaXZpZGVVUkwpKGh5cGVydHlVUkwpLmRvbWFpbjsKICAgIF90aGlzLmh5cGVydHlEaXNjb3ZlcnkgPSBuZXcgX2h5cGVydHlEaXNjb3ZlcnlIeXBlcnR5RGlzY292ZXJ5MlsnZGVmYXVsdCddKGRvbWFpbiwgYnVzKTsKCiAgICB2YXIgc3luY2hlciA9IG5ldyBfc3luY2hlclN5bmNoZXIyWydkZWZhdWx0J10oaHlwZXJ0eVVSTCwgYnVzLCBjb25maWd1cmF0aW9uKTsKICAgIHN5bmNoZXIub25Ob3RpZmljYXRpb24oZnVuY3Rpb24gKGV2ZW50KSB7CiAgICAgIF90aGlzLl9vbk5vdGlmaWNhdGlvbihldmVudCk7CiAgICB9KTsKCiAgICBfdGhpcy5fc3luY2hlciA9IHN5bmNoZXI7CiAgfQoKICBfY3JlYXRlQ2xhc3MoSHlwZXJ0eUNvbm5lY3RvciwgW3sKICAgIGtleTogJ19vbk5vdGlmaWNhdGlvbicsCiAgICB2YWx1ZTogZnVuY3Rpb24gX29uTm90aWZpY2F0aW9uKGV2ZW50KSB7CgogICAgICB2YXIgX3RoaXMgPSB0aGlzOwoKICAgICAgY29uc29sZS5pbmZvKCctLS0tLS0tLS0tLS0gQWNrbm93bGVkZ2VzIHRoZSBSZXBvcnRlciAtLS0tLS0tLS0tLS0gXG4nKTsKICAgICAgZXZlbnQuYWNrKCk7CiAgICAgIGNvbnNvbGUuaW5mbygnLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tIEVORCAtLS0tLS0tLS0tLS0tLS0tLS0tLS0tIFxuJyk7CgogICAgICBjb25zb2xlLmxvZyhfdGhpcy5fY29udHJvbGxlcnNbZXZlbnQuZnJvbV0pOwogICAgICBpZiAoX3RoaXMuX2NvbnRyb2xsZXJzW2V2ZW50LmZyb21dKSB7CiAgICAgICAgX3RoaXMuX2F1dG9TdWJzY3JpYmUoZXZlbnQpOwogICAgICB9IGVsc2UgewogICAgICAgIF90aGlzLl9hdXRvQWNjZXB0KGV2ZW50KTsKICAgICAgfQogICAgfQogIH0sIHsKICAgIGtleTogJ19hdXRvQWNjZXB0JywKICAgIHZhbHVlOiBmdW5jdGlvbiBfYXV0b0FjY2VwdChldmVudCkgewogICAgICB2YXIgX3RoaXMgPSB0aGlzOwogICAgICB2YXIgc3luY2hlciA9IF90aGlzLl9zeW5jaGVyOwoKICAgICAgY29uc29sZS5pbmZvKCctLS0tLS0tLS0tLS0tLS0tIFN5bmNoZXIgU3Vic2NyaWJlIC0tLS0tLS0tLS0tLS0tLS0gXG4nKTsKICAgICAgY29uc29sZS5pbmZvKCdTdWJzY3JpYmUgVVJMIE9iamVjdCAnLCBldmVudCwgc3luY2hlcik7CgogICAgICBzeW5jaGVyLnN1YnNjcmliZShfdGhpcy5fb2JqZWN0RGVzY1VSTCwgZXZlbnQudXJsKS50aGVuKGZ1bmN0aW9uIChkYXRhT2JqZWN0T2JzZXJ2ZXIpIHsKICAgICAgICBjb25zb2xlLmluZm8oJzEuIFJldHVybiBTdWJzY3JpYmUgRGF0YSBPYmplY3QgT2JzZXJ2ZXInLCBkYXRhT2JqZWN0T2JzZXJ2ZXIpOwoKICAgICAgICB2YXIgY29ubmVjdGlvbkNvbnRyb2xsZXIgPSBuZXcgX0Nvbm5lY3Rpb25Db250cm9sbGVyMlsnZGVmYXVsdCddKHN5bmNoZXIsIF90aGlzLl9kb21haW4sIF90aGlzLl9jb25maWd1cmF0aW9uKTsKCiAgICAgICAgLy8gVE9ETzogcmVtb3ZlIHRoaXMgcmVtb3RlUGVlckluZm9ybWF0aW9uOwogICAgICAgIGNvbm5lY3Rpb25Db250cm9sbGVyLnJlbW90ZVBlZXJJbmZvcm1hdGlvbiA9IGV2ZW50OwogICAgICAgIGNvbm5lY3Rpb25Db250cm9sbGVyLmRhdGFPYmplY3RPYnNlcnZlciA9IGRhdGFPYmplY3RPYnNlcnZlcjsKCiAgICAgICAgY29uc29sZS5pbmZvKCcyLiBEYXRhIE9iamVjdCBPYnNlcnZlciBkYXRhOiAnLCBKU09OLnN0cmluZ2lmeShkYXRhT2JqZWN0T2JzZXJ2ZXIuZGF0YSkpOwoKICAgICAgICBfdGhpcy50cmlnZ2VyKCdjb25uZWN0b3I6Y29ubmVjdGVkJywgY29ubmVjdGlvbkNvbnRyb2xsZXIpOwogICAgICAgIF90aGlzLnRyaWdnZXIoJ2hhdmU6bm90aWZpY2F0aW9uJywgZXZlbnQpOwoKICAgICAgICBjb25zb2xlLmluZm8oJy0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLSBFTkQgLS0tLS0tLS0tLS0tLS0tLS0tLS0tLSBcbicpOwogICAgICB9KVsnY2F0Y2gnXShmdW5jdGlvbiAocmVhc29uKSB7CiAgICAgICAgY29uc29sZS5lcnJvcihyZWFzb24pOwogICAgICB9KTsKICAgIH0KICB9LCB7CiAgICBrZXk6ICdfYXV0b1N1YnNjcmliZScsCiAgICB2YWx1ZTogZnVuY3Rpb24gX2F1dG9TdWJzY3JpYmUoZXZlbnQpIHsKICAgICAgdmFyIF90aGlzID0gdGhpczsKICAgICAgdmFyIHN5bmNoZXIgPSBfdGhpcy5fc3luY2hlcjsKCiAgICAgIGNvbnNvbGUuaW5mbygnLS0tLS0tLS0tLS0tLS0tLSBTeW5jaGVyIFN1YnNjcmliZSAtLS0tLS0tLS0tLS0tLS0tIFxuJyk7CiAgICAgIGNvbnNvbGUuaW5mbygnU3Vic2NyaWJlIFVSTCBPYmplY3QgJywgZXZlbnQsIHN5bmNoZXIpOwogICAgICBzeW5jaGVyLnN1YnNjcmliZShfdGhpcy5fb2JqZWN0RGVzY1VSTCwgZXZlbnQudXJsKS50aGVuKGZ1bmN0aW9uIChkYXRhT2JqZWN0T2JzZXJ2ZXIpIHsKICAgICAgICBjb25zb2xlLmluZm8oJzEuIFJldHVybiBTdWJzY3JpYmUgRGF0YSBPYmplY3QgT2JzZXJ2ZXInLCBkYXRhT2JqZWN0T2JzZXJ2ZXIpOwoKICAgICAgICBfdGhpcy5fY29udHJvbGxlcnNbZXZlbnQuZnJvbV0uZGF0YU9iamVjdE9ic2VydmVyID0gZGF0YU9iamVjdE9ic2VydmVyOwogICAgICB9KVsnY2F0Y2gnXShmdW5jdGlvbiAocmVhc29uKSB7CiAgICAgICAgY29uc29sZS5lcnJvcihyZWFzb24pOwogICAgICB9KTsKICAgIH0KCiAgICAvKioKICAgICogRXN0YWJsaXNoIGNvbm5lY3Rpb24gd2l0aCBvdGhlciBjbGllbnQgaWRlbnRpZmllcgogICAgKiBAcGFyYW0gIHtIeXBlcnR5VVJMfSBIeXBlcnR5VVJMIC0gRGVmaW5lIHRoZSBpZGVudGlmaWVyIG9mIHRoZSBvdGhlciBjb21wb25lbnQKICAgICogQHBhcmFtICB7T2JqZWN0fSBvcHRpb25zIC0gT2JqZWN0IHdpdGggb3B0aW9ucyB0byBpbXByb3ZlIHRoZSBjb25uZWN0CiAgICAqLwogIH0sIHsKICAgIGtleTogJ2Nvbm5lY3QnLAogICAgdmFsdWU6IGZ1bmN0aW9uIGNvbm5lY3QoaHlwZXJ0eVVSTCwgb3B0aW9ucykgewogICAgICAvLyBUT0RPOiBDSGFuZ2UgdGhlIGh5cGVydHlVUkwgZm9yIGEgbGlzdCBvZiBVUkxTCiAgICAgIHZhciBfdGhpcyA9IHRoaXM7CiAgICAgIHZhciBzeW5jaGVyID0gX3RoaXMuX3N5bmNoZXI7CgogICAgICBvcHRpb25zID0gb3B0aW9ucyB8fCB7IHZpZGVvOiB0cnVlLCBhdWRpbzogdHJ1ZSB9OwoKICAgICAgcmV0dXJuIG5ldyBQcm9taXNlKGZ1bmN0aW9uIChyZXNvbHZlLCByZWplY3QpIHsKCiAgICAgICAgdmFyIGNvbm5lY3Rpb25Db250cm9sbGVyID0gdW5kZWZpbmVkOwoKICAgICAgICBjb25zb2xlLmluZm8oJy0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLSBTeW5jaGVyIENyZWF0ZSAtLS0tLS0tLS0tLS0tLS0tLS0tLS0tIFxuJyk7CiAgICAgICAgY29ubmVjdGlvbkNvbnRyb2xsZXIgPSBuZXcgX0Nvbm5lY3Rpb25Db250cm9sbGVyMlsnZGVmYXVsdCddKHN5bmNoZXIsIF90aGlzLl9kb21haW4sIF90aGlzLl9jb25maWd1cmF0aW9uKTsKCiAgICAgICAgY29ubmVjdGlvbkNvbnRyb2xsZXIuZ2V0VXNlck1lZGlhKG9wdGlvbnMpLnRoZW4oZnVuY3Rpb24gKG1lZGlhQ29uc3RyYWludHMpIHsKICAgICAgICAgIGNvbnNvbGUuaW5mbygnMi4gUmV0dXJuIHRoZSBtZWRpYSBjb25zdHJhaW50cyBmcm9tIGNvbnRyb2xsZXI6ICcsIG1lZGlhQ29uc3RyYWludHMpOwoKICAgICAgICAgIHJldHVybiBzeW5jaGVyLmNyZWF0ZShfdGhpcy5fb2JqZWN0RGVzY1VSTCwgW2h5cGVydHlVUkxdLCB7fSk7CiAgICAgICAgfSkudGhlbihmdW5jdGlvbiAoZGF0YU9iamVjdFJlcG9ydGVyKSB7CiAgICAgICAgICBjb25zb2xlLmluZm8oJzEuIFJldHVybiBDcmVhdGUgRGF0YSBPYmplY3QgUmVwb3J0ZXInLCBkYXRhT2JqZWN0UmVwb3J0ZXIpOwogICAgICAgICAgY29ubmVjdGlvbkNvbnRyb2xsZXIuZGF0YU9iamVjdFJlcG9ydGVyID0gZGF0YU9iamVjdFJlcG9ydGVyOwoKICAgICAgICAgIF90aGlzLl9jb250cm9sbGVyc1toeXBlcnR5VVJMXSA9IGNvbm5lY3Rpb25Db250cm9sbGVyOwoKICAgICAgICAgIHJlc29sdmUoY29ubmVjdGlvbkNvbnRyb2xsZXIpOwogICAgICAgICAgY29uc29sZS5pbmZvKCctLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0gRU5EIC0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLSBcbicpOwogICAgICAgIH0pWydjYXRjaCddKGZ1bmN0aW9uIChyZWFzb24pIHsKICAgICAgICAgIGNvbnNvbGUuZXJyb3IocmVhc29uKTsKICAgICAgICAgIHJlamVjdChyZWFzb24pOwogICAgICAgIH0pOwogICAgICB9KTsKICAgIH0KCiAgICAvLyAvKioKICAgIC8vICogQWNjZXB0IHRoZSBpbmNvbWluZyBjYWxsCiAgICAvLyAqIEBtZXRob2QgYWNjZXB0CiAgICAvLyAqIEByZXR1cm4ge1Byb21pc2V9CiAgICAvLyAqLwogICAgLy8gYWNjZXB0KCkgewogICAgLy8gICBsZXQgX3RoaXMgPSB0aGlzOwogICAgLy8KICAgIC8vICAgcmV0dXJuIG5ldyBQcm9taXNlKGZ1bmN0aW9uKHJlc29sdmUsIHJlamVjdCkgewogICAgLy8KICAgIC8vICAgICBsZXQgb2JqZWN0VVJMID0gX3RoaXMubm90aWZpY2F0aW9uRXZlbnQudXJsOwogICAgLy8KICAgIC8vICAgICAvLyBzdGVwIDYgLSBodHRwczovL2dpdGh1Yi5jb20vcmVUSElOSy1wcm9qZWN0L3NjZW5hcmlvLXNlcnZpY2UtaW1wbGVtZW50YXRpb24vdHJlZS9tYXN0ZXIvZG9jcy9oeXBlcnRpZXMvY29ubmVjdG9yI25vdGlmaWNhdGlvbi1hYm91dC1pbmNvbWluZy1jb25uZWN0aW9uLXJlcXVlc3QKICAgIC8vICAgICAvLyBhZnRlciB3YWl0aW5nIGZvciBhbiBhbnN3ZXIsIHdlIGNhbiBub3cgc3Vic2NyaWJlIHRoZSBvYmplY3RVUkwKICAgIC8vICAgICBfdGhpcy5fc3luY2hlci5zdWJzY3JpYmUob2JqZWN0VVJMKS50aGVuKGZ1bmN0aW9uKGNvbm5lY3Rpb25EYXRhT2JqZWN0KSB7CiAgICAvLyAgICAgICBjb25zb2xlLmluZm8oJ1JldHVybiBTdWJzY3JpYmUgQ29ubmVjdGlvbiBEYXRhIE9iamVjdCcsIGNvbm5lY3Rpb25EYXRhT2JqZWN0KTsKICAgIC8vCiAgICAvLyAgICAgICAvLyBzdGVwIDcgYW5kIDEwIC0gaHR0cHM6Ly9naXRodWIuY29tL3JlVEhJTkstcHJvamVjdC9zY2VuYXJpby1zZXJ2aWNlLWltcGxlbWVudGF0aW9uL3RyZWUvbWFzdGVyL2RvY3MvaHlwZXJ0aWVzL2Nvbm5lY3RvciNub3RpZmljYXRpb24tYWJvdXQtaW5jb21pbmctY29ubmVjdGlvbi1yZXF1ZXN0CiAgICAvLyAgICAgICBfdGhpcy5jb25uZWN0aW9uQ29udHJvbGxlci5kYXRhT2JqZWN0T2JzZXJ2ZXIgPSBjb25uZWN0aW9uRGF0YU9iamVjdDsKICAgIC8vICAgICAgIHJlc29sdmUoX3RoaXMuY29ubmVjdGlvbkNvbnRyb2xsZXIpOwogICAgLy8KICAgIC8vICAgICAgIGxldCByZXNvdXJjZXMgPSBjb25uZWN0aW9uRGF0YU9iamVjdC5kYXRhLnJlc291cmNlczsKICAgIC8vICAgICAgIHJldHVybiBfdGhpcy5jb25uZWN0aW9uQ29udHJvbGxlci5nZXRVc2VyTWVkaWEocmVzb3VyY2VzKTsKICAgIC8vICAgICB9KQogICAgLy8gICAgIC50aGVuKGZ1bmN0aW9uKGNvbW1SZXNvdXJjZXMpIHsKICAgIC8vICAgICAgIGNvbnNvbGUuaW5mbygnR2V0IHdlYlJUQyBjb21tb24gcmVzb3VyY2VzJywgY29tbVJlc291cmNlcyk7CiAgICAvLyAgICAgfSkKICAgIC8vICAgICAuY2F0Y2goZnVuY3Rpb24ocmVhc29uKSB7CiAgICAvLyAgICAgICBjb25zb2xlLmVycm9yKHJlYXNvbik7CiAgICAvLyAgICAgICByZWplY3QocmVhc29uKTsKICAgIC8vICAgICB9KTsKICAgIC8vICAgfSk7CiAgICAvLyB9CiAgICAvLwogICAgLy8gLyoqCiAgICAvLyAqIENvbm5lY3Rpb24gaXMgY2xvc2VkIGJ5IGxvY2FsIHBlZXIgYW5kIGRpc2Nvbm5lY3RlZDsKICAgIC8vICogQG1ldGhvZCBkaXNjb25uZWN0CiAgICAvLyAqIEByZXR1cm4ge1Byb21pc2V9CiAgICAvLyAqLwogICAgLy8gZGlzY29ubmVjdCgpIHsKICAgIC8vCiAgICAvLyAgIGxldCBfdGhpcyA9IHRoaXM7CiAgICAvLwogICAgLy8gICByZXR1cm4gbmV3IFByb21pc2UoZnVuY3Rpb24ocmVzb2x2ZSwgcmVqZWN0KSB7CiAgICAvLwogICAgLy8gICAgIF90aGlzLmNvbm5lY3Rpb25Db250cm9sbGVyLmRpc2Nvbm5lY3QoKQogICAgLy8gICAgIC50aGVuKGZ1bmN0aW9uKGRpc2Nvbm5lY3RlZCkgewogICAgLy8KICAgIC8vICAgICAgIGNvbnNvbGUuaW5mbygnZGlzY29ubmVjdGVkOiAnLCBkaXNjb25uZWN0ZWQpOwogICAgLy8KICAgIC8vICAgICAgIHJlc29sdmUoZGlzY29ubmVjdGVkKTsKICAgIC8vICAgICB9KQogICAgLy8gICAgIC5jYXRjaChmdW5jdGlvbihyZWFzb24pIHsKICAgIC8vICAgICAgIHJlamVjdChyZWFzb24pOwogICAgLy8gICAgIH0pOwogICAgLy8KICAgIC8vICAgfSk7CiAgICAvLwogICAgLy8gfQogICAgLy8KICAgIC8vIF9hdXRvQ29ubmVjdChoeXBlcnR5VVJMKSB7CiAgICAvLyAgIGxldCBfdGhpcyA9IHRoaXM7CiAgICAvLwogICAgLy8gICBfdGhpcy5fc3luY2hlci5jcmVhdGUoe30sIFtoeXBlcnR5VVJMXSwge30pLnRoZW4oZnVuY3Rpb24oY29ubmVjdGlvbkRhdGFPYmplY3QpIHsKICAgIC8vICAgICBjb25zb2xlLmluZm8oJ1JldHVybiBDcmVhdGUgQ29ubmVjdGlvbiBEYXRhIE9iamVjdCcsIGNvbm5lY3Rpb25EYXRhT2JqZWN0KTsKICAgIC8vICAgICBfdGhpcy5jb25uZWN0aW9uQ29udHJvbGxlci5jb25uZWN0aW9uRGF0YU9iamVjdFJlcG9ydGVyID0gY29ubmVjdGlvbkRhdGFPYmplY3Q7CiAgICAvLyAgIH0pLmNhdGNoKGZ1bmN0aW9uKHJlYXNvbikgewogICAgLy8gICAgIGNvbnNvbGUuZXJyb3IocmVhc29uKTsKICAgIC8vICAgfSk7CiAgICAvLyB9CgogIH1dKTsKCiAgcmV0dXJuIEh5cGVydHlDb25uZWN0b3I7Cn0pKF91dGlsc0V2ZW50RW1pdHRlcjJbJ2RlZmF1bHQnXSk7CgpmdW5jdGlvbiBhY3RpdmF0ZShoeXBlcnR5VVJMLCBidXMsIGNvbmZpZ3VyYXRpb24pIHsKCiAgcmV0dXJuIHsKICAgIG5hbWU6ICdIeXBlcnR5Q29ubmVjdG9yJywKICAgIGluc3RhbmNlOiBuZXcgSHlwZXJ0eUNvbm5lY3RvcihoeXBlcnR5VVJMLCBidXMsIGNvbmZpZ3VyYXRpb24pCiAgfTsKfQoKbW9kdWxlLmV4cG9ydHMgPSBleHBvcnRzWydkZWZhdWx0J107Cgp9LHsiLi4vaHlwZXJ0eS1kaXNjb3ZlcnkvSHlwZXJ0eURpc2NvdmVyeSI6NiwiLi4vc3luY2hlci9TeW5jaGVyIjoxMywiLi4vdXRpbHMvRXZlbnRFbWl0dGVyIjoxNCwiLi4vdXRpbHMvdXRpbHMiOjE1LCIuL0Nvbm5lY3Rpb25Db250cm9sbGVyIjoyfV0sNDpbZnVuY3Rpb24ocmVxdWlyZSxtb2R1bGUsZXhwb3J0cyl7Ci8vIGRhdGFPYmplY3RSZXBvcnRlci5kYXRhID0gewovLyAgICBzdGF0dXMgOiAiY29ubmVjdGVkIiwKLy8gICAgb3duZXIgOiAiaHlwZXJ0eTovL2V4YW1wbGUuY29tL2FsaWNlaHkiLAovLyAgICBwZWVyIDogImNvbm5lY3Rpb246Ly9leGFtcGxlLmNvbS9hbGljZS9ib2IyNzAxMjAxNiIsCi8vICAgIG93bmVyUGVlciA6IHsKLy8gICAgICAgICAgY29ubmVjdGlvbkRlc2NyaXB0aW9uOiB7Ci8vICAgICAgICAgICAgIHNkcDogJ3M0ZGZhZjFzYTNmMWFzZDVmNHNkYWZhJywKLy8gICAgICAgICAgICAgdHlwZTogJ29mZmVyJwovLyAgICAgICAgICB9LAovLyAgICAgICAgICBpY2VDYW5kaWRhdGVzOiBbewovLyAgICAgICAgICAgICAgdHlwZTogJ2NhbmRpZGF0ZScsCi8vICAgICAgICAgICAgICBjYW5kaWRhdGU6IGV2ZW50LmNhbmRpZGF0ZS5jYW5kaWRhdGUsCi8vICAgICAgICAgICAgICBzZHBNaWQ6IGV2ZW50LmNhbmRpZGF0ZS5zZHBNaWQsCi8vICAgICAgICAgICAgICBzZHBNTGluZUluZGV4OiBldmVudC5jYW5kaWRhdGUuc2RwTUxpbmVJbmRleAovLyAgICAgICAgICAgIH0sCi8vICAgICAgICAgICAgewovLyAgICAgICAgICAgICAgdHlwZTogJ2NhbmRpZGF0ZScsCi8vICAgICAgICAgICAgICBjYW5kaWRhdGU6IGV2ZW50LmNhbmRpZGF0ZS5jYW5kaWRhdGUsCi8vICAgICAgICAgICAgICBzZHBNaWQ6IGV2ZW50LmNhbmRpZGF0ZS5zZHBNaWQsCi8vICAgICAgICAgICAgICBzZHBNTGluZUluZGV4OiBldmVudC5jYW5kaWRhdGUuc2RwTUxpbmVJbmRleAovLyAgICAgICAgICAgIH0sCi8vICAgICAgICAgICAgLi4uLi4KLy8gICAgICAgIF0KLy8gICAgICB9Ci8vICB9CgoidXNlIHN0cmljdCI7CgpPYmplY3QuZGVmaW5lUHJvcGVydHkoZXhwb3J0cywgIl9fZXNNb2R1bGUiLCB7CiAgIHZhbHVlOiB0cnVlCn0pOwp2YXIgY29ubmVjdGlvbiA9IHsKICAgc3RhdHVzOiAiY29ubmVjdGVkIiwKICAgb3duZXI6ICJoeXBlcnR5Oi8vZXhhbXBsZS5jb20vYWxpY2VoeSIsCiAgIHBlZXI6ICJjb25uZWN0aW9uOi8vZXhhbXBsZS5jb20vYWxpY2UvYm9iMjcwMTIwMTYiLAogICBvd25lclBlZXI6IHsKICAgICAgY29ubmVjdGlvbkRlc2NyaXB0aW9uOiB7fSwKICAgICAgaWNlQ2FuZGlkYXRlczogW10KICAgfQp9OwoKZXhwb3J0c1siZGVmYXVsdCJdID0gY29ubmVjdGlvbjsKbW9kdWxlLmV4cG9ydHMgPSBleHBvcnRzWyJkZWZhdWx0Il07Cgp9LHt9XSw1OltmdW5jdGlvbihyZXF1aXJlLG1vZHVsZSxleHBvcnRzKXsKInVzZSBzdHJpY3QiOwoKT2JqZWN0LmRlZmluZVByb3BlcnR5KGV4cG9ydHMsICJfX2VzTW9kdWxlIiwgewogIHZhbHVlOiB0cnVlCn0pOwp2YXIgcGVlciA9IHsKICBjb25uZWN0aW9uRGVzY3JpcHRpb246IHt9LAogIGljZUNhbmRpZGF0ZXM6IFtdCn07CgpleHBvcnRzWyJkZWZhdWx0Il0gPSBwZWVyOwptb2R1bGUuZXhwb3J0cyA9IGV4cG9ydHNbImRlZmF1bHQiXTsKCn0se31dLDY6W2Z1bmN0aW9uKHJlcXVpcmUsbW9kdWxlLGV4cG9ydHMpewovKioKKiBDb3JlIEh5cGVydHlEaXNjb3ZlcnkgaW50ZXJmYWNlCiogQ2xhc3MgdG8gYWxsb3cgYXBwbGljYXRpb25zIHRvIHNlYXJjaCBmb3IgaHlwZXJ0aWVzIHVzaW5nIHRoZSBtZXNzYWdlIGJ1cwoqLwondXNlIHN0cmljdCc7CgpPYmplY3QuZGVmaW5lUHJvcGVydHkoZXhwb3J0cywgJ19fZXNNb2R1bGUnLCB7CiAgdmFsdWU6IHRydWUKfSk7Cgp2YXIgX2NyZWF0ZUNsYXNzID0gKGZ1bmN0aW9uICgpIHsgZnVuY3Rpb24gZGVmaW5lUHJvcGVydGllcyh0YXJnZXQsIHByb3BzKSB7IGZvciAodmFyIGkgPSAwOyBpIDwgcHJvcHMubGVuZ3RoOyBpKyspIHsgdmFyIGRlc2NyaXB0b3IgPSBwcm9wc1tpXTsgZGVzY3JpcHRvci5lbnVtZXJhYmxlID0gZGVzY3JpcHRvci5lbnVtZXJhYmxlIHx8IGZhbHNlOyBkZXNjcmlwdG9yLmNvbmZpZ3VyYWJsZSA9IHRydWU7IGlmICgndmFsdWUnIGluIGRlc2NyaXB0b3IpIGRlc2NyaXB0b3Iud3JpdGFibGUgPSB0cnVlOyBPYmplY3QuZGVmaW5lUHJvcGVydHkodGFyZ2V0LCBkZXNjcmlwdG9yLmtleSwgZGVzY3JpcHRvcik7IH0gfSByZXR1cm4gZnVuY3Rpb24gKENvbnN0cnVjdG9yLCBwcm90b1Byb3BzLCBzdGF0aWNQcm9wcykgeyBpZiAocHJvdG9Qcm9wcykgZGVmaW5lUHJvcGVydGllcyhDb25zdHJ1Y3Rvci5wcm90b3R5cGUsIHByb3RvUHJvcHMpOyBpZiAoc3RhdGljUHJvcHMpIGRlZmluZVByb3BlcnRpZXMoQ29uc3RydWN0b3IsIHN0YXRpY1Byb3BzKTsgcmV0dXJuIENvbnN0cnVjdG9yOyB9OyB9KSgpOwoKZnVuY3Rpb24gX2NsYXNzQ2FsbENoZWNrKGluc3RhbmNlLCBDb25zdHJ1Y3RvcikgeyBpZiAoIShpbnN0YW5jZSBpbnN0YW5jZW9mIENvbnN0cnVjdG9yKSkgeyB0aHJvdyBuZXcgVHlwZUVycm9yKCdDYW5ub3QgY2FsbCBhIGNsYXNzIGFzIGEgZnVuY3Rpb24nKTsgfSB9Cgp2YXIgSHlwZXJ0eURpc2NvdmVyeSA9IChmdW5jdGlvbiAoKSB7CgogIC8qKgogICogVG8gaW5pdGlhbGlzZSB0aGUgSHlwZXJ0eURpc2NvdmVyLCB3aGljaCB3aWxsIHByb3ZpZGUgdGhlIHN1cHBvcnQgZm9yIGh5cGVydGllcyB0bwogICogcXVlcnkgdXNlcnMgcmVnaXN0ZXJlZCBpbiBvdXRzaWRlIHRoZSBpbnRlcm5hbCBjb3JlLgogICogQHBhcmFtICB7TWVzc2FnZUJ1c30gICAgICAgICAgbXNnYnVzICAgICAgICAgICAgICAgIG1zZ2J1cwogICogQHBhcmFtICB7UnVudGltZVVSTH0gICAgICAgICAgcnVudGltZVVSTCAgICAgICAgICAgIHJ1bnRpbWVVUkwKICAqLwoKICBmdW5jdGlvbiBIeXBlcnR5RGlzY292ZXJ5KGRvbWFpbiwgbXNnQnVzKSB7CiAgICBfY2xhc3NDYWxsQ2hlY2sodGhpcywgSHlwZXJ0eURpc2NvdmVyeSk7CgogICAgdmFyIF90aGlzID0gdGhpczsKICAgIF90aGlzLm1lc3NhZ2VCdXMgPSBtc2dCdXM7CgogICAgX3RoaXMuZG9tYWluID0gZG9tYWluOwogICAgX3RoaXMuZGlzY292ZXJ5VVJMID0gJ2h5cGVydHk6Ly8nICsgZG9tYWluICsgJy9oeXBlcnR5RGlzb3ZlcnknOwogIH0KCiAgLyoqCiAgKiBmdW5jdGlvbiB0byByZXF1ZXN0IGFib3V0IHVzZXJzIHJlZ2lzdGVyZWQgaW4gZG9tYWluIHJlZ2lzdHJ5LCBhbmQKICAqIHJldHVybiB0aGUgaHlwZXJ0eSBpbnN0YW5jZSBpZiBmb3VuZC4KICAqIEBwYXJhbSAge2VtYWlsfSAgICAgICAgICAgICAgZW1haWwKICAqIEByZXR1cm4ge1Byb21pc2V9ICAgICAgICAgIFByb21pc2UKICAqLwoKICBfY3JlYXRlQ2xhc3MoSHlwZXJ0eURpc2NvdmVyeSwgW3sKICAgIGtleTogJ2Rpc2NvdmVySHlwZXJ0eVBlclVzZXInLAogICAgdmFsdWU6IGZ1bmN0aW9uIGRpc2NvdmVySHlwZXJ0eVBlclVzZXIoZW1haWwpIHsKICAgICAgdmFyIF90aGlzID0gdGhpczsKICAgICAgdmFyIGlkZW50aXR5VVJMID0gJ3VzZXI6Ly8nICsgZW1haWwuc3Vic3RyaW5nKGVtYWlsLmluZGV4T2YoJ0AnKSArIDEsIGVtYWlsLmxlbmd0aCkgKyAnLycgKyBlbWFpbC5zdWJzdHJpbmcoMCwgZW1haWwuaW5kZXhPZignQCcpKTsKCiAgICAgIC8vIG1lc3NhZ2UgdG8gcXVlcnkgZG9tYWluIHJlZ2lzdHJ5LCBhc2tpbmcgZm9yIGEgdXNlciBoeXBlcnR5LgogICAgICB2YXIgbWVzc2FnZSA9IHsKICAgICAgICB0eXBlOiAnUkVBRCcsIGZyb206IF90aGlzLmRpc2NvdmVyeVVSTCwgdG86ICdkb21haW46Ly9yZWdpc3RyeS4nICsgX3RoaXMuZG9tYWluICsgJy8nLCBib2R5OiB7IHJlc291cmNlOiBpZGVudGl0eVVSTCB9CiAgICAgIH07CgogICAgICByZXR1cm4gbmV3IFByb21pc2UoZnVuY3Rpb24gKHJlc29sdmUsIHJlamVjdCkgewoKICAgICAgICBfdGhpcy5tZXNzYWdlQnVzLnBvc3RNZXNzYWdlKG1lc3NhZ2UsIGZ1bmN0aW9uIChyZXBseSkgewogICAgICAgICAgLy9jb25zb2xlLmxvZygnTUVTU0FHRScsIHJlcGx5KTsKCiAgICAgICAgICB2YXIgaHlwZXJ0eSA9IHVuZGVmaW5lZDsKICAgICAgICAgIHZhciBtb3N0UmVjZW50ID0gdW5kZWZpbmVkOwogICAgICAgICAgdmFyIGxhc3RIeXBlcnR5ID0gdW5kZWZpbmVkOwogICAgICAgICAgdmFyIHZhbHVlID0gcmVwbHkuYm9keS52YWx1ZTsKCiAgICAgICAgICAvL2NvbnNvbGUubG9nKCd2YWx1ZVBhcnNlZCcsIHZhbHVlUGFyc2VkKTsKICAgICAgICAgIGZvciAoaHlwZXJ0eSBpbiB2YWx1ZSkgewogICAgICAgICAgICBpZiAodmFsdWVbaHlwZXJ0eV0ubGFzdE1vZGlmaWVkICE9PSB1bmRlZmluZWQpIHsKICAgICAgICAgICAgICBpZiAobW9zdFJlY2VudCA9PT0gdW5kZWZpbmVkKSB7CiAgICAgICAgICAgICAgICBtb3N0UmVjZW50ID0gbmV3IERhdGUodmFsdWVbaHlwZXJ0eV0ubGFzdE1vZGlmaWVkKTsKICAgICAgICAgICAgICAgIGxhc3RIeXBlcnR5ID0gaHlwZXJ0eTsKICAgICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgdmFyIGh5cGVydHlEYXRlID0gbmV3IERhdGUodmFsdWVbaHlwZXJ0eV0ubGFzdE1vZGlmaWVkKTsKICAgICAgICAgICAgICAgIGlmIChtb3N0UmVjZW50LmdldFRpbWUoKSA8IGh5cGVydHlEYXRlLmdldFRpbWUoKSkgewogICAgICAgICAgICAgICAgICBtb3N0UmVjZW50ID0gaHlwZXJ0eURhdGU7CiAgICAgICAgICAgICAgICAgIGxhc3RIeXBlcnR5ID0gaHlwZXJ0eTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KICAgICAgICAgIH0KICAgICAgICAgIHZhciBoeXBlcnR5VVJMID0gbGFzdEh5cGVydHk7CgogICAgICAgICAgaWYgKGh5cGVydHlVUkwgPT09IHVuZGVmaW5lZCkgewogICAgICAgICAgICByZXR1cm4gcmVqZWN0KCdVc2VyIEh5cGVydHkgbm90IGZvdW5kJyk7CiAgICAgICAgICB9CgogICAgICAgICAgdmFyIGlkUGFja2FnZSA9IHsKICAgICAgICAgICAgaWQ6IGVtYWlsLAogICAgICAgICAgICBkZXNjcmlwdG9yOiB2YWx1ZVtoeXBlcnR5VVJMXS5kZXNjcmlwdG9yLAogICAgICAgICAgICBoeXBlcnR5VVJMOiBoeXBlcnR5VVJMCiAgICAgICAgICB9OwoKICAgICAgICAgIGNvbnNvbGUubG9nKCc9PT0+IFJlZ2lzdGVySHlwZXJ0eSBtZXNzYWdlQnVuZGxlOiAnLCBpZFBhY2thZ2UpOwogICAgICAgICAgcmVzb2x2ZShpZFBhY2thZ2UpOwogICAgICAgIH0pOwogICAgICB9KTsKICAgIH0KICB9XSk7CgogIHJldHVybiBIeXBlcnR5RGlzY292ZXJ5Owp9KSgpOwoKZXhwb3J0c1snZGVmYXVsdCddID0gSHlwZXJ0eURpc2NvdmVyeTsKbW9kdWxlLmV4cG9ydHMgPSBleHBvcnRzWydkZWZhdWx0J107Cgp9LHt9XSw3OltmdW5jdGlvbihyZXF1aXJlLG1vZHVsZSxleHBvcnRzKXsKJ3VzZSBzdHJpY3QnOwoKT2JqZWN0LmRlZmluZVByb3BlcnR5KGV4cG9ydHMsICdfX2VzTW9kdWxlJywgewogIHZhbHVlOiB0cnVlCn0pOwoKdmFyIF9jcmVhdGVDbGFzcyA9IChmdW5jdGlvbiAoKSB7IGZ1bmN0aW9uIGRlZmluZVByb3BlcnRpZXModGFyZ2V0LCBwcm9wcykgeyBmb3IgKHZhciBpID0gMDsgaSA8IHByb3BzLmxlbmd0aDsgaSsrKSB7IHZhciBkZXNjcmlwdG9yID0gcHJvcHNbaV07IGRlc2NyaXB0b3IuZW51bWVyYWJsZSA9IGRlc2NyaXB0b3IuZW51bWVyYWJsZSB8fCBmYWxzZTsgZGVzY3JpcHRvci5jb25maWd1cmFibGUgPSB0cnVlOyBpZiAoJ3ZhbHVlJyBpbiBkZXNjcmlwdG9yKSBkZXNjcmlwdG9yLndyaXRhYmxlID0gdHJ1ZTsgT2JqZWN0LmRlZmluZVByb3BlcnR5KHRhcmdldCwgZGVzY3JpcHRvci5rZXksIGRlc2NyaXB0b3IpOyB9IH0gcmV0dXJuIGZ1bmN0aW9uIChDb25zdHJ1Y3RvciwgcHJvdG9Qcm9wcywgc3RhdGljUHJvcHMpIHsgaWYgKHByb3RvUHJvcHMpIGRlZmluZVByb3BlcnRpZXMoQ29uc3RydWN0b3IucHJvdG90eXBlLCBwcm90b1Byb3BzKTsgaWYgKHN0YXRpY1Byb3BzKSBkZWZpbmVQcm9wZXJ0aWVzKENvbnN0cnVjdG9yLCBzdGF0aWNQcm9wcyk7IHJldHVybiBDb25zdHJ1Y3RvcjsgfTsgfSkoKTsKCmZ1bmN0aW9uIF9pbnRlcm9wUmVxdWlyZURlZmF1bHQob2JqKSB7IHJldHVybiBvYmogJiYgb2JqLl9fZXNNb2R1bGUgPyBvYmogOiB7ICdkZWZhdWx0Jzogb2JqIH07IH0KCmZ1bmN0aW9uIF9jbGFzc0NhbGxDaGVjayhpbnN0YW5jZSwgQ29uc3RydWN0b3IpIHsgaWYgKCEoaW5zdGFuY2UgaW5zdGFuY2VvZiBDb25zdHJ1Y3RvcikpIHsgdGhyb3cgbmV3IFR5cGVFcnJvcignQ2Fubm90IGNhbGwgYSBjbGFzcyBhcyBhIGZ1bmN0aW9uJyk7IH0gfQoKdmFyIF9TeW5jT2JqZWN0ID0gcmVxdWlyZSgnLi9TeW5jT2JqZWN0Jyk7Cgp2YXIgX1N5bmNPYmplY3QyID0gX2ludGVyb3BSZXF1aXJlRGVmYXVsdChfU3luY09iamVjdCk7Cgp2YXIgX0RhdGFPYmplY3RDaGlsZCA9IHJlcXVpcmUoJy4vRGF0YU9iamVjdENoaWxkJyk7Cgp2YXIgX0RhdGFPYmplY3RDaGlsZDIgPSBfaW50ZXJvcFJlcXVpcmVEZWZhdWx0KF9EYXRhT2JqZWN0Q2hpbGQpOwoKdmFyIF91dGlsc1V0aWxzSnMgPSByZXF1aXJlKCcuLi91dGlscy91dGlscy5qcycpOwoKLyoqCiAqIE1haW4gZXh0ZW5zaW9uIGNsYXNzIGZvciBvYnNlcnZlcnMgYW5kIHJlcG9ydGVycywgd2l0aCBjb21tb24gcHJvcGVydGllcyBhbmQgbWV0aG9kcy4KICogQ2hpbGRyZW4gbWFuYWdlbWVudCBpcyBjb21tb24gZm9yIG9ic2VydmVycyBhbmQgcmVwb3J0ZXJzLgogKi8KCnZhciBEYXRhT2JqZWN0ID0gKGZ1bmN0aW9uICgpIHsKICAvKiBwcml2YXRlCiAgX3ZlcnNpb246IG51bWJlcgogICBfb3duZXI6IEh5cGVydHlVUkwKICBfdXJsOiBPYmplY3RVUkwKICBfc2NoZW1hOiBTY2hlbWEKICBfYnVzOiBNaW5pQnVzCiAgX3N0YXR1czogb24gfCBwYXVzZWQKICBfc3luY09iajogU3luY0RhdGEKICAgX2NoaWxkcmVuOiB7IGlkOiBEYXRhT2JqZWN0Q2hpbGQgfQogICAtLS0tZXZlbnQgaGFuZGxlcnMtLS0tCiAgX29uQWRkQ2hpbGRyZW5IYW5kbGVyOiAoZXZlbnQpID0+IHZvaWQKICAqLwoKICAvKioKICAgKiBAaWdub3JlCiAgICogU2hvdWxkIG5vdCBiZSB1c2VkIGRpcmVjdGx5IGJ5IEh5cGVydGllcy4gSXQncyBjYWxsZWQgYnkgdGhlIFN5bmNoZXIgY3JlYXRlIG9yIHN1YnNjcmliZSBtZXRob2QncwogICAqLwoKICBmdW5jdGlvbiBEYXRhT2JqZWN0KG93bmVyLCB1cmwsIHNjaGVtYSwgYnVzLCBpbml0aWFsU3RhdHVzLCBpbml0aWFsRGF0YSwgY2hpbGRyZW4pIHsKICAgIHZhciBfdGhpczIgPSB0aGlzOwoKICAgIF9jbGFzc0NhbGxDaGVjayh0aGlzLCBEYXRhT2JqZWN0KTsKCiAgICB2YXIgX3RoaXMgPSB0aGlzOwoKICAgIF90aGlzLl92ZXJzaW9uID0gMDsKCiAgICBfdGhpcy5fb3duZXIgPSBvd25lcjsKICAgIF90aGlzLl91cmwgPSB1cmw7CiAgICBfdGhpcy5fc2NoZW1hID0gc2NoZW1hOwogICAgX3RoaXMuX2J1cyA9IGJ1czsKICAgIF90aGlzLl9zdGF0dXMgPSBpbml0aWFsU3RhdHVzOwogICAgX3RoaXMuX3N5bmNPYmogPSBuZXcgX1N5bmNPYmplY3QyWydkZWZhdWx0J10oaW5pdGlhbERhdGEpOwoKICAgIF90aGlzLl9jaGlsZElkID0gMDsKICAgIF90aGlzLl9jaGlsZHJlbiA9IHt9OwoKICAgIHZhciBjaGlsZEJhc2VVUkwgPSB1cmwgKyAnL2NoaWxkcmVuLyc7CgogICAgaWYgKGNoaWxkcmVuKSB7CiAgICAgIGNoaWxkcmVuLmZvckVhY2goZnVuY3Rpb24gKGNoaWxkKSB7CiAgICAgICAgdmFyIGNoaWxkVVJMID0gY2hpbGRCYXNlVVJMICsgY2hpbGQ7CiAgICAgICAgYnVzLmFkZExpc3RlbmVyKGNoaWxkVVJMLCBmdW5jdGlvbiAobXNnKSB7CiAgICAgICAgICAvL2lnbm9yZSBtc2cgc2VudCBieSBoaW1zZWxmCiAgICAgICAgICBpZiAobXNnLmZyb20gIT09IF90aGlzMi5fb3duZXIpIHsKICAgICAgICAgICAgc3dpdGNoIChtc2cudHlwZSkgewogICAgICAgICAgICAgIGNhc2UgJ2NyZWF0ZSc6CiAgICAgICAgICAgICAgICBfdGhpcy5fb25DaGlsZHJlbkNyZWF0ZShtc2cpO2JyZWFrOwogICAgICAgICAgICAgIGNhc2UgJ2RlbGV0ZSc6CiAgICAgICAgICAgICAgICBjb25zb2xlLmxvZyhtc2cpO2JyZWFrOwogICAgICAgICAgICAgIGRlZmF1bHQ6CiAgICAgICAgICAgICAgICBfdGhpcy5fY2hhbmdlQ2hpbGRyZW4obXNnKTticmVhazsKICAgICAgICAgICAgfQogICAgICAgICAgfQogICAgICAgIH0pOwogICAgICB9KTsKICAgIH0KICB9CgogIC8qKgogICAqIE9iamVjdCBVUkwgb2YgcmVwb3J0ZXIgb3Igb2JzZXJ2ZXIKICAgKiBAdHlwZSB7T2JqZWN0VVJMfQogICAqLwoKICBfY3JlYXRlQ2xhc3MoRGF0YU9iamVjdCwgW3sKICAgIGtleTogJ3BhdXNlJywKCiAgICAvKioKICAgICAqIEBpZ25vcmUKICAgICAqLwogICAgdmFsdWU6IGZ1bmN0aW9uIHBhdXNlKCkgewogICAgICAvL1RPRE86IHRoaXMgZmVhdHVyZSBuZWVkcyBtb3JlIGFuYWxpc2UKICAgICAgdGhyb3cgJ05vdCBpbXBsZW1lbnRlZCc7CiAgICB9CgogICAgLyoqCiAgICAgKiBAaWdub3JlCiAgICAgKi8KICB9LCB7CiAgICBrZXk6ICdyZXN1bWUnLAogICAgdmFsdWU6IGZ1bmN0aW9uIHJlc3VtZSgpIHsKICAgICAgLy9UT0RPOiB0aGlzIGZlYXR1cmUgbmVlZHMgbW9yZSBhbmFsaXNlCiAgICAgIHRocm93ICdOb3QgaW1wbGVtZW50ZWQnOwogICAgfQoKICAgIC8qKgogICAgICogQGlnbm9yZQogICAgICovCiAgfSwgewogICAga2V5OiAnc3RvcCcsCiAgICB2YWx1ZTogZnVuY3Rpb24gc3RvcCgpIHsKICAgICAgLy9UT0RPOiBzaG91bGQgcmVtb3ZlIHRoZSBzdWJzY3JpcHRpb24gYW5kIHNlbmQgbWVzc2FnZSB1bnN1YnNjcmliZT8KICAgICAgdGhyb3cgJ05vdCBpbXBsZW1lbnRlZCc7CiAgICB9CgogICAgLyoqCiAgICAgKiBAaWdub3JlCiAgICAgKi8KICB9LCB7CiAgICBrZXk6ICdyZWxlYXNlJywKICAgIHZhbHVlOiBmdW5jdGlvbiByZWxlYXNlKCkge30KICAgIC8vVE9ETzogcmVtb3ZlIGFsbCBsaXN0ZW5lcnMgZm9yIHRoaXMgb2JqZWN0CgogICAgLyoqCiAgICAgKiBDcmVhdGUgYW5kIGFkZCBhIGNoaWxkcmVuIHRvIHRoZSBzdWJzY3JpcHRpb24gZ3JvdXAuCiAgICAgKiBAcGFyYW0ge1N0cmluZ30gcmVzb3VyY2UgLSBSZXNvdXJjZSBuYW1lLCBvbmUgb2YgdGhlIGl0ZW1zIGluIHRoZSBzY2hlbWEucHJvcGVydGllcy5zY2hlbWUgb2YgdGhlIHBhcmVudCBvYmplY3QuCiAgICAgKiBAcGFyYW0ge0pTT059IGluaXRpYWxEYXRhIC0gSW5pdGlhbCBkYXRhIG9mIHRoZSBjaGlsZAogICAgICogQHJldHVybiB7UHJvbWlzZTxEYXRhT2JqZWN0Q2hpbGQ+fSAtIFJldHVybiBQcm9taXNlIHRvIGEgbmV3IENoaWxkcmVuLgogICAgICovCgogIH0sIHsKICAgIGtleTogJ2FkZENoaWxkcmVuJywKICAgIHZhbHVlOiBmdW5jdGlvbiBhZGRDaGlsZHJlbihyZXNvdXJjZSwgaW5pdGlhbERhdGEpIHsKICAgICAgdmFyIF90aGlzID0gdGhpczsKCiAgICAgIC8vY3JlYXRlIG5ldyBjaGlsZCB1bmlxdWUgSUQsIGJhc2VkIG9uIGh5cGVydHlVUkwKICAgICAgX3RoaXMuX2NoaWxkSWQrKzsKICAgICAgdmFyIG1zZ0NoaWxkSWQgPSBfdGhpcy5fb3duZXIgKyAnIycgKyBfdGhpcy5fY2hpbGRJZDsKICAgICAgdmFyIG1zZ0NoaWxkUGF0aCA9IF90aGlzLl91cmwgKyAnL2NoaWxkcmVuLycgKyByZXNvdXJjZTsKCiAgICAgIHZhciByZXF1ZXN0TXNnID0gewogICAgICAgIHR5cGU6ICdjcmVhdGUnLCBmcm9tOiBfdGhpcy5fb3duZXIsIHRvOiBtc2dDaGlsZFBhdGgsCiAgICAgICAgYm9keTogeyByZXNvdXJjZTogbXNnQ2hpbGRJZCwgdmFsdWU6IGluaXRpYWxEYXRhIH0KICAgICAgfTsKCiAgICAgIC8vcmV0dXJucyBwcm9taXNlLCBpbiB0aGUgZnV0dXJlLCB0aGUgQVBJIG1heSBjaGFuZ2UgdG8gYXN5bmNocm9ub3VzIGNhbGwKICAgICAgcmV0dXJuIG5ldyBQcm9taXNlKGZ1bmN0aW9uIChyZXNvbHZlKSB7CiAgICAgICAgdmFyIG1zZ0lkID0gX3RoaXMuX2J1cy5wb3N0TWVzc2FnZShyZXF1ZXN0TXNnKTsKCiAgICAgICAgY29uc29sZS5sb2coJ2NyZWF0ZS1yZXBvcnRlci1jaGlsZCggJyArIF90aGlzLl9vd25lciArICcgKTogJywgcmVxdWVzdE1zZyk7CiAgICAgICAgdmFyIG5ld0NoaWxkID0gbmV3IF9EYXRhT2JqZWN0Q2hpbGQyWydkZWZhdWx0J10oX3RoaXMuX293bmVyLCBtc2dDaGlsZElkLCBtc2dJZCwgX3RoaXMuX2J1cywgaW5pdGlhbERhdGEpOwogICAgICAgIG5ld0NoaWxkLm9uQ2hhbmdlKGZ1bmN0aW9uIChldmVudCkgewogICAgICAgICAgX3RoaXMuX29uQ2hhbmdlKGV2ZW50LCB7IHBhdGg6IG1zZ0NoaWxkUGF0aCwgY2hpbGRJZDogbXNnQ2hpbGRJZCB9KTsKICAgICAgICB9KTsKCiAgICAgICAgX3RoaXMuX2NoaWxkcmVuW21zZ0NoaWxkSWRdID0gbmV3Q2hpbGQ7CgogICAgICAgIHJlc29sdmUobmV3Q2hpbGQpOwogICAgICB9KTsKICAgIH0KCiAgICAvKioKICAgICAqIFNldHVwIHRoZSBjYWxsYmFjayB0byBwcm9jZXNzIGNyZWF0ZSBhbmQgZGVsZXRlIGNoaWxkcmVucwogICAgICogQHBhcmFtIHtmdW5jdGlvbihldmVudDogTXNnRXZlbnQpfSBjYWxsYmFjawogICAgICovCiAgfSwgewogICAga2V5OiAnb25BZGRDaGlsZHJlbicsCiAgICB2YWx1ZTogZnVuY3Rpb24gb25BZGRDaGlsZHJlbihjYWxsYmFjaykgewogICAgICB0aGlzLl9vbkFkZENoaWxkcmVuSGFuZGxlciA9IGNhbGxiYWNrOwogICAgfQogIH0sIHsKICAgIGtleTogJ19vbkNoaWxkcmVuQ3JlYXRlJywKICAgIHZhbHVlOiBmdW5jdGlvbiBfb25DaGlsZHJlbkNyZWF0ZShtc2cpIHsKICAgICAgdmFyIF90aGlzID0gdGhpczsKICAgICAgdmFyIG1zZ0NoaWxkSWQgPSBtc2cuYm9keS5yZXNvdXJjZTsKCiAgICAgIGNvbnNvbGUubG9nKCdjcmVhdGUtb2JzZXJ2ZXItY2hpbGQoICcgKyBfdGhpcy5fb3duZXIgKyAnICk6ICcsIG1zZyk7CiAgICAgIHZhciBuZXdDaGlsZCA9IG5ldyBfRGF0YU9iamVjdENoaWxkMlsnZGVmYXVsdCddKG1zZy5mcm9tLCBtc2dDaGlsZElkLCAwLCBfdGhpcy5fYnVzLCBtc2cuYm9keS52YWx1ZSk7CiAgICAgIF90aGlzLl9jaGlsZHJlblttc2dDaGlsZElkXSA9IG5ld0NoaWxkOwoKICAgICAgc2V0VGltZW91dChmdW5jdGlvbiAoKSB7CiAgICAgICAgX3RoaXMuX2J1cy5wb3N0TWVzc2FnZSh7CiAgICAgICAgICBpZDogbXNnLmlkLCB0eXBlOiAncmVzcG9uc2UnLCBmcm9tOiBtc2cudG8sIHRvOiBtc2cuZnJvbSwKICAgICAgICAgIGJvZHk6IHsgY29kZTogMjAwLCBzb3VyY2U6IF90aGlzLl9vd25lciB9CiAgICAgICAgfSk7CiAgICAgIH0pOwoKICAgICAgdmFyIGV2ZW50ID0gewogICAgICAgIHR5cGU6IG1zZy50eXBlLAogICAgICAgIGZyb206IG1zZy5mcm9tLAogICAgICAgIHVybDogbXNnLnRvLAogICAgICAgIHZhbHVlOiBtc2cuYm9keS52YWx1ZSwKICAgICAgICBjaGlsZElkOiBtc2dDaGlsZElkCiAgICAgIH07CgogICAgICBpZiAoX3RoaXMuX29uQWRkQ2hpbGRyZW5IYW5kbGVyKSB7CiAgICAgICAgX3RoaXMuX29uQWRkQ2hpbGRyZW5IYW5kbGVyKGV2ZW50KTsKICAgICAgfQogICAgfQoKICAgIC8vc2VuZCBkZWx0YSBtZXNzYWdlcyB0byBzdWJzY3JpcHRpb25zCiAgfSwgewogICAga2V5OiAnX29uQ2hhbmdlJywKICAgIHZhbHVlOiBmdW5jdGlvbiBfb25DaGFuZ2UoZXZlbnQsIGNoaWxkSW5mbykgewogICAgICB2YXIgX3RoaXMgPSB0aGlzOwoKICAgICAgX3RoaXMuX3ZlcnNpb24rKzsKCiAgICAgIGlmIChfdGhpcy5fc3RhdHVzID09PSAnb24nKSB7CiAgICAgICAgdmFyIGNoYW5nZU1zZyA9IHsKICAgICAgICAgIHR5cGU6IGV2ZW50LmNUeXBlLCBmcm9tOiBfdGhpcy5fb3duZXIsIHRvOiBfdGhpcy5fdXJsLAogICAgICAgICAgYm9keTogeyB2ZXJzaW9uOiBfdGhpcy5fdmVyc2lvbiwgb1R5cGU6IGV2ZW50Lm9UeXBlLCBhdHRyaWI6IGV2ZW50LmZpZWxkLCB2YWx1ZTogZXZlbnQuZGF0YSB9CiAgICAgICAgfTsKCiAgICAgICAgLy9jaGlsZEluZm8gbXVzdCBoYXZlIChwYXRoLCBjaGlsZElkKQogICAgICAgIGlmIChjaGlsZEluZm8pIHsKICAgICAgICAgIGNoYW5nZU1zZy50byA9IGNoaWxkSW5mby5wYXRoOwogICAgICAgICAgY2hhbmdlTXNnLmJvZHkuY2hpbGRJZCA9IGNoaWxkSW5mby5jaGlsZElkOwogICAgICAgIH0KCiAgICAgICAgX3RoaXMuX2J1cy5wb3N0TWVzc2FnZShjaGFuZ2VNc2cpOwogICAgICB9CiAgICB9CgogICAgLy9yZWNlaXZlIGFuZCBwcm9jZXNzIGRlbHRhIG1lc3NhZ2VzCiAgfSwgewogICAga2V5OiAnX2NoYW5nZU9iamVjdCcsCiAgICB2YWx1ZTogZnVuY3Rpb24gX2NoYW5nZU9iamVjdChzeW5jT2JqLCBtc2cpIHsKICAgICAgdmFyIF90aGlzID0gdGhpczsKCiAgICAgIC8vVE9ETzogdXBkYXRlIHZlcnNpb24gPwogICAgICAvL2hvdyB0byBoYW5kbGUgYW4gaW5jb3JyZWN0IHZlcnNpb24gPyBFeGFtcGxlOiByZWNlaXZlIGEgdmVyc2lvbiAzIHdoZW4gdGhlIG9ic2VydmVyIGlzIGluIHZlcnNpb24gMSwgd2hlcmUgaXMgdGhlIHZlcnNpb24gMiA/CiAgICAgIC8vd2lsbCB3ZSBuZWVkIHRvIGNvbmZpcm0gdGhlIHJlY2VwdGlvbiA/CiAgICAgIGlmIChfdGhpcy5fdmVyc2lvbiArIDEgPT09IG1zZy5ib2R5LnZlcnNpb24pIHsKICAgICAgICBfdGhpcy5fdmVyc2lvbisrOwogICAgICAgIHZhciBwYXRoID0gbXNnLmJvZHkuYXR0cmliOwogICAgICAgIHZhciB2YWx1ZSA9ICgwLCBfdXRpbHNVdGlsc0pzLmRlZXBDbG9uZSkobXNnLmJvZHkudmFsdWUpOwogICAgICAgIHZhciBmaW5kUmVzdWx0ID0gc3luY09iai5maW5kQmVmb3JlKHBhdGgpOwoKICAgICAgICBpZiAobXNnLnR5cGUgPT09IF9TeW5jT2JqZWN0LkNoYW5nZVR5cGUuVVBEQVRFKSB7CiAgICAgICAgICBmaW5kUmVzdWx0Lm9ialtmaW5kUmVzdWx0Lmxhc3RdID0gdmFsdWU7CiAgICAgICAgfSBlbHNlIHsKICAgICAgICAgIGlmIChtc2cudHlwZSA9PT0gX1N5bmNPYmplY3QuQ2hhbmdlVHlwZS5BREQpIHsKICAgICAgICAgICAgaWYgKG1zZy5ib2R5Lm9UeXBlID09PSBfU3luY09iamVjdC5PYmplY3RUeXBlLk9CSkVDVCkgewogICAgICAgICAgICAgIGZpbmRSZXN1bHQub2JqW2ZpbmRSZXN1bHQubGFzdF0gPSB2YWx1ZTsKICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAvL0FSUkFZCiAgICAgICAgICAgICAgdmFyIGFyciA9IGZpbmRSZXN1bHQub2JqOwogICAgICAgICAgICAgIHZhciBpbmRleCA9IGZpbmRSZXN1bHQubGFzdDsKICAgICAgICAgICAgICBBcnJheS5wcm90b3R5cGUuc3BsaWNlLmFwcGx5KGFyciwgW2luZGV4LCAwXS5jb25jYXQodmFsdWUpKTsKICAgICAgICAgICAgfQogICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgLy9SRU1PVkUKICAgICAgICAgICAgaWYgKG1zZy5ib2R5Lm9UeXBlID09PSBfU3luY09iamVjdC5PYmplY3RUeXBlLk9CSkVDVCkgewogICAgICAgICAgICAgIGRlbGV0ZSBmaW5kUmVzdWx0Lm9ialtmaW5kUmVzdWx0Lmxhc3RdOwogICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgIC8vQVJSQVkKICAgICAgICAgICAgICB2YXIgYXJyID0gZmluZFJlc3VsdC5vYmo7CiAgICAgICAgICAgICAgdmFyIGluZGV4ID0gZmluZFJlc3VsdC5sYXN0OwogICAgICAgICAgICAgIGFyci5zcGxpY2UoaW5kZXgsIHZhbHVlKTsKICAgICAgICAgICAgfQogICAgICAgICAgfQogICAgICAgIH0KICAgICAgfSBlbHNlIHsKICAgICAgICAvL1RPRE86IGhvdyB0byBoYW5kbGUgdW5zeW5jaHJvbml6ZWQgdmVyc2lvbnM/CiAgICAgICAgY29uc29sZS5sb2coJ1VOU1lOQ0hST05JWkVEIFZFUlNJT046IChkYXRhID0+ICcgKyBfdGhpcy5fdmVyc2lvbiArICcsIG1zZyA9PiAnICsgbXNnLmJvZHkudmVyc2lvbiArICcpJyk7CiAgICAgIH0KICAgIH0KICB9LCB7CiAgICBrZXk6ICdfY2hhbmdlQ2hpbGRyZW4nLAogICAgdmFsdWU6IGZ1bmN0aW9uIF9jaGFuZ2VDaGlsZHJlbihtc2cpIHsKICAgICAgdmFyIF90aGlzID0gdGhpczsKICAgICAgY29uc29sZS5sb2coJ0NoYW5nZSBjaGlsZHJlbjogJywgX3RoaXMuX293bmVyLCBtc2cpOwoKICAgICAgdmFyIGNoaWxkSWQgPSBtc2cuYm9keS5jaGlsZElkOwogICAgICB2YXIgY2hpbGRyZW4gPSBfdGhpcy5fY2hpbGRyZW5bY2hpbGRJZF07CgogICAgICBpZiAoY2hpbGRyZW4pIHsKICAgICAgICBfdGhpcy5fY2hhbmdlT2JqZWN0KGNoaWxkcmVuLl9zeW5jT2JqLCBtc2cpOwogICAgICB9IGVsc2UgewogICAgICAgIGNvbnNvbGUubG9nKCdObyBjaGlsZHJlbiBmb3VuZCBmb3I6ICcsIGNoaWxkSWQpOwogICAgICB9CiAgICB9CiAgfSwgewogICAga2V5OiAndXJsJywKICAgIGdldDogZnVuY3Rpb24gZ2V0KCkgewogICAgICByZXR1cm4gdGhpcy5fdXJsOwogICAgfQoKICAgIC8qKgogICAgICogT2JqZWN0IHNjaGVtYSBVUkwgKHRoaXMgZmllbGQgaXMgbm90IHlldCBzdGFibGUsIGFuZCBpcyBzdWJzamVjdCB0byBjaGFuZ2UpCiAgICAgKiBAdHlwZSB7U2NoZW1hVVJMfQogICAgICovCiAgfSwgewogICAga2V5OiAnc2NoZW1hJywKICAgIGdldDogZnVuY3Rpb24gZ2V0KCkgewogICAgICByZXR1cm4gdGhpcy5fc2NoZW1hOwogICAgfQoKICAgIC8qKgogICAgICogU3RhdHVzIG9mIHRoZSByZXBvcnRlciBvciBvYnNlcnZlciBjb25uZWN0aW9uICh0aGlzIGZpZWxkIGlzIG5vdCB5ZXQgc3RhYmxlLCBhbmQgaXMgc3Vic2plY3QgdG8gY2hhbmdlKQogICAgICogQHR5cGUge1N0YXR1c30gLSBFbnVtIG9mOiBvbiB8IHBhdXNlZAogICAgICovCiAgfSwgewogICAga2V5OiAnc3RhdHVzJywKICAgIGdldDogZnVuY3Rpb24gZ2V0KCkgewogICAgICByZXR1cm4gdGhpcy5fc3RhdHVzOwogICAgfQoKICAgIC8qKgogICAgICogRGF0YSBzdHJ1Y3R1cmUgdG8gYmUgc3luY2hyb25pemVkLgogICAgICogQHR5cGUge0pTT059IC0gSlNPTiBzdHJ1Y3R1cmUgdGhhdCBzaG91bGQgZm9sbG93IHRoZSBkZWZpbmVkIHNjaGVtYSwgaWYgYW55LgogICAgICovCiAgfSwgewogICAga2V5OiAnZGF0YScsCiAgICBnZXQ6IGZ1bmN0aW9uIGdldCgpIHsKICAgICAgcmV0dXJuIHRoaXMuX3N5bmNPYmouZGF0YTsKICAgIH0KCiAgICAvKioKICAgICAqIEFsbCBjcmVhdGVkIGNoaWxkcmVuJ3Mgc2luY2UgdGhlIHN1YnNjcmlwdGlvbiwgZG9lc24ndCBjb250YWluIGFsbCBjaGlsZHJlbidzIHNpbmNlIHJlcG9ydGVyIGNyZWF0aW9uLgogICAgICogQHR5cGUge09iamVjdDxDaGlsZElkLCBEYXRhT2JqZWN0Q2hpbGQ+fQogICAgICovCiAgfSwgewogICAga2V5OiAnY2hpbGRyZW4nLAogICAgZ2V0OiBmdW5jdGlvbiBnZXQoKSB7CiAgICAgIHJldHVybiB0aGlzLl9jaGlsZHJlbjsKICAgIH0KICB9XSk7CgogIHJldHVybiBEYXRhT2JqZWN0Owp9KSgpOwoKZXhwb3J0c1snZGVmYXVsdCddID0gRGF0YU9iamVjdDsKbW9kdWxlLmV4cG9ydHMgPSBleHBvcnRzWydkZWZhdWx0J107Cgp9LHsiLi4vdXRpbHMvdXRpbHMuanMiOjE1LCIuL0RhdGFPYmplY3RDaGlsZCI6OCwiLi9TeW5jT2JqZWN0IjoxMn1dLDg6W2Z1bmN0aW9uKHJlcXVpcmUsbW9kdWxlLGV4cG9ydHMpewondXNlIHN0cmljdCc7CgpPYmplY3QuZGVmaW5lUHJvcGVydHkoZXhwb3J0cywgJ19fZXNNb2R1bGUnLCB7CiAgdmFsdWU6IHRydWUKfSk7Cgp2YXIgX2NyZWF0ZUNsYXNzID0gKGZ1bmN0aW9uICgpIHsgZnVuY3Rpb24gZGVmaW5lUHJvcGVydGllcyh0YXJnZXQsIHByb3BzKSB7IGZvciAodmFyIGkgPSAwOyBpIDwgcHJvcHMubGVuZ3RoOyBpKyspIHsgdmFyIGRlc2NyaXB0b3IgPSBwcm9wc1tpXTsgZGVzY3JpcHRvci5lbnVtZXJhYmxlID0gZGVzY3JpcHRvci5lbnVtZXJhYmxlIHx8IGZhbHNlOyBkZXNjcmlwdG9yLmNvbmZpZ3VyYWJsZSA9IHRydWU7IGlmICgndmFsdWUnIGluIGRlc2NyaXB0b3IpIGRlc2NyaXB0b3Iud3JpdGFibGUgPSB0cnVlOyBPYmplY3QuZGVmaW5lUHJvcGVydHkodGFyZ2V0LCBkZXNjcmlwdG9yLmtleSwgZGVzY3JpcHRvcik7IH0gfSByZXR1cm4gZnVuY3Rpb24gKENvbnN0cnVjdG9yLCBwcm90b1Byb3BzLCBzdGF0aWNQcm9wcykgeyBpZiAocHJvdG9Qcm9wcykgZGVmaW5lUHJvcGVydGllcyhDb25zdHJ1Y3Rvci5wcm90b3R5cGUsIHByb3RvUHJvcHMpOyBpZiAoc3RhdGljUHJvcHMpIGRlZmluZVByb3BlcnRpZXMoQ29uc3RydWN0b3IsIHN0YXRpY1Byb3BzKTsgcmV0dXJuIENvbnN0cnVjdG9yOyB9OyB9KSgpOwoKZnVuY3Rpb24gX2ludGVyb3BSZXF1aXJlRGVmYXVsdChvYmopIHsgcmV0dXJuIG9iaiAmJiBvYmouX19lc01vZHVsZSA/IG9iaiA6IHsgJ2RlZmF1bHQnOiBvYmogfTsgfQoKZnVuY3Rpb24gX2NsYXNzQ2FsbENoZWNrKGluc3RhbmNlLCBDb25zdHJ1Y3RvcikgeyBpZiAoIShpbnN0YW5jZSBpbnN0YW5jZW9mIENvbnN0cnVjdG9yKSkgeyB0aHJvdyBuZXcgVHlwZUVycm9yKCdDYW5ub3QgY2FsbCBhIGNsYXNzIGFzIGEgZnVuY3Rpb24nKTsgfSB9Cgp2YXIgX1N5bmNPYmplY3QgPSByZXF1aXJlKCcuL1N5bmNPYmplY3QnKTsKCnZhciBfU3luY09iamVjdDIgPSBfaW50ZXJvcFJlcXVpcmVEZWZhdWx0KF9TeW5jT2JqZWN0KTsKCi8qKgogKiBUaGUgY2xhc3MgcmV0dXJuZWQgZnJvbSB0aGUgRGF0YU9iamVjdCBhZGRDaGlsZHJlbiBjYWxsIG9yIGZyb20gb25BZGRDaGlsZHJlbiBpZiByZW1vdGVseSBjcmVhdGVkLgogKiBDaGlsZHJlbiBvYmplY3Qgc3luY2hyb25pemF0aW9uIGlzIGEgYSBmYXN0IGZvcndhcmQgbWVjaGFuaXNtLCBubyBuZWVkIGZvciBkaXJlY3Qgc3Vic2NyaXB0aW9ucywgaXQgdXNlcyB0aGUgYWxyZWFkeSBhdXRob3JpemVkIHN1YnNjcmlwdGlvbiBmcm9tIHRoZSBwYXJlbnQgRGF0YU9iamVjdC4KICovCgp2YXIgRGF0YU9iamVjdENoaWxkIC8qIGltcGxlbWVudHMgU3luY1N0YXR1cyAqLyA9IChmdW5jdGlvbiAoKSB7CiAgLyogcHJpdmF0ZQogICAtLS0tZXZlbnQgaGFuZGxlcnMtLS0tCiAgX29uUmVzcG9uc2VIYW5kbGVyOiAoZXZlbnQpID0+IHZvaWQKICAqLwoKICAvKioKICAgKiBAaWdub3JlCiAgICogU2hvdWxkIG5vdCBiZSB1c2VkIGRpcmVjdGx5IGJ5IEh5cGVydGllcy4gSXQncyBjYWxsZWQgYnkgdGhlIERhdGFPYmplY3QuYWRkQ2hpbGRyZW4KICAgKi8KCiAgZnVuY3Rpb24gRGF0YU9iamVjdENoaWxkKG93bmVyLCBjaGlsZElkLCBtc2dJZCwgYnVzLCBpbml0aWFsRGF0YSkgewogICAgX2NsYXNzQ2FsbENoZWNrKHRoaXMsIERhdGFPYmplY3RDaGlsZCk7CgogICAgdmFyIF90aGlzID0gdGhpczsKCiAgICBfdGhpcy5fb3duZXIgPSBvd25lcjsKICAgIF90aGlzLl9jaGlsZElkID0gY2hpbGRJZDsKICAgIF90aGlzLl9idXMgPSBidXM7CiAgICBfdGhpcy5fc3luY09iaiA9IG5ldyBfU3luY09iamVjdDJbJ2RlZmF1bHQnXShpbml0aWFsRGF0YSk7CgogICAgYnVzLmFkZExpc3RlbmVyKG93bmVyLCBmdW5jdGlvbiAobXNnKSB7CiAgICAgIGlmIChtc2cudHlwZSA9PT0gJ3Jlc3BvbnNlJyAmJiBtc2cuaWQgPT09IG1zZ0lkKSB7CiAgICAgICAgY29uc29sZS5sb2coJ0RhdGFPYmplY3RDaGlsZC5vblJlc3BvbnNlOicsIG1zZyk7CiAgICAgICAgX3RoaXMuX29uUmVzcG9uc2UobXNnKTsKICAgICAgfQogICAgfSk7CiAgfQoKICAvKioKICAgKiBDaGlsZHJlbiBJRCBnZW5lcmF0ZWQgb24gYWRkQ2hpbGRyZW4uIFVuaXF1ZSBpZGVudGlmaWVyCiAgICogQHR5cGUge1VSTH0gLSBVUkwgb2YgdGhlIGZvcm1hdCA8SHlwZXJ0eVVSTD4jPG51bWVyaWMtc2VxdWVuY2U+CiAgICovCgogIF9jcmVhdGVDbGFzcyhEYXRhT2JqZWN0Q2hpbGQsIFt7CiAgICBrZXk6ICdvbkNoYW5nZScsCgogICAgLyoqCiAgICAgKiBSZWdpc3RlciB0aGUgY2hhbmdlIGxpc3RlbmVycyBzZW50IGJ5IHRoZSByZXBvcnRlciBjaGlsZAogICAgICogQHBhcmFtIHtmdW5jdGlvbihldmVudDogTXNnRXZlbnQpfSBjYWxsYmFjawogICAgICovCiAgICB2YWx1ZTogZnVuY3Rpb24gb25DaGFuZ2UoY2FsbGJhY2spIHsKICAgICAgdGhpcy5fc3luY09iai5vYnNlcnZlKGZ1bmN0aW9uIChldmVudCkgewogICAgICAgIGNhbGxiYWNrKGV2ZW50KTsKICAgICAgfSk7CiAgICB9CgogICAgLyoqCiAgICAgKiBTZXR1cCB0aGUgY2FsbGJhY2sgdG8gcHJvY2VzcyByZXNwb25zZSBub3RpZmljYXRpb25zIG9mIHRoZSBjcmVhdGVzCiAgICAgKiBAcGFyYW0ge2Z1bmN0aW9uKGV2ZW50OiBNc2dFdmVudCl9IGNhbGxiYWNrCiAgICAgKi8KICB9LCB7CiAgICBrZXk6ICdvblJlc3BvbnNlJywKICAgIHZhbHVlOiBmdW5jdGlvbiBvblJlc3BvbnNlKGNhbGxiYWNrKSB7CiAgICAgIHRoaXMuX29uUmVzcG9uc2VIYW5kbGVyID0gY2FsbGJhY2s7CiAgICB9CiAgfSwgewogICAga2V5OiAnX29uUmVzcG9uc2UnLAogICAgdmFsdWU6IGZ1bmN0aW9uIF9vblJlc3BvbnNlKG1zZykgewogICAgICB2YXIgX3RoaXMgPSB0aGlzOwoKICAgICAgdmFyIGV2ZW50ID0gewogICAgICAgIHR5cGU6IG1zZy50eXBlLAogICAgICAgIHVybDogbXNnLmJvZHkuc291cmNlLAogICAgICAgIGNvZGU6IG1zZy5ib2R5LmNvZGUKICAgICAgfTsKCiAgICAgIGlmIChfdGhpcy5fb25SZXNwb25zZUhhbmRsZXIpIHsKICAgICAgICBfdGhpcy5fb25SZXNwb25zZUhhbmRsZXIoZXZlbnQpOwogICAgICB9CiAgICB9CiAgfSwgewogICAga2V5OiAnY2hpbGRJZCcsCiAgICBnZXQ6IGZ1bmN0aW9uIGdldCgpIHsKICAgICAgcmV0dXJuIHRoaXMuX2NoaWxkSWQ7CiAgICB9CgogICAgLyoqCiAgICAgKiBEYXRhIFN0cnVjdHVyZSB0byBiZSBzeW5jaHJvbml6ZWQuCiAgICAgKiBAdHlwZSB7SlNPTn0gLSBKU09OIHN0cnVjdHVyZSB0aGF0IHNob3VsZCBmb2xsb3cgdGhlIGRlZmluZWQgc2NoZW1hLCBpZiBhbnkuCiAgICAgKi8KICB9LCB7CiAgICBrZXk6ICdkYXRhJywKICAgIGdldDogZnVuY3Rpb24gZ2V0KCkgewogICAgICByZXR1cm4gdGhpcy5fc3luY09iai5kYXRhOwogICAgfQogIH1dKTsKCiAgcmV0dXJuIERhdGFPYmplY3RDaGlsZDsKfSkoKTsKCmV4cG9ydHNbJ2RlZmF1bHQnXSA9IERhdGFPYmplY3RDaGlsZDsKbW9kdWxlLmV4cG9ydHMgPSBleHBvcnRzWydkZWZhdWx0J107Cgp9LHsiLi9TeW5jT2JqZWN0IjoxMn1dLDk6W2Z1bmN0aW9uKHJlcXVpcmUsbW9kdWxlLGV4cG9ydHMpewondXNlIHN0cmljdCc7CgpPYmplY3QuZGVmaW5lUHJvcGVydHkoZXhwb3J0cywgJ19fZXNNb2R1bGUnLCB7CiAgdmFsdWU6IHRydWUKfSk7Cgp2YXIgX2NyZWF0ZUNsYXNzID0gKGZ1bmN0aW9uICgpIHsgZnVuY3Rpb24gZGVmaW5lUHJvcGVydGllcyh0YXJnZXQsIHByb3BzKSB7IGZvciAodmFyIGkgPSAwOyBpIDwgcHJvcHMubGVuZ3RoOyBpKyspIHsgdmFyIGRlc2NyaXB0b3IgPSBwcm9wc1tpXTsgZGVzY3JpcHRvci5lbnVtZXJhYmxlID0gZGVzY3JpcHRvci5lbnVtZXJhYmxlIHx8IGZhbHNlOyBkZXNjcmlwdG9yLmNvbmZpZ3VyYWJsZSA9IHRydWU7IGlmICgndmFsdWUnIGluIGRlc2NyaXB0b3IpIGRlc2NyaXB0b3Iud3JpdGFibGUgPSB0cnVlOyBPYmplY3QuZGVmaW5lUHJvcGVydHkodGFyZ2V0LCBkZXNjcmlwdG9yLmtleSwgZGVzY3JpcHRvcik7IH0gfSByZXR1cm4gZnVuY3Rpb24gKENvbnN0cnVjdG9yLCBwcm90b1Byb3BzLCBzdGF0aWNQcm9wcykgeyBpZiAocHJvdG9Qcm9wcykgZGVmaW5lUHJvcGVydGllcyhDb25zdHJ1Y3Rvci5wcm90b3R5cGUsIHByb3RvUHJvcHMpOyBpZiAoc3RhdGljUHJvcHMpIGRlZmluZVByb3BlcnRpZXMoQ29uc3RydWN0b3IsIHN0YXRpY1Byb3BzKTsgcmV0dXJuIENvbnN0cnVjdG9yOyB9OyB9KSgpOwoKdmFyIF9nZXQgPSBmdW5jdGlvbiBnZXQoX3gsIF94MiwgX3gzKSB7IHZhciBfYWdhaW4gPSB0cnVlOyBfZnVuY3Rpb246IHdoaWxlIChfYWdhaW4pIHsgdmFyIG9iamVjdCA9IF94LCBwcm9wZXJ0eSA9IF94MiwgcmVjZWl2ZXIgPSBfeDM7IF9hZ2FpbiA9IGZhbHNlOyBpZiAob2JqZWN0ID09PSBudWxsKSBvYmplY3QgPSBGdW5jdGlvbi5wcm90b3R5cGU7IHZhciBkZXNjID0gT2JqZWN0LmdldE93blByb3BlcnR5RGVzY3JpcHRvcihvYmplY3QsIHByb3BlcnR5KTsgaWYgKGRlc2MgPT09IHVuZGVmaW5lZCkgeyB2YXIgcGFyZW50ID0gT2JqZWN0LmdldFByb3RvdHlwZU9mKG9iamVjdCk7IGlmIChwYXJlbnQgPT09IG51bGwpIHsgcmV0dXJuIHVuZGVmaW5lZDsgfSBlbHNlIHsgX3ggPSBwYXJlbnQ7IF94MiA9IHByb3BlcnR5OyBfeDMgPSByZWNlaXZlcjsgX2FnYWluID0gdHJ1ZTsgZGVzYyA9IHBhcmVudCA9IHVuZGVmaW5lZDsgY29udGludWUgX2Z1bmN0aW9uOyB9IH0gZWxzZSBpZiAoJ3ZhbHVlJyBpbiBkZXNjKSB7IHJldHVybiBkZXNjLnZhbHVlOyB9IGVsc2UgeyB2YXIgZ2V0dGVyID0gZGVzYy5nZXQ7IGlmIChnZXR0ZXIgPT09IHVuZGVmaW5lZCkgeyByZXR1cm4gdW5kZWZpbmVkOyB9IHJldHVybiBnZXR0ZXIuY2FsbChyZWNlaXZlcik7IH0gfSB9OwoKZnVuY3Rpb24gX2ludGVyb3BSZXF1aXJlRGVmYXVsdChvYmopIHsgcmV0dXJuIG9iaiAmJiBvYmouX19lc01vZHVsZSA/IG9iaiA6IHsgJ2RlZmF1bHQnOiBvYmogfTsgfQoKZnVuY3Rpb24gX2NsYXNzQ2FsbENoZWNrKGluc3RhbmNlLCBDb25zdHJ1Y3RvcikgeyBpZiAoIShpbnN0YW5jZSBpbnN0YW5jZW9mIENvbnN0cnVjdG9yKSkgeyB0aHJvdyBuZXcgVHlwZUVycm9yKCdDYW5ub3QgY2FsbCBhIGNsYXNzIGFzIGEgZnVuY3Rpb24nKTsgfSB9CgpmdW5jdGlvbiBfaW5oZXJpdHMoc3ViQ2xhc3MsIHN1cGVyQ2xhc3MpIHsgaWYgKHR5cGVvZiBzdXBlckNsYXNzICE9PSAnZnVuY3Rpb24nICYmIHN1cGVyQ2xhc3MgIT09IG51bGwpIHsgdGhyb3cgbmV3IFR5cGVFcnJvcignU3VwZXIgZXhwcmVzc2lvbiBtdXN0IGVpdGhlciBiZSBudWxsIG9yIGEgZnVuY3Rpb24sIG5vdCAnICsgdHlwZW9mIHN1cGVyQ2xhc3MpOyB9IHN1YkNsYXNzLnByb3RvdHlwZSA9IE9iamVjdC5jcmVhdGUoc3VwZXJDbGFzcyAmJiBzdXBlckNsYXNzLnByb3RvdHlwZSwgeyBjb25zdHJ1Y3RvcjogeyB2YWx1ZTogc3ViQ2xhc3MsIGVudW1lcmFibGU6IGZhbHNlLCB3cml0YWJsZTogdHJ1ZSwgY29uZmlndXJhYmxlOiB0cnVlIH0gfSk7IGlmIChzdXBlckNsYXNzKSBPYmplY3Quc2V0UHJvdG90eXBlT2YgPyBPYmplY3Quc2V0UHJvdG90eXBlT2Yoc3ViQ2xhc3MsIHN1cGVyQ2xhc3MpIDogc3ViQ2xhc3MuX19wcm90b19fID0gc3VwZXJDbGFzczsgfQoKdmFyIF9EYXRhT2JqZWN0MiA9IHJlcXVpcmUoJy4vRGF0YU9iamVjdCcpOwoKdmFyIF9EYXRhT2JqZWN0MyA9IF9pbnRlcm9wUmVxdWlyZURlZmF1bHQoX0RhdGFPYmplY3QyKTsKCnZhciBGaWx0ZXJUeXBlID0geyBBTlk6ICdhbnknLCBTVEFSVDogJ3N0YXJ0JywgRVhBQ1Q6ICdleGFjdCcgfTsKCi8qKgogKiBUaGUgY2xhc3MgcmV0dXJuZWQgZnJvbSB0aGUgU3luY2hlciBzdWJzY3JpYmUgY2FsbC4KICogVG8gYmUgdXNlZCBhcyBhbiBvYnNlcnZhdGlvbiBwb2ludCBmcm9tIGEgRGF0YU9iamVjdFJlcG9ydGVyIGNoYW5nZS4KICovCgp2YXIgRGF0YU9iamVjdE9ic2VydmVyID0gKGZ1bmN0aW9uIChfRGF0YU9iamVjdCkgewogIF9pbmhlcml0cyhEYXRhT2JqZWN0T2JzZXJ2ZXIsIF9EYXRhT2JqZWN0KTsKCiAgLyogcHJpdmF0ZQogICAtLS0tZXZlbnQgaGFuZGxlcnMtLS0tCiAgX2ZpbHRlcnM6IHs8ZmlsdGVyPjoge3R5cGU6IDxzdGFydCwgZXhhY3Q+LCBjYWxsYmFjazogPGZ1bmN0aW9uPn0gfQogICovCgogIC8qKgogICAqIEBpZ25vcmUKICAgKiBTaG91bGQgbm90IGJlIHVzZWQgZGlyZWN0bHkgYnkgSHlwZXJ0aWVzLiBJdCdzIGNhbGxlZCBieSB0aGUgU3luY2hlci5zdWJzY3JpYmUgbWV0aG9kCiAgICovCgogIGZ1bmN0aW9uIERhdGFPYmplY3RPYnNlcnZlcihvd25lciwgdXJsLCBzY2hlbWEsIGJ1cywgaW5pdGlhbFN0YXR1cywgaW5pdGlhbERhdGEsIGNoaWxkcmVuLCBpbml0aWFsVmVyc2lvbikgewogICAgX2NsYXNzQ2FsbENoZWNrKHRoaXMsIERhdGFPYmplY3RPYnNlcnZlcik7CgogICAgX2dldChPYmplY3QuZ2V0UHJvdG90eXBlT2YoRGF0YU9iamVjdE9ic2VydmVyLnByb3RvdHlwZSksICdjb25zdHJ1Y3RvcicsIHRoaXMpLmNhbGwodGhpcywgb3duZXIsIHVybCwgc2NoZW1hLCBidXMsIGluaXRpYWxTdGF0dXMsIGluaXRpYWxEYXRhLCBjaGlsZHJlbik7CiAgICB2YXIgX3RoaXMgPSB0aGlzOwoKICAgIF90aGlzLl92ZXJzaW9uID0gaW5pdGlhbFZlcnNpb247CgogICAgLy9hZGQgbGlzdGVuZXIgZm9yIG9ialVSTAogICAgYnVzLmFkZExpc3RlbmVyKHVybCwgZnVuY3Rpb24gKG1zZykgewogICAgICBjb25zb2xlLmxvZygnRGF0YU9iamVjdE9ic2VydmVyLScgKyB1cmwgKyAnLVJDVjogJywgbXNnKTsKICAgICAgX3RoaXMuX2NoYW5nZU9iamVjdChfdGhpcy5fc3luY09iaiwgbXNnKTsKICAgIH0pOwoKICAgIF90aGlzLl9zeW5jT2JqLm9ic2VydmUoZnVuY3Rpb24gKGV2ZW50KSB7CiAgICAgIF90aGlzLl9vbkZpbHRlcihldmVudCk7CiAgICB9KTsKCiAgICBfdGhpcy5fZmlsdGVycyA9IHt9OwogIH0KCiAgLyoqCiAgICogUmVnaXN0ZXIgdGhlIGNoYW5nZSBsaXN0ZW5lcnMgc2VudCBieSB0aGUgcmVwb3J0ZXIKICAgKiBAcGFyYW0ge3N0cmluZ30gZmlsdGVyIC0gRmlsdGVyIHRoYXQgaWRlbnRpZmllcyB0aGUgZmllbGQgKHNlcGFyZXRlZCBkb3QgcGF0aCkuIEFjY2VwdHMgKiBhdCB0aGUgZW5kIGZvciBhIG1vcmUgdW5yZXN0cmljdGVkIGZpbHRlcmluZy4KICAgKiBAcGFyYW0ge2Z1bmN0aW9uKGV2ZW50OiBNc2dFdmVudCl9IGNhbGxiYWNrCiAgICovCgogIF9jcmVhdGVDbGFzcyhEYXRhT2JqZWN0T2JzZXJ2ZXIsIFt7CiAgICBrZXk6ICdvbkNoYW5nZScsCiAgICB2YWx1ZTogZnVuY3Rpb24gb25DaGFuZ2UoZmlsdGVyLCBjYWxsYmFjaykgewogICAgICB2YXIga2V5ID0gZmlsdGVyOwogICAgICB2YXIgZmlsdGVyT2JqID0gewogICAgICAgIHR5cGU6IEZpbHRlclR5cGUuRVhBQ1QsCiAgICAgICAgY2FsbGJhY2s6IGNhbGxiYWNrCiAgICAgIH07CgogICAgICB2YXIgaWR4ID0gZmlsdGVyLmluZGV4T2YoJyonKTsKICAgICAgaWYgKGlkeCA9PT0gZmlsdGVyLmxlbmd0aCAtIDEpIHsKICAgICAgICBpZiAoaWR4ID09PSAwKSB7CiAgICAgICAgICBmaWx0ZXJPYmoudHlwZSA9IEZpbHRlclR5cGUuQU5ZOwogICAgICAgIH0gZWxzZSB7CiAgICAgICAgICBmaWx0ZXJPYmoudHlwZSA9IEZpbHRlclR5cGUuU1RBUlQ7CiAgICAgICAgICBrZXkgPSBmaWx0ZXIuc3Vic3RyKDAsIGZpbHRlci5sZW5ndGggLSAxKTsKICAgICAgICB9CiAgICAgIH0KCiAgICAgIHRoaXMuX2ZpbHRlcnNba2V5XSA9IGZpbHRlck9iajsKICAgIH0KICB9LCB7CiAgICBrZXk6ICdfb25GaWx0ZXInLAogICAgdmFsdWU6IGZ1bmN0aW9uIF9vbkZpbHRlcihldmVudCkgewogICAgICB2YXIgX3RoaXMgPSB0aGlzOwoKICAgICAgT2JqZWN0LmtleXMoX3RoaXMuX2ZpbHRlcnMpLmZvckVhY2goZnVuY3Rpb24gKGtleSkgewogICAgICAgIHZhciBmaWx0ZXIgPSBfdGhpcy5fZmlsdGVyc1trZXldOwogICAgICAgIGlmIChmaWx0ZXIudHlwZSA9PT0gRmlsdGVyVHlwZS5BTlkpIHsKICAgICAgICAgIC8vbWF0Y2ggYW55dGhpbmcKICAgICAgICAgIGZpbHRlci5jYWxsYmFjayhldmVudCk7CiAgICAgICAgfSBlbHNlIGlmIChmaWx0ZXIudHlwZSA9PT0gRmlsdGVyVHlwZS5TVEFSVCkgewogICAgICAgICAgLy9pZiBzdGFydHMgd2l0aCBmaWx0ZXIuLi4KICAgICAgICAgIGlmIChldmVudC5maWVsZC5pbmRleE9mKGtleSkgPT09IDApIHsKICAgICAgICAgICAgZmlsdGVyLmNhbGxiYWNrKGV2ZW50KTsKICAgICAgICAgIH0KICAgICAgICB9IGVsc2UgaWYgKGZpbHRlci50eXBlID09PSBGaWx0ZXJUeXBlLkVYQUNUKSB7CiAgICAgICAgICAvL2V4YWN0IG1hdGNoCiAgICAgICAgICBpZiAoZXZlbnQuZmllbGQgPT09IGtleSkgewogICAgICAgICAgICBmaWx0ZXIuY2FsbGJhY2soZXZlbnQpOwogICAgICAgICAgfQogICAgICAgIH0KICAgICAgfSk7CiAgICB9CiAgfV0pOwoKICByZXR1cm4gRGF0YU9iamVjdE9ic2VydmVyOwp9KShfRGF0YU9iamVjdDNbJ2RlZmF1bHQnXSAvKiBpbXBsZW1lbnRzIFN5bmNTdGF0dXMgKi8pOwoKZXhwb3J0c1snZGVmYXVsdCddID0gRGF0YU9iamVjdE9ic2VydmVyOwptb2R1bGUuZXhwb3J0cyA9IGV4cG9ydHNbJ2RlZmF1bHQnXTsKCn0seyIuL0RhdGFPYmplY3QiOjd9XSwxMDpbZnVuY3Rpb24ocmVxdWlyZSxtb2R1bGUsZXhwb3J0cyl7Cid1c2Ugc3RyaWN0JzsKCk9iamVjdC5kZWZpbmVQcm9wZXJ0eShleHBvcnRzLCAnX19lc01vZHVsZScsIHsKICB2YWx1ZTogdHJ1ZQp9KTsKCnZhciBfY3JlYXRlQ2xhc3MgPSAoZnVuY3Rpb24gKCkgeyBmdW5jdGlvbiBkZWZpbmVQcm9wZXJ0aWVzKHRhcmdldCwgcHJvcHMpIHsgZm9yICh2YXIgaSA9IDA7IGkgPCBwcm9wcy5sZW5ndGg7IGkrKykgeyB2YXIgZGVzY3JpcHRvciA9IHByb3BzW2ldOyBkZXNjcmlwdG9yLmVudW1lcmFibGUgPSBkZXNjcmlwdG9yLmVudW1lcmFibGUgfHwgZmFsc2U7IGRlc2NyaXB0b3IuY29uZmlndXJhYmxlID0gdHJ1ZTsgaWYgKCd2YWx1ZScgaW4gZGVzY3JpcHRvcikgZGVzY3JpcHRvci53cml0YWJsZSA9IHRydWU7IE9iamVjdC5kZWZpbmVQcm9wZXJ0eSh0YXJnZXQsIGRlc2NyaXB0b3Iua2V5LCBkZXNjcmlwdG9yKTsgfSB9IHJldHVybiBmdW5jdGlvbiAoQ29uc3RydWN0b3IsIHByb3RvUHJvcHMsIHN0YXRpY1Byb3BzKSB7IGlmIChwcm90b1Byb3BzKSBkZWZpbmVQcm9wZXJ0aWVzKENvbnN0cnVjdG9yLnByb3RvdHlwZSwgcHJvdG9Qcm9wcyk7IGlmIChzdGF0aWNQcm9wcykgZGVmaW5lUHJvcGVydGllcyhDb25zdHJ1Y3Rvciwgc3RhdGljUHJvcHMpOyByZXR1cm4gQ29uc3RydWN0b3I7IH07IH0pKCk7Cgp2YXIgX2dldCA9IGZ1bmN0aW9uIGdldChfeCwgX3gyLCBfeDMpIHsgdmFyIF9hZ2FpbiA9IHRydWU7IF9mdW5jdGlvbjogd2hpbGUgKF9hZ2FpbikgeyB2YXIgb2JqZWN0ID0gX3gsIHByb3BlcnR5ID0gX3gyLCByZWNlaXZlciA9IF94MzsgX2FnYWluID0gZmFsc2U7IGlmIChvYmplY3QgPT09IG51bGwpIG9iamVjdCA9IEZ1bmN0aW9uLnByb3RvdHlwZTsgdmFyIGRlc2MgPSBPYmplY3QuZ2V0T3duUHJvcGVydHlEZXNjcmlwdG9yKG9iamVjdCwgcHJvcGVydHkpOyBpZiAoZGVzYyA9PT0gdW5kZWZpbmVkKSB7IHZhciBwYXJlbnQgPSBPYmplY3QuZ2V0UHJvdG90eXBlT2Yob2JqZWN0KTsgaWYgKHBhcmVudCA9PT0gbnVsbCkgeyByZXR1cm4gdW5kZWZpbmVkOyB9IGVsc2UgeyBfeCA9IHBhcmVudDsgX3gyID0gcHJvcGVydHk7IF94MyA9IHJlY2VpdmVyOyBfYWdhaW4gPSB0cnVlOyBkZXNjID0gcGFyZW50ID0gdW5kZWZpbmVkOyBjb250aW51ZSBfZnVuY3Rpb247IH0gfSBlbHNlIGlmICgndmFsdWUnIGluIGRlc2MpIHsgcmV0dXJuIGRlc2MudmFsdWU7IH0gZWxzZSB7IHZhciBnZXR0ZXIgPSBkZXNjLmdldDsgaWYgKGdldHRlciA9PT0gdW5kZWZpbmVkKSB7IHJldHVybiB1bmRlZmluZWQ7IH0gcmV0dXJuIGdldHRlci5jYWxsKHJlY2VpdmVyKTsgfSB9IH07CgpmdW5jdGlvbiBfaW50ZXJvcFJlcXVpcmVEZWZhdWx0KG9iaikgeyByZXR1cm4gb2JqICYmIG9iai5fX2VzTW9kdWxlID8gb2JqIDogeyAnZGVmYXVsdCc6IG9iaiB9OyB9CgpmdW5jdGlvbiBfY2xhc3NDYWxsQ2hlY2soaW5zdGFuY2UsIENvbnN0cnVjdG9yKSB7IGlmICghKGluc3RhbmNlIGluc3RhbmNlb2YgQ29uc3RydWN0b3IpKSB7IHRocm93IG5ldyBUeXBlRXJyb3IoJ0Nhbm5vdCBjYWxsIGEgY2xhc3MgYXMgYSBmdW5jdGlvbicpOyB9IH0KCmZ1bmN0aW9uIF9pbmhlcml0cyhzdWJDbGFzcywgc3VwZXJDbGFzcykgeyBpZiAodHlwZW9mIHN1cGVyQ2xhc3MgIT09ICdmdW5jdGlvbicgJiYgc3VwZXJDbGFzcyAhPT0gbnVsbCkgeyB0aHJvdyBuZXcgVHlwZUVycm9yKCdTdXBlciBleHByZXNzaW9uIG11c3QgZWl0aGVyIGJlIG51bGwgb3IgYSBmdW5jdGlvbiwgbm90ICcgKyB0eXBlb2Ygc3VwZXJDbGFzcyk7IH0gc3ViQ2xhc3MucHJvdG90eXBlID0gT2JqZWN0LmNyZWF0ZShzdXBlckNsYXNzICYmIHN1cGVyQ2xhc3MucHJvdG90eXBlLCB7IGNvbnN0cnVjdG9yOiB7IHZhbHVlOiBzdWJDbGFzcywgZW51bWVyYWJsZTogZmFsc2UsIHdyaXRhYmxlOiB0cnVlLCBjb25maWd1cmFibGU6IHRydWUgfSB9KTsgaWYgKHN1cGVyQ2xhc3MpIE9iamVjdC5zZXRQcm90b3R5cGVPZiA/IE9iamVjdC5zZXRQcm90b3R5cGVPZihzdWJDbGFzcywgc3VwZXJDbGFzcykgOiBzdWJDbGFzcy5fX3Byb3RvX18gPSBzdXBlckNsYXNzOyB9Cgp2YXIgX0RhdGFPYmplY3QyID0gcmVxdWlyZSgnLi9EYXRhT2JqZWN0Jyk7Cgp2YXIgX0RhdGFPYmplY3QzID0gX2ludGVyb3BSZXF1aXJlRGVmYXVsdChfRGF0YU9iamVjdDIpOwoKdmFyIF91dGlsc1V0aWxzSnMgPSByZXF1aXJlKCcuLi91dGlscy91dGlscy5qcycpOwoKLyoqCiAqIFRoZSBjbGFzcyByZXR1cm5lZCBmcm9tIHRoZSBTeW5jaGVyIGNyZWF0ZSBjYWxsLgogKiBUbyBiZSB1c2VkIGFzIGEgcmVwb3J0ZXIgcG9pbnQsIGNoYW5nZXMgd2lsbCBiZSBzdWJtaXRlZCB0byBEYXRhT2JqZWN0T2JzZXJ2ZXIgaW5zdGFuY2VzLgogKi8KCnZhciBEYXRhT2JqZWN0UmVwb3J0ZXIgPSAoZnVuY3Rpb24gKF9EYXRhT2JqZWN0KSB7CiAgX2luaGVyaXRzKERhdGFPYmplY3RSZXBvcnRlciwgX0RhdGFPYmplY3QpOwoKICAvKiBwcml2YXRlCiAgX3N1YnNjcmlwdGlvbnM6IDxoeXBlcnR5VXJsOiB7IHN0YXR1czogc3RyaW5nIH0gfT4KICAgLS0tLWV2ZW50IGhhbmRsZXJzLS0tLQogIF9vblN1YnNjcmlwdGlvbkhhbmRsZXI6IChldmVudCkgPT4gdm9pZAogIF9vblJlc3BvbnNlSGFuZGxlcjogKGV2ZW50KSA9PiB2b2lkCiAgKi8KCiAgLyoqCiAgICogQGlnbm9yZQogICAqIFNob3VsZCBub3QgYmUgdXNlZCBkaXJlY3RseSBieSBIeXBlcnRpZXMuIEl0J3MgY2FsbGVkIGJ5IHRoZSBTeW5jaGVyLmNyZWF0ZSBtZXRob2QKICAgKi8KCiAgZnVuY3Rpb24gRGF0YU9iamVjdFJlcG9ydGVyKG93bmVyLCB1cmwsIHNjaGVtYSwgYnVzLCBpbml0aWFsU3RhdHVzLCBpbml0aWFsRGF0YSwgY2hpbGRyZW4pIHsKICAgIF9jbGFzc0NhbGxDaGVjayh0aGlzLCBEYXRhT2JqZWN0UmVwb3J0ZXIpOwoKICAgIF9nZXQoT2JqZWN0LmdldFByb3RvdHlwZU9mKERhdGFPYmplY3RSZXBvcnRlci5wcm90b3R5cGUpLCAnY29uc3RydWN0b3InLCB0aGlzKS5jYWxsKHRoaXMsIG93bmVyLCB1cmwsIHNjaGVtYSwgYnVzLCBpbml0aWFsU3RhdHVzLCBpbml0aWFsRGF0YSwgY2hpbGRyZW4pOwogICAgdmFyIF90aGlzID0gdGhpczsKCiAgICBidXMuYWRkTGlzdGVuZXIob3duZXIsIGZ1bmN0aW9uIChtc2cpIHsKICAgICAgaWYgKG1zZy50eXBlID09PSAncmVzcG9uc2UnICYmIG1zZy5ib2R5LnNvdXJjZSA9PT0gdXJsKSB7CiAgICAgICAgX3RoaXMuX29uUmVzcG9uc2UobXNnKTsKICAgICAgfQogICAgfSk7CgogICAgX3RoaXMuX3N5bmNPYmoub2JzZXJ2ZShmdW5jdGlvbiAoZXZlbnQpIHsKICAgICAgY29uc29sZS5sb2coJ0RhdGFPYmplY3RSZXBvcnRlci0nICsgdXJsICsgJy1TRU5EOiAnLCBldmVudCk7CiAgICAgIF90aGlzLl9vbkNoYW5nZShldmVudCk7CiAgICB9KTsKCiAgICBfdGhpcy5fc3Vic2NyaXB0aW9ucyA9IHt9OwogIH0KCiAgLyoqCiAgICogU3Vic2NyaXB0aW9ucyByZXF1ZXN0ZWQgYW5kIGFjY2VwdGVkIHRvIHRoaXMgcmVwb3J0ZXIKICAgKiBAdHlwZSB7T2JqZWN0PEh5cGVydHlVUkwsIFN5bmNTdWJzY3JpcHRpb24+fQogICAqLwoKICBfY3JlYXRlQ2xhc3MoRGF0YU9iamVjdFJlcG9ydGVyLCBbewogICAga2V5OiAnb25TdWJzY3JpcHRpb24nLAoKICAgIC8qKgogICAgICogU2V0dXAgdGhlIGNhbGxiYWNrIHRvIHByb2Nlc3Mgc3Vic2NyaWJlIGFuZCB1bnN1YnNjcmliZSBub3RpZmljYXRpb25zCiAgICAgKiBAcGFyYW0ge2Z1bmN0aW9uKGV2ZW50OiBNc2dFdmVudCl9IGNhbGxiYWNrCiAgICAgKi8KICAgIHZhbHVlOiBmdW5jdGlvbiBvblN1YnNjcmlwdGlvbihjYWxsYmFjaykgewogICAgICB0aGlzLl9vblN1YnNjcmlwdGlvbkhhbmRsZXIgPSBjYWxsYmFjazsKICAgIH0KCiAgICAvKioKICAgICAqIFNldHVwIHRoZSBjYWxsYmFjayB0byBwcm9jZXNzIHJlc3BvbnNlIG5vdGlmaWNhdGlvbnMgb2YgdGhlIGNyZWF0ZSdzCiAgICAgKiBAcGFyYW0ge2Z1bmN0aW9uKGV2ZW50OiBNc2dFdmVudCl9IGNhbGxiYWNrCiAgICAgKi8KICB9LCB7CiAgICBrZXk6ICdvblJlc3BvbnNlJywKICAgIHZhbHVlOiBmdW5jdGlvbiBvblJlc3BvbnNlKGNhbGxiYWNrKSB7CiAgICAgIHRoaXMuX29uUmVzcG9uc2VIYW5kbGVyID0gY2FsbGJhY2s7CiAgICB9CiAgfSwgewogICAga2V5OiAnX29uRm9yd2FyZCcsCiAgICB2YWx1ZTogZnVuY3Rpb24gX29uRm9yd2FyZChtc2cpIHsKICAgICAgdmFyIF90aGlzID0gdGhpczsKCiAgICAgIGNvbnNvbGUubG9nKCdEYXRhT2JqZWN0UmVwb3J0ZXItUkNWOiAnLCBtc2cpOwogICAgICBzd2l0Y2ggKG1zZy5ib2R5LnR5cGUpIHsKICAgICAgICBjYXNlICdzdWJzY3JpYmUnOgogICAgICAgICAgX3RoaXMuX29uU3Vic2NyaWJlKG1zZyk7YnJlYWs7CiAgICAgICAgY2FzZSAndW5zdWJzY3JpYmUnOgogICAgICAgICAgX3RoaXMuX29uVW5TdWJzY3JpYmUobXNnKTticmVhazsKICAgICAgfQogICAgfQogIH0sIHsKICAgIGtleTogJ19vblN1YnNjcmliZScsCiAgICB2YWx1ZTogZnVuY3Rpb24gX29uU3Vic2NyaWJlKG1zZykgewogICAgICB2YXIgX3RoaXMgPSB0aGlzOwogICAgICB2YXIgaHlwZXJ0eVVybCA9IG1zZy5ib2R5LmZyb207CgogICAgICB2YXIgZXZlbnQgPSB7CiAgICAgICAgdHlwZTogbXNnLmJvZHkudHlwZSwKICAgICAgICB1cmw6IGh5cGVydHlVcmwsCgogICAgICAgIGFjY2VwdDogZnVuY3Rpb24gYWNjZXB0KCkgewogICAgICAgICAgLy9jcmVhdGUgbmV3IHN1YnNjcmlwdGlvbgogICAgICAgICAgdmFyIHN1YiA9IHsgdXJsOiBoeXBlcnR5VXJsLCBzdGF0dXM6ICdvbicgfTsKICAgICAgICAgIF90aGlzLl9zdWJzY3JpcHRpb25zW2h5cGVydHlVcmxdID0gc3ViOwoKICAgICAgICAgIC8vc2VuZCBvayByZXNwb25zZSBtZXNzYWdlCiAgICAgICAgICBfdGhpcy5fYnVzLnBvc3RNZXNzYWdlKHsKICAgICAgICAgICAgaWQ6IG1zZy5pZCwgdHlwZTogJ3Jlc3BvbnNlJywgZnJvbTogbXNnLnRvLCB0bzogbXNnLmZyb20sCiAgICAgICAgICAgIGJvZHk6IHsgY29kZTogMjAwLCBzY2hlbWE6IF90aGlzLl9zY2hlbWEsIHZlcnNpb246IF90aGlzLl92ZXJzaW9uLCB2YWx1ZTogKDAsIF91dGlsc1V0aWxzSnMuZGVlcENsb25lKShfdGhpcy5kYXRhKSB9CiAgICAgICAgICB9KTsKCiAgICAgICAgICByZXR1cm4gc3ViOwogICAgICAgIH0sCgogICAgICAgIHJlamVjdDogZnVuY3Rpb24gcmVqZWN0KHJlYXNvbikgewogICAgICAgICAgLy9zZW5kIHJlamVjdCByZXNwb25zZSBtZXNzYWdlCiAgICAgICAgICBfdGhpcy5fYnVzLnBvc3RNZXNzYWdlKHsKICAgICAgICAgICAgaWQ6IG1zZy5pZCwgdHlwZTogJ3Jlc3BvbnNlJywgZnJvbTogbXNnLnRvLCB0bzogbXNnLmZyb20sCiAgICAgICAgICAgIGJvZHk6IHsgY29kZTogNDAzLCBkZXNjOiByZWFzb24gfQogICAgICAgICAgfSk7CiAgICAgICAgfQogICAgICB9OwoKICAgICAgaWYgKF90aGlzLl9vblN1YnNjcmlwdGlvbkhhbmRsZXIpIHsKICAgICAgICBfdGhpcy5fb25TdWJzY3JpcHRpb25IYW5kbGVyKGV2ZW50KTsKICAgICAgfQogICAgfQogIH0sIHsKICAgIGtleTogJ19vblVuU3Vic2NyaWJlJywKICAgIHZhbHVlOiBmdW5jdGlvbiBfb25VblN1YnNjcmliZShtc2cpIHsKICAgICAgdmFyIF90aGlzID0gdGhpczsKICAgICAgdmFyIGh5cGVydHlVcmwgPSBtc2cuYm9keS5mcm9tOwoKICAgICAgdmFyIHN1YiA9IF90aGlzLl9zdWJzY3JpcHRpb25zW2h5cGVydHlVcmxdOwogICAgICBkZWxldGUgX3RoaXMuX3N1YnNjcmlwdGlvbnNbaHlwZXJ0eVVybF07CgogICAgICB2YXIgZXZlbnQgPSB7CiAgICAgICAgdHlwZTogbXNnLmJvZHkudHlwZSwKICAgICAgICB1cmw6IGh5cGVydHlVcmwsCiAgICAgICAgb2JqZWN0OiBzdWIKICAgICAgfTsKCiAgICAgIGlmIChfdGhpcy5fb25TdWJzY3JpcHRpb25IYW5kbGVyKSB7CiAgICAgICAgX3RoaXMuX29uU3Vic2NyaXB0aW9uSGFuZGxlcihldmVudCk7CiAgICAgIH0KICAgIH0KICB9LCB7CiAgICBrZXk6ICdfb25SZXNwb25zZScsCiAgICB2YWx1ZTogZnVuY3Rpb24gX29uUmVzcG9uc2UobXNnKSB7CiAgICAgIHZhciBfdGhpcyA9IHRoaXM7CgogICAgICB2YXIgZXZlbnQgPSB7CiAgICAgICAgdHlwZTogbXNnLnR5cGUsCiAgICAgICAgdXJsOiBtc2cuZnJvbSwKICAgICAgICBjb2RlOiBtc2cuYm9keS5jb2RlCiAgICAgIH07CgogICAgICBpZiAoX3RoaXMuX29uUmVzcG9uc2VIYW5kbGVyKSB7CiAgICAgICAgX3RoaXMuX29uUmVzcG9uc2VIYW5kbGVyKGV2ZW50KTsKICAgICAgfQogICAgfQogIH0sIHsKICAgIGtleTogJ3N1YnNjcmlwdGlvbnMnLAogICAgZ2V0OiBmdW5jdGlvbiBnZXQoKSB7CiAgICAgIHJldHVybiB0aGlzLl9zdWJzY3JpcHRpb25zOwogICAgfQogIH1dKTsKCiAgcmV0dXJuIERhdGFPYmplY3RSZXBvcnRlcjsKfSkoX0RhdGFPYmplY3QzWydkZWZhdWx0J10gLyogaW1wbGVtZW50cyBTeW5jU3RhdHVzICovKTsKCmV4cG9ydHNbJ2RlZmF1bHQnXSA9IERhdGFPYmplY3RSZXBvcnRlcjsKbW9kdWxlLmV4cG9ydHMgPSBleHBvcnRzWydkZWZhdWx0J107Cgp9LHsiLi4vdXRpbHMvdXRpbHMuanMiOjE1LCIuL0RhdGFPYmplY3QiOjd9XSwxMTpbZnVuY3Rpb24ocmVxdWlyZSxtb2R1bGUsZXhwb3J0cyl7Ci8qKgogKiBAYWNjZXNzIHByaXZhdGUKICovCid1c2Ugc3RyaWN0JzsKCk9iamVjdC5kZWZpbmVQcm9wZXJ0eShleHBvcnRzLCAnX19lc01vZHVsZScsIHsKICB2YWx1ZTogdHJ1ZQp9KTsKCnZhciBfY3JlYXRlQ2xhc3MgPSAoZnVuY3Rpb24gKCkgeyBmdW5jdGlvbiBkZWZpbmVQcm9wZXJ0aWVzKHRhcmdldCwgcHJvcHMpIHsgZm9yICh2YXIgaSA9IDA7IGkgPCBwcm9wcy5sZW5ndGg7IGkrKykgeyB2YXIgZGVzY3JpcHRvciA9IHByb3BzW2ldOyBkZXNjcmlwdG9yLmVudW1lcmFibGUgPSBkZXNjcmlwdG9yLmVudW1lcmFibGUgfHwgZmFsc2U7IGRlc2NyaXB0b3IuY29uZmlndXJhYmxlID0gdHJ1ZTsgaWYgKCd2YWx1ZScgaW4gZGVzY3JpcHRvcikgZGVzY3JpcHRvci53cml0YWJsZSA9IHRydWU7IE9iamVjdC5kZWZpbmVQcm9wZXJ0eSh0YXJnZXQsIGRlc2NyaXB0b3Iua2V5LCBkZXNjcmlwdG9yKTsgfSB9IHJldHVybiBmdW5jdGlvbiAoQ29uc3RydWN0b3IsIHByb3RvUHJvcHMsIHN0YXRpY1Byb3BzKSB7IGlmIChwcm90b1Byb3BzKSBkZWZpbmVQcm9wZXJ0aWVzKENvbnN0cnVjdG9yLnByb3RvdHlwZSwgcHJvdG9Qcm9wcyk7IGlmIChzdGF0aWNQcm9wcykgZGVmaW5lUHJvcGVydGllcyhDb25zdHJ1Y3Rvciwgc3RhdGljUHJvcHMpOyByZXR1cm4gQ29uc3RydWN0b3I7IH07IH0pKCk7CgpmdW5jdGlvbiBfY2xhc3NDYWxsQ2hlY2soaW5zdGFuY2UsIENvbnN0cnVjdG9yKSB7IGlmICghKGluc3RhbmNlIGluc3RhbmNlb2YgQ29uc3RydWN0b3IpKSB7IHRocm93IG5ldyBUeXBlRXJyb3IoJ0Nhbm5vdCBjYWxsIGEgY2xhc3MgYXMgYSBmdW5jdGlvbicpOyB9IH0KCnZhciBEYXRhUHJvdmlzaW9uYWwgPSAoZnVuY3Rpb24gKCkgewogIC8qIHByaXZhdGUKICBfY2hpbGRyZW5MaXN0ZW5lcnM6IFtNc2dMaXN0ZW5lcl0KICBfbGlzdGVuZXI6IE1zZ0xpc3RlbmVyCiAgIF9jaGFuZ2VzOiBbXQogICovCgogIGZ1bmN0aW9uIERhdGFQcm92aXNpb25hbChvd25lciwgdXJsLCBidXMsIGNoaWxkcmVuKSB7CiAgICBfY2xhc3NDYWxsQ2hlY2sodGhpcywgRGF0YVByb3Zpc2lvbmFsKTsKCiAgICB2YXIgX3RoaXMgPSB0aGlzOwoKICAgIF90aGlzLl9jaGFuZ2VzID0gW107CiAgICBfdGhpcy5fY2hpbGRyZW4gPSBjaGlsZHJlbjsKICAgIF90aGlzLl9jaGlsZHJlbkxpc3RlbmVycyA9IFtdOwoKICAgIF90aGlzLl9saXN0ZW5lciA9IGJ1cy5hZGRMaXN0ZW5lcih1cmwsIGZ1bmN0aW9uIChtc2cpIHsKICAgICAgY29uc29sZS5sb2coJ0RhdGFQcm92aXNpb25hbC0nICsgdXJsICsgJy1SQ1Y6ICcsIG1zZyk7CiAgICAgIF90aGlzLl9jaGFuZ2VzLnB1c2gobXNnKTsKICAgIH0pOwoKICAgIC8qaWYgKGNoaWxkcmVuKSB7CiAgICAgIGxldCBjaGlsZEJhc2VVUkwgPSB1cmwgKyAnL2NoaWxkcmVuLyc7CiAgICAgIGNoaWxkcmVuLmZvckVhY2goKGNoaWxkKSA9PiB7CiAgICAgICAgbGV0IGNoaWxkVVJMID0gY2hpbGRCYXNlVVJMICsgY2hpbGQ7CiAgICAgICAgbGV0IGxpc3RlbmVyID0gYnVzLmFkZExpc3RlbmVyKGNoaWxkVVJMLCAobXNnKSA9PiB7CiAgICAgICAgICAvL2lnbm9yZSBtc2cgc2VudCBieSBoaW1zZWxmCiAgICAgICAgICBpZiAobXNnLmZyb20gIT09IG93bmVyKSB7CiAgICAgICAgICAgIGNvbnNvbGUubG9nKG1zZyk7CiAgICAgICAgICB9CiAgICAgICAgfSk7CiAgICAgICAgIF90aGlzLl9jaGlsZHJlbkxpc3RlbmVycy5wdXNoKGxpc3RlbmVyKTsKICAgICAgfSk7CiAgICB9Ki8KICB9CgogIF9jcmVhdGVDbGFzcyhEYXRhUHJvdmlzaW9uYWwsIFt7CiAgICBrZXk6ICdhcHBseScsCiAgICB2YWx1ZTogZnVuY3Rpb24gYXBwbHkob2JzZXJ2ZXIpIHsKICAgICAgdmFyIF90aGlzID0gdGhpczsKICAgICAgX3RoaXMuX2NoYW5nZXMuZm9yRWFjaChmdW5jdGlvbiAoY2hhbmdlKSB7CiAgICAgICAgb2JzZXJ2ZXIuX2NoYW5nZU9iamVjdChvYnNlcnZlci5fc3luY09iaiwgY2hhbmdlKTsKICAgICAgfSk7CiAgICB9CiAgfSwgewogICAga2V5OiAncmVsZWFzZScsCiAgICB2YWx1ZTogZnVuY3Rpb24gcmVsZWFzZSgpIHsKICAgICAgdGhpcy5fbGlzdGVuZXIucmVtb3ZlKCk7CgogICAgICAvKnRoaXMuX2NoaWxkcmVuTGlzdGVuZXJzLmZvckVhY2goKGxpc3RlbmVyKSA9PiB7CiAgICAgICAgbGlzdGVuZXIucmVtb3ZlKCk7CiAgICAgIH0pOyovCiAgICB9CiAgfSwgewogICAga2V5OiAnY2hpbGRyZW4nLAogICAgZ2V0OiBmdW5jdGlvbiBnZXQoKSB7CiAgICAgIHJldHVybiB0aGlzLl9jaGlsZHJlbjsKICAgIH0KICB9XSk7CgogIHJldHVybiBEYXRhUHJvdmlzaW9uYWw7Cn0pKCk7CgpleHBvcnRzWydkZWZhdWx0J10gPSBEYXRhUHJvdmlzaW9uYWw7Cm1vZHVsZS5leHBvcnRzID0gZXhwb3J0c1snZGVmYXVsdCddOwoKfSx7fV0sMTI6W2Z1bmN0aW9uKHJlcXVpcmUsbW9kdWxlLGV4cG9ydHMpewondXNlIHN0cmljdCc7CgpPYmplY3QuZGVmaW5lUHJvcGVydHkoZXhwb3J0cywgJ19fZXNNb2R1bGUnLCB7CiAgdmFsdWU6IHRydWUKfSk7Cgp2YXIgX2NyZWF0ZUNsYXNzID0gKGZ1bmN0aW9uICgpIHsgZnVuY3Rpb24gZGVmaW5lUHJvcGVydGllcyh0YXJnZXQsIHByb3BzKSB7IGZvciAodmFyIGkgPSAwOyBpIDwgcHJvcHMubGVuZ3RoOyBpKyspIHsgdmFyIGRlc2NyaXB0b3IgPSBwcm9wc1tpXTsgZGVzY3JpcHRvci5lbnVtZXJhYmxlID0gZGVzY3JpcHRvci5lbnVtZXJhYmxlIHx8IGZhbHNlOyBkZXNjcmlwdG9yLmNvbmZpZ3VyYWJsZSA9IHRydWU7IGlmICgndmFsdWUnIGluIGRlc2NyaXB0b3IpIGRlc2NyaXB0b3Iud3JpdGFibGUgPSB0cnVlOyBPYmplY3QuZGVmaW5lUHJvcGVydHkodGFyZ2V0LCBkZXNjcmlwdG9yLmtleSwgZGVzY3JpcHRvcik7IH0gfSByZXR1cm4gZnVuY3Rpb24gKENvbnN0cnVjdG9yLCBwcm90b1Byb3BzLCBzdGF0aWNQcm9wcykgeyBpZiAocHJvdG9Qcm9wcykgZGVmaW5lUHJvcGVydGllcyhDb25zdHJ1Y3Rvci5wcm90b3R5cGUsIHByb3RvUHJvcHMpOyBpZiAoc3RhdGljUHJvcHMpIGRlZmluZVByb3BlcnRpZXMoQ29uc3RydWN0b3IsIHN0YXRpY1Byb3BzKTsgcmV0dXJuIENvbnN0cnVjdG9yOyB9OyB9KSgpOwoKZnVuY3Rpb24gX2NsYXNzQ2FsbENoZWNrKGluc3RhbmNlLCBDb25zdHJ1Y3RvcikgeyBpZiAoIShpbnN0YW5jZSBpbnN0YW5jZW9mIENvbnN0cnVjdG9yKSkgeyB0aHJvdyBuZXcgVHlwZUVycm9yKCdDYW5ub3QgY2FsbCBhIGNsYXNzIGFzIGEgZnVuY3Rpb24nKTsgfSB9Cgp2YXIgX3V0aWxzVXRpbHNKcyA9IHJlcXVpcmUoJy4uL3V0aWxzL3V0aWxzLmpzJyk7CgovKioKICogQGFjY2VzcyBwcml2YXRlCiAqLwoKdmFyIFN5bmNPYmplY3QgPSAoZnVuY3Rpb24gKCkgewogIC8qIHByaXZhdGUKICAgIF9kYXRhOiBhbnk7CiAgICBfb2JzZXJ2ZXJzOiAoKGV2ZW50OiBDaGFuZ2VFdmVudCkgPT4gdm9pZClbXQogICovCgogIGZ1bmN0aW9uIFN5bmNPYmplY3QoaW5pdGlhbERhdGEpIHsKICAgIF9jbGFzc0NhbGxDaGVjayh0aGlzLCBTeW5jT2JqZWN0KTsKCiAgICB2YXIgX3RoaXMgPSB0aGlzOwoKICAgIF90aGlzLl9vYnNlcnZlcnMgPSBbXTsKICAgIF90aGlzLl9maWx0ZXJzID0ge307CgogICAgaWYgKGluaXRpYWxEYXRhKSB7CiAgICAgIF90aGlzLl9kYXRhID0gKDAsIF91dGlsc1V0aWxzSnMuZGVlcENsb25lKShpbml0aWFsRGF0YSk7CiAgICB9IGVsc2UgewogICAgICBfdGhpcy5fZGF0YSA9IHt9OwogICAgfQoKICAgIF90aGlzLl9pbnRlcm5hbE9ic2VydmUobmV3IFBhdGgoKSwgX3RoaXMuX2RhdGEpOwogIH0KCiAgLy9keW5hbWljIHBhdGggZm9yIEFycmF5IGluZGV4Li4uCgogIF9jcmVhdGVDbGFzcyhTeW5jT2JqZWN0LCBbewogICAga2V5OiAnb2JzZXJ2ZScsCiAgICB2YWx1ZTogZnVuY3Rpb24gb2JzZXJ2ZShjYWxsYmFjaykgewogICAgICB0aGlzLl9vYnNlcnZlcnMucHVzaChjYWxsYmFjayk7CiAgICB9CiAgfSwgewogICAga2V5OiAnZmluZCcsCiAgICB2YWx1ZTogZnVuY3Rpb24gZmluZChwYXRoKSB7CiAgICAgIHZhciBsaXN0ID0gcGF0aC5zcGxpdCgnLicpOwoKICAgICAgcmV0dXJuIHRoaXMuX2ZpbmRXaXRoU3BsaXQobGlzdCk7CiAgICB9CiAgfSwgewogICAga2V5OiAnZmluZEJlZm9yZScsCiAgICB2YWx1ZTogZnVuY3Rpb24gZmluZEJlZm9yZShwYXRoKSB7CiAgICAgIHZhciByZXN1bHQgPSB7fTsKICAgICAgdmFyIGxpc3QgPSBwYXRoLnNwbGl0KCcuJyk7CiAgICAgIHJlc3VsdC5sYXN0ID0gbGlzdC5wb3AoKTsKICAgICAgcmVzdWx0Lm9iaiA9IHRoaXMuX2ZpbmRXaXRoU3BsaXQobGlzdCk7CgogICAgICByZXR1cm4gcmVzdWx0OwogICAgfQogIH0sIHsKICAgIGtleTogJ19maW5kV2l0aFNwbGl0JywKICAgIHZhbHVlOiBmdW5jdGlvbiBfZmluZFdpdGhTcGxpdChsaXN0KSB7CiAgICAgIHZhciBvYmogPSB0aGlzLl9kYXRhOwogICAgICBsaXN0LmZvckVhY2goZnVuY3Rpb24gKHZhbHVlKSB7CiAgICAgICAgb2JqID0gb2JqW3ZhbHVlXTsKICAgICAgfSk7CgogICAgICByZXR1cm4gb2JqOwogICAgfQogIH0sIHsKICAgIGtleTogJ19maXJlRXZlbnQnLAogICAgdmFsdWU6IGZ1bmN0aW9uIF9maXJlRXZlbnQoZXZlbnQpIHsKICAgICAgdGhpcy5fb2JzZXJ2ZXJzLmZvckVhY2goZnVuY3Rpb24gKGNhbGxiYWNrKSB7CiAgICAgICAgY2FsbGJhY2soZXZlbnQpOwogICAgICB9KTsKICAgIH0KICB9LCB7CiAgICBrZXk6ICdfaXNPYnNlcnZhYmxlJywKICAgIHZhbHVlOiBmdW5jdGlvbiBfaXNPYnNlcnZhYmxlKG9iaikgewogICAgICBpZiAob2JqLmNvbnN0cnVjdG9yID09PSBPYmplY3QgfHwgb2JqLmNvbnN0cnVjdG9yID09PSBBcnJheSkgewogICAgICAgIHJldHVybiB0cnVlOwogICAgICB9CgogICAgICByZXR1cm4gZmFsc2U7CiAgICB9CiAgfSwgewogICAga2V5OiAnX2ludGVybmFsT2JzZXJ2ZScsCiAgICB2YWx1ZTogZnVuY3Rpb24gX2ludGVybmFsT2JzZXJ2ZShwYXRoLCBvYmopIHsKICAgICAgdmFyIF90aGlzID0gdGhpczsKCiAgICAgIGlmIChfdGhpcy5faXNPYnNlcnZhYmxlKG9iaikpIHsKICAgICAgICB2YXIgaGFuZGxlciA9IGZ1bmN0aW9uIGhhbmRsZXIoY2hhbmdlcykgewogICAgICAgICAgX3RoaXMuX29uQ2hhbmdlcyhwYXRoLCBjaGFuZ2VzKTsKICAgICAgICB9OwoKICAgICAgICBpZiAob2JqLmNvbnN0cnVjdG9yID09PSBPYmplY3QpIHsKICAgICAgICAgIE9iamVjdC5vYnNlcnZlKG9iaiwgaGFuZGxlcik7CiAgICAgICAgICBmb3IgKHZhciBwcm9wIGluIG9iaikgewogICAgICAgICAgICBpZiAoX3RoaXMuX2lzT2JzZXJ2YWJsZShvYmpbcHJvcF0pKSB7CiAgICAgICAgICAgICAgX3RoaXMuX2ludGVybmFsT2JzZXJ2ZShwYXRoWyduZXcnXShwcm9wKSwgb2JqW3Byb3BdKTsKICAgICAgICAgICAgfQogICAgICAgICAgfQogICAgICAgIH0gZWxzZSBpZiAob2JqLmNvbnN0cnVjdG9yID09PSBBcnJheSkgewogICAgICAgICAgQXJyYXkub2JzZXJ2ZShvYmosIGhhbmRsZXIpOwogICAgICAgICAgZm9yICh2YXIgcHJvcCBpbiBvYmopIHsKICAgICAgICAgICAgaWYgKF90aGlzLl9pc09ic2VydmFibGUob2JqW3Byb3BdKSkgewogICAgICAgICAgICAgIHZhciBucCA9IHBhdGhbJ25ldyddKG5ldyBBcnJheUluZGV4KG9ialtwcm9wXSwgcHJvcCkpOwogICAgICAgICAgICAgIF90aGlzLl9pbnRlcm5hbE9ic2VydmUobnAsIG9ialtwcm9wXSk7CiAgICAgICAgICAgIH0KICAgICAgICAgIH0KICAgICAgICB9CiAgICAgIH0KICAgIH0KICB9LCB7CiAgICBrZXk6ICdfb25DaGFuZ2VzJywKICAgIHZhbHVlOiBmdW5jdGlvbiBfb25DaGFuZ2VzKHBhdGgsIGNoYW5nZXMpIHsKICAgICAgdmFyIF90aGlzMiA9IHRoaXM7CgogICAgICBmb3IgKHZhciBpIGluIGNoYW5nZXMpIHsKICAgICAgICB2YXIgb2JqID0gY2hhbmdlc1tpXS5vYmplY3Q7CiAgICAgICAgdmFyIG9ialR5cGUgPSB1bmRlZmluZWQ7CgogICAgICAgIGlmIChvYmouY29uc3RydWN0b3IgPT09IE9iamVjdCkgewogICAgICAgICAgb2JqVHlwZSA9IE9iamVjdFR5cGUuT0JKRUNUOwogICAgICAgIH0KCiAgICAgICAgaWYgKG9iai5jb25zdHJ1Y3RvciA9PT0gQXJyYXkpIHsKICAgICAgICAgIG9ialR5cGUgPSBPYmplY3RUeXBlLkFSUkFZOwogICAgICAgIH0KCiAgICAgICAgaWYgKGNoYW5nZXNbaV0udHlwZSA9PT0gJ3NwbGljZScpIHsKICAgICAgICAgIChmdW5jdGlvbiAoKSB7CiAgICAgICAgICAgIHZhciBpZHggPSBjaGFuZ2VzW2ldLmluZGV4OwogICAgICAgICAgICB2YXIgZmllbGQgPSBwYXRoWyduZXcnXSgnJyArIGlkeCk7CiAgICAgICAgICAgIHZhciBmaWVsZFN0cmluZyA9IGZpZWxkLnRvU3RyaW5nKCk7CgogICAgICAgICAgICB2YXIgcmVtb3ZlU2l6ZSA9IGNoYW5nZXNbaV0ucmVtb3ZlZC5sZW5ndGg7CiAgICAgICAgICAgIGlmIChyZW1vdmVTaXplICE9PSAwKSB7CiAgICAgICAgICAgICAgdmFyIHJlbW92ZVZhbHVlcyA9IGNoYW5nZXNbaV0ucmVtb3ZlZDsKICAgICAgICAgICAgICByZW1vdmVWYWx1ZXMuZm9yRWFjaChmdW5jdGlvbiAodmFsdWUsIGluZGV4KSB7CiAgICAgICAgICAgICAgICBpZiAoX3RoaXMyLl9pc09ic2VydmFibGUodmFsdWUpKSB7CiAgICAgICAgICAgICAgICAgIHBhdGgucmVtb3ZlSW5kZXgoaWR4ICsgaW5kZXgpOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIH0pOwoKICAgICAgICAgICAgICBfdGhpczIuX2ZpcmVFdmVudCh7CiAgICAgICAgICAgICAgICBjVHlwZTogQ2hhbmdlVHlwZS5SRU1PVkUsCiAgICAgICAgICAgICAgICBvVHlwZTogb2JqVHlwZSwKICAgICAgICAgICAgICAgIGZpZWxkOiBmaWVsZFN0cmluZywKICAgICAgICAgICAgICAgIGRhdGE6IHJlbW92ZVNpemUKICAgICAgICAgICAgICB9KTsKICAgICAgICAgICAgfQoKICAgICAgICAgICAgdmFyIGFkZFNpemUgPSBjaGFuZ2VzW2ldLmFkZGVkQ291bnQ7CiAgICAgICAgICAgIGlmIChhZGRTaXplICE9PSAwKSB7CiAgICAgICAgICAgICAgdmFyIGFkZFZhbHVlcyA9IG9iai5zbGljZShpZHgsIGlkeCArIGFkZFNpemUpOwogICAgICAgICAgICAgIGFkZFZhbHVlcy5mb3JFYWNoKGZ1bmN0aW9uICh2YWx1ZSwgaW5kZXgpIHsKICAgICAgICAgICAgICAgIGlmIChfdGhpczIuX2lzT2JzZXJ2YWJsZSh2YWx1ZSkpIHsKICAgICAgICAgICAgICAgICAgdmFyIG5wID0gcGF0aFsnbmV3J10obmV3IEFycmF5SW5kZXgodmFsdWUsIGlkeCArIGluZGV4KSk7CiAgICAgICAgICAgICAgICAgIF90aGlzMi5faW50ZXJuYWxPYnNlcnZlKG5wLCB2YWx1ZSk7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgfSk7CgogICAgICAgICAgICAgIF90aGlzMi5fZmlyZUV2ZW50KHsKICAgICAgICAgICAgICAgIGNUeXBlOiBDaGFuZ2VUeXBlLkFERCwKICAgICAgICAgICAgICAgIG9UeXBlOiBvYmpUeXBlLAogICAgICAgICAgICAgICAgZmllbGQ6IGZpZWxkU3RyaW5nLAogICAgICAgICAgICAgICAgZGF0YTogKDAsIF91dGlsc1V0aWxzSnMuZGVlcENsb25lKShhZGRWYWx1ZXMpCiAgICAgICAgICAgICAgfSk7CiAgICAgICAgICAgIH0KCiAgICAgICAgICAgIC8vcmUtZGVmaW5lIHBhdGhzLi4uCiAgICAgICAgICAgIGlmIChpZHggIT09IG9iai5sZW5ndGggLSAxKSB7CiAgICAgICAgICAgICAgcGF0aC5yZUluZGV4RnJvbShvYmopOwogICAgICAgICAgICB9CiAgICAgICAgICB9KSgpOwogICAgICAgIH0gZWxzZSB7CiAgICAgICAgICB2YXIgZmllbGQgPSBwYXRoWyduZXcnXShjaGFuZ2VzW2ldLm5hbWUpOwogICAgICAgICAgdmFyIGZpZWxkU3RyaW5nID0gZmllbGQudG9TdHJpbmcoKTsKCiAgICAgICAgICBpZiAoZmllbGRTdHJpbmcuaW5kZXhPZignU3ltYm9sJykgIT09IC0xKSB7CiAgICAgICAgICAgIC8vaGFjayBmb3IgUGhhbnRvbUpTMgogICAgICAgICAgICAvL2NvbnNvbGUubG9nKCdTWU1CT0w6ICcsIGNoYW5nZXNbaV0pOwogICAgICAgICAgICBjb250aW51ZTsKICAgICAgICAgIH0KCiAgICAgICAgICAvL2xldCBvbGRWYWx1ZSA9IGNoYW5nZXNbaV0ub2xkVmFsdWU7CiAgICAgICAgICB2YXIgbmV3VmFsdWUgPSBvYmpbY2hhbmdlc1tpXS5uYW1lXTsKICAgICAgICAgIGlmIChjaGFuZ2VzW2ldLnR5cGUgPT09ICd1cGRhdGUnKSB7CiAgICAgICAgICAgIHRoaXMuX2ZpcmVFdmVudCh7CiAgICAgICAgICAgICAgY1R5cGU6IENoYW5nZVR5cGUuVVBEQVRFLAogICAgICAgICAgICAgIG9UeXBlOiBvYmpUeXBlLAogICAgICAgICAgICAgIGZpZWxkOiBmaWVsZFN0cmluZywKICAgICAgICAgICAgICBkYXRhOiAoMCwgX3V0aWxzVXRpbHNKcy5kZWVwQ2xvbmUpKG5ld1ZhbHVlKQogICAgICAgICAgICB9KTsKICAgICAgICAgIH0KCiAgICAgICAgICBpZiAoY2hhbmdlc1tpXS50eXBlID09PSAnYWRkJykgewogICAgICAgICAgICB0aGlzLl9pbnRlcm5hbE9ic2VydmUoZmllbGQsIG5ld1ZhbHVlKTsKICAgICAgICAgICAgdGhpcy5fZmlyZUV2ZW50KHsKICAgICAgICAgICAgICBjVHlwZTogQ2hhbmdlVHlwZS5BREQsCiAgICAgICAgICAgICAgb1R5cGU6IG9ialR5cGUsCiAgICAgICAgICAgICAgZmllbGQ6IGZpZWxkU3RyaW5nLAogICAgICAgICAgICAgIGRhdGE6ICgwLCBfdXRpbHNVdGlsc0pzLmRlZXBDbG9uZSkobmV3VmFsdWUpCiAgICAgICAgICAgIH0pOwogICAgICAgICAgfQoKICAgICAgICAgIGlmIChjaGFuZ2VzW2ldLnR5cGUgPT09ICdkZWxldGUnKSB7CiAgICAgICAgICAgIHRoaXMuX2ZpcmVFdmVudCh7CiAgICAgICAgICAgICAgY1R5cGU6IENoYW5nZVR5cGUuUkVNT1ZFLAogICAgICAgICAgICAgIG9UeXBlOiBvYmpUeXBlLAogICAgICAgICAgICAgIGZpZWxkOiBmaWVsZFN0cmluZwogICAgICAgICAgICB9KTsKICAgICAgICAgIH0KICAgICAgICB9CiAgICAgIH0KICAgIH0KICB9LCB7CiAgICBrZXk6ICdkYXRhJywKICAgIGdldDogZnVuY3Rpb24gZ2V0KCkgewogICAgICByZXR1cm4gdGhpcy5fZGF0YTsKICAgIH0KICB9XSk7CgogIHJldHVybiBTeW5jT2JqZWN0Owp9KSgpOwoKdmFyIFBhdGggPSAoZnVuY3Rpb24gKCkgewogIGZ1bmN0aW9uIFBhdGgoKSB7CiAgICBfY2xhc3NDYWxsQ2hlY2sodGhpcywgUGF0aCk7CgogICAgdGhpcy5fcGF0aCA9IFtdOwogICAgdGhpcy5fb2JzZXJ2YWJsZXMgPSB7fTsgLy88aW5kZXg6QXJyYXlJbmRleD4KICB9CgogIF9jcmVhdGVDbGFzcyhQYXRoLCBbewogICAga2V5OiAncmVtb3ZlSW5kZXgnLAogICAgdmFsdWU6IGZ1bmN0aW9uIHJlbW92ZUluZGV4KGlkeCkgewogICAgICAvL2NvbnNvbGUubG9nKCdSRU1PVkUtUEFUSCAnICsgaWR4KTsKICAgICAgZGVsZXRlIHRoaXMuX29ic2VydmFibGVzW2lkeF07CiAgICB9CiAgfSwgewogICAga2V5OiAncmVJbmRleEZyb20nLAogICAgdmFsdWU6IGZ1bmN0aW9uIHJlSW5kZXhGcm9tKGFycmF5KSB7CiAgICAgIHZhciBfdGhpczMgPSB0aGlzOwoKICAgICAgT2JqZWN0LmtleXModGhpcy5fb2JzZXJ2YWJsZXMpLmZvckVhY2goZnVuY3Rpb24gKGtleSkgewogICAgICAgIHZhciBhcnJheUluZGV4ID0gX3RoaXMzLl9vYnNlcnZhYmxlc1trZXldOwogICAgICAgIHZhciBpZHggPSBhcnJheS5pbmRleE9mKGFycmF5SW5kZXgub2JqKTsKICAgICAgICBpZiAoYXJyYXlJbmRleC5pZHggIT0gaWR4KSB7CiAgICAgICAgICAvL2NvbnNvbGUubG9nKCdSRS1JTkRFWDogJyArIGtleSArICctPicgKyBpZHgpOwogICAgICAgICAgYXJyYXlJbmRleC5pZHggPSBpZHg7CiAgICAgICAgICBkZWxldGUgX3RoaXMzLl9vYnNlcnZhYmxlc1trZXldOwogICAgICAgICAgX3RoaXMzLl9vYnNlcnZhYmxlc1tpZHhdID0gYXJyYXlJbmRleDsKICAgICAgICB9CiAgICAgIH0pOwogICAgfQogIH0sIHsKICAgIGtleTogJ25ldycsCiAgICB2YWx1ZTogZnVuY3Rpb24gX25ldyhpZHgpIHsKICAgICAgaWYgKGlkeC5jb25zdHJ1Y3RvciA9PSBBcnJheUluZGV4KSB7CiAgICAgICAgLy9jb25zb2xlLmxvZygnUEFUSC1PQlNFUlY6ICcsIGlkeCk7CiAgICAgICAgdGhpcy5fb2JzZXJ2YWJsZXNbaWR4LmlkeF0gPSBpZHg7CiAgICAgIH0KCiAgICAgIHZhciBuUGF0aCA9IHRoaXMuY2xvbmUoKTsKICAgICAgblBhdGguX3BhdGgucHVzaChpZHgpOwoKICAgICAgcmV0dXJuIG5QYXRoOwogICAgfQogIH0sIHsKICAgIGtleTogJ2Nsb25lJywKICAgIHZhbHVlOiBmdW5jdGlvbiBjbG9uZSgpIHsKICAgICAgdmFyIG5QYXRoID0gbmV3IFBhdGgoKTsKICAgICAgdGhpcy5fcGF0aC5mb3JFYWNoKGZ1bmN0aW9uICh2YWx1ZSkgewogICAgICAgIG5QYXRoLl9wYXRoLnB1c2godmFsdWUpOwogICAgICB9KTsKCiAgICAgIHJldHVybiBuUGF0aDsKICAgIH0KICB9LCB7CiAgICBrZXk6ICd0b1N0cmluZycsCiAgICB2YWx1ZTogZnVuY3Rpb24gdG9TdHJpbmcoKSB7CiAgICAgIC8vVE9ETzogb3B0aW1pemUhIQogICAgICB2YXIgc3RyID0gJyc7CiAgICAgIHRoaXMuX3BhdGguZm9yRWFjaChmdW5jdGlvbiAodmFsdWUsIGluZGV4KSB7CiAgICAgICAgaWYgKGluZGV4ID09PSAwKSB7CiAgICAgICAgICBzdHIgPSB2YWx1ZS50b1N0cmluZygpOwogICAgICAgIH0gZWxzZSB7CiAgICAgICAgICBzdHIgKz0gJy4nICsgdmFsdWUudG9TdHJpbmcoKTsKICAgICAgICB9CiAgICAgIH0pOwoKICAgICAgcmV0dXJuIHN0cjsKICAgIH0KICB9XSk7CgogIHJldHVybiBQYXRoOwp9KSgpOwoKdmFyIEFycmF5SW5kZXggPSAoZnVuY3Rpb24gKCkgewogIGZ1bmN0aW9uIEFycmF5SW5kZXgob2JqLCBpZHgpIHsKICAgIF9jbGFzc0NhbGxDaGVjayh0aGlzLCBBcnJheUluZGV4KTsKCiAgICB0aGlzLm9iaiA9IG9iajsKICAgIHRoaXMuaWR4ID0gaWR4OwogIH0KCiAgX2NyZWF0ZUNsYXNzKEFycmF5SW5kZXgsIFt7CiAgICBrZXk6ICd0b1N0cmluZycsCiAgICB2YWx1ZTogZnVuY3Rpb24gdG9TdHJpbmcoKSB7CiAgICAgIHJldHVybiB0aGlzLmlkeC50b1N0cmluZygpOwogICAgfQogIH1dKTsKCiAgcmV0dXJuIEFycmF5SW5kZXg7Cn0pKCk7Cgp2YXIgQ2hhbmdlVHlwZSA9IHsgVVBEQVRFOiAndXBkYXRlJywgQUREOiAnYWRkJywgUkVNT1ZFOiAncmVtb3ZlJyB9OwpleHBvcnRzLkNoYW5nZVR5cGUgPSBDaGFuZ2VUeXBlOwp2YXIgT2JqZWN0VHlwZSA9IHsgT0JKRUNUOiAnb2JqZWN0JywgQVJSQVk6ICdhcnJheScgfTsKZXhwb3J0cy5PYmplY3RUeXBlID0gT2JqZWN0VHlwZTsKZXhwb3J0c1snZGVmYXVsdCddID0gU3luY09iamVjdDsKCn0seyIuLi91dGlscy91dGlscy5qcyI6MTV9XSwxMzpbZnVuY3Rpb24ocmVxdWlyZSxtb2R1bGUsZXhwb3J0cyl7Cid1c2Ugc3RyaWN0JzsKCk9iamVjdC5kZWZpbmVQcm9wZXJ0eShleHBvcnRzLCAnX19lc01vZHVsZScsIHsKICB2YWx1ZTogdHJ1ZQp9KTsKCnZhciBfY3JlYXRlQ2xhc3MgPSAoZnVuY3Rpb24gKCkgeyBmdW5jdGlvbiBkZWZpbmVQcm9wZXJ0aWVzKHRhcmdldCwgcHJvcHMpIHsgZm9yICh2YXIgaSA9IDA7IGkgPCBwcm9wcy5sZW5ndGg7IGkrKykgeyB2YXIgZGVzY3JpcHRvciA9IHByb3BzW2ldOyBkZXNjcmlwdG9yLmVudW1lcmFibGUgPSBkZXNjcmlwdG9yLmVudW1lcmFibGUgfHwgZmFsc2U7IGRlc2NyaXB0b3IuY29uZmlndXJhYmxlID0gdHJ1ZTsgaWYgKCd2YWx1ZScgaW4gZGVzY3JpcHRvcikgZGVzY3JpcHRvci53cml0YWJsZSA9IHRydWU7IE9iamVjdC5kZWZpbmVQcm9wZXJ0eSh0YXJnZXQsIGRlc2NyaXB0b3Iua2V5LCBkZXNjcmlwdG9yKTsgfSB9IHJldHVybiBmdW5jdGlvbiAoQ29uc3RydWN0b3IsIHByb3RvUHJvcHMsIHN0YXRpY1Byb3BzKSB7IGlmIChwcm90b1Byb3BzKSBkZWZpbmVQcm9wZXJ0aWVzKENvbnN0cnVjdG9yLnByb3RvdHlwZSwgcHJvdG9Qcm9wcyk7IGlmIChzdGF0aWNQcm9wcykgZGVmaW5lUHJvcGVydGllcyhDb25zdHJ1Y3Rvciwgc3RhdGljUHJvcHMpOyByZXR1cm4gQ29uc3RydWN0b3I7IH07IH0pKCk7CgpmdW5jdGlvbiBfaW50ZXJvcFJlcXVpcmVEZWZhdWx0KG9iaikgeyByZXR1cm4gb2JqICYmIG9iai5fX2VzTW9kdWxlID8gb2JqIDogeyAnZGVmYXVsdCc6IG9iaiB9OyB9CgpmdW5jdGlvbiBfY2xhc3NDYWxsQ2hlY2soaW5zdGFuY2UsIENvbnN0cnVjdG9yKSB7IGlmICghKGluc3RhbmNlIGluc3RhbmNlb2YgQ29uc3RydWN0b3IpKSB7IHRocm93IG5ldyBUeXBlRXJyb3IoJ0Nhbm5vdCBjYWxsIGEgY2xhc3MgYXMgYSBmdW5jdGlvbicpOyB9IH0KCnZhciBfRGF0YU9iamVjdFJlcG9ydGVyID0gcmVxdWlyZSgnLi9EYXRhT2JqZWN0UmVwb3J0ZXInKTsKCnZhciBfRGF0YU9iamVjdFJlcG9ydGVyMiA9IF9pbnRlcm9wUmVxdWlyZURlZmF1bHQoX0RhdGFPYmplY3RSZXBvcnRlcik7Cgp2YXIgX0RhdGFPYmplY3RPYnNlcnZlciA9IHJlcXVpcmUoJy4vRGF0YU9iamVjdE9ic2VydmVyJyk7Cgp2YXIgX0RhdGFPYmplY3RPYnNlcnZlcjIgPSBfaW50ZXJvcFJlcXVpcmVEZWZhdWx0KF9EYXRhT2JqZWN0T2JzZXJ2ZXIpOwoKdmFyIF9EYXRhUHJvdmlzaW9uYWwgPSByZXF1aXJlKCcuL0RhdGFQcm92aXNpb25hbCcpOwoKdmFyIF9EYXRhUHJvdmlzaW9uYWwyID0gX2ludGVyb3BSZXF1aXJlRGVmYXVsdChfRGF0YVByb3Zpc2lvbmFsKTsKCi8qKgogKiBUaGUgbWFpbiBjbGFzcyBmb3IgdGhlIHN5bmNoZXIgcGFja2FnZS4KICogVGhlIFN5bmNoZXIgaXMgYSBzaW5nbGV0b24gY2xhc3MgcGVyIEh5cGVydHkvVVJMIGFuZCBpdCBpcyB0aGUgb3duZXIgb2YgYWxsIGNyZWF0ZWQgRGF0YSBTeW5jIE9iamVjdHMgYWNjb3JkaW5nIHRvIHRoZSBSZXBvcnRlciAtIE9ic2VydmVyIHBhdHRlcm4uCiAqIE1haW4gZnVuY3Rpb25hbGl0eSBpcyB0byBjcmVhdGUgcmVwb3J0ZXJzIGFuZCB0byBzdWJzY3JpYmUgdG8gZXhpc3Rpbmcgb25lcy4KICovCgp2YXIgU3luY2hlciA9IChmdW5jdGlvbiAoKSB7CiAgLyogcHJpdmF0ZQogIF9vd25lcjogVVJMCiAgX2J1czogTWluaUJ1cwogICBfc3ViVVJMOiBVUkwKICAgX3JlcG9ydGVyczogPHVybDogRGF0YU9iamVjdFJlcG9ydGVyPgogIF9vYnNlcnZlcnM6IDx1cmw6IERhdGFPYmplY3RPYnNlcnZlcj4KICBfcHJvdmlzaW9uYWxzOiA8dXJsOiBEYXRhUHJvdmlzaW9uYWw+CiAgIC0tLS1ldmVudCBoYW5kbGVycy0tLS0KICBfb25Ob3RpZmljYXRpb25IYW5kbGVyOiAoZXZlbnQpID0+IHZvaWQKICAqLwoKICAvKioKICAgKiBDb25zdHJ1Y3RvciB0aGF0IHNob3VsZCBiZSB1c2VkIGJ5IHRoZSBIeXBlcnR5IG93bmVyCiAgICogQHBhcmFtIHtIeXBlcnR5VVJMfSBvd25lciAtIEh5cGVydHkgVVJMIG93bmVyLiBBbiBVUkwgYWxsb2NhdGVkIGJ5IHRoZSBydW50aW1lIHRoYXQgdW5pcXVlbHkgaWRlbnRpZmllcyB0aGUgSHlwZXJ0eS4KICAgKiBAcGFyYW0ge01pbmlCdXN9IGJ1cyAtIEFuIGluc3RhbmNlIG9mIHRoZSBNaW5pQnVzIHByb3ZpZGVkIGluIHRoZSBzYW5kYm94LiBXaGVuIGFuIG9iamVjdCAoUmVwb3J0ZXIgb3IgT2JzZXJ2ZWQpIGlzIGNyZWF0ZWQsIHRoZSBTeW5jaGVyTWFuYWdlciB3aWxsIGFkZCBhIGxpc3RlbmVyIGluIHRoZSBNaW5pQnVzIHRvIHJlY2VpdmUvc2VuZCBNZXNzYWdlcyBvZiB0aGF0IG9iamVjdC4KICAgKiBAcGFyYW0ge0pTT059IGNvbmZpZyAtIENvbmZpZ3VyYXRpb24gZGF0YS4gVGhlIG9ubHkgcmVxdWlyZWQgZmllbGQgZm9yIG5vdyBpcyB0aGUgcnVudGltZVVSTC4KICAgKi8KCiAgZnVuY3Rpb24gU3luY2hlcihvd25lciwgYnVzLCBjb25maWcpIHsKICAgIF9jbGFzc0NhbGxDaGVjayh0aGlzLCBTeW5jaGVyKTsKCiAgICB2YXIgX3RoaXMgPSB0aGlzOwoKICAgIF90aGlzLl9vd25lciA9IG93bmVyOwogICAgX3RoaXMuX2J1cyA9IGJ1czsKCiAgICBfdGhpcy5fc3ViVVJMID0gY29uZmlnLnJ1bnRpbWVVUkwgKyAnL3NtJzsKCiAgICBfdGhpcy5fcmVwb3J0ZXJzID0ge307CiAgICBfdGhpcy5fb2JzZXJ2ZXJzID0ge307CiAgICBfdGhpcy5fcHJvdmlzaW9uYWxzID0ge307CgogICAgYnVzLmFkZExpc3RlbmVyKG93bmVyLCBmdW5jdGlvbiAobXNnKSB7CiAgICAgIGNvbnNvbGUubG9nKCdTeW5jaGVyLVJDVjogJywgbXNnKTsKICAgICAgc3dpdGNoIChtc2cudHlwZSkgewogICAgICAgIGNhc2UgJ2ZvcndhcmQnOgogICAgICAgICAgX3RoaXMuX29uRm9yd2FyZChtc2cpO2JyZWFrOwogICAgICAgIGNhc2UgJ2NyZWF0ZSc6CiAgICAgICAgICBfdGhpcy5fb25SZW1vdGVDcmVhdGUobXNnKTticmVhazsKICAgICAgfQogICAgfSk7CiAgfQoKICAvKioKICAgKiBUaGUgb3duZXIgb2YgdGhlIFN5bmNoZXIgYW5kIGFsbCBjcmVhdGVkIHJlcG9ydGVycy4KICAgKiBAdHlwZSB7SHlwZXJ0eVVSTH0KICAgKi8KCiAgX2NyZWF0ZUNsYXNzKFN5bmNoZXIsIFt7CiAgICBrZXk6ICdjcmVhdGUnLAoKICAgIC8qKgogICAgICogUmVxdWVzdCBhIERhdGFPYmplY3RSZXBvcnRlciBjcmVhdGlvbi4gVGhlIFVSTCB3aWxsIGJlIGJlIHJlcXVlc3RlZCBieSB0aGUgYWxsb2NhdGlvbiBtZWNoYW5pc20uCiAgICAgKiBAcGFyYW0gIHtTY2hlbWFVUkx9IHNjaGVtYSAtIFVSTCBvZiB0aGUgb2JqZWN0IGRlc2NyaXB0b3IKICAgICAqIEBwYXJhbSAge0h5cGVydHlVUkxbXX0gb2JzZXJ2ZXJzIC0gTGlzdCBvZiBoeXBlcnRpZXMgdGhhdCBhcmUgcHJlLWF1dGhvcml6ZWQgZm9yIHN1YnNjcmlwdGlvbgogICAgICogQHBhcmFtICB7SlNPTn0gaW5pdGlhbERhdGEgLSBJbml0aWFsIGRhdGEgb2YgdGhlIHJlcG9ydGVyCiAgICAgKiBAcmV0dXJuIHtQcm9taXNlPERhdGFPYmplY3RSZXBvcnRlcj59IFJldHVybiBQcm9taXNlIHRvIGEgbmV3IFJlcG9ydGVyLiBUaGUgcmVwb3J0ZXIgY2FuIGJlIGFjY2VwdGVkIG9yIHJlamVjdGVkIGJ5IHRoZSBQRVAKICAgICAqLwogICAgdmFsdWU6IGZ1bmN0aW9uIGNyZWF0ZShzY2hlbWEsIG9ic2VydmVycywgaW5pdGlhbERhdGEpIHsKICAgICAgdmFyIF90aGlzID0gdGhpczsKCiAgICAgIHZhciByZXF1ZXN0TXNnID0gewogICAgICAgIHR5cGU6ICdjcmVhdGUnLCBmcm9tOiBfdGhpcy5fb3duZXIsIHRvOiBfdGhpcy5fc3ViVVJMLAogICAgICAgIGJvZHk6IHsgc2NoZW1hOiBzY2hlbWEsIHZhbHVlOiBpbml0aWFsRGF0YSwgYXV0aG9yaXNlOiBvYnNlcnZlcnMgfQogICAgICB9OwoKICAgICAgcmV0dXJuIG5ldyBQcm9taXNlKGZ1bmN0aW9uIChyZXNvbHZlLCByZWplY3QpIHsKICAgICAgICAvL3JlcXVlc3QgY3JlYXRlIHRvIHRoZSBBbGxvY2F0aW9uIHN5c3RlbT8gQ2FuIGJlIHJlamVjdGVkIGJ5IHRoZSBQb2xpY3lFbmdpbmUuCiAgICAgICAgX3RoaXMuX2J1cy5wb3N0TWVzc2FnZShyZXF1ZXN0TXNnLCBmdW5jdGlvbiAocmVwbHkpIHsKICAgICAgICAgIGNvbnNvbGUubG9nKCdjcmVhdGUtcmVzcG9uc2U6ICcsIHJlcGx5KTsKICAgICAgICAgIGlmIChyZXBseS5ib2R5LmNvZGUgPT09IDIwMCkgewogICAgICAgICAgICB2YXIgb2JqVVJMID0gcmVwbHkuYm9keS5yZXNvdXJjZTsKCiAgICAgICAgICAgIC8vcmVwb3J0ZXIgY3JlYXRpb24gYWNjZXB0ZWQKICAgICAgICAgICAgdmFyIG5ld09iaiA9IG5ldyBfRGF0YU9iamVjdFJlcG9ydGVyMlsnZGVmYXVsdCddKF90aGlzLl9vd25lciwgb2JqVVJMLCBzY2hlbWEsIF90aGlzLl9idXMsICdvbicsIGluaXRpYWxEYXRhLCByZXBseS5ib2R5LmNoaWxkcmVuKTsKICAgICAgICAgICAgX3RoaXMuX3JlcG9ydGVyc1tvYmpVUkxdID0gbmV3T2JqOwoKICAgICAgICAgICAgcmVzb2x2ZShuZXdPYmopOwogICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgLy9yZXBvcnRlciBjcmVhdGlvbiByZWplY3RlZAogICAgICAgICAgICByZWplY3QocmVwbHkuYm9keS5kZXNjKTsKICAgICAgICAgIH0KICAgICAgICB9KTsKICAgICAgfSk7CiAgICB9CgogICAgLyoqCiAgICAgKiBSZXF1ZXN0IGEgc3Vic2NyaXB0aW9uIHRvIGFuIGV4aXN0ZW50IG9iamVjdC4KICAgICAqIEBwYXJhbSB7U2NoZW1hVVJMfSBzY2hlbWEgLSBVUkwgb2YgdGhlIG9iamVjdCBkZXNjcmlwdG9yCiAgICAgKiBAcGFyYW0ge09iamVjdFVSTH0gb2JqVVJMIC0gQWRkcmVzcyBvZiB0aGUgZXhpc3RlbnQgcmVwb3J0ZXIgb2JqZWN0CiAgICAgKiBAcmV0dXJuIHtQcm9taXNlPERhdGFPYmplY3RPYnNlcnZlcj59IFJldHVybiBQcm9taXNlIHRvIGEgbmV3IG9ic2VydmVyLgogICAgICovCiAgfSwgewogICAga2V5OiAnc3Vic2NyaWJlJywKICAgIHZhbHVlOiBmdW5jdGlvbiBzdWJzY3JpYmUoc2NoZW1hLCBvYmpVUkwpIHsKICAgICAgdmFyIF90aGlzID0gdGhpczsKCiAgICAgIC8vVE9ETzogdmFsaWRhdGUgaWYgc3Vic2NyaXB0aW9uIGFscmVhZHkgZXhpc3RzID8KICAgICAgdmFyIHN1YnNjcmliZU1zZyA9IHsKICAgICAgICB0eXBlOiAnc3Vic2NyaWJlJywgZnJvbTogX3RoaXMuX293bmVyLCB0bzogX3RoaXMuX3N1YlVSTCwKICAgICAgICBib2R5OiB7IHNjaGVtYTogc2NoZW1hLCByZXNvdXJjZTogb2JqVVJMIH0KICAgICAgfTsKCiAgICAgIHJldHVybiBuZXcgUHJvbWlzZShmdW5jdGlvbiAocmVzb2x2ZSwgcmVqZWN0KSB7CiAgICAgICAgLy9yZXF1ZXN0IHN1YnNjcmlwdGlvbgogICAgICAgIF90aGlzLl9idXMucG9zdE1lc3NhZ2Uoc3Vic2NyaWJlTXNnLCBmdW5jdGlvbiAocmVwbHkpIHsKICAgICAgICAgIGNvbnNvbGUubG9nKCdzdWJzY3JpYmUtcmVzcG9uc2U6ICcsIHJlcGx5KTsKICAgICAgICAgIHZhciBuZXdQcm92aXNpb25hbCA9IF90aGlzLl9wcm92aXNpb25hbHNbb2JqVVJMXTsKICAgICAgICAgIGRlbGV0ZSBfdGhpcy5fcHJvdmlzaW9uYWxzW29ialVSTF07CiAgICAgICAgICBpZiAobmV3UHJvdmlzaW9uYWwpIG5ld1Byb3Zpc2lvbmFsLnJlbGVhc2UoKTsKCiAgICAgICAgICBpZiAocmVwbHkuYm9keS5jb2RlIDwgMjAwKSB7CiAgICAgICAgICAgIG5ld1Byb3Zpc2lvbmFsID0gbmV3IF9EYXRhUHJvdmlzaW9uYWwyWydkZWZhdWx0J10oX3RoaXMuX293bmVyLCBvYmpVUkwsIF90aGlzLl9idXMsIHJlcGx5LmJvZHkuY2hpbGRyZW5SZXNvdXJjZXMpOwogICAgICAgICAgICBfdGhpcy5fcHJvdmlzaW9uYWxzW29ialVSTF0gPSBuZXdQcm92aXNpb25hbDsKICAgICAgICAgIH0gZWxzZSBpZiAocmVwbHkuYm9keS5jb2RlID09PSAyMDApIHsKICAgICAgICAgICAgdmFyIG5ld09iaiA9IG5ldyBfRGF0YU9iamVjdE9ic2VydmVyMlsnZGVmYXVsdCddKF90aGlzLl9vd25lciwgb2JqVVJMLCBzY2hlbWEsIF90aGlzLl9idXMsICdvbicsIHJlcGx5LmJvZHkudmFsdWUsIG5ld1Byb3Zpc2lvbmFsLmNoaWxkcmVuLCByZXBseS5ib2R5LnZlcnNpb24pOwoKICAgICAgICAgICAgcmVzb2x2ZShuZXdPYmopOwogICAgICAgICAgICBuZXdQcm92aXNpb25hbC5hcHBseShuZXdPYmopOwogICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgcmVqZWN0KHJlcGx5LmJvZHkuZGVzYyk7CiAgICAgICAgICB9CiAgICAgICAgfSk7CiAgICAgIH0pOwogICAgfQoKICAgIC8qKgogICAgICogU2V0dXAgdGhlIGNhbGxiYWNrIHRvIHByb2Nlc3MgY3JlYXRlIGFuZCBkZWxldGUgZXZlbnRzIG9mIHJlbW92ZSBSZXBvcnRlciBvYmplY3RzLgogICAgICogVGhpcyBpcyByZWxlYXRlZCB0byB0aGUgbWVzc2FnZW5zIHNlbnQgYnkgY3JlYXRlIHRvIHRoZSBvYnNlcnZlcnMgSHlwZXJ0eSBhcnJheS4KICAgICAqIEBwYXJhbSB7ZnVuY3Rpb24oZXZlbnQ6IE1zZ0V2ZW50KX0gY2FsbGJhY2sKICAgICAqLwogIH0sIHsKICAgIGtleTogJ29uTm90aWZpY2F0aW9uJywKICAgIHZhbHVlOiBmdW5jdGlvbiBvbk5vdGlmaWNhdGlvbihjYWxsYmFjaykgewogICAgICB0aGlzLl9vbk5vdGlmaWNhdGlvbkhhbmRsZXIgPSBjYWxsYmFjazsKICAgIH0KICB9LCB7CiAgICBrZXk6ICdfb25Gb3J3YXJkJywKICAgIHZhbHVlOiBmdW5jdGlvbiBfb25Gb3J3YXJkKG1zZykgewogICAgICB2YXIgX3RoaXMgPSB0aGlzOwoKICAgICAgdmFyIHJlcG9ydGVyID0gX3RoaXMuX3JlcG9ydGVyc1ttc2cuYm9keS50b107CiAgICAgIHJlcG9ydGVyLl9vbkZvcndhcmQobXNnKTsKICAgIH0KICB9LCB7CiAgICBrZXk6ICdfb25SZW1vdGVDcmVhdGUnLAogICAgdmFsdWU6IGZ1bmN0aW9uIF9vblJlbW90ZUNyZWF0ZShtc2cpIHsKICAgICAgdmFyIF90aGlzID0gdGhpczsKCiAgICAgIHZhciBldmVudCA9IHsKICAgICAgICB0eXBlOiBtc2cudHlwZSwKICAgICAgICBmcm9tOiBtc2cuZnJvbSwKICAgICAgICB1cmw6IG1zZy5ib2R5LnJlc291cmNlLAogICAgICAgIHNjaGVtYTogbXNnLmJvZHkuc2NoZW1hLAogICAgICAgIHZhbHVlOiBtc2cuYm9keS52YWx1ZSwKICAgICAgICBpZGVudGl0eTogbXNnLmJvZHkuaWRUb2tlbiwKCiAgICAgICAgYWNrOiBmdW5jdGlvbiBhY2sodHlwZSkgewogICAgICAgICAgdmFyIGxUeXBlID0gMjAwOwogICAgICAgICAgaWYgKHR5cGUpIHsKICAgICAgICAgICAgbFR5cGUgPSB0eXBlOwogICAgICAgICAgfQoKICAgICAgICAgIC8vc2VuZCBhY2sgcmVzcG9uc2UgbWVzc2FnZQogICAgICAgICAgX3RoaXMuX2J1cy5wb3N0TWVzc2FnZSh7CiAgICAgICAgICAgIGlkOiBtc2cuaWQsIHR5cGU6ICdyZXNwb25zZScsIGZyb206IG1zZy50bywgdG86IG1zZy5mcm9tLAogICAgICAgICAgICBib2R5OiB7IGNvZGU6IGxUeXBlLCBzb3VyY2U6IG1zZy5ib2R5LnJlc291cmNlIH0KICAgICAgICAgIH0pOwogICAgICAgIH0KICAgICAgfTsKCiAgICAgIGlmIChfdGhpcy5fb25Ob3RpZmljYXRpb25IYW5kbGVyKSB7CiAgICAgICAgX3RoaXMuX29uTm90aWZpY2F0aW9uSGFuZGxlcihldmVudCk7CiAgICAgIH0KICAgIH0KICB9LCB7CiAgICBrZXk6ICdvd25lcicsCiAgICBnZXQ6IGZ1bmN0aW9uIGdldCgpIHsKICAgICAgcmV0dXJuIHRoaXMuX293bmVyOwogICAgfQoKICAgIC8qKgogICAgICogQWxsIG93bmVkIHJlcG9ydGVycywgdGhlIG9uZXMgdGhhdCB3ZXJlIGNyZWF0ZWQgYnkgYSBjcmVhdGUKICAgICAqIEB0eXBlIHtPYmplY3Q8VVJMLCBEYXRhT2JqZWN0UmVwb3J0ZXI+fQogICAgICovCiAgfSwgewogICAga2V5OiAncmVwb3J0ZXJzJywKICAgIGdldDogZnVuY3Rpb24gZ2V0KCkgewogICAgICByZXR1cm4gdGhpcy5fcmVwb3J0ZXJzOwogICAgfQoKICAgIC8qKgogICAgICogQWxsIG93bmVkIG9ic2VydmVycywgdGhlIG9uZXMgdGhhdCB3ZXJlIGNyZWF0ZWQgYnkgYSBsb2NhbCBzdWJzY3JpcHRpb24KICAgICAqIEB0eXBlIHtPYmplY3Q8VVJMLCBEYXRhT2JqZWN0T2JzZXJ2ZXI+fQogICAgICovCiAgfSwgewogICAga2V5OiAnb2JzZXJ2ZXJzJywKICAgIGdldDogZnVuY3Rpb24gZ2V0KCkgewogICAgICByZXR1cm4gdGhpcy5fb2JzZXJ2ZXJzOwogICAgfQogIH1dKTsKCiAgcmV0dXJuIFN5bmNoZXI7Cn0pKCk7CgpleHBvcnRzWydkZWZhdWx0J10gPSBTeW5jaGVyOwptb2R1bGUuZXhwb3J0cyA9IGV4cG9ydHNbJ2RlZmF1bHQnXTsKCn0seyIuL0RhdGFPYmplY3RPYnNlcnZlciI6OSwiLi9EYXRhT2JqZWN0UmVwb3J0ZXIiOjEwLCIuL0RhdGFQcm92aXNpb25hbCI6MTF9XSwxNDpbZnVuY3Rpb24ocmVxdWlyZSxtb2R1bGUsZXhwb3J0cyl7Ci8qKgogKiBFdmVudEVtaXR0ZXIKICogQWxsIGNsYXNzZXMgd2hpY2ggZXh0ZW5kcyB0aGlzLCBjYW4gaGF2ZSBhZGRFdmVudExpc3RlbmVyIGFuZCB0cmlnZ2VyIGV2ZW50czsKICovCiJ1c2Ugc3RyaWN0IjsKCk9iamVjdC5kZWZpbmVQcm9wZXJ0eShleHBvcnRzLCAiX19lc01vZHVsZSIsIHsKICB2YWx1ZTogdHJ1ZQp9KTsKCnZhciBfY3JlYXRlQ2xhc3MgPSAoZnVuY3Rpb24gKCkgeyBmdW5jdGlvbiBkZWZpbmVQcm9wZXJ0aWVzKHRhcmdldCwgcHJvcHMpIHsgZm9yICh2YXIgaSA9IDA7IGkgPCBwcm9wcy5sZW5ndGg7IGkrKykgeyB2YXIgZGVzY3JpcHRvciA9IHByb3BzW2ldOyBkZXNjcmlwdG9yLmVudW1lcmFibGUgPSBkZXNjcmlwdG9yLmVudW1lcmFibGUgfHwgZmFsc2U7IGRlc2NyaXB0b3IuY29uZmlndXJhYmxlID0gdHJ1ZTsgaWYgKCJ2YWx1ZSIgaW4gZGVzY3JpcHRvcikgZGVzY3JpcHRvci53cml0YWJsZSA9IHRydWU7IE9iamVjdC5kZWZpbmVQcm9wZXJ0eSh0YXJnZXQsIGRlc2NyaXB0b3Iua2V5LCBkZXNjcmlwdG9yKTsgfSB9IHJldHVybiBmdW5jdGlvbiAoQ29uc3RydWN0b3IsIHByb3RvUHJvcHMsIHN0YXRpY1Byb3BzKSB7IGlmIChwcm90b1Byb3BzKSBkZWZpbmVQcm9wZXJ0aWVzKENvbnN0cnVjdG9yLnByb3RvdHlwZSwgcHJvdG9Qcm9wcyk7IGlmIChzdGF0aWNQcm9wcykgZGVmaW5lUHJvcGVydGllcyhDb25zdHJ1Y3Rvciwgc3RhdGljUHJvcHMpOyByZXR1cm4gQ29uc3RydWN0b3I7IH07IH0pKCk7CgpmdW5jdGlvbiBfY2xhc3NDYWxsQ2hlY2soaW5zdGFuY2UsIENvbnN0cnVjdG9yKSB7IGlmICghKGluc3RhbmNlIGluc3RhbmNlb2YgQ29uc3RydWN0b3IpKSB7IHRocm93IG5ldyBUeXBlRXJyb3IoIkNhbm5vdCBjYWxsIGEgY2xhc3MgYXMgYSBmdW5jdGlvbiIpOyB9IH0KCnZhciBFdmVudEVtaXR0ZXIgPSAoZnVuY3Rpb24gKCkgewogIGZ1bmN0aW9uIEV2ZW50RW1pdHRlcigpIHsKICAgIF9jbGFzc0NhbGxDaGVjayh0aGlzLCBFdmVudEVtaXR0ZXIpOwogIH0KCiAgX2NyZWF0ZUNsYXNzKEV2ZW50RW1pdHRlciwgW3sKICAgIGtleTogImFkZEV2ZW50TGlzdGVuZXIiLAoKICAgIC8qKgogICAgICogYWRkRXZlbnRMaXN0ZW5lciBsaXN0ZW4gZm9yIGFuIGV2ZW50VHlwZQogICAgICogQHBhcmFtICB7c3RyaW5nfSAgICAgICAgIGV2ZW50VHlwZSAtIGxpc3RlbmluZyBmb3IgdGhpcyB0eXBlIG9mIGV2ZW50CiAgICAgKiBAcGFyYW0gIHtGdW5jdGlvbn0gICAgICAgY2IgICAgICAgIC0gY2FsbGJhY2sgZnVuY3Rpb24gd2lsbCBiZSBleGVjdXRlZCB3aGVuIHRoZSBldmVudCBpdCBpcyBpbnZva2VkCiAgICAgKi8KICAgIHZhbHVlOiBmdW5jdGlvbiBhZGRFdmVudExpc3RlbmVyKGV2ZW50VHlwZSwgY2IpIHsKICAgICAgdmFyIF90aGlzID0gdGhpczsKICAgICAgX3RoaXNbZXZlbnRUeXBlXSA9IGNiOwogICAgfQoKICAgIC8qKgogICAgICogSW52b2tlIHRoZSBldmVudFR5cGUKICAgICAqIEBwYXJhbSAge3N0cmluZ30gZXZlbnRUeXBlIC0gZXZlbnQgd2lsbCBiZSBpbnZva2VkCiAgICAgKiBAcGFyYW0gIHtvYmplY3R9IHBhcmFtcyAtIHBhcmFtZXRlcnMgd2lsbCBiZSBwYXNzZWQgdG8gdGhlIGFkZEV2ZW50TGlzdGVuZXIKICAgICAqLwogIH0sIHsKICAgIGtleTogInRyaWdnZXIiLAogICAgdmFsdWU6IGZ1bmN0aW9uIHRyaWdnZXIoZXZlbnRUeXBlLCBwYXJhbXMpIHsKICAgICAgdmFyIF90aGlzID0gdGhpczsKCiAgICAgIGlmIChfdGhpc1tldmVudFR5cGVdKSB7CiAgICAgICAgX3RoaXNbZXZlbnRUeXBlXShwYXJhbXMpOwogICAgICB9CiAgICB9CiAgfV0pOwoKICByZXR1cm4gRXZlbnRFbWl0dGVyOwp9KSgpOwoKZXhwb3J0c1siZGVmYXVsdCJdID0gRXZlbnRFbWl0dGVyOwptb2R1bGUuZXhwb3J0cyA9IGV4cG9ydHNbImRlZmF1bHQiXTsKCn0se31dLDE1OltmdW5jdGlvbihyZXF1aXJlLG1vZHVsZSxleHBvcnRzKXsKLyoqCiAqIFN1cHBvcnQgbW9kdWxlIHdpdGggc29tZSBmdW5jdGlvbnMgd2lsbCBiZSB1c2VmdWwKICogQG1vZHVsZSB1dGlscwogKi8KCi8qKgogKiBAdHlwZWRlZiBkaXZpZGVVUkwKICogQHR5cGUgT2JqZWN0CiAqIEBwcm9wZXJ0eSB7c3RyaW5nfSB0eXBlIFRoZSB0eXBlIG9mIFVSTAogKiBAcHJvcGVydHkge3N0cmluZ30gZG9tYWluIFRoZSBkb21haW4gb2YgVVJMCiAqIEBwcm9wZXJ0eSB7c3RyaW5nfSBpZGVudGl0eSBUaGUgaWRlbnRpdHkgb2YgVVJMCiAqLwoKLyoqCiAqIERpdmlkZSBhbiB1cmwgaW4gdHlwZSwgZG9tYWluIGFuZCBpZGVudGl0eQogKiBAcGFyYW0gIHtVUkwuVVJMfSB1cmwgLSB1cmwgYWRkcmVzcwogKiBAcmV0dXJuIHtkaXZpZGVVUkx9IHRoZSByZXN1bHQgb2YgZGl2aWRlVVJMCiAqLwondXNlIHN0cmljdCc7CgpPYmplY3QuZGVmaW5lUHJvcGVydHkoZXhwb3J0cywgJ19fZXNNb2R1bGUnLCB7CiAgdmFsdWU6IHRydWUKfSk7CmV4cG9ydHMuZGl2aWRlVVJMID0gZGl2aWRlVVJMOwpleHBvcnRzLmRlZXBDbG9uZSA9IGRlZXBDbG9uZTsKCmZ1bmN0aW9uIGRpdmlkZVVSTCh1cmwpIHsKCiAgLy8gbGV0IHJlID0gLyhbYS16QS1aLV0qKT86XC9cLyg/OlwuKT8oWy1hLXpBLVowLTlAOiUuX1wrfiM9XXsyLDI1Nn1cLlthLXpdezIsNn1cYikqKFwvW1wvXGRcd1wuLV0qKSooPzpbXD9dKSooLispKi9naTsKICB2YXIgcmUgPSAvKFthLXpBLVotXSopOlwvXC8oPzpcLik/KFstYS16QS1aMC05QDolLl9cK34jPV17MiwyNTZ9KShbLWEtekEtWjAtOUA6JS5fXCt+Iz1cL10qKS9naTsKICB2YXIgc3Vic3QgPSAnJDEsJDIsJDMnOwogIHZhciBwYXJ0cyA9IHVybC5yZXBsYWNlKHJlLCBzdWJzdCkuc3BsaXQoJywnKTsKICB2YXIgcmVzdWx0ID0gewogICAgdHlwZTogcGFydHNbMF0sCiAgICBkb21haW46IHBhcnRzWzFdLAogICAgaWRlbnRpdHk6IHBhcnRzWzJdCiAgfTsKCiAgcmV0dXJuIHJlc3VsdDsKfQoKLyoqCiAqIE1ha2UgYSBDT1BZIG9mIHRoZSBvcmlnaW5hbCBkYXRhCiAqIEBwYXJhbSAge09iamVjdH0gIG9iaiAtIG9iamVjdCB0byBiZSBjbG9uZWQKICogQHJldHVybiB7T2JqZWN0fQogKi8KCmZ1bmN0aW9uIGRlZXBDbG9uZShvYmopIHsKICAvL1RPRE86IHNpbXBsZSBidXQgaW5lZmZpY2llbnQgSlNPTiBkZWVwIGNsb25lLi4uCiAgaWYgKG9iaikgcmV0dXJuIEpTT04ucGFyc2UoSlNPTi5zdHJpbmdpZnkob2JqKSk7Cn0KCn0se31dfSx7fSxbM10pKDMpCn0pOw==",
      "sourceCodeClassname": "HypertyConnector",
      "encoding": "base64",
      "signature": ""
    },
    "cguid": 1,
    "type": "Hyperties",
    "version": "0.1",
    "description": "Description of HypertyConnector",
    "objectName": "HypertyConnector",
    "sourcePackageURL": "/sourcePackage",
    "language": "javascript",
    "signature": "",
    "messageSchemas": "",
    "dataObjects": [],
    "accessControlPolicy": "somePolicy",
    "configuration": {
      "mediaConstraints": {
        "optional": [],
        "mandatory": {
          "offerToReceiveAudio": true,
          "offerToReceiveVideo": true
        }
      },
      "webrtc": {
        "iceServers": [
          {
            "url": "stun:stun.l.google.com:19302"
          },
          {
            "url": "turn:194.65.138.95:3478",
            "credential": "luis123",
            "username": "luis"
          }
        ]
      }
    }
  }
}