{
  "HelloHyperty": {
    "cguid": "1",
    "type": "0",
    "version": "0.1",
    "description": "description of Hello Hyperty",
    "objectName": "HelloHyperty",
    "sourcePackageURL": "/sourcePackage",
    "sourcePackage": {
      "sourceCode": "KGZ1bmN0aW9uKGYpe2lmKHR5cGVvZiBleHBvcnRzPT09Im9iamVjdCImJnR5cGVvZiBtb2R1bGUhPT0idW5kZWZpbmVkIil7bW9kdWxlLmV4cG9ydHM9ZigpfWVsc2UgaWYodHlwZW9mIGRlZmluZT09PSJmdW5jdGlvbiImJmRlZmluZS5hbWQpe2RlZmluZShbXSxmKX1lbHNle3ZhciBnO2lmKHR5cGVvZiB3aW5kb3chPT0idW5kZWZpbmVkIil7Zz13aW5kb3d9ZWxzZSBpZih0eXBlb2YgZ2xvYmFsIT09InVuZGVmaW5lZCIpe2c9Z2xvYmFsfWVsc2UgaWYodHlwZW9mIHNlbGYhPT0idW5kZWZpbmVkIil7Zz1zZWxmfWVsc2V7Zz10aGlzfWcuYWN0aXZhdGUgPSBmKCl9fSkoZnVuY3Rpb24oKXt2YXIgZGVmaW5lLG1vZHVsZSxleHBvcnRzO3JldHVybiAoZnVuY3Rpb24gZSh0LG4scil7ZnVuY3Rpb24gcyhvLHUpe2lmKCFuW29dKXtpZighdFtvXSl7dmFyIGE9dHlwZW9mIHJlcXVpcmU9PSJmdW5jdGlvbiImJnJlcXVpcmU7aWYoIXUmJmEpcmV0dXJuIGEobywhMCk7aWYoaSlyZXR1cm4gaShvLCEwKTt2YXIgZj1uZXcgRXJyb3IoIkNhbm5vdCBmaW5kIG1vZHVsZSAnIitvKyInIik7dGhyb3cgZi5jb2RlPSJNT0RVTEVfTk9UX0ZPVU5EIixmfXZhciBsPW5bb109e2V4cG9ydHM6e319O3Rbb11bMF0uY2FsbChsLmV4cG9ydHMsZnVuY3Rpb24oZSl7dmFyIG49dFtvXVsxXVtlXTtyZXR1cm4gcyhuP246ZSl9LGwsbC5leHBvcnRzLGUsdCxuLHIpfXJldHVybiBuW29dLmV4cG9ydHN9dmFyIGk9dHlwZW9mIHJlcXVpcmU9PSJmdW5jdGlvbiImJnJlcXVpcmU7Zm9yKHZhciBvPTA7bzxyLmxlbmd0aDtvKyspcyhyW29dKTtyZXR1cm4gc30pKHsxOltmdW5jdGlvbihyZXF1aXJlLG1vZHVsZSxleHBvcnRzKXsKLyoKQXV0aG9yOiBHZXJhaW50IEx1ZmYgYW5kIG90aGVycwpZZWFyOiAyMDEzCgpUaGlzIGNvZGUgaXMgcmVsZWFzZWQgaW50byB0aGUgInB1YmxpYyBkb21haW4iIGJ5IGl0cyBhdXRob3IocykuICBBbnlib2R5IG1heSB1c2UsIGFsdGVyIGFuZCBkaXN0cmlidXRlIHRoZSBjb2RlIHdpdGhvdXQgcmVzdHJpY3Rpb24uICBUaGUgYXV0aG9yIG1ha2VzIG5vIGd1YXJhbnRlZXMsIGFuZCB0YWtlcyBubyBsaWFiaWxpdHkgb2YgYW55IGtpbmQgZm9yIHVzZSBvZiB0aGlzIGNvZGUuCgpJZiB5b3UgZmluZCBhIGJ1ZyBvciBtYWtlIGFuIGltcHJvdmVtZW50LCBpdCB3b3VsZCBiZSBjb3VydGVvdXMgdG8gbGV0IHRoZSBhdXRob3Iga25vdywgYnV0IGl0IGlzIG5vdCBjb21wdWxzb3J5LgoqLwooZnVuY3Rpb24gKGdsb2JhbCwgZmFjdG9yeSkgewogIGlmICh0eXBlb2YgZGVmaW5lID09PSAnZnVuY3Rpb24nICYmIGRlZmluZS5hbWQpIHsKICAgIC8vIEFNRC4gUmVnaXN0ZXIgYXMgYW4gYW5vbnltb3VzIG1vZHVsZS4KICAgIGRlZmluZShbXSwgZmFjdG9yeSk7CiAgfSBlbHNlIGlmICh0eXBlb2YgbW9kdWxlICE9PSAndW5kZWZpbmVkJyAmJiBtb2R1bGUuZXhwb3J0cyl7CiAgICAvLyBDb21tb25KUy4gRGVmaW5lIGV4cG9ydC4KICAgIG1vZHVsZS5leHBvcnRzID0gZmFjdG9yeSgpOwogIH0gZWxzZSB7CiAgICAvLyBCcm93c2VyIGdsb2JhbHMKICAgIGdsb2JhbC50djQgPSBmYWN0b3J5KCk7CiAgfQp9KHRoaXMsIGZ1bmN0aW9uICgpIHsKCi8vIGh0dHBzOi8vZGV2ZWxvcGVyLm1vemlsbGEub3JnL2VuLVVTL2RvY3MvV2ViL0phdmFTY3JpcHQvUmVmZXJlbmNlL0dsb2JhbF9PYmplY3RzL09iamVjdC9rZXlzP3JlZGlyZWN0bG9jYWxlPWVuLVVTJnJlZGlyZWN0c2x1Zz1KYXZhU2NyaXB0JTJGUmVmZXJlbmNlJTJGR2xvYmFsX09iamVjdHMlMkZPYmplY3QlMkZrZXlzCmlmICghT2JqZWN0LmtleXMpIHsKCU9iamVjdC5rZXlzID0gKGZ1bmN0aW9uICgpIHsKCQl2YXIgaGFzT3duUHJvcGVydHkgPSBPYmplY3QucHJvdG90eXBlLmhhc093blByb3BlcnR5LAoJCQloYXNEb250RW51bUJ1ZyA9ICEoe3RvU3RyaW5nOiBudWxsfSkucHJvcGVydHlJc0VudW1lcmFibGUoJ3RvU3RyaW5nJyksCgkJCWRvbnRFbnVtcyA9IFsKCQkJCSd0b1N0cmluZycsCgkJCQkndG9Mb2NhbGVTdHJpbmcnLAoJCQkJJ3ZhbHVlT2YnLAoJCQkJJ2hhc093blByb3BlcnR5JywKCQkJCSdpc1Byb3RvdHlwZU9mJywKCQkJCSdwcm9wZXJ0eUlzRW51bWVyYWJsZScsCgkJCQknY29uc3RydWN0b3InCgkJCV0sCgkJCWRvbnRFbnVtc0xlbmd0aCA9IGRvbnRFbnVtcy5sZW5ndGg7CgoJCXJldHVybiBmdW5jdGlvbiAob2JqKSB7CgkJCWlmICh0eXBlb2Ygb2JqICE9PSAnb2JqZWN0JyAmJiB0eXBlb2Ygb2JqICE9PSAnZnVuY3Rpb24nIHx8IG9iaiA9PT0gbnVsbCkgewoJCQkJdGhyb3cgbmV3IFR5cGVFcnJvcignT2JqZWN0LmtleXMgY2FsbGVkIG9uIG5vbi1vYmplY3QnKTsKCQkJfQoKCQkJdmFyIHJlc3VsdCA9IFtdOwoKCQkJZm9yICh2YXIgcHJvcCBpbiBvYmopIHsKCQkJCWlmIChoYXNPd25Qcm9wZXJ0eS5jYWxsKG9iaiwgcHJvcCkpIHsKCQkJCQlyZXN1bHQucHVzaChwcm9wKTsKCQkJCX0KCQkJfQoKCQkJaWYgKGhhc0RvbnRFbnVtQnVnKSB7CgkJCQlmb3IgKHZhciBpPTA7IGkgPCBkb250RW51bXNMZW5ndGg7IGkrKykgewoJCQkJCWlmIChoYXNPd25Qcm9wZXJ0eS5jYWxsKG9iaiwgZG9udEVudW1zW2ldKSkgewoJCQkJCQlyZXN1bHQucHVzaChkb250RW51bXNbaV0pOwoJCQkJCX0KCQkJCX0KCQkJfQoJCQlyZXR1cm4gcmVzdWx0OwoJCX07Cgl9KSgpOwp9Ci8vIGh0dHBzOi8vZGV2ZWxvcGVyLm1vemlsbGEub3JnL2VuLVVTL2RvY3MvV2ViL0phdmFTY3JpcHQvUmVmZXJlbmNlL0dsb2JhbF9PYmplY3RzL09iamVjdC9jcmVhdGUKaWYgKCFPYmplY3QuY3JlYXRlKSB7CglPYmplY3QuY3JlYXRlID0gKGZ1bmN0aW9uKCl7CgkJZnVuY3Rpb24gRigpe30KCgkJcmV0dXJuIGZ1bmN0aW9uKG8pewoJCQlpZiAoYXJndW1lbnRzLmxlbmd0aCAhPT0gMSkgewoJCQkJdGhyb3cgbmV3IEVycm9yKCdPYmplY3QuY3JlYXRlIGltcGxlbWVudGF0aW9uIG9ubHkgYWNjZXB0cyBvbmUgcGFyYW1ldGVyLicpOwoJCQl9CgkJCUYucHJvdG90eXBlID0gbzsKCQkJcmV0dXJuIG5ldyBGKCk7CgkJfTsKCX0pKCk7Cn0KLy8gaHR0cHM6Ly9kZXZlbG9wZXIubW96aWxsYS5vcmcvZW4tVVMvZG9jcy9XZWIvSmF2YVNjcmlwdC9SZWZlcmVuY2UvR2xvYmFsX09iamVjdHMvQXJyYXkvaXNBcnJheT9yZWRpcmVjdGxvY2FsZT1lbi1VUyZyZWRpcmVjdHNsdWc9SmF2YVNjcmlwdCUyRlJlZmVyZW5jZSUyRkdsb2JhbF9PYmplY3RzJTJGQXJyYXklMkZpc0FycmF5CmlmKCFBcnJheS5pc0FycmF5KSB7CglBcnJheS5pc0FycmF5ID0gZnVuY3Rpb24gKHZBcmcpIHsKCQlyZXR1cm4gT2JqZWN0LnByb3RvdHlwZS50b1N0cmluZy5jYWxsKHZBcmcpID09PSAiW29iamVjdCBBcnJheV0iOwoJfTsKfQovLyBodHRwczovL2RldmVsb3Blci5tb3ppbGxhLm9yZy9lbi1VUy9kb2NzL1dlYi9KYXZhU2NyaXB0L1JlZmVyZW5jZS9HbG9iYWxfT2JqZWN0cy9BcnJheS9pbmRleE9mP3JlZGlyZWN0bG9jYWxlPWVuLVVTJnJlZGlyZWN0c2x1Zz1KYXZhU2NyaXB0JTJGUmVmZXJlbmNlJTJGR2xvYmFsX09iamVjdHMlMkZBcnJheSUyRmluZGV4T2YKaWYgKCFBcnJheS5wcm90b3R5cGUuaW5kZXhPZikgewoJQXJyYXkucHJvdG90eXBlLmluZGV4T2YgPSBmdW5jdGlvbiAoc2VhcmNoRWxlbWVudCAvKiwgZnJvbUluZGV4ICovICkgewoJCWlmICh0aGlzID09PSBudWxsKSB7CgkJCXRocm93IG5ldyBUeXBlRXJyb3IoKTsKCQl9CgkJdmFyIHQgPSBPYmplY3QodGhpcyk7CgkJdmFyIGxlbiA9IHQubGVuZ3RoID4+PiAwOwoKCQlpZiAobGVuID09PSAwKSB7CgkJCXJldHVybiAtMTsKCQl9CgkJdmFyIG4gPSAwOwoJCWlmIChhcmd1bWVudHMubGVuZ3RoID4gMSkgewoJCQluID0gTnVtYmVyKGFyZ3VtZW50c1sxXSk7CgkJCWlmIChuICE9PSBuKSB7IC8vIHNob3J0Y3V0IGZvciB2ZXJpZnlpbmcgaWYgaXQncyBOYU4KCQkJCW4gPSAwOwoJCQl9IGVsc2UgaWYgKG4gIT09IDAgJiYgbiAhPT0gSW5maW5pdHkgJiYgbiAhPT0gLUluZmluaXR5KSB7CgkJCQluID0gKG4gPiAwIHx8IC0xKSAqIE1hdGguZmxvb3IoTWF0aC5hYnMobikpOwoJCQl9CgkJfQoJCWlmIChuID49IGxlbikgewoJCQlyZXR1cm4gLTE7CgkJfQoJCXZhciBrID0gbiA+PSAwID8gbiA6IE1hdGgubWF4KGxlbiAtIE1hdGguYWJzKG4pLCAwKTsKCQlmb3IgKDsgayA8IGxlbjsgaysrKSB7CgkJCWlmIChrIGluIHQgJiYgdFtrXSA9PT0gc2VhcmNoRWxlbWVudCkgewoJCQkJcmV0dXJuIGs7CgkJCX0KCQl9CgkJcmV0dXJuIC0xOwoJfTsKfQoKLy8gR3J1bmdleSBPYmplY3QuaXNGcm96ZW4gaGFjawppZiAoIU9iamVjdC5pc0Zyb3plbikgewoJT2JqZWN0LmlzRnJvemVuID0gZnVuY3Rpb24gKG9iaikgewoJCXZhciBrZXkgPSAidHY0X3Rlc3RfZnJvemVuX2tleSI7CgkJd2hpbGUgKG9iai5oYXNPd25Qcm9wZXJ0eShrZXkpKSB7CgkJCWtleSArPSBNYXRoLnJhbmRvbSgpOwoJCX0KCQl0cnkgewoJCQlvYmpba2V5XSA9IHRydWU7CgkJCWRlbGV0ZSBvYmpba2V5XTsKCQkJcmV0dXJuIGZhbHNlOwoJCX0gY2F0Y2ggKGUpIHsKCQkJcmV0dXJuIHRydWU7CgkJfQoJfTsKfQovLyBCYXNlZCBvbjogaHR0cHM6Ly9naXRodWIuY29tL2dlcmFpbnRsdWZmL3VyaS10ZW1wbGF0ZXMsIGJ1dCB3aXRoIGFsbCB0aGUgZGUtc3Vic3RpdHV0aW9uIHN0dWZmIHJlbW92ZWQKCnZhciB1cmlUZW1wbGF0ZUdsb2JhbE1vZGlmaWVycyA9IHsKCSIrIjogdHJ1ZSwKCSIjIjogdHJ1ZSwKCSIuIjogdHJ1ZSwKCSIvIjogdHJ1ZSwKCSI7IjogdHJ1ZSwKCSI/IjogdHJ1ZSwKCSImIjogdHJ1ZQp9Owp2YXIgdXJpVGVtcGxhdGVTdWZmaWNlcyA9IHsKCSIqIjogdHJ1ZQp9OwoKZnVuY3Rpb24gbm90UmVhbGx5UGVyY2VudEVuY29kZShzdHJpbmcpIHsKCXJldHVybiBlbmNvZGVVUkkoc3RyaW5nKS5yZXBsYWNlKC8lMjVbMC05XVswLTldL2csIGZ1bmN0aW9uIChkb3VibGVFbmNvZGVkKSB7CgkJcmV0dXJuICIlIiArIGRvdWJsZUVuY29kZWQuc3Vic3RyaW5nKDMpOwoJfSk7Cn0KCmZ1bmN0aW9uIHVyaVRlbXBsYXRlU3Vic3RpdHV0aW9uKHNwZWMpIHsKCXZhciBtb2RpZmllciA9ICIiOwoJaWYgKHVyaVRlbXBsYXRlR2xvYmFsTW9kaWZpZXJzW3NwZWMuY2hhckF0KDApXSkgewoJCW1vZGlmaWVyID0gc3BlYy5jaGFyQXQoMCk7CgkJc3BlYyA9IHNwZWMuc3Vic3RyaW5nKDEpOwoJfQoJdmFyIHNlcGFyYXRvciA9ICIiOwoJdmFyIHByZWZpeCA9ICIiOwoJdmFyIHNob3VsZEVzY2FwZSA9IHRydWU7Cgl2YXIgc2hvd1ZhcmlhYmxlcyA9IGZhbHNlOwoJdmFyIHRyaW1FbXB0eVN0cmluZyA9IGZhbHNlOwoJaWYgKG1vZGlmaWVyID09PSAnKycpIHsKCQlzaG91bGRFc2NhcGUgPSBmYWxzZTsKCX0gZWxzZSBpZiAobW9kaWZpZXIgPT09ICIuIikgewoJCXByZWZpeCA9ICIuIjsKCQlzZXBhcmF0b3IgPSAiLiI7Cgl9IGVsc2UgaWYgKG1vZGlmaWVyID09PSAiLyIpIHsKCQlwcmVmaXggPSAiLyI7CgkJc2VwYXJhdG9yID0gIi8iOwoJfSBlbHNlIGlmIChtb2RpZmllciA9PT0gJyMnKSB7CgkJcHJlZml4ID0gIiMiOwoJCXNob3VsZEVzY2FwZSA9IGZhbHNlOwoJfSBlbHNlIGlmIChtb2RpZmllciA9PT0gJzsnKSB7CgkJcHJlZml4ID0gIjsiOwoJCXNlcGFyYXRvciA9ICI7IjsKCQlzaG93VmFyaWFibGVzID0gdHJ1ZTsKCQl0cmltRW1wdHlTdHJpbmcgPSB0cnVlOwoJfSBlbHNlIGlmIChtb2RpZmllciA9PT0gJz8nKSB7CgkJcHJlZml4ID0gIj8iOwoJCXNlcGFyYXRvciA9ICImIjsKCQlzaG93VmFyaWFibGVzID0gdHJ1ZTsKCX0gZWxzZSBpZiAobW9kaWZpZXIgPT09ICcmJykgewoJCXByZWZpeCA9ICImIjsKCQlzZXBhcmF0b3IgPSAiJiI7CgkJc2hvd1ZhcmlhYmxlcyA9IHRydWU7Cgl9CgoJdmFyIHZhck5hbWVzID0gW107Cgl2YXIgdmFyTGlzdCA9IHNwZWMuc3BsaXQoIiwiKTsKCXZhciB2YXJTcGVjcyA9IFtdOwoJdmFyIHZhclNwZWNNYXAgPSB7fTsKCWZvciAodmFyIGkgPSAwOyBpIDwgdmFyTGlzdC5sZW5ndGg7IGkrKykgewoJCXZhciB2YXJOYW1lID0gdmFyTGlzdFtpXTsKCQl2YXIgdHJ1bmNhdGUgPSBudWxsOwoJCWlmICh2YXJOYW1lLmluZGV4T2YoIjoiKSAhPT0gLTEpIHsKCQkJdmFyIHBhcnRzID0gdmFyTmFtZS5zcGxpdCgiOiIpOwoJCQl2YXJOYW1lID0gcGFydHNbMF07CgkJCXRydW5jYXRlID0gcGFyc2VJbnQocGFydHNbMV0sIDEwKTsKCQl9CgkJdmFyIHN1ZmZpY2VzID0ge307CgkJd2hpbGUgKHVyaVRlbXBsYXRlU3VmZmljZXNbdmFyTmFtZS5jaGFyQXQodmFyTmFtZS5sZW5ndGggLSAxKV0pIHsKCQkJc3VmZmljZXNbdmFyTmFtZS5jaGFyQXQodmFyTmFtZS5sZW5ndGggLSAxKV0gPSB0cnVlOwoJCQl2YXJOYW1lID0gdmFyTmFtZS5zdWJzdHJpbmcoMCwgdmFyTmFtZS5sZW5ndGggLSAxKTsKCQl9CgkJdmFyIHZhclNwZWMgPSB7CgkJCXRydW5jYXRlOiB0cnVuY2F0ZSwKCQkJbmFtZTogdmFyTmFtZSwKCQkJc3VmZmljZXM6IHN1ZmZpY2VzCgkJfTsKCQl2YXJTcGVjcy5wdXNoKHZhclNwZWMpOwoJCXZhclNwZWNNYXBbdmFyTmFtZV0gPSB2YXJTcGVjOwoJCXZhck5hbWVzLnB1c2godmFyTmFtZSk7Cgl9Cgl2YXIgc3ViRnVuY3Rpb24gPSBmdW5jdGlvbiAodmFsdWVGdW5jdGlvbikgewoJCXZhciByZXN1bHQgPSAiIjsKCQl2YXIgc3RhcnRJbmRleCA9IDA7CgkJZm9yICh2YXIgaSA9IDA7IGkgPCB2YXJTcGVjcy5sZW5ndGg7IGkrKykgewoJCQl2YXIgdmFyU3BlYyA9IHZhclNwZWNzW2ldOwoJCQl2YXIgdmFsdWUgPSB2YWx1ZUZ1bmN0aW9uKHZhclNwZWMubmFtZSk7CgkJCWlmICh2YWx1ZSA9PT0gbnVsbCB8fCB2YWx1ZSA9PT0gdW5kZWZpbmVkIHx8IChBcnJheS5pc0FycmF5KHZhbHVlKSAmJiB2YWx1ZS5sZW5ndGggPT09IDApIHx8ICh0eXBlb2YgdmFsdWUgPT09ICdvYmplY3QnICYmIE9iamVjdC5rZXlzKHZhbHVlKS5sZW5ndGggPT09IDApKSB7CgkJCQlzdGFydEluZGV4Kys7CgkJCQljb250aW51ZTsKCQkJfQoJCQlpZiAoaSA9PT0gc3RhcnRJbmRleCkgewoJCQkJcmVzdWx0ICs9IHByZWZpeDsKCQkJfSBlbHNlIHsKCQkJCXJlc3VsdCArPSAoc2VwYXJhdG9yIHx8ICIsIik7CgkJCX0KCQkJaWYgKEFycmF5LmlzQXJyYXkodmFsdWUpKSB7CgkJCQlpZiAoc2hvd1ZhcmlhYmxlcykgewoJCQkJCXJlc3VsdCArPSB2YXJTcGVjLm5hbWUgKyAiPSI7CgkJCQl9CgkJCQlmb3IgKHZhciBqID0gMDsgaiA8IHZhbHVlLmxlbmd0aDsgaisrKSB7CgkJCQkJaWYgKGogPiAwKSB7CgkJCQkJCXJlc3VsdCArPSB2YXJTcGVjLnN1ZmZpY2VzWycqJ10gPyAoc2VwYXJhdG9yIHx8ICIsIikgOiAiLCI7CgkJCQkJCWlmICh2YXJTcGVjLnN1ZmZpY2VzWycqJ10gJiYgc2hvd1ZhcmlhYmxlcykgewoJCQkJCQkJcmVzdWx0ICs9IHZhclNwZWMubmFtZSArICI9IjsKCQkJCQkJfQoJCQkJCX0KCQkJCQlyZXN1bHQgKz0gc2hvdWxkRXNjYXBlID8gZW5jb2RlVVJJQ29tcG9uZW50KHZhbHVlW2pdKS5yZXBsYWNlKC8hL2csICIlMjEiKSA6IG5vdFJlYWxseVBlcmNlbnRFbmNvZGUodmFsdWVbal0pOwoJCQkJfQoJCQl9IGVsc2UgaWYgKHR5cGVvZiB2YWx1ZSA9PT0gIm9iamVjdCIpIHsKCQkJCWlmIChzaG93VmFyaWFibGVzICYmICF2YXJTcGVjLnN1ZmZpY2VzWycqJ10pIHsKCQkJCQlyZXN1bHQgKz0gdmFyU3BlYy5uYW1lICsgIj0iOwoJCQkJfQoJCQkJdmFyIGZpcnN0ID0gdHJ1ZTsKCQkJCWZvciAodmFyIGtleSBpbiB2YWx1ZSkgewoJCQkJCWlmICghZmlyc3QpIHsKCQkJCQkJcmVzdWx0ICs9IHZhclNwZWMuc3VmZmljZXNbJyonXSA/IChzZXBhcmF0b3IgfHwgIiwiKSA6ICIsIjsKCQkJCQl9CgkJCQkJZmlyc3QgPSBmYWxzZTsKCQkJCQlyZXN1bHQgKz0gc2hvdWxkRXNjYXBlID8gZW5jb2RlVVJJQ29tcG9uZW50KGtleSkucmVwbGFjZSgvIS9nLCAiJTIxIikgOiBub3RSZWFsbHlQZXJjZW50RW5jb2RlKGtleSk7CgkJCQkJcmVzdWx0ICs9IHZhclNwZWMuc3VmZmljZXNbJyonXSA/ICc9JyA6ICIsIjsKCQkJCQlyZXN1bHQgKz0gc2hvdWxkRXNjYXBlID8gZW5jb2RlVVJJQ29tcG9uZW50KHZhbHVlW2tleV0pLnJlcGxhY2UoLyEvZywgIiUyMSIpIDogbm90UmVhbGx5UGVyY2VudEVuY29kZSh2YWx1ZVtrZXldKTsKCQkJCX0KCQkJfSBlbHNlIHsKCQkJCWlmIChzaG93VmFyaWFibGVzKSB7CgkJCQkJcmVzdWx0ICs9IHZhclNwZWMubmFtZTsKCQkJCQlpZiAoIXRyaW1FbXB0eVN0cmluZyB8fCB2YWx1ZSAhPT0gIiIpIHsKCQkJCQkJcmVzdWx0ICs9ICI9IjsKCQkJCQl9CgkJCQl9CgkJCQlpZiAodmFyU3BlYy50cnVuY2F0ZSAhPSBudWxsKSB7CgkJCQkJdmFsdWUgPSB2YWx1ZS5zdWJzdHJpbmcoMCwgdmFyU3BlYy50cnVuY2F0ZSk7CgkJCQl9CgkJCQlyZXN1bHQgKz0gc2hvdWxkRXNjYXBlID8gZW5jb2RlVVJJQ29tcG9uZW50KHZhbHVlKS5yZXBsYWNlKC8hL2csICIlMjEiKTogbm90UmVhbGx5UGVyY2VudEVuY29kZSh2YWx1ZSk7CgkJCX0KCQl9CgkJcmV0dXJuIHJlc3VsdDsKCX07CglzdWJGdW5jdGlvbi52YXJOYW1lcyA9IHZhck5hbWVzOwoJcmV0dXJuIHsKCQlwcmVmaXg6IHByZWZpeCwKCQlzdWJzdGl0dXRpb246IHN1YkZ1bmN0aW9uCgl9Owp9CgpmdW5jdGlvbiBVcmlUZW1wbGF0ZSh0ZW1wbGF0ZSkgewoJaWYgKCEodGhpcyBpbnN0YW5jZW9mIFVyaVRlbXBsYXRlKSkgewoJCXJldHVybiBuZXcgVXJpVGVtcGxhdGUodGVtcGxhdGUpOwoJfQoJdmFyIHBhcnRzID0gdGVtcGxhdGUuc3BsaXQoInsiKTsKCXZhciB0ZXh0UGFydHMgPSBbcGFydHMuc2hpZnQoKV07Cgl2YXIgcHJlZml4ZXMgPSBbXTsKCXZhciBzdWJzdGl0dXRpb25zID0gW107Cgl2YXIgdmFyTmFtZXMgPSBbXTsKCXdoaWxlIChwYXJ0cy5sZW5ndGggPiAwKSB7CgkJdmFyIHBhcnQgPSBwYXJ0cy5zaGlmdCgpOwoJCXZhciBzcGVjID0gcGFydC5zcGxpdCgifSIpWzBdOwoJCXZhciByZW1haW5kZXIgPSBwYXJ0LnN1YnN0cmluZyhzcGVjLmxlbmd0aCArIDEpOwoJCXZhciBmdW5jcyA9IHVyaVRlbXBsYXRlU3Vic3RpdHV0aW9uKHNwZWMpOwoJCXN1YnN0aXR1dGlvbnMucHVzaChmdW5jcy5zdWJzdGl0dXRpb24pOwoJCXByZWZpeGVzLnB1c2goZnVuY3MucHJlZml4KTsKCQl0ZXh0UGFydHMucHVzaChyZW1haW5kZXIpOwoJCXZhck5hbWVzID0gdmFyTmFtZXMuY29uY2F0KGZ1bmNzLnN1YnN0aXR1dGlvbi52YXJOYW1lcyk7Cgl9Cgl0aGlzLmZpbGwgPSBmdW5jdGlvbiAodmFsdWVGdW5jdGlvbikgewoJCXZhciByZXN1bHQgPSB0ZXh0UGFydHNbMF07CgkJZm9yICh2YXIgaSA9IDA7IGkgPCBzdWJzdGl0dXRpb25zLmxlbmd0aDsgaSsrKSB7CgkJCXZhciBzdWJzdGl0dXRpb24gPSBzdWJzdGl0dXRpb25zW2ldOwoJCQlyZXN1bHQgKz0gc3Vic3RpdHV0aW9uKHZhbHVlRnVuY3Rpb24pOwoJCQlyZXN1bHQgKz0gdGV4dFBhcnRzW2kgKyAxXTsKCQl9CgkJcmV0dXJuIHJlc3VsdDsKCX07Cgl0aGlzLnZhck5hbWVzID0gdmFyTmFtZXM7Cgl0aGlzLnRlbXBsYXRlID0gdGVtcGxhdGU7Cn0KVXJpVGVtcGxhdGUucHJvdG90eXBlID0gewoJdG9TdHJpbmc6IGZ1bmN0aW9uICgpIHsKCQlyZXR1cm4gdGhpcy50ZW1wbGF0ZTsKCX0sCglmaWxsRnJvbU9iamVjdDogZnVuY3Rpb24gKG9iaikgewoJCXJldHVybiB0aGlzLmZpbGwoZnVuY3Rpb24gKHZhck5hbWUpIHsKCQkJcmV0dXJuIG9ialt2YXJOYW1lXTsKCQl9KTsKCX0KfTsKdmFyIFZhbGlkYXRvckNvbnRleHQgPSBmdW5jdGlvbiBWYWxpZGF0b3JDb250ZXh0KHBhcmVudCwgY29sbGVjdE11bHRpcGxlLCBlcnJvclJlcG9ydGVyLCBjaGVja1JlY3Vyc2l2ZSwgdHJhY2tVbmtub3duUHJvcGVydGllcykgewoJdGhpcy5taXNzaW5nID0gW107Cgl0aGlzLm1pc3NpbmdNYXAgPSB7fTsKCXRoaXMuZm9ybWF0VmFsaWRhdG9ycyA9IHBhcmVudCA/IE9iamVjdC5jcmVhdGUocGFyZW50LmZvcm1hdFZhbGlkYXRvcnMpIDoge307Cgl0aGlzLnNjaGVtYXMgPSBwYXJlbnQgPyBPYmplY3QuY3JlYXRlKHBhcmVudC5zY2hlbWFzKSA6IHt9OwoJdGhpcy5jb2xsZWN0TXVsdGlwbGUgPSBjb2xsZWN0TXVsdGlwbGU7Cgl0aGlzLmVycm9ycyA9IFtdOwoJdGhpcy5oYW5kbGVFcnJvciA9IGNvbGxlY3RNdWx0aXBsZSA/IHRoaXMuY29sbGVjdEVycm9yIDogdGhpcy5yZXR1cm5FcnJvcjsKCWlmIChjaGVja1JlY3Vyc2l2ZSkgewoJCXRoaXMuY2hlY2tSZWN1cnNpdmUgPSB0cnVlOwoJCXRoaXMuc2Nhbm5lZCA9IFtdOwoJCXRoaXMuc2Nhbm5lZEZyb3plbiA9IFtdOwoJCXRoaXMuc2Nhbm5lZEZyb3plblNjaGVtYXMgPSBbXTsKCQl0aGlzLnNjYW5uZWRGcm96ZW5WYWxpZGF0aW9uRXJyb3JzID0gW107CgkJdGhpcy52YWxpZGF0ZWRTY2hlbWFzS2V5ID0gJ3R2NF92YWxpZGF0aW9uX2lkJzsKCQl0aGlzLnZhbGlkYXRpb25FcnJvcnNLZXkgPSAndHY0X3ZhbGlkYXRpb25fZXJyb3JzX2lkJzsKCX0KCWlmICh0cmFja1Vua25vd25Qcm9wZXJ0aWVzKSB7CgkJdGhpcy50cmFja1Vua25vd25Qcm9wZXJ0aWVzID0gdHJ1ZTsKCQl0aGlzLmtub3duUHJvcGVydHlQYXRocyA9IHt9OwoJCXRoaXMudW5rbm93blByb3BlcnR5UGF0aHMgPSB7fTsKCX0KCXRoaXMuZXJyb3JSZXBvcnRlciA9IGVycm9yUmVwb3J0ZXIgfHwgZGVmYXVsdEVycm9yUmVwb3J0ZXIoJ2VuJyk7CglpZiAodHlwZW9mIHRoaXMuZXJyb3JSZXBvcnRlciA9PT0gJ3N0cmluZycpIHsKCQl0aHJvdyBuZXcgRXJyb3IoJ2RlYnVnJyk7Cgl9Cgl0aGlzLmRlZmluZWRLZXl3b3JkcyA9IHt9OwoJaWYgKHBhcmVudCkgewoJCWZvciAodmFyIGtleSBpbiBwYXJlbnQuZGVmaW5lZEtleXdvcmRzKSB7CgkJCXRoaXMuZGVmaW5lZEtleXdvcmRzW2tleV0gPSBwYXJlbnQuZGVmaW5lZEtleXdvcmRzW2tleV0uc2xpY2UoMCk7CgkJfQoJfQp9OwpWYWxpZGF0b3JDb250ZXh0LnByb3RvdHlwZS5kZWZpbmVLZXl3b3JkID0gZnVuY3Rpb24gKGtleXdvcmQsIGtleXdvcmRGdW5jdGlvbikgewoJdGhpcy5kZWZpbmVkS2V5d29yZHNba2V5d29yZF0gPSB0aGlzLmRlZmluZWRLZXl3b3Jkc1trZXl3b3JkXSB8fCBbXTsKCXRoaXMuZGVmaW5lZEtleXdvcmRzW2tleXdvcmRdLnB1c2goa2V5d29yZEZ1bmN0aW9uKTsKfTsKVmFsaWRhdG9yQ29udGV4dC5wcm90b3R5cGUuY3JlYXRlRXJyb3IgPSBmdW5jdGlvbiAoY29kZSwgbWVzc2FnZVBhcmFtcywgZGF0YVBhdGgsIHNjaGVtYVBhdGgsIHN1YkVycm9ycywgZGF0YSwgc2NoZW1hKSB7Cgl2YXIgZXJyb3IgPSBuZXcgVmFsaWRhdGlvbkVycm9yKGNvZGUsIG1lc3NhZ2VQYXJhbXMsIGRhdGFQYXRoLCBzY2hlbWFQYXRoLCBzdWJFcnJvcnMpOwoJZXJyb3IubWVzc2FnZSA9IHRoaXMuZXJyb3JSZXBvcnRlcihlcnJvciwgZGF0YSwgc2NoZW1hKTsKCXJldHVybiBlcnJvcjsKfTsKVmFsaWRhdG9yQ29udGV4dC5wcm90b3R5cGUucmV0dXJuRXJyb3IgPSBmdW5jdGlvbiAoZXJyb3IpIHsKCXJldHVybiBlcnJvcjsKfTsKVmFsaWRhdG9yQ29udGV4dC5wcm90b3R5cGUuY29sbGVjdEVycm9yID0gZnVuY3Rpb24gKGVycm9yKSB7CglpZiAoZXJyb3IpIHsKCQl0aGlzLmVycm9ycy5wdXNoKGVycm9yKTsKCX0KCXJldHVybiBudWxsOwp9OwpWYWxpZGF0b3JDb250ZXh0LnByb3RvdHlwZS5wcmVmaXhFcnJvcnMgPSBmdW5jdGlvbiAoc3RhcnRJbmRleCwgZGF0YVBhdGgsIHNjaGVtYVBhdGgpIHsKCWZvciAodmFyIGkgPSBzdGFydEluZGV4OyBpIDwgdGhpcy5lcnJvcnMubGVuZ3RoOyBpKyspIHsKCQl0aGlzLmVycm9yc1tpXSA9IHRoaXMuZXJyb3JzW2ldLnByZWZpeFdpdGgoZGF0YVBhdGgsIHNjaGVtYVBhdGgpOwoJfQoJcmV0dXJuIHRoaXM7Cn07ClZhbGlkYXRvckNvbnRleHQucHJvdG90eXBlLmJhblVua25vd25Qcm9wZXJ0aWVzID0gZnVuY3Rpb24gKGRhdGEsIHNjaGVtYSkgewoJZm9yICh2YXIgdW5rbm93blBhdGggaW4gdGhpcy51bmtub3duUHJvcGVydHlQYXRocykgewoJCXZhciBlcnJvciA9IHRoaXMuY3JlYXRlRXJyb3IoRXJyb3JDb2Rlcy5VTktOT1dOX1BST1BFUlRZLCB7cGF0aDogdW5rbm93blBhdGh9LCB1bmtub3duUGF0aCwgIiIsIG51bGwsIGRhdGEsIHNjaGVtYSk7CgkJdmFyIHJlc3VsdCA9IHRoaXMuaGFuZGxlRXJyb3IoZXJyb3IpOwoJCWlmIChyZXN1bHQpIHsKCQkJcmV0dXJuIHJlc3VsdDsKCQl9Cgl9CglyZXR1cm4gbnVsbDsKfTsKClZhbGlkYXRvckNvbnRleHQucHJvdG90eXBlLmFkZEZvcm1hdCA9IGZ1bmN0aW9uIChmb3JtYXQsIHZhbGlkYXRvcikgewoJaWYgKHR5cGVvZiBmb3JtYXQgPT09ICdvYmplY3QnKSB7CgkJZm9yICh2YXIga2V5IGluIGZvcm1hdCkgewoJCQl0aGlzLmFkZEZvcm1hdChrZXksIGZvcm1hdFtrZXldKTsKCQl9CgkJcmV0dXJuIHRoaXM7Cgl9Cgl0aGlzLmZvcm1hdFZhbGlkYXRvcnNbZm9ybWF0XSA9IHZhbGlkYXRvcjsKfTsKVmFsaWRhdG9yQ29udGV4dC5wcm90b3R5cGUucmVzb2x2ZVJlZnMgPSBmdW5jdGlvbiAoc2NoZW1hLCB1cmxIaXN0b3J5KSB7CglpZiAoc2NoZW1hWyckcmVmJ10gIT09IHVuZGVmaW5lZCkgewoJCXVybEhpc3RvcnkgPSB1cmxIaXN0b3J5IHx8IHt9OwoJCWlmICh1cmxIaXN0b3J5W3NjaGVtYVsnJHJlZiddXSkgewoJCQlyZXR1cm4gdGhpcy5jcmVhdGVFcnJvcihFcnJvckNvZGVzLkNJUkNVTEFSX1JFRkVSRU5DRSwge3VybHM6IE9iamVjdC5rZXlzKHVybEhpc3RvcnkpLmpvaW4oJywgJyl9LCAnJywgJycsIG51bGwsIHVuZGVmaW5lZCwgc2NoZW1hKTsKCQl9CgkJdXJsSGlzdG9yeVtzY2hlbWFbJyRyZWYnXV0gPSB0cnVlOwoJCXNjaGVtYSA9IHRoaXMuZ2V0U2NoZW1hKHNjaGVtYVsnJHJlZiddLCB1cmxIaXN0b3J5KTsKCX0KCXJldHVybiBzY2hlbWE7Cn07ClZhbGlkYXRvckNvbnRleHQucHJvdG90eXBlLmdldFNjaGVtYSA9IGZ1bmN0aW9uICh1cmwsIHVybEhpc3RvcnkpIHsKCXZhciBzY2hlbWE7CglpZiAodGhpcy5zY2hlbWFzW3VybF0gIT09IHVuZGVmaW5lZCkgewoJCXNjaGVtYSA9IHRoaXMuc2NoZW1hc1t1cmxdOwoJCXJldHVybiB0aGlzLnJlc29sdmVSZWZzKHNjaGVtYSwgdXJsSGlzdG9yeSk7Cgl9Cgl2YXIgYmFzZVVybCA9IHVybDsKCXZhciBmcmFnbWVudCA9ICIiOwoJaWYgKHVybC5pbmRleE9mKCcjJykgIT09IC0xKSB7CgkJZnJhZ21lbnQgPSB1cmwuc3Vic3RyaW5nKHVybC5pbmRleE9mKCIjIikgKyAxKTsKCQliYXNlVXJsID0gdXJsLnN1YnN0cmluZygwLCB1cmwuaW5kZXhPZigiIyIpKTsKCX0KCWlmICh0eXBlb2YgdGhpcy5zY2hlbWFzW2Jhc2VVcmxdID09PSAnb2JqZWN0JykgewoJCXNjaGVtYSA9IHRoaXMuc2NoZW1hc1tiYXNlVXJsXTsKCQl2YXIgcG9pbnRlclBhdGggPSBkZWNvZGVVUklDb21wb25lbnQoZnJhZ21lbnQpOwoJCWlmIChwb2ludGVyUGF0aCA9PT0gIiIpIHsKCQkJcmV0dXJuIHRoaXMucmVzb2x2ZVJlZnMoc2NoZW1hLCB1cmxIaXN0b3J5KTsKCQl9IGVsc2UgaWYgKHBvaW50ZXJQYXRoLmNoYXJBdCgwKSAhPT0gIi8iKSB7CgkJCXJldHVybiB1bmRlZmluZWQ7CgkJfQoJCXZhciBwYXJ0cyA9IHBvaW50ZXJQYXRoLnNwbGl0KCIvIikuc2xpY2UoMSk7CgkJZm9yICh2YXIgaSA9IDA7IGkgPCBwYXJ0cy5sZW5ndGg7IGkrKykgewoJCQl2YXIgY29tcG9uZW50ID0gcGFydHNbaV0ucmVwbGFjZSgvfjEvZywgIi8iKS5yZXBsYWNlKC9+MC9nLCAifiIpOwoJCQlpZiAoc2NoZW1hW2NvbXBvbmVudF0gPT09IHVuZGVmaW5lZCkgewoJCQkJc2NoZW1hID0gdW5kZWZpbmVkOwoJCQkJYnJlYWs7CgkJCX0KCQkJc2NoZW1hID0gc2NoZW1hW2NvbXBvbmVudF07CgkJfQoJCWlmIChzY2hlbWEgIT09IHVuZGVmaW5lZCkgewoJCQlyZXR1cm4gdGhpcy5yZXNvbHZlUmVmcyhzY2hlbWEsIHVybEhpc3RvcnkpOwoJCX0KCX0KCWlmICh0aGlzLm1pc3NpbmdbYmFzZVVybF0gPT09IHVuZGVmaW5lZCkgewoJCXRoaXMubWlzc2luZy5wdXNoKGJhc2VVcmwpOwoJCXRoaXMubWlzc2luZ1tiYXNlVXJsXSA9IGJhc2VVcmw7CgkJdGhpcy5taXNzaW5nTWFwW2Jhc2VVcmxdID0gYmFzZVVybDsKCX0KfTsKVmFsaWRhdG9yQ29udGV4dC5wcm90b3R5cGUuc2VhcmNoU2NoZW1hcyA9IGZ1bmN0aW9uIChzY2hlbWEsIHVybCkgewoJaWYgKEFycmF5LmlzQXJyYXkoc2NoZW1hKSkgewoJCWZvciAodmFyIGkgPSAwOyBpIDwgc2NoZW1hLmxlbmd0aDsgaSsrKSB7CgkJCXRoaXMuc2VhcmNoU2NoZW1hcyhzY2hlbWFbaV0sIHVybCk7CgkJfQoJfSBlbHNlIGlmIChzY2hlbWEgJiYgdHlwZW9mIHNjaGVtYSA9PT0gIm9iamVjdCIpIHsKCQlpZiAodHlwZW9mIHNjaGVtYS5pZCA9PT0gInN0cmluZyIpIHsKCQkJaWYgKGlzVHJ1c3RlZFVybCh1cmwsIHNjaGVtYS5pZCkpIHsKCQkJCWlmICh0aGlzLnNjaGVtYXNbc2NoZW1hLmlkXSA9PT0gdW5kZWZpbmVkKSB7CgkJCQkJdGhpcy5zY2hlbWFzW3NjaGVtYS5pZF0gPSBzY2hlbWE7CgkJCQl9CgkJCX0KCQl9CgkJZm9yICh2YXIga2V5IGluIHNjaGVtYSkgewoJCQlpZiAoa2V5ICE9PSAiZW51bSIpIHsKCQkJCWlmICh0eXBlb2Ygc2NoZW1hW2tleV0gPT09ICJvYmplY3QiKSB7CgkJCQkJdGhpcy5zZWFyY2hTY2hlbWFzKHNjaGVtYVtrZXldLCB1cmwpOwoJCQkJfSBlbHNlIGlmIChrZXkgPT09ICIkcmVmIikgewoJCQkJCXZhciB1cmkgPSBnZXREb2N1bWVudFVyaShzY2hlbWFba2V5XSk7CgkJCQkJaWYgKHVyaSAmJiB0aGlzLnNjaGVtYXNbdXJpXSA9PT0gdW5kZWZpbmVkICYmIHRoaXMubWlzc2luZ01hcFt1cmldID09PSB1bmRlZmluZWQpIHsKCQkJCQkJdGhpcy5taXNzaW5nTWFwW3VyaV0gPSB1cmk7CgkJCQkJfQoJCQkJfQoJCQl9CgkJfQoJfQp9OwpWYWxpZGF0b3JDb250ZXh0LnByb3RvdHlwZS5hZGRTY2hlbWEgPSBmdW5jdGlvbiAodXJsLCBzY2hlbWEpIHsKCS8vb3ZlcmxvYWQKCWlmICh0eXBlb2YgdXJsICE9PSAnc3RyaW5nJyB8fCB0eXBlb2Ygc2NoZW1hID09PSAndW5kZWZpbmVkJykgewoJCWlmICh0eXBlb2YgdXJsID09PSAnb2JqZWN0JyAmJiB0eXBlb2YgdXJsLmlkID09PSAnc3RyaW5nJykgewoJCQlzY2hlbWEgPSB1cmw7CgkJCXVybCA9IHNjaGVtYS5pZDsKCQl9CgkJZWxzZSB7CgkJCXJldHVybjsKCQl9Cgl9CglpZiAodXJsID09PSBnZXREb2N1bWVudFVyaSh1cmwpICsgIiMiKSB7CgkJLy8gUmVtb3ZlIGVtcHR5IGZyYWdtZW50CgkJdXJsID0gZ2V0RG9jdW1lbnRVcmkodXJsKTsKCX0KCXRoaXMuc2NoZW1hc1t1cmxdID0gc2NoZW1hOwoJZGVsZXRlIHRoaXMubWlzc2luZ01hcFt1cmxdOwoJbm9ybVNjaGVtYShzY2hlbWEsIHVybCk7Cgl0aGlzLnNlYXJjaFNjaGVtYXMoc2NoZW1hLCB1cmwpOwp9OwoKVmFsaWRhdG9yQ29udGV4dC5wcm90b3R5cGUuZ2V0U2NoZW1hTWFwID0gZnVuY3Rpb24gKCkgewoJdmFyIG1hcCA9IHt9OwoJZm9yICh2YXIga2V5IGluIHRoaXMuc2NoZW1hcykgewoJCW1hcFtrZXldID0gdGhpcy5zY2hlbWFzW2tleV07Cgl9CglyZXR1cm4gbWFwOwp9OwoKVmFsaWRhdG9yQ29udGV4dC5wcm90b3R5cGUuZ2V0U2NoZW1hVXJpcyA9IGZ1bmN0aW9uIChmaWx0ZXJSZWdFeHApIHsKCXZhciBsaXN0ID0gW107Cglmb3IgKHZhciBrZXkgaW4gdGhpcy5zY2hlbWFzKSB7CgkJaWYgKCFmaWx0ZXJSZWdFeHAgfHwgZmlsdGVyUmVnRXhwLnRlc3Qoa2V5KSkgewoJCQlsaXN0LnB1c2goa2V5KTsKCQl9Cgl9CglyZXR1cm4gbGlzdDsKfTsKClZhbGlkYXRvckNvbnRleHQucHJvdG90eXBlLmdldE1pc3NpbmdVcmlzID0gZnVuY3Rpb24gKGZpbHRlclJlZ0V4cCkgewoJdmFyIGxpc3QgPSBbXTsKCWZvciAodmFyIGtleSBpbiB0aGlzLm1pc3NpbmdNYXApIHsKCQlpZiAoIWZpbHRlclJlZ0V4cCB8fCBmaWx0ZXJSZWdFeHAudGVzdChrZXkpKSB7CgkJCWxpc3QucHVzaChrZXkpOwoJCX0KCX0KCXJldHVybiBsaXN0Owp9OwoKVmFsaWRhdG9yQ29udGV4dC5wcm90b3R5cGUuZHJvcFNjaGVtYXMgPSBmdW5jdGlvbiAoKSB7Cgl0aGlzLnNjaGVtYXMgPSB7fTsKCXRoaXMucmVzZXQoKTsKfTsKVmFsaWRhdG9yQ29udGV4dC5wcm90b3R5cGUucmVzZXQgPSBmdW5jdGlvbiAoKSB7Cgl0aGlzLm1pc3NpbmcgPSBbXTsKCXRoaXMubWlzc2luZ01hcCA9IHt9OwoJdGhpcy5lcnJvcnMgPSBbXTsKfTsKClZhbGlkYXRvckNvbnRleHQucHJvdG90eXBlLnZhbGlkYXRlQWxsID0gZnVuY3Rpb24gKGRhdGEsIHNjaGVtYSwgZGF0YVBhdGhQYXJ0cywgc2NoZW1hUGF0aFBhcnRzLCBkYXRhUG9pbnRlclBhdGgpIHsKCXZhciB0b3BMZXZlbDsKCXNjaGVtYSA9IHRoaXMucmVzb2x2ZVJlZnMoc2NoZW1hKTsKCWlmICghc2NoZW1hKSB7CgkJcmV0dXJuIG51bGw7Cgl9IGVsc2UgaWYgKHNjaGVtYSBpbnN0YW5jZW9mIFZhbGlkYXRpb25FcnJvcikgewoJCXRoaXMuZXJyb3JzLnB1c2goc2NoZW1hKTsKCQlyZXR1cm4gc2NoZW1hOwoJfQoKCXZhciBzdGFydEVycm9yQ291bnQgPSB0aGlzLmVycm9ycy5sZW5ndGg7Cgl2YXIgZnJvemVuSW5kZXgsIHNjYW5uZWRGcm96ZW5TY2hlbWFJbmRleCA9IG51bGwsIHNjYW5uZWRTY2hlbWFzSW5kZXggPSBudWxsOwoJaWYgKHRoaXMuY2hlY2tSZWN1cnNpdmUgJiYgZGF0YSAmJiB0eXBlb2YgZGF0YSA9PT0gJ29iamVjdCcpIHsKCQl0b3BMZXZlbCA9ICF0aGlzLnNjYW5uZWQubGVuZ3RoOwoJCWlmIChkYXRhW3RoaXMudmFsaWRhdGVkU2NoZW1hc0tleV0pIHsKCQkJdmFyIHNjaGVtYUluZGV4ID0gZGF0YVt0aGlzLnZhbGlkYXRlZFNjaGVtYXNLZXldLmluZGV4T2Yoc2NoZW1hKTsKCQkJaWYgKHNjaGVtYUluZGV4ICE9PSAtMSkgewoJCQkJdGhpcy5lcnJvcnMgPSB0aGlzLmVycm9ycy5jb25jYXQoZGF0YVt0aGlzLnZhbGlkYXRpb25FcnJvcnNLZXldW3NjaGVtYUluZGV4XSk7CgkJCQlyZXR1cm4gbnVsbDsKCQkJfQoJCX0KCQlpZiAoT2JqZWN0LmlzRnJvemVuKGRhdGEpKSB7CgkJCWZyb3plbkluZGV4ID0gdGhpcy5zY2FubmVkRnJvemVuLmluZGV4T2YoZGF0YSk7CgkJCWlmIChmcm96ZW5JbmRleCAhPT0gLTEpIHsKCQkJCXZhciBmcm96ZW5TY2hlbWFJbmRleCA9IHRoaXMuc2Nhbm5lZEZyb3plblNjaGVtYXNbZnJvemVuSW5kZXhdLmluZGV4T2Yoc2NoZW1hKTsKCQkJCWlmIChmcm96ZW5TY2hlbWFJbmRleCAhPT0gLTEpIHsKCQkJCQl0aGlzLmVycm9ycyA9IHRoaXMuZXJyb3JzLmNvbmNhdCh0aGlzLnNjYW5uZWRGcm96ZW5WYWxpZGF0aW9uRXJyb3JzW2Zyb3plbkluZGV4XVtmcm96ZW5TY2hlbWFJbmRleF0pOwoJCQkJCXJldHVybiBudWxsOwoJCQkJfQoJCQl9CgkJfQoJCXRoaXMuc2Nhbm5lZC5wdXNoKGRhdGEpOwoJCWlmIChPYmplY3QuaXNGcm96ZW4oZGF0YSkpIHsKCQkJaWYgKGZyb3plbkluZGV4ID09PSAtMSkgewoJCQkJZnJvemVuSW5kZXggPSB0aGlzLnNjYW5uZWRGcm96ZW4ubGVuZ3RoOwoJCQkJdGhpcy5zY2FubmVkRnJvemVuLnB1c2goZGF0YSk7CgkJCQl0aGlzLnNjYW5uZWRGcm96ZW5TY2hlbWFzLnB1c2goW10pOwoJCQl9CgkJCXNjYW5uZWRGcm96ZW5TY2hlbWFJbmRleCA9IHRoaXMuc2Nhbm5lZEZyb3plblNjaGVtYXNbZnJvemVuSW5kZXhdLmxlbmd0aDsKCQkJdGhpcy5zY2FubmVkRnJvemVuU2NoZW1hc1tmcm96ZW5JbmRleF1bc2Nhbm5lZEZyb3plblNjaGVtYUluZGV4XSA9IHNjaGVtYTsKCQkJdGhpcy5zY2FubmVkRnJvemVuVmFsaWRhdGlvbkVycm9yc1tmcm96ZW5JbmRleF1bc2Nhbm5lZEZyb3plblNjaGVtYUluZGV4XSA9IFtdOwoJCX0gZWxzZSB7CgkJCWlmICghZGF0YVt0aGlzLnZhbGlkYXRlZFNjaGVtYXNLZXldKSB7CgkJCQl0cnkgewoJCQkJCU9iamVjdC5kZWZpbmVQcm9wZXJ0eShkYXRhLCB0aGlzLnZhbGlkYXRlZFNjaGVtYXNLZXksIHsKCQkJCQkJdmFsdWU6IFtdLAoJCQkJCQljb25maWd1cmFibGU6IHRydWUKCQkJCQl9KTsKCQkJCQlPYmplY3QuZGVmaW5lUHJvcGVydHkoZGF0YSwgdGhpcy52YWxpZGF0aW9uRXJyb3JzS2V5LCB7CgkJCQkJCXZhbHVlOiBbXSwKCQkJCQkJY29uZmlndXJhYmxlOiB0cnVlCgkJCQkJfSk7CgkJCQl9IGNhdGNoIChlKSB7CgkJCQkJLy9JRSA3Lzggd29ya2Fyb3VuZAoJCQkJCWRhdGFbdGhpcy52YWxpZGF0ZWRTY2hlbWFzS2V5XSA9IFtdOwoJCQkJCWRhdGFbdGhpcy52YWxpZGF0aW9uRXJyb3JzS2V5XSA9IFtdOwoJCQkJfQoJCQl9CgkJCXNjYW5uZWRTY2hlbWFzSW5kZXggPSBkYXRhW3RoaXMudmFsaWRhdGVkU2NoZW1hc0tleV0ubGVuZ3RoOwoJCQlkYXRhW3RoaXMudmFsaWRhdGVkU2NoZW1hc0tleV1bc2Nhbm5lZFNjaGVtYXNJbmRleF0gPSBzY2hlbWE7CgkJCWRhdGFbdGhpcy52YWxpZGF0aW9uRXJyb3JzS2V5XVtzY2FubmVkU2NoZW1hc0luZGV4XSA9IFtdOwoJCX0KCX0KCgl2YXIgZXJyb3JDb3VudCA9IHRoaXMuZXJyb3JzLmxlbmd0aDsKCXZhciBlcnJvciA9IHRoaXMudmFsaWRhdGVCYXNpYyhkYXRhLCBzY2hlbWEsIGRhdGFQb2ludGVyUGF0aCkKCQl8fCB0aGlzLnZhbGlkYXRlTnVtZXJpYyhkYXRhLCBzY2hlbWEsIGRhdGFQb2ludGVyUGF0aCkKCQl8fCB0aGlzLnZhbGlkYXRlU3RyaW5nKGRhdGEsIHNjaGVtYSwgZGF0YVBvaW50ZXJQYXRoKQoJCXx8IHRoaXMudmFsaWRhdGVBcnJheShkYXRhLCBzY2hlbWEsIGRhdGFQb2ludGVyUGF0aCkKCQl8fCB0aGlzLnZhbGlkYXRlT2JqZWN0KGRhdGEsIHNjaGVtYSwgZGF0YVBvaW50ZXJQYXRoKQoJCXx8IHRoaXMudmFsaWRhdGVDb21iaW5hdGlvbnMoZGF0YSwgc2NoZW1hLCBkYXRhUG9pbnRlclBhdGgpCgkJfHwgdGhpcy52YWxpZGF0ZUh5cGVybWVkaWEoZGF0YSwgc2NoZW1hLCBkYXRhUG9pbnRlclBhdGgpCgkJfHwgdGhpcy52YWxpZGF0ZUZvcm1hdChkYXRhLCBzY2hlbWEsIGRhdGFQb2ludGVyUGF0aCkKCQl8fCB0aGlzLnZhbGlkYXRlRGVmaW5lZEtleXdvcmRzKGRhdGEsIHNjaGVtYSwgZGF0YVBvaW50ZXJQYXRoKQoJCXx8IG51bGw7CgoJaWYgKHRvcExldmVsKSB7CgkJd2hpbGUgKHRoaXMuc2Nhbm5lZC5sZW5ndGgpIHsKCQkJdmFyIGl0ZW0gPSB0aGlzLnNjYW5uZWQucG9wKCk7CgkJCWRlbGV0ZSBpdGVtW3RoaXMudmFsaWRhdGVkU2NoZW1hc0tleV07CgkJfQoJCXRoaXMuc2Nhbm5lZEZyb3plbiA9IFtdOwoJCXRoaXMuc2Nhbm5lZEZyb3plblNjaGVtYXMgPSBbXTsKCX0KCglpZiAoZXJyb3IgfHwgZXJyb3JDb3VudCAhPT0gdGhpcy5lcnJvcnMubGVuZ3RoKSB7CgkJd2hpbGUgKChkYXRhUGF0aFBhcnRzICYmIGRhdGFQYXRoUGFydHMubGVuZ3RoKSB8fCAoc2NoZW1hUGF0aFBhcnRzICYmIHNjaGVtYVBhdGhQYXJ0cy5sZW5ndGgpKSB7CgkJCXZhciBkYXRhUGFydCA9IChkYXRhUGF0aFBhcnRzICYmIGRhdGFQYXRoUGFydHMubGVuZ3RoKSA/ICIiICsgZGF0YVBhdGhQYXJ0cy5wb3AoKSA6IG51bGw7CgkJCXZhciBzY2hlbWFQYXJ0ID0gKHNjaGVtYVBhdGhQYXJ0cyAmJiBzY2hlbWFQYXRoUGFydHMubGVuZ3RoKSA/ICIiICsgc2NoZW1hUGF0aFBhcnRzLnBvcCgpIDogbnVsbDsKCQkJaWYgKGVycm9yKSB7CgkJCQllcnJvciA9IGVycm9yLnByZWZpeFdpdGgoZGF0YVBhcnQsIHNjaGVtYVBhcnQpOwoJCQl9CgkJCXRoaXMucHJlZml4RXJyb3JzKGVycm9yQ291bnQsIGRhdGFQYXJ0LCBzY2hlbWFQYXJ0KTsKCQl9Cgl9CgoJaWYgKHNjYW5uZWRGcm96ZW5TY2hlbWFJbmRleCAhPT0gbnVsbCkgewoJCXRoaXMuc2Nhbm5lZEZyb3plblZhbGlkYXRpb25FcnJvcnNbZnJvemVuSW5kZXhdW3NjYW5uZWRGcm96ZW5TY2hlbWFJbmRleF0gPSB0aGlzLmVycm9ycy5zbGljZShzdGFydEVycm9yQ291bnQpOwoJfSBlbHNlIGlmIChzY2FubmVkU2NoZW1hc0luZGV4ICE9PSBudWxsKSB7CgkJZGF0YVt0aGlzLnZhbGlkYXRpb25FcnJvcnNLZXldW3NjYW5uZWRTY2hlbWFzSW5kZXhdID0gdGhpcy5lcnJvcnMuc2xpY2Uoc3RhcnRFcnJvckNvdW50KTsKCX0KCglyZXR1cm4gdGhpcy5oYW5kbGVFcnJvcihlcnJvcik7Cn07ClZhbGlkYXRvckNvbnRleHQucHJvdG90eXBlLnZhbGlkYXRlRm9ybWF0ID0gZnVuY3Rpb24gKGRhdGEsIHNjaGVtYSkgewoJaWYgKHR5cGVvZiBzY2hlbWEuZm9ybWF0ICE9PSAnc3RyaW5nJyB8fCAhdGhpcy5mb3JtYXRWYWxpZGF0b3JzW3NjaGVtYS5mb3JtYXRdKSB7CgkJcmV0dXJuIG51bGw7Cgl9Cgl2YXIgZXJyb3JNZXNzYWdlID0gdGhpcy5mb3JtYXRWYWxpZGF0b3JzW3NjaGVtYS5mb3JtYXRdLmNhbGwobnVsbCwgZGF0YSwgc2NoZW1hKTsKCWlmICh0eXBlb2YgZXJyb3JNZXNzYWdlID09PSAnc3RyaW5nJyB8fCB0eXBlb2YgZXJyb3JNZXNzYWdlID09PSAnbnVtYmVyJykgewoJCXJldHVybiB0aGlzLmNyZWF0ZUVycm9yKEVycm9yQ29kZXMuRk9STUFUX0NVU1RPTSwge21lc3NhZ2U6IGVycm9yTWVzc2FnZX0sICcnLCAnL2Zvcm1hdCcsIG51bGwsIGRhdGEsIHNjaGVtYSk7Cgl9IGVsc2UgaWYgKGVycm9yTWVzc2FnZSAmJiB0eXBlb2YgZXJyb3JNZXNzYWdlID09PSAnb2JqZWN0JykgewoJCXJldHVybiB0aGlzLmNyZWF0ZUVycm9yKEVycm9yQ29kZXMuRk9STUFUX0NVU1RPTSwge21lc3NhZ2U6IGVycm9yTWVzc2FnZS5tZXNzYWdlIHx8ICI/In0sIGVycm9yTWVzc2FnZS5kYXRhUGF0aCB8fCAnJywgZXJyb3JNZXNzYWdlLnNjaGVtYVBhdGggfHwgIi9mb3JtYXQiLCBudWxsLCBkYXRhLCBzY2hlbWEpOwoJfQoJcmV0dXJuIG51bGw7Cn07ClZhbGlkYXRvckNvbnRleHQucHJvdG90eXBlLnZhbGlkYXRlRGVmaW5lZEtleXdvcmRzID0gZnVuY3Rpb24gKGRhdGEsIHNjaGVtYSwgZGF0YVBvaW50ZXJQYXRoKSB7Cglmb3IgKHZhciBrZXkgaW4gdGhpcy5kZWZpbmVkS2V5d29yZHMpIHsKCQlpZiAodHlwZW9mIHNjaGVtYVtrZXldID09PSAndW5kZWZpbmVkJykgewoJCQljb250aW51ZTsKCQl9CgkJdmFyIHZhbGlkYXRpb25GdW5jdGlvbnMgPSB0aGlzLmRlZmluZWRLZXl3b3Jkc1trZXldOwoJCWZvciAodmFyIGkgPSAwOyBpIDwgdmFsaWRhdGlvbkZ1bmN0aW9ucy5sZW5ndGg7IGkrKykgewoJCQl2YXIgZnVuYyA9IHZhbGlkYXRpb25GdW5jdGlvbnNbaV07CgkJCXZhciByZXN1bHQgPSBmdW5jKGRhdGEsIHNjaGVtYVtrZXldLCBzY2hlbWEsIGRhdGFQb2ludGVyUGF0aCk7CgkJCWlmICh0eXBlb2YgcmVzdWx0ID09PSAnc3RyaW5nJyB8fCB0eXBlb2YgcmVzdWx0ID09PSAnbnVtYmVyJykgewoJCQkJcmV0dXJuIHRoaXMuY3JlYXRlRXJyb3IoRXJyb3JDb2Rlcy5LRVlXT1JEX0NVU1RPTSwge2tleToga2V5LCBtZXNzYWdlOiByZXN1bHR9LCAnJywgJycsIG51bGwsIGRhdGEsIHNjaGVtYSkucHJlZml4V2l0aChudWxsLCBrZXkpOwoJCQl9IGVsc2UgaWYgKHJlc3VsdCAmJiB0eXBlb2YgcmVzdWx0ID09PSAnb2JqZWN0JykgewoJCQkJdmFyIGNvZGUgPSByZXN1bHQuY29kZTsKCQkJCWlmICh0eXBlb2YgY29kZSA9PT0gJ3N0cmluZycpIHsKCQkJCQlpZiAoIUVycm9yQ29kZXNbY29kZV0pIHsKCQkJCQkJdGhyb3cgbmV3IEVycm9yKCdVbmRlZmluZWQgZXJyb3IgY29kZSAodXNlIGRlZmluZUVycm9yKTogJyArIGNvZGUpOwoJCQkJCX0KCQkJCQljb2RlID0gRXJyb3JDb2Rlc1tjb2RlXTsKCQkJCX0gZWxzZSBpZiAodHlwZW9mIGNvZGUgIT09ICdudW1iZXInKSB7CgkJCQkJY29kZSA9IEVycm9yQ29kZXMuS0VZV09SRF9DVVNUT007CgkJCQl9CgkJCQl2YXIgbWVzc2FnZVBhcmFtcyA9ICh0eXBlb2YgcmVzdWx0Lm1lc3NhZ2UgPT09ICdvYmplY3QnKSA/IHJlc3VsdC5tZXNzYWdlIDoge2tleToga2V5LCBtZXNzYWdlOiByZXN1bHQubWVzc2FnZSB8fCAiPyJ9OwoJCQkJdmFyIHNjaGVtYVBhdGggPSByZXN1bHQuc2NoZW1hUGF0aCB8fCAoIi8iICsga2V5LnJlcGxhY2UoL34vZywgJ34wJykucmVwbGFjZSgvXC8vZywgJ34xJykpOwoJCQkJcmV0dXJuIHRoaXMuY3JlYXRlRXJyb3IoY29kZSwgbWVzc2FnZVBhcmFtcywgcmVzdWx0LmRhdGFQYXRoIHx8IG51bGwsIHNjaGVtYVBhdGgsIG51bGwsIGRhdGEsIHNjaGVtYSk7CgkJCX0KCQl9Cgl9CglyZXR1cm4gbnVsbDsKfTsKCmZ1bmN0aW9uIHJlY3Vyc2l2ZUNvbXBhcmUoQSwgQikgewoJaWYgKEEgPT09IEIpIHsKCQlyZXR1cm4gdHJ1ZTsKCX0KCWlmIChBICYmIEIgJiYgdHlwZW9mIEEgPT09ICJvYmplY3QiICYmIHR5cGVvZiBCID09PSAib2JqZWN0IikgewoJCWlmIChBcnJheS5pc0FycmF5KEEpICE9PSBBcnJheS5pc0FycmF5KEIpKSB7CgkJCXJldHVybiBmYWxzZTsKCQl9IGVsc2UgaWYgKEFycmF5LmlzQXJyYXkoQSkpIHsKCQkJaWYgKEEubGVuZ3RoICE9PSBCLmxlbmd0aCkgewoJCQkJcmV0dXJuIGZhbHNlOwoJCQl9CgkJCWZvciAodmFyIGkgPSAwOyBpIDwgQS5sZW5ndGg7IGkrKykgewoJCQkJaWYgKCFyZWN1cnNpdmVDb21wYXJlKEFbaV0sIEJbaV0pKSB7CgkJCQkJcmV0dXJuIGZhbHNlOwoJCQkJfQoJCQl9CgkJfSBlbHNlIHsKCQkJdmFyIGtleTsKCQkJZm9yIChrZXkgaW4gQSkgewoJCQkJaWYgKEJba2V5XSA9PT0gdW5kZWZpbmVkICYmIEFba2V5XSAhPT0gdW5kZWZpbmVkKSB7CgkJCQkJcmV0dXJuIGZhbHNlOwoJCQkJfQoJCQl9CgkJCWZvciAoa2V5IGluIEIpIHsKCQkJCWlmIChBW2tleV0gPT09IHVuZGVmaW5lZCAmJiBCW2tleV0gIT09IHVuZGVmaW5lZCkgewoJCQkJCXJldHVybiBmYWxzZTsKCQkJCX0KCQkJfQoJCQlmb3IgKGtleSBpbiBBKSB7CgkJCQlpZiAoIXJlY3Vyc2l2ZUNvbXBhcmUoQVtrZXldLCBCW2tleV0pKSB7CgkJCQkJcmV0dXJuIGZhbHNlOwoJCQkJfQoJCQl9CgkJfQoJCXJldHVybiB0cnVlOwoJfQoJcmV0dXJuIGZhbHNlOwp9CgpWYWxpZGF0b3JDb250ZXh0LnByb3RvdHlwZS52YWxpZGF0ZUJhc2ljID0gZnVuY3Rpb24gdmFsaWRhdGVCYXNpYyhkYXRhLCBzY2hlbWEsIGRhdGFQb2ludGVyUGF0aCkgewoJdmFyIGVycm9yOwoJaWYgKGVycm9yID0gdGhpcy52YWxpZGF0ZVR5cGUoZGF0YSwgc2NoZW1hLCBkYXRhUG9pbnRlclBhdGgpKSB7CgkJcmV0dXJuIGVycm9yLnByZWZpeFdpdGgobnVsbCwgInR5cGUiKTsKCX0KCWlmIChlcnJvciA9IHRoaXMudmFsaWRhdGVFbnVtKGRhdGEsIHNjaGVtYSwgZGF0YVBvaW50ZXJQYXRoKSkgewoJCXJldHVybiBlcnJvci5wcmVmaXhXaXRoKG51bGwsICJ0eXBlIik7Cgl9CglyZXR1cm4gbnVsbDsKfTsKClZhbGlkYXRvckNvbnRleHQucHJvdG90eXBlLnZhbGlkYXRlVHlwZSA9IGZ1bmN0aW9uIHZhbGlkYXRlVHlwZShkYXRhLCBzY2hlbWEpIHsKCWlmIChzY2hlbWEudHlwZSA9PT0gdW5kZWZpbmVkKSB7CgkJcmV0dXJuIG51bGw7Cgl9Cgl2YXIgZGF0YVR5cGUgPSB0eXBlb2YgZGF0YTsKCWlmIChkYXRhID09PSBudWxsKSB7CgkJZGF0YVR5cGUgPSAibnVsbCI7Cgl9IGVsc2UgaWYgKEFycmF5LmlzQXJyYXkoZGF0YSkpIHsKCQlkYXRhVHlwZSA9ICJhcnJheSI7Cgl9Cgl2YXIgYWxsb3dlZFR5cGVzID0gc2NoZW1hLnR5cGU7CglpZiAoIUFycmF5LmlzQXJyYXkoYWxsb3dlZFR5cGVzKSkgewoJCWFsbG93ZWRUeXBlcyA9IFthbGxvd2VkVHlwZXNdOwoJfQoKCWZvciAodmFyIGkgPSAwOyBpIDwgYWxsb3dlZFR5cGVzLmxlbmd0aDsgaSsrKSB7CgkJdmFyIHR5cGUgPSBhbGxvd2VkVHlwZXNbaV07CgkJaWYgKHR5cGUgPT09IGRhdGFUeXBlIHx8ICh0eXBlID09PSAiaW50ZWdlciIgJiYgZGF0YVR5cGUgPT09ICJudW1iZXIiICYmIChkYXRhICUgMSA9PT0gMCkpKSB7CgkJCXJldHVybiBudWxsOwoJCX0KCX0KCXJldHVybiB0aGlzLmNyZWF0ZUVycm9yKEVycm9yQ29kZXMuSU5WQUxJRF9UWVBFLCB7dHlwZTogZGF0YVR5cGUsIGV4cGVjdGVkOiBhbGxvd2VkVHlwZXMuam9pbigiLyIpfSwgJycsICcnLCBudWxsLCBkYXRhLCBzY2hlbWEpOwp9OwoKVmFsaWRhdG9yQ29udGV4dC5wcm90b3R5cGUudmFsaWRhdGVFbnVtID0gZnVuY3Rpb24gdmFsaWRhdGVFbnVtKGRhdGEsIHNjaGVtYSkgewoJaWYgKHNjaGVtYVsiZW51bSJdID09PSB1bmRlZmluZWQpIHsKCQlyZXR1cm4gbnVsbDsKCX0KCWZvciAodmFyIGkgPSAwOyBpIDwgc2NoZW1hWyJlbnVtIl0ubGVuZ3RoOyBpKyspIHsKCQl2YXIgZW51bVZhbCA9IHNjaGVtYVsiZW51bSJdW2ldOwoJCWlmIChyZWN1cnNpdmVDb21wYXJlKGRhdGEsIGVudW1WYWwpKSB7CgkJCXJldHVybiBudWxsOwoJCX0KCX0KCXJldHVybiB0aGlzLmNyZWF0ZUVycm9yKEVycm9yQ29kZXMuRU5VTV9NSVNNQVRDSCwge3ZhbHVlOiAodHlwZW9mIEpTT04gIT09ICd1bmRlZmluZWQnKSA/IEpTT04uc3RyaW5naWZ5KGRhdGEpIDogZGF0YX0sICcnLCAnJywgbnVsbCwgZGF0YSwgc2NoZW1hKTsKfTsKClZhbGlkYXRvckNvbnRleHQucHJvdG90eXBlLnZhbGlkYXRlTnVtZXJpYyA9IGZ1bmN0aW9uIHZhbGlkYXRlTnVtZXJpYyhkYXRhLCBzY2hlbWEsIGRhdGFQb2ludGVyUGF0aCkgewoJcmV0dXJuIHRoaXMudmFsaWRhdGVNdWx0aXBsZU9mKGRhdGEsIHNjaGVtYSwgZGF0YVBvaW50ZXJQYXRoKQoJCXx8IHRoaXMudmFsaWRhdGVNaW5NYXgoZGF0YSwgc2NoZW1hLCBkYXRhUG9pbnRlclBhdGgpCgkJfHwgdGhpcy52YWxpZGF0ZU5hTihkYXRhLCBzY2hlbWEsIGRhdGFQb2ludGVyUGF0aCkKCQl8fCBudWxsOwp9OwoKdmFyIENMT1NFX0VOT1VHSF9MT1cgPSBNYXRoLnBvdygyLCAtNTEpOwp2YXIgQ0xPU0VfRU5PVUdIX0hJR0ggPSAxIC0gQ0xPU0VfRU5PVUdIX0xPVzsKVmFsaWRhdG9yQ29udGV4dC5wcm90b3R5cGUudmFsaWRhdGVNdWx0aXBsZU9mID0gZnVuY3Rpb24gdmFsaWRhdGVNdWx0aXBsZU9mKGRhdGEsIHNjaGVtYSkgewoJdmFyIG11bHRpcGxlT2YgPSBzY2hlbWEubXVsdGlwbGVPZiB8fCBzY2hlbWEuZGl2aXNpYmxlQnk7CglpZiAobXVsdGlwbGVPZiA9PT0gdW5kZWZpbmVkKSB7CgkJcmV0dXJuIG51bGw7Cgl9CglpZiAodHlwZW9mIGRhdGEgPT09ICJudW1iZXIiKSB7CgkJdmFyIHJlbWFpbmRlciA9IChkYXRhL211bHRpcGxlT2YpJTE7CgkJaWYgKHJlbWFpbmRlciA+PSBDTE9TRV9FTk9VR0hfTE9XICYmIHJlbWFpbmRlciA8IENMT1NFX0VOT1VHSF9ISUdIKSB7CgkJCXJldHVybiB0aGlzLmNyZWF0ZUVycm9yKEVycm9yQ29kZXMuTlVNQkVSX01VTFRJUExFX09GLCB7dmFsdWU6IGRhdGEsIG11bHRpcGxlT2Y6IG11bHRpcGxlT2Z9LCAnJywgJycsIG51bGwsIGRhdGEsIHNjaGVtYSk7CgkJfQoJfQoJcmV0dXJuIG51bGw7Cn07CgpWYWxpZGF0b3JDb250ZXh0LnByb3RvdHlwZS52YWxpZGF0ZU1pbk1heCA9IGZ1bmN0aW9uIHZhbGlkYXRlTWluTWF4KGRhdGEsIHNjaGVtYSkgewoJaWYgKHR5cGVvZiBkYXRhICE9PSAibnVtYmVyIikgewoJCXJldHVybiBudWxsOwoJfQoJaWYgKHNjaGVtYS5taW5pbXVtICE9PSB1bmRlZmluZWQpIHsKCQlpZiAoZGF0YSA8IHNjaGVtYS5taW5pbXVtKSB7CgkJCXJldHVybiB0aGlzLmNyZWF0ZUVycm9yKEVycm9yQ29kZXMuTlVNQkVSX01JTklNVU0sIHt2YWx1ZTogZGF0YSwgbWluaW11bTogc2NoZW1hLm1pbmltdW19LCAnJywgJy9taW5pbXVtJywgbnVsbCwgZGF0YSwgc2NoZW1hKTsKCQl9CgkJaWYgKHNjaGVtYS5leGNsdXNpdmVNaW5pbXVtICYmIGRhdGEgPT09IHNjaGVtYS5taW5pbXVtKSB7CgkJCXJldHVybiB0aGlzLmNyZWF0ZUVycm9yKEVycm9yQ29kZXMuTlVNQkVSX01JTklNVU1fRVhDTFVTSVZFLCB7dmFsdWU6IGRhdGEsIG1pbmltdW06IHNjaGVtYS5taW5pbXVtfSwgJycsICcvZXhjbHVzaXZlTWluaW11bScsIG51bGwsIGRhdGEsIHNjaGVtYSk7CgkJfQoJfQoJaWYgKHNjaGVtYS5tYXhpbXVtICE9PSB1bmRlZmluZWQpIHsKCQlpZiAoZGF0YSA+IHNjaGVtYS5tYXhpbXVtKSB7CgkJCXJldHVybiB0aGlzLmNyZWF0ZUVycm9yKEVycm9yQ29kZXMuTlVNQkVSX01BWElNVU0sIHt2YWx1ZTogZGF0YSwgbWF4aW11bTogc2NoZW1hLm1heGltdW19LCAnJywgJy9tYXhpbXVtJywgbnVsbCwgZGF0YSwgc2NoZW1hKTsKCQl9CgkJaWYgKHNjaGVtYS5leGNsdXNpdmVNYXhpbXVtICYmIGRhdGEgPT09IHNjaGVtYS5tYXhpbXVtKSB7CgkJCXJldHVybiB0aGlzLmNyZWF0ZUVycm9yKEVycm9yQ29kZXMuTlVNQkVSX01BWElNVU1fRVhDTFVTSVZFLCB7dmFsdWU6IGRhdGEsIG1heGltdW06IHNjaGVtYS5tYXhpbXVtfSwgJycsICcvZXhjbHVzaXZlTWF4aW11bScsIG51bGwsIGRhdGEsIHNjaGVtYSk7CgkJfQoJfQoJcmV0dXJuIG51bGw7Cn07CgpWYWxpZGF0b3JDb250ZXh0LnByb3RvdHlwZS52YWxpZGF0ZU5hTiA9IGZ1bmN0aW9uIHZhbGlkYXRlTmFOKGRhdGEsIHNjaGVtYSkgewoJaWYgKHR5cGVvZiBkYXRhICE9PSAibnVtYmVyIikgewoJCXJldHVybiBudWxsOwoJfQoJaWYgKGlzTmFOKGRhdGEpID09PSB0cnVlIHx8IGRhdGEgPT09IEluZmluaXR5IHx8IGRhdGEgPT09IC1JbmZpbml0eSkgewoJCXJldHVybiB0aGlzLmNyZWF0ZUVycm9yKEVycm9yQ29kZXMuTlVNQkVSX05PVF9BX05VTUJFUiwge3ZhbHVlOiBkYXRhfSwgJycsICcvdHlwZScsIG51bGwsIGRhdGEsIHNjaGVtYSk7Cgl9CglyZXR1cm4gbnVsbDsKfTsKClZhbGlkYXRvckNvbnRleHQucHJvdG90eXBlLnZhbGlkYXRlU3RyaW5nID0gZnVuY3Rpb24gdmFsaWRhdGVTdHJpbmcoZGF0YSwgc2NoZW1hLCBkYXRhUG9pbnRlclBhdGgpIHsKCXJldHVybiB0aGlzLnZhbGlkYXRlU3RyaW5nTGVuZ3RoKGRhdGEsIHNjaGVtYSwgZGF0YVBvaW50ZXJQYXRoKQoJCXx8IHRoaXMudmFsaWRhdGVTdHJpbmdQYXR0ZXJuKGRhdGEsIHNjaGVtYSwgZGF0YVBvaW50ZXJQYXRoKQoJCXx8IG51bGw7Cn07CgpWYWxpZGF0b3JDb250ZXh0LnByb3RvdHlwZS52YWxpZGF0ZVN0cmluZ0xlbmd0aCA9IGZ1bmN0aW9uIHZhbGlkYXRlU3RyaW5nTGVuZ3RoKGRhdGEsIHNjaGVtYSkgewoJaWYgKHR5cGVvZiBkYXRhICE9PSAic3RyaW5nIikgewoJCXJldHVybiBudWxsOwoJfQoJaWYgKHNjaGVtYS5taW5MZW5ndGggIT09IHVuZGVmaW5lZCkgewoJCWlmIChkYXRhLmxlbmd0aCA8IHNjaGVtYS5taW5MZW5ndGgpIHsKCQkJcmV0dXJuIHRoaXMuY3JlYXRlRXJyb3IoRXJyb3JDb2Rlcy5TVFJJTkdfTEVOR1RIX1NIT1JULCB7bGVuZ3RoOiBkYXRhLmxlbmd0aCwgbWluaW11bTogc2NoZW1hLm1pbkxlbmd0aH0sICcnLCAnL21pbkxlbmd0aCcsIG51bGwsIGRhdGEsIHNjaGVtYSk7CgkJfQoJfQoJaWYgKHNjaGVtYS5tYXhMZW5ndGggIT09IHVuZGVmaW5lZCkgewoJCWlmIChkYXRhLmxlbmd0aCA+IHNjaGVtYS5tYXhMZW5ndGgpIHsKCQkJcmV0dXJuIHRoaXMuY3JlYXRlRXJyb3IoRXJyb3JDb2Rlcy5TVFJJTkdfTEVOR1RIX0xPTkcsIHtsZW5ndGg6IGRhdGEubGVuZ3RoLCBtYXhpbXVtOiBzY2hlbWEubWF4TGVuZ3RofSwgJycsICcvbWF4TGVuZ3RoJywgbnVsbCwgZGF0YSwgc2NoZW1hKTsKCQl9Cgl9CglyZXR1cm4gbnVsbDsKfTsKClZhbGlkYXRvckNvbnRleHQucHJvdG90eXBlLnZhbGlkYXRlU3RyaW5nUGF0dGVybiA9IGZ1bmN0aW9uIHZhbGlkYXRlU3RyaW5nUGF0dGVybihkYXRhLCBzY2hlbWEpIHsKCWlmICh0eXBlb2YgZGF0YSAhPT0gInN0cmluZyIgfHwgKHR5cGVvZiBzY2hlbWEucGF0dGVybiAhPT0gInN0cmluZyIgJiYgIShzY2hlbWEucGF0dGVybiBpbnN0YW5jZW9mIFJlZ0V4cCkpKSB7CgkJcmV0dXJuIG51bGw7Cgl9Cgl2YXIgcmVnZXhwOwoJaWYgKHNjaGVtYS5wYXR0ZXJuIGluc3RhbmNlb2YgUmVnRXhwKSB7CgkgIHJlZ2V4cCA9IHNjaGVtYS5wYXR0ZXJuOwoJfQoJZWxzZSB7CgkgIHZhciBib2R5LCBmbGFncyA9ICcnOwoJICAvLyBDaGVjayBmb3IgcmVndWxhciBleHByZXNzaW9uIGxpdGVyYWxzCgkgIC8vIEBzZWUgaHR0cDovL3d3dy5lY21hLWludGVybmF0aW9uYWwub3JnL2VjbWEtMjYyLzUuMS8jc2VjLTcuOC41CgkgIHZhciBsaXRlcmFsID0gc2NoZW1hLnBhdHRlcm4ubWF0Y2goL15cLyguKylcLyhbaW1nXSopJC8pOwoJICBpZiAobGl0ZXJhbCkgewoJICAgIGJvZHkgPSBsaXRlcmFsWzFdOwoJICAgIGZsYWdzID0gbGl0ZXJhbFsyXTsKCSAgfQoJICBlbHNlIHsKCSAgICBib2R5ID0gc2NoZW1hLnBhdHRlcm47CgkgIH0KCSAgcmVnZXhwID0gbmV3IFJlZ0V4cChib2R5LCBmbGFncyk7Cgl9CglpZiAoIXJlZ2V4cC50ZXN0KGRhdGEpKSB7CgkJcmV0dXJuIHRoaXMuY3JlYXRlRXJyb3IoRXJyb3JDb2Rlcy5TVFJJTkdfUEFUVEVSTiwge3BhdHRlcm46IHNjaGVtYS5wYXR0ZXJufSwgJycsICcvcGF0dGVybicsIG51bGwsIGRhdGEsIHNjaGVtYSk7Cgl9CglyZXR1cm4gbnVsbDsKfTsKClZhbGlkYXRvckNvbnRleHQucHJvdG90eXBlLnZhbGlkYXRlQXJyYXkgPSBmdW5jdGlvbiB2YWxpZGF0ZUFycmF5KGRhdGEsIHNjaGVtYSwgZGF0YVBvaW50ZXJQYXRoKSB7CglpZiAoIUFycmF5LmlzQXJyYXkoZGF0YSkpIHsKCQlyZXR1cm4gbnVsbDsKCX0KCXJldHVybiB0aGlzLnZhbGlkYXRlQXJyYXlMZW5ndGgoZGF0YSwgc2NoZW1hLCBkYXRhUG9pbnRlclBhdGgpCgkJfHwgdGhpcy52YWxpZGF0ZUFycmF5VW5pcXVlSXRlbXMoZGF0YSwgc2NoZW1hLCBkYXRhUG9pbnRlclBhdGgpCgkJfHwgdGhpcy52YWxpZGF0ZUFycmF5SXRlbXMoZGF0YSwgc2NoZW1hLCBkYXRhUG9pbnRlclBhdGgpCgkJfHwgbnVsbDsKfTsKClZhbGlkYXRvckNvbnRleHQucHJvdG90eXBlLnZhbGlkYXRlQXJyYXlMZW5ndGggPSBmdW5jdGlvbiB2YWxpZGF0ZUFycmF5TGVuZ3RoKGRhdGEsIHNjaGVtYSkgewoJdmFyIGVycm9yOwoJaWYgKHNjaGVtYS5taW5JdGVtcyAhPT0gdW5kZWZpbmVkKSB7CgkJaWYgKGRhdGEubGVuZ3RoIDwgc2NoZW1hLm1pbkl0ZW1zKSB7CgkJCWVycm9yID0gdGhpcy5jcmVhdGVFcnJvcihFcnJvckNvZGVzLkFSUkFZX0xFTkdUSF9TSE9SVCwge2xlbmd0aDogZGF0YS5sZW5ndGgsIG1pbmltdW06IHNjaGVtYS5taW5JdGVtc30sICcnLCAnL21pbkl0ZW1zJywgbnVsbCwgZGF0YSwgc2NoZW1hKTsKCQkJaWYgKHRoaXMuaGFuZGxlRXJyb3IoZXJyb3IpKSB7CgkJCQlyZXR1cm4gZXJyb3I7CgkJCX0KCQl9Cgl9CglpZiAoc2NoZW1hLm1heEl0ZW1zICE9PSB1bmRlZmluZWQpIHsKCQlpZiAoZGF0YS5sZW5ndGggPiBzY2hlbWEubWF4SXRlbXMpIHsKCQkJZXJyb3IgPSB0aGlzLmNyZWF0ZUVycm9yKEVycm9yQ29kZXMuQVJSQVlfTEVOR1RIX0xPTkcsIHtsZW5ndGg6IGRhdGEubGVuZ3RoLCBtYXhpbXVtOiBzY2hlbWEubWF4SXRlbXN9LCAnJywgJy9tYXhJdGVtcycsIG51bGwsIGRhdGEsIHNjaGVtYSk7CgkJCWlmICh0aGlzLmhhbmRsZUVycm9yKGVycm9yKSkgewoJCQkJcmV0dXJuIGVycm9yOwoJCQl9CgkJfQoJfQoJcmV0dXJuIG51bGw7Cn07CgpWYWxpZGF0b3JDb250ZXh0LnByb3RvdHlwZS52YWxpZGF0ZUFycmF5VW5pcXVlSXRlbXMgPSBmdW5jdGlvbiB2YWxpZGF0ZUFycmF5VW5pcXVlSXRlbXMoZGF0YSwgc2NoZW1hKSB7CglpZiAoc2NoZW1hLnVuaXF1ZUl0ZW1zKSB7CgkJZm9yICh2YXIgaSA9IDA7IGkgPCBkYXRhLmxlbmd0aDsgaSsrKSB7CgkJCWZvciAodmFyIGogPSBpICsgMTsgaiA8IGRhdGEubGVuZ3RoOyBqKyspIHsKCQkJCWlmIChyZWN1cnNpdmVDb21wYXJlKGRhdGFbaV0sIGRhdGFbal0pKSB7CgkJCQkJdmFyIGVycm9yID0gdGhpcy5jcmVhdGVFcnJvcihFcnJvckNvZGVzLkFSUkFZX1VOSVFVRSwge21hdGNoMTogaSwgbWF0Y2gyOiBqfSwgJycsICcvdW5pcXVlSXRlbXMnLCBudWxsLCBkYXRhLCBzY2hlbWEpOwoJCQkJCWlmICh0aGlzLmhhbmRsZUVycm9yKGVycm9yKSkgewoJCQkJCQlyZXR1cm4gZXJyb3I7CgkJCQkJfQoJCQkJfQoJCQl9CgkJfQoJfQoJcmV0dXJuIG51bGw7Cn07CgpWYWxpZGF0b3JDb250ZXh0LnByb3RvdHlwZS52YWxpZGF0ZUFycmF5SXRlbXMgPSBmdW5jdGlvbiB2YWxpZGF0ZUFycmF5SXRlbXMoZGF0YSwgc2NoZW1hLCBkYXRhUG9pbnRlclBhdGgpIHsKCWlmIChzY2hlbWEuaXRlbXMgPT09IHVuZGVmaW5lZCkgewoJCXJldHVybiBudWxsOwoJfQoJdmFyIGVycm9yLCBpOwoJaWYgKEFycmF5LmlzQXJyYXkoc2NoZW1hLml0ZW1zKSkgewoJCWZvciAoaSA9IDA7IGkgPCBkYXRhLmxlbmd0aDsgaSsrKSB7CgkJCWlmIChpIDwgc2NoZW1hLml0ZW1zLmxlbmd0aCkgewoJCQkJaWYgKGVycm9yID0gdGhpcy52YWxpZGF0ZUFsbChkYXRhW2ldLCBzY2hlbWEuaXRlbXNbaV0sIFtpXSwgWyJpdGVtcyIsIGldLCBkYXRhUG9pbnRlclBhdGggKyAiLyIgKyBpKSkgewoJCQkJCXJldHVybiBlcnJvcjsKCQkJCX0KCQkJfSBlbHNlIGlmIChzY2hlbWEuYWRkaXRpb25hbEl0ZW1zICE9PSB1bmRlZmluZWQpIHsKCQkJCWlmICh0eXBlb2Ygc2NoZW1hLmFkZGl0aW9uYWxJdGVtcyA9PT0gImJvb2xlYW4iKSB7CgkJCQkJaWYgKCFzY2hlbWEuYWRkaXRpb25hbEl0ZW1zKSB7CgkJCQkJCWVycm9yID0gKHRoaXMuY3JlYXRlRXJyb3IoRXJyb3JDb2Rlcy5BUlJBWV9BRERJVElPTkFMX0lURU1TLCB7fSwgJy8nICsgaSwgJy9hZGRpdGlvbmFsSXRlbXMnLCBudWxsLCBkYXRhLCBzY2hlbWEpKTsKCQkJCQkJaWYgKHRoaXMuaGFuZGxlRXJyb3IoZXJyb3IpKSB7CgkJCQkJCQlyZXR1cm4gZXJyb3I7CgkJCQkJCX0KCQkJCQl9CgkJCQl9IGVsc2UgaWYgKGVycm9yID0gdGhpcy52YWxpZGF0ZUFsbChkYXRhW2ldLCBzY2hlbWEuYWRkaXRpb25hbEl0ZW1zLCBbaV0sIFsiYWRkaXRpb25hbEl0ZW1zIl0sIGRhdGFQb2ludGVyUGF0aCArICIvIiArIGkpKSB7CgkJCQkJcmV0dXJuIGVycm9yOwoJCQkJfQoJCQl9CgkJfQoJfSBlbHNlIHsKCQlmb3IgKGkgPSAwOyBpIDwgZGF0YS5sZW5ndGg7IGkrKykgewoJCQlpZiAoZXJyb3IgPSB0aGlzLnZhbGlkYXRlQWxsKGRhdGFbaV0sIHNjaGVtYS5pdGVtcywgW2ldLCBbIml0ZW1zIl0sIGRhdGFQb2ludGVyUGF0aCArICIvIiArIGkpKSB7CgkJCQlyZXR1cm4gZXJyb3I7CgkJCX0KCQl9Cgl9CglyZXR1cm4gbnVsbDsKfTsKClZhbGlkYXRvckNvbnRleHQucHJvdG90eXBlLnZhbGlkYXRlT2JqZWN0ID0gZnVuY3Rpb24gdmFsaWRhdGVPYmplY3QoZGF0YSwgc2NoZW1hLCBkYXRhUG9pbnRlclBhdGgpIHsKCWlmICh0eXBlb2YgZGF0YSAhPT0gIm9iamVjdCIgfHwgZGF0YSA9PT0gbnVsbCB8fCBBcnJheS5pc0FycmF5KGRhdGEpKSB7CgkJcmV0dXJuIG51bGw7Cgl9CglyZXR1cm4gdGhpcy52YWxpZGF0ZU9iamVjdE1pbk1heFByb3BlcnRpZXMoZGF0YSwgc2NoZW1hLCBkYXRhUG9pbnRlclBhdGgpCgkJfHwgdGhpcy52YWxpZGF0ZU9iamVjdFJlcXVpcmVkUHJvcGVydGllcyhkYXRhLCBzY2hlbWEsIGRhdGFQb2ludGVyUGF0aCkKCQl8fCB0aGlzLnZhbGlkYXRlT2JqZWN0UHJvcGVydGllcyhkYXRhLCBzY2hlbWEsIGRhdGFQb2ludGVyUGF0aCkKCQl8fCB0aGlzLnZhbGlkYXRlT2JqZWN0RGVwZW5kZW5jaWVzKGRhdGEsIHNjaGVtYSwgZGF0YVBvaW50ZXJQYXRoKQoJCXx8IG51bGw7Cn07CgpWYWxpZGF0b3JDb250ZXh0LnByb3RvdHlwZS52YWxpZGF0ZU9iamVjdE1pbk1heFByb3BlcnRpZXMgPSBmdW5jdGlvbiB2YWxpZGF0ZU9iamVjdE1pbk1heFByb3BlcnRpZXMoZGF0YSwgc2NoZW1hKSB7Cgl2YXIga2V5cyA9IE9iamVjdC5rZXlzKGRhdGEpOwoJdmFyIGVycm9yOwoJaWYgKHNjaGVtYS5taW5Qcm9wZXJ0aWVzICE9PSB1bmRlZmluZWQpIHsKCQlpZiAoa2V5cy5sZW5ndGggPCBzY2hlbWEubWluUHJvcGVydGllcykgewoJCQllcnJvciA9IHRoaXMuY3JlYXRlRXJyb3IoRXJyb3JDb2Rlcy5PQkpFQ1RfUFJPUEVSVElFU19NSU5JTVVNLCB7cHJvcGVydHlDb3VudDoga2V5cy5sZW5ndGgsIG1pbmltdW06IHNjaGVtYS5taW5Qcm9wZXJ0aWVzfSwgJycsICcvbWluUHJvcGVydGllcycsIG51bGwsIGRhdGEsIHNjaGVtYSk7CgkJCWlmICh0aGlzLmhhbmRsZUVycm9yKGVycm9yKSkgewoJCQkJcmV0dXJuIGVycm9yOwoJCQl9CgkJfQoJfQoJaWYgKHNjaGVtYS5tYXhQcm9wZXJ0aWVzICE9PSB1bmRlZmluZWQpIHsKCQlpZiAoa2V5cy5sZW5ndGggPiBzY2hlbWEubWF4UHJvcGVydGllcykgewoJCQllcnJvciA9IHRoaXMuY3JlYXRlRXJyb3IoRXJyb3JDb2Rlcy5PQkpFQ1RfUFJPUEVSVElFU19NQVhJTVVNLCB7cHJvcGVydHlDb3VudDoga2V5cy5sZW5ndGgsIG1heGltdW06IHNjaGVtYS5tYXhQcm9wZXJ0aWVzfSwgJycsICcvbWF4UHJvcGVydGllcycsIG51bGwsIGRhdGEsIHNjaGVtYSk7CgkJCWlmICh0aGlzLmhhbmRsZUVycm9yKGVycm9yKSkgewoJCQkJcmV0dXJuIGVycm9yOwoJCQl9CgkJfQoJfQoJcmV0dXJuIG51bGw7Cn07CgpWYWxpZGF0b3JDb250ZXh0LnByb3RvdHlwZS52YWxpZGF0ZU9iamVjdFJlcXVpcmVkUHJvcGVydGllcyA9IGZ1bmN0aW9uIHZhbGlkYXRlT2JqZWN0UmVxdWlyZWRQcm9wZXJ0aWVzKGRhdGEsIHNjaGVtYSkgewoJaWYgKHNjaGVtYS5yZXF1aXJlZCAhPT0gdW5kZWZpbmVkKSB7CgkJZm9yICh2YXIgaSA9IDA7IGkgPCBzY2hlbWEucmVxdWlyZWQubGVuZ3RoOyBpKyspIHsKCQkJdmFyIGtleSA9IHNjaGVtYS5yZXF1aXJlZFtpXTsKCQkJaWYgKGRhdGFba2V5XSA9PT0gdW5kZWZpbmVkKSB7CgkJCQl2YXIgZXJyb3IgPSB0aGlzLmNyZWF0ZUVycm9yKEVycm9yQ29kZXMuT0JKRUNUX1JFUVVJUkVELCB7a2V5OiBrZXl9LCAnJywgJy9yZXF1aXJlZC8nICsgaSwgbnVsbCwgZGF0YSwgc2NoZW1hKTsKCQkJCWlmICh0aGlzLmhhbmRsZUVycm9yKGVycm9yKSkgewoJCQkJCXJldHVybiBlcnJvcjsKCQkJCX0KCQkJfQoJCX0KCX0KCXJldHVybiBudWxsOwp9OwoKVmFsaWRhdG9yQ29udGV4dC5wcm90b3R5cGUudmFsaWRhdGVPYmplY3RQcm9wZXJ0aWVzID0gZnVuY3Rpb24gdmFsaWRhdGVPYmplY3RQcm9wZXJ0aWVzKGRhdGEsIHNjaGVtYSwgZGF0YVBvaW50ZXJQYXRoKSB7Cgl2YXIgZXJyb3I7Cglmb3IgKHZhciBrZXkgaW4gZGF0YSkgewoJCXZhciBrZXlQb2ludGVyUGF0aCA9IGRhdGFQb2ludGVyUGF0aCArICIvIiArIGtleS5yZXBsYWNlKC9+L2csICd+MCcpLnJlcGxhY2UoL1wvL2csICd+MScpOwoJCXZhciBmb3VuZE1hdGNoID0gZmFsc2U7CgkJaWYgKHNjaGVtYS5wcm9wZXJ0aWVzICE9PSB1bmRlZmluZWQgJiYgc2NoZW1hLnByb3BlcnRpZXNba2V5XSAhPT0gdW5kZWZpbmVkKSB7CgkJCWZvdW5kTWF0Y2ggPSB0cnVlOwoJCQlpZiAoZXJyb3IgPSB0aGlzLnZhbGlkYXRlQWxsKGRhdGFba2V5XSwgc2NoZW1hLnByb3BlcnRpZXNba2V5XSwgW2tleV0sIFsicHJvcGVydGllcyIsIGtleV0sIGtleVBvaW50ZXJQYXRoKSkgewoJCQkJcmV0dXJuIGVycm9yOwoJCQl9CgkJfQoJCWlmIChzY2hlbWEucGF0dGVyblByb3BlcnRpZXMgIT09IHVuZGVmaW5lZCkgewoJCQlmb3IgKHZhciBwYXR0ZXJuS2V5IGluIHNjaGVtYS5wYXR0ZXJuUHJvcGVydGllcykgewoJCQkJdmFyIHJlZ2V4cCA9IG5ldyBSZWdFeHAocGF0dGVybktleSk7CgkJCQlpZiAocmVnZXhwLnRlc3Qoa2V5KSkgewoJCQkJCWZvdW5kTWF0Y2ggPSB0cnVlOwoJCQkJCWlmIChlcnJvciA9IHRoaXMudmFsaWRhdGVBbGwoZGF0YVtrZXldLCBzY2hlbWEucGF0dGVyblByb3BlcnRpZXNbcGF0dGVybktleV0sIFtrZXldLCBbInBhdHRlcm5Qcm9wZXJ0aWVzIiwgcGF0dGVybktleV0sIGtleVBvaW50ZXJQYXRoKSkgewoJCQkJCQlyZXR1cm4gZXJyb3I7CgkJCQkJfQoJCQkJfQoJCQl9CgkJfQoJCWlmICghZm91bmRNYXRjaCkgewoJCQlpZiAoc2NoZW1hLmFkZGl0aW9uYWxQcm9wZXJ0aWVzICE9PSB1bmRlZmluZWQpIHsKCQkJCWlmICh0aGlzLnRyYWNrVW5rbm93blByb3BlcnRpZXMpIHsKCQkJCQl0aGlzLmtub3duUHJvcGVydHlQYXRoc1trZXlQb2ludGVyUGF0aF0gPSB0cnVlOwoJCQkJCWRlbGV0ZSB0aGlzLnVua25vd25Qcm9wZXJ0eVBhdGhzW2tleVBvaW50ZXJQYXRoXTsKCQkJCX0KCQkJCWlmICh0eXBlb2Ygc2NoZW1hLmFkZGl0aW9uYWxQcm9wZXJ0aWVzID09PSAiYm9vbGVhbiIpIHsKCQkJCQlpZiAoIXNjaGVtYS5hZGRpdGlvbmFsUHJvcGVydGllcykgewoJCQkJCQllcnJvciA9IHRoaXMuY3JlYXRlRXJyb3IoRXJyb3JDb2Rlcy5PQkpFQ1RfQURESVRJT05BTF9QUk9QRVJUSUVTLCB7a2V5OiBrZXl9LCAnJywgJy9hZGRpdGlvbmFsUHJvcGVydGllcycsIG51bGwsIGRhdGEsIHNjaGVtYSkucHJlZml4V2l0aChrZXksIG51bGwpOwoJCQkJCQlpZiAodGhpcy5oYW5kbGVFcnJvcihlcnJvcikpIHsKCQkJCQkJCXJldHVybiBlcnJvcjsKCQkJCQkJfQoJCQkJCX0KCQkJCX0gZWxzZSB7CgkJCQkJaWYgKGVycm9yID0gdGhpcy52YWxpZGF0ZUFsbChkYXRhW2tleV0sIHNjaGVtYS5hZGRpdGlvbmFsUHJvcGVydGllcywgW2tleV0sIFsiYWRkaXRpb25hbFByb3BlcnRpZXMiXSwga2V5UG9pbnRlclBhdGgpKSB7CgkJCQkJCXJldHVybiBlcnJvcjsKCQkJCQl9CgkJCQl9CgkJCX0gZWxzZSBpZiAodGhpcy50cmFja1Vua25vd25Qcm9wZXJ0aWVzICYmICF0aGlzLmtub3duUHJvcGVydHlQYXRoc1trZXlQb2ludGVyUGF0aF0pIHsKCQkJCXRoaXMudW5rbm93blByb3BlcnR5UGF0aHNba2V5UG9pbnRlclBhdGhdID0gdHJ1ZTsKCQkJfQoJCX0gZWxzZSBpZiAodGhpcy50cmFja1Vua25vd25Qcm9wZXJ0aWVzKSB7CgkJCXRoaXMua25vd25Qcm9wZXJ0eVBhdGhzW2tleVBvaW50ZXJQYXRoXSA9IHRydWU7CgkJCWRlbGV0ZSB0aGlzLnVua25vd25Qcm9wZXJ0eVBhdGhzW2tleVBvaW50ZXJQYXRoXTsKCQl9Cgl9CglyZXR1cm4gbnVsbDsKfTsKClZhbGlkYXRvckNvbnRleHQucHJvdG90eXBlLnZhbGlkYXRlT2JqZWN0RGVwZW5kZW5jaWVzID0gZnVuY3Rpb24gdmFsaWRhdGVPYmplY3REZXBlbmRlbmNpZXMoZGF0YSwgc2NoZW1hLCBkYXRhUG9pbnRlclBhdGgpIHsKCXZhciBlcnJvcjsKCWlmIChzY2hlbWEuZGVwZW5kZW5jaWVzICE9PSB1bmRlZmluZWQpIHsKCQlmb3IgKHZhciBkZXBLZXkgaW4gc2NoZW1hLmRlcGVuZGVuY2llcykgewoJCQlpZiAoZGF0YVtkZXBLZXldICE9PSB1bmRlZmluZWQpIHsKCQkJCXZhciBkZXAgPSBzY2hlbWEuZGVwZW5kZW5jaWVzW2RlcEtleV07CgkJCQlpZiAodHlwZW9mIGRlcCA9PT0gInN0cmluZyIpIHsKCQkJCQlpZiAoZGF0YVtkZXBdID09PSB1bmRlZmluZWQpIHsKCQkJCQkJZXJyb3IgPSB0aGlzLmNyZWF0ZUVycm9yKEVycm9yQ29kZXMuT0JKRUNUX0RFUEVOREVOQ1lfS0VZLCB7a2V5OiBkZXBLZXksIG1pc3Npbmc6IGRlcH0sICcnLCAnJywgbnVsbCwgZGF0YSwgc2NoZW1hKS5wcmVmaXhXaXRoKG51bGwsIGRlcEtleSkucHJlZml4V2l0aChudWxsLCAiZGVwZW5kZW5jaWVzIik7CgkJCQkJCWlmICh0aGlzLmhhbmRsZUVycm9yKGVycm9yKSkgewoJCQkJCQkJcmV0dXJuIGVycm9yOwoJCQkJCQl9CgkJCQkJfQoJCQkJfSBlbHNlIGlmIChBcnJheS5pc0FycmF5KGRlcCkpIHsKCQkJCQlmb3IgKHZhciBpID0gMDsgaSA8IGRlcC5sZW5ndGg7IGkrKykgewoJCQkJCQl2YXIgcmVxdWlyZWRLZXkgPSBkZXBbaV07CgkJCQkJCWlmIChkYXRhW3JlcXVpcmVkS2V5XSA9PT0gdW5kZWZpbmVkKSB7CgkJCQkJCQllcnJvciA9IHRoaXMuY3JlYXRlRXJyb3IoRXJyb3JDb2Rlcy5PQkpFQ1RfREVQRU5ERU5DWV9LRVksIHtrZXk6IGRlcEtleSwgbWlzc2luZzogcmVxdWlyZWRLZXl9LCAnJywgJy8nICsgaSwgbnVsbCwgZGF0YSwgc2NoZW1hKS5wcmVmaXhXaXRoKG51bGwsIGRlcEtleSkucHJlZml4V2l0aChudWxsLCAiZGVwZW5kZW5jaWVzIik7CgkJCQkJCQlpZiAodGhpcy5oYW5kbGVFcnJvcihlcnJvcikpIHsKCQkJCQkJCQlyZXR1cm4gZXJyb3I7CgkJCQkJCQl9CgkJCQkJCX0KCQkJCQl9CgkJCQl9IGVsc2UgewoJCQkJCWlmIChlcnJvciA9IHRoaXMudmFsaWRhdGVBbGwoZGF0YSwgZGVwLCBbXSwgWyJkZXBlbmRlbmNpZXMiLCBkZXBLZXldLCBkYXRhUG9pbnRlclBhdGgpKSB7CgkJCQkJCXJldHVybiBlcnJvcjsKCQkJCQl9CgkJCQl9CgkJCX0KCQl9Cgl9CglyZXR1cm4gbnVsbDsKfTsKClZhbGlkYXRvckNvbnRleHQucHJvdG90eXBlLnZhbGlkYXRlQ29tYmluYXRpb25zID0gZnVuY3Rpb24gdmFsaWRhdGVDb21iaW5hdGlvbnMoZGF0YSwgc2NoZW1hLCBkYXRhUG9pbnRlclBhdGgpIHsKCXJldHVybiB0aGlzLnZhbGlkYXRlQWxsT2YoZGF0YSwgc2NoZW1hLCBkYXRhUG9pbnRlclBhdGgpCgkJfHwgdGhpcy52YWxpZGF0ZUFueU9mKGRhdGEsIHNjaGVtYSwgZGF0YVBvaW50ZXJQYXRoKQoJCXx8IHRoaXMudmFsaWRhdGVPbmVPZihkYXRhLCBzY2hlbWEsIGRhdGFQb2ludGVyUGF0aCkKCQl8fCB0aGlzLnZhbGlkYXRlTm90KGRhdGEsIHNjaGVtYSwgZGF0YVBvaW50ZXJQYXRoKQoJCXx8IG51bGw7Cn07CgpWYWxpZGF0b3JDb250ZXh0LnByb3RvdHlwZS52YWxpZGF0ZUFsbE9mID0gZnVuY3Rpb24gdmFsaWRhdGVBbGxPZihkYXRhLCBzY2hlbWEsIGRhdGFQb2ludGVyUGF0aCkgewoJaWYgKHNjaGVtYS5hbGxPZiA9PT0gdW5kZWZpbmVkKSB7CgkJcmV0dXJuIG51bGw7Cgl9Cgl2YXIgZXJyb3I7Cglmb3IgKHZhciBpID0gMDsgaSA8IHNjaGVtYS5hbGxPZi5sZW5ndGg7IGkrKykgewoJCXZhciBzdWJTY2hlbWEgPSBzY2hlbWEuYWxsT2ZbaV07CgkJaWYgKGVycm9yID0gdGhpcy52YWxpZGF0ZUFsbChkYXRhLCBzdWJTY2hlbWEsIFtdLCBbImFsbE9mIiwgaV0sIGRhdGFQb2ludGVyUGF0aCkpIHsKCQkJcmV0dXJuIGVycm9yOwoJCX0KCX0KCXJldHVybiBudWxsOwp9OwoKVmFsaWRhdG9yQ29udGV4dC5wcm90b3R5cGUudmFsaWRhdGVBbnlPZiA9IGZ1bmN0aW9uIHZhbGlkYXRlQW55T2YoZGF0YSwgc2NoZW1hLCBkYXRhUG9pbnRlclBhdGgpIHsKCWlmIChzY2hlbWEuYW55T2YgPT09IHVuZGVmaW5lZCkgewoJCXJldHVybiBudWxsOwoJfQoJdmFyIGVycm9ycyA9IFtdOwoJdmFyIHN0YXJ0RXJyb3JDb3VudCA9IHRoaXMuZXJyb3JzLmxlbmd0aDsKCXZhciBvbGRVbmtub3duUHJvcGVydHlQYXRocywgb2xkS25vd25Qcm9wZXJ0eVBhdGhzOwoJaWYgKHRoaXMudHJhY2tVbmtub3duUHJvcGVydGllcykgewoJCW9sZFVua25vd25Qcm9wZXJ0eVBhdGhzID0gdGhpcy51bmtub3duUHJvcGVydHlQYXRoczsKCQlvbGRLbm93blByb3BlcnR5UGF0aHMgPSB0aGlzLmtub3duUHJvcGVydHlQYXRoczsKCX0KCXZhciBlcnJvckF0RW5kID0gdHJ1ZTsKCWZvciAodmFyIGkgPSAwOyBpIDwgc2NoZW1hLmFueU9mLmxlbmd0aDsgaSsrKSB7CgkJaWYgKHRoaXMudHJhY2tVbmtub3duUHJvcGVydGllcykgewoJCQl0aGlzLnVua25vd25Qcm9wZXJ0eVBhdGhzID0ge307CgkJCXRoaXMua25vd25Qcm9wZXJ0eVBhdGhzID0ge307CgkJfQoJCXZhciBzdWJTY2hlbWEgPSBzY2hlbWEuYW55T2ZbaV07CgoJCXZhciBlcnJvckNvdW50ID0gdGhpcy5lcnJvcnMubGVuZ3RoOwoJCXZhciBlcnJvciA9IHRoaXMudmFsaWRhdGVBbGwoZGF0YSwgc3ViU2NoZW1hLCBbXSwgWyJhbnlPZiIsIGldLCBkYXRhUG9pbnRlclBhdGgpOwoKCQlpZiAoZXJyb3IgPT09IG51bGwgJiYgZXJyb3JDb3VudCA9PT0gdGhpcy5lcnJvcnMubGVuZ3RoKSB7CgkJCXRoaXMuZXJyb3JzID0gdGhpcy5lcnJvcnMuc2xpY2UoMCwgc3RhcnRFcnJvckNvdW50KTsKCgkJCWlmICh0aGlzLnRyYWNrVW5rbm93blByb3BlcnRpZXMpIHsKCQkJCWZvciAodmFyIGtub3duS2V5IGluIHRoaXMua25vd25Qcm9wZXJ0eVBhdGhzKSB7CgkJCQkJb2xkS25vd25Qcm9wZXJ0eVBhdGhzW2tub3duS2V5XSA9IHRydWU7CgkJCQkJZGVsZXRlIG9sZFVua25vd25Qcm9wZXJ0eVBhdGhzW2tub3duS2V5XTsKCQkJCX0KCQkJCWZvciAodmFyIHVua25vd25LZXkgaW4gdGhpcy51bmtub3duUHJvcGVydHlQYXRocykgewoJCQkJCWlmICghb2xkS25vd25Qcm9wZXJ0eVBhdGhzW3Vua25vd25LZXldKSB7CgkJCQkJCW9sZFVua25vd25Qcm9wZXJ0eVBhdGhzW3Vua25vd25LZXldID0gdHJ1ZTsKCQkJCQl9CgkJCQl9CgkJCQkvLyBXZSBuZWVkIHRvIGNvbnRpbnVlIGxvb3Bpbmcgc28gd2UgY2F0Y2ggYWxsIHRoZSBwcm9wZXJ0eSBkZWZpbml0aW9ucywgYnV0IHdlIGRvbid0IHdhbnQgdG8gcmV0dXJuIGFuIGVycm9yCgkJCQllcnJvckF0RW5kID0gZmFsc2U7CgkJCQljb250aW51ZTsKCQkJfQoKCQkJcmV0dXJuIG51bGw7CgkJfQoJCWlmIChlcnJvcikgewoJCQllcnJvcnMucHVzaChlcnJvci5wcmVmaXhXaXRoKG51bGwsICIiICsgaSkucHJlZml4V2l0aChudWxsLCAiYW55T2YiKSk7CgkJfQoJfQoJaWYgKHRoaXMudHJhY2tVbmtub3duUHJvcGVydGllcykgewoJCXRoaXMudW5rbm93blByb3BlcnR5UGF0aHMgPSBvbGRVbmtub3duUHJvcGVydHlQYXRoczsKCQl0aGlzLmtub3duUHJvcGVydHlQYXRocyA9IG9sZEtub3duUHJvcGVydHlQYXRoczsKCX0KCWlmIChlcnJvckF0RW5kKSB7CgkJZXJyb3JzID0gZXJyb3JzLmNvbmNhdCh0aGlzLmVycm9ycy5zbGljZShzdGFydEVycm9yQ291bnQpKTsKCQl0aGlzLmVycm9ycyA9IHRoaXMuZXJyb3JzLnNsaWNlKDAsIHN0YXJ0RXJyb3JDb3VudCk7CgkJcmV0dXJuIHRoaXMuY3JlYXRlRXJyb3IoRXJyb3JDb2Rlcy5BTllfT0ZfTUlTU0lORywge30sICIiLCAiL2FueU9mIiwgZXJyb3JzLCBkYXRhLCBzY2hlbWEpOwoJfQp9OwoKVmFsaWRhdG9yQ29udGV4dC5wcm90b3R5cGUudmFsaWRhdGVPbmVPZiA9IGZ1bmN0aW9uIHZhbGlkYXRlT25lT2YoZGF0YSwgc2NoZW1hLCBkYXRhUG9pbnRlclBhdGgpIHsKCWlmIChzY2hlbWEub25lT2YgPT09IHVuZGVmaW5lZCkgewoJCXJldHVybiBudWxsOwoJfQoJdmFyIHZhbGlkSW5kZXggPSBudWxsOwoJdmFyIGVycm9ycyA9IFtdOwoJdmFyIHN0YXJ0RXJyb3JDb3VudCA9IHRoaXMuZXJyb3JzLmxlbmd0aDsKCXZhciBvbGRVbmtub3duUHJvcGVydHlQYXRocywgb2xkS25vd25Qcm9wZXJ0eVBhdGhzOwoJaWYgKHRoaXMudHJhY2tVbmtub3duUHJvcGVydGllcykgewoJCW9sZFVua25vd25Qcm9wZXJ0eVBhdGhzID0gdGhpcy51bmtub3duUHJvcGVydHlQYXRoczsKCQlvbGRLbm93blByb3BlcnR5UGF0aHMgPSB0aGlzLmtub3duUHJvcGVydHlQYXRoczsKCX0KCWZvciAodmFyIGkgPSAwOyBpIDwgc2NoZW1hLm9uZU9mLmxlbmd0aDsgaSsrKSB7CgkJaWYgKHRoaXMudHJhY2tVbmtub3duUHJvcGVydGllcykgewoJCQl0aGlzLnVua25vd25Qcm9wZXJ0eVBhdGhzID0ge307CgkJCXRoaXMua25vd25Qcm9wZXJ0eVBhdGhzID0ge307CgkJfQoJCXZhciBzdWJTY2hlbWEgPSBzY2hlbWEub25lT2ZbaV07CgoJCXZhciBlcnJvckNvdW50ID0gdGhpcy5lcnJvcnMubGVuZ3RoOwoJCXZhciBlcnJvciA9IHRoaXMudmFsaWRhdGVBbGwoZGF0YSwgc3ViU2NoZW1hLCBbXSwgWyJvbmVPZiIsIGldLCBkYXRhUG9pbnRlclBhdGgpOwoKCQlpZiAoZXJyb3IgPT09IG51bGwgJiYgZXJyb3JDb3VudCA9PT0gdGhpcy5lcnJvcnMubGVuZ3RoKSB7CgkJCWlmICh2YWxpZEluZGV4ID09PSBudWxsKSB7CgkJCQl2YWxpZEluZGV4ID0gaTsKCQkJfSBlbHNlIHsKCQkJCXRoaXMuZXJyb3JzID0gdGhpcy5lcnJvcnMuc2xpY2UoMCwgc3RhcnRFcnJvckNvdW50KTsKCQkJCXJldHVybiB0aGlzLmNyZWF0ZUVycm9yKEVycm9yQ29kZXMuT05FX09GX01VTFRJUExFLCB7aW5kZXgxOiB2YWxpZEluZGV4LCBpbmRleDI6IGl9LCAiIiwgIi9vbmVPZiIsIG51bGwsIGRhdGEsIHNjaGVtYSk7CgkJCX0KCQkJaWYgKHRoaXMudHJhY2tVbmtub3duUHJvcGVydGllcykgewoJCQkJZm9yICh2YXIga25vd25LZXkgaW4gdGhpcy5rbm93blByb3BlcnR5UGF0aHMpIHsKCQkJCQlvbGRLbm93blByb3BlcnR5UGF0aHNba25vd25LZXldID0gdHJ1ZTsKCQkJCQlkZWxldGUgb2xkVW5rbm93blByb3BlcnR5UGF0aHNba25vd25LZXldOwoJCQkJfQoJCQkJZm9yICh2YXIgdW5rbm93bktleSBpbiB0aGlzLnVua25vd25Qcm9wZXJ0eVBhdGhzKSB7CgkJCQkJaWYgKCFvbGRLbm93blByb3BlcnR5UGF0aHNbdW5rbm93bktleV0pIHsKCQkJCQkJb2xkVW5rbm93blByb3BlcnR5UGF0aHNbdW5rbm93bktleV0gPSB0cnVlOwoJCQkJCX0KCQkJCX0KCQkJfQoJCX0gZWxzZSBpZiAoZXJyb3IpIHsKCQkJZXJyb3JzLnB1c2goZXJyb3IpOwoJCX0KCX0KCWlmICh0aGlzLnRyYWNrVW5rbm93blByb3BlcnRpZXMpIHsKCQl0aGlzLnVua25vd25Qcm9wZXJ0eVBhdGhzID0gb2xkVW5rbm93blByb3BlcnR5UGF0aHM7CgkJdGhpcy5rbm93blByb3BlcnR5UGF0aHMgPSBvbGRLbm93blByb3BlcnR5UGF0aHM7Cgl9CglpZiAodmFsaWRJbmRleCA9PT0gbnVsbCkgewoJCWVycm9ycyA9IGVycm9ycy5jb25jYXQodGhpcy5lcnJvcnMuc2xpY2Uoc3RhcnRFcnJvckNvdW50KSk7CgkJdGhpcy5lcnJvcnMgPSB0aGlzLmVycm9ycy5zbGljZSgwLCBzdGFydEVycm9yQ291bnQpOwoJCXJldHVybiB0aGlzLmNyZWF0ZUVycm9yKEVycm9yQ29kZXMuT05FX09GX01JU1NJTkcsIHt9LCAiIiwgIi9vbmVPZiIsIGVycm9ycywgZGF0YSwgc2NoZW1hKTsKCX0gZWxzZSB7CgkJdGhpcy5lcnJvcnMgPSB0aGlzLmVycm9ycy5zbGljZSgwLCBzdGFydEVycm9yQ291bnQpOwoJfQoJcmV0dXJuIG51bGw7Cn07CgpWYWxpZGF0b3JDb250ZXh0LnByb3RvdHlwZS52YWxpZGF0ZU5vdCA9IGZ1bmN0aW9uIHZhbGlkYXRlTm90KGRhdGEsIHNjaGVtYSwgZGF0YVBvaW50ZXJQYXRoKSB7CglpZiAoc2NoZW1hLm5vdCA9PT0gdW5kZWZpbmVkKSB7CgkJcmV0dXJuIG51bGw7Cgl9Cgl2YXIgb2xkRXJyb3JDb3VudCA9IHRoaXMuZXJyb3JzLmxlbmd0aDsKCXZhciBvbGRVbmtub3duUHJvcGVydHlQYXRocywgb2xkS25vd25Qcm9wZXJ0eVBhdGhzOwoJaWYgKHRoaXMudHJhY2tVbmtub3duUHJvcGVydGllcykgewoJCW9sZFVua25vd25Qcm9wZXJ0eVBhdGhzID0gdGhpcy51bmtub3duUHJvcGVydHlQYXRoczsKCQlvbGRLbm93blByb3BlcnR5UGF0aHMgPSB0aGlzLmtub3duUHJvcGVydHlQYXRoczsKCQl0aGlzLnVua25vd25Qcm9wZXJ0eVBhdGhzID0ge307CgkJdGhpcy5rbm93blByb3BlcnR5UGF0aHMgPSB7fTsKCX0KCXZhciBlcnJvciA9IHRoaXMudmFsaWRhdGVBbGwoZGF0YSwgc2NoZW1hLm5vdCwgbnVsbCwgbnVsbCwgZGF0YVBvaW50ZXJQYXRoKTsKCXZhciBub3RFcnJvcnMgPSB0aGlzLmVycm9ycy5zbGljZShvbGRFcnJvckNvdW50KTsKCXRoaXMuZXJyb3JzID0gdGhpcy5lcnJvcnMuc2xpY2UoMCwgb2xkRXJyb3JDb3VudCk7CglpZiAodGhpcy50cmFja1Vua25vd25Qcm9wZXJ0aWVzKSB7CgkJdGhpcy51bmtub3duUHJvcGVydHlQYXRocyA9IG9sZFVua25vd25Qcm9wZXJ0eVBhdGhzOwoJCXRoaXMua25vd25Qcm9wZXJ0eVBhdGhzID0gb2xkS25vd25Qcm9wZXJ0eVBhdGhzOwoJfQoJaWYgKGVycm9yID09PSBudWxsICYmIG5vdEVycm9ycy5sZW5ndGggPT09IDApIHsKCQlyZXR1cm4gdGhpcy5jcmVhdGVFcnJvcihFcnJvckNvZGVzLk5PVF9QQVNTRUQsIHt9LCAiIiwgIi9ub3QiLCBudWxsLCBkYXRhLCBzY2hlbWEpOwoJfQoJcmV0dXJuIG51bGw7Cn07CgpWYWxpZGF0b3JDb250ZXh0LnByb3RvdHlwZS52YWxpZGF0ZUh5cGVybWVkaWEgPSBmdW5jdGlvbiB2YWxpZGF0ZUNvbWJpbmF0aW9ucyhkYXRhLCBzY2hlbWEsIGRhdGFQb2ludGVyUGF0aCkgewoJaWYgKCFzY2hlbWEubGlua3MpIHsKCQlyZXR1cm4gbnVsbDsKCX0KCXZhciBlcnJvcjsKCWZvciAodmFyIGkgPSAwOyBpIDwgc2NoZW1hLmxpbmtzLmxlbmd0aDsgaSsrKSB7CgkJdmFyIGxkbyA9IHNjaGVtYS5saW5rc1tpXTsKCQlpZiAobGRvLnJlbCA9PT0gImRlc2NyaWJlZGJ5IikgewoJCQl2YXIgdGVtcGxhdGUgPSBuZXcgVXJpVGVtcGxhdGUobGRvLmhyZWYpOwoJCQl2YXIgYWxsUHJlc2VudCA9IHRydWU7CgkJCWZvciAodmFyIGogPSAwOyBqIDwgdGVtcGxhdGUudmFyTmFtZXMubGVuZ3RoOyBqKyspIHsKCQkJCWlmICghKHRlbXBsYXRlLnZhck5hbWVzW2pdIGluIGRhdGEpKSB7CgkJCQkJYWxsUHJlc2VudCA9IGZhbHNlOwoJCQkJCWJyZWFrOwoJCQkJfQoJCQl9CgkJCWlmIChhbGxQcmVzZW50KSB7CgkJCQl2YXIgc2NoZW1hVXJsID0gdGVtcGxhdGUuZmlsbEZyb21PYmplY3QoZGF0YSk7CgkJCQl2YXIgc3ViU2NoZW1hID0geyIkcmVmIjogc2NoZW1hVXJsfTsKCQkJCWlmIChlcnJvciA9IHRoaXMudmFsaWRhdGVBbGwoZGF0YSwgc3ViU2NoZW1hLCBbXSwgWyJsaW5rcyIsIGldLCBkYXRhUG9pbnRlclBhdGgpKSB7CgkJCQkJcmV0dXJuIGVycm9yOwoJCQkJfQoJCQl9CgkJfQoJfQp9OwoKLy8gcGFyc2VVUkkoKSBhbmQgcmVzb2x2ZVVybCgpIGFyZSBmcm9tIGh0dHBzOi8vZ2lzdC5naXRodWIuY29tLzEwODg4NTAKLy8gICAtICByZWxlYXNlZCBhcyBwdWJsaWMgZG9tYWluIGJ5IGF1dGhvciAoIllhZmZsZSIpIC0gc2VlIGNvbW1lbnRzIG9uIGdpc3QKCmZ1bmN0aW9uIHBhcnNlVVJJKHVybCkgewoJdmFyIG0gPSBTdHJpbmcodXJsKS5yZXBsYWNlKC9eXHMrfFxzKyQvZywgJycpLm1hdGNoKC9eKFteOlwvPyNdKzopPyhcL1wvKD86W146QF0qKD86OlteOkBdKik/QCk/KChbXjpcLz8jXSopKD86OihcZCopKT8pKT8oW14/I10qKShcP1teI10qKT8oI1tcc1xTXSopPy8pOwoJLy8gYXV0aG9yaXR5ID0gJy8vJyArIHVzZXIgKyAnOicgKyBwYXNzICdAJyArIGhvc3RuYW1lICsgJzonIHBvcnQKCXJldHVybiAobSA/IHsKCQlocmVmICAgICA6IG1bMF0gfHwgJycsCgkJcHJvdG9jb2wgOiBtWzFdIHx8ICcnLAoJCWF1dGhvcml0eTogbVsyXSB8fCAnJywKCQlob3N0ICAgICA6IG1bM10gfHwgJycsCgkJaG9zdG5hbWUgOiBtWzRdIHx8ICcnLAoJCXBvcnQgICAgIDogbVs1XSB8fCAnJywKCQlwYXRobmFtZSA6IG1bNl0gfHwgJycsCgkJc2VhcmNoICAgOiBtWzddIHx8ICcnLAoJCWhhc2ggICAgIDogbVs4XSB8fCAnJwoJfSA6IG51bGwpOwp9CgpmdW5jdGlvbiByZXNvbHZlVXJsKGJhc2UsIGhyZWYpIHsvLyBSRkMgMzk4NgoKCWZ1bmN0aW9uIHJlbW92ZURvdFNlZ21lbnRzKGlucHV0KSB7CgkJdmFyIG91dHB1dCA9IFtdOwoJCWlucHV0LnJlcGxhY2UoL14oXC5cLj8oXC98JCkpKy8sICcnKQoJCQkucmVwbGFjZSgvXC8oXC4oXC98JCkpKy9nLCAnLycpCgkJCS5yZXBsYWNlKC9cL1wuXC4kLywgJy8uLi8nKQoJCQkucmVwbGFjZSgvXC8/W15cL10qL2csIGZ1bmN0aW9uIChwKSB7CgkJCQlpZiAocCA9PT0gJy8uLicpIHsKCQkJCQlvdXRwdXQucG9wKCk7CgkJCQl9IGVsc2UgewoJCQkJCW91dHB1dC5wdXNoKHApOwoJCQkJfQoJCX0pOwoJCXJldHVybiBvdXRwdXQuam9pbignJykucmVwbGFjZSgvXlwvLywgaW5wdXQuY2hhckF0KDApID09PSAnLycgPyAnLycgOiAnJyk7Cgl9CgoJaHJlZiA9IHBhcnNlVVJJKGhyZWYgfHwgJycpOwoJYmFzZSA9IHBhcnNlVVJJKGJhc2UgfHwgJycpOwoKCXJldHVybiAhaHJlZiB8fCAhYmFzZSA/IG51bGwgOiAoaHJlZi5wcm90b2NvbCB8fCBiYXNlLnByb3RvY29sKSArCgkJKGhyZWYucHJvdG9jb2wgfHwgaHJlZi5hdXRob3JpdHkgPyBocmVmLmF1dGhvcml0eSA6IGJhc2UuYXV0aG9yaXR5KSArCgkJcmVtb3ZlRG90U2VnbWVudHMoaHJlZi5wcm90b2NvbCB8fCBocmVmLmF1dGhvcml0eSB8fCBocmVmLnBhdGhuYW1lLmNoYXJBdCgwKSA9PT0gJy8nID8gaHJlZi5wYXRobmFtZSA6IChocmVmLnBhdGhuYW1lID8gKChiYXNlLmF1dGhvcml0eSAmJiAhYmFzZS5wYXRobmFtZSA/ICcvJyA6ICcnKSArIGJhc2UucGF0aG5hbWUuc2xpY2UoMCwgYmFzZS5wYXRobmFtZS5sYXN0SW5kZXhPZignLycpICsgMSkgKyBocmVmLnBhdGhuYW1lKSA6IGJhc2UucGF0aG5hbWUpKSArCgkJKGhyZWYucHJvdG9jb2wgfHwgaHJlZi5hdXRob3JpdHkgfHwgaHJlZi5wYXRobmFtZSA/IGhyZWYuc2VhcmNoIDogKGhyZWYuc2VhcmNoIHx8IGJhc2Uuc2VhcmNoKSkgKwoJCWhyZWYuaGFzaDsKfQoKZnVuY3Rpb24gZ2V0RG9jdW1lbnRVcmkodXJpKSB7CglyZXR1cm4gdXJpLnNwbGl0KCcjJylbMF07Cn0KZnVuY3Rpb24gbm9ybVNjaGVtYShzY2hlbWEsIGJhc2VVcmkpIHsKCWlmIChzY2hlbWEgJiYgdHlwZW9mIHNjaGVtYSA9PT0gIm9iamVjdCIpIHsKCQlpZiAoYmFzZVVyaSA9PT0gdW5kZWZpbmVkKSB7CgkJCWJhc2VVcmkgPSBzY2hlbWEuaWQ7CgkJfSBlbHNlIGlmICh0eXBlb2Ygc2NoZW1hLmlkID09PSAic3RyaW5nIikgewoJCQliYXNlVXJpID0gcmVzb2x2ZVVybChiYXNlVXJpLCBzY2hlbWEuaWQpOwoJCQlzY2hlbWEuaWQgPSBiYXNlVXJpOwoJCX0KCQlpZiAoQXJyYXkuaXNBcnJheShzY2hlbWEpKSB7CgkJCWZvciAodmFyIGkgPSAwOyBpIDwgc2NoZW1hLmxlbmd0aDsgaSsrKSB7CgkJCQlub3JtU2NoZW1hKHNjaGVtYVtpXSwgYmFzZVVyaSk7CgkJCX0KCQl9IGVsc2UgewoJCQlpZiAodHlwZW9mIHNjaGVtYVsnJHJlZiddID09PSAic3RyaW5nIikgewoJCQkJc2NoZW1hWyckcmVmJ10gPSByZXNvbHZlVXJsKGJhc2VVcmksIHNjaGVtYVsnJHJlZiddKTsKCQkJfQoJCQlmb3IgKHZhciBrZXkgaW4gc2NoZW1hKSB7CgkJCQlpZiAoa2V5ICE9PSAiZW51bSIpIHsKCQkJCQlub3JtU2NoZW1hKHNjaGVtYVtrZXldLCBiYXNlVXJpKTsKCQkJCX0KCQkJfQoJCX0KCX0KfQoKZnVuY3Rpb24gZGVmYXVsdEVycm9yUmVwb3J0ZXIobGFuZ3VhZ2UpIHsKCWxhbmd1YWdlID0gbGFuZ3VhZ2UgfHwgJ2VuJzsKCgl2YXIgZXJyb3JNZXNzYWdlcyA9IGxhbmd1YWdlc1tsYW5ndWFnZV07CgoJcmV0dXJuIGZ1bmN0aW9uIChlcnJvcikgewoJCXZhciBtZXNzYWdlVGVtcGxhdGUgPSBlcnJvck1lc3NhZ2VzW2Vycm9yLmNvZGVdIHx8IEVycm9yTWVzc2FnZXNEZWZhdWx0W2Vycm9yLmNvZGVdOwoJCWlmICh0eXBlb2YgbWVzc2FnZVRlbXBsYXRlICE9PSAnc3RyaW5nJykgewoJCQlyZXR1cm4gIlVua25vd24gZXJyb3IgY29kZSAiICsgZXJyb3IuY29kZSArICI6ICIgKyBKU09OLnN0cmluZ2lmeShlcnJvci5tZXNzYWdlUGFyYW1zKTsKCQl9CgkJdmFyIG1lc3NhZ2VQYXJhbXMgPSBlcnJvci5wYXJhbXM7CgkJLy8gQWRhcHRlZCBmcm9tIENyb2NrZm9yZCdzIHN1cHBsYW50KCkKCQlyZXR1cm4gbWVzc2FnZVRlbXBsYXRlLnJlcGxhY2UoL1x7KFtee31dKilcfS9nLCBmdW5jdGlvbiAod2hvbGUsIHZhck5hbWUpIHsKCQkJdmFyIHN1YlZhbHVlID0gbWVzc2FnZVBhcmFtc1t2YXJOYW1lXTsKCQkJcmV0dXJuIHR5cGVvZiBzdWJWYWx1ZSA9PT0gJ3N0cmluZycgfHwgdHlwZW9mIHN1YlZhbHVlID09PSAnbnVtYmVyJyA/IHN1YlZhbHVlIDogd2hvbGU7CgkJfSk7Cgl9Owp9Cgp2YXIgRXJyb3JDb2RlcyA9IHsKCUlOVkFMSURfVFlQRTogMCwKCUVOVU1fTUlTTUFUQ0g6IDEsCglBTllfT0ZfTUlTU0lORzogMTAsCglPTkVfT0ZfTUlTU0lORzogMTEsCglPTkVfT0ZfTVVMVElQTEU6IDEyLAoJTk9UX1BBU1NFRDogMTMsCgkvLyBOdW1lcmljIGVycm9ycwoJTlVNQkVSX01VTFRJUExFX09GOiAxMDAsCglOVU1CRVJfTUlOSU1VTTogMTAxLAoJTlVNQkVSX01JTklNVU1fRVhDTFVTSVZFOiAxMDIsCglOVU1CRVJfTUFYSU1VTTogMTAzLAoJTlVNQkVSX01BWElNVU1fRVhDTFVTSVZFOiAxMDQsCglOVU1CRVJfTk9UX0FfTlVNQkVSOiAxMDUsCgkvLyBTdHJpbmcgZXJyb3JzCglTVFJJTkdfTEVOR1RIX1NIT1JUOiAyMDAsCglTVFJJTkdfTEVOR1RIX0xPTkc6IDIwMSwKCVNUUklOR19QQVRURVJOOiAyMDIsCgkvLyBPYmplY3QgZXJyb3JzCglPQkpFQ1RfUFJPUEVSVElFU19NSU5JTVVNOiAzMDAsCglPQkpFQ1RfUFJPUEVSVElFU19NQVhJTVVNOiAzMDEsCglPQkpFQ1RfUkVRVUlSRUQ6IDMwMiwKCU9CSkVDVF9BRERJVElPTkFMX1BST1BFUlRJRVM6IDMwMywKCU9CSkVDVF9ERVBFTkRFTkNZX0tFWTogMzA0LAoJLy8gQXJyYXkgZXJyb3JzCglBUlJBWV9MRU5HVEhfU0hPUlQ6IDQwMCwKCUFSUkFZX0xFTkdUSF9MT05HOiA0MDEsCglBUlJBWV9VTklRVUU6IDQwMiwKCUFSUkFZX0FERElUSU9OQUxfSVRFTVM6IDQwMywKCS8vIEN1c3RvbS91c2VyLWRlZmluZWQgZXJyb3JzCglGT1JNQVRfQ1VTVE9NOiA1MDAsCglLRVlXT1JEX0NVU1RPTTogNTAxLAoJLy8gU2NoZW1hIHN0cnVjdHVyZQoJQ0lSQ1VMQVJfUkVGRVJFTkNFOiA2MDAsCgkvLyBOb24tc3RhbmRhcmQgdmFsaWRhdGlvbiBvcHRpb25zCglVTktOT1dOX1BST1BFUlRZOiAxMDAwCn07CnZhciBFcnJvckNvZGVMb29rdXAgPSB7fTsKZm9yICh2YXIga2V5IGluIEVycm9yQ29kZXMpIHsKCUVycm9yQ29kZUxvb2t1cFtFcnJvckNvZGVzW2tleV1dID0ga2V5Owp9CnZhciBFcnJvck1lc3NhZ2VzRGVmYXVsdCA9IHsKCUlOVkFMSURfVFlQRTogIkludmFsaWQgdHlwZToge3R5cGV9IChleHBlY3RlZCB7ZXhwZWN0ZWR9KSIsCglFTlVNX01JU01BVENIOiAiTm8gZW51bSBtYXRjaCBmb3I6IHt2YWx1ZX0iLAoJQU5ZX09GX01JU1NJTkc6ICJEYXRhIGRvZXMgbm90IG1hdGNoIGFueSBzY2hlbWFzIGZyb20gXCJhbnlPZlwiIiwKCU9ORV9PRl9NSVNTSU5HOiAiRGF0YSBkb2VzIG5vdCBtYXRjaCBhbnkgc2NoZW1hcyBmcm9tIFwib25lT2ZcIiIsCglPTkVfT0ZfTVVMVElQTEU6ICJEYXRhIGlzIHZhbGlkIGFnYWluc3QgbW9yZSB0aGFuIG9uZSBzY2hlbWEgZnJvbSBcIm9uZU9mXCI6IGluZGljZXMge2luZGV4MX0gYW5kIHtpbmRleDJ9IiwKCU5PVF9QQVNTRUQ6ICJEYXRhIG1hdGNoZXMgc2NoZW1hIGZyb20gXCJub3RcIiIsCgkvLyBOdW1lcmljIGVycm9ycwoJTlVNQkVSX01VTFRJUExFX09GOiAiVmFsdWUge3ZhbHVlfSBpcyBub3QgYSBtdWx0aXBsZSBvZiB7bXVsdGlwbGVPZn0iLAoJTlVNQkVSX01JTklNVU06ICJWYWx1ZSB7dmFsdWV9IGlzIGxlc3MgdGhhbiBtaW5pbXVtIHttaW5pbXVtfSIsCglOVU1CRVJfTUlOSU1VTV9FWENMVVNJVkU6ICJWYWx1ZSB7dmFsdWV9IGlzIGVxdWFsIHRvIGV4Y2x1c2l2ZSBtaW5pbXVtIHttaW5pbXVtfSIsCglOVU1CRVJfTUFYSU1VTTogIlZhbHVlIHt2YWx1ZX0gaXMgZ3JlYXRlciB0aGFuIG1heGltdW0ge21heGltdW19IiwKCU5VTUJFUl9NQVhJTVVNX0VYQ0xVU0lWRTogIlZhbHVlIHt2YWx1ZX0gaXMgZXF1YWwgdG8gZXhjbHVzaXZlIG1heGltdW0ge21heGltdW19IiwKCU5VTUJFUl9OT1RfQV9OVU1CRVI6ICJWYWx1ZSB7dmFsdWV9IGlzIG5vdCBhIHZhbGlkIG51bWJlciIsCgkvLyBTdHJpbmcgZXJyb3JzCglTVFJJTkdfTEVOR1RIX1NIT1JUOiAiU3RyaW5nIGlzIHRvbyBzaG9ydCAoe2xlbmd0aH0gY2hhcnMpLCBtaW5pbXVtIHttaW5pbXVtfSIsCglTVFJJTkdfTEVOR1RIX0xPTkc6ICJTdHJpbmcgaXMgdG9vIGxvbmcgKHtsZW5ndGh9IGNoYXJzKSwgbWF4aW11bSB7bWF4aW11bX0iLAoJU1RSSU5HX1BBVFRFUk46ICJTdHJpbmcgZG9lcyBub3QgbWF0Y2ggcGF0dGVybjoge3BhdHRlcm59IiwKCS8vIE9iamVjdCBlcnJvcnMKCU9CSkVDVF9QUk9QRVJUSUVTX01JTklNVU06ICJUb28gZmV3IHByb3BlcnRpZXMgZGVmaW5lZCAoe3Byb3BlcnR5Q291bnR9KSwgbWluaW11bSB7bWluaW11bX0iLAoJT0JKRUNUX1BST1BFUlRJRVNfTUFYSU1VTTogIlRvbyBtYW55IHByb3BlcnRpZXMgZGVmaW5lZCAoe3Byb3BlcnR5Q291bnR9KSwgbWF4aW11bSB7bWF4aW11bX0iLAoJT0JKRUNUX1JFUVVJUkVEOiAiTWlzc2luZyByZXF1aXJlZCBwcm9wZXJ0eToge2tleX0iLAoJT0JKRUNUX0FERElUSU9OQUxfUFJPUEVSVElFUzogIkFkZGl0aW9uYWwgcHJvcGVydGllcyBub3QgYWxsb3dlZCIsCglPQkpFQ1RfREVQRU5ERU5DWV9LRVk6ICJEZXBlbmRlbmN5IGZhaWxlZCAtIGtleSBtdXN0IGV4aXN0OiB7bWlzc2luZ30gKGR1ZSB0byBrZXk6IHtrZXl9KSIsCgkvLyBBcnJheSBlcnJvcnMKCUFSUkFZX0xFTkdUSF9TSE9SVDogIkFycmF5IGlzIHRvbyBzaG9ydCAoe2xlbmd0aH0pLCBtaW5pbXVtIHttaW5pbXVtfSIsCglBUlJBWV9MRU5HVEhfTE9ORzogIkFycmF5IGlzIHRvbyBsb25nICh7bGVuZ3RofSksIG1heGltdW0ge21heGltdW19IiwKCUFSUkFZX1VOSVFVRTogIkFycmF5IGl0ZW1zIGFyZSBub3QgdW5pcXVlIChpbmRpY2VzIHttYXRjaDF9IGFuZCB7bWF0Y2gyfSkiLAoJQVJSQVlfQURESVRJT05BTF9JVEVNUzogIkFkZGl0aW9uYWwgaXRlbXMgbm90IGFsbG93ZWQiLAoJLy8gRm9ybWF0IGVycm9ycwoJRk9STUFUX0NVU1RPTTogIkZvcm1hdCB2YWxpZGF0aW9uIGZhaWxlZCAoe21lc3NhZ2V9KSIsCglLRVlXT1JEX0NVU1RPTTogIktleXdvcmQgZmFpbGVkOiB7a2V5fSAoe21lc3NhZ2V9KSIsCgkvLyBTY2hlbWEgc3RydWN0dXJlCglDSVJDVUxBUl9SRUZFUkVOQ0U6ICJDaXJjdWxhciAkcmVmczoge3VybHN9IiwKCS8vIE5vbi1zdGFuZGFyZCB2YWxpZGF0aW9uIG9wdGlvbnMKCVVOS05PV05fUFJPUEVSVFk6ICJVbmtub3duIHByb3BlcnR5IChub3QgaW4gc2NoZW1hKSIKfTsKCmZ1bmN0aW9uIFZhbGlkYXRpb25FcnJvcihjb2RlLCBwYXJhbXMsIGRhdGFQYXRoLCBzY2hlbWFQYXRoLCBzdWJFcnJvcnMpIHsKCUVycm9yLmNhbGwodGhpcyk7CglpZiAoY29kZSA9PT0gdW5kZWZpbmVkKSB7CgkJdGhyb3cgbmV3IEVycm9yICgiTm8gZXJyb3IgY29kZSBzdXBwbGllZDogIiArIHNjaGVtYVBhdGgpOwoJfQoJdGhpcy5tZXNzYWdlID0gJyc7Cgl0aGlzLnBhcmFtcyA9IHBhcmFtczsKCXRoaXMuY29kZSA9IGNvZGU7Cgl0aGlzLmRhdGFQYXRoID0gZGF0YVBhdGggfHwgIiI7Cgl0aGlzLnNjaGVtYVBhdGggPSBzY2hlbWFQYXRoIHx8ICIiOwoJdGhpcy5zdWJFcnJvcnMgPSBzdWJFcnJvcnMgfHwgbnVsbDsKCgl2YXIgZXJyID0gbmV3IEVycm9yKHRoaXMubWVzc2FnZSk7Cgl0aGlzLnN0YWNrID0gZXJyLnN0YWNrIHx8IGVyci5zdGFja3RyYWNlOwoJaWYgKCF0aGlzLnN0YWNrKSB7CgkJdHJ5IHsKCQkJdGhyb3cgZXJyOwoJCX0KCQljYXRjaChlcnIpIHsKCQkJdGhpcy5zdGFjayA9IGVyci5zdGFjayB8fCBlcnIuc3RhY2t0cmFjZTsKCQl9Cgl9Cn0KVmFsaWRhdGlvbkVycm9yLnByb3RvdHlwZSA9IE9iamVjdC5jcmVhdGUoRXJyb3IucHJvdG90eXBlKTsKVmFsaWRhdGlvbkVycm9yLnByb3RvdHlwZS5jb25zdHJ1Y3RvciA9IFZhbGlkYXRpb25FcnJvcjsKVmFsaWRhdGlvbkVycm9yLnByb3RvdHlwZS5uYW1lID0gJ1ZhbGlkYXRpb25FcnJvcic7CgpWYWxpZGF0aW9uRXJyb3IucHJvdG90eXBlLnByZWZpeFdpdGggPSBmdW5jdGlvbiAoZGF0YVByZWZpeCwgc2NoZW1hUHJlZml4KSB7CglpZiAoZGF0YVByZWZpeCAhPT0gbnVsbCkgewoJCWRhdGFQcmVmaXggPSBkYXRhUHJlZml4LnJlcGxhY2UoL34vZywgIn4wIikucmVwbGFjZSgvXC8vZywgIn4xIik7CgkJdGhpcy5kYXRhUGF0aCA9ICIvIiArIGRhdGFQcmVmaXggKyB0aGlzLmRhdGFQYXRoOwoJfQoJaWYgKHNjaGVtYVByZWZpeCAhPT0gbnVsbCkgewoJCXNjaGVtYVByZWZpeCA9IHNjaGVtYVByZWZpeC5yZXBsYWNlKC9+L2csICJ+MCIpLnJlcGxhY2UoL1wvL2csICJ+MSIpOwoJCXRoaXMuc2NoZW1hUGF0aCA9ICIvIiArIHNjaGVtYVByZWZpeCArIHRoaXMuc2NoZW1hUGF0aDsKCX0KCWlmICh0aGlzLnN1YkVycm9ycyAhPT0gbnVsbCkgewoJCWZvciAodmFyIGkgPSAwOyBpIDwgdGhpcy5zdWJFcnJvcnMubGVuZ3RoOyBpKyspIHsKCQkJdGhpcy5zdWJFcnJvcnNbaV0ucHJlZml4V2l0aChkYXRhUHJlZml4LCBzY2hlbWFQcmVmaXgpOwoJCX0KCX0KCXJldHVybiB0aGlzOwp9OwoKZnVuY3Rpb24gaXNUcnVzdGVkVXJsKGJhc2VVcmwsIHRlc3RVcmwpIHsKCWlmKHRlc3RVcmwuc3Vic3RyaW5nKDAsIGJhc2VVcmwubGVuZ3RoKSA9PT0gYmFzZVVybCl7CgkJdmFyIHJlbWFpbmRlciA9IHRlc3RVcmwuc3Vic3RyaW5nKGJhc2VVcmwubGVuZ3RoKTsKCQlpZiAoKHRlc3RVcmwubGVuZ3RoID4gMCAmJiB0ZXN0VXJsLmNoYXJBdChiYXNlVXJsLmxlbmd0aCAtIDEpID09PSAiLyIpCgkJCXx8IHJlbWFpbmRlci5jaGFyQXQoMCkgPT09ICIjIgoJCQl8fCByZW1haW5kZXIuY2hhckF0KDApID09PSAiPyIpIHsKCQkJcmV0dXJuIHRydWU7CgkJfQoJfQoJcmV0dXJuIGZhbHNlOwp9Cgp2YXIgbGFuZ3VhZ2VzID0ge307CmZ1bmN0aW9uIGNyZWF0ZUFwaShsYW5ndWFnZSkgewoJdmFyIGdsb2JhbENvbnRleHQgPSBuZXcgVmFsaWRhdG9yQ29udGV4dCgpOwoJdmFyIGN1cnJlbnRMYW5ndWFnZTsKCXZhciBjdXN0b21FcnJvclJlcG9ydGVyOwoJdmFyIGFwaSA9IHsKCQlzZXRFcnJvclJlcG9ydGVyOiBmdW5jdGlvbiAocmVwb3J0ZXIpIHsKCQkJaWYgKHR5cGVvZiByZXBvcnRlciA9PT0gJ3N0cmluZycpIHsKCQkJCXJldHVybiB0aGlzLmxhbmd1YWdlKHJlcG9ydGVyKTsKCQkJfQoJCQljdXN0b21FcnJvclJlcG9ydGVyID0gcmVwb3J0ZXI7CgkJCXJldHVybiB0cnVlOwoJCX0sCgkJYWRkRm9ybWF0OiBmdW5jdGlvbiAoKSB7CgkJCWdsb2JhbENvbnRleHQuYWRkRm9ybWF0LmFwcGx5KGdsb2JhbENvbnRleHQsIGFyZ3VtZW50cyk7CgkJfSwKCQlsYW5ndWFnZTogZnVuY3Rpb24gKGNvZGUpIHsKCQkJaWYgKCFjb2RlKSB7CgkJCQlyZXR1cm4gY3VycmVudExhbmd1YWdlOwoJCQl9CgkJCWlmICghbGFuZ3VhZ2VzW2NvZGVdKSB7CgkJCQljb2RlID0gY29kZS5zcGxpdCgnLScpWzBdOyAvLyBmYWxsIGJhY2sgdG8gYmFzZSBsYW5ndWFnZQoJCQl9CgkJCWlmIChsYW5ndWFnZXNbY29kZV0pIHsKCQkJCWN1cnJlbnRMYW5ndWFnZSA9IGNvZGU7CgkJCQlyZXR1cm4gY29kZTsgLy8gc28geW91IGNhbiB0ZWxsIGlmIGZhbGwtYmFjayBoYXMgaGFwcGVuZWQKCQkJfQoJCQlyZXR1cm4gZmFsc2U7CgkJfSwKCQlhZGRMYW5ndWFnZTogZnVuY3Rpb24gKGNvZGUsIG1lc3NhZ2VNYXApIHsKCQkJdmFyIGtleTsKCQkJZm9yIChrZXkgaW4gRXJyb3JDb2RlcykgewoJCQkJaWYgKG1lc3NhZ2VNYXBba2V5XSAmJiAhbWVzc2FnZU1hcFtFcnJvckNvZGVzW2tleV1dKSB7CgkJCQkJbWVzc2FnZU1hcFtFcnJvckNvZGVzW2tleV1dID0gbWVzc2FnZU1hcFtrZXldOwoJCQkJfQoJCQl9CgkJCXZhciByb290Q29kZSA9IGNvZGUuc3BsaXQoJy0nKVswXTsKCQkJaWYgKCFsYW5ndWFnZXNbcm9vdENvZGVdKSB7IC8vIHVzZSBmb3IgYmFzZSBsYW5ndWFnZSBpZiBub3QgeWV0IGRlZmluZWQKCQkJCWxhbmd1YWdlc1tjb2RlXSA9IG1lc3NhZ2VNYXA7CgkJCQlsYW5ndWFnZXNbcm9vdENvZGVdID0gbWVzc2FnZU1hcDsKCQkJfSBlbHNlIHsKCQkJCWxhbmd1YWdlc1tjb2RlXSA9IE9iamVjdC5jcmVhdGUobGFuZ3VhZ2VzW3Jvb3RDb2RlXSk7CgkJCQlmb3IgKGtleSBpbiBtZXNzYWdlTWFwKSB7CgkJCQkJaWYgKHR5cGVvZiBsYW5ndWFnZXNbcm9vdENvZGVdW2tleV0gPT09ICd1bmRlZmluZWQnKSB7CgkJCQkJCWxhbmd1YWdlc1tyb290Q29kZV1ba2V5XSA9IG1lc3NhZ2VNYXBba2V5XTsKCQkJCQl9CgkJCQkJbGFuZ3VhZ2VzW2NvZGVdW2tleV0gPSBtZXNzYWdlTWFwW2tleV07CgkJCQl9CgkJCX0KCQkJcmV0dXJuIHRoaXM7CgkJfSwKCQlmcmVzaEFwaTogZnVuY3Rpb24gKGxhbmd1YWdlKSB7CgkJCXZhciByZXN1bHQgPSBjcmVhdGVBcGkoKTsKCQkJaWYgKGxhbmd1YWdlKSB7CgkJCQlyZXN1bHQubGFuZ3VhZ2UobGFuZ3VhZ2UpOwoJCQl9CgkJCXJldHVybiByZXN1bHQ7CgkJfSwKCQl2YWxpZGF0ZTogZnVuY3Rpb24gKGRhdGEsIHNjaGVtYSwgY2hlY2tSZWN1cnNpdmUsIGJhblVua25vd25Qcm9wZXJ0aWVzKSB7CgkJCXZhciBkZWYgPSBkZWZhdWx0RXJyb3JSZXBvcnRlcihjdXJyZW50TGFuZ3VhZ2UpOwoJCQl2YXIgZXJyb3JSZXBvcnRlciA9IGN1c3RvbUVycm9yUmVwb3J0ZXIgPyBmdW5jdGlvbiAoZXJyb3IsIGRhdGEsIHNjaGVtYSkgewoJCQkJcmV0dXJuIGN1c3RvbUVycm9yUmVwb3J0ZXIoZXJyb3IsIGRhdGEsIHNjaGVtYSkgfHwgZGVmKGVycm9yLCBkYXRhLCBzY2hlbWEpOwoJCQl9IDogZGVmOwoJCQl2YXIgY29udGV4dCA9IG5ldyBWYWxpZGF0b3JDb250ZXh0KGdsb2JhbENvbnRleHQsIGZhbHNlLCBlcnJvclJlcG9ydGVyLCBjaGVja1JlY3Vyc2l2ZSwgYmFuVW5rbm93blByb3BlcnRpZXMpOwoJCQlpZiAodHlwZW9mIHNjaGVtYSA9PT0gInN0cmluZyIpIHsKCQkJCXNjaGVtYSA9IHsiJHJlZiI6IHNjaGVtYX07CgkJCX0KCQkJY29udGV4dC5hZGRTY2hlbWEoIiIsIHNjaGVtYSk7CgkJCXZhciBlcnJvciA9IGNvbnRleHQudmFsaWRhdGVBbGwoZGF0YSwgc2NoZW1hLCBudWxsLCBudWxsLCAiIik7CgkJCWlmICghZXJyb3IgJiYgYmFuVW5rbm93blByb3BlcnRpZXMpIHsKCQkJCWVycm9yID0gY29udGV4dC5iYW5Vbmtub3duUHJvcGVydGllcyhkYXRhLCBzY2hlbWEpOwoJCQl9CgkJCXRoaXMuZXJyb3IgPSBlcnJvcjsKCQkJdGhpcy5taXNzaW5nID0gY29udGV4dC5taXNzaW5nOwoJCQl0aGlzLnZhbGlkID0gKGVycm9yID09PSBudWxsKTsKCQkJcmV0dXJuIHRoaXMudmFsaWQ7CgkJfSwKCQl2YWxpZGF0ZVJlc3VsdDogZnVuY3Rpb24gKCkgewoJCQl2YXIgcmVzdWx0ID0ge307CgkJCXRoaXMudmFsaWRhdGUuYXBwbHkocmVzdWx0LCBhcmd1bWVudHMpOwoJCQlyZXR1cm4gcmVzdWx0OwoJCX0sCgkJdmFsaWRhdGVNdWx0aXBsZTogZnVuY3Rpb24gKGRhdGEsIHNjaGVtYSwgY2hlY2tSZWN1cnNpdmUsIGJhblVua25vd25Qcm9wZXJ0aWVzKSB7CgkJCXZhciBkZWYgPSBkZWZhdWx0RXJyb3JSZXBvcnRlcihjdXJyZW50TGFuZ3VhZ2UpOwoJCQl2YXIgZXJyb3JSZXBvcnRlciA9IGN1c3RvbUVycm9yUmVwb3J0ZXIgPyBmdW5jdGlvbiAoZXJyb3IsIGRhdGEsIHNjaGVtYSkgewoJCQkJcmV0dXJuIGN1c3RvbUVycm9yUmVwb3J0ZXIoZXJyb3IsIGRhdGEsIHNjaGVtYSkgfHwgZGVmKGVycm9yLCBkYXRhLCBzY2hlbWEpOwoJCQl9IDogZGVmOwoJCQl2YXIgY29udGV4dCA9IG5ldyBWYWxpZGF0b3JDb250ZXh0KGdsb2JhbENvbnRleHQsIHRydWUsIGVycm9yUmVwb3J0ZXIsIGNoZWNrUmVjdXJzaXZlLCBiYW5Vbmtub3duUHJvcGVydGllcyk7CgkJCWlmICh0eXBlb2Ygc2NoZW1hID09PSAic3RyaW5nIikgewoJCQkJc2NoZW1hID0geyIkcmVmIjogc2NoZW1hfTsKCQkJfQoJCQljb250ZXh0LmFkZFNjaGVtYSgiIiwgc2NoZW1hKTsKCQkJY29udGV4dC52YWxpZGF0ZUFsbChkYXRhLCBzY2hlbWEsIG51bGwsIG51bGwsICIiKTsKCQkJaWYgKGJhblVua25vd25Qcm9wZXJ0aWVzKSB7CgkJCQljb250ZXh0LmJhblVua25vd25Qcm9wZXJ0aWVzKGRhdGEsIHNjaGVtYSk7CgkJCX0KCQkJdmFyIHJlc3VsdCA9IHt9OwoJCQlyZXN1bHQuZXJyb3JzID0gY29udGV4dC5lcnJvcnM7CgkJCXJlc3VsdC5taXNzaW5nID0gY29udGV4dC5taXNzaW5nOwoJCQlyZXN1bHQudmFsaWQgPSAocmVzdWx0LmVycm9ycy5sZW5ndGggPT09IDApOwoJCQlyZXR1cm4gcmVzdWx0OwoJCX0sCgkJYWRkU2NoZW1hOiBmdW5jdGlvbiAoKSB7CgkJCXJldHVybiBnbG9iYWxDb250ZXh0LmFkZFNjaGVtYS5hcHBseShnbG9iYWxDb250ZXh0LCBhcmd1bWVudHMpOwoJCX0sCgkJZ2V0U2NoZW1hOiBmdW5jdGlvbiAoKSB7CgkJCXJldHVybiBnbG9iYWxDb250ZXh0LmdldFNjaGVtYS5hcHBseShnbG9iYWxDb250ZXh0LCBhcmd1bWVudHMpOwoJCX0sCgkJZ2V0U2NoZW1hTWFwOiBmdW5jdGlvbiAoKSB7CgkJCXJldHVybiBnbG9iYWxDb250ZXh0LmdldFNjaGVtYU1hcC5hcHBseShnbG9iYWxDb250ZXh0LCBhcmd1bWVudHMpOwoJCX0sCgkJZ2V0U2NoZW1hVXJpczogZnVuY3Rpb24gKCkgewoJCQlyZXR1cm4gZ2xvYmFsQ29udGV4dC5nZXRTY2hlbWFVcmlzLmFwcGx5KGdsb2JhbENvbnRleHQsIGFyZ3VtZW50cyk7CgkJfSwKCQlnZXRNaXNzaW5nVXJpczogZnVuY3Rpb24gKCkgewoJCQlyZXR1cm4gZ2xvYmFsQ29udGV4dC5nZXRNaXNzaW5nVXJpcy5hcHBseShnbG9iYWxDb250ZXh0LCBhcmd1bWVudHMpOwoJCX0sCgkJZHJvcFNjaGVtYXM6IGZ1bmN0aW9uICgpIHsKCQkJZ2xvYmFsQ29udGV4dC5kcm9wU2NoZW1hcy5hcHBseShnbG9iYWxDb250ZXh0LCBhcmd1bWVudHMpOwoJCX0sCgkJZGVmaW5lS2V5d29yZDogZnVuY3Rpb24gKCkgewoJCQlnbG9iYWxDb250ZXh0LmRlZmluZUtleXdvcmQuYXBwbHkoZ2xvYmFsQ29udGV4dCwgYXJndW1lbnRzKTsKCQl9LAoJCWRlZmluZUVycm9yOiBmdW5jdGlvbiAoY29kZU5hbWUsIGNvZGVOdW1iZXIsIGRlZmF1bHRNZXNzYWdlKSB7CgkJCWlmICh0eXBlb2YgY29kZU5hbWUgIT09ICdzdHJpbmcnIHx8ICEvXltBLVpdKyhfW0EtWl0rKSokLy50ZXN0KGNvZGVOYW1lKSkgewoJCQkJdGhyb3cgbmV3IEVycm9yKCdDb2RlIG5hbWUgbXVzdCBiZSBhIHN0cmluZyBpbiBVUFBFUl9DQVNFX1dJVEhfVU5ERVJTQ09SRVMnKTsKCQkJfQoJCQlpZiAodHlwZW9mIGNvZGVOdW1iZXIgIT09ICdudW1iZXInIHx8IGNvZGVOdW1iZXIlMSAhPT0gMCB8fCBjb2RlTnVtYmVyIDwgMTAwMDApIHsKCQkJCXRocm93IG5ldyBFcnJvcignQ29kZSBudW1iZXIgbXVzdCBiZSBhbiBpbnRlZ2VyID4gMTAwMDAnKTsKCQkJfQoJCQlpZiAodHlwZW9mIEVycm9yQ29kZXNbY29kZU5hbWVdICE9PSAndW5kZWZpbmVkJykgewoJCQkJdGhyb3cgbmV3IEVycm9yKCdFcnJvciBhbHJlYWR5IGRlZmluZWQ6ICcgKyBjb2RlTmFtZSArICcgYXMgJyArIEVycm9yQ29kZXNbY29kZU5hbWVdKTsKCQkJfQoJCQlpZiAodHlwZW9mIEVycm9yQ29kZUxvb2t1cFtjb2RlTnVtYmVyXSAhPT0gJ3VuZGVmaW5lZCcpIHsKCQkJCXRocm93IG5ldyBFcnJvcignRXJyb3IgY29kZSBhbHJlYWR5IHVzZWQ6ICcgKyBFcnJvckNvZGVMb29rdXBbY29kZU51bWJlcl0gKyAnIGFzICcgKyBjb2RlTnVtYmVyKTsKCQkJfQoJCQlFcnJvckNvZGVzW2NvZGVOYW1lXSA9IGNvZGVOdW1iZXI7CgkJCUVycm9yQ29kZUxvb2t1cFtjb2RlTnVtYmVyXSA9IGNvZGVOYW1lOwoJCQlFcnJvck1lc3NhZ2VzRGVmYXVsdFtjb2RlTmFtZV0gPSBFcnJvck1lc3NhZ2VzRGVmYXVsdFtjb2RlTnVtYmVyXSA9IGRlZmF1bHRNZXNzYWdlOwoJCQlmb3IgKHZhciBsYW5nQ29kZSBpbiBsYW5ndWFnZXMpIHsKCQkJCXZhciBsYW5ndWFnZSA9IGxhbmd1YWdlc1tsYW5nQ29kZV07CgkJCQlpZiAobGFuZ3VhZ2VbY29kZU5hbWVdKSB7CgkJCQkJbGFuZ3VhZ2VbY29kZU51bWJlcl0gPSBsYW5ndWFnZVtjb2RlTnVtYmVyXSB8fCBsYW5ndWFnZVtjb2RlTmFtZV07CgkJCQl9CgkJCX0KCQl9LAoJCXJlc2V0OiBmdW5jdGlvbiAoKSB7CgkJCWdsb2JhbENvbnRleHQucmVzZXQoKTsKCQkJdGhpcy5lcnJvciA9IG51bGw7CgkJCXRoaXMubWlzc2luZyA9IFtdOwoJCQl0aGlzLnZhbGlkID0gdHJ1ZTsKCQl9LAoJCW1pc3Npbmc6IFtdLAoJCWVycm9yOiBudWxsLAoJCXZhbGlkOiB0cnVlLAoJCW5vcm1TY2hlbWE6IG5vcm1TY2hlbWEsCgkJcmVzb2x2ZVVybDogcmVzb2x2ZVVybCwKCQlnZXREb2N1bWVudFVyaTogZ2V0RG9jdW1lbnRVcmksCgkJZXJyb3JDb2RlczogRXJyb3JDb2RlcwoJfTsKCWFwaS5sYW5ndWFnZShsYW5ndWFnZSB8fCAnZW4nKTsKCXJldHVybiBhcGk7Cn0KCnZhciB0djQgPSBjcmVhdGVBcGkoKTsKdHY0LmFkZExhbmd1YWdlKCdlbi1nYicsIEVycm9yTWVzc2FnZXNEZWZhdWx0KTsKCi8vbGVnYWN5IHByb3BlcnR5CnR2NC50djQgPSB0djQ7CgpyZXR1cm4gdHY0OyAvLyB1c2VkIGJ5IF9oZWFkZXIuanMgdG8gZ2xvYmFsaXNlLgoKfSkpOwp9LHt9XSwyOltmdW5jdGlvbihyZXF1aXJlLG1vZHVsZSxleHBvcnRzKXsKLyoKICogIENvcHlyaWdodCAoYykgMjAxNCBUaGUgV2ViUlRDIHByb2plY3QgYXV0aG9ycy4gQWxsIFJpZ2h0cyBSZXNlcnZlZC4KICoKICogIFVzZSBvZiB0aGlzIHNvdXJjZSBjb2RlIGlzIGdvdmVybmVkIGJ5IGEgQlNELXN0eWxlIGxpY2Vuc2UKICogIHRoYXQgY2FuIGJlIGZvdW5kIGluIHRoZSBMSUNFTlNFIGZpbGUgaW4gdGhlIHJvb3Qgb2YgdGhlIHNvdXJjZQogKiAgdHJlZS4KICovCgovKiBNb3JlIGluZm9ybWF0aW9uIGFib3V0IHRoZXNlIG9wdGlvbnMgYXQganNoaW50LmNvbS9kb2NzL29wdGlvbnMgKi8KLyoganNoaW50IGJyb3dzZXI6IHRydWUsIGNhbWVsY2FzZTogdHJ1ZSwgY3VybHk6IHRydWUsIGRldmVsOiB0cnVlLAogICBlcWVxZXE6IHRydWUsIGZvcmluOiBmYWxzZSwgZ2xvYmFsc3RyaWN0OiB0cnVlLCBub2RlOiB0cnVlLAogICBxdW90bWFyazogc2luZ2xlLCB1bmRlZjogdHJ1ZSwgdW51c2VkOiBzdHJpY3QgKi8KLyogZ2xvYmFsIG1velJUQ0ljZUNhbmRpZGF0ZSwgbW96UlRDUGVlckNvbm5lY3Rpb24sIFByb21pc2UsCm1velJUQ1Nlc3Npb25EZXNjcmlwdGlvbiwgd2Via2l0UlRDUGVlckNvbm5lY3Rpb24sIE1lZGlhU3RyZWFtVHJhY2sgKi8KLyogZXhwb3J0ZWQgdHJhY2UscmVxdWVzdFVzZXJNZWRpYSAqLwoKJ3VzZSBzdHJpY3QnOwoKdmFyIGdldFVzZXJNZWRpYSA9IG51bGw7CnZhciBhdHRhY2hNZWRpYVN0cmVhbSA9IG51bGw7CnZhciByZWF0dGFjaE1lZGlhU3RyZWFtID0gbnVsbDsKdmFyIHdlYnJ0Y0RldGVjdGVkQnJvd3NlciA9IG51bGw7CnZhciB3ZWJydGNEZXRlY3RlZFZlcnNpb24gPSBudWxsOwp2YXIgd2VicnRjTWluaW11bVZlcnNpb24gPSBudWxsOwp2YXIgd2VicnRjVXRpbHMgPSB7CiAgbG9nOiBmdW5jdGlvbigpIHsKICAgIC8vIHN1cHByZXNzIGNvbnNvbGUubG9nIG91dHB1dCB3aGVuIGJlaW5nIGluY2x1ZGVkIGFzIGEgbW9kdWxlLgogICAgaWYgKHR5cGVvZiBtb2R1bGUgIT09ICd1bmRlZmluZWQnIHx8CiAgICAgICAgdHlwZW9mIHJlcXVpcmUgPT09ICdmdW5jdGlvbicgJiYgdHlwZW9mIGRlZmluZSA9PT0gJ2Z1bmN0aW9uJykgewogICAgICByZXR1cm47CiAgICB9CiAgICBjb25zb2xlLmxvZy5hcHBseShjb25zb2xlLCBhcmd1bWVudHMpOwogIH0sCiAgZXh0cmFjdFZlcnNpb246IGZ1bmN0aW9uKHVhc3RyaW5nLCBleHByLCBwb3MpIHsKICAgIHZhciBtYXRjaCA9IHVhc3RyaW5nLm1hdGNoKGV4cHIpOwogICAgcmV0dXJuIG1hdGNoICYmIG1hdGNoLmxlbmd0aCA+PSBwb3MgJiYgcGFyc2VJbnQobWF0Y2hbcG9zXSk7CiAgfQp9OwoKZnVuY3Rpb24gdHJhY2UodGV4dCkgewogIC8vIFRoaXMgZnVuY3Rpb24gaXMgdXNlZCBmb3IgbG9nZ2luZy4KICBpZiAodGV4dFt0ZXh0Lmxlbmd0aCAtIDFdID09PSAnXG4nKSB7CiAgICB0ZXh0ID0gdGV4dC5zdWJzdHJpbmcoMCwgdGV4dC5sZW5ndGggLSAxKTsKICB9CiAgaWYgKHdpbmRvdy5wZXJmb3JtYW5jZSkgewogICAgdmFyIG5vdyA9ICh3aW5kb3cucGVyZm9ybWFuY2Uubm93KCkgLyAxMDAwKS50b0ZpeGVkKDMpOwogICAgd2VicnRjVXRpbHMubG9nKG5vdyArICc6ICcgKyB0ZXh0KTsKICB9IGVsc2UgewogICAgd2VicnRjVXRpbHMubG9nKHRleHQpOwogIH0KfQoKaWYgKHR5cGVvZiB3aW5kb3cgPT09ICdvYmplY3QnKSB7CiAgaWYgKHdpbmRvdy5IVE1MTWVkaWFFbGVtZW50ICYmCiAgICAhKCdzcmNPYmplY3QnIGluIHdpbmRvdy5IVE1MTWVkaWFFbGVtZW50LnByb3RvdHlwZSkpIHsKICAgIC8vIFNoaW0gdGhlIHNyY09iamVjdCBwcm9wZXJ0eSwgb25jZSwgd2hlbiBIVE1MTWVkaWFFbGVtZW50IGlzIGZvdW5kLgogICAgT2JqZWN0LmRlZmluZVByb3BlcnR5KHdpbmRvdy5IVE1MTWVkaWFFbGVtZW50LnByb3RvdHlwZSwgJ3NyY09iamVjdCcsIHsKICAgICAgZ2V0OiBmdW5jdGlvbigpIHsKICAgICAgICAvLyBJZiBwcmVmaXhlZCBzcmNPYmplY3QgcHJvcGVydHkgZXhpc3RzLCByZXR1cm4gaXQuCiAgICAgICAgLy8gT3RoZXJ3aXNlIHVzZSB0aGUgc2hpbW1lZCBwcm9wZXJ0eSwgX3NyY09iamVjdAogICAgICAgIHJldHVybiAnbW96U3JjT2JqZWN0JyBpbiB0aGlzID8gdGhpcy5tb3pTcmNPYmplY3QgOiB0aGlzLl9zcmNPYmplY3Q7CiAgICAgIH0sCiAgICAgIHNldDogZnVuY3Rpb24oc3RyZWFtKSB7CiAgICAgICAgaWYgKCdtb3pTcmNPYmplY3QnIGluIHRoaXMpIHsKICAgICAgICAgIHRoaXMubW96U3JjT2JqZWN0ID0gc3RyZWFtOwogICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAvLyBVc2UgX3NyY09iamVjdCBhcyBhIHByaXZhdGUgcHJvcGVydHkgZm9yIHRoaXMgc2hpbQogICAgICAgICAgdGhpcy5fc3JjT2JqZWN0ID0gc3RyZWFtOwogICAgICAgICAgLy8gVE9ETzogcmV2b2tlT2JqZWN0VXJsKHRoaXMuc3JjKSB3aGVuICFzdHJlYW0gdG8gcmVsZWFzZSByZXNvdXJjZXM/CiAgICAgICAgICB0aGlzLnNyYyA9IFVSTC5jcmVhdGVPYmplY3RVUkwoc3RyZWFtKTsKICAgICAgICB9CiAgICAgIH0KICAgIH0pOwogIH0KICAvLyBQcm94eSBleGlzdGluZyBnbG9iYWxzCiAgZ2V0VXNlck1lZGlhID0gd2luZG93Lm5hdmlnYXRvciAmJiB3aW5kb3cubmF2aWdhdG9yLmdldFVzZXJNZWRpYTsKfQoKLy8gQXR0YWNoIGEgbWVkaWEgc3RyZWFtIHRvIGFuIGVsZW1lbnQuCmF0dGFjaE1lZGlhU3RyZWFtID0gZnVuY3Rpb24oZWxlbWVudCwgc3RyZWFtKSB7CiAgZWxlbWVudC5zcmNPYmplY3QgPSBzdHJlYW07Cn07CgpyZWF0dGFjaE1lZGlhU3RyZWFtID0gZnVuY3Rpb24odG8sIGZyb20pIHsKICB0by5zcmNPYmplY3QgPSBmcm9tLnNyY09iamVjdDsKfTsKCmlmICh0eXBlb2Ygd2luZG93ID09PSAndW5kZWZpbmVkJyB8fCAhd2luZG93Lm5hdmlnYXRvcikgewogIHdlYnJ0Y1V0aWxzLmxvZygnVGhpcyBkb2VzIG5vdCBhcHBlYXIgdG8gYmUgYSBicm93c2VyJyk7CiAgd2VicnRjRGV0ZWN0ZWRCcm93c2VyID0gJ25vdCBhIGJyb3dzZXInOwp9IGVsc2UgaWYgKG5hdmlnYXRvci5tb3pHZXRVc2VyTWVkaWEgJiYgd2luZG93Lm1velJUQ1BlZXJDb25uZWN0aW9uKSB7CiAgd2VicnRjVXRpbHMubG9nKCdUaGlzIGFwcGVhcnMgdG8gYmUgRmlyZWZveCcpOwoKICB3ZWJydGNEZXRlY3RlZEJyb3dzZXIgPSAnZmlyZWZveCc7CgogIC8vIHRoZSBkZXRlY3RlZCBmaXJlZm94IHZlcnNpb24uCiAgd2VicnRjRGV0ZWN0ZWRWZXJzaW9uID0gd2VicnRjVXRpbHMuZXh0cmFjdFZlcnNpb24obmF2aWdhdG9yLnVzZXJBZ2VudCwKICAgICAgL0ZpcmVmb3hcLyhbMC05XSspXC4vLCAxKTsKCiAgLy8gdGhlIG1pbmltdW0gZmlyZWZveCB2ZXJzaW9uIHN0aWxsIHN1cHBvcnRlZCBieSBhZGFwdGVyLgogIHdlYnJ0Y01pbmltdW1WZXJzaW9uID0gMzE7CgogIC8vIFRoZSBSVENQZWVyQ29ubmVjdGlvbiBvYmplY3QuCiAgd2luZG93LlJUQ1BlZXJDb25uZWN0aW9uID0gZnVuY3Rpb24ocGNDb25maWcsIHBjQ29uc3RyYWludHMpIHsKICAgIGlmICh3ZWJydGNEZXRlY3RlZFZlcnNpb24gPCAzOCkgewogICAgICAvLyAudXJscyBpcyBub3Qgc3VwcG9ydGVkIGluIEZGIDwgMzguCiAgICAgIC8vIGNyZWF0ZSBSVENJY2VTZXJ2ZXJzIHdpdGggYSBzaW5nbGUgdXJsLgogICAgICBpZiAocGNDb25maWcgJiYgcGNDb25maWcuaWNlU2VydmVycykgewogICAgICAgIHZhciBuZXdJY2VTZXJ2ZXJzID0gW107CiAgICAgICAgZm9yICh2YXIgaSA9IDA7IGkgPCBwY0NvbmZpZy5pY2VTZXJ2ZXJzLmxlbmd0aDsgaSsrKSB7CiAgICAgICAgICB2YXIgc2VydmVyID0gcGNDb25maWcuaWNlU2VydmVyc1tpXTsKICAgICAgICAgIGlmIChzZXJ2ZXIuaGFzT3duUHJvcGVydHkoJ3VybHMnKSkgewogICAgICAgICAgICBmb3IgKHZhciBqID0gMDsgaiA8IHNlcnZlci51cmxzLmxlbmd0aDsgaisrKSB7CiAgICAgICAgICAgICAgdmFyIG5ld1NlcnZlciA9IHsKICAgICAgICAgICAgICAgIHVybDogc2VydmVyLnVybHNbal0KICAgICAgICAgICAgICB9OwogICAgICAgICAgICAgIGlmIChzZXJ2ZXIudXJsc1tqXS5pbmRleE9mKCd0dXJuJykgPT09IDApIHsKICAgICAgICAgICAgICAgIG5ld1NlcnZlci51c2VybmFtZSA9IHNlcnZlci51c2VybmFtZTsKICAgICAgICAgICAgICAgIG5ld1NlcnZlci5jcmVkZW50aWFsID0gc2VydmVyLmNyZWRlbnRpYWw7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIG5ld0ljZVNlcnZlcnMucHVzaChuZXdTZXJ2ZXIpOwogICAgICAgICAgICB9CiAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICBuZXdJY2VTZXJ2ZXJzLnB1c2gocGNDb25maWcuaWNlU2VydmVyc1tpXSk7CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICAgIHBjQ29uZmlnLmljZVNlcnZlcnMgPSBuZXdJY2VTZXJ2ZXJzOwogICAgICB9CiAgICB9CiAgICByZXR1cm4gbmV3IG1velJUQ1BlZXJDb25uZWN0aW9uKHBjQ29uZmlnLCBwY0NvbnN0cmFpbnRzKTsgLy8ganNjczppZ25vcmUgcmVxdWlyZUNhcGl0YWxpemVkQ29uc3RydWN0b3JzCiAgfTsKCiAgLy8gVGhlIFJUQ1Nlc3Npb25EZXNjcmlwdGlvbiBvYmplY3QuCiAgaWYgKCF3aW5kb3cuUlRDU2Vzc2lvbkRlc2NyaXB0aW9uKSB7CiAgICB3aW5kb3cuUlRDU2Vzc2lvbkRlc2NyaXB0aW9uID0gbW96UlRDU2Vzc2lvbkRlc2NyaXB0aW9uOwogIH0KCiAgLy8gVGhlIFJUQ0ljZUNhbmRpZGF0ZSBvYmplY3QuCiAgaWYgKCF3aW5kb3cuUlRDSWNlQ2FuZGlkYXRlKSB7CiAgICB3aW5kb3cuUlRDSWNlQ2FuZGlkYXRlID0gbW96UlRDSWNlQ2FuZGlkYXRlOwogIH0KCiAgLy8gZ2V0VXNlck1lZGlhIGNvbnN0cmFpbnRzIHNoaW0uCiAgZ2V0VXNlck1lZGlhID0gZnVuY3Rpb24oY29uc3RyYWludHMsIG9uU3VjY2Vzcywgb25FcnJvcikgewogICAgdmFyIGNvbnN0cmFpbnRzVG9GRjM3ID0gZnVuY3Rpb24oYykgewogICAgICBpZiAodHlwZW9mIGMgIT09ICdvYmplY3QnIHx8IGMucmVxdWlyZSkgewogICAgICAgIHJldHVybiBjOwogICAgICB9CiAgICAgIHZhciByZXF1aXJlID0gW107CiAgICAgIE9iamVjdC5rZXlzKGMpLmZvckVhY2goZnVuY3Rpb24oa2V5KSB7CiAgICAgICAgaWYgKGtleSA9PT0gJ3JlcXVpcmUnIHx8IGtleSA9PT0gJ2FkdmFuY2VkJyB8fCBrZXkgPT09ICdtZWRpYVNvdXJjZScpIHsKICAgICAgICAgIHJldHVybjsKICAgICAgICB9CiAgICAgICAgdmFyIHIgPSBjW2tleV0gPSAodHlwZW9mIGNba2V5XSA9PT0gJ29iamVjdCcpID8KICAgICAgICAgICAgY1trZXldIDoge2lkZWFsOiBjW2tleV19OwogICAgICAgIGlmIChyLm1pbiAhPT0gdW5kZWZpbmVkIHx8CiAgICAgICAgICAgIHIubWF4ICE9PSB1bmRlZmluZWQgfHwgci5leGFjdCAhPT0gdW5kZWZpbmVkKSB7CiAgICAgICAgICByZXF1aXJlLnB1c2goa2V5KTsKICAgICAgICB9CiAgICAgICAgaWYgKHIuZXhhY3QgIT09IHVuZGVmaW5lZCkgewogICAgICAgICAgaWYgKHR5cGVvZiByLmV4YWN0ID09PSAnbnVtYmVyJykgewogICAgICAgICAgICByLm1pbiA9IHIubWF4ID0gci5leGFjdDsKICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgIGNba2V5XSA9IHIuZXhhY3Q7CiAgICAgICAgICB9CiAgICAgICAgICBkZWxldGUgci5leGFjdDsKICAgICAgICB9CiAgICAgICAgaWYgKHIuaWRlYWwgIT09IHVuZGVmaW5lZCkgewogICAgICAgICAgYy5hZHZhbmNlZCA9IGMuYWR2YW5jZWQgfHwgW107CiAgICAgICAgICB2YXIgb2MgPSB7fTsKICAgICAgICAgIGlmICh0eXBlb2Ygci5pZGVhbCA9PT0gJ251bWJlcicpIHsKICAgICAgICAgICAgb2Nba2V5XSA9IHttaW46IHIuaWRlYWwsIG1heDogci5pZGVhbH07CiAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICBvY1trZXldID0gci5pZGVhbDsKICAgICAgICAgIH0KICAgICAgICAgIGMuYWR2YW5jZWQucHVzaChvYyk7CiAgICAgICAgICBkZWxldGUgci5pZGVhbDsKICAgICAgICAgIGlmICghT2JqZWN0LmtleXMocikubGVuZ3RoKSB7CiAgICAgICAgICAgIGRlbGV0ZSBjW2tleV07CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICB9KTsKICAgICAgaWYgKHJlcXVpcmUubGVuZ3RoKSB7CiAgICAgICAgYy5yZXF1aXJlID0gcmVxdWlyZTsKICAgICAgfQogICAgICByZXR1cm4gYzsKICAgIH07CiAgICBpZiAod2VicnRjRGV0ZWN0ZWRWZXJzaW9uIDwgMzgpIHsKICAgICAgd2VicnRjVXRpbHMubG9nKCdzcGVjOiAnICsgSlNPTi5zdHJpbmdpZnkoY29uc3RyYWludHMpKTsKICAgICAgaWYgKGNvbnN0cmFpbnRzLmF1ZGlvKSB7CiAgICAgICAgY29uc3RyYWludHMuYXVkaW8gPSBjb25zdHJhaW50c1RvRkYzNyhjb25zdHJhaW50cy5hdWRpbyk7CiAgICAgIH0KICAgICAgaWYgKGNvbnN0cmFpbnRzLnZpZGVvKSB7CiAgICAgICAgY29uc3RyYWludHMudmlkZW8gPSBjb25zdHJhaW50c1RvRkYzNyhjb25zdHJhaW50cy52aWRlbyk7CiAgICAgIH0KICAgICAgd2VicnRjVXRpbHMubG9nKCdmZjM3OiAnICsgSlNPTi5zdHJpbmdpZnkoY29uc3RyYWludHMpKTsKICAgIH0KICAgIHJldHVybiBuYXZpZ2F0b3IubW96R2V0VXNlck1lZGlhKGNvbnN0cmFpbnRzLCBvblN1Y2Nlc3MsIG9uRXJyb3IpOwogIH07CgogIG5hdmlnYXRvci5nZXRVc2VyTWVkaWEgPSBnZXRVc2VyTWVkaWE7CgogIC8vIFNoaW0gZm9yIG1lZGlhRGV2aWNlcyBvbiBvbGRlciB2ZXJzaW9ucy4KICBpZiAoIW5hdmlnYXRvci5tZWRpYURldmljZXMpIHsKICAgIG5hdmlnYXRvci5tZWRpYURldmljZXMgPSB7Z2V0VXNlck1lZGlhOiByZXF1ZXN0VXNlck1lZGlhLAogICAgICBhZGRFdmVudExpc3RlbmVyOiBmdW5jdGlvbigpIHsgfSwKICAgICAgcmVtb3ZlRXZlbnRMaXN0ZW5lcjogZnVuY3Rpb24oKSB7IH0KICAgIH07CiAgfQogIG5hdmlnYXRvci5tZWRpYURldmljZXMuZW51bWVyYXRlRGV2aWNlcyA9CiAgICAgIG5hdmlnYXRvci5tZWRpYURldmljZXMuZW51bWVyYXRlRGV2aWNlcyB8fCBmdW5jdGlvbigpIHsKICAgIHJldHVybiBuZXcgUHJvbWlzZShmdW5jdGlvbihyZXNvbHZlKSB7CiAgICAgIHZhciBpbmZvcyA9IFsKICAgICAgICB7a2luZDogJ2F1ZGlvaW5wdXQnLCBkZXZpY2VJZDogJ2RlZmF1bHQnLCBsYWJlbDogJycsIGdyb3VwSWQ6ICcnfSwKICAgICAgICB7a2luZDogJ3ZpZGVvaW5wdXQnLCBkZXZpY2VJZDogJ2RlZmF1bHQnLCBsYWJlbDogJycsIGdyb3VwSWQ6ICcnfQogICAgICBdOwogICAgICByZXNvbHZlKGluZm9zKTsKICAgIH0pOwogIH07CgogIGlmICh3ZWJydGNEZXRlY3RlZFZlcnNpb24gPCA0MSkgewogICAgLy8gV29yayBhcm91bmQgaHR0cDovL2J1Z3ppbC5sYS8xMTY5NjY1CiAgICB2YXIgb3JnRW51bWVyYXRlRGV2aWNlcyA9CiAgICAgICAgbmF2aWdhdG9yLm1lZGlhRGV2aWNlcy5lbnVtZXJhdGVEZXZpY2VzLmJpbmQobmF2aWdhdG9yLm1lZGlhRGV2aWNlcyk7CiAgICBuYXZpZ2F0b3IubWVkaWFEZXZpY2VzLmVudW1lcmF0ZURldmljZXMgPSBmdW5jdGlvbigpIHsKICAgICAgcmV0dXJuIG9yZ0VudW1lcmF0ZURldmljZXMoKS50aGVuKHVuZGVmaW5lZCwgZnVuY3Rpb24oZSkgewogICAgICAgIGlmIChlLm5hbWUgPT09ICdOb3RGb3VuZEVycm9yJykgewogICAgICAgICAgcmV0dXJuIFtdOwogICAgICAgIH0KICAgICAgICB0aHJvdyBlOwogICAgICB9KTsKICAgIH07CiAgfQp9IGVsc2UgaWYgKG5hdmlnYXRvci53ZWJraXRHZXRVc2VyTWVkaWEgJiYgd2luZG93LndlYmtpdFJUQ1BlZXJDb25uZWN0aW9uKSB7CiAgd2VicnRjVXRpbHMubG9nKCdUaGlzIGFwcGVhcnMgdG8gYmUgQ2hyb21lJyk7CgogIHdlYnJ0Y0RldGVjdGVkQnJvd3NlciA9ICdjaHJvbWUnOwoKICAvLyB0aGUgZGV0ZWN0ZWQgY2hyb21lIHZlcnNpb24uCiAgd2VicnRjRGV0ZWN0ZWRWZXJzaW9uID0gd2VicnRjVXRpbHMuZXh0cmFjdFZlcnNpb24obmF2aWdhdG9yLnVzZXJBZ2VudCwKICAgICAgL0Nocm9tKGV8aXVtKVwvKFswLTldKylcLi8sIDIpOwoKICAvLyB0aGUgbWluaW11bSBjaHJvbWUgdmVyc2lvbiBzdGlsbCBzdXBwb3J0ZWQgYnkgYWRhcHRlci4KICB3ZWJydGNNaW5pbXVtVmVyc2lvbiA9IDM4OwoKICAvLyBUaGUgUlRDUGVlckNvbm5lY3Rpb24gb2JqZWN0LgogIHdpbmRvdy5SVENQZWVyQ29ubmVjdGlvbiA9IGZ1bmN0aW9uKHBjQ29uZmlnLCBwY0NvbnN0cmFpbnRzKSB7CiAgICAvLyBUcmFuc2xhdGUgaWNlVHJhbnNwb3J0UG9saWN5IHRvIGljZVRyYW5zcG9ydHMsCiAgICAvLyBzZWUgaHR0cHM6Ly9jb2RlLmdvb2dsZS5jb20vcC93ZWJydGMvaXNzdWVzL2RldGFpbD9pZD00ODY5CiAgICBpZiAocGNDb25maWcgJiYgcGNDb25maWcuaWNlVHJhbnNwb3J0UG9saWN5KSB7CiAgICAgIHBjQ29uZmlnLmljZVRyYW5zcG9ydHMgPSBwY0NvbmZpZy5pY2VUcmFuc3BvcnRQb2xpY3k7CiAgICB9CgogICAgdmFyIHBjID0gbmV3IHdlYmtpdFJUQ1BlZXJDb25uZWN0aW9uKHBjQ29uZmlnLCBwY0NvbnN0cmFpbnRzKTsgLy8ganNjczppZ25vcmUgcmVxdWlyZUNhcGl0YWxpemVkQ29uc3RydWN0b3JzCiAgICB2YXIgb3JpZ0dldFN0YXRzID0gcGMuZ2V0U3RhdHMuYmluZChwYyk7CiAgICBwYy5nZXRTdGF0cyA9IGZ1bmN0aW9uKHNlbGVjdG9yLCBzdWNjZXNzQ2FsbGJhY2ssIGVycm9yQ2FsbGJhY2spIHsgLy8ganNoaW50IGlnbm9yZTogbGluZQogICAgICB2YXIgc2VsZiA9IHRoaXM7CiAgICAgIHZhciBhcmdzID0gYXJndW1lbnRzOwoKICAgICAgLy8gSWYgc2VsZWN0b3IgaXMgYSBmdW5jdGlvbiB0aGVuIHdlIGFyZSBpbiB0aGUgb2xkIHN0eWxlIHN0YXRzIHNvIGp1c3QKICAgICAgLy8gcGFzcyBiYWNrIHRoZSBvcmlnaW5hbCBnZXRTdGF0cyBmb3JtYXQgdG8gYXZvaWQgYnJlYWtpbmcgb2xkIHVzZXJzLgogICAgICBpZiAoYXJndW1lbnRzLmxlbmd0aCA+IDAgJiYgdHlwZW9mIHNlbGVjdG9yID09PSAnZnVuY3Rpb24nKSB7CiAgICAgICAgcmV0dXJuIG9yaWdHZXRTdGF0cyhzZWxlY3Rvciwgc3VjY2Vzc0NhbGxiYWNrKTsKICAgICAgfQoKICAgICAgdmFyIGZpeENocm9tZVN0YXRzID0gZnVuY3Rpb24ocmVzcG9uc2UpIHsKICAgICAgICB2YXIgc3RhbmRhcmRSZXBvcnQgPSB7fTsKICAgICAgICB2YXIgcmVwb3J0cyA9IHJlc3BvbnNlLnJlc3VsdCgpOwogICAgICAgIHJlcG9ydHMuZm9yRWFjaChmdW5jdGlvbihyZXBvcnQpIHsKICAgICAgICAgIHZhciBzdGFuZGFyZFN0YXRzID0gewogICAgICAgICAgICBpZDogcmVwb3J0LmlkLAogICAgICAgICAgICB0aW1lc3RhbXA6IHJlcG9ydC50aW1lc3RhbXAsCiAgICAgICAgICAgIHR5cGU6IHJlcG9ydC50eXBlCiAgICAgICAgICB9OwogICAgICAgICAgcmVwb3J0Lm5hbWVzKCkuZm9yRWFjaChmdW5jdGlvbihuYW1lKSB7CiAgICAgICAgICAgIHN0YW5kYXJkU3RhdHNbbmFtZV0gPSByZXBvcnQuc3RhdChuYW1lKTsKICAgICAgICAgIH0pOwogICAgICAgICAgc3RhbmRhcmRSZXBvcnRbc3RhbmRhcmRTdGF0cy5pZF0gPSBzdGFuZGFyZFN0YXRzOwogICAgICAgIH0pOwoKICAgICAgICByZXR1cm4gc3RhbmRhcmRSZXBvcnQ7CiAgICAgIH07CgogICAgICBpZiAoYXJndW1lbnRzLmxlbmd0aCA+PSAyKSB7CiAgICAgICAgdmFyIHN1Y2Nlc3NDYWxsYmFja1dyYXBwZXIgPSBmdW5jdGlvbihyZXNwb25zZSkgewogICAgICAgICAgYXJnc1sxXShmaXhDaHJvbWVTdGF0cyhyZXNwb25zZSkpOwogICAgICAgIH07CgogICAgICAgIHJldHVybiBvcmlnR2V0U3RhdHMuYXBwbHkodGhpcywgW3N1Y2Nlc3NDYWxsYmFja1dyYXBwZXIsIGFyZ3VtZW50c1swXV0pOwogICAgICB9CgogICAgICAvLyBwcm9taXNlLXN1cHBvcnQKICAgICAgcmV0dXJuIG5ldyBQcm9taXNlKGZ1bmN0aW9uKHJlc29sdmUsIHJlamVjdCkgewogICAgICAgIGlmIChhcmdzLmxlbmd0aCA9PT0gMSAmJiBzZWxlY3RvciA9PT0gbnVsbCkgewogICAgICAgICAgb3JpZ0dldFN0YXRzLmFwcGx5KHNlbGYsIFsKICAgICAgICAgICAgICBmdW5jdGlvbihyZXNwb25zZSkgewogICAgICAgICAgICAgICAgcmVzb2x2ZS5hcHBseShudWxsLCBbZml4Q2hyb21lU3RhdHMocmVzcG9uc2UpXSk7CiAgICAgICAgICAgICAgfSwgcmVqZWN0XSk7CiAgICAgICAgfSBlbHNlIHsKICAgICAgICAgIG9yaWdHZXRTdGF0cy5hcHBseShzZWxmLCBbcmVzb2x2ZSwgcmVqZWN0XSk7CiAgICAgICAgfQogICAgICB9KTsKICAgIH07CgogICAgcmV0dXJuIHBjOwogIH07CgogIC8vIGFkZCBwcm9taXNlIHN1cHBvcnQKICBbJ2NyZWF0ZU9mZmVyJywgJ2NyZWF0ZUFuc3dlciddLmZvckVhY2goZnVuY3Rpb24obWV0aG9kKSB7CiAgICB2YXIgbmF0aXZlTWV0aG9kID0gd2Via2l0UlRDUGVlckNvbm5lY3Rpb24ucHJvdG90eXBlW21ldGhvZF07CiAgICB3ZWJraXRSVENQZWVyQ29ubmVjdGlvbi5wcm90b3R5cGVbbWV0aG9kXSA9IGZ1bmN0aW9uKCkgewogICAgICB2YXIgc2VsZiA9IHRoaXM7CiAgICAgIGlmIChhcmd1bWVudHMubGVuZ3RoIDwgMSB8fCAoYXJndW1lbnRzLmxlbmd0aCA9PT0gMSAmJgogICAgICAgICAgdHlwZW9mKGFyZ3VtZW50c1swXSkgPT09ICdvYmplY3QnKSkgewogICAgICAgIHZhciBvcHRzID0gYXJndW1lbnRzLmxlbmd0aCA9PT0gMSA/IGFyZ3VtZW50c1swXSA6IHVuZGVmaW5lZDsKICAgICAgICByZXR1cm4gbmV3IFByb21pc2UoZnVuY3Rpb24ocmVzb2x2ZSwgcmVqZWN0KSB7CiAgICAgICAgICBuYXRpdmVNZXRob2QuYXBwbHkoc2VsZiwgW3Jlc29sdmUsIHJlamVjdCwgb3B0c10pOwogICAgICAgIH0pOwogICAgICB9IGVsc2UgewogICAgICAgIHJldHVybiBuYXRpdmVNZXRob2QuYXBwbHkodGhpcywgYXJndW1lbnRzKTsKICAgICAgfQogICAgfTsKICB9KTsKCiAgWydzZXRMb2NhbERlc2NyaXB0aW9uJywgJ3NldFJlbW90ZURlc2NyaXB0aW9uJywKICAgICAgJ2FkZEljZUNhbmRpZGF0ZSddLmZvckVhY2goZnVuY3Rpb24obWV0aG9kKSB7CiAgICB2YXIgbmF0aXZlTWV0aG9kID0gd2Via2l0UlRDUGVlckNvbm5lY3Rpb24ucHJvdG90eXBlW21ldGhvZF07CiAgICB3ZWJraXRSVENQZWVyQ29ubmVjdGlvbi5wcm90b3R5cGVbbWV0aG9kXSA9IGZ1bmN0aW9uKCkgewogICAgICB2YXIgYXJncyA9IGFyZ3VtZW50czsKICAgICAgdmFyIHNlbGYgPSB0aGlzOwogICAgICByZXR1cm4gbmV3IFByb21pc2UoZnVuY3Rpb24ocmVzb2x2ZSwgcmVqZWN0KSB7CiAgICAgICAgbmF0aXZlTWV0aG9kLmFwcGx5KHNlbGYsIFthcmdzWzBdLAogICAgICAgICAgICBmdW5jdGlvbigpIHsKICAgICAgICAgICAgICByZXNvbHZlKCk7CiAgICAgICAgICAgICAgaWYgKGFyZ3MubGVuZ3RoID49IDIpIHsKICAgICAgICAgICAgICAgIGFyZ3NbMV0uYXBwbHkobnVsbCwgW10pOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgfSwKICAgICAgICAgICAgZnVuY3Rpb24oZXJyKSB7CiAgICAgICAgICAgICAgcmVqZWN0KGVycik7CiAgICAgICAgICAgICAgaWYgKGFyZ3MubGVuZ3RoID49IDMpIHsKICAgICAgICAgICAgICAgIGFyZ3NbMl0uYXBwbHkobnVsbCwgW2Vycl0pOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgfV0KICAgICAgICAgICk7CiAgICAgIH0pOwogICAgfTsKICB9KTsKCiAgLy8gZ2V0VXNlck1lZGlhIGNvbnN0cmFpbnRzIHNoaW0uCiAgdmFyIGNvbnN0cmFpbnRzVG9DaHJvbWUgPSBmdW5jdGlvbihjKSB7CiAgICBpZiAodHlwZW9mIGMgIT09ICdvYmplY3QnIHx8IGMubWFuZGF0b3J5IHx8IGMub3B0aW9uYWwpIHsKICAgICAgcmV0dXJuIGM7CiAgICB9CiAgICB2YXIgY2MgPSB7fTsKICAgIE9iamVjdC5rZXlzKGMpLmZvckVhY2goZnVuY3Rpb24oa2V5KSB7CiAgICAgIGlmIChrZXkgPT09ICdyZXF1aXJlJyB8fCBrZXkgPT09ICdhZHZhbmNlZCcgfHwga2V5ID09PSAnbWVkaWFTb3VyY2UnKSB7CiAgICAgICAgcmV0dXJuOwogICAgICB9CiAgICAgIHZhciByID0gKHR5cGVvZiBjW2tleV0gPT09ICdvYmplY3QnKSA/IGNba2V5XSA6IHtpZGVhbDogY1trZXldfTsKICAgICAgaWYgKHIuZXhhY3QgIT09IHVuZGVmaW5lZCAmJiB0eXBlb2Ygci5leGFjdCA9PT0gJ251bWJlcicpIHsKICAgICAgICByLm1pbiA9IHIubWF4ID0gci5leGFjdDsKICAgICAgfQogICAgICB2YXIgb2xkbmFtZSA9IGZ1bmN0aW9uKHByZWZpeCwgbmFtZSkgewogICAgICAgIGlmIChwcmVmaXgpIHsKICAgICAgICAgIHJldHVybiBwcmVmaXggKyBuYW1lLmNoYXJBdCgwKS50b1VwcGVyQ2FzZSgpICsgbmFtZS5zbGljZSgxKTsKICAgICAgICB9CiAgICAgICAgcmV0dXJuIChuYW1lID09PSAnZGV2aWNlSWQnKSA/ICdzb3VyY2VJZCcgOiBuYW1lOwogICAgICB9OwogICAgICBpZiAoci5pZGVhbCAhPT0gdW5kZWZpbmVkKSB7CiAgICAgICAgY2Mub3B0aW9uYWwgPSBjYy5vcHRpb25hbCB8fCBbXTsKICAgICAgICB2YXIgb2MgPSB7fTsKICAgICAgICBpZiAodHlwZW9mIHIuaWRlYWwgPT09ICdudW1iZXInKSB7CiAgICAgICAgICBvY1tvbGRuYW1lKCdtaW4nLCBrZXkpXSA9IHIuaWRlYWw7CiAgICAgICAgICBjYy5vcHRpb25hbC5wdXNoKG9jKTsKICAgICAgICAgIG9jID0ge307CiAgICAgICAgICBvY1tvbGRuYW1lKCdtYXgnLCBrZXkpXSA9IHIuaWRlYWw7CiAgICAgICAgICBjYy5vcHRpb25hbC5wdXNoKG9jKTsKICAgICAgICB9IGVsc2UgewogICAgICAgICAgb2Nbb2xkbmFtZSgnJywga2V5KV0gPSByLmlkZWFsOwogICAgICAgICAgY2Mub3B0aW9uYWwucHVzaChvYyk7CiAgICAgICAgfQogICAgICB9CiAgICAgIGlmIChyLmV4YWN0ICE9PSB1bmRlZmluZWQgJiYgdHlwZW9mIHIuZXhhY3QgIT09ICdudW1iZXInKSB7CiAgICAgICAgY2MubWFuZGF0b3J5ID0gY2MubWFuZGF0b3J5IHx8IHt9OwogICAgICAgIGNjLm1hbmRhdG9yeVtvbGRuYW1lKCcnLCBrZXkpXSA9IHIuZXhhY3Q7CiAgICAgIH0gZWxzZSB7CiAgICAgICAgWydtaW4nLCAnbWF4J10uZm9yRWFjaChmdW5jdGlvbihtaXgpIHsKICAgICAgICAgIGlmIChyW21peF0gIT09IHVuZGVmaW5lZCkgewogICAgICAgICAgICBjYy5tYW5kYXRvcnkgPSBjYy5tYW5kYXRvcnkgfHwge307CiAgICAgICAgICAgIGNjLm1hbmRhdG9yeVtvbGRuYW1lKG1peCwga2V5KV0gPSByW21peF07CiAgICAgICAgICB9CiAgICAgICAgfSk7CiAgICAgIH0KICAgIH0pOwogICAgaWYgKGMuYWR2YW5jZWQpIHsKICAgICAgY2Mub3B0aW9uYWwgPSAoY2Mub3B0aW9uYWwgfHwgW10pLmNvbmNhdChjLmFkdmFuY2VkKTsKICAgIH0KICAgIHJldHVybiBjYzsKICB9OwoKICBnZXRVc2VyTWVkaWEgPSBmdW5jdGlvbihjb25zdHJhaW50cywgb25TdWNjZXNzLCBvbkVycm9yKSB7CiAgICBpZiAoY29uc3RyYWludHMuYXVkaW8pIHsKICAgICAgY29uc3RyYWludHMuYXVkaW8gPSBjb25zdHJhaW50c1RvQ2hyb21lKGNvbnN0cmFpbnRzLmF1ZGlvKTsKICAgIH0KICAgIGlmIChjb25zdHJhaW50cy52aWRlbykgewogICAgICBjb25zdHJhaW50cy52aWRlbyA9IGNvbnN0cmFpbnRzVG9DaHJvbWUoY29uc3RyYWludHMudmlkZW8pOwogICAgfQogICAgd2VicnRjVXRpbHMubG9nKCdjaHJvbWU6ICcgKyBKU09OLnN0cmluZ2lmeShjb25zdHJhaW50cykpOwogICAgcmV0dXJuIG5hdmlnYXRvci53ZWJraXRHZXRVc2VyTWVkaWEoY29uc3RyYWludHMsIG9uU3VjY2Vzcywgb25FcnJvcik7CiAgfTsKICBuYXZpZ2F0b3IuZ2V0VXNlck1lZGlhID0gZ2V0VXNlck1lZGlhOwoKICBpZiAoIW5hdmlnYXRvci5tZWRpYURldmljZXMpIHsKICAgIG5hdmlnYXRvci5tZWRpYURldmljZXMgPSB7Z2V0VXNlck1lZGlhOiByZXF1ZXN0VXNlck1lZGlhLAogICAgICAgICAgICAgICAgICAgICAgICAgICAgICBlbnVtZXJhdGVEZXZpY2VzOiBmdW5jdGlvbigpIHsKICAgICAgcmV0dXJuIG5ldyBQcm9taXNlKGZ1bmN0aW9uKHJlc29sdmUpIHsKICAgICAgICB2YXIga2luZHMgPSB7YXVkaW86ICdhdWRpb2lucHV0JywgdmlkZW86ICd2aWRlb2lucHV0J307CiAgICAgICAgcmV0dXJuIE1lZGlhU3RyZWFtVHJhY2suZ2V0U291cmNlcyhmdW5jdGlvbihkZXZpY2VzKSB7CiAgICAgICAgICByZXNvbHZlKGRldmljZXMubWFwKGZ1bmN0aW9uKGRldmljZSkgewogICAgICAgICAgICByZXR1cm4ge2xhYmVsOiBkZXZpY2UubGFiZWwsCiAgICAgICAgICAgICAgICAgICAga2luZDoga2luZHNbZGV2aWNlLmtpbmRdLAogICAgICAgICAgICAgICAgICAgIGRldmljZUlkOiBkZXZpY2UuaWQsCiAgICAgICAgICAgICAgICAgICAgZ3JvdXBJZDogJyd9OwogICAgICAgICAgfSkpOwogICAgICAgIH0pOwogICAgICB9KTsKICAgIH19OwogIH0KCiAgLy8gQSBzaGltIGZvciBnZXRVc2VyTWVkaWEgbWV0aG9kIG9uIHRoZSBtZWRpYURldmljZXMgb2JqZWN0LgogIC8vIFRPRE8oS2FwdGVuSmFuc3NvbikgcmVtb3ZlIG9uY2UgaW1wbGVtZW50ZWQgaW4gQ2hyb21lIHN0YWJsZS4KICBpZiAoIW5hdmlnYXRvci5tZWRpYURldmljZXMuZ2V0VXNlck1lZGlhKSB7CiAgICBuYXZpZ2F0b3IubWVkaWFEZXZpY2VzLmdldFVzZXJNZWRpYSA9IGZ1bmN0aW9uKGNvbnN0cmFpbnRzKSB7CiAgICAgIHJldHVybiByZXF1ZXN0VXNlck1lZGlhKGNvbnN0cmFpbnRzKTsKICAgIH07CiAgfSBlbHNlIHsKICAgIC8vIEV2ZW4gdGhvdWdoIENocm9tZSA0NSBoYXMgbmF2aWdhdG9yLm1lZGlhRGV2aWNlcyBhbmQgYSBnZXRVc2VyTWVkaWEKICAgIC8vIGZ1bmN0aW9uIHdoaWNoIHJldHVybnMgYSBQcm9taXNlLCBpdCBkb2VzIG5vdCBhY2NlcHQgc3BlYy1zdHlsZQogICAgLy8gY29uc3RyYWludHMuCiAgICB2YXIgb3JpZ0dldFVzZXJNZWRpYSA9IG5hdmlnYXRvci5tZWRpYURldmljZXMuZ2V0VXNlck1lZGlhLgogICAgICAgIGJpbmQobmF2aWdhdG9yLm1lZGlhRGV2aWNlcyk7CiAgICBuYXZpZ2F0b3IubWVkaWFEZXZpY2VzLmdldFVzZXJNZWRpYSA9IGZ1bmN0aW9uKGMpIHsKICAgICAgd2VicnRjVXRpbHMubG9nKCdzcGVjOiAgICcgKyBKU09OLnN0cmluZ2lmeShjKSk7IC8vIHdoaXRlc3BhY2UgZm9yIGFsaWdubWVudAogICAgICBjLmF1ZGlvID0gY29uc3RyYWludHNUb0Nocm9tZShjLmF1ZGlvKTsKICAgICAgYy52aWRlbyA9IGNvbnN0cmFpbnRzVG9DaHJvbWUoYy52aWRlbyk7CiAgICAgIHdlYnJ0Y1V0aWxzLmxvZygnY2hyb21lOiAnICsgSlNPTi5zdHJpbmdpZnkoYykpOwogICAgICByZXR1cm4gb3JpZ0dldFVzZXJNZWRpYShjKTsKICAgIH07CiAgfQoKICAvLyBEdW1teSBkZXZpY2VjaGFuZ2UgZXZlbnQgbWV0aG9kcy4KICAvLyBUT0RPKEthcHRlbkphbnNzb24pIHJlbW92ZSBvbmNlIGltcGxlbWVudGVkIGluIENocm9tZSBzdGFibGUuCiAgaWYgKHR5cGVvZiBuYXZpZ2F0b3IubWVkaWFEZXZpY2VzLmFkZEV2ZW50TGlzdGVuZXIgPT09ICd1bmRlZmluZWQnKSB7CiAgICBuYXZpZ2F0b3IubWVkaWFEZXZpY2VzLmFkZEV2ZW50TGlzdGVuZXIgPSBmdW5jdGlvbigpIHsKICAgICAgd2VicnRjVXRpbHMubG9nKCdEdW1teSBtZWRpYURldmljZXMuYWRkRXZlbnRMaXN0ZW5lciBjYWxsZWQuJyk7CiAgICB9OwogIH0KICBpZiAodHlwZW9mIG5hdmlnYXRvci5tZWRpYURldmljZXMucmVtb3ZlRXZlbnRMaXN0ZW5lciA9PT0gJ3VuZGVmaW5lZCcpIHsKICAgIG5hdmlnYXRvci5tZWRpYURldmljZXMucmVtb3ZlRXZlbnRMaXN0ZW5lciA9IGZ1bmN0aW9uKCkgewogICAgICB3ZWJydGNVdGlscy5sb2coJ0R1bW15IG1lZGlhRGV2aWNlcy5yZW1vdmVFdmVudExpc3RlbmVyIGNhbGxlZC4nKTsKICAgIH07CiAgfQoKICAvLyBBdHRhY2ggYSBtZWRpYSBzdHJlYW0gdG8gYW4gZWxlbWVudC4KICBhdHRhY2hNZWRpYVN0cmVhbSA9IGZ1bmN0aW9uKGVsZW1lbnQsIHN0cmVhbSkgewogICAgaWYgKHdlYnJ0Y0RldGVjdGVkVmVyc2lvbiA+PSA0MykgewogICAgICBlbGVtZW50LnNyY09iamVjdCA9IHN0cmVhbTsKICAgIH0gZWxzZSBpZiAodHlwZW9mIGVsZW1lbnQuc3JjICE9PSAndW5kZWZpbmVkJykgewogICAgICBlbGVtZW50LnNyYyA9IFVSTC5jcmVhdGVPYmplY3RVUkwoc3RyZWFtKTsKICAgIH0gZWxzZSB7CiAgICAgIHdlYnJ0Y1V0aWxzLmxvZygnRXJyb3IgYXR0YWNoaW5nIHN0cmVhbSB0byBlbGVtZW50LicpOwogICAgfQogIH07CiAgcmVhdHRhY2hNZWRpYVN0cmVhbSA9IGZ1bmN0aW9uKHRvLCBmcm9tKSB7CiAgICBpZiAod2VicnRjRGV0ZWN0ZWRWZXJzaW9uID49IDQzKSB7CiAgICAgIHRvLnNyY09iamVjdCA9IGZyb20uc3JjT2JqZWN0OwogICAgfSBlbHNlIHsKICAgICAgdG8uc3JjID0gZnJvbS5zcmM7CiAgICB9CiAgfTsKCn0gZWxzZSBpZiAobmF2aWdhdG9yLm1lZGlhRGV2aWNlcyAmJiBuYXZpZ2F0b3IudXNlckFnZW50Lm1hdGNoKAogICAgL0VkZ2VcLyhcZCspLihcZCspJC8pKSB7CiAgd2VicnRjVXRpbHMubG9nKCdUaGlzIGFwcGVhcnMgdG8gYmUgRWRnZScpOwogIHdlYnJ0Y0RldGVjdGVkQnJvd3NlciA9ICdlZGdlJzsKCiAgd2VicnRjRGV0ZWN0ZWRWZXJzaW9uID0gd2VicnRjVXRpbHMuZXh0cmFjdFZlcnNpb24obmF2aWdhdG9yLnVzZXJBZ2VudCwKICAgICAgL0VkZ2VcLyhcZCspLihcZCspJC8sIDIpOwoKICAvLyB0aGUgbWluaW11bSB2ZXJzaW9uIHN0aWxsIHN1cHBvcnRlZCBieSBhZGFwdGVyLgogIHdlYnJ0Y01pbmltdW1WZXJzaW9uID0gMTI7Cn0gZWxzZSB7CiAgd2VicnRjVXRpbHMubG9nKCdCcm93c2VyIGRvZXMgbm90IGFwcGVhciB0byBiZSBXZWJSVEMtY2FwYWJsZScpOwp9CgovLyBSZXR1cm5zIHRoZSByZXN1bHQgb2YgZ2V0VXNlck1lZGlhIGFzIGEgUHJvbWlzZS4KZnVuY3Rpb24gcmVxdWVzdFVzZXJNZWRpYShjb25zdHJhaW50cykgewogIHJldHVybiBuZXcgUHJvbWlzZShmdW5jdGlvbihyZXNvbHZlLCByZWplY3QpIHsKICAgIGdldFVzZXJNZWRpYShjb25zdHJhaW50cywgcmVzb2x2ZSwgcmVqZWN0KTsKICB9KTsKfQoKdmFyIHdlYnJ0Y1Rlc3RpbmcgPSB7fTsKdHJ5IHsKICBPYmplY3QuZGVmaW5lUHJvcGVydHkod2VicnRjVGVzdGluZywgJ3ZlcnNpb24nLCB7CiAgICBzZXQ6IGZ1bmN0aW9uKHZlcnNpb24pIHsKICAgICAgd2VicnRjRGV0ZWN0ZWRWZXJzaW9uID0gdmVyc2lvbjsKICAgIH0KICB9KTsKfSBjYXRjaCAoZSkge30KCmlmICh0eXBlb2YgbW9kdWxlICE9PSAndW5kZWZpbmVkJykgewogIHZhciBSVENQZWVyQ29ubmVjdGlvbjsKICBpZiAodHlwZW9mIHdpbmRvdyAhPT0gJ3VuZGVmaW5lZCcpIHsKICAgIFJUQ1BlZXJDb25uZWN0aW9uID0gd2luZG93LlJUQ1BlZXJDb25uZWN0aW9uOwogIH0KICBtb2R1bGUuZXhwb3J0cyA9IHsKICAgIFJUQ1BlZXJDb25uZWN0aW9uOiBSVENQZWVyQ29ubmVjdGlvbiwKICAgIGdldFVzZXJNZWRpYTogZ2V0VXNlck1lZGlhLAogICAgYXR0YWNoTWVkaWFTdHJlYW06IGF0dGFjaE1lZGlhU3RyZWFtLAogICAgcmVhdHRhY2hNZWRpYVN0cmVhbTogcmVhdHRhY2hNZWRpYVN0cmVhbSwKICAgIHdlYnJ0Y0RldGVjdGVkQnJvd3Nlcjogd2VicnRjRGV0ZWN0ZWRCcm93c2VyLAogICAgd2VicnRjRGV0ZWN0ZWRWZXJzaW9uOiB3ZWJydGNEZXRlY3RlZFZlcnNpb24sCiAgICB3ZWJydGNNaW5pbXVtVmVyc2lvbjogd2VicnRjTWluaW11bVZlcnNpb24sCiAgICB3ZWJydGNUZXN0aW5nOiB3ZWJydGNUZXN0aW5nLAogICAgd2VicnRjVXRpbHM6IHdlYnJ0Y1V0aWxzCiAgICAvL3JlcXVlc3RVc2VyTWVkaWE6IG5vdCBleHBvc2VkIG9uIHB1cnBvc2UuCiAgICAvL3RyYWNlOiBub3QgZXhwb3NlZCBvbiBwdXJwb3NlLgogIH07Cn0gZWxzZSBpZiAoKHR5cGVvZiByZXF1aXJlID09PSAnZnVuY3Rpb24nKSAmJiAodHlwZW9mIGRlZmluZSA9PT0gJ2Z1bmN0aW9uJykpIHsKICAvLyBFeHBvc2Ugb2JqZWN0cyBhbmQgZnVuY3Rpb25zIHdoZW4gUmVxdWlyZUpTIGlzIGRvaW5nIHRoZSBsb2FkaW5nLgogIGRlZmluZShbXSwgZnVuY3Rpb24oKSB7CiAgICByZXR1cm4gewogICAgICBSVENQZWVyQ29ubmVjdGlvbjogd2luZG93LlJUQ1BlZXJDb25uZWN0aW9uLAogICAgICBnZXRVc2VyTWVkaWE6IGdldFVzZXJNZWRpYSwKICAgICAgYXR0YWNoTWVkaWFTdHJlYW06IGF0dGFjaE1lZGlhU3RyZWFtLAogICAgICByZWF0dGFjaE1lZGlhU3RyZWFtOiByZWF0dGFjaE1lZGlhU3RyZWFtLAogICAgICB3ZWJydGNEZXRlY3RlZEJyb3dzZXI6IHdlYnJ0Y0RldGVjdGVkQnJvd3NlciwKICAgICAgd2VicnRjRGV0ZWN0ZWRWZXJzaW9uOiB3ZWJydGNEZXRlY3RlZFZlcnNpb24sCiAgICAgIHdlYnJ0Y01pbmltdW1WZXJzaW9uOiB3ZWJydGNNaW5pbXVtVmVyc2lvbiwKICAgICAgd2VicnRjVGVzdGluZzogd2VicnRjVGVzdGluZywKICAgICAgd2VicnRjVXRpbHM6IHdlYnJ0Y1V0aWxzCiAgICAgIC8vcmVxdWVzdFVzZXJNZWRpYTogbm90IGV4cG9zZWQgb24gcHVycG9zZS4KICAgICAgLy90cmFjZTogbm90IGV4cG9zZWQgb24gcHVycG9zZS4KICAgIH07CiAgfSk7Cn0KCn0se31dLDM6W2Z1bmN0aW9uKHJlcXVpcmUsbW9kdWxlLGV4cG9ydHMpewondXNlIHN0cmljdCc7CgpPYmplY3QuZGVmaW5lUHJvcGVydHkoZXhwb3J0cywgJ19fZXNNb2R1bGUnLCB7CiAgdmFsdWU6IHRydWUKfSk7Cgp2YXIgX2NyZWF0ZUNsYXNzID0gKGZ1bmN0aW9uICgpIHsgZnVuY3Rpb24gZGVmaW5lUHJvcGVydGllcyh0YXJnZXQsIHByb3BzKSB7IGZvciAodmFyIGkgPSAwOyBpIDwgcHJvcHMubGVuZ3RoOyBpKyspIHsgdmFyIGRlc2NyaXB0b3IgPSBwcm9wc1tpXTsgZGVzY3JpcHRvci5lbnVtZXJhYmxlID0gZGVzY3JpcHRvci5lbnVtZXJhYmxlIHx8IGZhbHNlOyBkZXNjcmlwdG9yLmNvbmZpZ3VyYWJsZSA9IHRydWU7IGlmICgndmFsdWUnIGluIGRlc2NyaXB0b3IpIGRlc2NyaXB0b3Iud3JpdGFibGUgPSB0cnVlOyBPYmplY3QuZGVmaW5lUHJvcGVydHkodGFyZ2V0LCBkZXNjcmlwdG9yLmtleSwgZGVzY3JpcHRvcik7IH0gfSByZXR1cm4gZnVuY3Rpb24gKENvbnN0cnVjdG9yLCBwcm90b1Byb3BzLCBzdGF0aWNQcm9wcykgeyBpZiAocHJvdG9Qcm9wcykgZGVmaW5lUHJvcGVydGllcyhDb25zdHJ1Y3Rvci5wcm90b3R5cGUsIHByb3RvUHJvcHMpOyBpZiAoc3RhdGljUHJvcHMpIGRlZmluZVByb3BlcnRpZXMoQ29uc3RydWN0b3IsIHN0YXRpY1Byb3BzKTsgcmV0dXJuIENvbnN0cnVjdG9yOyB9OyB9KSgpOwoKZXhwb3J0c1snZGVmYXVsdCddID0gYWN0aXZhdGU7CgpmdW5jdGlvbiBfaW50ZXJvcFJlcXVpcmVEZWZhdWx0KG9iaikgeyByZXR1cm4gb2JqICYmIG9iai5fX2VzTW9kdWxlID8gb2JqIDogeyAnZGVmYXVsdCc6IG9iaiB9OyB9CgpmdW5jdGlvbiBfY2xhc3NDYWxsQ2hlY2soaW5zdGFuY2UsIENvbnN0cnVjdG9yKSB7IGlmICghKGluc3RhbmNlIGluc3RhbmNlb2YgQ29uc3RydWN0b3IpKSB7IHRocm93IG5ldyBUeXBlRXJyb3IoJ0Nhbm5vdCBjYWxsIGEgY2xhc3MgYXMgYSBmdW5jdGlvbicpOyB9IH0KCnZhciBfc3JjU2VydmljZUZyYW1ld29yayA9IHJlcXVpcmUoJy4uL3NyYy9zZXJ2aWNlLWZyYW1ld29yaycpOwoKdmFyIF9zcmNIeXBlcnR5SHlwZXJ0eUNvbm5lY3RvciA9IHJlcXVpcmUoJy4uL3NyYy9oeXBlcnR5L0h5cGVydHlDb25uZWN0b3InKTsKCnZhciBfc3JjSHlwZXJ0eUh5cGVydHlDb25uZWN0b3IyID0gX2ludGVyb3BSZXF1aXJlRGVmYXVsdChfc3JjSHlwZXJ0eUh5cGVydHlDb25uZWN0b3IpOwoKdmFyIEhlbGxvSHlwZXJ0eSA9IChmdW5jdGlvbiAoKSB7CiAgZnVuY3Rpb24gSGVsbG9IeXBlcnR5KGh5cGVydHlVUkwsIGJ1cywgY29uZmlndXJhdGlvbikgewogICAgX2NsYXNzQ2FsbENoZWNrKHRoaXMsIEhlbGxvSHlwZXJ0eSk7CgogICAgY29uc29sZS5sb2coJ1dvcmxkIEh5cGVydHkgSW5zdGFuY2UnKTsKCiAgICB2YXIgX3RoaXMgPSB0aGlzOwogICAgX3RoaXMuYnVzID0gYnVzOwogICAgX3RoaXMuY29uZmlndXJhdGlvbiA9IGNvbmZpZ3VyYXRpb247CiAgICBfdGhpcy5oeXBlcnR5VVJMID0gaHlwZXJ0eVVSTDsKCiAgICB2YXIgc3luY2hlciA9IG5ldyBfc3JjU2VydmljZUZyYW1ld29yay5TeW5jaGVyKGh5cGVydHlVUkwsIGJ1cywgY29uZmlndXJhdGlvbik7CiAgICBfdGhpcy5zeW5jaGVyID0gc3luY2hlcjsKCiAgICBfdGhpcy5zeW5jaGVyLm9uTm90aWZpY2F0aW9uKGZ1bmN0aW9uIChldmVudCkgewogICAgICBjb25zb2xlLmxvZygnaHlwZXJ0eSBoZWxsbyBoYXZlIGFuIG5vdGlmaWNhdGlvbjogJywgZXZlbnQpOwogICAgICBfdGhpcy5oeXBlcnR5Q29ubmVjdG9yLl9vbk5vdGlmaWNhdGlvbihldmVudCwgaHlwZXJ0eVVSTCk7CiAgICB9KTsKCiAgICBfdGhpcy5oeXBlcnR5Q29ubmVjdG9yID0gbmV3IF9zcmNIeXBlcnR5SHlwZXJ0eUNvbm5lY3RvcjJbJ2RlZmF1bHQnXShzeW5jaGVyKTsKICAgIF90aGlzLmh5cGVydHlDb25uZWN0b3IubmFtZSA9ICdIZWxsbyBIeXBlcnR5JzsKICB9CgogIF9jcmVhdGVDbGFzcyhIZWxsb0h5cGVydHksIFt7CiAgICBrZXk6ICdjb25uZWN0JywKICAgIHZhbHVlOiBmdW5jdGlvbiBjb25uZWN0KGh5cGVydHlVUkwsIG9wdGlvbnMpIHsKICAgICAgdmFyIF90aGlzID0gdGhpczsKICAgICAgX3RoaXMudG8gPSBoeXBlcnR5VVJMOwoKICAgICAgcmV0dXJuIG5ldyBQcm9taXNlKGZ1bmN0aW9uIChyZXNvbHZlLCByZWplY3QpIHsKCiAgICAgICAgY29uc29sZS5pbmZvKCdDb25uZWN0aW5nIHRvOiAnLCBoeXBlcnR5VVJMKTsKICAgICAgICBfdGhpcy5oeXBlcnR5Q29ubmVjdG9yLmNvbm5lY3QoaHlwZXJ0eVVSTCwgb3B0aW9ucykudGhlbihmdW5jdGlvbiAoY29udHJvbGxlcikgewogICAgICAgICAgY29uc29sZS5pbmZvKCdDb25uZWN0ZWQgdG86ICcsIGh5cGVydHlVUkwsIGNvbnRyb2xsZXIpOwogICAgICAgICAgcmVzb2x2ZShjb250cm9sbGVyKTsKICAgICAgICB9KVsnY2F0Y2gnXShmdW5jdGlvbiAocmVhc29uKSB7CiAgICAgICAgICByZWplY3QocmVhc29uKTsKICAgICAgICB9KTsKICAgICAgfSk7CiAgICB9CiAgfSwgewogICAga2V5OiAnYWNjZXB0JywKICAgIHZhbHVlOiBmdW5jdGlvbiBhY2NlcHQoKSB7CiAgICAgIHZhciBfdGhpcyA9IHRoaXM7CgogICAgICByZXR1cm4gbmV3IFByb21pc2UoZnVuY3Rpb24gKHJlc29sdmUsIHJlamVjdCkgewoKICAgICAgICBjb25zb2xlLmluZm8oJ1N1YnNjcmliaW5nIG9iamVjdCcpOwogICAgICAgIF90aGlzLmh5cGVydHlDb25uZWN0b3IuYWNjZXB0KCkudGhlbihmdW5jdGlvbiAoY29udHJvbGxlcikgewogICAgICAgICAgY29uc29sZS5pbmZvKCdzdWJzY3JpYmVkIHRvOiAnLCBjb250cm9sbGVyKTsKICAgICAgICAgIHJlc29sdmUoY29udHJvbGxlcik7CiAgICAgICAgfSlbJ2NhdGNoJ10oZnVuY3Rpb24gKHJlYXNvbikgewogICAgICAgICAgY29uc29sZS5lcnJvcihyZWFzb24pOwogICAgICAgICAgcmVqZWN0KHJlYXNvbik7CiAgICAgICAgfSk7CiAgICAgIH0pOwogICAgfQogIH0sIHsKICAgIGtleTogJ2Rpc2Nvbm5lY3QnLAogICAgdmFsdWU6IGZ1bmN0aW9uIGRpc2Nvbm5lY3QoKSB7CgogICAgICB2YXIgX3RoaXMgPSB0aGlzOwoKICAgICAgcmV0dXJuIG5ldyBQcm9taXNlKGZ1bmN0aW9uIChyZXNvbHZlLCByZWplY3QpIHsKCiAgICAgICAgY29uc29sZS5pbmZvKCdkaXNjb25uZWN0aW5nIG9iamVjdCcpOwogICAgICAgIF90aGlzLmh5cGVydHlDb25uZWN0b3IuZGlzY29ubmVjdCgpLnRoZW4oZnVuY3Rpb24gKHJlc3VsdCkgewogICAgICAgICAgY29uc29sZS5pbmZvKCdkaXNjb25uZWN0ZWQnKTsKICAgICAgICAgIHJlc29sdmUocmVzdWx0KTsKICAgICAgICB9KVsnY2F0Y2gnXShmdW5jdGlvbiAocmVhc29uKSB7CiAgICAgICAgICBjb25zb2xlLmVycm9yKHJlYXNvbik7CiAgICAgICAgICByZWplY3QocmVhc29uKTsKICAgICAgICB9KTsKICAgICAgfSk7CiAgICB9CiAgfSwgewogICAga2V5OiAnc2VuZE1lc3NhZ2UnLAogICAgdmFsdWU6IGZ1bmN0aW9uIHNlbmRNZXNzYWdlKCkgewoKICAgICAgdmFyIF90aGlzID0gdGhpczsKCiAgICAgIF90aGlzLmJ1cy5wb3N0TWVzc2FnZSh7CiAgICAgICAgZnJvbTogX3RoaXMuaHlwZXJ0eVVSTCwKICAgICAgICB0bzogJ2h5cGVydHktcnVudGltZTovL3NwMS9Xb3JsZEh5cGVydHknLAogICAgICAgIGJvZHk6IHsKICAgICAgICAgIHZhbHVlOiAnSGVsbG8gZnJvbSB3b3JsZCBoeXBlcnR5IGluc3RhbmNlJwogICAgICAgIH0KICAgICAgfSk7CiAgICB9CiAgfV0pOwoKICByZXR1cm4gSGVsbG9IeXBlcnR5Owp9KSgpOwoKZnVuY3Rpb24gYWN0aXZhdGUoaHlwZXJ0eVVSTCwgYnVzLCBjb25maWd1cmF0aW9uKSB7CgogIHJldHVybiB7CiAgICBoeXBlcnR5TmFtZTogJ0hlbGxvSHlwZXJ0eScsCiAgICBoeXBlcnR5Q29kZTogbmV3IEhlbGxvSHlwZXJ0eShoeXBlcnR5VVJMLCBidXMsIGNvbmZpZ3VyYXRpb24pCiAgfTsKfQoKbW9kdWxlLmV4cG9ydHMgPSBleHBvcnRzWydkZWZhdWx0J107Cgp9LHsiLi4vc3JjL2h5cGVydHkvSHlwZXJ0eUNvbm5lY3RvciI6MTMsIi4uL3NyYy9zZXJ2aWNlLWZyYW1ld29yayI6MTh9XSw0OltmdW5jdGlvbihyZXF1aXJlLG1vZHVsZSxleHBvcnRzKXsKLyoqCiAqIENyZWF0ZWQgYnkgYW1vIG9uIDE0LzExLzIwMTUuCiAqLwondXNlIHN0cmljdCc7CgpPYmplY3QuZGVmaW5lUHJvcGVydHkoZXhwb3J0cywgJ19fZXNNb2R1bGUnLCB7CiAgICB2YWx1ZTogdHJ1ZQp9KTsKCnZhciBfY3JlYXRlQ2xhc3MgPSAoZnVuY3Rpb24gKCkgeyBmdW5jdGlvbiBkZWZpbmVQcm9wZXJ0aWVzKHRhcmdldCwgcHJvcHMpIHsgZm9yICh2YXIgaSA9IDA7IGkgPCBwcm9wcy5sZW5ndGg7IGkrKykgeyB2YXIgZGVzY3JpcHRvciA9IHByb3BzW2ldOyBkZXNjcmlwdG9yLmVudW1lcmFibGUgPSBkZXNjcmlwdG9yLmVudW1lcmFibGUgfHwgZmFsc2U7IGRlc2NyaXB0b3IuY29uZmlndXJhYmxlID0gdHJ1ZTsgaWYgKCd2YWx1ZScgaW4gZGVzY3JpcHRvcikgZGVzY3JpcHRvci53cml0YWJsZSA9IHRydWU7IE9iamVjdC5kZWZpbmVQcm9wZXJ0eSh0YXJnZXQsIGRlc2NyaXB0b3Iua2V5LCBkZXNjcmlwdG9yKTsgfSB9IHJldHVybiBmdW5jdGlvbiAoQ29uc3RydWN0b3IsIHByb3RvUHJvcHMsIHN0YXRpY1Byb3BzKSB7IGlmIChwcm90b1Byb3BzKSBkZWZpbmVQcm9wZXJ0aWVzKENvbnN0cnVjdG9yLnByb3RvdHlwZSwgcHJvdG9Qcm9wcyk7IGlmIChzdGF0aWNQcm9wcykgZGVmaW5lUHJvcGVydGllcyhDb25zdHJ1Y3Rvciwgc3RhdGljUHJvcHMpOyByZXR1cm4gQ29uc3RydWN0b3I7IH07IH0pKCk7CgpmdW5jdGlvbiBfY2xhc3NDYWxsQ2hlY2soaW5zdGFuY2UsIENvbnN0cnVjdG9yKSB7IGlmICghKGluc3RhbmNlIGluc3RhbmNlb2YgQ29uc3RydWN0b3IpKSB7IHRocm93IG5ldyBUeXBlRXJyb3IoJ0Nhbm5vdCBjYWxsIGEgY2xhc3MgYXMgYSBmdW5jdGlvbicpOyB9IH0KCnZhciBDYXRhbG9ndWVEYXRhT2JqZWN0ID0gKGZ1bmN0aW9uICgpIHsKICAgIC8qKgogICAgICogQ3JlYXRlcyB0aGUgQ2F0YWxvZ3VlIERhdGEgT2JqZWN0CiAgICAgKiBAcGFyYW0gZ3VpZCAtIEdsb2JhbCBVbmlxdWUgaWRlbnRpZmllciBvZiB0aGUgQ2F0YWxvZ3VlIE9iamVjdCAoZS5nLiBIeXBlcnR5IGRlc2NyaXB0b3IsIFByb3RvY29sU3R1YiBkZXNjcmlwdG9yLAogICAgICogZXRjKSBlbmFibGluZyB0aGUgc2FtZSBvYmplY3QgdG8gYmUgc3RvcmVkIGFuZCBkaXNjb3ZlcmVkIGluIGRpZmZlcmVudCBDYXRhbG9ndWVzLiBUaGF0IG1lYW5zLCBndWlkIGNvcnJlc3BvbmRzIHRvCiAgICAgKiA8cmVzb3VyY2UtdHlwZS1pZD4gcGVyIEJORiBvZiBSZXNvdXJjZSBQYXRoLiBDb3VsZG4ndCB3ZSBoYXZlIHByb2JsZW1zIHdpdGggdG9vIGxvbmcgVVJMIHBhdGhzPwogICAgICogQHBhcmFtIHR5cGUgLSBpbmRpY2F0ZXMgdGhlIHR5cGUgb2YgQ2F0YWxvZ3VlIERhdGEgT2JqZWN0IGUuZy4gSHlwZXJ0eSwgUHJvdG9jb2xTdHViLCBldGMKICAgICAqIEBwYXJhbSBvYmplY3ROYW1lIC0gaHVtYW4tdW5kZXJzdGFuZGFibGUgbmFtZSBvZiB0aGUgY2F0YWxvZ3VlIG9iamVjdCBlLmcuICJNeSBBd2Vzb21lIEh5cGVydHkiCiAgICAgKiBAcGFyYW0gZGVzY3JpcHRpb24gLSBkZXNjcmlwdGlvbiBvZiB0aGUgc291cmNlIHBhY2thZ2UKICAgICAqIEBwYXJhbSBsYW5ndWFnZSAtIHRoZSBwcm9ncmFtbWluZyBsYW5ndWFnZSB1c2VkIGluIHRoZSBTb3VyY2VQYWNrYWdlLlNvdXJjZUNvZGUKICAgICAqIEBwYXJhbSBzb3VyY2VQYWNrYWdlVVJMIC0gQSBzdHJpbmcgY29udGFpbmluZyB0aGUgVVJMIGZyb20gd2hlcmUgdGhlIHNvdXJjZSBjb2RlIHBhY2thZ2Ugb2YgdGhlIGNvcnJlc3BvbmRpbmcKICAgICAqIGNhdGFsb2d1ZSBvYmplY3QsIGUuZy4gZGVwbG95YWJsZSBwYWNrYWdlcyBjb250YWluaW5nIGV4ZWN1dGFibGUgY29kZSBmb3IgSHlwZXJ0aWVzIG9yIFByb3RvU3R1YnMsIGNhbiBiZSBkb3dubG9hZGVkCiAgICAgKi8KCiAgICBmdW5jdGlvbiBDYXRhbG9ndWVEYXRhT2JqZWN0KGd1aWQsIHR5cGUsIG9iamVjdE5hbWUsIGRlc2NyaXB0aW9uLCBsYW5ndWFnZSwgc291cmNlUGFja2FnZVVSTCkgewogICAgICAgIF9jbGFzc0NhbGxDaGVjayh0aGlzLCBDYXRhbG9ndWVEYXRhT2JqZWN0KTsKCiAgICAgICAgdGhpcy5fZ3VpZCA9IGd1aWQ7CiAgICAgICAgdGhpcy5fdHlwZSA9IHR5cGU7CiAgICAgICAgdGhpcy5fb2JqZWN0TmFtZSA9IG9iamVjdE5hbWU7CiAgICAgICAgdGhpcy5fZGVzY3JpcHRpb24gPSBkZXNjcmlwdGlvbjsKICAgICAgICB0aGlzLl9sYW5ndWFnZSA9IGxhbmd1YWdlOwogICAgICAgIHRoaXMuX3NvdXJjZVBhY2thZ2VVUkwgPSBzb3VyY2VQYWNrYWdlVVJMOwoKICAgICAgICB0aGlzLl9zaWduYXR1cmUgPSBudWxsOwogICAgICAgIHRoaXMuX3NvdXJjZVBhY2thZ2UgPSBudWxsOwogICAgfQoKICAgIC8vIEdldHRlcnMKCiAgICBfY3JlYXRlQ2xhc3MoQ2F0YWxvZ3VlRGF0YU9iamVjdCwgW3sKICAgICAgICBrZXk6ICdndWlkJywKICAgICAgICBnZXQ6IGZ1bmN0aW9uIGdldCgpIHsKICAgICAgICAgICAgcmV0dXJuIHRoaXMuX2d1aWQ7CiAgICAgICAgfQogICAgfSwgewogICAgICAgIGtleTogJ3R5cGUnLAogICAgICAgIGdldDogZnVuY3Rpb24gZ2V0KCkgewogICAgICAgICAgICByZXR1cm4gdGhpcy5fdHlwZTsKICAgICAgICB9CiAgICB9LCB7CiAgICAgICAga2V5OiAnb2JqZWN0TmFtZScsCiAgICAgICAgZ2V0OiBmdW5jdGlvbiBnZXQoKSB7CiAgICAgICAgICAgIHJldHVybiB0aGlzLl9vYmplY3ROYW1lOwogICAgICAgIH0KICAgIH0sIHsKICAgICAgICBrZXk6ICdkZXNjcmlwdGlvbicsCiAgICAgICAgZ2V0OiBmdW5jdGlvbiBnZXQoKSB7CiAgICAgICAgICAgIHJldHVybiB0aGlzLl9kZXNjcmlwdGlvbjsKICAgICAgICB9CiAgICB9LCB7CiAgICAgICAga2V5OiAnbGFuZ3VhZ2UnLAogICAgICAgIGdldDogZnVuY3Rpb24gZ2V0KCkgewogICAgICAgICAgICByZXR1cm4gdGhpcy5fbGFuZ3VhZ2U7CiAgICAgICAgfQogICAgfSwgewogICAgICAgIGtleTogJ3NpZ25hdHVyZScsCiAgICAgICAgZ2V0OiBmdW5jdGlvbiBnZXQoKSB7CiAgICAgICAgICAgIHJldHVybiB0aGlzLl9zaWduYXR1cmU7CiAgICAgICAgfSwKCiAgICAgICAgLy8gU2V0dGVycwogICAgICAgIC8qKgogICAgICAgICAqIFNldCB0aGUgc2lnbmF0dXJlIHRvIGVuYWJsZXMgaW50ZWdyaXR5IGFuZCBhdXRoZW50aWNpdHkgdmVyaWZpY2F0aW9uCiAgICAgICAgICogQHBhcmFtIHNpZ25hdHVyZQogICAgICAgICAqLwogICAgICAgIHNldDogZnVuY3Rpb24gc2V0KHNpZ25hdHVyZSkgewogICAgICAgICAgICBpZiAoc2lnbmF0dXJlKSB0aGlzLl9zaWduYXR1cmUgPSBzaWduYXR1cmU7CiAgICAgICAgfQogICAgfSwgewogICAgICAgIGtleTogJ3NvdXJjZVBhY2thZ2UnLAogICAgICAgIGdldDogZnVuY3Rpb24gZ2V0KCkgewogICAgICAgICAgICByZXR1cm4gdGhpcy5fc291cmNlUGFja2FnZTsKICAgICAgICB9LAogICAgICAgIHNldDogZnVuY3Rpb24gc2V0KHNyY1BhY2thZ2UpIHsKICAgICAgICAgICAgaWYgKHNyY1BhY2thZ2UpIHRoaXMuX3NvdXJjZVBhY2thZ2UgPSBzcmNQYWNrYWdlOwogICAgICAgIH0KICAgIH0sIHsKICAgICAgICBrZXk6ICdzb3VyY2VQYWNrYWdlVVJMJywKICAgICAgICBnZXQ6IGZ1bmN0aW9uIGdldCgpIHsKICAgICAgICAgICAgcmV0dXJuIHRoaXMuX3NvdXJjZVBhY2thZ2VVUkw7CiAgICAgICAgfQogICAgfV0pOwoKICAgIHJldHVybiBDYXRhbG9ndWVEYXRhT2JqZWN0Owp9KSgpOwoKdmFyIENhdGFsb2d1ZU9iamVjdFR5cGUgPSB7CiAgICBIWVBFUlRZOiAnaHlwZXJ0eScsIFBST1RPU1RVQjogJ3Byb3Rvc3R1YicsIEhZUEVSVFlfUlVOVElNRTogJ2h5cGVydHlfcnVudGltZScsCiAgICBIWVBFUlRZX0lOVEVSQ0VQVE9SOiAnaHlwZXJ0eV9pbnNwZWN0b3InLCBIWVBFUlRZX0RBVEFfT0JKRUNUOiAnaHlwZXJ0eV9kYXRhX29iamVjdCcsCiAgICBQT0xJQ1lfRU5GT1JDRVI6ICdwb2xpY3lfZW5mb3JjZXInCn07CmV4cG9ydHMuQ2F0YWxvZ3VlT2JqZWN0VHlwZSA9IENhdGFsb2d1ZU9iamVjdFR5cGU7CnZhciBEYXRhT2JqZWN0U291cmNlTGFuZ3VhZ2UgPSB7CiAgICBKQVZBU0NSSVBUX0VDTUE2OiAnamF2YXNjcmlwdF9lY21hNicsIEpBVkFTQ1JJUFRfRUNNQTU6ICdqYXZhc2NyaXB0X2VjbWE1JywKICAgIEpTT05fU0NIRU1BX1Y0OiAnanNvbl9zY2hlbWFfdjQnLCBQWVRIT046ICdweXRob24nLCBUWVBFU0NSSVBUOiAndHlwZXNjcmlwdCcKfTsKZXhwb3J0cy5EYXRhT2JqZWN0U291cmNlTGFuZ3VhZ2UgPSBEYXRhT2JqZWN0U291cmNlTGFuZ3VhZ2U7CmV4cG9ydHNbJ2RlZmF1bHQnXSA9IENhdGFsb2d1ZURhdGFPYmplY3Q7Cgp9LHt9XSw1OltmdW5jdGlvbihyZXF1aXJlLG1vZHVsZSxleHBvcnRzKXsKJ3VzZSBzdHJpY3QnOwoKT2JqZWN0LmRlZmluZVByb3BlcnR5KGV4cG9ydHMsICdfX2VzTW9kdWxlJywgewogICAgdmFsdWU6IHRydWUKfSk7Cgp2YXIgX2NyZWF0ZUNsYXNzID0gKGZ1bmN0aW9uICgpIHsgZnVuY3Rpb24gZGVmaW5lUHJvcGVydGllcyh0YXJnZXQsIHByb3BzKSB7IGZvciAodmFyIGkgPSAwOyBpIDwgcHJvcHMubGVuZ3RoOyBpKyspIHsgdmFyIGRlc2NyaXB0b3IgPSBwcm9wc1tpXTsgZGVzY3JpcHRvci5lbnVtZXJhYmxlID0gZGVzY3JpcHRvci5lbnVtZXJhYmxlIHx8IGZhbHNlOyBkZXNjcmlwdG9yLmNvbmZpZ3VyYWJsZSA9IHRydWU7IGlmICgndmFsdWUnIGluIGRlc2NyaXB0b3IpIGRlc2NyaXB0b3Iud3JpdGFibGUgPSB0cnVlOyBPYmplY3QuZGVmaW5lUHJvcGVydHkodGFyZ2V0LCBkZXNjcmlwdG9yLmtleSwgZGVzY3JpcHRvcik7IH0gfSByZXR1cm4gZnVuY3Rpb24gKENvbnN0cnVjdG9yLCBwcm90b1Byb3BzLCBzdGF0aWNQcm9wcykgeyBpZiAocHJvdG9Qcm9wcykgZGVmaW5lUHJvcGVydGllcyhDb25zdHJ1Y3Rvci5wcm90b3R5cGUsIHByb3RvUHJvcHMpOyBpZiAoc3RhdGljUHJvcHMpIGRlZmluZVByb3BlcnRpZXMoQ29uc3RydWN0b3IsIHN0YXRpY1Byb3BzKTsgcmV0dXJuIENvbnN0cnVjdG9yOyB9OyB9KSgpOwoKdmFyIF9nZXQgPSBmdW5jdGlvbiBnZXQoX3gsIF94MiwgX3gzKSB7IHZhciBfYWdhaW4gPSB0cnVlOyBfZnVuY3Rpb246IHdoaWxlIChfYWdhaW4pIHsgdmFyIG9iamVjdCA9IF94LCBwcm9wZXJ0eSA9IF94MiwgcmVjZWl2ZXIgPSBfeDM7IF9hZ2FpbiA9IGZhbHNlOyBpZiAob2JqZWN0ID09PSBudWxsKSBvYmplY3QgPSBGdW5jdGlvbi5wcm90b3R5cGU7IHZhciBkZXNjID0gT2JqZWN0LmdldE93blByb3BlcnR5RGVzY3JpcHRvcihvYmplY3QsIHByb3BlcnR5KTsgaWYgKGRlc2MgPT09IHVuZGVmaW5lZCkgeyB2YXIgcGFyZW50ID0gT2JqZWN0LmdldFByb3RvdHlwZU9mKG9iamVjdCk7IGlmIChwYXJlbnQgPT09IG51bGwpIHsgcmV0dXJuIHVuZGVmaW5lZDsgfSBlbHNlIHsgX3ggPSBwYXJlbnQ7IF94MiA9IHByb3BlcnR5OyBfeDMgPSByZWNlaXZlcjsgX2FnYWluID0gdHJ1ZTsgZGVzYyA9IHBhcmVudCA9IHVuZGVmaW5lZDsgY29udGludWUgX2Z1bmN0aW9uOyB9IH0gZWxzZSBpZiAoJ3ZhbHVlJyBpbiBkZXNjKSB7IHJldHVybiBkZXNjLnZhbHVlOyB9IGVsc2UgeyB2YXIgZ2V0dGVyID0gZGVzYy5nZXQ7IGlmIChnZXR0ZXIgPT09IHVuZGVmaW5lZCkgeyByZXR1cm4gdW5kZWZpbmVkOyB9IHJldHVybiBnZXR0ZXIuY2FsbChyZWNlaXZlcik7IH0gfSB9OwoKZnVuY3Rpb24gX2ludGVyb3BSZXF1aXJlRGVmYXVsdChvYmopIHsgcmV0dXJuIG9iaiAmJiBvYmouX19lc01vZHVsZSA/IG9iaiA6IHsgJ2RlZmF1bHQnOiBvYmogfTsgfQoKZnVuY3Rpb24gX2NsYXNzQ2FsbENoZWNrKGluc3RhbmNlLCBDb25zdHJ1Y3RvcikgeyBpZiAoIShpbnN0YW5jZSBpbnN0YW5jZW9mIENvbnN0cnVjdG9yKSkgeyB0aHJvdyBuZXcgVHlwZUVycm9yKCdDYW5ub3QgY2FsbCBhIGNsYXNzIGFzIGEgZnVuY3Rpb24nKTsgfSB9CgpmdW5jdGlvbiBfaW5oZXJpdHMoc3ViQ2xhc3MsIHN1cGVyQ2xhc3MpIHsgaWYgKHR5cGVvZiBzdXBlckNsYXNzICE9PSAnZnVuY3Rpb24nICYmIHN1cGVyQ2xhc3MgIT09IG51bGwpIHsgdGhyb3cgbmV3IFR5cGVFcnJvcignU3VwZXIgZXhwcmVzc2lvbiBtdXN0IGVpdGhlciBiZSBudWxsIG9yIGEgZnVuY3Rpb24sIG5vdCAnICsgdHlwZW9mIHN1cGVyQ2xhc3MpOyB9IHN1YkNsYXNzLnByb3RvdHlwZSA9IE9iamVjdC5jcmVhdGUoc3VwZXJDbGFzcyAmJiBzdXBlckNsYXNzLnByb3RvdHlwZSwgeyBjb25zdHJ1Y3RvcjogeyB2YWx1ZTogc3ViQ2xhc3MsIGVudW1lcmFibGU6IGZhbHNlLCB3cml0YWJsZTogdHJ1ZSwgY29uZmlndXJhYmxlOiB0cnVlIH0gfSk7IGlmIChzdXBlckNsYXNzKSBPYmplY3Quc2V0UHJvdG90eXBlT2YgPyBPYmplY3Quc2V0UHJvdG90eXBlT2Yoc3ViQ2xhc3MsIHN1cGVyQ2xhc3MpIDogc3ViQ2xhc3MuX19wcm90b19fID0gc3VwZXJDbGFzczsgfQoKdmFyIF9yZVRISU5LT2JqZWN0UmV0aGlua09iamVjdCA9IHJlcXVpcmUoJy4uL3JlVEhJTktPYmplY3QvUmV0aGlua09iamVjdCcpOwoKdmFyIF9yZVRISU5LT2JqZWN0UmV0aGlua09iamVjdDIgPSBfaW50ZXJvcFJlcXVpcmVEZWZhdWx0KF9yZVRISU5LT2JqZWN0UmV0aGlua09iamVjdCk7Cgp2YXIgX0NhdGFsb2d1ZURhdGFPYmplY3QgPSByZXF1aXJlKCcuL0NhdGFsb2d1ZURhdGFPYmplY3QnKTsKCnZhciBfQ2F0YWxvZ3VlRGF0YU9iamVjdDIgPSBfaW50ZXJvcFJlcXVpcmVEZWZhdWx0KF9DYXRhbG9ndWVEYXRhT2JqZWN0KTsKCnZhciBfU291cmNlUGFja2FnZSA9IHJlcXVpcmUoJy4vU291cmNlUGFja2FnZScpOwoKdmFyIF9Tb3VyY2VQYWNrYWdlMiA9IF9pbnRlcm9wUmVxdWlyZURlZmF1bHQoX1NvdXJjZVBhY2thZ2UpOwoKdmFyIF9IeXBlcnR5RGVzY3JpcHRvciA9IHJlcXVpcmUoJy4vSHlwZXJ0eURlc2NyaXB0b3InKTsKCnZhciBfSHlwZXJ0eURlc2NyaXB0b3IyID0gX2ludGVyb3BSZXF1aXJlRGVmYXVsdChfSHlwZXJ0eURlc2NyaXB0b3IpOwoKdmFyIF9Qcm90b2NvbFN0dWJEZXNjcmlwdG9yID0gcmVxdWlyZSgnLi9Qcm90b2NvbFN0dWJEZXNjcmlwdG9yJyk7Cgp2YXIgX1Byb3RvY29sU3R1YkRlc2NyaXB0b3IyID0gX2ludGVyb3BSZXF1aXJlRGVmYXVsdChfUHJvdG9jb2xTdHViRGVzY3JpcHRvcik7Cgp2YXIgX0h5cGVydHlSdW50aW1lRGVzY3JpcHRvciA9IHJlcXVpcmUoJy4vSHlwZXJ0eVJ1bnRpbWVEZXNjcmlwdG9yJyk7Cgp2YXIgX0h5cGVydHlSdW50aW1lRGVzY3JpcHRvcjIgPSBfaW50ZXJvcFJlcXVpcmVEZWZhdWx0KF9IeXBlcnR5UnVudGltZURlc2NyaXB0b3IpOwoKdmFyIF9Qb2xpY3lFbmZvcmNlckRlc2NyaXB0b3IgPSByZXF1aXJlKCcuL1BvbGljeUVuZm9yY2VyRGVzY3JpcHRvcicpOwoKdmFyIF9Qb2xpY3lFbmZvcmNlckRlc2NyaXB0b3IyID0gX2ludGVyb3BSZXF1aXJlRGVmYXVsdChfUG9saWN5RW5mb3JjZXJEZXNjcmlwdG9yKTsKCnZhciBfRGF0YU9iamVjdFNjaGVtYSA9IHJlcXVpcmUoJy4vRGF0YU9iamVjdFNjaGVtYScpOwoKdmFyIF9EYXRhT2JqZWN0U2NoZW1hMiA9IF9pbnRlcm9wUmVxdWlyZURlZmF1bHQoX0RhdGFPYmplY3RTY2hlbWEpOwoKdmFyIENhdGFsb2d1ZURhdGFPYmplY3RGYWN0b3J5ID0gKGZ1bmN0aW9uIChfUmV0aGlua09iamVjdCkgewogICAgX2luaGVyaXRzKENhdGFsb2d1ZURhdGFPYmplY3RGYWN0b3J5LCBfUmV0aGlua09iamVjdCk7CgogICAgLyoqCiAgICAgKiBDb25zdHJ1Y3RvcgogICAgICogQHBhcmFtIHtib29sZWFufSB2YWxpZGF0aW9uCiAgICAgKiBAcGFyYW0ge1VSTC5VUkwgfSBzY2hlbWEgLSBsaW5rIHRvIHRoZSBzY2hlbWEKICAgICAqLwoKICAgIGZ1bmN0aW9uIENhdGFsb2d1ZURhdGFPYmplY3RGYWN0b3J5KHZhbGlkYXRpb24sIHNjaGVtYSkgewogICAgICAgIF9jbGFzc0NhbGxDaGVjayh0aGlzLCBDYXRhbG9ndWVEYXRhT2JqZWN0RmFjdG9yeSk7CgogICAgICAgIF9nZXQoT2JqZWN0LmdldFByb3RvdHlwZU9mKENhdGFsb2d1ZURhdGFPYmplY3RGYWN0b3J5LnByb3RvdHlwZSksICdjb25zdHJ1Y3RvcicsIHRoaXMpLmNhbGwodGhpcywgdmFsaWRhdGlvbiwgc2NoZW1hKTsKICAgIH0KCiAgICBfY3JlYXRlQ2xhc3MoQ2F0YWxvZ3VlRGF0YU9iamVjdEZhY3RvcnksIFt7CiAgICAgICAga2V5OiAnY3JlYXRlQ2F0YWxvZ3VlRGF0YU9iamVjdCcsCiAgICAgICAgdmFsdWU6IGZ1bmN0aW9uIGNyZWF0ZUNhdGFsb2d1ZURhdGFPYmplY3QodHlwZSwgb2JqZWN0TmFtZSwgZGVzY3JpcHRpb24sIGxhbmd1YWdlLCBzb3VyY2VQYWNrYWdlVVJMKSB7CiAgICAgICAgICAgIGlmICh0eXBlb2YgdHlwZSA9PT0gInVuZGVmaW5lZCIgfHwgdHlwZW9mIG9iamVjdE5hbWUgPT09ICJ1bmRlZmluZWQiIHx8IHR5cGVvZiBkZXNjcmlwdGlvbiA9PT0gInVuZGVmaW5lZCIgfHwgdHlwZW9mIGxhbmd1YWdlID09PSAidW5kZWZpbmVkIiB8fCB0eXBlb2Ygc291cmNlUGFja2FnZVVSTCA9PT0gInVuZGVmaW5lZCIpIHRocm93IG5ldyBFcnJvcigiSW52YWxpZCBwYXJhbWV0ZXJzISIpOwogICAgICAgICAgICByZXR1cm4gbmV3IF9DYXRhbG9ndWVEYXRhT2JqZWN0MlsnZGVmYXVsdCddKHRoaXMuX2dlbmVyYXRlR3VpZCgpLCB0eXBlLCBvYmplY3ROYW1lLCBkZXNjcmlwdGlvbiwgbGFuZ3VhZ2UsIHNvdXJjZVBhY2thZ2VVUkwpOwogICAgICAgIH0KICAgIH0sIHsKICAgICAgICBrZXk6ICdjcmVhdGVIeXBlcnR5RGVzY3JpcHRvck9iamVjdCcsCiAgICAgICAgdmFsdWU6IGZ1bmN0aW9uIGNyZWF0ZUh5cGVydHlEZXNjcmlwdG9yT2JqZWN0KG9iamVjdE5hbWUsIGRlc2NyaXB0aW9uLCBsYW5ndWFnZSwgc291cmNlUGFja2FnZVVSTCwgaHlwZXJ0eVR5cGUsIGRhdGFPYmplY3RzKSB7CiAgICAgICAgICAgIGlmICh0eXBlb2Ygb2JqZWN0TmFtZSA9PT0gInVuZGVmaW5lZCIgfHwgdHlwZW9mIGRlc2NyaXB0aW9uID09PSAidW5kZWZpbmVkIiB8fCB0eXBlb2YgbGFuZ3VhZ2UgPT09ICJ1bmRlZmluZWQiIHx8IHR5cGVvZiBzb3VyY2VQYWNrYWdlVVJMID09PSAidW5kZWZpbmVkIiB8fCB0eXBlb2YgaHlwZXJ0eVR5cGUgPT09ICJ1bmRlZmluZWQiIHx8IHR5cGVvZiBkYXRhT2JqZWN0cyA9PT0gInVuZGVmaW5lZCIpIHRocm93IG5ldyBFcnJvcigiSW52YWxpZCBwYXJhbWV0ZXJzISIpOwogICAgICAgICAgICByZXR1cm4gbmV3IF9IeXBlcnR5RGVzY3JpcHRvcjJbJ2RlZmF1bHQnXSh0aGlzLl9nZW5lcmF0ZUd1aWQoKSwgX0NhdGFsb2d1ZURhdGFPYmplY3QuQ2F0YWxvZ3VlT2JqZWN0VHlwZS5IWVBFUlRZLCBvYmplY3ROYW1lLCBkZXNjcmlwdGlvbiwgbGFuZ3VhZ2UsIHNvdXJjZVBhY2thZ2VVUkwsIGh5cGVydHlUeXBlLCBkYXRhT2JqZWN0cyk7CiAgICAgICAgfQogICAgfSwgewogICAgICAgIGtleTogJ2NyZWF0ZVByb3RvU3R1YkRlc2NyaXB0b3JPYmplY3QnLAogICAgICAgIHZhbHVlOiBmdW5jdGlvbiBjcmVhdGVQcm90b1N0dWJEZXNjcmlwdG9yT2JqZWN0KG9iamVjdE5hbWUsIGRlc2NyaXB0aW9uLCBsYW5ndWFnZSwgc291cmNlUGFja2FnZVVSTCwgbWVzc2FnZVNjaGVtYXMsIGNvbmZpZ3VyYXRpb25MaXN0LCBjb25zdHJhaW50TGlzdCkgewogICAgICAgICAgICBpZiAodHlwZW9mIG9iamVjdE5hbWUgPT09ICJ1bmRlZmluZWQiIHx8IHR5cGVvZiBkZXNjcmlwdGlvbiA9PT0gInVuZGVmaW5lZCIgfHwgdHlwZW9mIGxhbmd1YWdlID09PSAidW5kZWZpbmVkIiB8fCB0eXBlb2Ygc291cmNlUGFja2FnZVVSTCA9PT0gInVuZGVmaW5lZCIgfHwgdHlwZW9mIG1lc3NhZ2VTY2hlbWFzID09PSAidW5kZWZpbmVkIiB8fCB0eXBlb2YgY29uZmlndXJhdGlvbkxpc3QgPT09ICJ1bmRlZmluZWQiIHx8IHR5cGVvZiBjb25zdHJhaW50TGlzdCA9PT0gInVuZGVmaW5lZCIpIHRocm93IG5ldyBFcnJvcigiSW52YWxpZCBwYXJhbWV0ZXJzISIpOwogICAgICAgICAgICByZXR1cm4gbmV3IF9Qcm90b2NvbFN0dWJEZXNjcmlwdG9yMlsnZGVmYXVsdCddKHRoaXMuX2dlbmVyYXRlR3VpZCgpLCBfQ2F0YWxvZ3VlRGF0YU9iamVjdC5DYXRhbG9ndWVPYmplY3RUeXBlLlBST1RPU1RVQiwgb2JqZWN0TmFtZSwgZGVzY3JpcHRpb24sIGxhbmd1YWdlLCBzb3VyY2VQYWNrYWdlVVJMLCBtZXNzYWdlU2NoZW1hcywgY29uZmlndXJhdGlvbkxpc3QsIGNvbnN0cmFpbnRMaXN0KTsKICAgICAgICB9CiAgICB9LCB7CiAgICAgICAga2V5OiAnY3JlYXRlSHlwZXJ0eVJ1bnRpbWVEZXNjcmlwdG9yT2JqZWN0JywKICAgICAgICB2YWx1ZTogZnVuY3Rpb24gY3JlYXRlSHlwZXJ0eVJ1bnRpbWVEZXNjcmlwdG9yT2JqZWN0KG9iamVjdE5hbWUsIGRlc2NyaXB0aW9uLCBsYW5ndWFnZSwgc291cmNlUGFja2FnZVVSTCwgcnVudGltZVR5cGUsIGh5cGVydHlDYXBhYmlsaXRpZXMsIHByb3RvY29sQ2FwYWJpbGl0aWVzKSB7CiAgICAgICAgICAgIGlmICh0eXBlb2Ygb2JqZWN0TmFtZSA9PT0gInVuZGVmaW5lZCIgfHwgdHlwZW9mIGRlc2NyaXB0aW9uID09PSAidW5kZWZpbmVkIiB8fCB0eXBlb2YgbGFuZ3VhZ2UgPT09ICJ1bmRlZmluZWQiIHx8IHR5cGVvZiBzb3VyY2VQYWNrYWdlVVJMID09PSAidW5kZWZpbmVkIiB8fCB0eXBlb2YgcnVudGltZVR5cGUgPT09ICJ1bmRlZmluZWQiIHx8IHR5cGVvZiBoeXBlcnR5Q2FwYWJpbGl0aWVzID09PSAidW5kZWZpbmVkIiB8fCB0eXBlb2YgcHJvdG9jb2xDYXBhYmlsaXRpZXMgPT09ICJ1bmRlZmluZWQiKSB0aHJvdyBuZXcgRXJyb3IoIkludmFsaWQgcGFyYW1ldGVycyEiKTsKCiAgICAgICAgICAgIHJldHVybiBuZXcgX0h5cGVydHlSdW50aW1lRGVzY3JpcHRvcjJbJ2RlZmF1bHQnXSh0aGlzLl9nZW5lcmF0ZUd1aWQoKSwgX0NhdGFsb2d1ZURhdGFPYmplY3QuQ2F0YWxvZ3VlT2JqZWN0VHlwZS5IWVBFUlRZX1JVTlRJTUUsIG9iamVjdE5hbWUsIGRlc2NyaXB0aW9uLCBsYW5ndWFnZSwgc291cmNlUGFja2FnZVVSTCwgcnVudGltZVR5cGUsIGh5cGVydHlDYXBhYmlsaXRpZXMsIHByb3RvY29sQ2FwYWJpbGl0aWVzKTsKICAgICAgICB9CiAgICB9LCB7CiAgICAgICAga2V5OiAnY3JlYXRlUG9saWN5RW5mb3JjZXJEZXNjcmlwdG9yT2JqZWN0JywKICAgICAgICB2YWx1ZTogZnVuY3Rpb24gY3JlYXRlUG9saWN5RW5mb3JjZXJEZXNjcmlwdG9yT2JqZWN0KG9iamVjdE5hbWUsIGRlc2NyaXB0aW9uLCBsYW5ndWFnZSwgc291cmNlUGFja2FnZVVSTCwgY29uZmlndXJhdGlvbiwgcG9saWNpZXMpIHsKICAgICAgICAgICAgaWYgKHR5cGVvZiBvYmplY3ROYW1lID09PSAidW5kZWZpbmVkIiB8fCB0eXBlb2YgZGVzY3JpcHRpb24gPT09ICJ1bmRlZmluZWQiIHx8IHR5cGVvZiBsYW5ndWFnZSA9PT0gInVuZGVmaW5lZCIgfHwgdHlwZW9mIHNvdXJjZVBhY2thZ2VVUkwgPT09ICJ1bmRlZmluZWQiIHx8IHR5cGVvZiBjb25maWd1cmF0aW9uID09PSAidW5kZWZpbmVkIiB8fCB0eXBlb2YgcG9saWNpZXMgPT09ICJ1bmRlZmluZWQiKSB0aHJvdyBuZXcgRXJyb3IoIkludmFsaWQgcGFyYW1ldGVycyEiKTsKCiAgICAgICAgICAgIHJldHVybiBuZXcgX1BvbGljeUVuZm9yY2VyRGVzY3JpcHRvcjJbJ2RlZmF1bHQnXSh0aGlzLl9nZW5lcmF0ZUd1aWQoKSwgX0NhdGFsb2d1ZURhdGFPYmplY3QuQ2F0YWxvZ3VlT2JqZWN0VHlwZS5QT0xJQ1lfRU5GT1JDRVIsIG9iamVjdE5hbWUsIGRlc2NyaXB0aW9uLCBsYW5ndWFnZSwgc291cmNlUGFja2FnZVVSTCwgY29uZmlndXJhdGlvbiwgcG9saWNpZXMpOwogICAgICAgIH0KICAgIH0sIHsKICAgICAgICBrZXk6ICdjcmVhdGVEYXRhT2JqZWN0U2NoZW1hJywKICAgICAgICB2YWx1ZTogZnVuY3Rpb24gY3JlYXRlRGF0YU9iamVjdFNjaGVtYSh0eXBlLCBvYmplY3ROYW1lLCBkZXNjcmlwdGlvbiwgbGFuZ3VhZ2UsIHNvdXJjZVBhY2thZ2VVUkwpIHsKICAgICAgICAgICAgaWYgKHR5cGVvZiB0eXBlID09PSAidW5kZWZpbmVkIiB8fCB0eXBlb2Ygb2JqZWN0TmFtZSA9PT0gInVuZGVmaW5lZCIgfHwgdHlwZW9mIGRlc2NyaXB0aW9uID09PSAidW5kZWZpbmVkIiB8fCB0eXBlb2YgbGFuZ3VhZ2UgPT09ICJ1bmRlZmluZWQiIHx8IHR5cGVvZiBzb3VyY2VQYWNrYWdlVVJMID09PSAidW5kZWZpbmVkIikgdGhyb3cgbmV3IEVycm9yKCJJbnZhbGlkIHBhcmFtZXRlcnMhIik7CgogICAgICAgICAgICByZXR1cm4gbmV3IF9EYXRhT2JqZWN0U2NoZW1hMlsnZGVmYXVsdCddKHRoaXMuX2dlbmVyYXRlR3VpZCgpLCB0eXBlLCBvYmplY3ROYW1lLCBkZXNjcmlwdGlvbiwgbGFuZ3VhZ2UsIHNvdXJjZVBhY2thZ2VVUkwpOwogICAgICAgIH0KICAgIH0sIHsKICAgICAgICBrZXk6ICdjcmVhdGVTb3VyY2VQYWNrYWdlJywKICAgICAgICB2YWx1ZTogZnVuY3Rpb24gY3JlYXRlU291cmNlUGFja2FnZShzb3VyY2VDb2RlLCBzb3VyY2VDb2RlQ2xhc3NuYW1lKSB7CiAgICAgICAgICAgIGlmICh0eXBlb2Ygc291cmNlQ29kZSA9PT0gInVuZGVmaW5lZCIgfHwgdHlwZW9mIHNvdXJjZUNvZGVDbGFzc25hbWUgPT09ICJ1bmRlZmluZWQiKSB0aHJvdyBuZXcgRXJyb3IoIkludmFsaWQgcGFyYW1ldGVycyEiKTsKCiAgICAgICAgICAgIHJldHVybiBuZXcgX1NvdXJjZVBhY2thZ2UyWydkZWZhdWx0J10oc291cmNlQ29kZSwgc291cmNlQ29kZUNsYXNzbmFtZSk7CiAgICAgICAgfQogICAgfSwgewogICAgICAgIGtleTogJ19nZW5lcmF0ZUd1aWQnLAogICAgICAgIHZhbHVlOiBmdW5jdGlvbiBfZ2VuZXJhdGVHdWlkKCkgewogICAgICAgICAgICB2YXIgZCA9IG5ldyBEYXRlKCkuZ2V0VGltZSgpOwoKICAgICAgICAgICAgcmV0dXJuICd4eHh4eHh4eC14eHh4LTR4eHgteXh4eC14eHh4eHh4eHh4eHgnLnJlcGxhY2UoL1t4eV0vZywgZnVuY3Rpb24gKGMpIHsKICAgICAgICAgICAgICAgIHZhciByID0gKGQgKyBNYXRoLnJhbmRvbSgpICogMTYpICUgMTYgfCAwOwogICAgICAgICAgICAgICAgZCA9IE1hdGguZmxvb3IoZCAvIDE2KTsKICAgICAgICAgICAgICAgIHJldHVybiAoYyA9PSAneCcgPyByIDogciAmIDB4MyB8IDB4OCkudG9TdHJpbmcoMTYpOwogICAgICAgICAgICB9KTsKICAgICAgICB9CiAgICB9XSk7CgogICAgcmV0dXJuIENhdGFsb2d1ZURhdGFPYmplY3RGYWN0b3J5Owp9KShfcmVUSElOS09iamVjdFJldGhpbmtPYmplY3QyWydkZWZhdWx0J10pOwoKZXhwb3J0c1snZGVmYXVsdCddID0gQ2F0YWxvZ3VlRGF0YU9iamVjdEZhY3Rvcnk7Cm1vZHVsZS5leHBvcnRzID0gZXhwb3J0c1snZGVmYXVsdCddOwoKfSx7Ii4uL3JlVEhJTktPYmplY3QvUmV0aGlua09iamVjdCI6MTcsIi4vQ2F0YWxvZ3VlRGF0YU9iamVjdCI6NCwiLi9EYXRhT2JqZWN0U2NoZW1hIjo2LCIuL0h5cGVydHlEZXNjcmlwdG9yIjo3LCIuL0h5cGVydHlSdW50aW1lRGVzY3JpcHRvciI6OCwiLi9Qb2xpY3lFbmZvcmNlckRlc2NyaXB0b3IiOjksIi4vUHJvdG9jb2xTdHViRGVzY3JpcHRvciI6MTAsIi4vU291cmNlUGFja2FnZSI6MTF9XSw2OltmdW5jdGlvbihyZXF1aXJlLG1vZHVsZSxleHBvcnRzKXsKLyoqCiAqIENyZWF0ZWQgYnkgcHp1IG9uIDE5LjExLjE1LgogKi8KCid1c2Ugc3RyaWN0JzsKCk9iamVjdC5kZWZpbmVQcm9wZXJ0eShleHBvcnRzLCAnX19lc01vZHVsZScsIHsKICAgIHZhbHVlOiB0cnVlCn0pOwoKdmFyIF9nZXQgPSBmdW5jdGlvbiBnZXQoX3gsIF94MiwgX3gzKSB7IHZhciBfYWdhaW4gPSB0cnVlOyBfZnVuY3Rpb246IHdoaWxlIChfYWdhaW4pIHsgdmFyIG9iamVjdCA9IF94LCBwcm9wZXJ0eSA9IF94MiwgcmVjZWl2ZXIgPSBfeDM7IF9hZ2FpbiA9IGZhbHNlOyBpZiAob2JqZWN0ID09PSBudWxsKSBvYmplY3QgPSBGdW5jdGlvbi5wcm90b3R5cGU7IHZhciBkZXNjID0gT2JqZWN0LmdldE93blByb3BlcnR5RGVzY3JpcHRvcihvYmplY3QsIHByb3BlcnR5KTsgaWYgKGRlc2MgPT09IHVuZGVmaW5lZCkgeyB2YXIgcGFyZW50ID0gT2JqZWN0LmdldFByb3RvdHlwZU9mKG9iamVjdCk7IGlmIChwYXJlbnQgPT09IG51bGwpIHsgcmV0dXJuIHVuZGVmaW5lZDsgfSBlbHNlIHsgX3ggPSBwYXJlbnQ7IF94MiA9IHByb3BlcnR5OyBfeDMgPSByZWNlaXZlcjsgX2FnYWluID0gdHJ1ZTsgZGVzYyA9IHBhcmVudCA9IHVuZGVmaW5lZDsgY29udGludWUgX2Z1bmN0aW9uOyB9IH0gZWxzZSBpZiAoJ3ZhbHVlJyBpbiBkZXNjKSB7IHJldHVybiBkZXNjLnZhbHVlOyB9IGVsc2UgeyB2YXIgZ2V0dGVyID0gZGVzYy5nZXQ7IGlmIChnZXR0ZXIgPT09IHVuZGVmaW5lZCkgeyByZXR1cm4gdW5kZWZpbmVkOyB9IHJldHVybiBnZXR0ZXIuY2FsbChyZWNlaXZlcik7IH0gfSB9OwoKZnVuY3Rpb24gX2ludGVyb3BSZXF1aXJlRGVmYXVsdChvYmopIHsgcmV0dXJuIG9iaiAmJiBvYmouX19lc01vZHVsZSA/IG9iaiA6IHsgJ2RlZmF1bHQnOiBvYmogfTsgfQoKZnVuY3Rpb24gX2NsYXNzQ2FsbENoZWNrKGluc3RhbmNlLCBDb25zdHJ1Y3RvcikgeyBpZiAoIShpbnN0YW5jZSBpbnN0YW5jZW9mIENvbnN0cnVjdG9yKSkgeyB0aHJvdyBuZXcgVHlwZUVycm9yKCdDYW5ub3QgY2FsbCBhIGNsYXNzIGFzIGEgZnVuY3Rpb24nKTsgfSB9CgpmdW5jdGlvbiBfaW5oZXJpdHMoc3ViQ2xhc3MsIHN1cGVyQ2xhc3MpIHsgaWYgKHR5cGVvZiBzdXBlckNsYXNzICE9PSAnZnVuY3Rpb24nICYmIHN1cGVyQ2xhc3MgIT09IG51bGwpIHsgdGhyb3cgbmV3IFR5cGVFcnJvcignU3VwZXIgZXhwcmVzc2lvbiBtdXN0IGVpdGhlciBiZSBudWxsIG9yIGEgZnVuY3Rpb24sIG5vdCAnICsgdHlwZW9mIHN1cGVyQ2xhc3MpOyB9IHN1YkNsYXNzLnByb3RvdHlwZSA9IE9iamVjdC5jcmVhdGUoc3VwZXJDbGFzcyAmJiBzdXBlckNsYXNzLnByb3RvdHlwZSwgeyBjb25zdHJ1Y3RvcjogeyB2YWx1ZTogc3ViQ2xhc3MsIGVudW1lcmFibGU6IGZhbHNlLCB3cml0YWJsZTogdHJ1ZSwgY29uZmlndXJhYmxlOiB0cnVlIH0gfSk7IGlmIChzdXBlckNsYXNzKSBPYmplY3Quc2V0UHJvdG90eXBlT2YgPyBPYmplY3Quc2V0UHJvdG90eXBlT2Yoc3ViQ2xhc3MsIHN1cGVyQ2xhc3MpIDogc3ViQ2xhc3MuX19wcm90b19fID0gc3VwZXJDbGFzczsgfQoKdmFyIF9DYXRhbG9ndWVEYXRhT2JqZWN0MiA9IHJlcXVpcmUoJy4vQ2F0YWxvZ3VlRGF0YU9iamVjdCcpOwoKdmFyIF9DYXRhbG9ndWVEYXRhT2JqZWN0MyA9IF9pbnRlcm9wUmVxdWlyZURlZmF1bHQoX0NhdGFsb2d1ZURhdGFPYmplY3QyKTsKCnZhciBEYXRhT2JqZWN0U2NoZW1hID0gKGZ1bmN0aW9uIChfQ2F0YWxvZ3VlRGF0YU9iamVjdCkgewogICAgX2luaGVyaXRzKERhdGFPYmplY3RTY2hlbWEsIF9DYXRhbG9ndWVEYXRhT2JqZWN0KTsKCiAgICBmdW5jdGlvbiBEYXRhT2JqZWN0U2NoZW1hKGd1aWQsIHR5cGUsIG9iamVjdE5hbWUsIGRlc2NyaXB0aW9uLCBsYW5ndWFnZSwgc291cmNlUGFja2FnZVVSTCkgewogICAgICAgIF9jbGFzc0NhbGxDaGVjayh0aGlzLCBEYXRhT2JqZWN0U2NoZW1hKTsKCiAgICAgICAgX2dldChPYmplY3QuZ2V0UHJvdG90eXBlT2YoRGF0YU9iamVjdFNjaGVtYS5wcm90b3R5cGUpLCAnY29uc3RydWN0b3InLCB0aGlzKS5jYWxsKHRoaXMsIGd1aWQsIHR5cGUsIG9iamVjdE5hbWUsIGRlc2NyaXB0aW9uLCBsYW5ndWFnZSwgc291cmNlUGFja2FnZVVSTCk7CiAgICB9CgogICAgLy9DaGlsZHJlbgogICAgcmV0dXJuIERhdGFPYmplY3RTY2hlbWE7Cn0pKF9DYXRhbG9ndWVEYXRhT2JqZWN0M1snZGVmYXVsdCddKTsKCnZhciBNZXNzYWdlRGF0YU9iamVjdFNjaGVtYSA9IChmdW5jdGlvbiAoX0RhdGFPYmplY3RTY2hlbWEpIHsKICAgIF9pbmhlcml0cyhNZXNzYWdlRGF0YU9iamVjdFNjaGVtYSwgX0RhdGFPYmplY3RTY2hlbWEpOwoKICAgIGZ1bmN0aW9uIE1lc3NhZ2VEYXRhT2JqZWN0U2NoZW1hKGd1aWQsIHR5cGUsIG9iamVjdE5hbWUsIGRlc2NyaXB0aW9uLCBsYW5ndWFnZSwgc291cmNlUGFja2FnZVVSTCkgewogICAgICAgIF9jbGFzc0NhbGxDaGVjayh0aGlzLCBNZXNzYWdlRGF0YU9iamVjdFNjaGVtYSk7CgogICAgICAgIF9nZXQoT2JqZWN0LmdldFByb3RvdHlwZU9mKE1lc3NhZ2VEYXRhT2JqZWN0U2NoZW1hLnByb3RvdHlwZSksICdjb25zdHJ1Y3RvcicsIHRoaXMpLmNhbGwodGhpcywgZ3VpZCwgdHlwZSwgb2JqZWN0TmFtZSwgZGVzY3JpcHRpb24sIGxhbmd1YWdlLCBzb3VyY2VQYWNrYWdlVVJMKTsKICAgIH0KCiAgICByZXR1cm4gTWVzc2FnZURhdGFPYmplY3RTY2hlbWE7Cn0pKERhdGFPYmplY3RTY2hlbWEpOwoKZXhwb3J0cy5NZXNzYWdlRGF0YU9iamVjdFNjaGVtYSA9IE1lc3NhZ2VEYXRhT2JqZWN0U2NoZW1hOwoKdmFyIEh5cGVydHlEYXRhT2JqZWN0U2NoZW1hID0gKGZ1bmN0aW9uIChfRGF0YU9iamVjdFNjaGVtYTIpIHsKICAgIF9pbmhlcml0cyhIeXBlcnR5RGF0YU9iamVjdFNjaGVtYSwgX0RhdGFPYmplY3RTY2hlbWEyKTsKCiAgICBmdW5jdGlvbiBIeXBlcnR5RGF0YU9iamVjdFNjaGVtYShndWlkLCB0eXBlLCBvYmplY3ROYW1lLCBkZXNjcmlwdGlvbiwgbGFuZ3VhZ2UsIHNvdXJjZVBhY2thZ2VVUkwsIGFjY2Vzc0NvbnRyb2xQb2xpY3kpIHsKICAgICAgICBfY2xhc3NDYWxsQ2hlY2sodGhpcywgSHlwZXJ0eURhdGFPYmplY3RTY2hlbWEpOwoKICAgICAgICBfZ2V0KE9iamVjdC5nZXRQcm90b3R5cGVPZihIeXBlcnR5RGF0YU9iamVjdFNjaGVtYS5wcm90b3R5cGUpLCAnY29uc3RydWN0b3InLCB0aGlzKS5jYWxsKHRoaXMsIGd1aWQsIHR5cGUsIG9iamVjdE5hbWUsIGRlc2NyaXB0aW9uLCBsYW5ndWFnZSwgc291cmNlUGFja2FnZVVSTCk7CiAgICAgICAgdGhpcy5fYWNjZXNzQ29udHJvbFBvbGljeSA9IGFjY2Vzc0NvbnRyb2xQb2xpY3k7CiAgICB9CgogICAgLy9DaGlsZHJlbgogICAgcmV0dXJuIEh5cGVydHlEYXRhT2JqZWN0U2NoZW1hOwp9KShEYXRhT2JqZWN0U2NoZW1hKTsKCmV4cG9ydHMuSHlwZXJ0eURhdGFPYmplY3RTY2hlbWEgPSBIeXBlcnR5RGF0YU9iamVjdFNjaGVtYTsKCnZhciBDb21tdW5pY2F0aW9uRGF0YU9iamVjdFNjaGVtYSA9IChmdW5jdGlvbiAoX0h5cGVydHlEYXRhT2JqZWN0U2NoZW1hKSB7CiAgICBfaW5oZXJpdHMoQ29tbXVuaWNhdGlvbkRhdGFPYmplY3RTY2hlbWEsIF9IeXBlcnR5RGF0YU9iamVjdFNjaGVtYSk7CgogICAgZnVuY3Rpb24gQ29tbXVuaWNhdGlvbkRhdGFPYmplY3RTY2hlbWEoZ3VpZCwgdHlwZSwgb2JqZWN0TmFtZSwgZGVzY3JpcHRpb24sIGxhbmd1YWdlLCBzb3VyY2VQYWNrYWdlVVJMLCBhY2Nlc3NDb250cm9sUG9saWN5KSB7CiAgICAgICAgX2NsYXNzQ2FsbENoZWNrKHRoaXMsIENvbW11bmljYXRpb25EYXRhT2JqZWN0U2NoZW1hKTsKCiAgICAgICAgX2dldChPYmplY3QuZ2V0UHJvdG90eXBlT2YoQ29tbXVuaWNhdGlvbkRhdGFPYmplY3RTY2hlbWEucHJvdG90eXBlKSwgJ2NvbnN0cnVjdG9yJywgdGhpcykuY2FsbCh0aGlzLCBndWlkLCB0eXBlLCBvYmplY3ROYW1lLCBkZXNjcmlwdGlvbiwgbGFuZ3VhZ2UsIHNvdXJjZVBhY2thZ2VVUkwsIGFjY2Vzc0NvbnRyb2xQb2xpY3kpOwogICAgfQoKICAgIHJldHVybiBDb21tdW5pY2F0aW9uRGF0YU9iamVjdFNjaGVtYTsKfSkoSHlwZXJ0eURhdGFPYmplY3RTY2hlbWEpOwoKZXhwb3J0cy5Db21tdW5pY2F0aW9uRGF0YU9iamVjdFNjaGVtYSA9IENvbW11bmljYXRpb25EYXRhT2JqZWN0U2NoZW1hOwoKdmFyIENvbm5lY3Rpb25EYXRhT2JqZWN0U2NoZW1hID0gKGZ1bmN0aW9uIChfSHlwZXJ0eURhdGFPYmplY3RTY2hlbWEyKSB7CiAgICBfaW5oZXJpdHMoQ29ubmVjdGlvbkRhdGFPYmplY3RTY2hlbWEsIF9IeXBlcnR5RGF0YU9iamVjdFNjaGVtYTIpOwoKICAgIGZ1bmN0aW9uIENvbm5lY3Rpb25EYXRhT2JqZWN0U2NoZW1hKGd1aWQsIHR5cGUsIG9iamVjdE5hbWUsIGRlc2NyaXB0aW9uLCBsYW5ndWFnZSwgc291cmNlUGFja2FnZVVSTCwgYWNjZXNzQ29udHJvbFBvbGljeSkgewogICAgICAgIF9jbGFzc0NhbGxDaGVjayh0aGlzLCBDb25uZWN0aW9uRGF0YU9iamVjdFNjaGVtYSk7CgogICAgICAgIF9nZXQoT2JqZWN0LmdldFByb3RvdHlwZU9mKENvbm5lY3Rpb25EYXRhT2JqZWN0U2NoZW1hLnByb3RvdHlwZSksICdjb25zdHJ1Y3RvcicsIHRoaXMpLmNhbGwodGhpcywgZ3VpZCwgdHlwZSwgb2JqZWN0TmFtZSwgZGVzY3JpcHRpb24sIGxhbmd1YWdlLCBzb3VyY2VQYWNrYWdlVVJMLCBhY2Nlc3NDb250cm9sUG9saWN5KTsKICAgIH0KCiAgICByZXR1cm4gQ29ubmVjdGlvbkRhdGFPYmplY3RTY2hlbWE7Cn0pKEh5cGVydHlEYXRhT2JqZWN0U2NoZW1hKTsKCmV4cG9ydHMuQ29ubmVjdGlvbkRhdGFPYmplY3RTY2hlbWEgPSBDb25uZWN0aW9uRGF0YU9iamVjdFNjaGVtYTsKCnZhciBJZGVudGlmeURhdGFPYmplY3RTY2hlbWEgPSAoZnVuY3Rpb24gKF9IeXBlcnR5RGF0YU9iamVjdFNjaGVtYTMpIHsKICAgIF9pbmhlcml0cyhJZGVudGlmeURhdGFPYmplY3RTY2hlbWEsIF9IeXBlcnR5RGF0YU9iamVjdFNjaGVtYTMpOwoKICAgIGZ1bmN0aW9uIElkZW50aWZ5RGF0YU9iamVjdFNjaGVtYShndWlkLCB0eXBlLCBvYmplY3ROYW1lLCBkZXNjcmlwdGlvbiwgbGFuZ3VhZ2UsIHNvdXJjZVBhY2thZ2VVUkwsIGFjY2Vzc0NvbnRyb2xQb2xpY3kpIHsKICAgICAgICBfY2xhc3NDYWxsQ2hlY2sodGhpcywgSWRlbnRpZnlEYXRhT2JqZWN0U2NoZW1hKTsKCiAgICAgICAgX2dldChPYmplY3QuZ2V0UHJvdG90eXBlT2YoSWRlbnRpZnlEYXRhT2JqZWN0U2NoZW1hLnByb3RvdHlwZSksICdjb25zdHJ1Y3RvcicsIHRoaXMpLmNhbGwodGhpcywgZ3VpZCwgdHlwZSwgb2JqZWN0TmFtZSwgZGVzY3JpcHRpb24sIGxhbmd1YWdlLCBzb3VyY2VQYWNrYWdlVVJMLCBhY2Nlc3NDb250cm9sUG9saWN5KTsKICAgIH0KCiAgICByZXR1cm4gSWRlbnRpZnlEYXRhT2JqZWN0U2NoZW1hOwp9KShIeXBlcnR5RGF0YU9iamVjdFNjaGVtYSk7CgpleHBvcnRzLklkZW50aWZ5RGF0YU9iamVjdFNjaGVtYSA9IElkZW50aWZ5RGF0YU9iamVjdFNjaGVtYTsKCnZhciBDb250ZXh0RGF0YU9iamVjdFNjaGVtYSA9IChmdW5jdGlvbiAoX0h5cGVydHlEYXRhT2JqZWN0U2NoZW1hNCkgewogICAgX2luaGVyaXRzKENvbnRleHREYXRhT2JqZWN0U2NoZW1hLCBfSHlwZXJ0eURhdGFPYmplY3RTY2hlbWE0KTsKCiAgICBmdW5jdGlvbiBDb250ZXh0RGF0YU9iamVjdFNjaGVtYShndWlkLCB0eXBlLCBvYmplY3ROYW1lLCBkZXNjcmlwdGlvbiwgbGFuZ3VhZ2UsIHNvdXJjZVBhY2thZ2VVUkwsIGFjY2Vzc0NvbnRyb2xQb2xpY3kpIHsKICAgICAgICBfY2xhc3NDYWxsQ2hlY2sodGhpcywgQ29udGV4dERhdGFPYmplY3RTY2hlbWEpOwoKICAgICAgICBfZ2V0KE9iamVjdC5nZXRQcm90b3R5cGVPZihDb250ZXh0RGF0YU9iamVjdFNjaGVtYS5wcm90b3R5cGUpLCAnY29uc3RydWN0b3InLCB0aGlzKS5jYWxsKHRoaXMsIGd1aWQsIHR5cGUsIG9iamVjdE5hbWUsIGRlc2NyaXB0aW9uLCBsYW5ndWFnZSwgc291cmNlUGFja2FnZVVSTCwgYWNjZXNzQ29udHJvbFBvbGljeSk7CiAgICB9CgogICAgcmV0dXJuIENvbnRleHREYXRhT2JqZWN0U2NoZW1hOwp9KShIeXBlcnR5RGF0YU9iamVjdFNjaGVtYSk7CgpleHBvcnRzLkNvbnRleHREYXRhT2JqZWN0U2NoZW1hID0gQ29udGV4dERhdGFPYmplY3RTY2hlbWE7CmV4cG9ydHNbJ2RlZmF1bHQnXSA9IERhdGFPYmplY3RTY2hlbWE7Cgp9LHsiLi9DYXRhbG9ndWVEYXRhT2JqZWN0Ijo0fV0sNzpbZnVuY3Rpb24ocmVxdWlyZSxtb2R1bGUsZXhwb3J0cyl7Ci8qKgogKiBDcmVhdGVkIGJ5IGFtbyBvbiAxNC8xMS8yMDE1LgogKi8KJ3VzZSBzdHJpY3QnOwoKT2JqZWN0LmRlZmluZVByb3BlcnR5KGV4cG9ydHMsICdfX2VzTW9kdWxlJywgewogICAgdmFsdWU6IHRydWUKfSk7Cgp2YXIgX2NyZWF0ZUNsYXNzID0gKGZ1bmN0aW9uICgpIHsgZnVuY3Rpb24gZGVmaW5lUHJvcGVydGllcyh0YXJnZXQsIHByb3BzKSB7IGZvciAodmFyIGkgPSAwOyBpIDwgcHJvcHMubGVuZ3RoOyBpKyspIHsgdmFyIGRlc2NyaXB0b3IgPSBwcm9wc1tpXTsgZGVzY3JpcHRvci5lbnVtZXJhYmxlID0gZGVzY3JpcHRvci5lbnVtZXJhYmxlIHx8IGZhbHNlOyBkZXNjcmlwdG9yLmNvbmZpZ3VyYWJsZSA9IHRydWU7IGlmICgndmFsdWUnIGluIGRlc2NyaXB0b3IpIGRlc2NyaXB0b3Iud3JpdGFibGUgPSB0cnVlOyBPYmplY3QuZGVmaW5lUHJvcGVydHkodGFyZ2V0LCBkZXNjcmlwdG9yLmtleSwgZGVzY3JpcHRvcik7IH0gfSByZXR1cm4gZnVuY3Rpb24gKENvbnN0cnVjdG9yLCBwcm90b1Byb3BzLCBzdGF0aWNQcm9wcykgeyBpZiAocHJvdG9Qcm9wcykgZGVmaW5lUHJvcGVydGllcyhDb25zdHJ1Y3Rvci5wcm90b3R5cGUsIHByb3RvUHJvcHMpOyBpZiAoc3RhdGljUHJvcHMpIGRlZmluZVByb3BlcnRpZXMoQ29uc3RydWN0b3IsIHN0YXRpY1Byb3BzKTsgcmV0dXJuIENvbnN0cnVjdG9yOyB9OyB9KSgpOwoKdmFyIF9nZXQgPSBmdW5jdGlvbiBnZXQoX3gsIF94MiwgX3gzKSB7IHZhciBfYWdhaW4gPSB0cnVlOyBfZnVuY3Rpb246IHdoaWxlIChfYWdhaW4pIHsgdmFyIG9iamVjdCA9IF94LCBwcm9wZXJ0eSA9IF94MiwgcmVjZWl2ZXIgPSBfeDM7IF9hZ2FpbiA9IGZhbHNlOyBpZiAob2JqZWN0ID09PSBudWxsKSBvYmplY3QgPSBGdW5jdGlvbi5wcm90b3R5cGU7IHZhciBkZXNjID0gT2JqZWN0LmdldE93blByb3BlcnR5RGVzY3JpcHRvcihvYmplY3QsIHByb3BlcnR5KTsgaWYgKGRlc2MgPT09IHVuZGVmaW5lZCkgeyB2YXIgcGFyZW50ID0gT2JqZWN0LmdldFByb3RvdHlwZU9mKG9iamVjdCk7IGlmIChwYXJlbnQgPT09IG51bGwpIHsgcmV0dXJuIHVuZGVmaW5lZDsgfSBlbHNlIHsgX3ggPSBwYXJlbnQ7IF94MiA9IHByb3BlcnR5OyBfeDMgPSByZWNlaXZlcjsgX2FnYWluID0gdHJ1ZTsgZGVzYyA9IHBhcmVudCA9IHVuZGVmaW5lZDsgY29udGludWUgX2Z1bmN0aW9uOyB9IH0gZWxzZSBpZiAoJ3ZhbHVlJyBpbiBkZXNjKSB7IHJldHVybiBkZXNjLnZhbHVlOyB9IGVsc2UgeyB2YXIgZ2V0dGVyID0gZGVzYy5nZXQ7IGlmIChnZXR0ZXIgPT09IHVuZGVmaW5lZCkgeyByZXR1cm4gdW5kZWZpbmVkOyB9IHJldHVybiBnZXR0ZXIuY2FsbChyZWNlaXZlcik7IH0gfSB9OwoKZnVuY3Rpb24gX2ludGVyb3BSZXF1aXJlRGVmYXVsdChvYmopIHsgcmV0dXJuIG9iaiAmJiBvYmouX19lc01vZHVsZSA/IG9iaiA6IHsgJ2RlZmF1bHQnOiBvYmogfTsgfQoKZnVuY3Rpb24gX2NsYXNzQ2FsbENoZWNrKGluc3RhbmNlLCBDb25zdHJ1Y3RvcikgeyBpZiAoIShpbnN0YW5jZSBpbnN0YW5jZW9mIENvbnN0cnVjdG9yKSkgeyB0aHJvdyBuZXcgVHlwZUVycm9yKCdDYW5ub3QgY2FsbCBhIGNsYXNzIGFzIGEgZnVuY3Rpb24nKTsgfSB9CgpmdW5jdGlvbiBfaW5oZXJpdHMoc3ViQ2xhc3MsIHN1cGVyQ2xhc3MpIHsgaWYgKHR5cGVvZiBzdXBlckNsYXNzICE9PSAnZnVuY3Rpb24nICYmIHN1cGVyQ2xhc3MgIT09IG51bGwpIHsgdGhyb3cgbmV3IFR5cGVFcnJvcignU3VwZXIgZXhwcmVzc2lvbiBtdXN0IGVpdGhlciBiZSBudWxsIG9yIGEgZnVuY3Rpb24sIG5vdCAnICsgdHlwZW9mIHN1cGVyQ2xhc3MpOyB9IHN1YkNsYXNzLnByb3RvdHlwZSA9IE9iamVjdC5jcmVhdGUoc3VwZXJDbGFzcyAmJiBzdXBlckNsYXNzLnByb3RvdHlwZSwgeyBjb25zdHJ1Y3RvcjogeyB2YWx1ZTogc3ViQ2xhc3MsIGVudW1lcmFibGU6IGZhbHNlLCB3cml0YWJsZTogdHJ1ZSwgY29uZmlndXJhYmxlOiB0cnVlIH0gfSk7IGlmIChzdXBlckNsYXNzKSBPYmplY3Quc2V0UHJvdG90eXBlT2YgPyBPYmplY3Quc2V0UHJvdG90eXBlT2Yoc3ViQ2xhc3MsIHN1cGVyQ2xhc3MpIDogc3ViQ2xhc3MuX19wcm90b19fID0gc3VwZXJDbGFzczsgfQoKdmFyIF9DYXRhbG9ndWVEYXRhT2JqZWN0MiA9IHJlcXVpcmUoJy4vQ2F0YWxvZ3VlRGF0YU9iamVjdCcpOwoKdmFyIF9DYXRhbG9ndWVEYXRhT2JqZWN0MyA9IF9pbnRlcm9wUmVxdWlyZURlZmF1bHQoX0NhdGFsb2d1ZURhdGFPYmplY3QyKTsKCnZhciBIeXBlcnR5RGVzY3JpcHRvciA9IChmdW5jdGlvbiAoX0NhdGFsb2d1ZURhdGFPYmplY3QpIHsKICAgIF9pbmhlcml0cyhIeXBlcnR5RGVzY3JpcHRvciwgX0NhdGFsb2d1ZURhdGFPYmplY3QpOwoKICAgIGZ1bmN0aW9uIEh5cGVydHlEZXNjcmlwdG9yKGd1aWQsIGNhdGFsb2d1ZVR5cGUsIG9iamVjdE5hbWUsIGRlc2NyaXB0aW9uLCBsYW5ndWFnZSwgc291cmNlUGFja2FnZVVSTCwgaHlwZXJ0eVR5cGUsIGRhdGFPYmplY3RzKSB7CiAgICAgICAgX2NsYXNzQ2FsbENoZWNrKHRoaXMsIEh5cGVydHlEZXNjcmlwdG9yKTsKCiAgICAgICAgX2dldChPYmplY3QuZ2V0UHJvdG90eXBlT2YoSHlwZXJ0eURlc2NyaXB0b3IucHJvdG90eXBlKSwgJ2NvbnN0cnVjdG9yJywgdGhpcykuY2FsbCh0aGlzLCBndWlkLCBjYXRhbG9ndWVUeXBlLCBvYmplY3ROYW1lLCBkZXNjcmlwdGlvbiwgbGFuZ3VhZ2UsIHNvdXJjZVBhY2thZ2VVUkwpOwoKICAgICAgICB0aGlzLl9jb25maWd1cmF0aW9uRGF0YUxpc3QgPSB7fTsKICAgICAgICB0aGlzLl9ydW50aW1lQ29uc3RyYWludExpc3QgPSB7fTsKICAgICAgICB0aGlzLl9wb2xpY2llcyA9IHt9OwogICAgICAgIHRoaXMuX21lc3NhZ2VTY2hlbWEgPSBudWxsOwoKICAgICAgICB0aGlzLl9oeXBlcnR5VHlwZSA9IGh5cGVydHlUeXBlOwogICAgICAgIHRoaXMuX2RhdGFPYmplY3RzID0gZGF0YU9iamVjdHM7CiAgICB9CgogICAgX2NyZWF0ZUNsYXNzKEh5cGVydHlEZXNjcmlwdG9yLCBbewogICAgICAgIGtleTogJ2h5cGVydHlUeXBlJywKICAgICAgICBnZXQ6IGZ1bmN0aW9uIGdldCgpIHsKICAgICAgICAgICAgcmV0dXJuIHRoaXMuX2h5cGVydHlUeXBlOwogICAgICAgIH0sCiAgICAgICAgc2V0OiBmdW5jdGlvbiBzZXQoaFR5cGUpIHsKICAgICAgICAgICAgaWYgKGhUeXBlKSB0aGlzLl9oeXBlcnR5VHlwZSA9IGhUeXBlOwogICAgICAgIH0KICAgIH0sIHsKICAgICAgICBrZXk6ICdkYXRhT2JqZWN0cycsCiAgICAgICAgZ2V0OiBmdW5jdGlvbiBnZXQoKSB7CiAgICAgICAgICAgIHJldHVybiB0aGlzLl9kYXRhT2JqZWN0czsKICAgICAgICB9LAogICAgICAgIHNldDogZnVuY3Rpb24gc2V0KGRhdGFPYmplY3RVcmwpIHsKICAgICAgICAgICAgaWYgKGRhdGFPYmplY3RVcmwpIHRoaXMuX2RhdGFPYmplY3RzID0gZGF0YU9iamVjdFVybDsKICAgICAgICB9CiAgICB9LCB7CiAgICAgICAga2V5OiAnY29uZmlndXJhdGlvbkRhdGFMaXN0JywKICAgICAgICBnZXQ6IGZ1bmN0aW9uIGdldCgpIHsKICAgICAgICAgICAgcmV0dXJuIHRoaXMuX2NvbmZpZ3VyYXRpb25EYXRhTGlzdDsKICAgICAgICB9LAogICAgICAgIHNldDogZnVuY3Rpb24gc2V0KGNvbmZpZ0RhdGFMaXN0KSB7CiAgICAgICAgICAgIGlmIChjb25maWdEYXRhTGlzdCkgdGhpcy5fY29uZmlndXJhdGlvbkRhdGFMaXN0ID0gY29uZmlnRGF0YUxpc3Q7CiAgICAgICAgfQogICAgfSwgewogICAgICAgIGtleTogJ3J1bnRpbWVDb25zdHJhaW50TGlzdCcsCiAgICAgICAgZ2V0OiBmdW5jdGlvbiBnZXQoKSB7CiAgICAgICAgICAgIHJldHVybiB0aGlzLl9ydW50aW1lQ29uc3RyYWludExpc3Q7CiAgICAgICAgfSwKICAgICAgICBzZXQ6IGZ1bmN0aW9uIHNldChydW50aW1lQ29uc3RMaXN0KSB7CiAgICAgICAgICAgIGlmIChydW50aW1lQ29uc3RMaXN0KSB0aGlzLl9ydW50aW1lQ29uc3RyYWludExpc3QgPSBydW50aW1lQ29uc3RMaXN0OwogICAgICAgIH0KICAgIH0sIHsKICAgICAgICBrZXk6ICdtZXNzYWdlU2NoZW1hJywKICAgICAgICBnZXQ6IGZ1bmN0aW9uIGdldCgpIHsKICAgICAgICAgICAgcmV0dXJuIHRoaXMuX21lc3NhZ2VTY2hlbWE7CiAgICAgICAgfSwKICAgICAgICBzZXQ6IGZ1bmN0aW9uIHNldChtc2dTY2hlbWEpIHsKICAgICAgICAgICAgaWYgKG1zZ1NjaGVtYSkgdGhpcy5fbWVzc2FnZVNjaGVtYSA9IG1zZ1NjaGVtYTsKICAgICAgICB9CiAgICB9LCB7CiAgICAgICAga2V5OiAncG9saWNpZXMnLAogICAgICAgIGdldDogZnVuY3Rpb24gZ2V0KCkgewogICAgICAgICAgICByZXR1cm4gdGhpcy5fcG9saWNpZXM7CiAgICAgICAgfSwKICAgICAgICBzZXQ6IGZ1bmN0aW9uIHNldChwb2xpY3lMaXN0KSB7CiAgICAgICAgICAgIGlmIChwb2xpY3lMaXN0KSB0aGlzLl9wb2xpY2llcyA9IHBvbGljeUxpc3Q7CiAgICAgICAgfQogICAgfV0pOwoKICAgIHJldHVybiBIeXBlcnR5RGVzY3JpcHRvcjsKfSkoX0NhdGFsb2d1ZURhdGFPYmplY3QzWydkZWZhdWx0J10pOwoKdmFyIFJ1bnRpbWVIeXBlcnR5Q2FwYWJpbGl0eVR5cGUgPSB7fTsKZXhwb3J0cy5SdW50aW1lSHlwZXJ0eUNhcGFiaWxpdHlUeXBlID0gUnVudGltZUh5cGVydHlDYXBhYmlsaXR5VHlwZTsKdmFyIEh5cGVydHlUeXBlID0geyBDT01NVU5JQ0FUT1I6ICdjb21tdW5pY2F0b3InLCBJREVOVElUWTogJ2lkZW50aXR5JywgQ09OVEVYVDogJ2NvbnRleHQnIH07CmV4cG9ydHMuSHlwZXJ0eVR5cGUgPSBIeXBlcnR5VHlwZTsKZXhwb3J0c1snZGVmYXVsdCddID0gSHlwZXJ0eURlc2NyaXB0b3I7Cgp9LHsiLi9DYXRhbG9ndWVEYXRhT2JqZWN0Ijo0fV0sODpbZnVuY3Rpb24ocmVxdWlyZSxtb2R1bGUsZXhwb3J0cyl7Ci8qKgogKiBDcmVhdGVkIGJ5IGFtbyBvbiAxNC8xMS8yMDE1LgogKi8KCid1c2Ugc3RyaWN0JzsKCk9iamVjdC5kZWZpbmVQcm9wZXJ0eShleHBvcnRzLCAnX19lc01vZHVsZScsIHsKICAgIHZhbHVlOiB0cnVlCn0pOwoKdmFyIF9jcmVhdGVDbGFzcyA9IChmdW5jdGlvbiAoKSB7IGZ1bmN0aW9uIGRlZmluZVByb3BlcnRpZXModGFyZ2V0LCBwcm9wcykgeyBmb3IgKHZhciBpID0gMDsgaSA8IHByb3BzLmxlbmd0aDsgaSsrKSB7IHZhciBkZXNjcmlwdG9yID0gcHJvcHNbaV07IGRlc2NyaXB0b3IuZW51bWVyYWJsZSA9IGRlc2NyaXB0b3IuZW51bWVyYWJsZSB8fCBmYWxzZTsgZGVzY3JpcHRvci5jb25maWd1cmFibGUgPSB0cnVlOyBpZiAoJ3ZhbHVlJyBpbiBkZXNjcmlwdG9yKSBkZXNjcmlwdG9yLndyaXRhYmxlID0gdHJ1ZTsgT2JqZWN0LmRlZmluZVByb3BlcnR5KHRhcmdldCwgZGVzY3JpcHRvci5rZXksIGRlc2NyaXB0b3IpOyB9IH0gcmV0dXJuIGZ1bmN0aW9uIChDb25zdHJ1Y3RvciwgcHJvdG9Qcm9wcywgc3RhdGljUHJvcHMpIHsgaWYgKHByb3RvUHJvcHMpIGRlZmluZVByb3BlcnRpZXMoQ29uc3RydWN0b3IucHJvdG90eXBlLCBwcm90b1Byb3BzKTsgaWYgKHN0YXRpY1Byb3BzKSBkZWZpbmVQcm9wZXJ0aWVzKENvbnN0cnVjdG9yLCBzdGF0aWNQcm9wcyk7IHJldHVybiBDb25zdHJ1Y3RvcjsgfTsgfSkoKTsKCnZhciBfZ2V0ID0gZnVuY3Rpb24gZ2V0KF94LCBfeDIsIF94MykgeyB2YXIgX2FnYWluID0gdHJ1ZTsgX2Z1bmN0aW9uOiB3aGlsZSAoX2FnYWluKSB7IHZhciBvYmplY3QgPSBfeCwgcHJvcGVydHkgPSBfeDIsIHJlY2VpdmVyID0gX3gzOyBfYWdhaW4gPSBmYWxzZTsgaWYgKG9iamVjdCA9PT0gbnVsbCkgb2JqZWN0ID0gRnVuY3Rpb24ucHJvdG90eXBlOyB2YXIgZGVzYyA9IE9iamVjdC5nZXRPd25Qcm9wZXJ0eURlc2NyaXB0b3Iob2JqZWN0LCBwcm9wZXJ0eSk7IGlmIChkZXNjID09PSB1bmRlZmluZWQpIHsgdmFyIHBhcmVudCA9IE9iamVjdC5nZXRQcm90b3R5cGVPZihvYmplY3QpOyBpZiAocGFyZW50ID09PSBudWxsKSB7IHJldHVybiB1bmRlZmluZWQ7IH0gZWxzZSB7IF94ID0gcGFyZW50OyBfeDIgPSBwcm9wZXJ0eTsgX3gzID0gcmVjZWl2ZXI7IF9hZ2FpbiA9IHRydWU7IGRlc2MgPSBwYXJlbnQgPSB1bmRlZmluZWQ7IGNvbnRpbnVlIF9mdW5jdGlvbjsgfSB9IGVsc2UgaWYgKCd2YWx1ZScgaW4gZGVzYykgeyByZXR1cm4gZGVzYy52YWx1ZTsgfSBlbHNlIHsgdmFyIGdldHRlciA9IGRlc2MuZ2V0OyBpZiAoZ2V0dGVyID09PSB1bmRlZmluZWQpIHsgcmV0dXJuIHVuZGVmaW5lZDsgfSByZXR1cm4gZ2V0dGVyLmNhbGwocmVjZWl2ZXIpOyB9IH0gfTsKCmZ1bmN0aW9uIF9pbnRlcm9wUmVxdWlyZURlZmF1bHQob2JqKSB7IHJldHVybiBvYmogJiYgb2JqLl9fZXNNb2R1bGUgPyBvYmogOiB7ICdkZWZhdWx0Jzogb2JqIH07IH0KCmZ1bmN0aW9uIF9jbGFzc0NhbGxDaGVjayhpbnN0YW5jZSwgQ29uc3RydWN0b3IpIHsgaWYgKCEoaW5zdGFuY2UgaW5zdGFuY2VvZiBDb25zdHJ1Y3RvcikpIHsgdGhyb3cgbmV3IFR5cGVFcnJvcignQ2Fubm90IGNhbGwgYSBjbGFzcyBhcyBhIGZ1bmN0aW9uJyk7IH0gfQoKZnVuY3Rpb24gX2luaGVyaXRzKHN1YkNsYXNzLCBzdXBlckNsYXNzKSB7IGlmICh0eXBlb2Ygc3VwZXJDbGFzcyAhPT0gJ2Z1bmN0aW9uJyAmJiBzdXBlckNsYXNzICE9PSBudWxsKSB7IHRocm93IG5ldyBUeXBlRXJyb3IoJ1N1cGVyIGV4cHJlc3Npb24gbXVzdCBlaXRoZXIgYmUgbnVsbCBvciBhIGZ1bmN0aW9uLCBub3QgJyArIHR5cGVvZiBzdXBlckNsYXNzKTsgfSBzdWJDbGFzcy5wcm90b3R5cGUgPSBPYmplY3QuY3JlYXRlKHN1cGVyQ2xhc3MgJiYgc3VwZXJDbGFzcy5wcm90b3R5cGUsIHsgY29uc3RydWN0b3I6IHsgdmFsdWU6IHN1YkNsYXNzLCBlbnVtZXJhYmxlOiBmYWxzZSwgd3JpdGFibGU6IHRydWUsIGNvbmZpZ3VyYWJsZTogdHJ1ZSB9IH0pOyBpZiAoc3VwZXJDbGFzcykgT2JqZWN0LnNldFByb3RvdHlwZU9mID8gT2JqZWN0LnNldFByb3RvdHlwZU9mKHN1YkNsYXNzLCBzdXBlckNsYXNzKSA6IHN1YkNsYXNzLl9fcHJvdG9fXyA9IHN1cGVyQ2xhc3M7IH0KCnZhciBfQ2F0YWxvZ3VlRGF0YU9iamVjdDIgPSByZXF1aXJlKCcuL0NhdGFsb2d1ZURhdGFPYmplY3QnKTsKCnZhciBfQ2F0YWxvZ3VlRGF0YU9iamVjdDMgPSBfaW50ZXJvcFJlcXVpcmVEZWZhdWx0KF9DYXRhbG9ndWVEYXRhT2JqZWN0Mik7Cgp2YXIgSHlwZXJ0eVJ1bnRpbWVEZXNjcmlwdG9yID0gKGZ1bmN0aW9uIChfQ2F0YWxvZ3VlRGF0YU9iamVjdCkgewogICAgX2luaGVyaXRzKEh5cGVydHlSdW50aW1lRGVzY3JpcHRvciwgX0NhdGFsb2d1ZURhdGFPYmplY3QpOwoKICAgIGZ1bmN0aW9uIEh5cGVydHlSdW50aW1lRGVzY3JpcHRvcihndWlkLCBjYXRhbG9ndWVUeXBlLCBvYmplY3ROYW1lLCBkZXNjcmlwdGlvbiwgbGFuZ3VhZ2UsIHNvdXJjZVBhY2thZ2VVUkwsIHJ1bnRpbWVUeXBlLCBoeXBlcnR5Q2FwYWJpbGl0aWVzLCBwcm90b2NvbENhcGFiaWxpdGllcykgewogICAgICAgIF9jbGFzc0NhbGxDaGVjayh0aGlzLCBIeXBlcnR5UnVudGltZURlc2NyaXB0b3IpOwoKICAgICAgICBfZ2V0KE9iamVjdC5nZXRQcm90b3R5cGVPZihIeXBlcnR5UnVudGltZURlc2NyaXB0b3IucHJvdG90eXBlKSwgJ2NvbnN0cnVjdG9yJywgdGhpcykuY2FsbCh0aGlzLCBndWlkLCBjYXRhbG9ndWVUeXBlLCBvYmplY3ROYW1lLCBkZXNjcmlwdGlvbiwgbGFuZ3VhZ2UsIHNvdXJjZVBhY2thZ2VVUkwpOwoKICAgICAgICB0aGlzLl9ydW50aW1lVHlwZSA9IHJ1bnRpbWVUeXBlOwogICAgICAgIGlmIChoeXBlcnR5Q2FwYWJpbGl0aWVzKSB0aGlzLl9oeXBlcnR5Q2FwYWJpbGl0aWVzID0gaHlwZXJ0eUNhcGFiaWxpdGllcztlbHNlIHRoaXMuX2h5cGVydHlDYXBhYmlsaXRpZXMgPSB7fTsKICAgICAgICBpZiAocHJvdG9jb2xDYXBhYmlsaXRpZXMpIHRoaXMuX3Byb3RvY29sQ2FwYWJpbGl0aWVzID0gcHJvdG9jb2xDYXBhYmlsaXRpZXM7ZWxzZSB0aGlzLl9wcm90b2NvbENhcGFiaWxpdGllcyA9IHt9OwogICAgfQoKICAgIF9jcmVhdGVDbGFzcyhIeXBlcnR5UnVudGltZURlc2NyaXB0b3IsIFt7CiAgICAgICAga2V5OiAncnVudGltZVR5cGUnLAogICAgICAgIGdldDogZnVuY3Rpb24gZ2V0KCkgewogICAgICAgICAgICByZXR1cm4gdGhpcy5fcnVudGltZVR5cGU7CiAgICAgICAgfQogICAgfSwgewogICAgICAgIGtleTogJ2h5cGVydHlDYXBhYmlsaXRpZXMnLAogICAgICAgIGdldDogZnVuY3Rpb24gZ2V0KCkgewogICAgICAgICAgICByZXR1cm4gdGhpcy5faHlwZXJ0eUNhcGFiaWxpdGllczsKICAgICAgICB9CiAgICB9LCB7CiAgICAgICAga2V5OiAncHJvdG9jb2xDYXBhYmlsaXRpZXMnLAogICAgICAgIGdldDogZnVuY3Rpb24gZ2V0KCkgewogICAgICAgICAgICByZXR1cm4gdGhpcy5faHlwZXJ0eUNhcGFiaWxpdGllczsKICAgICAgICB9CiAgICB9XSk7CgogICAgcmV0dXJuIEh5cGVydHlSdW50aW1lRGVzY3JpcHRvcjsKfSkoX0NhdGFsb2d1ZURhdGFPYmplY3QzWydkZWZhdWx0J10pOwoKdmFyIFJ1bnRpbWVUeXBlID0geyBCUk9XU0VSOiAnYnJvd3NlcicsIFNUQU5EQUxPTkU6ICdzdGFuZGFsb25lJywgU0VSVkVSOiAnc2VydmVyJywgR0FURVdBWTogJ2dhdGV3YXknIH07CmV4cG9ydHMuUnVudGltZVR5cGUgPSBSdW50aW1lVHlwZTsKdmFyIFJ1bnRpbWVIeXBlcnR5Q2FwYWJpbGl0eVR5cGUgPSB7IE1JQzogJ21pYycsIENBTUVSQTogJ2NhbWVyYScsIFNFTlNPUjogJ3NlbnNvcicsIFdFQlJUQzogJ3dlYnJ0YycsCiAgICBPUlRDOiAnb3J0YycgfTsKZXhwb3J0cy5SdW50aW1lSHlwZXJ0eUNhcGFiaWxpdHlUeXBlID0gUnVudGltZUh5cGVydHlDYXBhYmlsaXR5VHlwZTsKdmFyIFJ1bnRpbWVQcm90b2NvbENhcGFiaWxpdHlUeXBlID0geyBIVFRQOiAnaHR0cCcsIEhUVFBTOiAnaHR0cHMnLCBXUzogJ3dzJywgV1NTOiAnd3NzJywgQ09BUDogJ2NvYXAnLAogICAgREFUQUNIQU5FTDogJ2RhdGFjaGFubmVsJyB9OwpleHBvcnRzLlJ1bnRpbWVQcm90b2NvbENhcGFiaWxpdHlUeXBlID0gUnVudGltZVByb3RvY29sQ2FwYWJpbGl0eVR5cGU7CmV4cG9ydHNbJ2RlZmF1bHQnXSA9IEh5cGVydHlSdW50aW1lRGVzY3JpcHRvcjsKCn0seyIuL0NhdGFsb2d1ZURhdGFPYmplY3QiOjR9XSw5OltmdW5jdGlvbihyZXF1aXJlLG1vZHVsZSxleHBvcnRzKXsKLyoqCiAqIENyZWF0ZWQgYnkgcHp1IG9uIDE5LjExLjE1LgogKi8KJ3VzZSBzdHJpY3QnOwoKT2JqZWN0LmRlZmluZVByb3BlcnR5KGV4cG9ydHMsICdfX2VzTW9kdWxlJywgewogICAgdmFsdWU6IHRydWUKfSk7Cgp2YXIgX2NyZWF0ZUNsYXNzID0gKGZ1bmN0aW9uICgpIHsgZnVuY3Rpb24gZGVmaW5lUHJvcGVydGllcyh0YXJnZXQsIHByb3BzKSB7IGZvciAodmFyIGkgPSAwOyBpIDwgcHJvcHMubGVuZ3RoOyBpKyspIHsgdmFyIGRlc2NyaXB0b3IgPSBwcm9wc1tpXTsgZGVzY3JpcHRvci5lbnVtZXJhYmxlID0gZGVzY3JpcHRvci5lbnVtZXJhYmxlIHx8IGZhbHNlOyBkZXNjcmlwdG9yLmNvbmZpZ3VyYWJsZSA9IHRydWU7IGlmICgndmFsdWUnIGluIGRlc2NyaXB0b3IpIGRlc2NyaXB0b3Iud3JpdGFibGUgPSB0cnVlOyBPYmplY3QuZGVmaW5lUHJvcGVydHkodGFyZ2V0LCBkZXNjcmlwdG9yLmtleSwgZGVzY3JpcHRvcik7IH0gfSByZXR1cm4gZnVuY3Rpb24gKENvbnN0cnVjdG9yLCBwcm90b1Byb3BzLCBzdGF0aWNQcm9wcykgeyBpZiAocHJvdG9Qcm9wcykgZGVmaW5lUHJvcGVydGllcyhDb25zdHJ1Y3Rvci5wcm90b3R5cGUsIHByb3RvUHJvcHMpOyBpZiAoc3RhdGljUHJvcHMpIGRlZmluZVByb3BlcnRpZXMoQ29uc3RydWN0b3IsIHN0YXRpY1Byb3BzKTsgcmV0dXJuIENvbnN0cnVjdG9yOyB9OyB9KSgpOwoKdmFyIF9nZXQgPSBmdW5jdGlvbiBnZXQoX3gsIF94MiwgX3gzKSB7IHZhciBfYWdhaW4gPSB0cnVlOyBfZnVuY3Rpb246IHdoaWxlIChfYWdhaW4pIHsgdmFyIG9iamVjdCA9IF94LCBwcm9wZXJ0eSA9IF94MiwgcmVjZWl2ZXIgPSBfeDM7IF9hZ2FpbiA9IGZhbHNlOyBpZiAob2JqZWN0ID09PSBudWxsKSBvYmplY3QgPSBGdW5jdGlvbi5wcm90b3R5cGU7IHZhciBkZXNjID0gT2JqZWN0LmdldE93blByb3BlcnR5RGVzY3JpcHRvcihvYmplY3QsIHByb3BlcnR5KTsgaWYgKGRlc2MgPT09IHVuZGVmaW5lZCkgeyB2YXIgcGFyZW50ID0gT2JqZWN0LmdldFByb3RvdHlwZU9mKG9iamVjdCk7IGlmIChwYXJlbnQgPT09IG51bGwpIHsgcmV0dXJuIHVuZGVmaW5lZDsgfSBlbHNlIHsgX3ggPSBwYXJlbnQ7IF94MiA9IHByb3BlcnR5OyBfeDMgPSByZWNlaXZlcjsgX2FnYWluID0gdHJ1ZTsgZGVzYyA9IHBhcmVudCA9IHVuZGVmaW5lZDsgY29udGludWUgX2Z1bmN0aW9uOyB9IH0gZWxzZSBpZiAoJ3ZhbHVlJyBpbiBkZXNjKSB7IHJldHVybiBkZXNjLnZhbHVlOyB9IGVsc2UgeyB2YXIgZ2V0dGVyID0gZGVzYy5nZXQ7IGlmIChnZXR0ZXIgPT09IHVuZGVmaW5lZCkgeyByZXR1cm4gdW5kZWZpbmVkOyB9IHJldHVybiBnZXR0ZXIuY2FsbChyZWNlaXZlcik7IH0gfSB9OwoKZnVuY3Rpb24gX2ludGVyb3BSZXF1aXJlRGVmYXVsdChvYmopIHsgcmV0dXJuIG9iaiAmJiBvYmouX19lc01vZHVsZSA/IG9iaiA6IHsgJ2RlZmF1bHQnOiBvYmogfTsgfQoKZnVuY3Rpb24gX2NsYXNzQ2FsbENoZWNrKGluc3RhbmNlLCBDb25zdHJ1Y3RvcikgeyBpZiAoIShpbnN0YW5jZSBpbnN0YW5jZW9mIENvbnN0cnVjdG9yKSkgeyB0aHJvdyBuZXcgVHlwZUVycm9yKCdDYW5ub3QgY2FsbCBhIGNsYXNzIGFzIGEgZnVuY3Rpb24nKTsgfSB9CgpmdW5jdGlvbiBfaW5oZXJpdHMoc3ViQ2xhc3MsIHN1cGVyQ2xhc3MpIHsgaWYgKHR5cGVvZiBzdXBlckNsYXNzICE9PSAnZnVuY3Rpb24nICYmIHN1cGVyQ2xhc3MgIT09IG51bGwpIHsgdGhyb3cgbmV3IFR5cGVFcnJvcignU3VwZXIgZXhwcmVzc2lvbiBtdXN0IGVpdGhlciBiZSBudWxsIG9yIGEgZnVuY3Rpb24sIG5vdCAnICsgdHlwZW9mIHN1cGVyQ2xhc3MpOyB9IHN1YkNsYXNzLnByb3RvdHlwZSA9IE9iamVjdC5jcmVhdGUoc3VwZXJDbGFzcyAmJiBzdXBlckNsYXNzLnByb3RvdHlwZSwgeyBjb25zdHJ1Y3RvcjogeyB2YWx1ZTogc3ViQ2xhc3MsIGVudW1lcmFibGU6IGZhbHNlLCB3cml0YWJsZTogdHJ1ZSwgY29uZmlndXJhYmxlOiB0cnVlIH0gfSk7IGlmIChzdXBlckNsYXNzKSBPYmplY3Quc2V0UHJvdG90eXBlT2YgPyBPYmplY3Quc2V0UHJvdG90eXBlT2Yoc3ViQ2xhc3MsIHN1cGVyQ2xhc3MpIDogc3ViQ2xhc3MuX19wcm90b19fID0gc3VwZXJDbGFzczsgfQoKdmFyIF9DYXRhbG9ndWVEYXRhT2JqZWN0MiA9IHJlcXVpcmUoJy4vQ2F0YWxvZ3VlRGF0YU9iamVjdCcpOwoKdmFyIF9DYXRhbG9ndWVEYXRhT2JqZWN0MyA9IF9pbnRlcm9wUmVxdWlyZURlZmF1bHQoX0NhdGFsb2d1ZURhdGFPYmplY3QyKTsKCnZhciBQb2xpY3lFbmZvcmNlckRlc2NyaXB0b3IgPSAoZnVuY3Rpb24gKF9DYXRhbG9ndWVEYXRhT2JqZWN0KSB7CiAgICBfaW5oZXJpdHMoUG9saWN5RW5mb3JjZXJEZXNjcmlwdG9yLCBfQ2F0YWxvZ3VlRGF0YU9iamVjdCk7CgogICAgZnVuY3Rpb24gUG9saWN5RW5mb3JjZXJEZXNjcmlwdG9yKGd1aWQsIHR5cGUsIG9iamVjdE5hbWUsIGRlc2NyaXB0aW9uLCBsYW5ndWFnZSwgc291cmNlUGFja2FnZVVSTCwgY29uZmlndXJhdGlvbiwgcG9saWNpZXMpIHsKICAgICAgICBfY2xhc3NDYWxsQ2hlY2sodGhpcywgUG9saWN5RW5mb3JjZXJEZXNjcmlwdG9yKTsKCiAgICAgICAgX2dldChPYmplY3QuZ2V0UHJvdG90eXBlT2YoUG9saWN5RW5mb3JjZXJEZXNjcmlwdG9yLnByb3RvdHlwZSksICdjb25zdHJ1Y3RvcicsIHRoaXMpLmNhbGwodGhpcywgZ3VpZCwgdHlwZSwgb2JqZWN0TmFtZSwgZGVzY3JpcHRpb24sIGxhbmd1YWdlLCBzb3VyY2VQYWNrYWdlVVJMKTsKCiAgICAgICAgdGhpcy5fY29uZmlndXJhdGlvbiA9IGNvbmZpZ3VyYXRpb247CiAgICAgICAgdGhpcy5fcG9saWNpZXMgPSBwb2xpY2llczsKICAgIH0KCiAgICBfY3JlYXRlQ2xhc3MoUG9saWN5RW5mb3JjZXJEZXNjcmlwdG9yLCBbewogICAgICAgIGtleTogJ2NvbmZpZ3VyYXRpb24nLAogICAgICAgIGdldDogZnVuY3Rpb24gZ2V0KCkgewogICAgICAgICAgICByZXR1cm4gdGhpcy5fY29uZmlndXJhdGlvbjsKICAgICAgICB9LAogICAgICAgIHNldDogZnVuY3Rpb24gc2V0KGNvbmZpZ3VyYXRpb24pIHsKICAgICAgICAgICAgdGhpcy5fY29uZmlndXJhdGlvbiA9IGNvbmZpZ3VyYXRpb247CiAgICAgICAgfQogICAgfSwgewogICAgICAgIGtleTogJ3BvbGljaWVzJywKICAgICAgICBnZXQ6IGZ1bmN0aW9uIGdldCgpIHsKICAgICAgICAgICAgcmV0dXJuIHRoaXMuX3BvbGljaWVzOwogICAgICAgIH0sCiAgICAgICAgc2V0OiBmdW5jdGlvbiBzZXQocG9saWNpZXMpIHsKICAgICAgICAgICAgdGhpcy5fcG9saWNpZXMgPSBwb2xpY2llczsKICAgICAgICB9CiAgICB9XSk7CgogICAgcmV0dXJuIFBvbGljeUVuZm9yY2VyRGVzY3JpcHRvcjsKfSkoX0NhdGFsb2d1ZURhdGFPYmplY3QzWydkZWZhdWx0J10pOwoKZXhwb3J0c1snZGVmYXVsdCddID0gUG9saWN5RW5mb3JjZXJEZXNjcmlwdG9yOwptb2R1bGUuZXhwb3J0cyA9IGV4cG9ydHNbJ2RlZmF1bHQnXTsKCn0seyIuL0NhdGFsb2d1ZURhdGFPYmplY3QiOjR9XSwxMDpbZnVuY3Rpb24ocmVxdWlyZSxtb2R1bGUsZXhwb3J0cyl7Ci8qKgogKiBDcmVhdGVkIGJ5IGFtbyBvbiAxNC8xMS8yMDE1LgogKi8KCid1c2Ugc3RyaWN0JzsKCk9iamVjdC5kZWZpbmVQcm9wZXJ0eShleHBvcnRzLCAnX19lc01vZHVsZScsIHsKICAgIHZhbHVlOiB0cnVlCn0pOwoKdmFyIF9jcmVhdGVDbGFzcyA9IChmdW5jdGlvbiAoKSB7IGZ1bmN0aW9uIGRlZmluZVByb3BlcnRpZXModGFyZ2V0LCBwcm9wcykgeyBmb3IgKHZhciBpID0gMDsgaSA8IHByb3BzLmxlbmd0aDsgaSsrKSB7IHZhciBkZXNjcmlwdG9yID0gcHJvcHNbaV07IGRlc2NyaXB0b3IuZW51bWVyYWJsZSA9IGRlc2NyaXB0b3IuZW51bWVyYWJsZSB8fCBmYWxzZTsgZGVzY3JpcHRvci5jb25maWd1cmFibGUgPSB0cnVlOyBpZiAoJ3ZhbHVlJyBpbiBkZXNjcmlwdG9yKSBkZXNjcmlwdG9yLndyaXRhYmxlID0gdHJ1ZTsgT2JqZWN0LmRlZmluZVByb3BlcnR5KHRhcmdldCwgZGVzY3JpcHRvci5rZXksIGRlc2NyaXB0b3IpOyB9IH0gcmV0dXJuIGZ1bmN0aW9uIChDb25zdHJ1Y3RvciwgcHJvdG9Qcm9wcywgc3RhdGljUHJvcHMpIHsgaWYgKHByb3RvUHJvcHMpIGRlZmluZVByb3BlcnRpZXMoQ29uc3RydWN0b3IucHJvdG90eXBlLCBwcm90b1Byb3BzKTsgaWYgKHN0YXRpY1Byb3BzKSBkZWZpbmVQcm9wZXJ0aWVzKENvbnN0cnVjdG9yLCBzdGF0aWNQcm9wcyk7IHJldHVybiBDb25zdHJ1Y3RvcjsgfTsgfSkoKTsKCnZhciBfZ2V0ID0gZnVuY3Rpb24gZ2V0KF94LCBfeDIsIF94MykgeyB2YXIgX2FnYWluID0gdHJ1ZTsgX2Z1bmN0aW9uOiB3aGlsZSAoX2FnYWluKSB7IHZhciBvYmplY3QgPSBfeCwgcHJvcGVydHkgPSBfeDIsIHJlY2VpdmVyID0gX3gzOyBfYWdhaW4gPSBmYWxzZTsgaWYgKG9iamVjdCA9PT0gbnVsbCkgb2JqZWN0ID0gRnVuY3Rpb24ucHJvdG90eXBlOyB2YXIgZGVzYyA9IE9iamVjdC5nZXRPd25Qcm9wZXJ0eURlc2NyaXB0b3Iob2JqZWN0LCBwcm9wZXJ0eSk7IGlmIChkZXNjID09PSB1bmRlZmluZWQpIHsgdmFyIHBhcmVudCA9IE9iamVjdC5nZXRQcm90b3R5cGVPZihvYmplY3QpOyBpZiAocGFyZW50ID09PSBudWxsKSB7IHJldHVybiB1bmRlZmluZWQ7IH0gZWxzZSB7IF94ID0gcGFyZW50OyBfeDIgPSBwcm9wZXJ0eTsgX3gzID0gcmVjZWl2ZXI7IF9hZ2FpbiA9IHRydWU7IGRlc2MgPSBwYXJlbnQgPSB1bmRlZmluZWQ7IGNvbnRpbnVlIF9mdW5jdGlvbjsgfSB9IGVsc2UgaWYgKCd2YWx1ZScgaW4gZGVzYykgeyByZXR1cm4gZGVzYy52YWx1ZTsgfSBlbHNlIHsgdmFyIGdldHRlciA9IGRlc2MuZ2V0OyBpZiAoZ2V0dGVyID09PSB1bmRlZmluZWQpIHsgcmV0dXJuIHVuZGVmaW5lZDsgfSByZXR1cm4gZ2V0dGVyLmNhbGwocmVjZWl2ZXIpOyB9IH0gfTsKCmZ1bmN0aW9uIF9pbnRlcm9wUmVxdWlyZURlZmF1bHQob2JqKSB7IHJldHVybiBvYmogJiYgb2JqLl9fZXNNb2R1bGUgPyBvYmogOiB7ICdkZWZhdWx0Jzogb2JqIH07IH0KCmZ1bmN0aW9uIF9jbGFzc0NhbGxDaGVjayhpbnN0YW5jZSwgQ29uc3RydWN0b3IpIHsgaWYgKCEoaW5zdGFuY2UgaW5zdGFuY2VvZiBDb25zdHJ1Y3RvcikpIHsgdGhyb3cgbmV3IFR5cGVFcnJvcignQ2Fubm90IGNhbGwgYSBjbGFzcyBhcyBhIGZ1bmN0aW9uJyk7IH0gfQoKZnVuY3Rpb24gX2luaGVyaXRzKHN1YkNsYXNzLCBzdXBlckNsYXNzKSB7IGlmICh0eXBlb2Ygc3VwZXJDbGFzcyAhPT0gJ2Z1bmN0aW9uJyAmJiBzdXBlckNsYXNzICE9PSBudWxsKSB7IHRocm93IG5ldyBUeXBlRXJyb3IoJ1N1cGVyIGV4cHJlc3Npb24gbXVzdCBlaXRoZXIgYmUgbnVsbCBvciBhIGZ1bmN0aW9uLCBub3QgJyArIHR5cGVvZiBzdXBlckNsYXNzKTsgfSBzdWJDbGFzcy5wcm90b3R5cGUgPSBPYmplY3QuY3JlYXRlKHN1cGVyQ2xhc3MgJiYgc3VwZXJDbGFzcy5wcm90b3R5cGUsIHsgY29uc3RydWN0b3I6IHsgdmFsdWU6IHN1YkNsYXNzLCBlbnVtZXJhYmxlOiBmYWxzZSwgd3JpdGFibGU6IHRydWUsIGNvbmZpZ3VyYWJsZTogdHJ1ZSB9IH0pOyBpZiAoc3VwZXJDbGFzcykgT2JqZWN0LnNldFByb3RvdHlwZU9mID8gT2JqZWN0LnNldFByb3RvdHlwZU9mKHN1YkNsYXNzLCBzdXBlckNsYXNzKSA6IHN1YkNsYXNzLl9fcHJvdG9fXyA9IHN1cGVyQ2xhc3M7IH0KCnZhciBfQ2F0YWxvZ3VlRGF0YU9iamVjdDIgPSByZXF1aXJlKCcuL0NhdGFsb2d1ZURhdGFPYmplY3QnKTsKCnZhciBfQ2F0YWxvZ3VlRGF0YU9iamVjdDMgPSBfaW50ZXJvcFJlcXVpcmVEZWZhdWx0KF9DYXRhbG9ndWVEYXRhT2JqZWN0Mik7Cgp2YXIgX0h5cGVydHlSdW50aW1lRGVzY3JpcHRvciA9IHJlcXVpcmUoJy4vSHlwZXJ0eVJ1bnRpbWVEZXNjcmlwdG9yJyk7Cgp2YXIgX0h5cGVydHlSdW50aW1lRGVzY3JpcHRvcjIgPSBfaW50ZXJvcFJlcXVpcmVEZWZhdWx0KF9IeXBlcnR5UnVudGltZURlc2NyaXB0b3IpOwoKdmFyIFByb3RvY29sU3R1YkRlc2NyaXB0b3IgPSAoZnVuY3Rpb24gKF9DYXRhbG9ndWVEYXRhT2JqZWN0KSB7CiAgICBfaW5oZXJpdHMoUHJvdG9jb2xTdHViRGVzY3JpcHRvciwgX0NhdGFsb2d1ZURhdGFPYmplY3QpOwoKICAgIGZ1bmN0aW9uIFByb3RvY29sU3R1YkRlc2NyaXB0b3IoZ3VpZCwgdHlwZSwgb2JqZWN0TmFtZSwgZGVzY3JpcHRpb24sIGxhbmd1YWdlLCBzb3VyY2VQYWNrYWdlVVJMLCBtZXNzYWdlU2NoZW1hcywgY29uZmlndXJhdGlvbkxpc3QsIGNvbnN0cmFpbnRMaXN0KSB7CiAgICAgICAgX2NsYXNzQ2FsbENoZWNrKHRoaXMsIFByb3RvY29sU3R1YkRlc2NyaXB0b3IpOwoKICAgICAgICBfZ2V0KE9iamVjdC5nZXRQcm90b3R5cGVPZihQcm90b2NvbFN0dWJEZXNjcmlwdG9yLnByb3RvdHlwZSksICdjb25zdHJ1Y3RvcicsIHRoaXMpLmNhbGwodGhpcywgZ3VpZCwgdHlwZSwgb2JqZWN0TmFtZSwgZGVzY3JpcHRpb24sIGxhbmd1YWdlLCBzb3VyY2VQYWNrYWdlVVJMKTsKCiAgICAgICAgdGhpcy5fbWVzc2FnZVNjaGVtYXMgPSBtZXNzYWdlU2NoZW1hczsKICAgICAgICBpZiAoY29uZmlndXJhdGlvbkxpc3QpIHRoaXMuX2NvbmZpZ3VyYXRpb25MaXN0ID0gY29uZmlndXJhdGlvbkxpc3Q7ZWxzZSB0aGlzLl9jb25maWd1cmF0aW9uTGlzdCA9IHt9OwoKICAgICAgICBpZiAoY29uc3RyYWludExpc3QpIHRoaXMuX2NvbnN0cmFpbnRzTGlzdCA9IGNvbnN0cmFpbnRMaXN0O2Vsc2UgdGhpcy5fY29uc3RyYWludHNMaXN0ID0ge307CiAgICB9CgogICAgX2NyZWF0ZUNsYXNzKFByb3RvY29sU3R1YkRlc2NyaXB0b3IsIFt7CiAgICAgICAga2V5OiAnbWVzc2FnZVNjaGVtYXMnLAogICAgICAgIGdldDogZnVuY3Rpb24gZ2V0KCkgewogICAgICAgICAgICByZXR1cm4gdGhpcy5fbWVzc2FnZVNjaGVtYXM7CiAgICAgICAgfQogICAgfSwgewogICAgICAgIGtleTogJ2NvbnN0cmFpbnRzTGlzdCcsCiAgICAgICAgZ2V0OiBmdW5jdGlvbiBnZXQoKSB7CiAgICAgICAgICAgIHJldHVybiB0aGlzLl9jb25zdHJhaW50c0xpc3Q7CiAgICAgICAgfQogICAgfSwgewogICAgICAgIGtleTogJ2NvbmZpZ3VyYXRpb25MaXN0JywKICAgICAgICBnZXQ6IGZ1bmN0aW9uIGdldCgpIHsKICAgICAgICAgICAgcmV0dXJuIHRoaXMuX2NvbmZpZ3VyYXRpb25MaXN0OwogICAgICAgIH0KICAgIH1dKTsKCiAgICByZXR1cm4gUHJvdG9jb2xTdHViRGVzY3JpcHRvcjsKfSkoX0NhdGFsb2d1ZURhdGFPYmplY3QzWydkZWZhdWx0J10pOwoKZXhwb3J0c1snZGVmYXVsdCddID0gUHJvdG9jb2xTdHViRGVzY3JpcHRvcjsKbW9kdWxlLmV4cG9ydHMgPSBleHBvcnRzWydkZWZhdWx0J107Cgp9LHsiLi9DYXRhbG9ndWVEYXRhT2JqZWN0Ijo0LCIuL0h5cGVydHlSdW50aW1lRGVzY3JpcHRvciI6OH1dLDExOltmdW5jdGlvbihyZXF1aXJlLG1vZHVsZSxleHBvcnRzKXsKLyoqCiAqIENyZWF0ZWQgYnkgYW1vIG9uIDE0LzExLzIwMTUuCiAqLwoidXNlIHN0cmljdCI7CgpPYmplY3QuZGVmaW5lUHJvcGVydHkoZXhwb3J0cywgIl9fZXNNb2R1bGUiLCB7CiAgICB2YWx1ZTogdHJ1ZQp9KTsKCnZhciBfY3JlYXRlQ2xhc3MgPSAoZnVuY3Rpb24gKCkgeyBmdW5jdGlvbiBkZWZpbmVQcm9wZXJ0aWVzKHRhcmdldCwgcHJvcHMpIHsgZm9yICh2YXIgaSA9IDA7IGkgPCBwcm9wcy5sZW5ndGg7IGkrKykgeyB2YXIgZGVzY3JpcHRvciA9IHByb3BzW2ldOyBkZXNjcmlwdG9yLmVudW1lcmFibGUgPSBkZXNjcmlwdG9yLmVudW1lcmFibGUgfHwgZmFsc2U7IGRlc2NyaXB0b3IuY29uZmlndXJhYmxlID0gdHJ1ZTsgaWYgKCJ2YWx1ZSIgaW4gZGVzY3JpcHRvcikgZGVzY3JpcHRvci53cml0YWJsZSA9IHRydWU7IE9iamVjdC5kZWZpbmVQcm9wZXJ0eSh0YXJnZXQsIGRlc2NyaXB0b3Iua2V5LCBkZXNjcmlwdG9yKTsgfSB9IHJldHVybiBmdW5jdGlvbiAoQ29uc3RydWN0b3IsIHByb3RvUHJvcHMsIHN0YXRpY1Byb3BzKSB7IGlmIChwcm90b1Byb3BzKSBkZWZpbmVQcm9wZXJ0aWVzKENvbnN0cnVjdG9yLnByb3RvdHlwZSwgcHJvdG9Qcm9wcyk7IGlmIChzdGF0aWNQcm9wcykgZGVmaW5lUHJvcGVydGllcyhDb25zdHJ1Y3Rvciwgc3RhdGljUHJvcHMpOyByZXR1cm4gQ29uc3RydWN0b3I7IH07IH0pKCk7CgpmdW5jdGlvbiBfY2xhc3NDYWxsQ2hlY2soaW5zdGFuY2UsIENvbnN0cnVjdG9yKSB7IGlmICghKGluc3RhbmNlIGluc3RhbmNlb2YgQ29uc3RydWN0b3IpKSB7IHRocm93IG5ldyBUeXBlRXJyb3IoIkNhbm5vdCBjYWxsIGEgY2xhc3MgYXMgYSBmdW5jdGlvbiIpOyB9IH0KCnZhciBTb3VyY2VQYWNrYWdlID0gKGZ1bmN0aW9uICgpIHsKICAgIGZ1bmN0aW9uIFNvdXJjZVBhY2thZ2Uoc291cmNlQ29kZSwgc291cmNlQ29kZUNsYXNzbmFtZSkgewogICAgICAgIF9jbGFzc0NhbGxDaGVjayh0aGlzLCBTb3VyY2VQYWNrYWdlKTsKCiAgICAgICAgdGhpcy5fc291cmNlQ29kZSA9IHNvdXJjZUNvZGU7CiAgICAgICAgdGhpcy5fc291cmNlQ29kZUNsYXNzbmFtZSA9IHNvdXJjZUNvZGVDbGFzc25hbWU7CgogICAgICAgIHRoaXMuX2VuY29kaW5nID0gbnVsbDsKICAgICAgICB0aGlzLl9zaWduYXR1cmUgPSBudWxsOwogICAgfQoKICAgIF9jcmVhdGVDbGFzcyhTb3VyY2VQYWNrYWdlLCBbewogICAgICAgIGtleTogInNvdXJjZUNvZGUiLAogICAgICAgIGdldDogZnVuY3Rpb24gZ2V0KCkgewogICAgICAgICAgICByZXR1cm4gdGhpcy5fc291cmNlQ29kZTsKICAgICAgICB9CiAgICB9LCB7CiAgICAgICAga2V5OiAic291cmNlQ29kZUNsYXNzbmFtZSIsCiAgICAgICAgZ2V0OiBmdW5jdGlvbiBnZXQoKSB7CiAgICAgICAgICAgIHJldHVybiB0aGlzLl9zb3VyY2VDb2RlOwogICAgICAgIH0KICAgIH0sIHsKICAgICAgICBrZXk6ICJlbmNvZGluZyIsCiAgICAgICAgZ2V0OiBmdW5jdGlvbiBnZXQoKSB7CiAgICAgICAgICAgIHJldHVybiB0aGlzLl9lbmNvZGluZzsKICAgICAgICB9LAogICAgICAgIHNldDogZnVuY3Rpb24gc2V0KGVuY29kaW5nKSB7CiAgICAgICAgICAgIGlmIChlbmNvZGluZykgdGhpcy5fZW5jb2RpbmcgPSBlbmNvZGluZzsKICAgICAgICB9CiAgICB9LCB7CiAgICAgICAga2V5OiAic2lnbmF0dXJlIiwKICAgICAgICBnZXQ6IGZ1bmN0aW9uIGdldCgpIHsKICAgICAgICAgICAgcmV0dXJuIHRoaXMuX3NpZ25hdHVyZTsKICAgICAgICB9LAogICAgICAgIHNldDogZnVuY3Rpb24gc2V0KHNpZ24pIHsKICAgICAgICAgICAgaWYgKHNpZ24pIHRoaXMuX3NpZ25hdHVyZSA9IHNpZ247CiAgICAgICAgfQogICAgfV0pOwoKICAgIHJldHVybiBTb3VyY2VQYWNrYWdlOwp9KSgpOwoKZXhwb3J0c1siZGVmYXVsdCJdID0gU291cmNlUGFja2FnZTsKbW9kdWxlLmV4cG9ydHMgPSBleHBvcnRzWyJkZWZhdWx0Il07Cgp9LHt9XSwxMjpbZnVuY3Rpb24ocmVxdWlyZSxtb2R1bGUsZXhwb3J0cyl7Ci8qIGpzaGludCB1bmRlZjogdHJ1ZSAqLwovKiBnbG9iYWxzIFJUQ1BlZXJDb25uZWN0aW9uICovCi8qIGdsb2JhbHMgUlRDU2Vzc2lvbkRlc2NyaXB0aW9uICovCi8qIGdsb2JhbHMgUlRDSWNlQ2FuZGlkYXRlICovCgondXNlIHN0cmljdCc7CgpPYmplY3QuZGVmaW5lUHJvcGVydHkoZXhwb3J0cywgJ19fZXNNb2R1bGUnLCB7CiAgdmFsdWU6IHRydWUKfSk7Cgp2YXIgX2NyZWF0ZUNsYXNzID0gKGZ1bmN0aW9uICgpIHsgZnVuY3Rpb24gZGVmaW5lUHJvcGVydGllcyh0YXJnZXQsIHByb3BzKSB7IGZvciAodmFyIGkgPSAwOyBpIDwgcHJvcHMubGVuZ3RoOyBpKyspIHsgdmFyIGRlc2NyaXB0b3IgPSBwcm9wc1tpXTsgZGVzY3JpcHRvci5lbnVtZXJhYmxlID0gZGVzY3JpcHRvci5lbnVtZXJhYmxlIHx8IGZhbHNlOyBkZXNjcmlwdG9yLmNvbmZpZ3VyYWJsZSA9IHRydWU7IGlmICgndmFsdWUnIGluIGRlc2NyaXB0b3IpIGRlc2NyaXB0b3Iud3JpdGFibGUgPSB0cnVlOyBPYmplY3QuZGVmaW5lUHJvcGVydHkodGFyZ2V0LCBkZXNjcmlwdG9yLmtleSwgZGVzY3JpcHRvcik7IH0gfSByZXR1cm4gZnVuY3Rpb24gKENvbnN0cnVjdG9yLCBwcm90b1Byb3BzLCBzdGF0aWNQcm9wcykgeyBpZiAocHJvdG9Qcm9wcykgZGVmaW5lUHJvcGVydGllcyhDb25zdHJ1Y3Rvci5wcm90b3R5cGUsIHByb3RvUHJvcHMpOyBpZiAoc3RhdGljUHJvcHMpIGRlZmluZVByb3BlcnRpZXMoQ29uc3RydWN0b3IsIHN0YXRpY1Byb3BzKTsgcmV0dXJuIENvbnN0cnVjdG9yOyB9OyB9KSgpOwoKdmFyIF9nZXQgPSBmdW5jdGlvbiBnZXQoX3gsIF94MiwgX3gzKSB7IHZhciBfYWdhaW4gPSB0cnVlOyBfZnVuY3Rpb246IHdoaWxlIChfYWdhaW4pIHsgdmFyIG9iamVjdCA9IF94LCBwcm9wZXJ0eSA9IF94MiwgcmVjZWl2ZXIgPSBfeDM7IF9hZ2FpbiA9IGZhbHNlOyBpZiAob2JqZWN0ID09PSBudWxsKSBvYmplY3QgPSBGdW5jdGlvbi5wcm90b3R5cGU7IHZhciBkZXNjID0gT2JqZWN0LmdldE93blByb3BlcnR5RGVzY3JpcHRvcihvYmplY3QsIHByb3BlcnR5KTsgaWYgKGRlc2MgPT09IHVuZGVmaW5lZCkgeyB2YXIgcGFyZW50ID0gT2JqZWN0LmdldFByb3RvdHlwZU9mKG9iamVjdCk7IGlmIChwYXJlbnQgPT09IG51bGwpIHsgcmV0dXJuIHVuZGVmaW5lZDsgfSBlbHNlIHsgX3ggPSBwYXJlbnQ7IF94MiA9IHByb3BlcnR5OyBfeDMgPSByZWNlaXZlcjsgX2FnYWluID0gdHJ1ZTsgZGVzYyA9IHBhcmVudCA9IHVuZGVmaW5lZDsgY29udGludWUgX2Z1bmN0aW9uOyB9IH0gZWxzZSBpZiAoJ3ZhbHVlJyBpbiBkZXNjKSB7IHJldHVybiBkZXNjLnZhbHVlOyB9IGVsc2UgeyB2YXIgZ2V0dGVyID0gZGVzYy5nZXQ7IGlmIChnZXR0ZXIgPT09IHVuZGVmaW5lZCkgeyByZXR1cm4gdW5kZWZpbmVkOyB9IHJldHVybiBnZXR0ZXIuY2FsbChyZWNlaXZlcik7IH0gfSB9OwoKZnVuY3Rpb24gX2ludGVyb3BSZXF1aXJlRGVmYXVsdChvYmopIHsgcmV0dXJuIG9iaiAmJiBvYmouX19lc01vZHVsZSA/IG9iaiA6IHsgJ2RlZmF1bHQnOiBvYmogfTsgfQoKZnVuY3Rpb24gX2NsYXNzQ2FsbENoZWNrKGluc3RhbmNlLCBDb25zdHJ1Y3RvcikgeyBpZiAoIShpbnN0YW5jZSBpbnN0YW5jZW9mIENvbnN0cnVjdG9yKSkgeyB0aHJvdyBuZXcgVHlwZUVycm9yKCdDYW5ub3QgY2FsbCBhIGNsYXNzIGFzIGEgZnVuY3Rpb24nKTsgfSB9CgpmdW5jdGlvbiBfaW5oZXJpdHMoc3ViQ2xhc3MsIHN1cGVyQ2xhc3MpIHsgaWYgKHR5cGVvZiBzdXBlckNsYXNzICE9PSAnZnVuY3Rpb24nICYmIHN1cGVyQ2xhc3MgIT09IG51bGwpIHsgdGhyb3cgbmV3IFR5cGVFcnJvcignU3VwZXIgZXhwcmVzc2lvbiBtdXN0IGVpdGhlciBiZSBudWxsIG9yIGEgZnVuY3Rpb24sIG5vdCAnICsgdHlwZW9mIHN1cGVyQ2xhc3MpOyB9IHN1YkNsYXNzLnByb3RvdHlwZSA9IE9iamVjdC5jcmVhdGUoc3VwZXJDbGFzcyAmJiBzdXBlckNsYXNzLnByb3RvdHlwZSwgeyBjb25zdHJ1Y3RvcjogeyB2YWx1ZTogc3ViQ2xhc3MsIGVudW1lcmFibGU6IGZhbHNlLCB3cml0YWJsZTogdHJ1ZSwgY29uZmlndXJhYmxlOiB0cnVlIH0gfSk7IGlmIChzdXBlckNsYXNzKSBPYmplY3Quc2V0UHJvdG90eXBlT2YgPyBPYmplY3Quc2V0UHJvdG90eXBlT2Yoc3ViQ2xhc3MsIHN1cGVyQ2xhc3MpIDogc3ViQ2xhc3MuX19wcm90b19fID0gc3VwZXJDbGFzczsgfQoKcmVxdWlyZSgnd2VicnRjLWFkYXB0ZXItdGVzdCcpOwoKdmFyIF91dGlsc0V2ZW50RW1pdHRlciA9IHJlcXVpcmUoJy4uL3V0aWxzL0V2ZW50RW1pdHRlcicpOwoKdmFyIF91dGlsc0V2ZW50RW1pdHRlcjIgPSBfaW50ZXJvcFJlcXVpcmVEZWZhdWx0KF91dGlsc0V2ZW50RW1pdHRlcik7Cgp2YXIgQ29ubmVjdGlvbkNvbnRyb2xsZXIgPSAoZnVuY3Rpb24gKF9FdmVudEVtaXR0ZXIpIHsKICBfaW5oZXJpdHMoQ29ubmVjdGlvbkNvbnRyb2xsZXIsIF9FdmVudEVtaXR0ZXIpOwoKICBmdW5jdGlvbiBDb25uZWN0aW9uQ29udHJvbGxlcigpIHsKICAgIF9jbGFzc0NhbGxDaGVjayh0aGlzLCBDb25uZWN0aW9uQ29udHJvbGxlcik7CgogICAgX2dldChPYmplY3QuZ2V0UHJvdG90eXBlT2YoQ29ubmVjdGlvbkNvbnRyb2xsZXIucHJvdG90eXBlKSwgJ2NvbnN0cnVjdG9yJywgdGhpcykuY2FsbCh0aGlzKTsKCiAgICB2YXIgX3RoaXMgPSB0aGlzOwoKICAgIF90aGlzLm1vZGUgPSAnb2ZmZXInOwoKICAgIF90aGlzLm1lZGlhQ29uc3RyYWludHMgPSB7CiAgICAgIG9wdGlvbmFsOiBbXSwKICAgICAgbWFuZGF0b3J5OiB7CiAgICAgICAgb2ZmZXJUb1JlY2VpdmVBdWRpbzogdHJ1ZSwKICAgICAgICBvZmZlclRvUmVjZWl2ZVZpZGVvOiB0cnVlCiAgICAgIH0KICAgIH07CgogICAgLy8gUHJlcGFyZSB0aGUgUGVlckNvbm5lY3Rpb24KICAgIHZhciBwZWVyQ29ubmVjdGlvbiA9IG5ldyBSVENQZWVyQ29ubmVjdGlvbigpOwoKICAgIHBlZXJDb25uZWN0aW9uLmFkZEV2ZW50TGlzdGVuZXIoJ3NpZ25hbGluZ3N0YXRlY2hhbmdlJywgZnVuY3Rpb24gKGV2ZW50KSB7CgogICAgICBjb25zb2xlLmluZm8oJ3NpZ25hbGluZ3N0YXRlY2hhbmdlJywgZXZlbnQpOwoKICAgICAgaWYgKGV2ZW50LmN1cnJlbnRUYXJnZXQuc2lnbmFsaW5nU3RhdGUgPT09ICdoYXZlLXJlbW90ZS1vZmZlcicpIHsKICAgICAgICBfdGhpcy5tb2RlID0gJ2Fuc3dlcic7CiAgICAgICAgX3RoaXMudHJpZ2dlcignY29udHJvbGxlcjpzdGF0ZTpjaGFuZ2UnLCBfdGhpcy5tb2RlKTsKICAgICAgfQoKICAgICAgaWYgKGV2ZW50LmN1cnJlbnRUYXJnZXQuc2lnbmFsaW5nU3RhdGUgPT09ICdoYXZlLWxvY2FsLW9mZmVyJykgewogICAgICAgIF90aGlzLnRyaWdnZXIoJ2NvbnRyb2xsZXI6c3RhdGU6Y2hhbmdlJywgX3RoaXMubW9kZSk7CiAgICAgIH0KICAgIH0pOwoKICAgIHBlZXJDb25uZWN0aW9uLmFkZEV2ZW50TGlzdGVuZXIoJ2ljZWNvbm5lY3Rpb25zdGF0ZWNoYW5nZScsIGZ1bmN0aW9uIChldmVudCkgewogICAgICBjb25zb2xlLmluZm8oZXZlbnQuY3VycmVudFRhcmdldC5pY2VDb25uZWN0aW9uU3RhdGUpOwogICAgfSk7CgogICAgcGVlckNvbm5lY3Rpb24uYWRkRXZlbnRMaXN0ZW5lcignaWNlY2FuZGlkYXRlJywgZnVuY3Rpb24gKGV2ZW50KSB7CgogICAgICBpZiAoIWV2ZW50LmNhbmRpZGF0ZSkgcmV0dXJuOwoKICAgICAgdmFyIGRhdGEgPSBfdGhpcy5fY29ubmVjdGlvbkRhdGFPYmplY3RSZXBvcnRlci5kYXRhOwogICAgICBkYXRhLmljZSA9IHsKICAgICAgICB0eXBlOiAnY2FuZGlkYXRlJywKICAgICAgICBjYW5kaWRhdGU6IGV2ZW50LmNhbmRpZGF0ZS5jYW5kaWRhdGUsCiAgICAgICAgc2RwTWlkOiBldmVudC5jYW5kaWRhdGUuc2RwTWlkLAogICAgICAgIHNkcE1MaW5lSW5kZXg6IGV2ZW50LmNhbmRpZGF0ZS5zZHBNTGluZUluZGV4CiAgICAgIH07CiAgICB9KTsKCiAgICAvLyBBZGQgc3RyZWFtIHRvIFBlZXJDb25uZWN0aW9uCiAgICBwZWVyQ29ubmVjdGlvbi5hZGRFdmVudExpc3RlbmVyKCdhZGRzdHJlYW0nLCBmdW5jdGlvbiAoZXZlbnQpIHsKICAgICAgY29uc29sZS5pbmZvKCdhZGQgc3RyZWFtIGZyb20gbW9kZTogJywgX3RoaXMubW9kZSk7CiAgICAgIF90aGlzLnRyaWdnZXIoJ3N0cmVhbTphZGRlZCcsIFVSTC5jcmVhdGVPYmplY3RVUkwoZXZlbnQuc3RyZWFtKSwgX3RoaXMuY29ubmVjdGlvbkRhdGFPYmplY3RSZXBvcnRlciwgX3RoaXMuY29ubmVjdGlvbkRhdGFPYmplY3RPYnNlcnZlcik7CiAgICB9KTsKCiAgICBfdGhpcy5wZWVyQ29ubmVjdGlvbiA9IHBlZXJDb25uZWN0aW9uOwogIH0KCiAgX2NyZWF0ZUNsYXNzKENvbm5lY3Rpb25Db250cm9sbGVyLCBbewogICAga2V5OiAnZ2V0VXNlck1lZGlhJywKCiAgICAvKioKICAgICAqIEdldCBXZWJSVEMgQVBJIHJlc291cmNlcwogICAgICogQHBhcmFtICB7T2JqZWN0fSAgICAgb3B0aW9ucyBPYmplY3QgY29udGFpbmluZyB0aGUgaW5mb3JtYXRpb24gdGhhdCByZXNvdXJjZXMgd2lsbCBiZSB1c2VkIChjYW1lcmEsIG1pYywgcmVzb2x1dGlvbiwgZXRjKTsKICAgICAqIEByZXR1cm4ge1Byb21pc2V9CiAgICAgKi8KICAgIHZhbHVlOiBmdW5jdGlvbiBnZXRVc2VyTWVkaWEoY29uc3RyYWludHMpIHsKCiAgICAgIHZhciBfdGhpcyA9IHRoaXM7CgogICAgICByZXR1cm4gbmV3IFByb21pc2UoZnVuY3Rpb24gKHJlc29sdmUsIHJlamVjdCkgewoKICAgICAgICBuYXZpZ2F0b3IubWVkaWFEZXZpY2VzLmdldFVzZXJNZWRpYShjb25zdHJhaW50cykudGhlbihmdW5jdGlvbiAobWVkaWFTdHJlYW0pIHsKICAgICAgICAgIF90aGlzLnBlZXJDb25uZWN0aW9uLmFkZFN0cmVhbShtZWRpYVN0cmVhbSk7CiAgICAgICAgICByZXNvbHZlKG1lZGlhU3RyZWFtKTsKICAgICAgICB9KVsnY2F0Y2gnXShmdW5jdGlvbiAocmVhc29uKSB7CiAgICAgICAgICByZWplY3QocmVhc29uKTsKICAgICAgICB9KTsKICAgICAgfSk7CiAgICB9CiAgfSwgewogICAga2V5OiAnY2hhbmdlUGVlckluZm9ybWF0aW9uJywKICAgIHZhbHVlOiBmdW5jdGlvbiBjaGFuZ2VQZWVySW5mb3JtYXRpb24oKSB7CgogICAgICB2YXIgX3RoaXMgPSB0aGlzOwoKICAgICAgX3RoaXMuX2Nvbm5lY3Rpb25EYXRhT2JqZWN0T2JzZXJ2ZXIub25DaGFuZ2UoJyonLCBmdW5jdGlvbiAoZXZlbnQpIHsKICAgICAgICBjb25zb2xlLmRlYnVnKCdtZXNzYWdlOicsIGV2ZW50KTsKCiAgICAgICAgdmFyIG1lc3NhZ2UgPSBldmVudC5kYXRhOwoKICAgICAgICBpZiAobWVzc2FnZS50eXBlID09PSAnb2ZmZXInIHx8IG1lc3NhZ2UudHlwZSA9PT0gJ2Fuc3dlcicpIHsKCiAgICAgICAgICBfdGhpcy5wZWVyQ29ubmVjdGlvbi5zZXRSZW1vdGVEZXNjcmlwdGlvbihuZXcgUlRDU2Vzc2lvbkRlc2NyaXB0aW9uKG1lc3NhZ2UpLCBfdGhpcy5yZW1vdGVEZXNjcmlwdGlvblN1Y2Nlc3MsIF90aGlzLnJlbW90ZURlc2NyaXB0aW9uRXJyb3IpOwogICAgICAgIH0gZWxzZSBpZiAobWVzc2FnZS50eXBlID09PSAnY2FuZGlkYXRlJykgewogICAgICAgICAgX3RoaXMucGVlckNvbm5lY3Rpb24uYWRkSWNlQ2FuZGlkYXRlKG5ldyBSVENJY2VDYW5kaWRhdGUoeyBjYW5kaWRhdGU6IG1lc3NhZ2UuY2FuZGlkYXRlIH0pKTsKICAgICAgICB9CiAgICAgIH0pOwogICAgfQogIH0sIHsKICAgIGtleTogJ3JlbW90ZURlc2NyaXB0aW9uU3VjY2VzcycsCiAgICB2YWx1ZTogZnVuY3Rpb24gcmVtb3RlRGVzY3JpcHRpb25TdWNjZXNzKCkgewogICAgICBjb25zb2xlLmluZm8oJ3JlbW90ZSBzdWNjZXNzJyk7CiAgICB9CiAgfSwgewogICAga2V5OiAncmVtb3RlRGVzY3JpcHRpb25FcnJvcicsCiAgICB2YWx1ZTogZnVuY3Rpb24gcmVtb3RlRGVzY3JpcHRpb25FcnJvcihlcnJvcikgewogICAgICBjb25zb2xlLmVycm9yKCdlcnJvcjogJywgZXJyb3IpOwogICAgfQogIH0sIHsKICAgIGtleTogJ2NyZWF0ZU9mZmVyJywKICAgIHZhbHVlOiBmdW5jdGlvbiBjcmVhdGVPZmZlcigpIHsKICAgICAgdmFyIF90aGlzID0gdGhpczsKCiAgICAgIF90aGlzLnBlZXJDb25uZWN0aW9uLmNyZWF0ZU9mZmVyKGZ1bmN0aW9uIChkZXNjcmlwdGlvbikgewogICAgICAgIF90aGlzLm9uTG9jYWxTZXNzaW9uQ3JlYXRlZChkZXNjcmlwdGlvbik7CiAgICAgIH0sIF90aGlzLmluZm9FcnJvciwgX3RoaXMubWVkaWFDb25zdHJhaW50cyk7CiAgICB9CiAgfSwgewogICAga2V5OiAnY3JlYXRlQW5zd2VyJywKICAgIHZhbHVlOiBmdW5jdGlvbiBjcmVhdGVBbnN3ZXIoKSB7CiAgICAgIHZhciBfdGhpcyA9IHRoaXM7CgogICAgICBfdGhpcy5wZWVyQ29ubmVjdGlvbi5jcmVhdGVBbnN3ZXIoZnVuY3Rpb24gKGRlc2NyaXB0aW9uKSB7CiAgICAgICAgX3RoaXMub25Mb2NhbFNlc3Npb25DcmVhdGVkKGRlc2NyaXB0aW9uKTsKICAgICAgfSwgX3RoaXMuaW5mb0Vycm9yKTsKICAgIH0KICB9LCB7CiAgICBrZXk6ICdvbkxvY2FsU2Vzc2lvbkNyZWF0ZWQnLAogICAgdmFsdWU6IGZ1bmN0aW9uIG9uTG9jYWxTZXNzaW9uQ3JlYXRlZChkZXNjcmlwdGlvbikgewoKICAgICAgdmFyIF90aGlzID0gdGhpczsKICAgICAgdmFyIHBlZXJDb25uZWN0aW9uID0gX3RoaXMucGVlckNvbm5lY3Rpb247CgogICAgICBwZWVyQ29ubmVjdGlvbi5zZXRMb2NhbERlc2NyaXB0aW9uKGRlc2NyaXB0aW9uLCBmdW5jdGlvbiAoKSB7CgogICAgICAgIHZhciBkYXRhID0gX3RoaXMuX2Nvbm5lY3Rpb25EYXRhT2JqZWN0UmVwb3J0ZXIuZGF0YTsKICAgICAgICBkYXRhLnNkcCA9IHsKICAgICAgICAgIHNkcDogZGVzY3JpcHRpb24uc2RwLAogICAgICAgICAgdHlwZTogZGVzY3JpcHRpb24udHlwZQogICAgICAgIH07CiAgICAgIH0sIF90aGlzLmluZm9FcnJvcik7CiAgICB9CiAgfSwgewogICAga2V5OiAnaW5mb0Vycm9yJywKICAgIHZhbHVlOiBmdW5jdGlvbiBpbmZvRXJyb3IoZXJyKSB7CiAgICAgIGNvbnNvbGUuZXJyb3IoZXJyLnRvU3RyaW5nKCksIGVycik7CiAgICB9CgogICAgLyoqCiAgICAgKiBVc2VkIHRvIGFjY2VwdCBhbiBpbmNvbWluZyBjb25uZWN0aW9uIHJlcXVlc3QuCiAgICAgKiBAbWV0aG9kIGFjY2VwdAogICAgICogQHJldHVybiB7UHJvbWlzZX0KICAgICAqLwogIH0sIHsKICAgIGtleTogJ2FjY2VwdCcsCiAgICB2YWx1ZTogZnVuY3Rpb24gYWNjZXB0KCkgewogICAgICAvLyBUT0RPOiBvcHRpbWl6ZSB0aGUgZGlzY29ubmVjdCBmdW5jdGlvbgoKICAgICAgLy8gbGV0IF90aGlzID0gdGhpczsKCiAgICAgIHJldHVybiBuZXcgUHJvbWlzZShmdW5jdGlvbiAocmVzb2x2ZSwgcmVqZWN0KSB7CiAgICAgICAgdHJ5IHsKICAgICAgICAgIHJlc29sdmUodHJ1ZSk7CiAgICAgICAgfSBjYXRjaCAoZSkgewogICAgICAgICAgcmVqZWN0KCdlcnJvciBhY2NlcHRpbmcgY29ubmVjdGlvbicpOwogICAgICAgIH0KICAgICAgfSk7CiAgICB9CgogICAgLyoqCiAgICAqIFVzZWQgdG8gZGVjbGluZSBhbiBpbmNvbWluZyBjb25uZWN0aW9uIHJlcXVlc3QuCiAgICAqIEBtZXRob2QgZGVjbGluZQogICAgKiBAcmV0dXJuIHtQcm9taXNlfQogICAgKi8KICB9LCB7CiAgICBrZXk6ICdkZWNsaW5lJywKICAgIHZhbHVlOiBmdW5jdGlvbiBkZWNsaW5lKCkge30KCiAgICAvKioKICAgICAqIFVzZWQgdG8gY2xvc2UgYW4gZXhpc3RpbmcgY29ubmVjdGlvbiBpbnN0YW5jZS4KICAgICAqIEBtZXRob2QgZGlzY29ubmVjdAogICAgICogQHJldHVybiB7UHJvbWlzZX0KICAgICAqLwogIH0sIHsKICAgIGtleTogJ2Rpc2Nvbm5lY3QnLAogICAgdmFsdWU6IGZ1bmN0aW9uIGRpc2Nvbm5lY3QoKSB7CgogICAgICAvLyBUT0RPOiBvcHRpbWl6ZSB0aGUgZGlzY29ubmVjdCBmdW5jdGlvbgoKICAgICAgdmFyIF90aGlzID0gdGhpczsKCiAgICAgIHJldHVybiBuZXcgUHJvbWlzZShmdW5jdGlvbiAocmVzb2x2ZSwgcmVqZWN0KSB7CgogICAgICAgIHRyeSB7CgogICAgICAgICAgX3RoaXMucGVlckNvbm5lY3Rpb24uY2xvc2UoKTsKCiAgICAgICAgICByZXNvbHZlKHRydWUpOwogICAgICAgIH0gY2F0Y2ggKGUpIHsKICAgICAgICAgIHJlamVjdCgnZXJyb3IgZGlzY29ubmVjdGluZyBjb25uZWN0aW9uJyk7CiAgICAgICAgfQogICAgICB9KTsKICAgIH0KCiAgICAvKioKICAgICAqIFVzZWQgdG8gYWRkL2ludml0ZSBuZXcgcGVlcnMgb24gYW4gZXhpc3RpbmcgY29ubmVjdGlvbiBpbnN0YW5jZSAoZm9yIG11bHRpcGFydHkgY29ubmVjdGlvbnMpLgogICAgICogQG1ldGhvZCBhZGRQZWVyCiAgICAgKiBAcmV0dXJuIHtQcm9taXNlfQogICAgICovCiAgfSwgewogICAga2V5OiAnYWRkUGVlcicsCiAgICB2YWx1ZTogZnVuY3Rpb24gYWRkUGVlcigpIHt9CgogICAgLyoqCiAgICAgKiBVc2VkIHRvIHJlbW92ZSBhIHBlZXIgZnJvbSBhbiBleGlzdGluZyBjb25uZWN0aW9uIGluc3RhbmNlLgogICAgICogQG1ldGhvZCByZW1vdmVQZWVyCiAgICAgKiBAcmV0dXJuIHtQcm9taXNlfQogICAgICovCiAgfSwgewogICAga2V5OiAncmVtb3ZlUGVlcicsCiAgICB2YWx1ZTogZnVuY3Rpb24gcmVtb3ZlUGVlcigpIHt9CiAgfSwgewogICAga2V5OiAnc3RhdHVzJywKICAgIGdldDogZnVuY3Rpb24gZ2V0KCkgewogICAgICB2YXIgX3RoaXMgPSB0aGlzOwogICAgICByZXR1cm4gX3RoaXMuX3N0YXR1czsKICAgIH0KCiAgICAvKioKICAgICogU2V0IHRoZSBjb25uZWN0aW9uRGF0YU9iamVjdCBpbiB0aGUgY29udHJvbGxlcgogICAgKiBAcGFyYW0ge0Nvbm5lY3Rpb25EYXRhT2JqZWN0fSBjb25uZWN0aW9uRGF0YU9iamVjdCAtIGhhdmUgYWxsIGluZm9ybWF0aW9uIGFib3V0IHRoZSBzeW5jaGVyIG9iamVjdDsKICAgICovCiAgfSwgewogICAga2V5OiAnY29ubmVjdGlvbkRhdGFPYmplY3RSZXBvcnRlcicsCiAgICBzZXQ6IGZ1bmN0aW9uIHNldChjb25uZWN0aW9uRGF0YU9iamVjdCkgewogICAgICBpZiAoIWNvbm5lY3Rpb25EYXRhT2JqZWN0KSB0aHJvdyBuZXcgRXJyb3IoJ1RoZSBDb25uZWN0aW9uIERhdGEgT2JqZWN0IGlzIGEgbmVlZGVkIHBhcmFtZXRlcicpOwoKICAgICAgdmFyIF90aGlzID0gdGhpczsKICAgICAgX3RoaXMuX2Nvbm5lY3Rpb25EYXRhT2JqZWN0UmVwb3J0ZXIgPSBjb25uZWN0aW9uRGF0YU9iamVjdDsKCiAgICAgIGNvbm5lY3Rpb25EYXRhT2JqZWN0Lm9uU3Vic2NyaXB0aW9uKGZ1bmN0aW9uIChldmVudCkgewogICAgICAgIGV2ZW50LmFjY2VwdCgpOwoKICAgICAgICBpZiAoX3RoaXMubW9kZSA9PT0gJ29mZmVyJykgewogICAgICAgICAgX3RoaXMuY3JlYXRlT2ZmZXIoKTsKICAgICAgICB9IGVsc2UgewogICAgICAgICAgX3RoaXMuY3JlYXRlQW5zd2VyKCk7CiAgICAgICAgfQogICAgICB9KTsKCiAgICAgIGNvbnNvbGUuaW5mbygnU2V0IGNvbm5lY3Rpb25EYXRhT2JqZWN0OiAnLCBfdGhpcy5fY29ubmVjdGlvbkRhdGFPYmplY3RSZXBvcnRlcik7CiAgICB9LAoKICAgIC8qKgogICAgKiByZXR1cm4gdGhlIGNvbm5lY3Rpb25EYXRhT2JqZWN0IGluIHRoZSBjb250cm9sbGVyCiAgICAqIEByZXR1cm4ge0Nvbm5lY3Rpb25EYXRhT2JqZWN0fSBjb25uZWN0aW9uRGF0YU9iamVjdAogICAgKi8KICAgIGdldDogZnVuY3Rpb24gZ2V0KCkgewogICAgICB2YXIgX3RoaXMgPSB0aGlzOwogICAgICByZXR1cm4gX3RoaXMuX2Nvbm5lY3Rpb25EYXRhT2JqZWN0UmVwb3J0ZXI7CiAgICB9CgogICAgLyoqCiAgICAqIFNldCB0aGUgY29ubmVjdGlvbkRhdGFPYmplY3QgaW4gdGhlIGNvbnRyb2xsZXIKICAgICogQHBhcmFtIHtDb25uZWN0aW9uRGF0YU9iamVjdH0gY29ubmVjdGlvbkRhdGFPYmplY3QgLSBoYXZlIGFsbCBpbmZvcm1hdGlvbiBhYm91dCB0aGUgc3luY2hlciBvYmplY3Q7CiAgICAqLwogIH0sIHsKICAgIGtleTogJ2Nvbm5lY3Rpb25EYXRhT2JqZWN0T2JzZXJ2ZXInLAogICAgc2V0OiBmdW5jdGlvbiBzZXQoY29ubmVjdGlvbkRhdGFPYmplY3QpIHsKICAgICAgaWYgKCFjb25uZWN0aW9uRGF0YU9iamVjdCkgdGhyb3cgbmV3IEVycm9yKCdUaGUgQ29ubmVjdGlvbiBEYXRhIE9iamVjdCBpcyBhIG5lZWRlZCBwYXJhbWV0ZXInKTsKCiAgICAgIHZhciBfdGhpcyA9IHRoaXM7CiAgICAgIF90aGlzLl9jb25uZWN0aW9uRGF0YU9iamVjdE9ic2VydmVyID0gY29ubmVjdGlvbkRhdGFPYmplY3Q7CgogICAgICBjb25uZWN0aW9uRGF0YU9iamVjdC5vbk5vdGlmaWNhdGlvbihmdW5jdGlvbiAoZXZlbnQpIHsKICAgICAgICBjb25zb2xlLmluZm8oJ0Nvbm5lY3Rpb24gRGF0YSBPYmplY3QgT2JzZXJ2ZXIgbm90aWZpY2F0aW9uOiAnLCBldmVudCk7CiAgICAgICAgX3RoaXMudHJpZ2dlcignb246bm90aWZpY2F0aW9uJywgZXZlbnQpOwogICAgICB9KTsKCiAgICAgIGNvbnNvbGUuaW5mbygnU2V0IGNvbm5lY3Rpb25EYXRhT2JqZWN0OiAnLCBfdGhpcy5fY29ubmVjdGlvbkRhdGFPYmplY3RPYnNlcnZlcik7CgogICAgICBfdGhpcy5jaGFuZ2VQZWVySW5mb3JtYXRpb24oKTsKICAgIH0sCgogICAgLyoqCiAgICAqIHJldHVybiB0aGUgY29ubmVjdGlvbkRhdGFPYmplY3QgaW4gdGhlIGNvbnRyb2xsZXIKICAgICogQHJldHVybiB7Q29ubmVjdGlvbkRhdGFPYmplY3R9IGNvbm5lY3Rpb25EYXRhT2JqZWN0CiAgICAqLwogICAgZ2V0OiBmdW5jdGlvbiBnZXQoKSB7CiAgICAgIHZhciBfdGhpcyA9IHRoaXM7CiAgICAgIHJldHVybiBfdGhpcy5fY29ubmVjdGlvbkRhdGFPYmplY3RPYnNlcnZlcjsKICAgIH0KICB9XSk7CgogIHJldHVybiBDb25uZWN0aW9uQ29udHJvbGxlcjsKfSkoX3V0aWxzRXZlbnRFbWl0dGVyMlsnZGVmYXVsdCddKTsKCmV4cG9ydHNbJ2RlZmF1bHQnXSA9IENvbm5lY3Rpb25Db250cm9sbGVyOwptb2R1bGUuZXhwb3J0cyA9IGV4cG9ydHNbJ2RlZmF1bHQnXTsKCn0seyIuLi91dGlscy9FdmVudEVtaXR0ZXIiOjIzLCJ3ZWJydGMtYWRhcHRlci10ZXN0IjoyfV0sMTM6W2Z1bmN0aW9uKHJlcXVpcmUsbW9kdWxlLGV4cG9ydHMpewondXNlIHN0cmljdCc7CgpPYmplY3QuZGVmaW5lUHJvcGVydHkoZXhwb3J0cywgJ19fZXNNb2R1bGUnLCB7CiAgdmFsdWU6IHRydWUKfSk7Cgp2YXIgX2NyZWF0ZUNsYXNzID0gKGZ1bmN0aW9uICgpIHsgZnVuY3Rpb24gZGVmaW5lUHJvcGVydGllcyh0YXJnZXQsIHByb3BzKSB7IGZvciAodmFyIGkgPSAwOyBpIDwgcHJvcHMubGVuZ3RoOyBpKyspIHsgdmFyIGRlc2NyaXB0b3IgPSBwcm9wc1tpXTsgZGVzY3JpcHRvci5lbnVtZXJhYmxlID0gZGVzY3JpcHRvci5lbnVtZXJhYmxlIHx8IGZhbHNlOyBkZXNjcmlwdG9yLmNvbmZpZ3VyYWJsZSA9IHRydWU7IGlmICgndmFsdWUnIGluIGRlc2NyaXB0b3IpIGRlc2NyaXB0b3Iud3JpdGFibGUgPSB0cnVlOyBPYmplY3QuZGVmaW5lUHJvcGVydHkodGFyZ2V0LCBkZXNjcmlwdG9yLmtleSwgZGVzY3JpcHRvcik7IH0gfSByZXR1cm4gZnVuY3Rpb24gKENvbnN0cnVjdG9yLCBwcm90b1Byb3BzLCBzdGF0aWNQcm9wcykgeyBpZiAocHJvdG9Qcm9wcykgZGVmaW5lUHJvcGVydGllcyhDb25zdHJ1Y3Rvci5wcm90b3R5cGUsIHByb3RvUHJvcHMpOyBpZiAoc3RhdGljUHJvcHMpIGRlZmluZVByb3BlcnRpZXMoQ29uc3RydWN0b3IsIHN0YXRpY1Byb3BzKTsgcmV0dXJuIENvbnN0cnVjdG9yOyB9OyB9KSgpOwoKdmFyIF9nZXQgPSBmdW5jdGlvbiBnZXQoX3gsIF94MiwgX3gzKSB7IHZhciBfYWdhaW4gPSB0cnVlOyBfZnVuY3Rpb246IHdoaWxlIChfYWdhaW4pIHsgdmFyIG9iamVjdCA9IF94LCBwcm9wZXJ0eSA9IF94MiwgcmVjZWl2ZXIgPSBfeDM7IF9hZ2FpbiA9IGZhbHNlOyBpZiAob2JqZWN0ID09PSBudWxsKSBvYmplY3QgPSBGdW5jdGlvbi5wcm90b3R5cGU7IHZhciBkZXNjID0gT2JqZWN0LmdldE93blByb3BlcnR5RGVzY3JpcHRvcihvYmplY3QsIHByb3BlcnR5KTsgaWYgKGRlc2MgPT09IHVuZGVmaW5lZCkgeyB2YXIgcGFyZW50ID0gT2JqZWN0LmdldFByb3RvdHlwZU9mKG9iamVjdCk7IGlmIChwYXJlbnQgPT09IG51bGwpIHsgcmV0dXJuIHVuZGVmaW5lZDsgfSBlbHNlIHsgX3ggPSBwYXJlbnQ7IF94MiA9IHByb3BlcnR5OyBfeDMgPSByZWNlaXZlcjsgX2FnYWluID0gdHJ1ZTsgZGVzYyA9IHBhcmVudCA9IHVuZGVmaW5lZDsgY29udGludWUgX2Z1bmN0aW9uOyB9IH0gZWxzZSBpZiAoJ3ZhbHVlJyBpbiBkZXNjKSB7IHJldHVybiBkZXNjLnZhbHVlOyB9IGVsc2UgeyB2YXIgZ2V0dGVyID0gZGVzYy5nZXQ7IGlmIChnZXR0ZXIgPT09IHVuZGVmaW5lZCkgeyByZXR1cm4gdW5kZWZpbmVkOyB9IHJldHVybiBnZXR0ZXIuY2FsbChyZWNlaXZlcik7IH0gfSB9OwoKZnVuY3Rpb24gX2ludGVyb3BSZXF1aXJlRGVmYXVsdChvYmopIHsgcmV0dXJuIG9iaiAmJiBvYmouX19lc01vZHVsZSA/IG9iaiA6IHsgJ2RlZmF1bHQnOiBvYmogfTsgfQoKZnVuY3Rpb24gX2NsYXNzQ2FsbENoZWNrKGluc3RhbmNlLCBDb25zdHJ1Y3RvcikgeyBpZiAoIShpbnN0YW5jZSBpbnN0YW5jZW9mIENvbnN0cnVjdG9yKSkgeyB0aHJvdyBuZXcgVHlwZUVycm9yKCdDYW5ub3QgY2FsbCBhIGNsYXNzIGFzIGEgZnVuY3Rpb24nKTsgfSB9CgpmdW5jdGlvbiBfaW5oZXJpdHMoc3ViQ2xhc3MsIHN1cGVyQ2xhc3MpIHsgaWYgKHR5cGVvZiBzdXBlckNsYXNzICE9PSAnZnVuY3Rpb24nICYmIHN1cGVyQ2xhc3MgIT09IG51bGwpIHsgdGhyb3cgbmV3IFR5cGVFcnJvcignU3VwZXIgZXhwcmVzc2lvbiBtdXN0IGVpdGhlciBiZSBudWxsIG9yIGEgZnVuY3Rpb24sIG5vdCAnICsgdHlwZW9mIHN1cGVyQ2xhc3MpOyB9IHN1YkNsYXNzLnByb3RvdHlwZSA9IE9iamVjdC5jcmVhdGUoc3VwZXJDbGFzcyAmJiBzdXBlckNsYXNzLnByb3RvdHlwZSwgeyBjb25zdHJ1Y3RvcjogeyB2YWx1ZTogc3ViQ2xhc3MsIGVudW1lcmFibGU6IGZhbHNlLCB3cml0YWJsZTogdHJ1ZSwgY29uZmlndXJhYmxlOiB0cnVlIH0gfSk7IGlmIChzdXBlckNsYXNzKSBPYmplY3Quc2V0UHJvdG90eXBlT2YgPyBPYmplY3Quc2V0UHJvdG90eXBlT2Yoc3ViQ2xhc3MsIHN1cGVyQ2xhc3MpIDogc3ViQ2xhc3MuX19wcm90b19fID0gc3VwZXJDbGFzczsgfQoKdmFyIF9Db25uZWN0aW9uQ29udHJvbGxlciA9IHJlcXVpcmUoJy4vQ29ubmVjdGlvbkNvbnRyb2xsZXInKTsKCnZhciBfQ29ubmVjdGlvbkNvbnRyb2xsZXIyID0gX2ludGVyb3BSZXF1aXJlRGVmYXVsdChfQ29ubmVjdGlvbkNvbnRyb2xsZXIpOwoKdmFyIF91dGlsc0V2ZW50RW1pdHRlciA9IHJlcXVpcmUoJy4uL3V0aWxzL0V2ZW50RW1pdHRlcicpOwoKdmFyIF91dGlsc0V2ZW50RW1pdHRlcjIgPSBfaW50ZXJvcFJlcXVpcmVEZWZhdWx0KF91dGlsc0V2ZW50RW1pdHRlcik7CgovKioKICogSHlwZXJ0eSBDb25uZWN0b3I7CiAqIEBhdXRob3IgVml0b3IgU2lsdmEgW3ZpdG9yLXQtc2lsdmFAdGVsZWNvbS5wdF0KICogQHZlcnNpb24gMC4xLjAKICovCgp2YXIgSHlwZXJ0eUNvbm5lY3RvciA9IChmdW5jdGlvbiAoX0V2ZW50RW1pdHRlcikgewogIF9pbmhlcml0cyhIeXBlcnR5Q29ubmVjdG9yLCBfRXZlbnRFbWl0dGVyKTsKCiAgLyoqCiAgICogQ3JlYXRlIGEgbmV3IEh5cGVydHkgQ29ubmVjdG9yCiAgICogQHBhcmFtICB7U3luY2hlcn0gc3luY2hlciAtIFN5bmNoZXIgcHJvdmlkZWQgZnJvbSB0aGUgcnVudGltZSBjb3JlCiAgICovCgogIGZ1bmN0aW9uIEh5cGVydHlDb25uZWN0b3Ioc3luY2hlcikgewogICAgX2NsYXNzQ2FsbENoZWNrKHRoaXMsIEh5cGVydHlDb25uZWN0b3IpOwoKICAgIGlmICghc3luY2hlcikgdGhyb3cgbmV3IEVycm9yKCdUaGUgU3luY2hlciBpcyBhIG5lZWRlZCBwYXJhbWV0ZXInKTsKCiAgICBfZ2V0KE9iamVjdC5nZXRQcm90b3R5cGVPZihIeXBlcnR5Q29ubmVjdG9yLnByb3RvdHlwZSksICdjb25zdHJ1Y3RvcicsIHRoaXMpLmNhbGwodGhpcywgc3luY2hlcik7CgogICAgdmFyIF90aGlzID0gdGhpczsKCiAgICBfdGhpcy5jb250cm9sbGVycyA9IHt9OwoKICAgIC8vIHN0ZXAgMiAtIGh0dHBzOi8vZ2l0aHViLmNvbS9yZVRISU5LLXByb2plY3Qvc2NlbmFyaW8tc2VydmljZS1pbXBsZW1lbnRhdGlvbi90cmVlL21hc3Rlci9kb2NzL2h5cGVydGllcy9jb25uZWN0b3Ijbm90aWZpY2F0aW9uLWFib3V0LWluY29taW5nLWNvbm5lY3Rpb24tcmVxdWVzdAogICAgc3luY2hlci5vbk5vdGlmaWNhdGlvbihmdW5jdGlvbiAoZXZlbnQpIHsKICAgICAgY29uc29sZS5pbmZvKCdjb25uZWN0b3IgaGF2ZSBhbiBub3RpZmljYXRpb246ICcsIGV2ZW50KTsKICAgICAgX3RoaXMuX2F1dG9TdWJzY3JpYmUoZXZlbnQpOwogICAgfSk7CgogICAgX3RoaXMuX3N5bmNoZXIgPSBzeW5jaGVyOwogIH0KCiAgLyoqCiAgICogRXN0YWJsaXNoIGNvbm5lY3Rpb24gd2l0aCBvdGhlciBjbGllbnQgaWRlbnRpZmllcgogICAqIEBwYXJhbSAge0h5cGVydHlVUkx9IEh5cGVydHlVUkwgLSBEZWZpbmUgdGhlIGlkZW50aWZpZXIgb2YgdGhlIG90aGVyIGNvbXBvbmVudAogICAqIEBwYXJhbSAge09iamVjdH0gb3B0aW9ucyAtIE9iamVjdCB3aXRoIG9wdGlvbnMgdG8gaW1wcm92ZSB0aGUgY29ubmVjdAogICAqLwoKICBfY3JlYXRlQ2xhc3MoSHlwZXJ0eUNvbm5lY3RvciwgW3sKICAgIGtleTogJ2Nvbm5lY3QnLAogICAgdmFsdWU6IGZ1bmN0aW9uIGNvbm5lY3QoaHlwZXJ0eVVSTCwgb3B0aW9ucykgewogICAgICAvLyBUT0RPOiBDSGFuZ2UgdGhlIGh5cGVydHlVUkwgZm9yIGEgbGlzdCBvZiBVUkxTCiAgICAgIHZhciBfdGhpcyA9IHRoaXM7CgogICAgICBvcHRpb25zID0gb3B0aW9ucyB8fCB7IHZpZGVvOiB0cnVlLCBhdWRpbzogdHJ1ZSB9OwoKICAgICAgdmFyIGNvbm5lY3Rpb25Db250cm9sbGVyID0gbmV3IF9Db25uZWN0aW9uQ29udHJvbGxlcjJbJ2RlZmF1bHQnXSgpOwoKICAgICAgY29ubmVjdGlvbkNvbnRyb2xsZXIuYWRkRXZlbnRMaXN0ZW5lcignY29udHJvbGxlcjpzdGF0ZTpjaGFuZ2UnLCBmdW5jdGlvbiAoc3RhdGUpIHsKICAgICAgICBpZiAoc3RhdGUgPT09ICdhbnN3ZXInKSB7CiAgICAgICAgICBjb25zb2xlLmluZm8oJ2Nvbm5lY3Rpb24gY29udHJvbGxlciBzdGF0ZTogJywgc3RhdGUpOwogICAgICAgICAgX3RoaXMubW9kZSA9IHN0YXRlOwoKICAgICAgICAgIC8vIF90aGlzLl9hdXRvQ29ubmVjdChfdGhpcy5ub3RpZmljYXRpb25FdmVudC5mcm9tKTsKICAgICAgICB9CiAgICAgIH0pOwoKICAgICAgX3RoaXMuY29udHJvbGxlcnNbaHlwZXJ0eVVSTF0gPSBjb25uZWN0aW9uQ29udHJvbGxlcjsKCiAgICAgIHJldHVybiBuZXcgUHJvbWlzZShmdW5jdGlvbiAocmVzb2x2ZSwgcmVqZWN0KSB7CgogICAgICAgIC8vIFN0ZXAgMyBhbmQgNCAtIGh0dHBzOi8vZ2l0aHViLmNvbS9yZVRISU5LLXByb2plY3Qvc2NlbmFyaW8tc2VydmljZS1pbXBsZW1lbnRhdGlvbi90cmVlL21hc3Rlci9kb2NzL2h5cGVydGllcy9jb25uZWN0b3IjY3JlYXRlLW5ldy1jb25uZWN0aW9uCiAgICAgICAgY29ubmVjdGlvbkNvbnRyb2xsZXIuZ2V0VXNlck1lZGlhKG9wdGlvbnMpLnRoZW4oZnVuY3Rpb24gKGNvbW1SZXNvdXJjZXMpIHsKICAgICAgICAgIGNvbnNvbGUuaW5mbygnR2V0IHdlYlJUQyBjb21tb24gcmVzb3VyY2VzJywgY29tbVJlc291cmNlcywgaHlwZXJ0eVVSTCk7CgogICAgICAgICAgLy8gVE9ETzogT3B0aW1pemUgdGhlIHJlc291cmNlcyB0byBnZXQ7CiAgICAgICAgICAvLyBhbmQgYWRkIGFsbCBvcHRpb25zIGF2YWlsYWJsZTsKICAgICAgICAgIHZhciBpbml0aWFsID0ge307CiAgICAgICAgICBpbml0aWFsLm93bmVyID0gdHJ1ZTsKICAgICAgICAgIGluaXRpYWwudG8gPSBoeXBlcnR5VVJMOwogICAgICAgICAgaW5pdGlhbC5yZXNvdXJjZXMgPSB7CiAgICAgICAgICAgIHZpZGVvOiBvcHRpb25zLnZpZGVvLAogICAgICAgICAgICBhdWRpbzogb3B0aW9ucy5hdWRpbwogICAgICAgICAgfTsKCiAgICAgICAgICAvLyBTdGVwIDUgLSBodHRwczovL2dpdGh1Yi5jb20vcmVUSElOSy1wcm9qZWN0L3NjZW5hcmlvLXNlcnZpY2UtaW1wbGVtZW50YXRpb24vdHJlZS9tYXN0ZXIvZG9jcy9oeXBlcnRpZXMvY29ubmVjdG9yI2NyZWF0ZS1uZXctY29ubmVjdGlvbgogICAgICAgICAgcmV0dXJuIF90aGlzLl9zeW5jaGVyLmNyZWF0ZSh7fSwgW2h5cGVydHlVUkxdLCBpbml0aWFsKTsKICAgICAgICB9KS50aGVuKGZ1bmN0aW9uIChjb25uZWN0aW9uRGF0YU9iamVjdCkgewogICAgICAgICAgY29uc29sZS5pbmZvKCdSZXR1cm4gQ3JlYXRlIENvbm5lY3Rpb24gRGF0YSBPYmplY3QnLCBjb25uZWN0aW9uRGF0YU9iamVjdCk7CgogICAgICAgICAgLy8gU3RlcCAxMSAtIGh0dHBzOi8vZ2l0aHViLmNvbS9yZVRISU5LLXByb2plY3Qvc2NlbmFyaW8tc2VydmljZS1pbXBsZW1lbnRhdGlvbi90cmVlL21hc3Rlci9kb2NzL2h5cGVydGllcy9jb25uZWN0b3IjY3JlYXRlLW5ldy1jb25uZWN0aW9uCiAgICAgICAgICBjb25uZWN0aW9uQ29udHJvbGxlci5jb25uZWN0aW9uRGF0YU9iamVjdFJlcG9ydGVyID0gY29ubmVjdGlvbkRhdGFPYmplY3Q7CgogICAgICAgICAgLy8gU3RlcCAxMiAtIGh0dHBzOi8vZ2l0aHViLmNvbS9yZVRISU5LLXByb2plY3Qvc2NlbmFyaW8tc2VydmljZS1pbXBsZW1lbnRhdGlvbi90cmVlL21hc3Rlci9kb2NzL2h5cGVydGllcy9jb25uZWN0b3IjY3JlYXRlLW5ldy1jb25uZWN0aW9uCiAgICAgICAgICByZXNvbHZlKGNvbm5lY3Rpb25Db250cm9sbGVyKTsKICAgICAgICB9KVsnY2F0Y2gnXShmdW5jdGlvbiAocmVhc29uKSB7CiAgICAgICAgICBjb25zb2xlLmVycm9yKHJlYXNvbik7CiAgICAgICAgICByZWplY3QocmVhc29uKTsKICAgICAgICB9KTsKICAgICAgfSk7CiAgICB9CgogICAgLyoqCiAgICAgKiBBY2NlcHQgdGhlIGluY29taW5nIGNhbGwKICAgICAqIEBtZXRob2QgYWNjZXB0CiAgICAgKiBAcmV0dXJuIHtQcm9taXNlfQogICAgICovCiAgfSwgewogICAga2V5OiAnYWNjZXB0JywKICAgIHZhbHVlOiBmdW5jdGlvbiBhY2NlcHQoKSB7CiAgICAgIHZhciBfdGhpcyA9IHRoaXM7CgogICAgICByZXR1cm4gbmV3IFByb21pc2UoZnVuY3Rpb24gKHJlc29sdmUsIHJlamVjdCkgewoKICAgICAgICB2YXIgb2JqZWN0VVJMID0gX3RoaXMubm90aWZpY2F0aW9uRXZlbnQudXJsOwoKICAgICAgICAvLyBzdGVwIDYgLSBodHRwczovL2dpdGh1Yi5jb20vcmVUSElOSy1wcm9qZWN0L3NjZW5hcmlvLXNlcnZpY2UtaW1wbGVtZW50YXRpb24vdHJlZS9tYXN0ZXIvZG9jcy9oeXBlcnRpZXMvY29ubmVjdG9yI25vdGlmaWNhdGlvbi1hYm91dC1pbmNvbWluZy1jb25uZWN0aW9uLXJlcXVlc3QKICAgICAgICAvLyBhZnRlciB3YWl0aW5nIGZvciBhbiBhbnN3ZXIsIHdlIGNhbiBub3cgc3Vic2NyaWJlIHRoZSBvYmplY3RVUkwKICAgICAgICBfdGhpcy5fc3luY2hlci5zdWJzY3JpYmUob2JqZWN0VVJMKS50aGVuKGZ1bmN0aW9uIChjb25uZWN0aW9uRGF0YU9iamVjdCkgewogICAgICAgICAgY29uc29sZS5pbmZvKCdSZXR1cm4gU3Vic2NyaWJlIENvbm5lY3Rpb24gRGF0YSBPYmplY3QnLCBjb25uZWN0aW9uRGF0YU9iamVjdCk7CgogICAgICAgICAgLy8gc3RlcCA3IGFuZCAxMCAtIGh0dHBzOi8vZ2l0aHViLmNvbS9yZVRISU5LLXByb2plY3Qvc2NlbmFyaW8tc2VydmljZS1pbXBsZW1lbnRhdGlvbi90cmVlL21hc3Rlci9kb2NzL2h5cGVydGllcy9jb25uZWN0b3Ijbm90aWZpY2F0aW9uLWFib3V0LWluY29taW5nLWNvbm5lY3Rpb24tcmVxdWVzdAogICAgICAgICAgX3RoaXMuY29ubmVjdGlvbkNvbnRyb2xsZXIuY29ubmVjdGlvbkRhdGFPYmplY3RPYnNlcnZlciA9IGNvbm5lY3Rpb25EYXRhT2JqZWN0OwogICAgICAgICAgcmVzb2x2ZShfdGhpcy5jb25uZWN0aW9uQ29udHJvbGxlcik7CgogICAgICAgICAgdmFyIHJlc291cmNlcyA9IGNvbm5lY3Rpb25EYXRhT2JqZWN0LmRhdGEucmVzb3VyY2VzOwogICAgICAgICAgcmV0dXJuIF90aGlzLmNvbm5lY3Rpb25Db250cm9sbGVyLmdldFVzZXJNZWRpYShyZXNvdXJjZXMpOwogICAgICAgIH0pLnRoZW4oZnVuY3Rpb24gKGNvbW1SZXNvdXJjZXMpIHsKICAgICAgICAgIGNvbnNvbGUuaW5mbygnR2V0IHdlYlJUQyBjb21tb24gcmVzb3VyY2VzJywgY29tbVJlc291cmNlcyk7CiAgICAgICAgfSlbJ2NhdGNoJ10oZnVuY3Rpb24gKHJlYXNvbikgewogICAgICAgICAgY29uc29sZS5lcnJvcihyZWFzb24pOwogICAgICAgICAgcmVqZWN0KHJlYXNvbik7CiAgICAgICAgfSk7CiAgICAgIH0pOwogICAgfQoKICAgIC8qKgogICAgICogQ29ubmVjdGlvbiBpcyBjbG9zZWQgYnkgbG9jYWwgcGVlciBhbmQgZGlzY29ubmVjdGVkOwogICAgICogQG1ldGhvZCBkaXNjb25uZWN0CiAgICAgKiBAcmV0dXJuIHtQcm9taXNlfQogICAgICovCiAgfSwgewogICAga2V5OiAnZGlzY29ubmVjdCcsCiAgICB2YWx1ZTogZnVuY3Rpb24gZGlzY29ubmVjdCgpIHsKCiAgICAgIHZhciBfdGhpcyA9IHRoaXM7CgogICAgICByZXR1cm4gbmV3IFByb21pc2UoZnVuY3Rpb24gKHJlc29sdmUsIHJlamVjdCkgewoKICAgICAgICBfdGhpcy5jb25uZWN0aW9uQ29udHJvbGxlci5kaXNjb25uZWN0KCkudGhlbihmdW5jdGlvbiAoZGlzY29ubmVjdGVkKSB7CgogICAgICAgICAgY29uc29sZS5pbmZvKCdkaXNjb25uZWN0ZWQ6ICcsIGRpc2Nvbm5lY3RlZCk7CgogICAgICAgICAgcmVzb2x2ZShkaXNjb25uZWN0ZWQpOwogICAgICAgIH0pWydjYXRjaCddKGZ1bmN0aW9uIChyZWFzb24pIHsKICAgICAgICAgIHJlamVjdChyZWFzb24pOwogICAgICAgIH0pOwogICAgICB9KTsKICAgIH0KICB9LCB7CiAgICBrZXk6ICdfYXV0b0Nvbm5lY3QnLAogICAgdmFsdWU6IGZ1bmN0aW9uIF9hdXRvQ29ubmVjdChoeXBlcnR5VVJMKSB7CiAgICAgIHZhciBfdGhpcyA9IHRoaXM7CgogICAgICBfdGhpcy5fc3luY2hlci5jcmVhdGUoe30sIFtoeXBlcnR5VVJMXSwge30pLnRoZW4oZnVuY3Rpb24gKGNvbm5lY3Rpb25EYXRhT2JqZWN0KSB7CiAgICAgICAgY29uc29sZS5pbmZvKCdSZXR1cm4gQ3JlYXRlIENvbm5lY3Rpb24gRGF0YSBPYmplY3QnLCBjb25uZWN0aW9uRGF0YU9iamVjdCk7CiAgICAgICAgX3RoaXMuY29ubmVjdGlvbkNvbnRyb2xsZXIuY29ubmVjdGlvbkRhdGFPYmplY3RSZXBvcnRlciA9IGNvbm5lY3Rpb25EYXRhT2JqZWN0OwogICAgICB9KVsnY2F0Y2gnXShmdW5jdGlvbiAocmVhc29uKSB7CiAgICAgICAgY29uc29sZS5lcnJvcihyZWFzb24pOwogICAgICB9KTsKICAgIH0KICB9LCB7CiAgICBrZXk6ICdfYXV0b1N1YnNjcmliZScsCiAgICB2YWx1ZTogZnVuY3Rpb24gX2F1dG9TdWJzY3JpYmUoZXZlbnQpIHsKICAgICAgdmFyIF90aGlzID0gdGhpczsKICAgICAgdmFyIHVybCA9IGV2ZW50LnVybDsKCiAgICAgIGV2ZW50LmFjaygpOwoKICAgICAgX3RoaXMuX3N5bmNoZXIuc3Vic2NyaWJlKHVybCkudGhlbihmdW5jdGlvbiAoY29ubmVjdGlvbkRhdGFPYmplY3QpIHsKICAgICAgICBjb25zb2xlLmluZm8oJ1JldHVybiBTdWJzY3JpYmUgQ29ubmVjdGlvbiBEYXRhIE9iamVjdCcsIGNvbm5lY3Rpb25EYXRhT2JqZWN0KTsKCiAgICAgICAgdmFyIGNvbm5lY3Rpb25Db250cm9sbGVyID0gbmV3IF9Db25uZWN0aW9uQ29udHJvbGxlcjJbJ2RlZmF1bHQnXSgpOwogICAgICAgIGNvbm5lY3Rpb25Db250cm9sbGVyLmNvbm5lY3Rpb25EYXRhT2JqZWN0T2JzZXJ2ZXIgPSBjb25uZWN0aW9uRGF0YU9iamVjdDsKICAgICAgICBfdGhpcy50cmlnZ2VyKCdvbjpzdWJzY3JpYmUnLCBjb25uZWN0aW9uQ29udHJvbGxlcik7CiAgICAgIH0pWydjYXRjaCddKGZ1bmN0aW9uICgpIHt9KTsKICAgIH0KICB9XSk7CgogIHJldHVybiBIeXBlcnR5Q29ubmVjdG9yOwp9KShfdXRpbHNFdmVudEVtaXR0ZXIyWydkZWZhdWx0J10pOwoKZXhwb3J0c1snZGVmYXVsdCddID0gSHlwZXJ0eUNvbm5lY3RvcjsKbW9kdWxlLmV4cG9ydHMgPSBleHBvcnRzWydkZWZhdWx0J107Cgp9LHsiLi4vdXRpbHMvRXZlbnRFbWl0dGVyIjoyMywiLi9Db25uZWN0aW9uQ29udHJvbGxlciI6MTJ9XSwxNDpbZnVuY3Rpb24ocmVxdWlyZSxtb2R1bGUsZXhwb3J0cyl7Ci8qKgoqIENsYXNzIGltcGxlbWVudGF0aW9uIG9mIE1lc3NhZ2UgRGF0YSBNb2RlbAoqLwoKJ3VzZSBzdHJpY3QnOwoKT2JqZWN0LmRlZmluZVByb3BlcnR5KGV4cG9ydHMsICdfX2VzTW9kdWxlJywgewogICAgdmFsdWU6IHRydWUKfSk7CgpmdW5jdGlvbiBfY2xhc3NDYWxsQ2hlY2soaW5zdGFuY2UsIENvbnN0cnVjdG9yKSB7IGlmICghKGluc3RhbmNlIGluc3RhbmNlb2YgQ29uc3RydWN0b3IpKSB7IHRocm93IG5ldyBUeXBlRXJyb3IoJ0Nhbm5vdCBjYWxsIGEgY2xhc3MgYXMgYSBmdW5jdGlvbicpOyB9IH0KCnZhciBNZXNzYWdlID0gZnVuY3Rpb24gTWVzc2FnZShpZCwgZnJvbSwgdG9MaXN0LCB0eXBlLCBjb250ZXh0SWQsIGJvZHksIHNpZ25hdHVyZSkgewogICAgX2NsYXNzQ2FsbENoZWNrKHRoaXMsIE1lc3NhZ2UpOwoKICAgIHRoaXMuaWQgPSBpZDsKICAgIHRoaXMuZnJvbSA9IGZyb207CiAgICB0aGlzLnRvID0gdG9MaXN0OwogICAgdGhpcy50eXBlID0gdHlwZTsKICAgIHRoaXMuY29udGV4dElkID0gY29udGV4dElkOwogICAgdGhpcy5zaWduYXR1cmUgPSBzaWduYXR1cmU7CiAgICB0aGlzLmJvZHkgPSBib2R5Owp9CgovKgpnZXQgaWQoKXsgcmV0dXJuIHRoaXMuaWQ7IH0KIGdldCBmcm9tKCl7IHJldHVybiB0aGlzLmZyb207IH0KIGdldCB0eXBlKCkgeyByZXR1cm4gdGhpcy50eXBlOyB9CiBnZXQgY29udGV4dElkKCkgeyByZXR1cm4gdGhpcy5jb250ZXh0SWQ7IH0KIGdldCBib2R5KCl7IHJldHVybiB0aGlzLmJvZHk7IH0KIHNldCBpZChpZGVudGlmaWVyKXsKICAgIGlmKGlkZW50aWZpZXIpCiAgICAgICAgdGhpcy5pZCA9IGlkZW50aWZpZXI7Cn0KIHNldCBmcm9tKHNlbmRlcil7CiAgICBpZihzZW5kZXIpCiAgICAgICAgdGhpcy5mcm9tID0gc2VuZGVyOwp9CiBzZXQgdHlwZShtc2dUeXBlKXsKICAgIGlmKG1zZ1R5cGUpCiAgICAgICAgdGhpcy50eXBlID0gbXNnVHlwZTsKfQogc2V0IGNvbnRleHRJZChjSUQpewogICAgaWYoY0lEKQogICAgICAgIHRoaXMuY29udGV4dElkID0gY0lEOwp9CnNldCBib2R5KG1zZ0JvZHkpewogICAgaWYobXNnQm9keSkKICAgICAgICB0aGlzLmJvZHkgPSBtc2dCb2R5Owp9CnNldCB0byhyZWNpcGllbnRMaXN0KXsKICAgIGlmKHJlY2lwaWVudExpc3QpCiAgICAgICAgdGhpcy50byA9IHJlY2lwaWVudExpc3Q7Cn0KIHNldCBzaWduYXR1cmUoc2lnbmF0dXJlKSB7CiAgICBpZiAoc2lnbmF0dXJlKQogICAgICAgIHRoaXMuc2lnbmF0dXJlID0gc2lnbmF0dXJlOwp9Ki8KCjsKCmV4cG9ydHMuTWVzc2FnZSA9IE1lc3NhZ2U7CnZhciBNZXNzYWdlVHlwZSA9IHsgQ1JFQVRFOiAnY3JlYXRlJywgUkVBRDogJ3JlYWQnLCBVUERBVEU6ICd1cGRhdGUnLCBERUxFVEU6ICdkZWxldGUnLCBTVUJTQ1JJQkU6ICdzdWJzY3JpYmUnLAogICAgVU5TVUJTQ1JJQkU6ICd1bnN1YnNjcmliZScsIFJFU1BPTlNFOiAncmVzcG9uc2UnLCBGT1JXQVJEOiAnZm9yd2FyZCcgfTsKCmV4cG9ydHMuTWVzc2FnZVR5cGUgPSBNZXNzYWdlVHlwZTsKZXhwb3J0c1snZGVmYXVsdCddID0gTWVzc2FnZTsKCn0se31dLDE1OltmdW5jdGlvbihyZXF1aXJlLG1vZHVsZSxleHBvcnRzKXsKJ3VzZSBzdHJpY3QnOwoKT2JqZWN0LmRlZmluZVByb3BlcnR5KGV4cG9ydHMsICdfX2VzTW9kdWxlJywgewogICAgdmFsdWU6IHRydWUKfSk7Cgp2YXIgX2dldCA9IGZ1bmN0aW9uIGdldChfeCwgX3gyLCBfeDMpIHsgdmFyIF9hZ2FpbiA9IHRydWU7IF9mdW5jdGlvbjogd2hpbGUgKF9hZ2FpbikgeyB2YXIgb2JqZWN0ID0gX3gsIHByb3BlcnR5ID0gX3gyLCByZWNlaXZlciA9IF94MzsgX2FnYWluID0gZmFsc2U7IGlmIChvYmplY3QgPT09IG51bGwpIG9iamVjdCA9IEZ1bmN0aW9uLnByb3RvdHlwZTsgdmFyIGRlc2MgPSBPYmplY3QuZ2V0T3duUHJvcGVydHlEZXNjcmlwdG9yKG9iamVjdCwgcHJvcGVydHkpOyBpZiAoZGVzYyA9PT0gdW5kZWZpbmVkKSB7IHZhciBwYXJlbnQgPSBPYmplY3QuZ2V0UHJvdG90eXBlT2Yob2JqZWN0KTsgaWYgKHBhcmVudCA9PT0gbnVsbCkgeyByZXR1cm4gdW5kZWZpbmVkOyB9IGVsc2UgeyBfeCA9IHBhcmVudDsgX3gyID0gcHJvcGVydHk7IF94MyA9IHJlY2VpdmVyOyBfYWdhaW4gPSB0cnVlOyBkZXNjID0gcGFyZW50ID0gdW5kZWZpbmVkOyBjb250aW51ZSBfZnVuY3Rpb247IH0gfSBlbHNlIGlmICgndmFsdWUnIGluIGRlc2MpIHsgcmV0dXJuIGRlc2MudmFsdWU7IH0gZWxzZSB7IHZhciBnZXR0ZXIgPSBkZXNjLmdldDsgaWYgKGdldHRlciA9PT0gdW5kZWZpbmVkKSB7IHJldHVybiB1bmRlZmluZWQ7IH0gcmV0dXJuIGdldHRlci5jYWxsKHJlY2VpdmVyKTsgfSB9IH07CgpmdW5jdGlvbiBfaW5oZXJpdHMoc3ViQ2xhc3MsIHN1cGVyQ2xhc3MpIHsgaWYgKHR5cGVvZiBzdXBlckNsYXNzICE9PSAnZnVuY3Rpb24nICYmIHN1cGVyQ2xhc3MgIT09IG51bGwpIHsgdGhyb3cgbmV3IFR5cGVFcnJvcignU3VwZXIgZXhwcmVzc2lvbiBtdXN0IGVpdGhlciBiZSBudWxsIG9yIGEgZnVuY3Rpb24sIG5vdCAnICsgdHlwZW9mIHN1cGVyQ2xhc3MpOyB9IHN1YkNsYXNzLnByb3RvdHlwZSA9IE9iamVjdC5jcmVhdGUoc3VwZXJDbGFzcyAmJiBzdXBlckNsYXNzLnByb3RvdHlwZSwgeyBjb25zdHJ1Y3RvcjogeyB2YWx1ZTogc3ViQ2xhc3MsIGVudW1lcmFibGU6IGZhbHNlLCB3cml0YWJsZTogdHJ1ZSwgY29uZmlndXJhYmxlOiB0cnVlIH0gfSk7IGlmIChzdXBlckNsYXNzKSBPYmplY3Quc2V0UHJvdG90eXBlT2YgPyBPYmplY3Quc2V0UHJvdG90eXBlT2Yoc3ViQ2xhc3MsIHN1cGVyQ2xhc3MpIDogc3ViQ2xhc3MuX19wcm90b19fID0gc3VwZXJDbGFzczsgfQoKZnVuY3Rpb24gX2NsYXNzQ2FsbENoZWNrKGluc3RhbmNlLCBDb25zdHJ1Y3RvcikgeyBpZiAoIShpbnN0YW5jZSBpbnN0YW5jZW9mIENvbnN0cnVjdG9yKSkgeyB0aHJvdyBuZXcgVHlwZUVycm9yKCdDYW5ub3QgY2FsbCBhIGNsYXNzIGFzIGEgZnVuY3Rpb24nKTsgfSB9Cgp2YXIgTWVzc2FnZUJvZHkgPQoKLyoqCiAqCiAqIEBwYXJhbSB7SWRlbnRpdHkuSldUfSBpZFRva2VuIC0gdG9rZW4gZm9yIElkZW50aXR5IGFzc2VydGlvbiBwdXJwb3NlCiAqIEBwYXJhbSB7SWRlbnRpdHkuSldUfSBhY2Nlc3NUb2tlbgogKiBAcGFyYW0ge1VSTC5VUkx9IHJlc291cmNlCiAqIEBwYXJhbSB7VVJMLkh5cGVydHlDYXRhbG9ndWVVUkx9IHNjaGVtYQogKiBAcGFyYW0ge0lkZW50aXR5LkpXVH0gYXNzZXJ0ZWRJZGVudGl0eQogKgogKi8KZnVuY3Rpb24gTWVzc2FnZUJvZHkoaWRUb2tlbiwgYWNjZXNzVG9rZW4sIHJlc291cmNlLCBzY2hlbWEsIGFzc2VydGVkSWRlbnRpdHkpIHsKICAgIF9jbGFzc0NhbGxDaGVjayh0aGlzLCBNZXNzYWdlQm9keSk7CgogICAgLy9sZXQgX3RoaXMgPSB0aGlzOwogICAgaWYgKHR5cGVvZiBpZG9rZW4gIT09ICd1bmRlZmluZWQnKSB0aGlzLmlkVG9rZW4gPSBpZFRva2VuOwogICAgaWYgKHR5cGVvZiBhY2Nlc3NUb2tlbiAhPT0gJ3VuZGVmaW5lZCcpIHRoaXMuYWNjZXNzVG9rZW4gPSBhY2Nlc3NUb2tlbjsKICAgIGlmICh0eXBlb2YgcmVzb3VyY2UgIT09ICd1bmRlZmluZWQnKSB0aGlzLnJlc291cmNlID0gcmVzb3VyY2U7CiAgICBpZiAodHlwZW9mIHNjaGVtYSAhPT0gJ3VuZGVmaW5lZCcpIHRoaXMuc2NoZW1hID0gc2NoZW1hOwogICAgaWYgKHR5cGVvZiBhc3NlcnRlZElkZW50aXR5ICE9PSAndW5kZWZpbmVkJykgdGhpcy5hc3NlcnRlZElkZW50aXR5ID0gYXNzZXJ0ZWRJZGVudGl0eTsKfTsKCnZhciBDcmVhdGVNZXNzYWdlQm9keSA9IChmdW5jdGlvbiAoX01lc3NhZ2VCb2R5KSB7CiAgICBfaW5oZXJpdHMoQ3JlYXRlTWVzc2FnZUJvZHksIF9NZXNzYWdlQm9keSk7CgogICAgZnVuY3Rpb24gQ3JlYXRlTWVzc2FnZUJvZHkodmFsdWUsIHBvbGljeSwgaWRUb2tlbiwgYWNjZXNzVG9rZW4sIHJlc291cmNlLCBzY2hlbWEsIGFzc2VydGVkSWRlbnRpdHkpIHsKICAgICAgICBfY2xhc3NDYWxsQ2hlY2sodGhpcywgQ3JlYXRlTWVzc2FnZUJvZHkpOwoKICAgICAgICBpZiAodHlwZW9mIHZhbHVlID09PSAndW5kZWZpbmVkJykgdGhyb3cgbmV3IEVycm9yKCJUaGUgdmFsdWUgcGFyYW1ldGVyIGlzIG51bGwiKTsKICAgICAgICBfZ2V0KE9iamVjdC5nZXRQcm90b3R5cGVPZihDcmVhdGVNZXNzYWdlQm9keS5wcm90b3R5cGUpLCAnY29uc3RydWN0b3InLCB0aGlzKS5jYWxsKHRoaXMsIGlkVG9rZW4sIGFjY2Vzc1Rva2VuLCByZXNvdXJjZSwgc2NoZW1hLCBhc3NlcnRlZElkZW50aXR5LCBzY2hlbWEsIGFzc2VydGVkSWRlbnRpdHkpOwoKICAgICAgICB0aGlzLnZhbHVlID0gdmFsdWU7CiAgICAgICAgaWYgKHBvbGljeSkgdGhpcy5wb2xpY3kgPSBwb2xpY3k7CiAgICB9CgogICAgcmV0dXJuIENyZWF0ZU1lc3NhZ2VCb2R5Owp9KShNZXNzYWdlQm9keSk7CgpleHBvcnRzLkNyZWF0ZU1lc3NhZ2VCb2R5ID0gQ3JlYXRlTWVzc2FnZUJvZHk7Cgp2YXIgUmVhZE1lc3NhZ2VCb2R5ID0gKGZ1bmN0aW9uIChfTWVzc2FnZUJvZHkyKSB7CiAgICBfaW5oZXJpdHMoUmVhZE1lc3NhZ2VCb2R5LCBfTWVzc2FnZUJvZHkyKTsKCiAgICBmdW5jdGlvbiBSZWFkTWVzc2FnZUJvZHkoaWRUb2tlbiwgYWNjZXNzVG9rZW4sIHJlc291cmNlLCBzY2hlbWEsIGFzc2VydGVkSWRlbnRpdHksIGF0dHJpYnV0ZSwgY3JpdGVyaWFTeW50YXgsIGNyaXRlcmlhKSB7CiAgICAgICAgX2NsYXNzQ2FsbENoZWNrKHRoaXMsIFJlYWRNZXNzYWdlQm9keSk7CgogICAgICAgIF9nZXQoT2JqZWN0LmdldFByb3RvdHlwZU9mKFJlYWRNZXNzYWdlQm9keS5wcm90b3R5cGUpLCAnY29uc3RydWN0b3InLCB0aGlzKS5jYWxsKHRoaXMsIGlkVG9rZW4sIGFjY2Vzc1Rva2VuLCByZXNvdXJjZSwgc2NoZW1hLCBhc3NlcnRlZElkZW50aXR5KTsKCiAgICAgICAgaWYgKGF0dHJpYnV0ZSkgdGhpcy5hdHRyaWJ1dGUgPSBhdHRyaWJ1dGU7CgogICAgICAgIGlmIChjcml0ZXJpYVN5bnRheCkgdGhpcy5jcml0ZXJpYVN5bnRheCA9IGNyaXRlcmlhU3ludGF4OwoKICAgICAgICBpZiAoY3JpdGVyaWEpIHRoaXMuY3JpdGVyaWEgPSBjcml0ZXJpYTsKICAgIH0KCiAgICByZXR1cm4gUmVhZE1lc3NhZ2VCb2R5Owp9KShNZXNzYWdlQm9keSk7CgpleHBvcnRzLlJlYWRNZXNzYWdlQm9keSA9IFJlYWRNZXNzYWdlQm9keTsKCnZhciBEZWxldGVNZXNzYWdlQm9keSA9IChmdW5jdGlvbiAoX01lc3NhZ2VCb2R5MykgewogICAgX2luaGVyaXRzKERlbGV0ZU1lc3NhZ2VCb2R5LCBfTWVzc2FnZUJvZHkzKTsKCiAgICBmdW5jdGlvbiBEZWxldGVNZXNzYWdlQm9keShpZFRva2VuLCBhY2Nlc3NUb2tlbiwgcmVzb3VyY2UsIHNjaGVtYSwgYXNzZXJ0ZWRJZGVudGl0eSwgYXR0cmlidXRlKSB7CiAgICAgICAgX2NsYXNzQ2FsbENoZWNrKHRoaXMsIERlbGV0ZU1lc3NhZ2VCb2R5KTsKCiAgICAgICAgX2dldChPYmplY3QuZ2V0UHJvdG90eXBlT2YoRGVsZXRlTWVzc2FnZUJvZHkucHJvdG90eXBlKSwgJ2NvbnN0cnVjdG9yJywgdGhpcykuY2FsbCh0aGlzLCBpZFRva2VuLCBhY2Nlc3NUb2tlbiwgcmVzb3VyY2UsIHNjaGVtYSwgYXNzZXJ0ZWRJZGVudGl0eSk7CgogICAgICAgIGlmIChhdHRyaWJ1dGUpIHsKICAgICAgICAgICAgdGhpcy5hdHRyaWJ1dGUgPSBhdHRyaWJ1dGU7CiAgICAgICAgfQogICAgfQoKICAgIHJldHVybiBEZWxldGVNZXNzYWdlQm9keTsKfSkoTWVzc2FnZUJvZHkpOwoKZXhwb3J0cy5EZWxldGVNZXNzYWdlQm9keSA9IERlbGV0ZU1lc3NhZ2VCb2R5OwoKdmFyIFVwZGF0ZU1lc3NhZ2VCb2R5ID0gKGZ1bmN0aW9uIChfTWVzc2FnZUJvZHk0KSB7CiAgICBfaW5oZXJpdHMoVXBkYXRlTWVzc2FnZUJvZHksIF9NZXNzYWdlQm9keTQpOwoKICAgIGZ1bmN0aW9uIFVwZGF0ZU1lc3NhZ2VCb2R5KGlkVG9rZW4sIGFjY2Vzc1Rva2VuLCByZXNvdXJjZSwgc2NoZW1hLCBhc3NlcnRlZElkZW50aXR5LCBhdHRyaWJ1dGUsIHZhbHVlKSB7CiAgICAgICAgX2NsYXNzQ2FsbENoZWNrKHRoaXMsIFVwZGF0ZU1lc3NhZ2VCb2R5KTsKCiAgICAgICAgX2dldChPYmplY3QuZ2V0UHJvdG90eXBlT2YoVXBkYXRlTWVzc2FnZUJvZHkucHJvdG90eXBlKSwgJ2NvbnN0cnVjdG9yJywgdGhpcykuY2FsbCh0aGlzLCBpZFRva2VuLCBhY2Nlc3NUb2tlbiwgcmVzb3VyY2UsIHNjaGVtYSwgYXNzZXJ0ZWRJZGVudGl0eSk7CgogICAgICAgIHRoaXMuYXR0cmlidXRlID0gYXR0cmlidXRlOwogICAgICAgIHRoaXMudmFsdWUgPSB2YWx1ZTsKICAgIH0KCiAgICByZXR1cm4gVXBkYXRlTWVzc2FnZUJvZHk7Cn0pKE1lc3NhZ2VCb2R5KTsKCmV4cG9ydHMuVXBkYXRlTWVzc2FnZUJvZHkgPSBVcGRhdGVNZXNzYWdlQm9keTsKCnZhciBGb3J3YXJkTWVzc2FnZUJvZHkgPSAoZnVuY3Rpb24gKF9NZXNzYWdlQm9keTUpIHsKICAgIF9pbmhlcml0cyhGb3J3YXJkTWVzc2FnZUJvZHksIF9NZXNzYWdlQm9keTUpOwoKICAgIGZ1bmN0aW9uIEZvcndhcmRNZXNzYWdlQm9keShpZFRva2VuLCBhY2Nlc3NUb2tlbiwgcmVzb3VyY2UsIHNjaGVtYSwgYXNzZXJ0ZWRJZGVudGl0eSwgbWVzc2FnZSkgewogICAgICAgIF9jbGFzc0NhbGxDaGVjayh0aGlzLCBGb3J3YXJkTWVzc2FnZUJvZHkpOwoKICAgICAgICBfZ2V0KE9iamVjdC5nZXRQcm90b3R5cGVPZihGb3J3YXJkTWVzc2FnZUJvZHkucHJvdG90eXBlKSwgJ2NvbnN0cnVjdG9yJywgdGhpcykuY2FsbCh0aGlzLCBpZFRva2VuLCBhY2Nlc3NUb2tlbiwgcmVzb3VyY2UsIHNjaGVtYSwgYXNzZXJ0ZWRJZGVudGl0eSk7CgogICAgICAgIHRoaXMubWVzc2FnZSA9IG1lc3NhZ2U7CiAgICB9CgogICAgcmV0dXJuIEZvcndhcmRNZXNzYWdlQm9keTsKfSkoTWVzc2FnZUJvZHkpOwoKZXhwb3J0cy5Gb3J3YXJkTWVzc2FnZUJvZHkgPSBGb3J3YXJkTWVzc2FnZUJvZHk7Cgp2YXIgUmVzcG9uc2VNZXNzYWdlQm9keSA9IChmdW5jdGlvbiAoX01lc3NhZ2VCb2R5NikgewogICAgX2luaGVyaXRzKFJlc3BvbnNlTWVzc2FnZUJvZHksIF9NZXNzYWdlQm9keTYpOwoKICAgIGZ1bmN0aW9uIFJlc3BvbnNlTWVzc2FnZUJvZHkoaWRUb2tlbiwgYWNjZXNzVG9rZW4sIHJlc291cmNlLCBjb2RlLCB2YWx1ZSkgewogICAgICAgIF9jbGFzc0NhbGxDaGVjayh0aGlzLCBSZXNwb25zZU1lc3NhZ2VCb2R5KTsKCiAgICAgICAgX2dldChPYmplY3QuZ2V0UHJvdG90eXBlT2YoUmVzcG9uc2VNZXNzYWdlQm9keS5wcm90b3R5cGUpLCAnY29uc3RydWN0b3InLCB0aGlzKS5jYWxsKHRoaXMsIGlkVG9rZW4sIGFjY2Vzc1Rva2VuLCByZXNvdXJjZSk7CgogICAgICAgIGlmIChjb2RlKSB7CiAgICAgICAgICAgIHRoaXMuY29kZSA9IGNvZGU7CiAgICAgICAgICAgIHRoaXMuZGVzY3JpcHRpb24gPSBSRUFTT05fUEhSQVNFW2NvZGVdOwogICAgICAgIH0KCiAgICAgICAgaWYgKHZhbHVlKSB0aGlzLnZhbHVlID0gdmFsdWU7CiAgICB9CgogICAgcmV0dXJuIFJlc3BvbnNlTWVzc2FnZUJvZHk7Cn0pKE1lc3NhZ2VCb2R5KTsKCmV4cG9ydHMuUmVzcG9uc2VNZXNzYWdlQm9keSA9IFJlc3BvbnNlTWVzc2FnZUJvZHk7CnZhciBSRVNQT05TX0NPREUgPSB7CiAgICAxMDA6ICcxMDAnLAogICAgMTAxOiAnMTAxJywKICAgIDIwMDogJzIwMCcsCiAgICAyMDE6ICcyMDEnLAogICAgMjAyOiAnMjAyJywKICAgIDIwMzogJzIwMycsCiAgICAyMDQ6ICcyMDQnLAogICAgMjA1OiAnMjA1JywKICAgIDIwNjogJzIwNicsCiAgICAzMDA6ICczMDAnLAogICAgMzAxOiAnMzAxJywKICAgIDMwMjogJzMwMicsCiAgICAzMDM6ICczMDMnLAogICAgMzA0OiAnMzA0JywKICAgIDMwNTogJzMwNScsCiAgICAzMDc6ICczMDcnLAogICAgNDAwOiAnNDAwJywKICAgIDQwMTogJzQwMScsCiAgICA0MDI6ICc0MDInLAogICAgNDAzOiAnNDAzJywKICAgIDQwNDogJzQwNCcsCiAgICA0MDU6ICc0MDUnLAogICAgNDA2OiAnNDA2JywKICAgIDQwNzogJzQwNycsCiAgICA0MDg6ICc0MDgnLAogICAgNDA5OiAnNDA5JywKICAgIDQxMDogJzQxMCcsCiAgICA0MTE6ICc0MTEnLAogICAgNDEyOiAnNDEyJywKICAgIDQxMzogJzQxMycsCiAgICA0MTQ6ICc0MTQnLAogICAgNDE1OiAnNDE1JywKICAgIDQxNjogJzQxNicsCiAgICA0MTc6ICc0MTcnLAogICAgNDI2OiAnNDI2JywKICAgIDUwMDogJzUwMCcsCiAgICA1MDE6ICc1MDEnLAogICAgNTAyOiAnNTAyJywKICAgIDUwMzogJzUwMycsCiAgICA1MDQ6ICc1MDQnLAogICAgNTA1OiAnNTA1Jwp9OwpleHBvcnRzLlJFU1BPTlNfQ09ERSA9IFJFU1BPTlNfQ09ERTsKdmFyIFJFQVNPTl9QSFJBU0UgPSB7CiAgICAxMDA6ICdDb250aW51ZScsCiAgICAxMDE6ICdTd2l0Y2hpbmcgUHJvdG9jb2xzJywKICAgIDIwMDogJ09LJywKICAgIDIwMTogJ0NyZWF0ZWQnLAogICAgMjAyOiAnQWNjZXB0ZWQnLAogICAgMjAzOiAnTm9uLUF1dGhvcml0YXRpdmUgSW5mb3JtYXRpb24nLAogICAgMjA0OiAnTm8gQ29udGVudCcsCiAgICAyMDU6ICdSZXNldCBDb250ZW50JywKICAgIDIwNjogJ1BhcnRpYWwgQ29udGVudCcsCiAgICAzMDA6ICdNdWx0aXBsZSBDaG9pY2VzJywKICAgIDMwMTogJ01vdmVkIFBlcm1hbmVudGx5JywKICAgIDMwMjogJ0ZvdW5kJywKICAgIDMwMzogJ1NlZSBPdGhlcicsCiAgICAzMDQ6ICdOb3QgTW9kaWZpZWQnLAogICAgMzA1OiAnVXNlIFByb3h5JywKICAgIDMwNzogJ1RlbXBvcmFyeSBSZWRpcmVjdCcsCiAgICA0MDA6ICdCYWQgUmVxdWVzdCcsCiAgICA0MDE6ICdVbmF1dGhvcml6ZWQnLAogICAgNDAyOiAnUGF5bWVudCBSZXF1aXJlZCcsCiAgICA0MDM6ICdGb3JiaWRkZW4nLAogICAgNDA0OiAnTm90IEZvdW5kJywKICAgIDQwNTogJ01ldGhvZCBOb3QgQWxsb3dlZCcsCiAgICA0MDY6ICdOb3QgQWNjZXB0YWJsZScsCiAgICA0MDc6ICdQcm94eSBBdXRoZW50aWNhdGlvbiBSZXF1aXJlZCcsCiAgICA0MDg6ICdSZXF1ZXN0IFRpbWVvdXQnLAogICAgNDA5OiAnQ29uZmxpY3QnLAogICAgNDEwOiAnR29uZScsCiAgICA0MTE6ICdMZW5ndGggUmVxdWlyZWQnLAogICAgNDEyOiAnUHJlY29uZGl0aW9uIEZhaWxlZCcsCiAgICA0MTM6ICdQYXlsb2FkIFRvbyBMYXJnZScsCiAgICA0MTQ6ICdSZXF1ZXN0LVVSSSBUb28gTG9uZycsCiAgICA0MTU6ICdVbnN1cHBvcnRlZCBNZWRpYSBUeXBlJywKICAgIDQxNjogJ1JhbmdlIE5vdCBTYXRpc2ZpYWJsZScsCiAgICA0MTc6ICdFeHBlY3RhdGlvbiBGYWlsZWQnLAogICAgNDI2OiAnVXBncmFkZSBSZXF1aXJlZCcsCiAgICA1MDA6ICdJbnRlcm5hbCBTZXJ2ZXIgRXJyb3InLAogICAgNTAxOiAnTm90IEltcGxlbWVudGVkJywKICAgIDUwMjogJ0JhZCBHYXRld2F5JywKICAgIDUwMzogJ1NlcnZpY2UgVW5hdmFpbGFibGUnLAogICAgNTA0OiAnR2F0ZXdheSBUaW1lLW91dCcsCiAgICA1MDU6ICdIVFRQIFZlcnNpb24gTm90IFN1cHBvcnRlZCcKfTsKCmV4cG9ydHMuUkVBU09OX1BIUkFTRSA9IFJFQVNPTl9QSFJBU0U7CmV4cG9ydHNbJ2RlZmF1bHQnXSA9IE1lc3NhZ2VCb2R5OwoKfSx7fV0sMTY6W2Z1bmN0aW9uKHJlcXVpcmUsbW9kdWxlLGV4cG9ydHMpewovKioKKiBNZXNzYWdlIEZhY3RvcnkKKiAKKi8KCid1c2Ugc3RyaWN0JzsKCk9iamVjdC5kZWZpbmVQcm9wZXJ0eShleHBvcnRzLCAnX19lc01vZHVsZScsIHsKICAgIHZhbHVlOiB0cnVlCn0pOwoKdmFyIF9jcmVhdGVDbGFzcyA9IChmdW5jdGlvbiAoKSB7IGZ1bmN0aW9uIGRlZmluZVByb3BlcnRpZXModGFyZ2V0LCBwcm9wcykgeyBmb3IgKHZhciBpID0gMDsgaSA8IHByb3BzLmxlbmd0aDsgaSsrKSB7IHZhciBkZXNjcmlwdG9yID0gcHJvcHNbaV07IGRlc2NyaXB0b3IuZW51bWVyYWJsZSA9IGRlc2NyaXB0b3IuZW51bWVyYWJsZSB8fCBmYWxzZTsgZGVzY3JpcHRvci5jb25maWd1cmFibGUgPSB0cnVlOyBpZiAoJ3ZhbHVlJyBpbiBkZXNjcmlwdG9yKSBkZXNjcmlwdG9yLndyaXRhYmxlID0gdHJ1ZTsgT2JqZWN0LmRlZmluZVByb3BlcnR5KHRhcmdldCwgZGVzY3JpcHRvci5rZXksIGRlc2NyaXB0b3IpOyB9IH0gcmV0dXJuIGZ1bmN0aW9uIChDb25zdHJ1Y3RvciwgcHJvdG9Qcm9wcywgc3RhdGljUHJvcHMpIHsgaWYgKHByb3RvUHJvcHMpIGRlZmluZVByb3BlcnRpZXMoQ29uc3RydWN0b3IucHJvdG90eXBlLCBwcm90b1Byb3BzKTsgaWYgKHN0YXRpY1Byb3BzKSBkZWZpbmVQcm9wZXJ0aWVzKENvbnN0cnVjdG9yLCBzdGF0aWNQcm9wcyk7IHJldHVybiBDb25zdHJ1Y3RvcjsgfTsgfSkoKTsKCnZhciBfZ2V0ID0gZnVuY3Rpb24gZ2V0KF94LCBfeDIsIF94MykgeyB2YXIgX2FnYWluID0gdHJ1ZTsgX2Z1bmN0aW9uOiB3aGlsZSAoX2FnYWluKSB7IHZhciBvYmplY3QgPSBfeCwgcHJvcGVydHkgPSBfeDIsIHJlY2VpdmVyID0gX3gzOyBfYWdhaW4gPSBmYWxzZTsgaWYgKG9iamVjdCA9PT0gbnVsbCkgb2JqZWN0ID0gRnVuY3Rpb24ucHJvdG90eXBlOyB2YXIgZGVzYyA9IE9iamVjdC5nZXRPd25Qcm9wZXJ0eURlc2NyaXB0b3Iob2JqZWN0LCBwcm9wZXJ0eSk7IGlmIChkZXNjID09PSB1bmRlZmluZWQpIHsgdmFyIHBhcmVudCA9IE9iamVjdC5nZXRQcm90b3R5cGVPZihvYmplY3QpOyBpZiAocGFyZW50ID09PSBudWxsKSB7IHJldHVybiB1bmRlZmluZWQ7IH0gZWxzZSB7IF94ID0gcGFyZW50OyBfeDIgPSBwcm9wZXJ0eTsgX3gzID0gcmVjZWl2ZXI7IF9hZ2FpbiA9IHRydWU7IGRlc2MgPSBwYXJlbnQgPSB1bmRlZmluZWQ7IGNvbnRpbnVlIF9mdW5jdGlvbjsgfSB9IGVsc2UgaWYgKCd2YWx1ZScgaW4gZGVzYykgeyByZXR1cm4gZGVzYy52YWx1ZTsgfSBlbHNlIHsgdmFyIGdldHRlciA9IGRlc2MuZ2V0OyBpZiAoZ2V0dGVyID09PSB1bmRlZmluZWQpIHsgcmV0dXJuIHVuZGVmaW5lZDsgfSByZXR1cm4gZ2V0dGVyLmNhbGwocmVjZWl2ZXIpOyB9IH0gfTsKCmZ1bmN0aW9uIF9pbnRlcm9wUmVxdWlyZURlZmF1bHQob2JqKSB7IHJldHVybiBvYmogJiYgb2JqLl9fZXNNb2R1bGUgPyBvYmogOiB7ICdkZWZhdWx0Jzogb2JqIH07IH0KCmZ1bmN0aW9uIF9jbGFzc0NhbGxDaGVjayhpbnN0YW5jZSwgQ29uc3RydWN0b3IpIHsgaWYgKCEoaW5zdGFuY2UgaW5zdGFuY2VvZiBDb25zdHJ1Y3RvcikpIHsgdGhyb3cgbmV3IFR5cGVFcnJvcignQ2Fubm90IGNhbGwgYSBjbGFzcyBhcyBhIGZ1bmN0aW9uJyk7IH0gfQoKZnVuY3Rpb24gX2luaGVyaXRzKHN1YkNsYXNzLCBzdXBlckNsYXNzKSB7IGlmICh0eXBlb2Ygc3VwZXJDbGFzcyAhPT0gJ2Z1bmN0aW9uJyAmJiBzdXBlckNsYXNzICE9PSBudWxsKSB7IHRocm93IG5ldyBUeXBlRXJyb3IoJ1N1cGVyIGV4cHJlc3Npb24gbXVzdCBlaXRoZXIgYmUgbnVsbCBvciBhIGZ1bmN0aW9uLCBub3QgJyArIHR5cGVvZiBzdXBlckNsYXNzKTsgfSBzdWJDbGFzcy5wcm90b3R5cGUgPSBPYmplY3QuY3JlYXRlKHN1cGVyQ2xhc3MgJiYgc3VwZXJDbGFzcy5wcm90b3R5cGUsIHsgY29uc3RydWN0b3I6IHsgdmFsdWU6IHN1YkNsYXNzLCBlbnVtZXJhYmxlOiBmYWxzZSwgd3JpdGFibGU6IHRydWUsIGNvbmZpZ3VyYWJsZTogdHJ1ZSB9IH0pOyBpZiAoc3VwZXJDbGFzcykgT2JqZWN0LnNldFByb3RvdHlwZU9mID8gT2JqZWN0LnNldFByb3RvdHlwZU9mKHN1YkNsYXNzLCBzdXBlckNsYXNzKSA6IHN1YkNsYXNzLl9fcHJvdG9fXyA9IHN1cGVyQ2xhc3M7IH0KCnZhciBfcmVUSElOS09iamVjdFJldGhpbmtPYmplY3RKcyA9IHJlcXVpcmUoJy4uL3JlVEhJTktPYmplY3QvUmV0aGlua09iamVjdC5qcycpOwoKdmFyIF9yZVRISU5LT2JqZWN0UmV0aGlua09iamVjdEpzMiA9IF9pbnRlcm9wUmVxdWlyZURlZmF1bHQoX3JlVEhJTktPYmplY3RSZXRoaW5rT2JqZWN0SnMpOwoKdmFyIF9NZXNzYWdlSnMgPSByZXF1aXJlKCcuL01lc3NhZ2UuanMnKTsKCnZhciBfTWVzc2FnZUpzMiA9IF9pbnRlcm9wUmVxdWlyZURlZmF1bHQoX01lc3NhZ2VKcyk7Cgp2YXIgX01lc3NhZ2VCb2R5SnMgPSByZXF1aXJlKCcuL01lc3NhZ2VCb2R5LmpzJyk7Cgp2YXIgTWVzc2FnZUZhY3RvcnkgPSAoZnVuY3Rpb24gKF9SZXRoaW5rT2JqZWN0KSB7CiAgICBfaW5oZXJpdHMoTWVzc2FnZUZhY3RvcnksIF9SZXRoaW5rT2JqZWN0KTsKCiAgICAvKioKICAgICAqIENvbnN0cnVjdG9yCiAgICAgKiBAcGFyYW0ge2Jvb2xlYW59IHZhbGlkYXRpb24KICAgICAqIEBwYXJhbSB7VVJMLlVSTCB9IHNjaGVtYSAtIGxpbmsgdG8gdGhlIHNjaGVtYQogICAgICovCgogICAgZnVuY3Rpb24gTWVzc2FnZUZhY3RvcnkodmFsaWRhdGlvbiwgc2NoZW1hKSB7CiAgICAgICAgX2NsYXNzQ2FsbENoZWNrKHRoaXMsIE1lc3NhZ2VGYWN0b3J5KTsKCiAgICAgICAgX2dldChPYmplY3QuZ2V0UHJvdG90eXBlT2YoTWVzc2FnZUZhY3RvcnkucHJvdG90eXBlKSwgJ2NvbnN0cnVjdG9yJywgdGhpcykuY2FsbCh0aGlzLCB2YWxpZGF0aW9uLCBzY2hlbWEpOwoKICAgICAgICB2YXIgX3RoaXMgPSB0aGlzOwogICAgfQoKICAgIF9jcmVhdGVDbGFzcyhNZXNzYWdlRmFjdG9yeSwgW3sKICAgICAgICBrZXk6ICd2YWxpZGF0ZScsCiAgICAgICAgdmFsdWU6IGZ1bmN0aW9uIHZhbGlkYXRlKGRhdGEpIHsKICAgICAgICAgICAgcmV0dXJuIF9nZXQoT2JqZWN0LmdldFByb3RvdHlwZU9mKE1lc3NhZ2VGYWN0b3J5LnByb3RvdHlwZSksICd2YWxpZGF0ZScsIHRoaXMpLmNhbGwodGhpcywgZGF0YSk7CiAgICAgICAgfQoKICAgICAgICAvKioKICAgICAgICAgKiBDcmVhdGUgYSBNZXNzYWdlIHdpdGggQ1JFQVRFIE1lc3NhZ2VUeXBlIGFuZCBDcmVhdGUgTWVzc2FnZSBCb2R5CiAgICAgICAgICoKICAgICAgICAgKiBAcGFyYW0ge1VSTC5VUkx9IGZyb20gLSB0aGUgc2VuZGVyIG9mIHRoaXMgbWVzc2FnZQogICAgICAgICAqIEBwYXJhbSB7VVJMLlVSTExpc3R9IE9uZSBvciBtb3JlIFVSTHMgb2YgTWVzc2FnZSByZWNpcGllbnRzLiBBY2NvcmRpbmcgdG8gdGhlIFVSTCBzY2hlbWUgaXQgbWF5IGJlIGhhbmRsZWQgaW4KICAgICAgICAgKiBkaWZmZXJlbnQgd2F5cwogICAgICAgICAqIEBwYXJhbSB7T2JqZWN0fSBjb250ZXh0SWQgLSB0aGUgR1VJRCB1c2VkIHRvIGlkZW50aXR5IGVnIGEgY29tbXVuaWNhdGlvbiBzZXNzaW9uIGxpa2UgYSB0ZWxlcGhvbnkgY2FsbAogICAgICAgICAqIEBwYXJhbSB7SWRlbnRpdHkuSldUfSBpZFRva2VuIC0gdG9rZW4gZm9yIElkZW50aXR5IGFzc2VydGlvbiBwdXJwb3NlCiAgICAgICAgICogQHBhcmFtIHtJZGVudGl0eS5KV1R9IGFjY2Vzc1Rva2VuIC0gYWNjZXNzIHRva2VuIGZvciBhY2Nlc3MgY29udHJvbCBwdXJwb3NlcwogICAgICAgICAqIEBwYXJhbSB7VVJMLlVSbH0gcmVzb3VyY2UgLSBVUkwgb2YgRGF0YSBPYmplY3QgUmVzb3VyY2UgYXNzb2NpYXRlZCB3aXRoIHRoZSBtZXNzYWdlCiAgICAgICAgICogQHBhcmFtIHtzdHJpbmd9IHNpZ25hdHVyZSAtCiAgICAgICAgICogQHBhcmFtIHtzdHJpbmd9IHZhbHVlIC0gdGhlIGNyZWF0ZWQgb2JqZWN0IGluIEpTT04gZm9ybWF0CiAgICAgICAgICogQHBhcmFtIHtVUkwuVVJMfSBwb2xpY3kgLSBVUkwgZnJvbSB3aGVyZSBhY2Nlc3MgcG9saWN5IGNvbnRyb2wgY2FuIGJlIGRvd25sb2FkZWQKICAgICAgICAgKgogICAgICAgICAqIEByZXR1cm4ge01lc3NhZ2V9IENyZWF0ZSBNZXNzYWdlCiAgICAgICAgICovCiAgICB9LCB7CiAgICAgICAga2V5OiAnY3JlYXRlTWVzc2FnZVJlcXVlc3QnLAogICAgICAgIHZhbHVlOiBmdW5jdGlvbiBjcmVhdGVNZXNzYWdlUmVxdWVzdChmcm9tLCB0bywgY29udGV4dElkLCBpZFRva2VuLCBhY2Nlc3NUb2tlbiwgcmVzb3VyY2UsIHNpZ25hdHVyZSwgc2NoZW1hLCBhc3NlcnRlZElkZW50aXR5LCB2YWx1ZSwgcG9saWN5KSB7CiAgICAgICAgICAgIGlmICh0eXBlb2YgZnJvbSA9PT0gJ3VuZGVmaW5lZCcgfHwgdHlwZW9mIGNvbnRleHRJZCA9PT0gJ3VuZGVmaW5lZCcgfHwgdHlwZW9mIHZhbHVlID09PSAndW5kZWZpbmVkJykgdGhyb3cgbmV3IEVycm9yKCJmcm9tLCBjb250ZXh0SWQsIGFuZCB2YWx1ZSBvZiBvYmplY3QgdG8gYmUgY3JlYXRlZCBNVVNUIGJlIHNwZWNpZmllZCIpOwoKICAgICAgICAgICAgdmFyIG1lc3NhZ2VCb2R5ID0gbmV3IF9NZXNzYWdlQm9keUpzLkNyZWF0ZU1lc3NhZ2VCb2R5KHZhbHVlLCBwb2xpY3ksIGlkVG9rZW4sIGFjY2Vzc1Rva2VuLCByZXNvdXJjZSwgc2NoZW1hLCBhc3NlcnRlZElkZW50aXR5KTsKICAgICAgICAgICAgdmFyIG1lc3NhZ2UgPSBuZXcgX01lc3NhZ2VKczJbJ2RlZmF1bHQnXShNZXNzYWdlRmFjdG9yeS5fZ2VuZXJhdGVNZXNzYWdlSWQoKSwgZnJvbSwgdG8sIF9NZXNzYWdlSnMuTWVzc2FnZVR5cGUuQ1JFQVRFLCBjb250ZXh0SWQsIG1lc3NhZ2VCb2R5LCBzaWduYXR1cmUpOwogICAgICAgICAgICByZXR1cm4gbWVzc2FnZTsKICAgICAgICB9CiAgICB9LCB7CiAgICAgICAga2V5OiAnY3JlYXRlRm9yd2FyZE1lc3NhZ2VSZXF1ZXN0JywKICAgICAgICB2YWx1ZTogZnVuY3Rpb24gY3JlYXRlRm9yd2FyZE1lc3NhZ2VSZXF1ZXN0KGRhdGEsIGZyb20sIHRvLCBjb250ZXh0SWQsIGlkVG9rZW4sIGFjY2Vzc1Rva2VuLCByZXNvdXJjZSwgc2lnbmF0dXJlLCBzY2hlbWEsIGFzc2VydGVkSWRlbnRpdHkpIHsKICAgICAgICAgICAgaWYgKHR5cGVvZiBmcm9tID09PSAndW5kZWZpbmVkJyB8fCB0eXBlb2YgY29udGV4dElkID09PSAndW5kZWZpbmVkJyB8fCB0eXBlb2YgZGF0YSA9PT0gJ3VuZGVmaW5lZCcpIHRocm93IG5ldyBFcnJvcigiZnJvbSwgY29udGV4dElkLCBhbmQgbWVzc2FnZSB0byBmb3J3YXJkIE1VU1QgYmUgc3BlY2lmaWVkIik7CgogICAgICAgICAgICB2YXIgbWVzc2FnZUJvZHkgPSBuZXcgX01lc3NhZ2VCb2R5SnMuRm9yd2FyZE1lc3NhZ2VCb2R5KGlkVG9rZW4sIGFjY2Vzc1Rva2VuLCByZXNvdXJjZSwgc2NoZW1hLCBhc3NlcnRlZElkZW50aXR5LCBkYXRhKTsKICAgICAgICAgICAgdmFyIG1lc3NhZ2UgPSBuZXcgX01lc3NhZ2VKczJbJ2RlZmF1bHQnXShNZXNzYWdlRmFjdG9yeS5fZ2VuZXJhdGVNZXNzYWdlSWQoKSwgZnJvbSwgdG8sIF9NZXNzYWdlSnMuTWVzc2FnZVR5cGUuRk9SV0FSRCwgY29udGV4dElkLCBtZXNzYWdlQm9keSwgc2lnbmF0dXJlKTsKICAgICAgICAgICAgcmV0dXJuIG1lc3NhZ2U7CiAgICAgICAgfQoKICAgICAgICAvKioKICAgICAgICAgKiAgQ3JlYXRlIERlbGV0ZSBNZXNzYWdlCiAgICAgICAgICogQHBhcmFtIHtVUkwuVVJMfSBmcm9tIC0gdGhlIHNlbmRlciBvZiB0aGlzIG1lc3NhZ2UKICAgICAgICAgKiBAcGFyYW0ge1VSTC5VUkxMaXN0fSB0byAtIE9uZSBvciBtb3JlIFVSTHMgb2YgTWVzc2FnZSByZWNpcGllbnRzLiBBY2NvcmRpbmcgdG8gdGhlIFVSTCBzY2hlbWUgaXQgbWF5IGJlIGhhbmRsZWQgaW4KICAgICAgICAgKiBkaWZmZXJlbnQgd2F5cwogICAgICAgICAqIEBwYXJhbSB7T2JqZWN0fSBjb250ZXh0SWQgLSB0aGUgR1VJRCB1c2VkIHRvIGlkZW50aXR5IGVnIGEgY29tbXVuaWNhdGlvbiBzZXNzaW9uIGxpa2UgYSB0ZWxlcGhvbnkgY2FsbAogICAgICAgICAqIEBwYXJhbSB7SWRlbnRpdHkuSldUfSBpZFRva2VuIC0gdG9rZW4gZm9yIElkZW50aXR5IGFzc2VydGlvbiBwdXJwb3NlCiAgICAgICAgICogQHBhcmFtIHtJZGVudGl0eS5KV1R9IGFjY2Vzc1Rva2VuIC0gYWNjZXNzIHRva2VuIGZvciBhY2Nlc3MgY29udHJvbCBwdXJwb3NlcwogICAgICAgICAqIEBwYXJhbSB7VVJMLlVSbH0gcmVzb3VyY2UgLSBVUkwgb2YgRGF0YSBPYmplY3QgUmVzb3VyY2UgYXNzb2NpYXRlZCB3aXRoIHRoZSBtZXNzYWdlCiAgICAgICAgICogQHBhcmFtIHtzdHJpbmd9IHNpZ25hdHVyZSAtCiAgICAgICAgICogQHBhcmFtIGF0dHJpYnV0ZSAtIElkZW50aWZpZXMgdGhlIGF0dHJpYnV0ZSBpbiB0aGUgT2JqZWN0IHRvIGJlIGRlbGV0ZWQKICAgICAgICAgKiBAcGFyYW0gc2NoZW1hCiAgICAgICAgICogQHBhcmFtIGFzc2VydGVkSWRlbnRpdHkgLSB1c2VyIGlkZW50aXR5CiAgICAgICAgICogQHJldHVybiBEZWxldGUgTWVzc2FnZQogICAgICAgICAqLwogICAgfSwgewogICAgICAgIGtleTogJ2NyZWF0ZURlbGV0ZU1lc3NhZ2VSZXF1ZXN0JywKICAgICAgICB2YWx1ZTogZnVuY3Rpb24gY3JlYXRlRGVsZXRlTWVzc2FnZVJlcXVlc3QoZnJvbSwgdG8sIGNvbnRleHRJZCwgaWRUb2tlbiwgYWNjZXNzVG9rZW4sIHJlc291cmNlLCBzaWduYXR1cmUsIGF0dHJpYnV0ZSwgc2NoZW1hLCBhc3NlcnRlZElkZW50aXR5KSB7CiAgICAgICAgICAgIGlmICh0eXBlb2YgZnJvbSA9PT0gJ3VuZGVmaW5lZCcgfHwgdHlwZW9mIGNvbnRleHRJZCA9PT0gJ3VuZGVmaW5lZCcpIHRocm93IG5ldyBFcnJvcigiZnJvbSwgY29udGV4dElkLCBhbmQgdmFsdWUgb2Ygb2JqZWN0IHRvIGJlIGNyZWF0ZWQgTVVTVCBiZSBzcGVjaWZpZWQiKTsKICAgICAgICAgICAgdmFyIG1lc3NhZ2VCb2R5ID0gbmV3IF9NZXNzYWdlQm9keUpzLkRlbGV0ZU1lc3NhZ2VCb2R5KGlkVG9rZW4sIGFjY2Vzc1Rva2VuLCByZXNvdXJjZSwgYXR0cmlidXRlLCBzY2hlbWEsIGFzc2VydGVkSWRlbnRpdHkpOwogICAgICAgICAgICB2YXIgbWVzc2FnZSA9IG5ldyBfTWVzc2FnZUpzMlsnZGVmYXVsdCddKE1lc3NhZ2VGYWN0b3J5Ll9nZW5lcmF0ZU1lc3NhZ2VJZCgpLCBmcm9tLCB0bywgX01lc3NhZ2VKcy5NZXNzYWdlVHlwZS5ERUxFVEUsIGNvbnRleHRJZCwgbWVzc2FnZUJvZHksIHNpZ25hdHVyZSk7CiAgICAgICAgICAgIHJldHVybiBtZXNzYWdlOwogICAgICAgIH0KCiAgICAgICAgLyoqCiAgICAgICAgICogQ3JlYXRlcyBhbiBVcGRhdGUgTWVzc2FnZSBSZXF1ZXN0CiAgICAgICAgICogQHBhcmFtIHtVUkwuVVJMfSBmcm9tIC0gdGhlIHNlbmRlciBvZiB0aGlzIG1lc3NhZ2UKICAgICAgICAgKiBAcGFyYW0ge1VSTC5VUkxMaXN0fSBPbmUgb3IgbW9yZSBVUkxzIG9mIE1lc3NhZ2UgcmVjaXBpZW50cy4gQWNjb3JkaW5nIHRvIHRoZSBVUkwgc2NoZW1lIGl0IG1heSBiZSBoYW5kbGVkIGluCiAgICAgICAgICogZGlmZmVyZW50IHdheXMKICAgICAgICAgKiBAcGFyYW0ge09iamVjdH0gY29udGV4dElkIC0gdGhlIEdVSUQgdXNlZCB0byBpZGVudGl0eSBlZyBhIGNvbW11bmljYXRpb24gc2Vzc2lvbiBsaWtlIGEgdGVsZXBob255IGNhbGwKICAgICAgICAgKiBAcGFyYW0ge0lkZW50aXR5LkpXVH0gaWRUb2tlbiAtIHRva2VuIGZvciBJZGVudGl0eSBhc3NlcnRpb24gcHVycG9zZQogICAgICAgICAqIEBwYXJhbSB7SWRlbnRpdHkuSldUfSBhY2Nlc3NUb2tlbiAtIGFjY2VzcyB0b2tlbiBmb3IgYWNjZXNzIGNvbnRyb2wgcHVycG9zZXMKICAgICAgICAgKiBAcGFyYW0ge1VSTC5VUmx9IHJlc291cmNlIC0gVVJMIG9mIERhdGEgT2JqZWN0IFJlc291cmNlIGFzc29jaWF0ZWQgd2l0aCB0aGUgbWVzc2FnZQogICAgICAgICAqIEBwYXJhbSB7c3RyaW5nfSBzaWduYXR1cmUgLQogICAgICAgICAqIEBwYXJhbSBhdHRyaWJ1dGUgLSBJZGVudGlmaWVzIHRoZSBhdHRyaWJ1dGUgaW4gdGhlIE9iamVjdCB0byBiZSB1cGRhdGVkCiAgICAgICAgICogQHBhcmFtIHZhbHVlIC0gVGhlIG5ldyB2YWx1ZSBvZiB0aGUgYXR0cmlidXRlIHRvIGJlIHVwZGF0ZWQKICAgICAgICAgKi8KICAgIH0sIHsKICAgICAgICBrZXk6ICdjcmVhdGVVcGRhdGVNZXNzYWdlUmVxdWVzdCcsCiAgICAgICAgdmFsdWU6IGZ1bmN0aW9uIGNyZWF0ZVVwZGF0ZU1lc3NhZ2VSZXF1ZXN0KGZyb20sIHRvLCBjb250ZXh0SWQsIGlkVG9rZW4sIGFjY2Vzc1Rva2VuLCByZXNvdXJjZSwgc2lnbmF0dXJlLCBzY2hlbWEsIGFzc2VydGVkSWRlbnRpdHksIGF0dHJpYnV0ZSwgdmFsdWUpIHsKICAgICAgICAgICAgaWYgKHR5cGVvZiBmcm9tID09PSAndW5kZWZpbmVkJyB8fCB0eXBlb2YgY29udGV4dElkID09PSAndW5kZWZpbmVkJykgdGhyb3cgbmV3IEVycm9yKCJmcm9tLCBhbmQgY29udGV4dElkIE1VU1QgYmUgc3BlY2lmaWVkIik7CiAgICAgICAgICAgIHZhciBtZXNzYWdlQm9keSA9IG5ldyBfTWVzc2FnZUJvZHlKcy5VcGRhdGVNZXNzYWdlQm9keShpZFRva2VuLCBhY2Nlc3NUb2tlbiwgcmVzb3VyY2UsIHNjaGVtYSwgYXNzZXJ0ZWRJZGVudGl0eSwgYXR0cmlidXRlLCB2YWx1ZSk7CiAgICAgICAgICAgIHZhciBtZXNzYWdlID0gbmV3IF9NZXNzYWdlSnMyWydkZWZhdWx0J10oTWVzc2FnZUZhY3RvcnkuX2dlbmVyYXRlTWVzc2FnZUlkKCksIGZyb20sIHRvLCBfTWVzc2FnZUpzLk1lc3NhZ2VUeXBlLlVQREFURSwgY29udGV4dElkLCBtZXNzYWdlQm9keSwgc2lnbmF0dXJlKTsKICAgICAgICAgICAgcmV0dXJuIG1lc3NhZ2U7CiAgICAgICAgfQoKICAgICAgICAvKioKICAgICAgICAgKgogICAgICAgICAqIEBwYXJhbSB7VVJMLlVSTH0gZnJvbSAtIHRoZSBzZW5kZXIgb2YgdGhpcyBtZXNzYWdlCiAgICAgICAgICogQHBhcmFtIHtVUkwuVVJMTGlzdH0gT25lIG9yIG1vcmUgVVJMcyBvZiBNZXNzYWdlIHJlY2lwaWVudHMuIEFjY29yZGluZyB0byB0aGUgVVJMIHNjaGVtZSBpdCBtYXkgYmUgaGFuZGxlZCBpbgogICAgICAgICAqIGRpZmZlcmVudCB3YXlzCiAgICAgICAgICogQHBhcmFtIHtPYmplY3R9IGNvbnRleHRJZCAtIHRoZSBHVUlEIHVzZWQgdG8gaWRlbnRpdHkgZWcgYSBjb21tdW5pY2F0aW9uIHNlc3Npb24gbGlrZSBhIHRlbGVwaG9ueSBjYWxsCiAgICAgICAgICogQHBhcmFtIHtJZGVudGl0eS5KV1R9IGlkVG9rZW4gLSB0b2tlbiBmb3IgSWRlbnRpdHkgYXNzZXJ0aW9uIHB1cnBvc2UKICAgICAgICAgKiBAcGFyYW0ge0lkZW50aXR5LkpXVH0gYWNjZXNzVG9rZW4gLSBhY2Nlc3MgdG9rZW4gZm9yIGFjY2VzcyBjb250cm9sIHB1cnBvc2VzCiAgICAgICAgICogQHBhcmFtIHtVUkwuVVJsfSByZXNvdXJjZSAtIFVSTCBvZiBEYXRhIE9iamVjdCBSZXNvdXJjZSBhc3NvY2lhdGVkIHdpdGggdGhlIG1lc3NhZ2UKICAgICAgICAgKiBAcGFyYW0ge3N0cmluZ30gc2lnbmF0dXJlIC0KICAgICAgICAgKiBAcGFyYW0gc2NoZW1hIC0KICAgICAgICAgKiBAcGFyYW0gYXNzZXJ0ZWRJZGVudGl0eSAtIHRoZSB1c2VyIGlkZW50aXR5CiAgICAgICAgICogQHBhcmFtIGF0dHJpYnV0ZSAtIElkZW50aWZpZXMgdGhlIGF0dHJpYnV0ZSBpbiB0aGUgT2JqZWN0IHRvIGJlIHJlYWQKICAgICAgICAgKiBAcGFyYW0gY3JpdGVyaWFTeW50YXggLQogICAgICAgICAqIEBwYXJhbSBjcml0ZXJpYSAtCiAgICAgICAgICovCiAgICB9LCB7CiAgICAgICAga2V5OiAnY3JlYXRlUmVhZE1lc3NhZ2VSZXF1ZXN0JywKICAgICAgICB2YWx1ZTogZnVuY3Rpb24gY3JlYXRlUmVhZE1lc3NhZ2VSZXF1ZXN0KGZyb20sIHRvLCBjb250ZXh0SWQsIGlkVG9rZW4sIGFjY2Vzc1Rva2VuLCByZXNvdXJjZSwgc2lnbmF0dXJlLCBzY2hlbWEsIGFzc2VydGVkSWRlbnRpdHksIGF0dHJpYnV0ZSwgY3JpdGVyaWFTeW50YXgsIGNyaXRlcmlhKSB7CiAgICAgICAgICAgIGlmICh0eXBlb2YgZnJvbSA9PT0gJ3VuZGVmaW5lZCcgfHwgdHlwZW9mIGNvbnRleHRJZCA9PT0gJ3VuZGVmaW5lZCcpIHRocm93IG5ldyBFcnJvcigiZnJvbSwgYW5kIGNvbnRleHRJZCBNVVNUIGJlIHNwZWNpZmllZCIpOwogICAgICAgICAgICB2YXIgbWVzc2FnZUJvZHkgPSBuZXcgX01lc3NhZ2VCb2R5SnMuUmVhZE1lc3NhZ2VCb2R5KGlkVG9rZW4sIGFjY2Vzc1Rva2VuLCByZXNvdXJjZSwgc2NoZW1hLCBhc3NlcnRlZElkZW50aXR5LCBhdHRyaWJ1dGUsIGNyaXRlcmlhU3ludGF4LCBjcml0ZXJpYSk7CiAgICAgICAgICAgIHZhciBtZXNzYWdlID0gbmV3IF9NZXNzYWdlSnMyWydkZWZhdWx0J10oTWVzc2FnZUZhY3RvcnkuX2dlbmVyYXRlTWVzc2FnZUlkKCksIGZyb20sIHRvLCBfTWVzc2FnZUpzLk1lc3NhZ2VUeXBlLlVQREFURSwgY29udGV4dElkLCBtZXNzYWdlQm9keSwgc2lnbmF0dXJlKTsKICAgICAgICAgICAgcmV0dXJuIG1lc3NhZ2U7CiAgICAgICAgfQoKICAgICAgICAvKioKICAgICAgICAgKgogICAgICAgICAqIEBwYXJhbSB7VVJMLlVSTH0gZnJvbSAtIHRoZSBzZW5kZXIgb2YgdGhpcyBtZXNzYWdlCiAgICAgICAgICogQHBhcmFtIHtVUkwuVVJMTGlzdH0gT25lIG9yIG1vcmUgVVJMcyBvZiBNZXNzYWdlIHJlY2lwaWVudHMuIEFjY29yZGluZyB0byB0aGUgVVJMIHNjaGVtZSBpdCBtYXkgYmUgaGFuZGxlZCBpbgogICAgICAgICAqIGRpZmZlcmVudCB3YXlzCiAgICAgICAgICogQHBhcmFtIHtPYmplY3R9IGNvbnRleHRJZCAtIHRoZSBHVUlEIHVzZWQgdG8gaWRlbnRpdHkgZWcgYSBjb21tdW5pY2F0aW9uIHNlc3Npb24gbGlrZSBhIHRlbGVwaG9ueSBjYWxsCiAgICAgICAgICogQHBhcmFtIHtJZGVudGl0eS5KV1R9IGlkVG9rZW4gLSB0b2tlbiBmb3IgSWRlbnRpdHkgYXNzZXJ0aW9uIHB1cnBvc2UKICAgICAgICAgKiBAcGFyYW0ge0lkZW50aXR5LkpXVH0gYWNjZXNzVG9rZW4gLSBhY2Nlc3MgdG9rZW4gZm9yIGFjY2VzcyBjb250cm9sIHB1cnBvc2VzCiAgICAgICAgICogQHBhcmFtIHtVUkwuVVJsfSByZXNvdXJjZSAtIFVSTCBvZiBEYXRhIE9iamVjdCBSZXNvdXJjZSBhc3NvY2lhdGVkIHdpdGggdGhlIG1lc3NhZ2UKICAgICAgICAgKiBAcGFyYW0ge3N0cmluZ30gc2lnbmF0dXJlIC0KICAgICAgICAgKiBAcGFyYW0gc2NoZW1hIC0KICAgICAgICAgKiBAcGFyYW0gYXNzZXJ0ZWRJZGVudGl0eSAtIHRoZSB1c2VyJ3MgaWRlbnRpdHkKICAgICAgICAgKiBAcGFyYW0gY29kZSAtIHJlc3BvbnNlIGNvZGUgY29tcGxpYW50IHdpdGggSFRUUCByZXNwb25zZSBjb2RlcyAoUkZDNzIzMSkuCiAgICAgICAgICogQHBhcmFtIHZhbHVlIC0gQ29udGFpbnMgYSBkYXRhIHZhbHVlIGluIEpTT04gZm9ybWF0LgogICAgICAgICAqLwogICAgfSwgewogICAgICAgIGtleTogJ2NyZWF0ZU1lc3NhZ2VSZXNwb25zZScsCiAgICAgICAgdmFsdWU6IGZ1bmN0aW9uIGNyZWF0ZU1lc3NhZ2VSZXNwb25zZShmcm9tLCB0bywgY29udGV4dElkLCBpZFRva2VuLCBhY2Nlc3NUb2tlbiwgcmVzb3VyY2UsIHNpZ25hdHVyZSwgc2NoZW1hLCBhc3NlcnRlZElkZW50aXR5LCBjb2RlLCB2YWx1ZSkgewogICAgICAgICAgICBpZiAodHlwZW9mIGZyb20gPT09ICd1bmRlZmluZWQnIHx8IHR5cGVvZiBjb250ZXh0SWQgPT09ICd1bmRlZmluZWQnIHx8IHR5cGVvZiBjb2RlID09PSAndW5kZWZpbmVkJykgdGhyb3cgbmV3IEVycm9yKCJmcm9tLCBjb250ZXh0SWQsIGFuZCByZXNwb25zZSBDb2RlIE1VU1QgYmUgc3BlY2lmaWVkIik7CiAgICAgICAgICAgIHZhciByZXNwb25zZSA9IG5ldyBfTWVzc2FnZUJvZHlKcy5SZXNwb25zZU1lc3NhZ2VCb2R5KGlkVG9rZW4sIGFjY2Vzc1Rva2VuLCByZXNvdXJjZSwgY29kZSwgdmFsdWUpOwogICAgICAgICAgICByZXR1cm4gbmV3IF9NZXNzYWdlSnMyWydkZWZhdWx0J10oTWVzc2FnZUZhY3RvcnkuX2dlbmVyYXRlTWVzc2FnZUlkKCksIGZyb20sIHRvLCBfTWVzc2FnZUpzLk1lc3NhZ2VUeXBlLlJFU1BPTlNFLCBjb250ZXh0SWQsIHJlc3BvbnNlLCBzaWduYXR1cmUpOwogICAgICAgIH0KCiAgICAgICAgLyoqCiAgICAgICAgICogR2VuZXJhdGUgYSBEZWxldGUgTWVzc2FnZSBCb2R5IHRvIHRoZSBnaXZlbiBNZXNzYWdlCiAgICAgICAgICogQHBhcmFtIHtNZXNzYWdlfSBkYXRhIC0gdGhlIGlucHV0IE1lc3NhZ2UKICAgICAgICAgKiBAcGFyYW0ge3N0cmluZ30gYXR0cmlidXRlIC0gdGhlIGF0dHJpYnV0ZSB0byBiZSBkZWxldGVkCiAgICAgICAgICogQHJldHVybiB7TWVzc2FnZX0gRGVsZXRlIE1lc3NhZ2UKICAgICAgICAgKi8KICAgIH0sIHsKICAgICAgICBrZXk6ICdnZW5lcmF0ZURlbGV0ZU1lc3NhZ2VCb2R5JywKICAgICAgICB2YWx1ZTogZnVuY3Rpb24gZ2VuZXJhdGVEZWxldGVNZXNzYWdlQm9keShkYXRhLCBhdHRyaWJ1dGUpIHsKICAgICAgICAgICAgaWYgKHR5cGVvZiBkYXRhID09PSAndW5kZWZpbmVkJyB8fCB0eXBlb2YgYXR0cmlidXRlID09PSAndW5kZWZpbmVkJykgdGhyb3cgbmV3IEVycm9yKCJtZXNzYWdlIGFuZCBhdHRyaWJ1dGUgTVVTVCBiZSBzcGVjaWZpZWQiKTsKICAgICAgICAgICAgdmFyIHByZXZpb3VzQm9keSA9IGRhdGEuYm9keTsKICAgICAgICAgICAgdmFyIGlkVG9rZW4gPSBwcmV2aW91c0JvZHkuaWRUb2tlbjsKICAgICAgICAgICAgdmFyIGFjY2Vzc1Rva2VuID0gcHJldmlvdXNCb2R5LmFjY2Vzc1Rva2VuOwogICAgICAgICAgICB2YXIgcmVzb3VyY2UgPSBwcmV2aW91c0JvZHkucmVzb3VyY2U7CiAgICAgICAgICAgIHZhciBzY2hlbWEgPSBwcmV2aW91c0JvZHkuc2NoZW1hOwogICAgICAgICAgICB2YXIgYXNzZXJ0ZWRJZGVudGl0eSA9IHByZXZpb3VzQm9keS5hc3NlcnRlZElkZW50aXR5OwoKICAgICAgICAgICAgdmFyIG5ld0JvZHkgPSBuZXcgX01lc3NhZ2VCb2R5SnMuRGVsZXRlTWVzc2FnZUJvZHkoaWRUb2tlbiwgYWNjZXNzVG9rZW4sIHJlc291cmNlLCBhdHRyaWJ1dGUsIHNjaGVtYSwgYXNzZXJ0ZWRJZGVudGl0eSk7CiAgICAgICAgICAgIHJldHVybiBuZXcgX01lc3NhZ2VKczJbJ2RlZmF1bHQnXShkYXRhLmlkLCBkYXRhLmZyb20sIGRhdGEudG8sIF9NZXNzYWdlSnMuTWVzc2FnZVR5cGUuREVMRVRFLCBkYXRhLmNvbnRleHRJZCwgbmV3Qm9keSwgZGF0YS5zaWduYXR1cmUpOwogICAgICAgIH0KCiAgICAgICAgLyoqCiAgICAgICAgICogR2VuZXJhdGUgYW4gVXBkYXRlIE1lc3NhZ2UgQm9keSB0byB0aGUgZ2l2ZW4gTWVzc2FnZQogICAgICAgICAqIEBwYXJhbSB7TWVzc2FnZX0gZGF0YSAtIE1lc3NhZ2UgdG8gYmUgdXBkYXRlZAogICAgICAgICAqIEBwYXJhbSB7c3RyaW5nfSBhdHRyaWJ1dGUgdG8gYmUgdXBkYXRlZAogICAgICAgICAqIEBwYXJhbSB7b2JqZWN0fSB2YWx1ZSB0aGUgbmV3IHZhbHVlIG9mIHRoZSBhdHRyaWJ1dGUKICAgICAgICAgKiBAcmV0dXJuIHtNZXNzYWdlfSBVcGRhdGUgTWVzc2FnZQogICAgICAgICAqLwogICAgfSwgewogICAgICAgIGtleTogJ2dlbmVyYXRlVXBkYXRlTWVzc2FnZUJvZHknLAogICAgICAgIHZhbHVlOiBmdW5jdGlvbiBnZW5lcmF0ZVVwZGF0ZU1lc3NhZ2VCb2R5KGRhdGEsIGF0dHJpYnV0ZSwgdmFsdWUpIHsKICAgICAgICAgICAgaWYgKCFkYXRhIHx8ICFhdHRyaWJ1dGUgfHwgIXZhbHVlKSB0aHJvdyBuZXcgRXJyb3IoIm1lc3NhZ2UgYXR0cmlidXRlIGFuZCB2YWx1ZSBNVVNUIGJlIHNwZWNpZmllZCIpOwogICAgICAgICAgICB2YXIgcHJldmlvdXNCb2R5ID0gZGF0YS5ib2R5OwogICAgICAgICAgICB2YXIgaWRUb2tlbiA9IHByZXZpb3VzQm9keS5pZFRva2VuOwogICAgICAgICAgICB2YXIgYWNjZXNzVG9rZW4gPSBwcmV2aW91c0JvZHkuYWNjZXNzVG9rZW47CiAgICAgICAgICAgIHZhciByZXNvdXJjZSA9IHByZXZpb3VzQm9keS5yZXNvdXJjZTsKICAgICAgICAgICAgdmFyIHNjaGVtYSA9IHByZXZpb3VzQm9keS5zY2hlbWE7CiAgICAgICAgICAgIHZhciBhc3NlcnRlZElkZW50aXR5ID0gcHJldmlvdXNCb2R5LmFzc2VydGVkSWRlbnRpdHk7CgogICAgICAgICAgICB2YXIgbmV3Qm9keSA9IG5ldyBfTWVzc2FnZUJvZHlKcy5VcGRhdGVNZXNzYWdlQm9keShpZFRva2VuLCBhY2Nlc3NUb2tlbiwgcmVzb3VyY2UsIHNjaGVtYSwgYXNzZXJ0ZWRJZGVudGl0eSwgYXR0cmlidXRlLCB2YWx1ZSk7CiAgICAgICAgICAgIHJldHVybiBuZXcgX01lc3NhZ2VKczJbJ2RlZmF1bHQnXShkYXRhLmlkLCBkYXRhLmZyb20sIGRhdGEudG8sIF9NZXNzYWdlSnMuTWVzc2FnZVR5cGUuVVBEQVRFLCBkYXRhLmNvbnRleHRJZCwgbmV3Qm9keSwgZGF0YS5zaWduYXR1cmUpOwogICAgICAgIH0KCiAgICAgICAgLyoqCiAgICAgICAgICogZ2VuZXJhdGUgYSBSZWFkIE1lc3NhZ2UgQm9keSB0byBnaXZlbiByZXF1ZXN0CiAgICAgICAgICogQHBhcmFtIHtNZXNzYWdlfSBkYXRhIC0gTWVzc2FnZSB0byBiZSB1cGRhdGVkCiAgICAgICAgICogQHBhcmFtIHtPYmplY3R9IGF0dHJpYnV0ZSAtIElkZW50aWZpZXMgdGhlIGF0dHJpYnV0ZSBpbiB0aGUgT2JqZWN0IHRvIGJlIHJlYWQKICAgICAgICAgKiBAcGFyYW0ge09iamVjdH0gY3JpdGVyaWEKICAgICAgICAgKiBAcGFyYW0ge09iamVjdH0gY3JpdGVyaWFTeW50YXgKICAgICAgICAgKi8KICAgIH0sIHsKICAgICAgICBrZXk6ICdnZW5lcmF0ZVJlYWRNZXNzYWdlQm9keScsCiAgICAgICAgdmFsdWU6IGZ1bmN0aW9uIGdlbmVyYXRlUmVhZE1lc3NhZ2VCb2R5KGRhdGEsIGF0dHJpYnV0ZSwgY3JpdGVyaWEsIGNyaXRlcmlhU3ludGF4KSB7CiAgICAgICAgICAgIGlmICghZGF0YSkgdGhyb3cgbmV3IEVycm9yKCJtZXNzYWdlIE1VU1QgYmUgc3BlY2lmaWVkIik7CiAgICAgICAgICAgIHZhciBwcmV2aW91c0JvZHkgPSBkYXRhLmJvZHk7CiAgICAgICAgICAgIHZhciBpZFRva2VuID0gcHJldmlvdXNCb2R5LmlkVG9rZW47CiAgICAgICAgICAgIHZhciBhY2Nlc3NUb2tlbiA9IHByZXZpb3VzQm9keS5hY2Nlc3NUb2tlbjsKICAgICAgICAgICAgdmFyIHJlc291cmNlID0gcHJldmlvdXNCb2R5LnJlc291cmNlOwogICAgICAgICAgICB2YXIgc2NoZW1hID0gcHJldmlvdXNCb2R5LnNjaGVtYTsKICAgICAgICAgICAgdmFyIGFzc2VydGVkSWRlbnRpdHkgPSBwcmV2aW91c0JvZHkuYXNzZXJ0ZWRJZGVudGl0eTsKCiAgICAgICAgICAgIHZhciByZWFkQm9keSA9IG5ldyBfTWVzc2FnZUJvZHlKcy5SZWFkTWVzc2FnZUJvZHkoaWRUb2tlbiwgYWNjZXNzVG9rZW4sIHJlc291cmNlLCBzY2hlbWEsIGFzc2VydGVkSWRlbnRpdHksIGF0dHJpYnV0ZSwgY3JpdGVyaWFTeW50YXgsIGNyaXRlcmlhKTsKICAgICAgICAgICAgcmV0dXJuIG5ldyBfTWVzc2FnZUpzMlsnZGVmYXVsdCddKGRhdGEuaWQsIGRhdGEuZnJvbSwgZGF0YS50bywgX01lc3NhZ2VKcy5NZXNzYWdlVHlwZS5SRUFELCBkYXRhLmNvbnRleHRJZCwgcmVhZEJvZHksIGRhdGEuc2lnbmF0dXJlKTsKICAgICAgICB9CgogICAgICAgIC8qKgogICAgICAgICAqIEdlbmVyYXRlIGEgcmVzcG9uc2UgdG8gdGhlIGdpdmVuIE1lc3NhZ2UKICAgICAgICAgKiBAcGFyYW0ge01lc3NhZ2V9IGRhdGEgLSBNZXNzYWdlIHRvIGJlIHVwZGF0ZWQKICAgICAgICAgKiBAcGFyYW0gY29kZSAtIHJlc3BvbnNlIGNvZGUgY29tcGxpYW50IHdpdGggSFRUUCByZXNwb25zZSBjb2RlcyAoUkZDNzIzMSkuCiAgICAgICAgICogQHBhcmFtIHZhbHVlIC0gQ29udGFpbnMgYSBkYXRhIHZhbHVlIGluIEpTT04gZm9ybWF0LgogICAgICAgICAqLwogICAgfSwgewogICAgICAgIGtleTogJ2dlbmVyYXRlTWVzc2FnZVJlc3BvbnNlJywKICAgICAgICB2YWx1ZTogZnVuY3Rpb24gZ2VuZXJhdGVNZXNzYWdlUmVzcG9uc2UoZGF0YSwgY29kZSwgdmFsdWUpIHsKICAgICAgICAgICAgaWYgKCFkYXRhIHx8ICFjb2RlKSB0aHJvdyBuZXcgRXJyb3IoIm1lc3NhZ2UgYW5kIHJlc3BvbnNlIGNvZGUgTVVTVCBiZSBzcGVjaWZpZWQiKTsKCiAgICAgICAgICAgIHZhciBwcmV2aW91c0JvZHkgPSBkYXRhLmJvZHk7CiAgICAgICAgICAgIHZhciBpZFRva2VuID0gcHJldmlvdXNCb2R5LmlkVG9rZW47CiAgICAgICAgICAgIHZhciBhY2Nlc3NUb2tlbiA9IHByZXZpb3VzQm9keS5hY2Nlc3NUb2tlbjsKICAgICAgICAgICAgdmFyIHJlc291cmNlID0gcHJldmlvdXNCb2R5LnJlc291cmNlOwoKICAgICAgICAgICAgdmFyIHJlc3BvbnNlID0gbmV3IF9NZXNzYWdlQm9keUpzLlJlc3BvbnNlTWVzc2FnZUJvZHkoaWRUb2tlbiwgYWNjZXNzVG9rZW4sIHJlc291cmNlLCBjb2RlLCB2YWx1ZSk7CiAgICAgICAgICAgIHJldHVybiBuZXcgX01lc3NhZ2VKczJbJ2RlZmF1bHQnXShkYXRhLmlkLCBkYXRhLmZyb20sIGRhdGEudG8sIF9NZXNzYWdlSnMuTWVzc2FnZVR5cGUuUkVTUE9OU0UsIGRhdGEuY29udGV4dElkLCByZXNwb25zZSwgZGF0YS5zaWduYXR1cmUpOwogICAgICAgIH0KICAgIH1dLCBbewogICAgICAgIGtleTogJ19nZW5lcmF0ZU1lc3NhZ2VJZCcsCiAgICAgICAgdmFsdWU6IGZ1bmN0aW9uIF9nZW5lcmF0ZU1lc3NhZ2VJZCgpIHsKICAgICAgICAgICAgdmFyIGQgPSBuZXcgRGF0ZSgpLmdldFRpbWUoKTsKCiAgICAgICAgICAgIHJldHVybiAneHh4eHh4eHgteHh4eC00eHh4LXl4eHgteHh4eHh4eHh4eHh4Jy5yZXBsYWNlKC9beHldL2csIGZ1bmN0aW9uIChjKSB7CiAgICAgICAgICAgICAgICB2YXIgciA9IChkICsgTWF0aC5yYW5kb20oKSAqIDE2KSAlIDE2IHwgMDsKICAgICAgICAgICAgICAgIGQgPSBNYXRoLmZsb29yKGQgLyAxNik7CiAgICAgICAgICAgICAgICByZXR1cm4gKGMgPT0gJ3gnID8gciA6IHIgJiAweDMgfCAweDgpLnRvU3RyaW5nKDE2KTsKICAgICAgICAgICAgfSk7CiAgICAgICAgfQogICAgfV0pOwoKICAgIHJldHVybiBNZXNzYWdlRmFjdG9yeTsKfSkoX3JlVEhJTktPYmplY3RSZXRoaW5rT2JqZWN0SnMyWydkZWZhdWx0J10pOwoKZXhwb3J0c1snZGVmYXVsdCddID0gTWVzc2FnZUZhY3Rvcnk7Cm1vZHVsZS5leHBvcnRzID0gZXhwb3J0c1snZGVmYXVsdCddOwoKfSx7Ii4uL3JlVEhJTktPYmplY3QvUmV0aGlua09iamVjdC5qcyI6MTcsIi4vTWVzc2FnZS5qcyI6MTQsIi4vTWVzc2FnZUJvZHkuanMiOjE1fV0sMTc6W2Z1bmN0aW9uKHJlcXVpcmUsbW9kdWxlLGV4cG9ydHMpewoidXNlIHN0cmljdCI7CgpPYmplY3QuZGVmaW5lUHJvcGVydHkoZXhwb3J0cywgIl9fZXNNb2R1bGUiLCB7CiAgICB2YWx1ZTogdHJ1ZQp9KTsKCnZhciBfY3JlYXRlQ2xhc3MgPSAoZnVuY3Rpb24gKCkgeyBmdW5jdGlvbiBkZWZpbmVQcm9wZXJ0aWVzKHRhcmdldCwgcHJvcHMpIHsgZm9yICh2YXIgaSA9IDA7IGkgPCBwcm9wcy5sZW5ndGg7IGkrKykgeyB2YXIgZGVzY3JpcHRvciA9IHByb3BzW2ldOyBkZXNjcmlwdG9yLmVudW1lcmFibGUgPSBkZXNjcmlwdG9yLmVudW1lcmFibGUgfHwgZmFsc2U7IGRlc2NyaXB0b3IuY29uZmlndXJhYmxlID0gdHJ1ZTsgaWYgKCJ2YWx1ZSIgaW4gZGVzY3JpcHRvcikgZGVzY3JpcHRvci53cml0YWJsZSA9IHRydWU7IE9iamVjdC5kZWZpbmVQcm9wZXJ0eSh0YXJnZXQsIGRlc2NyaXB0b3Iua2V5LCBkZXNjcmlwdG9yKTsgfSB9IHJldHVybiBmdW5jdGlvbiAoQ29uc3RydWN0b3IsIHByb3RvUHJvcHMsIHN0YXRpY1Byb3BzKSB7IGlmIChwcm90b1Byb3BzKSBkZWZpbmVQcm9wZXJ0aWVzKENvbnN0cnVjdG9yLnByb3RvdHlwZSwgcHJvdG9Qcm9wcyk7IGlmIChzdGF0aWNQcm9wcykgZGVmaW5lUHJvcGVydGllcyhDb25zdHJ1Y3Rvciwgc3RhdGljUHJvcHMpOyByZXR1cm4gQ29uc3RydWN0b3I7IH07IH0pKCk7CgpmdW5jdGlvbiBfaW50ZXJvcFJlcXVpcmVEZWZhdWx0KG9iaikgeyByZXR1cm4gb2JqICYmIG9iai5fX2VzTW9kdWxlID8gb2JqIDogeyAiZGVmYXVsdCI6IG9iaiB9OyB9CgpmdW5jdGlvbiBfY2xhc3NDYWxsQ2hlY2soaW5zdGFuY2UsIENvbnN0cnVjdG9yKSB7IGlmICghKGluc3RhbmNlIGluc3RhbmNlb2YgQ29uc3RydWN0b3IpKSB7IHRocm93IG5ldyBUeXBlRXJyb3IoIkNhbm5vdCBjYWxsIGEgY2xhc3MgYXMgYSBmdW5jdGlvbiIpOyB9IH0KCnZhciBfdHY0ID0gcmVxdWlyZSgidHY0Iik7Cgp2YXIgX3R2NDIgPSBfaW50ZXJvcFJlcXVpcmVEZWZhdWx0KF90djQpOwoKdmFyIFJldGhpbmtPYmplY3QgPSAoZnVuY3Rpb24gKCkgewogICAgZnVuY3Rpb24gUmV0aGlua09iamVjdCh2YWxpZGF0aW9uLCBzY2hlbWEpIHsKICAgICAgICBfY2xhc3NDYWxsQ2hlY2sodGhpcywgUmV0aGlua09iamVjdCk7CgogICAgICAgIHZhciBfdGhpcyA9IHRoaXM7CgogICAgICAgIHRoaXMudmFsaWRhdGlvbiA9IHZhbGlkYXRpb247CiAgICAgICAgdGhpcy5zY2hlbWEgPSBzY2hlbWE7CiAgICB9CgogICAgX2NyZWF0ZUNsYXNzKFJldGhpbmtPYmplY3QsIFt7CiAgICAgICAga2V5OiAidmFsaWRhdGUiLAogICAgICAgIHZhbHVlOiBmdW5jdGlvbiB2YWxpZGF0ZShkYXRhKSB7CiAgICAgICAgICAgIGlmICh0aGlzLnNjaGVtYSkgcmV0dXJuIF90djQyWyJkZWZhdWx0Il0udmFsaWRhdGUoZGF0YSwgdGhpcy5zY2hlbWEpO2Vsc2UgcmV0dXJuIGZhbHNlOwogICAgICAgIH0KICAgIH1dKTsKCiAgICByZXR1cm4gUmV0aGlua09iamVjdDsKfSkoKTsKCmV4cG9ydHMuUmV0aGlua09iamVjdCA9IFJldGhpbmtPYmplY3Q7CmV4cG9ydHNbImRlZmF1bHQiXSA9IFJldGhpbmtPYmplY3Q7Cgp9LHsidHY0IjoxfV0sMTg6W2Z1bmN0aW9uKHJlcXVpcmUsbW9kdWxlLGV4cG9ydHMpewovLyBpbXBvcnQgQWRkcmVzc0ZhY3RvcnkgZnJvbSAnLi9hZGRyZXNzLWZhY3RvcnkvdXJsJzsKJ3VzZSBzdHJpY3QnOwoKT2JqZWN0LmRlZmluZVByb3BlcnR5KGV4cG9ydHMsICdfX2VzTW9kdWxlJywgewogIHZhbHVlOiB0cnVlCn0pOwoKZnVuY3Rpb24gX2ludGVyb3BSZXF1aXJlRGVmYXVsdChvYmopIHsgcmV0dXJuIG9iaiAmJiBvYmouX19lc01vZHVsZSA/IG9iaiA6IHsgJ2RlZmF1bHQnOiBvYmogfTsgfQoKdmFyIF9jYXRhbG9ndWVGYWN0b3J5Q2F0YWxvZ3VlRGF0YU9iamVjdEZhY3RvcnkgPSByZXF1aXJlKCcuL2NhdGFsb2d1ZS1mYWN0b3J5L0NhdGFsb2d1ZURhdGFPYmplY3RGYWN0b3J5Jyk7Cgp2YXIgX2NhdGFsb2d1ZUZhY3RvcnlDYXRhbG9ndWVEYXRhT2JqZWN0RmFjdG9yeTIgPSBfaW50ZXJvcFJlcXVpcmVEZWZhdWx0KF9jYXRhbG9ndWVGYWN0b3J5Q2F0YWxvZ3VlRGF0YU9iamVjdEZhY3RvcnkpOwoKdmFyIF9tZXNzYWdlRmFjdG9yeU1lc3NhZ2VGYWN0b3J5ID0gcmVxdWlyZSgnLi9tZXNzYWdlLWZhY3RvcnkvTWVzc2FnZUZhY3RvcnknKTsKCnZhciBfbWVzc2FnZUZhY3RvcnlNZXNzYWdlRmFjdG9yeTIgPSBfaW50ZXJvcFJlcXVpcmVEZWZhdWx0KF9tZXNzYWdlRmFjdG9yeU1lc3NhZ2VGYWN0b3J5KTsKCnZhciBfc3luY2hlclN5bmNoZXIgPSByZXF1aXJlKCcuL3N5bmNoZXIvU3luY2hlcicpOwoKdmFyIF9zeW5jaGVyU3luY2hlcjIgPSBfaW50ZXJvcFJlcXVpcmVEZWZhdWx0KF9zeW5jaGVyU3luY2hlcik7Cgp2YXIgX3N5bmNoZXJEYXRhT2JqZWN0UmVwb3J0ZXIgPSByZXF1aXJlKCcuL3N5bmNoZXIvRGF0YU9iamVjdFJlcG9ydGVyJyk7Cgp2YXIgX3N5bmNoZXJEYXRhT2JqZWN0UmVwb3J0ZXIyID0gX2ludGVyb3BSZXF1aXJlRGVmYXVsdChfc3luY2hlckRhdGFPYmplY3RSZXBvcnRlcik7Cgp2YXIgX3N5bmNoZXJEYXRhT2JqZWN0T2JzZXJ2ZXIgPSByZXF1aXJlKCcuL3N5bmNoZXIvRGF0YU9iamVjdE9ic2VydmVyJyk7Cgp2YXIgX3N5bmNoZXJEYXRhT2JqZWN0T2JzZXJ2ZXIyID0gX2ludGVyb3BSZXF1aXJlRGVmYXVsdChfc3luY2hlckRhdGFPYmplY3RPYnNlcnZlcik7Cgp2YXIgX2h5cGVydHlIeXBlcnR5Q29ubmVjdG9yID0gcmVxdWlyZSgnLi9oeXBlcnR5L0h5cGVydHlDb25uZWN0b3InKTsKCnZhciBfaHlwZXJ0eUh5cGVydHlDb25uZWN0b3IyID0gX2ludGVyb3BSZXF1aXJlRGVmYXVsdChfaHlwZXJ0eUh5cGVydHlDb25uZWN0b3IpOwoKdmFyIF9jYXRhbG9ndWVGYWN0b3J5SHlwZXJ0eURlc2NyaXB0b3IgPSByZXF1aXJlKCcuL2NhdGFsb2d1ZS1mYWN0b3J5L0h5cGVydHlEZXNjcmlwdG9yJyk7Cgp2YXIgX2NhdGFsb2d1ZUZhY3RvcnlIeXBlcnR5RGVzY3JpcHRvcjIgPSBfaW50ZXJvcFJlcXVpcmVEZWZhdWx0KF9jYXRhbG9ndWVGYWN0b3J5SHlwZXJ0eURlc2NyaXB0b3IpOwoKdmFyIF9jYXRhbG9ndWVGYWN0b3J5UHJvdG9jb2xTdHViRGVzY3JpcHRvciA9IHJlcXVpcmUoJy4vY2F0YWxvZ3VlLWZhY3RvcnkvUHJvdG9jb2xTdHViRGVzY3JpcHRvcicpOwoKdmFyIF9jYXRhbG9ndWVGYWN0b3J5UHJvdG9jb2xTdHViRGVzY3JpcHRvcjIgPSBfaW50ZXJvcFJlcXVpcmVEZWZhdWx0KF9jYXRhbG9ndWVGYWN0b3J5UHJvdG9jb2xTdHViRGVzY3JpcHRvcik7Cgp2YXIgX2NhdGFsb2d1ZUZhY3RvcnlTb3VyY2VQYWNrYWdlID0gcmVxdWlyZSgnLi9jYXRhbG9ndWUtZmFjdG9yeS9Tb3VyY2VQYWNrYWdlJyk7Cgp2YXIgX2NhdGFsb2d1ZUZhY3RvcnlTb3VyY2VQYWNrYWdlMiA9IF9pbnRlcm9wUmVxdWlyZURlZmF1bHQoX2NhdGFsb2d1ZUZhY3RvcnlTb3VyY2VQYWNrYWdlKTsKCi8vIGV4cG9ydCB7QWRkcmVzc0ZhY3Rvcnl9OwpleHBvcnRzLkNhdGFsb2d1ZUZhY3RvcnkgPSBfY2F0YWxvZ3VlRmFjdG9yeUNhdGFsb2d1ZURhdGFPYmplY3RGYWN0b3J5MlsnZGVmYXVsdCddOwpleHBvcnRzLk1lc3NhZ2VGYWN0b3J5ID0gX21lc3NhZ2VGYWN0b3J5TWVzc2FnZUZhY3RvcnkyWydkZWZhdWx0J107CmV4cG9ydHMuU3luY2hlciA9IF9zeW5jaGVyU3luY2hlcjJbJ2RlZmF1bHQnXTsKZXhwb3J0cy5EYXRhT2JqZWN0UmVwb3J0ZXIgPSBfc3luY2hlckRhdGFPYmplY3RSZXBvcnRlcjJbJ2RlZmF1bHQnXTsKZXhwb3J0cy5EYXRhT2JqZWN0T2JzZXJ2ZXIgPSBfc3luY2hlckRhdGFPYmplY3RPYnNlcnZlcjJbJ2RlZmF1bHQnXTsKZXhwb3J0cy5IeXBlcnR5Q29ubmVjdG9yID0gX2h5cGVydHlIeXBlcnR5Q29ubmVjdG9yMlsnZGVmYXVsdCddOwpleHBvcnRzLkh5cGVydHlEZXNjcmlwdG9yID0gX2NhdGFsb2d1ZUZhY3RvcnlIeXBlcnR5RGVzY3JpcHRvcjJbJ2RlZmF1bHQnXTsKZXhwb3J0cy5Qcm90b2NvbFN0dWJEZXNjcmlwdG9yID0gX2NhdGFsb2d1ZUZhY3RvcnlQcm90b2NvbFN0dWJEZXNjcmlwdG9yMlsnZGVmYXVsdCddOwpleHBvcnRzLlNvdXJjZVBhY2thZ2UgPSBfY2F0YWxvZ3VlRmFjdG9yeVNvdXJjZVBhY2thZ2UyWydkZWZhdWx0J107Cgp9LHsiLi9jYXRhbG9ndWUtZmFjdG9yeS9DYXRhbG9ndWVEYXRhT2JqZWN0RmFjdG9yeSI6NSwiLi9jYXRhbG9ndWUtZmFjdG9yeS9IeXBlcnR5RGVzY3JpcHRvciI6NywiLi9jYXRhbG9ndWUtZmFjdG9yeS9Qcm90b2NvbFN0dWJEZXNjcmlwdG9yIjoxMCwiLi9jYXRhbG9ndWUtZmFjdG9yeS9Tb3VyY2VQYWNrYWdlIjoxMSwiLi9oeXBlcnR5L0h5cGVydHlDb25uZWN0b3IiOjEzLCIuL21lc3NhZ2UtZmFjdG9yeS9NZXNzYWdlRmFjdG9yeSI6MTYsIi4vc3luY2hlci9EYXRhT2JqZWN0T2JzZXJ2ZXIiOjE5LCIuL3N5bmNoZXIvRGF0YU9iamVjdFJlcG9ydGVyIjoyMCwiLi9zeW5jaGVyL1N5bmNoZXIiOjIyfV0sMTk6W2Z1bmN0aW9uKHJlcXVpcmUsbW9kdWxlLGV4cG9ydHMpewondXNlIHN0cmljdCc7CgpPYmplY3QuZGVmaW5lUHJvcGVydHkoZXhwb3J0cywgJ19fZXNNb2R1bGUnLCB7CiAgdmFsdWU6IHRydWUKfSk7Cgp2YXIgX2NyZWF0ZUNsYXNzID0gKGZ1bmN0aW9uICgpIHsgZnVuY3Rpb24gZGVmaW5lUHJvcGVydGllcyh0YXJnZXQsIHByb3BzKSB7IGZvciAodmFyIGkgPSAwOyBpIDwgcHJvcHMubGVuZ3RoOyBpKyspIHsgdmFyIGRlc2NyaXB0b3IgPSBwcm9wc1tpXTsgZGVzY3JpcHRvci5lbnVtZXJhYmxlID0gZGVzY3JpcHRvci5lbnVtZXJhYmxlIHx8IGZhbHNlOyBkZXNjcmlwdG9yLmNvbmZpZ3VyYWJsZSA9IHRydWU7IGlmICgndmFsdWUnIGluIGRlc2NyaXB0b3IpIGRlc2NyaXB0b3Iud3JpdGFibGUgPSB0cnVlOyBPYmplY3QuZGVmaW5lUHJvcGVydHkodGFyZ2V0LCBkZXNjcmlwdG9yLmtleSwgZGVzY3JpcHRvcik7IH0gfSByZXR1cm4gZnVuY3Rpb24gKENvbnN0cnVjdG9yLCBwcm90b1Byb3BzLCBzdGF0aWNQcm9wcykgeyBpZiAocHJvdG9Qcm9wcykgZGVmaW5lUHJvcGVydGllcyhDb25zdHJ1Y3Rvci5wcm90b3R5cGUsIHByb3RvUHJvcHMpOyBpZiAoc3RhdGljUHJvcHMpIGRlZmluZVByb3BlcnRpZXMoQ29uc3RydWN0b3IsIHN0YXRpY1Byb3BzKTsgcmV0dXJuIENvbnN0cnVjdG9yOyB9OyB9KSgpOwoKZnVuY3Rpb24gX2ludGVyb3BSZXF1aXJlRGVmYXVsdChvYmopIHsgcmV0dXJuIG9iaiAmJiBvYmouX19lc01vZHVsZSA/IG9iaiA6IHsgJ2RlZmF1bHQnOiBvYmogfTsgfQoKZnVuY3Rpb24gX2NsYXNzQ2FsbENoZWNrKGluc3RhbmNlLCBDb25zdHJ1Y3RvcikgeyBpZiAoIShpbnN0YW5jZSBpbnN0YW5jZW9mIENvbnN0cnVjdG9yKSkgeyB0aHJvdyBuZXcgVHlwZUVycm9yKCdDYW5ub3QgY2FsbCBhIGNsYXNzIGFzIGEgZnVuY3Rpb24nKTsgfSB9Cgp2YXIgX1N5bmNPYmplY3QgPSByZXF1aXJlKCcuL1N5bmNPYmplY3QnKTsKCnZhciBfU3luY09iamVjdDIgPSBfaW50ZXJvcFJlcXVpcmVEZWZhdWx0KF9TeW5jT2JqZWN0KTsKCnZhciBGaWx0ZXJUeXBlID0geyBBTlk6ICdhbnknLCBTVEFSVDogJ3N0YXJ0JywgRVhBQ1Q6ICdleGFjdCcgfTsKCnZhciBEYXRhT2JqZWN0T2JzZXJ2ZXIgLyogaW1wbGVtZW50cyBTeW5jU3RhdHVzICovID0gKGZ1bmN0aW9uICgpIHsKICAvKiBwcml2YXRlCiAgX3ZlcnNpb246IG51bWJlcgogIF9vd25lcjogSHlwZXJ0eVVSTAogICBfdXJsOiBPYmplY3RVUkwKICBfc2NoZW1hOiBTY2hlbWEKICBfc3RhdHVzOiBvbiB8IHBhdXNlZAogICBfc3luY09iajogU3luY0RhdGEKICAgLS0tLWV2ZW50IGhhbmRsZXJzLS0tLQogIF9maWx0ZXJzOiB7PGZpbHRlcj46IHt0eXBlOiA8c3RhcnQsIGV4YWN0PiwgY2FsbGJhY2s6IDxmdW5jdGlvbj59IH0KICAqLwoKICBmdW5jdGlvbiBEYXRhT2JqZWN0T2JzZXJ2ZXIob3duZXJVUkwsIG9iamVjdFVSTCwgc2NoZW1hLCBpbml0aWFsU3RhdHVzLCBpbml0aWFsRGF0YSkgewogICAgX2NsYXNzQ2FsbENoZWNrKHRoaXMsIERhdGFPYmplY3RPYnNlcnZlcik7CgogICAgdmFyIF90aGlzID0gdGhpczsKCiAgICBfdGhpcy5fdmVyc2lvbiA9IDA7CiAgICBfdGhpcy5fb3duZXIgPSBvd25lclVSTDsKICAgIF90aGlzLl91cmwgPSBvYmplY3RVUkw7CiAgICBfdGhpcy5fc2NoZW1hID0gc2NoZW1hOwoKICAgIF90aGlzLl9zdGF0dXMgPSBpbml0aWFsU3RhdHVzOwogICAgX3RoaXMuX3N5bmNPYmogPSBuZXcgX1N5bmNPYmplY3QyWydkZWZhdWx0J10oaW5pdGlhbERhdGEpOwogICAgX3RoaXMuX3N5bmNPYmoub2JzZXJ2ZShmdW5jdGlvbiAoZXZlbnQpIHsKICAgICAgX3RoaXMuX29uRmlsdGVyKGV2ZW50KTsKICAgIH0pOwoKICAgIF90aGlzLl9maWx0ZXJzID0ge307CiAgfQoKICBfY3JlYXRlQ2xhc3MoRGF0YU9iamVjdE9ic2VydmVyLCBbewogICAga2V5OiAncGF1c2UnLAogICAgdmFsdWU6IGZ1bmN0aW9uIHBhdXNlKCkgewogICAgICAvL1RPRE86IHRoaXMgZmVhdHVyZSBuZWVkcyBtb3JlIGFuYWxpc2UKICAgICAgdGhyb3cgJ05vdCBpbXBsZW1lbnRlZCc7CiAgICB9CiAgfSwgewogICAga2V5OiAncmVzdW1lJywKICAgIHZhbHVlOiBmdW5jdGlvbiByZXN1bWUoKSB7CiAgICAgIC8vVE9ETzogdGhpcyBmZWF0dXJlIG5lZWRzIG1vcmUgYW5hbGlzZQogICAgICB0aHJvdyAnTm90IGltcGxlbWVudGVkJzsKICAgIH0KICB9LCB7CiAgICBrZXk6ICdzdG9wJywKICAgIHZhbHVlOiBmdW5jdGlvbiBzdG9wKCkgewogICAgICAvL1RPRE86IHNob3VsZCByZW1vdmUgdGhlIHN1YnNjcmlwdGlvbiBhbmQgc2VuZCBtZXNzYWdlIHVuc3Vic2NyaWJlPwogICAgICB0aHJvdyAnTm90IGltcGxlbWVudGVkJzsKICAgIH0KCiAgICAvL3JlZ2lzdGVyIGNoYW5nZSBmaWx0ZXIKICB9LCB7CiAgICBrZXk6ICdvbkNoYW5nZScsCiAgICB2YWx1ZTogZnVuY3Rpb24gb25DaGFuZ2UoZmlsdGVyLCBjYWxsYmFjaykgewogICAgICB2YXIga2V5ID0gZmlsdGVyOwogICAgICB2YXIgZmlsdGVyT2JqID0gewogICAgICAgIHR5cGU6IEZpbHRlclR5cGUuRVhBQ1QsCiAgICAgICAgY2FsbGJhY2s6IGNhbGxiYWNrCiAgICAgIH07CgogICAgICB2YXIgaWR4ID0gZmlsdGVyLmluZGV4T2YoJyonKTsKICAgICAgaWYgKGlkeCA9PT0gZmlsdGVyLmxlbmd0aCAtIDEpIHsKICAgICAgICBpZiAoaWR4ID09PSAwKSB7CiAgICAgICAgICBmaWx0ZXJPYmoudHlwZSA9IEZpbHRlclR5cGUuQU5ZOwogICAgICAgIH0gZWxzZSB7CiAgICAgICAgICBmaWx0ZXJPYmoudHlwZSA9IEZpbHRlclR5cGUuU1RBUlQ7CiAgICAgICAgICBrZXkgPSBmaWx0ZXIuc3Vic3RyKDAsIGZpbHRlci5sZW5ndGggLSAxKTsKICAgICAgICB9CiAgICAgIH0KCiAgICAgIHRoaXMuX2ZpbHRlcnNba2V5XSA9IGZpbHRlck9iajsKICAgIH0KCiAgICAvL2ZpbHRlciBjaGFuZ2VzCiAgfSwgewogICAga2V5OiAnX29uRmlsdGVyJywKICAgIHZhbHVlOiBmdW5jdGlvbiBfb25GaWx0ZXIoZXZlbnQpIHsKICAgICAgdmFyIF90aGlzID0gdGhpczsKCiAgICAgIE9iamVjdC5rZXlzKF90aGlzLl9maWx0ZXJzKS5mb3JFYWNoKGZ1bmN0aW9uIChrZXkpIHsKICAgICAgICB2YXIgZmlsdGVyID0gX3RoaXMuX2ZpbHRlcnNba2V5XTsKICAgICAgICBpZiAoZmlsdGVyLnR5cGUgPT09IEZpbHRlclR5cGUuQU5ZKSB7CiAgICAgICAgICAvL21hdGNoIGFueXRoaW5nCiAgICAgICAgICBmaWx0ZXIuY2FsbGJhY2soZXZlbnQpOwogICAgICAgIH0gZWxzZSBpZiAoZmlsdGVyLnR5cGUgPT09IEZpbHRlclR5cGUuU1RBUlQpIHsKICAgICAgICAgIC8vaWYgc3RhcnRzIHdpdGggZmlsdGVyLi4uCiAgICAgICAgICBpZiAoZXZlbnQuZmllbGQuaW5kZXhPZihrZXkpID09PSAwKSB7CiAgICAgICAgICAgIGZpbHRlci5jYWxsYmFjayhldmVudCk7CiAgICAgICAgICB9CiAgICAgICAgfSBlbHNlIGlmIChmaWx0ZXIudHlwZSA9PT0gRmlsdGVyVHlwZS5FWEFDVCkgewogICAgICAgICAgLy9leGFjdCBtYXRjaAogICAgICAgICAgaWYgKGV2ZW50LmZpZWxkID09PSBrZXkpIHsKICAgICAgICAgICAgZmlsdGVyLmNhbGxiYWNrKGV2ZW50KTsKICAgICAgICAgIH0KICAgICAgICB9CiAgICAgIH0pOwogICAgfQoKICAgIC8vcmVjZWl2ZSBhbmQgcHJvY2VzcyBjaGFuZ2UgbWVzc2FnZXMKICB9LCB7CiAgICBrZXk6ICdfY2hhbmdlT2JqZWN0JywKICAgIHZhbHVlOiBmdW5jdGlvbiBfY2hhbmdlT2JqZWN0KG1zZykgewogICAgICB2YXIgX3RoaXMgPSB0aGlzOwoKICAgICAgLy9UT0RPOiB1cGRhdGUgdmVyc2lvbiA/CiAgICAgIC8vaG93IHRvIGhhbmRsZSBhbiBpbmNvcnJlY3QgdmVyc2lvbiA/IEV4YW1wbGU6IHJlY2VpdmUgYSB2ZXJzaW9uIDMgd2hlbiB0aGUgb2JzZXJ2ZXIgaXMgaW4gdmVyc2lvbiAxLCB3aGVyZSBpcyB0aGUgdmVyc2lvbiAyID8KICAgICAgLy93aWxsIHdlIG5lZWQgdG8gY29uZmlybSB0aGUgcmVjZXB0aW9uID8KICAgICAgaWYgKF90aGlzLl92ZXJzaW9uICsgMSA9PT0gbXNnLmJvZHkudmVyc2lvbikgewogICAgICAgIF90aGlzLl92ZXJzaW9uKys7CiAgICAgICAgdmFyIHBhdGggPSBtc2cuYm9keS5hdHRyaWI7CiAgICAgICAgdmFyIHZhbHVlID0gbXNnLmJvZHkudmFsdWU7CiAgICAgICAgdmFyIGZpbmRSZXN1bHQgPSBfdGhpcy5fc3luY09iai5maW5kQmVmb3JlKHBhdGgpOwoKICAgICAgICBpZiAobXNnLnR5cGUgPT09IF9TeW5jT2JqZWN0LkNoYW5nZVR5cGUuVVBEQVRFKSB7CiAgICAgICAgICBmaW5kUmVzdWx0Lm9ialtmaW5kUmVzdWx0Lmxhc3RdID0gdmFsdWU7CiAgICAgICAgfSBlbHNlIHsKICAgICAgICAgIGlmIChtc2cudHlwZSA9PT0gX1N5bmNPYmplY3QuQ2hhbmdlVHlwZS5BREQpIHsKICAgICAgICAgICAgaWYgKG1zZy5ib2R5Lm9UeXBlID09PSBfU3luY09iamVjdC5PYmplY3RUeXBlLk9CSkVDVCkgewogICAgICAgICAgICAgIGZpbmRSZXN1bHQub2JqW2ZpbmRSZXN1bHQubGFzdF0gPSB2YWx1ZTsKICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAvL0FSUkFZCiAgICAgICAgICAgICAgdmFyIGFyciA9IGZpbmRSZXN1bHQub2JqOwogICAgICAgICAgICAgIHZhciBpbmRleCA9IGZpbmRSZXN1bHQubGFzdDsKICAgICAgICAgICAgICBBcnJheS5wcm90b3R5cGUuc3BsaWNlLmFwcGx5KGFyciwgW2luZGV4LCAwXS5jb25jYXQodmFsdWUpKTsKICAgICAgICAgICAgfQogICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgLy9SRU1PVkUKICAgICAgICAgICAgaWYgKG1zZy5ib2R5Lm9UeXBlID09PSBfU3luY09iamVjdC5PYmplY3RUeXBlLk9CSkVDVCkgewogICAgICAgICAgICAgIGRlbGV0ZSBmaW5kUmVzdWx0Lm9ialtmaW5kUmVzdWx0Lmxhc3RdOwogICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgIC8vQVJSQVkKICAgICAgICAgICAgICB2YXIgYXJyID0gZmluZFJlc3VsdC5vYmo7CiAgICAgICAgICAgICAgdmFyIGluZGV4ID0gZmluZFJlc3VsdC5sYXN0OwogICAgICAgICAgICAgIGFyci5zcGxpY2UoaW5kZXgsIHZhbHVlKTsKICAgICAgICAgICAgfQogICAgICAgICAgfQogICAgICAgIH0KICAgICAgfSBlbHNlIHsKICAgICAgICAvL1RPRE86IGhvdyB0byBoYW5kbGUgdW5zeW5jaHJvbml6ZWQgdmVyc2lvbnM/CiAgICAgICAgY29uc29sZS5sb2coJ3Vuc3luY2hyb25pemVkIHZlcnNpb25zJyk7CiAgICAgIH0KICAgIH0KICB9LCB7CiAgICBrZXk6ICd2ZXJzaW9uJywKICAgIGdldDogZnVuY3Rpb24gZ2V0KCkgewogICAgICByZXR1cm4gdGhpcy5fdmVyc2lvbjsKICAgIH0KICB9LCB7CiAgICBrZXk6ICdvd25lcicsCiAgICBnZXQ6IGZ1bmN0aW9uIGdldCgpIHsKICAgICAgcmV0dXJuIHRoaXMuX293bmVyOwogICAgfQogIH0sIHsKICAgIGtleTogJ3VybCcsCiAgICBnZXQ6IGZ1bmN0aW9uIGdldCgpIHsKICAgICAgcmV0dXJuIHRoaXMuX3VybDsKICAgIH0KICB9LCB7CiAgICBrZXk6ICdzY2hlbWEnLAogICAgZ2V0OiBmdW5jdGlvbiBnZXQoKSB7CiAgICAgIHJldHVybiB0aGlzLl9zY2hlbWE7CiAgICB9CiAgfSwgewogICAga2V5OiAnc3RhdHVzJywKICAgIGdldDogZnVuY3Rpb24gZ2V0KCkgewogICAgICByZXR1cm4gdGhpcy5fc3RhdHVzOwogICAgfQogIH0sIHsKICAgIGtleTogJ2RhdGEnLAogICAgZ2V0OiBmdW5jdGlvbiBnZXQoKSB7CiAgICAgIHJldHVybiB0aGlzLl9zeW5jT2JqLmRhdGE7CiAgICB9CiAgfV0pOwoKICByZXR1cm4gRGF0YU9iamVjdE9ic2VydmVyOwp9KSgpOwoKZXhwb3J0c1snZGVmYXVsdCddID0gRGF0YU9iamVjdE9ic2VydmVyOwptb2R1bGUuZXhwb3J0cyA9IGV4cG9ydHNbJ2RlZmF1bHQnXTsKCn0seyIuL1N5bmNPYmplY3QiOjIxfV0sMjA6W2Z1bmN0aW9uKHJlcXVpcmUsbW9kdWxlLGV4cG9ydHMpewondXNlIHN0cmljdCc7CgpPYmplY3QuZGVmaW5lUHJvcGVydHkoZXhwb3J0cywgJ19fZXNNb2R1bGUnLCB7CiAgdmFsdWU6IHRydWUKfSk7Cgp2YXIgX2NyZWF0ZUNsYXNzID0gKGZ1bmN0aW9uICgpIHsgZnVuY3Rpb24gZGVmaW5lUHJvcGVydGllcyh0YXJnZXQsIHByb3BzKSB7IGZvciAodmFyIGkgPSAwOyBpIDwgcHJvcHMubGVuZ3RoOyBpKyspIHsgdmFyIGRlc2NyaXB0b3IgPSBwcm9wc1tpXTsgZGVzY3JpcHRvci5lbnVtZXJhYmxlID0gZGVzY3JpcHRvci5lbnVtZXJhYmxlIHx8IGZhbHNlOyBkZXNjcmlwdG9yLmNvbmZpZ3VyYWJsZSA9IHRydWU7IGlmICgndmFsdWUnIGluIGRlc2NyaXB0b3IpIGRlc2NyaXB0b3Iud3JpdGFibGUgPSB0cnVlOyBPYmplY3QuZGVmaW5lUHJvcGVydHkodGFyZ2V0LCBkZXNjcmlwdG9yLmtleSwgZGVzY3JpcHRvcik7IH0gfSByZXR1cm4gZnVuY3Rpb24gKENvbnN0cnVjdG9yLCBwcm90b1Byb3BzLCBzdGF0aWNQcm9wcykgeyBpZiAocHJvdG9Qcm9wcykgZGVmaW5lUHJvcGVydGllcyhDb25zdHJ1Y3Rvci5wcm90b3R5cGUsIHByb3RvUHJvcHMpOyBpZiAoc3RhdGljUHJvcHMpIGRlZmluZVByb3BlcnRpZXMoQ29uc3RydWN0b3IsIHN0YXRpY1Byb3BzKTsgcmV0dXJuIENvbnN0cnVjdG9yOyB9OyB9KSgpOwoKZnVuY3Rpb24gX2ludGVyb3BSZXF1aXJlRGVmYXVsdChvYmopIHsgcmV0dXJuIG9iaiAmJiBvYmouX19lc01vZHVsZSA/IG9iaiA6IHsgJ2RlZmF1bHQnOiBvYmogfTsgfQoKZnVuY3Rpb24gX2NsYXNzQ2FsbENoZWNrKGluc3RhbmNlLCBDb25zdHJ1Y3RvcikgeyBpZiAoIShpbnN0YW5jZSBpbnN0YW5jZW9mIENvbnN0cnVjdG9yKSkgeyB0aHJvdyBuZXcgVHlwZUVycm9yKCdDYW5ub3QgY2FsbCBhIGNsYXNzIGFzIGEgZnVuY3Rpb24nKTsgfSB9Cgp2YXIgX1N5bmNPYmplY3QgPSByZXF1aXJlKCcuL1N5bmNPYmplY3QnKTsKCnZhciBfU3luY09iamVjdDIgPSBfaW50ZXJvcFJlcXVpcmVEZWZhdWx0KF9TeW5jT2JqZWN0KTsKCnZhciBfdXRpbHNVdGlsc0pzID0gcmVxdWlyZSgnLi4vdXRpbHMvdXRpbHMuanMnKTsKCnZhciBEYXRhT2JqZWN0UmVwb3J0ZXIgLyogaW1wbGVtZW50cyBTeW5jU3RhdHVzICovID0gKGZ1bmN0aW9uICgpIHsKICAvKiBwcml2YXRlCiAgX3ZlcnNpb246IG51bWJlcgogICBfdXJsOiBPYmplY3RVUkwKICBfc2NoZW1hOiBTY2hlbWEKICBfYnVzOiBNaW5pQnVzCiAgX3N0YXR1czogb24gfCBwYXVzZWQKICAgX3N5bmNPYmo6IFN5bmNEYXRhCiAgX3N1YnNjcmlwdGlvbnM6IDxoeXBlcnR5VXJsOiB7IHN0YXR1czogc3RyaW5nIH0gfT4KICAgLS0tLWV2ZW50IGhhbmRsZXJzLS0tLQogIF9vblN1YnNjcmlwdGlvbkhhbmRsZXI6IChldmVudCkgPT4gdm9pZAogICovCgogIGZ1bmN0aW9uIERhdGFPYmplY3RSZXBvcnRlcihvd25lciwgdXJsLCBzY2hlbWEsIGJ1cywgaW5pdGlhbFN0YXR1cywgaW5pdGlhbERhdGEpIHsKICAgIF9jbGFzc0NhbGxDaGVjayh0aGlzLCBEYXRhT2JqZWN0UmVwb3J0ZXIpOwoKICAgIHZhciBfdGhpcyA9IHRoaXM7CgogICAgX3RoaXMuX3ZlcnNpb24gPSAwOwogICAgX3RoaXMuX293bmVyID0gb3duZXI7CiAgICBfdGhpcy5fdXJsID0gdXJsOwogICAgX3RoaXMuX3NjaGVtYSA9IHNjaGVtYTsKICAgIF90aGlzLl9idXMgPSBidXM7CgogICAgX3RoaXMuX3N1YnNjcmlwdGlvbnMgPSB7fTsKCiAgICBfdGhpcy5fc3RhdHVzID0gaW5pdGlhbFN0YXR1czsKICAgIF90aGlzLl9zeW5jT2JqID0gbmV3IF9TeW5jT2JqZWN0MlsnZGVmYXVsdCddKGluaXRpYWxEYXRhKTsKICAgIF90aGlzLl9zeW5jT2JqLm9ic2VydmUoZnVuY3Rpb24gKGV2ZW50KSB7CiAgICAgIF90aGlzLl9vbkNoYW5nZShldmVudCk7CiAgICB9KTsKICB9CgogIF9jcmVhdGVDbGFzcyhEYXRhT2JqZWN0UmVwb3J0ZXIsIFt7CiAgICBrZXk6ICdwYXVzZScsCiAgICB2YWx1ZTogZnVuY3Rpb24gcGF1c2UoKSB7CiAgICAgIC8vVE9ETzogcGF1c2UgY2hhbmdlIHJlcG9ydHM/CiAgICB9CiAgfSwgewogICAga2V5OiAncmVzdW1lJywKICAgIHZhbHVlOiBmdW5jdGlvbiByZXN1bWUoKSB7CiAgICAgIC8vVE9ETzogcmVzdW1lIGNoYW5nZSByZXBvcnRzPwogICAgfQogIH0sIHsKICAgIGtleTogJ3N0b3AnLAogICAgdmFsdWU6IGZ1bmN0aW9uIHN0b3AoKSB7CiAgICAgIC8vVE9ETzogZGVzdHJveSByZXBvcnRlcj8KICAgIH0KICB9LCB7CiAgICBrZXk6ICdvblN1YnNjcmlwdGlvbicsCiAgICB2YWx1ZTogZnVuY3Rpb24gb25TdWJzY3JpcHRpb24oY2FsbGJhY2spIHsKICAgICAgdGhpcy5fb25TdWJzY3JpcHRpb25IYW5kbGVyID0gY2FsbGJhY2s7CiAgICB9CiAgfSwgewogICAga2V5OiAnX29uRm9yd2FyZCcsCiAgICB2YWx1ZTogZnVuY3Rpb24gX29uRm9yd2FyZChtc2cpIHsKICAgICAgdmFyIF90aGlzID0gdGhpczsKCiAgICAgIGNvbnNvbGUubG9nKCdEYXRhT2JqZWN0UmVwb3J0ZXItUkNWOiAnLCBtc2cpOwogICAgICBzd2l0Y2ggKG1zZy5ib2R5LnR5cGUpIHsKICAgICAgICBjYXNlICdzdWJzY3JpYmUnOgogICAgICAgICAgX3RoaXMuX29uU3Vic2NyaWJlKG1zZyk7YnJlYWs7CiAgICAgICAgY2FzZSAndW5zdWJzY3JpYmUnOgogICAgICAgICAgX3RoaXMuX29uVW5TdWJzY3JpYmUobXNnKTticmVhazsKICAgICAgfQogICAgfQogIH0sIHsKICAgIGtleTogJ19vblN1YnNjcmliZScsCiAgICB2YWx1ZTogZnVuY3Rpb24gX29uU3Vic2NyaWJlKG1zZykgewogICAgICB2YXIgX3RoaXMgPSB0aGlzOwogICAgICB2YXIgaHlwZXJ0eVVybCA9IG1zZy5ib2R5LmZyb207CgogICAgICB2YXIgZXZlbnQgPSB7CiAgICAgICAgdHlwZTogbXNnLmJvZHkudHlwZSwKICAgICAgICB1cmw6IGh5cGVydHlVcmwsCgogICAgICAgIGFjY2VwdDogZnVuY3Rpb24gYWNjZXB0KCkgewogICAgICAgICAgLy9jcmVhdGUgbmV3IHN1YnNjcmlwdGlvbgogICAgICAgICAgX3RoaXMuX3N1YnNjcmlwdGlvbnNbaHlwZXJ0eVVybF0gPSB7IHN0YXR1czogJ29uJyB9OwoKICAgICAgICAgIC8vc2VuZCBvayByZXNwb25zZSBtZXNzYWdlCiAgICAgICAgICBfdGhpcy5fYnVzLnBvc3RNZXNzYWdlKHsKICAgICAgICAgICAgaWQ6IG1zZy5pZCwgdHlwZTogJ3Jlc3BvbnNlJywgZnJvbTogbXNnLnRvLCB0bzogbXNnLmZyb20sCiAgICAgICAgICAgIGJvZHk6IHsgY29kZTogMjAwLCBzY2hlbWE6IF90aGlzLl9zY2hlbWEsIHZlcnNpb246IF90aGlzLl92ZXJzaW9uLCB2YWx1ZTogKDAsIF91dGlsc1V0aWxzSnMuZGVlcENsb25lKShfdGhpcy5kYXRhKSB9CiAgICAgICAgICB9KTsKICAgICAgICB9LAoKICAgICAgICByZWplY3Q6IGZ1bmN0aW9uIHJlamVjdChyZWFzb24pIHsKICAgICAgICAgIC8vc2VuZCByZWplY3QgcmVzcG9uc2UgbWVzc2FnZQogICAgICAgICAgX3RoaXMuX2J1cy5wb3N0TWVzc2FnZSh7CiAgICAgICAgICAgIGlkOiBtc2cuaWQsIHR5cGU6ICdyZXNwb25zZScsIGZyb206IG1zZy50bywgdG86IG1zZy5mcm9tLAogICAgICAgICAgICBib2R5OiB7IGNvZGU6IDQwMywgZGVzYzogcmVhc29uIH0KICAgICAgICAgIH0pOwogICAgICAgIH0KICAgICAgfTsKCiAgICAgIGlmIChfdGhpcy5fb25TdWJzY3JpcHRpb25IYW5kbGVyKSB7CiAgICAgICAgX3RoaXMuX29uU3Vic2NyaXB0aW9uSGFuZGxlcihldmVudCk7CiAgICAgIH0KICAgIH0KICB9LCB7CiAgICBrZXk6ICdfb25VblN1YnNjcmliZScsCiAgICB2YWx1ZTogZnVuY3Rpb24gX29uVW5TdWJzY3JpYmUobXNnKSB7CiAgICAgIHZhciBfdGhpcyA9IHRoaXM7CiAgICAgIHZhciBoeXBlcnR5VXJsID0gbXNnLmJvZHkuZnJvbTsKCiAgICAgIHZhciBzdWIgPSBfdGhpcy5fc3Vic2NyaXB0aW9uc1toeXBlcnR5VXJsXTsKICAgICAgZGVsZXRlIF90aGlzLl9zdWJzY3JpcHRpb25zW2h5cGVydHlVcmxdOwoKICAgICAgdmFyIGV2ZW50ID0gewogICAgICAgIHR5cGU6IG1zZy5ib2R5LnR5cGUsCiAgICAgICAgdXJsOiBoeXBlcnR5VXJsLAogICAgICAgIG9iamVjdDogc3ViCiAgICAgIH07CgogICAgICBpZiAoX3RoaXMuX29uU3Vic2NyaXB0aW9uSGFuZGxlcikgewogICAgICAgIF90aGlzLl9vblN1YnNjcmlwdGlvbkhhbmRsZXIoZXZlbnQpOwogICAgICB9CiAgICB9CgogICAgLy9zZW5kIGRlbHRhIG1lc3NhZ2VzIHRvIHN1YnNjcmlwdGlvbnMKICB9LCB7CiAgICBrZXk6ICdfb25DaGFuZ2UnLAogICAgdmFsdWU6IGZ1bmN0aW9uIF9vbkNoYW5nZShldmVudCkgewogICAgICB2YXIgX3RoaXMgPSB0aGlzOwoKICAgICAgX3RoaXMuX3ZlcnNpb24rKzsKCiAgICAgIGlmIChfdGhpcy5fc3RhdHVzID09PSAnb24nKSB7CiAgICAgICAgX3RoaXMuX2J1cy5wb3N0TWVzc2FnZSh7CiAgICAgICAgICB0eXBlOiBldmVudC5jVHlwZSwgZnJvbTogX3RoaXMuX293bmVyLCB0bzogX3RoaXMuX3VybCwKICAgICAgICAgIGJvZHk6IHsgdmVyc2lvbjogX3RoaXMuX3ZlcnNpb24sIG9UeXBlOiBldmVudC5vVHlwZSwgYXR0cmliOiBldmVudC5maWVsZCwgdmFsdWU6IGV2ZW50LmRhdGEgfQogICAgICAgIH0pOwogICAgICB9CiAgICB9CiAgfSwgewogICAga2V5OiAndmVyc2lvbicsCiAgICBnZXQ6IGZ1bmN0aW9uIGdldCgpIHsKICAgICAgcmV0dXJuIHRoaXMuX3ZlcnNpb247CiAgICB9CiAgfSwgewogICAga2V5OiAndXJsJywKICAgIGdldDogZnVuY3Rpb24gZ2V0KCkgewogICAgICByZXR1cm4gdGhpcy5fdXJsOwogICAgfQogIH0sIHsKICAgIGtleTogJ3NjaGVtYScsCiAgICBnZXQ6IGZ1bmN0aW9uIGdldCgpIHsKICAgICAgcmV0dXJuIHRoaXMuX3NjaGVtYTsKICAgIH0KICB9LCB7CiAgICBrZXk6ICdzdGF0dXMnLAogICAgZ2V0OiBmdW5jdGlvbiBnZXQoKSB7CiAgICAgIHJldHVybiB0aGlzLl9zdGF0dXM7CiAgICB9CiAgfSwgewogICAga2V5OiAnZGF0YScsCiAgICBnZXQ6IGZ1bmN0aW9uIGdldCgpIHsKICAgICAgcmV0dXJuIHRoaXMuX3N5bmNPYmouZGF0YTsKICAgIH0KICB9LCB7CiAgICBrZXk6ICdzdWJzY3JpcHRpb25zJywKICAgIGdldDogZnVuY3Rpb24gZ2V0KCkgewogICAgICByZXR1cm4gdGhpcy5fc3Vic2NyaXB0aW9uczsKICAgIH0KICB9XSk7CgogIHJldHVybiBEYXRhT2JqZWN0UmVwb3J0ZXI7Cn0pKCk7CgpleHBvcnRzWydkZWZhdWx0J10gPSBEYXRhT2JqZWN0UmVwb3J0ZXI7Cm1vZHVsZS5leHBvcnRzID0gZXhwb3J0c1snZGVmYXVsdCddOwoKfSx7Ii4uL3V0aWxzL3V0aWxzLmpzIjoyNCwiLi9TeW5jT2JqZWN0IjoyMX1dLDIxOltmdW5jdGlvbihyZXF1aXJlLG1vZHVsZSxleHBvcnRzKXsKJ3VzZSBzdHJpY3QnOwoKT2JqZWN0LmRlZmluZVByb3BlcnR5KGV4cG9ydHMsICdfX2VzTW9kdWxlJywgewogIHZhbHVlOiB0cnVlCn0pOwoKdmFyIF9jcmVhdGVDbGFzcyA9IChmdW5jdGlvbiAoKSB7IGZ1bmN0aW9uIGRlZmluZVByb3BlcnRpZXModGFyZ2V0LCBwcm9wcykgeyBmb3IgKHZhciBpID0gMDsgaSA8IHByb3BzLmxlbmd0aDsgaSsrKSB7IHZhciBkZXNjcmlwdG9yID0gcHJvcHNbaV07IGRlc2NyaXB0b3IuZW51bWVyYWJsZSA9IGRlc2NyaXB0b3IuZW51bWVyYWJsZSB8fCBmYWxzZTsgZGVzY3JpcHRvci5jb25maWd1cmFibGUgPSB0cnVlOyBpZiAoJ3ZhbHVlJyBpbiBkZXNjcmlwdG9yKSBkZXNjcmlwdG9yLndyaXRhYmxlID0gdHJ1ZTsgT2JqZWN0LmRlZmluZVByb3BlcnR5KHRhcmdldCwgZGVzY3JpcHRvci5rZXksIGRlc2NyaXB0b3IpOyB9IH0gcmV0dXJuIGZ1bmN0aW9uIChDb25zdHJ1Y3RvciwgcHJvdG9Qcm9wcywgc3RhdGljUHJvcHMpIHsgaWYgKHByb3RvUHJvcHMpIGRlZmluZVByb3BlcnRpZXMoQ29uc3RydWN0b3IucHJvdG90eXBlLCBwcm90b1Byb3BzKTsgaWYgKHN0YXRpY1Byb3BzKSBkZWZpbmVQcm9wZXJ0aWVzKENvbnN0cnVjdG9yLCBzdGF0aWNQcm9wcyk7IHJldHVybiBDb25zdHJ1Y3RvcjsgfTsgfSkoKTsKCmZ1bmN0aW9uIF9jbGFzc0NhbGxDaGVjayhpbnN0YW5jZSwgQ29uc3RydWN0b3IpIHsgaWYgKCEoaW5zdGFuY2UgaW5zdGFuY2VvZiBDb25zdHJ1Y3RvcikpIHsgdGhyb3cgbmV3IFR5cGVFcnJvcignQ2Fubm90IGNhbGwgYSBjbGFzcyBhcyBhIGZ1bmN0aW9uJyk7IH0gfQoKdmFyIF91dGlsc1V0aWxzSnMgPSByZXF1aXJlKCcuLi91dGlscy91dGlscy5qcycpOwoKdmFyIFN5bmNPYmplY3QgPSAoZnVuY3Rpb24gKCkgewogIC8qIHByaXZhdGUKICAgIF9kYXRhOiBhbnk7CiAgICBfb2JzZXJ2ZXJzOiAoKGV2ZW50OiBDaGFuZ2VFdmVudCkgPT4gdm9pZClbXQogICovCgogIGZ1bmN0aW9uIFN5bmNPYmplY3QoaW5pdGlhbERhdGEpIHsKICAgIF9jbGFzc0NhbGxDaGVjayh0aGlzLCBTeW5jT2JqZWN0KTsKCiAgICB2YXIgX3RoaXMgPSB0aGlzOwoKICAgIF90aGlzLl9vYnNlcnZlcnMgPSBbXTsKICAgIF90aGlzLl9maWx0ZXJzID0ge307CgogICAgaWYgKGluaXRpYWxEYXRhKSB7CiAgICAgIF90aGlzLl9kYXRhID0gaW5pdGlhbERhdGE7CiAgICB9IGVsc2UgewogICAgICBfdGhpcy5fZGF0YSA9IHt9OwogICAgfQoKICAgIF90aGlzLl9pbnRlcm5hbE9ic2VydmUobmV3IFBhdGgoKSwgX3RoaXMuX2RhdGEpOwogIH0KCiAgLy9keW5hbWljIHBhdGggZm9yIEFycmF5IGluZGV4Li4uCgogIF9jcmVhdGVDbGFzcyhTeW5jT2JqZWN0LCBbewogICAga2V5OiAnb2JzZXJ2ZScsCiAgICB2YWx1ZTogZnVuY3Rpb24gb2JzZXJ2ZShjYWxsYmFjaykgewogICAgICB0aGlzLl9vYnNlcnZlcnMucHVzaChjYWxsYmFjayk7CiAgICB9CiAgfSwgewogICAga2V5OiAnZmluZCcsCiAgICB2YWx1ZTogZnVuY3Rpb24gZmluZChwYXRoKSB7CiAgICAgIHZhciBsaXN0ID0gcGF0aC5zcGxpdCgnLicpOwoKICAgICAgcmV0dXJuIHRoaXMuX2ZpbmRXaXRoU3BsaXQobGlzdCk7CiAgICB9CiAgfSwgewogICAga2V5OiAnZmluZEJlZm9yZScsCiAgICB2YWx1ZTogZnVuY3Rpb24gZmluZEJlZm9yZShwYXRoKSB7CiAgICAgIHZhciByZXN1bHQgPSB7fTsKICAgICAgdmFyIGxpc3QgPSBwYXRoLnNwbGl0KCcuJyk7CiAgICAgIHJlc3VsdC5sYXN0ID0gbGlzdC5wb3AoKTsKICAgICAgcmVzdWx0Lm9iaiA9IHRoaXMuX2ZpbmRXaXRoU3BsaXQobGlzdCk7CgogICAgICByZXR1cm4gcmVzdWx0OwogICAgfQogIH0sIHsKICAgIGtleTogJ19maW5kV2l0aFNwbGl0JywKICAgIHZhbHVlOiBmdW5jdGlvbiBfZmluZFdpdGhTcGxpdChsaXN0KSB7CiAgICAgIHZhciBvYmogPSB0aGlzLl9kYXRhOwogICAgICBsaXN0LmZvckVhY2goZnVuY3Rpb24gKHZhbHVlKSB7CiAgICAgICAgb2JqID0gb2JqW3ZhbHVlXTsKICAgICAgfSk7CgogICAgICByZXR1cm4gb2JqOwogICAgfQogIH0sIHsKICAgIGtleTogJ19maXJlRXZlbnQnLAogICAgdmFsdWU6IGZ1bmN0aW9uIF9maXJlRXZlbnQoZXZlbnQpIHsKICAgICAgdGhpcy5fb2JzZXJ2ZXJzLmZvckVhY2goZnVuY3Rpb24gKGNhbGxiYWNrKSB7CiAgICAgICAgY2FsbGJhY2soZXZlbnQpOwogICAgICB9KTsKICAgIH0KICB9LCB7CiAgICBrZXk6ICdfaXNPYnNlcnZhYmxlJywKICAgIHZhbHVlOiBmdW5jdGlvbiBfaXNPYnNlcnZhYmxlKG9iaikgewogICAgICBpZiAob2JqLmNvbnN0cnVjdG9yID09PSBPYmplY3QgfHwgb2JqLmNvbnN0cnVjdG9yID09PSBBcnJheSkgewogICAgICAgIHJldHVybiB0cnVlOwogICAgICB9CgogICAgICByZXR1cm4gZmFsc2U7CiAgICB9CiAgfSwgewogICAga2V5OiAnX2ludGVybmFsT2JzZXJ2ZScsCiAgICB2YWx1ZTogZnVuY3Rpb24gX2ludGVybmFsT2JzZXJ2ZShwYXRoLCBvYmopIHsKICAgICAgdmFyIF90aGlzID0gdGhpczsKCiAgICAgIGlmIChfdGhpcy5faXNPYnNlcnZhYmxlKG9iaikpIHsKICAgICAgICB2YXIgaGFuZGxlciA9IGZ1bmN0aW9uIGhhbmRsZXIoY2hhbmdlcykgewogICAgICAgICAgX3RoaXMuX29uQ2hhbmdlcyhwYXRoLCBjaGFuZ2VzKTsKICAgICAgICB9OwoKICAgICAgICBpZiAob2JqLmNvbnN0cnVjdG9yID09PSBPYmplY3QpIHsKICAgICAgICAgIE9iamVjdC5vYnNlcnZlKG9iaiwgaGFuZGxlcik7CiAgICAgICAgICBmb3IgKHZhciBwcm9wIGluIG9iaikgewogICAgICAgICAgICBpZiAoX3RoaXMuX2lzT2JzZXJ2YWJsZShvYmpbcHJvcF0pKSB7CiAgICAgICAgICAgICAgX3RoaXMuX2ludGVybmFsT2JzZXJ2ZShwYXRoWyduZXcnXShwcm9wKSwgb2JqW3Byb3BdKTsKICAgICAgICAgICAgfQogICAgICAgICAgfQogICAgICAgIH0gZWxzZSBpZiAob2JqLmNvbnN0cnVjdG9yID09PSBBcnJheSkgewogICAgICAgICAgQXJyYXkub2JzZXJ2ZShvYmosIGhhbmRsZXIpOwogICAgICAgICAgZm9yICh2YXIgcHJvcCBpbiBvYmopIHsKICAgICAgICAgICAgaWYgKF90aGlzLl9pc09ic2VydmFibGUob2JqW3Byb3BdKSkgewogICAgICAgICAgICAgIHZhciBucCA9IHBhdGhbJ25ldyddKG5ldyBBcnJheUluZGV4KG9ialtwcm9wXSwgcHJvcCkpOwogICAgICAgICAgICAgIF90aGlzLl9pbnRlcm5hbE9ic2VydmUobnAsIG9ialtwcm9wXSk7CiAgICAgICAgICAgIH0KICAgICAgICAgIH0KICAgICAgICB9CiAgICAgIH0KICAgIH0KICB9LCB7CiAgICBrZXk6ICdfb25DaGFuZ2VzJywKICAgIHZhbHVlOiBmdW5jdGlvbiBfb25DaGFuZ2VzKHBhdGgsIGNoYW5nZXMpIHsKICAgICAgdmFyIF90aGlzMiA9IHRoaXM7CgogICAgICBmb3IgKHZhciBpIGluIGNoYW5nZXMpIHsKICAgICAgICB2YXIgb2JqID0gY2hhbmdlc1tpXS5vYmplY3Q7CiAgICAgICAgdmFyIG9ialR5cGUgPSB1bmRlZmluZWQ7CgogICAgICAgIGlmIChvYmouY29uc3RydWN0b3IgPT0gT2JqZWN0KSB7CiAgICAgICAgICBvYmpUeXBlID0gT2JqZWN0VHlwZS5PQkpFQ1Q7CiAgICAgICAgfQoKICAgICAgICBpZiAob2JqLmNvbnN0cnVjdG9yID09IEFycmF5KSB7CiAgICAgICAgICBvYmpUeXBlID0gT2JqZWN0VHlwZS5BUlJBWTsKICAgICAgICB9CgogICAgICAgIGlmIChjaGFuZ2VzW2ldLnR5cGUgPT09ICdzcGxpY2UnKSB7CiAgICAgICAgICAoZnVuY3Rpb24gKCkgewogICAgICAgICAgICB2YXIgaWR4ID0gY2hhbmdlc1tpXS5pbmRleDsKICAgICAgICAgICAgdmFyIGZpZWxkID0gcGF0aFsnbmV3J10oJycgKyBpZHgpOwogICAgICAgICAgICB2YXIgZmllbGRTdHJpbmcgPSBmaWVsZC50b1N0cmluZygpOwoKICAgICAgICAgICAgdmFyIHJlbW92ZVNpemUgPSBjaGFuZ2VzW2ldLnJlbW92ZWQubGVuZ3RoOwogICAgICAgICAgICBpZiAocmVtb3ZlU2l6ZSAhPT0gMCkgewogICAgICAgICAgICAgIHZhciByZW1vdmVWYWx1ZXMgPSBjaGFuZ2VzW2ldLnJlbW92ZWQ7CiAgICAgICAgICAgICAgcmVtb3ZlVmFsdWVzLmZvckVhY2goZnVuY3Rpb24gKHZhbHVlLCBpbmRleCkgewogICAgICAgICAgICAgICAgaWYgKF90aGlzMi5faXNPYnNlcnZhYmxlKHZhbHVlKSkgewogICAgICAgICAgICAgICAgICBwYXRoLnJlbW92ZUluZGV4KGlkeCArIGluZGV4KTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICB9KTsKCiAgICAgICAgICAgICAgX3RoaXMyLl9maXJlRXZlbnQoewogICAgICAgICAgICAgICAgY1R5cGU6IENoYW5nZVR5cGUuUkVNT1ZFLAogICAgICAgICAgICAgICAgb1R5cGU6IG9ialR5cGUsCiAgICAgICAgICAgICAgICBmaWVsZDogZmllbGRTdHJpbmcsCiAgICAgICAgICAgICAgICBkYXRhOiByZW1vdmVTaXplCiAgICAgICAgICAgICAgfSk7CiAgICAgICAgICAgIH0KCiAgICAgICAgICAgIHZhciBhZGRTaXplID0gY2hhbmdlc1tpXS5hZGRlZENvdW50OwogICAgICAgICAgICBpZiAoYWRkU2l6ZSAhPT0gMCkgewogICAgICAgICAgICAgIHZhciBhZGRWYWx1ZXMgPSBvYmouc2xpY2UoaWR4LCBpZHggKyBhZGRTaXplKTsKICAgICAgICAgICAgICBhZGRWYWx1ZXMuZm9yRWFjaChmdW5jdGlvbiAodmFsdWUsIGluZGV4KSB7CiAgICAgICAgICAgICAgICBpZiAoX3RoaXMyLl9pc09ic2VydmFibGUodmFsdWUpKSB7CiAgICAgICAgICAgICAgICAgIHZhciBucCA9IHBhdGhbJ25ldyddKG5ldyBBcnJheUluZGV4KHZhbHVlLCBpZHggKyBpbmRleCkpOwogICAgICAgICAgICAgICAgICBfdGhpczIuX2ludGVybmFsT2JzZXJ2ZShucCwgdmFsdWUpOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIH0pOwoKICAgICAgICAgICAgICBfdGhpczIuX2ZpcmVFdmVudCh7CiAgICAgICAgICAgICAgICBjVHlwZTogQ2hhbmdlVHlwZS5BREQsCiAgICAgICAgICAgICAgICBvVHlwZTogb2JqVHlwZSwKICAgICAgICAgICAgICAgIGZpZWxkOiBmaWVsZFN0cmluZywKICAgICAgICAgICAgICAgIGRhdGE6ICgwLCBfdXRpbHNVdGlsc0pzLmRlZXBDbG9uZSkoYWRkVmFsdWVzKQogICAgICAgICAgICAgIH0pOwogICAgICAgICAgICB9CgogICAgICAgICAgICAvL3JlLWRlZmluZSBwYXRocy4uLgogICAgICAgICAgICBpZiAoaWR4ICE9IG9iai5sZW5ndGggLSAxKSB7CiAgICAgICAgICAgICAgcGF0aC5yZUluZGV4RnJvbShvYmopOwogICAgICAgICAgICB9CiAgICAgICAgICB9KSgpOwogICAgICAgIH0gZWxzZSB7CiAgICAgICAgICB2YXIgZmllbGQgPSBwYXRoWyduZXcnXShjaGFuZ2VzW2ldLm5hbWUpOwogICAgICAgICAgdmFyIGZpZWxkU3RyaW5nID0gZmllbGQudG9TdHJpbmcoKTsKCiAgICAgICAgICBpZiAoZmllbGRTdHJpbmcuaW5kZXhPZignU3ltYm9sJykgIT09IC0xKSB7CiAgICAgICAgICAgIC8vaGFjayBmb3IgUGhhbnRvbUpTMgogICAgICAgICAgICAvL2NvbnNvbGUubG9nKCdTWU1CT0w6ICcsIGNoYW5nZXNbaV0pOwogICAgICAgICAgICBjb250aW51ZTsKICAgICAgICAgIH0KCiAgICAgICAgICAvL2xldCBvbGRWYWx1ZSA9IGNoYW5nZXNbaV0ub2xkVmFsdWU7CiAgICAgICAgICB2YXIgbmV3VmFsdWUgPSBvYmpbY2hhbmdlc1tpXS5uYW1lXTsKICAgICAgICAgIGlmIChjaGFuZ2VzW2ldLnR5cGUgPT09ICd1cGRhdGUnKSB7CiAgICAgICAgICAgIHRoaXMuX2ZpcmVFdmVudCh7CiAgICAgICAgICAgICAgY1R5cGU6IENoYW5nZVR5cGUuVVBEQVRFLAogICAgICAgICAgICAgIG9UeXBlOiBvYmpUeXBlLAogICAgICAgICAgICAgIGZpZWxkOiBmaWVsZFN0cmluZywKICAgICAgICAgICAgICBkYXRhOiAoMCwgX3V0aWxzVXRpbHNKcy5kZWVwQ2xvbmUpKG5ld1ZhbHVlKQogICAgICAgICAgICB9KTsKICAgICAgICAgIH0KCiAgICAgICAgICBpZiAoY2hhbmdlc1tpXS50eXBlID09PSAnYWRkJykgewogICAgICAgICAgICB0aGlzLl9pbnRlcm5hbE9ic2VydmUoZmllbGQsIG5ld1ZhbHVlKTsKICAgICAgICAgICAgdGhpcy5fZmlyZUV2ZW50KHsKICAgICAgICAgICAgICBjVHlwZTogQ2hhbmdlVHlwZS5BREQsCiAgICAgICAgICAgICAgb1R5cGU6IG9ialR5cGUsCiAgICAgICAgICAgICAgZmllbGQ6IGZpZWxkU3RyaW5nLAogICAgICAgICAgICAgIGRhdGE6ICgwLCBfdXRpbHNVdGlsc0pzLmRlZXBDbG9uZSkobmV3VmFsdWUpCiAgICAgICAgICAgIH0pOwogICAgICAgICAgfQoKICAgICAgICAgIGlmIChjaGFuZ2VzW2ldLnR5cGUgPT09ICdkZWxldGUnKSB7CiAgICAgICAgICAgIHRoaXMuX2ZpcmVFdmVudCh7CiAgICAgICAgICAgICAgY1R5cGU6IENoYW5nZVR5cGUuUkVNT1ZFLAogICAgICAgICAgICAgIG9UeXBlOiBvYmpUeXBlLAogICAgICAgICAgICAgIGZpZWxkOiBmaWVsZFN0cmluZwogICAgICAgICAgICB9KTsKICAgICAgICAgIH0KICAgICAgICB9CiAgICAgIH0KICAgIH0KICB9LCB7CiAgICBrZXk6ICdkYXRhJywKICAgIGdldDogZnVuY3Rpb24gZ2V0KCkgewogICAgICByZXR1cm4gdGhpcy5fZGF0YTsKICAgIH0KICB9XSk7CgogIHJldHVybiBTeW5jT2JqZWN0Owp9KSgpOwoKdmFyIFBhdGggPSAoZnVuY3Rpb24gKCkgewogIGZ1bmN0aW9uIFBhdGgoKSB7CiAgICBfY2xhc3NDYWxsQ2hlY2sodGhpcywgUGF0aCk7CgogICAgdGhpcy5fcGF0aCA9IFtdOwogICAgdGhpcy5fb2JzZXJ2YWJsZXMgPSB7fTsgLy88aW5kZXg6QXJyYXlJbmRleD4KICB9CgogIF9jcmVhdGVDbGFzcyhQYXRoLCBbewogICAga2V5OiAncmVtb3ZlSW5kZXgnLAogICAgdmFsdWU6IGZ1bmN0aW9uIHJlbW92ZUluZGV4KGlkeCkgewogICAgICAvL2NvbnNvbGUubG9nKCdSRU1PVkUtUEFUSCAnICsgaWR4KTsKICAgICAgZGVsZXRlIHRoaXMuX29ic2VydmFibGVzW2lkeF07CiAgICB9CiAgfSwgewogICAga2V5OiAncmVJbmRleEZyb20nLAogICAgdmFsdWU6IGZ1bmN0aW9uIHJlSW5kZXhGcm9tKGFycmF5KSB7CiAgICAgIHZhciBfdGhpczMgPSB0aGlzOwoKICAgICAgT2JqZWN0LmtleXModGhpcy5fb2JzZXJ2YWJsZXMpLmZvckVhY2goZnVuY3Rpb24gKGtleSkgewogICAgICAgIHZhciBhcnJheUluZGV4ID0gX3RoaXMzLl9vYnNlcnZhYmxlc1trZXldOwogICAgICAgIHZhciBpZHggPSBhcnJheS5pbmRleE9mKGFycmF5SW5kZXgub2JqKTsKICAgICAgICBpZiAoYXJyYXlJbmRleC5pZHggIT0gaWR4KSB7CiAgICAgICAgICAvL2NvbnNvbGUubG9nKCdSRS1JTkRFWDogJyArIGtleSArICctPicgKyBpZHgpOwogICAgICAgICAgYXJyYXlJbmRleC5pZHggPSBpZHg7CiAgICAgICAgICBkZWxldGUgX3RoaXMzLl9vYnNlcnZhYmxlc1trZXldOwogICAgICAgICAgX3RoaXMzLl9vYnNlcnZhYmxlc1tpZHhdID0gYXJyYXlJbmRleDsKICAgICAgICB9CiAgICAgIH0pOwogICAgfQogIH0sIHsKICAgIGtleTogJ25ldycsCiAgICB2YWx1ZTogZnVuY3Rpb24gX25ldyhpZHgpIHsKICAgICAgaWYgKGlkeC5jb25zdHJ1Y3RvciA9PSBBcnJheUluZGV4KSB7CiAgICAgICAgLy9jb25zb2xlLmxvZygnUEFUSC1PQlNFUlY6ICcsIGlkeCk7CiAgICAgICAgdGhpcy5fb2JzZXJ2YWJsZXNbaWR4LmlkeF0gPSBpZHg7CiAgICAgIH0KCiAgICAgIHZhciBuUGF0aCA9IHRoaXMuY2xvbmUoKTsKICAgICAgblBhdGguX3BhdGgucHVzaChpZHgpOwoKICAgICAgcmV0dXJuIG5QYXRoOwogICAgfQogIH0sIHsKICAgIGtleTogJ2Nsb25lJywKICAgIHZhbHVlOiBmdW5jdGlvbiBjbG9uZSgpIHsKICAgICAgdmFyIG5QYXRoID0gbmV3IFBhdGgoKTsKICAgICAgdGhpcy5fcGF0aC5mb3JFYWNoKGZ1bmN0aW9uICh2YWx1ZSkgewogICAgICAgIG5QYXRoLl9wYXRoLnB1c2godmFsdWUpOwogICAgICB9KTsKCiAgICAgIHJldHVybiBuUGF0aDsKICAgIH0KICB9LCB7CiAgICBrZXk6ICd0b1N0cmluZycsCiAgICB2YWx1ZTogZnVuY3Rpb24gdG9TdHJpbmcoKSB7CiAgICAgIC8vVE9ETzogb3B0aW1pemUhIQogICAgICB2YXIgc3RyID0gJyc7CiAgICAgIHRoaXMuX3BhdGguZm9yRWFjaChmdW5jdGlvbiAodmFsdWUsIGluZGV4KSB7CiAgICAgICAgaWYgKGluZGV4ID09PSAwKSB7CiAgICAgICAgICBzdHIgPSB2YWx1ZS50b1N0cmluZygpOwogICAgICAgIH0gZWxzZSB7CiAgICAgICAgICBzdHIgKz0gJy4nICsgdmFsdWUudG9TdHJpbmcoKTsKICAgICAgICB9CiAgICAgIH0pOwoKICAgICAgcmV0dXJuIHN0cjsKICAgIH0KICB9XSk7CgogIHJldHVybiBQYXRoOwp9KSgpOwoKdmFyIEFycmF5SW5kZXggPSAoZnVuY3Rpb24gKCkgewogIGZ1bmN0aW9uIEFycmF5SW5kZXgob2JqLCBpZHgpIHsKICAgIF9jbGFzc0NhbGxDaGVjayh0aGlzLCBBcnJheUluZGV4KTsKCiAgICB0aGlzLm9iaiA9IG9iajsKICAgIHRoaXMuaWR4ID0gaWR4OwogIH0KCiAgX2NyZWF0ZUNsYXNzKEFycmF5SW5kZXgsIFt7CiAgICBrZXk6ICd0b1N0cmluZycsCiAgICB2YWx1ZTogZnVuY3Rpb24gdG9TdHJpbmcoKSB7CiAgICAgIHJldHVybiB0aGlzLmlkeC50b1N0cmluZygpOwogICAgfQogIH1dKTsKCiAgcmV0dXJuIEFycmF5SW5kZXg7Cn0pKCk7Cgp2YXIgQ2hhbmdlVHlwZSA9IHsgVVBEQVRFOiAndXBkYXRlJywgQUREOiAnYWRkJywgUkVNT1ZFOiAncmVtb3ZlJyB9OwpleHBvcnRzLkNoYW5nZVR5cGUgPSBDaGFuZ2VUeXBlOwp2YXIgT2JqZWN0VHlwZSA9IHsgT0JKRUNUOiAnb2JqZWN0JywgQVJSQVk6ICdhcnJheScgfTsKZXhwb3J0cy5PYmplY3RUeXBlID0gT2JqZWN0VHlwZTsKZXhwb3J0c1snZGVmYXVsdCddID0gU3luY09iamVjdDsKCn0seyIuLi91dGlscy91dGlscy5qcyI6MjR9XSwyMjpbZnVuY3Rpb24ocmVxdWlyZSxtb2R1bGUsZXhwb3J0cyl7Cid1c2Ugc3RyaWN0JzsKCk9iamVjdC5kZWZpbmVQcm9wZXJ0eShleHBvcnRzLCAnX19lc01vZHVsZScsIHsKICB2YWx1ZTogdHJ1ZQp9KTsKCnZhciBfY3JlYXRlQ2xhc3MgPSAoZnVuY3Rpb24gKCkgeyBmdW5jdGlvbiBkZWZpbmVQcm9wZXJ0aWVzKHRhcmdldCwgcHJvcHMpIHsgZm9yICh2YXIgaSA9IDA7IGkgPCBwcm9wcy5sZW5ndGg7IGkrKykgeyB2YXIgZGVzY3JpcHRvciA9IHByb3BzW2ldOyBkZXNjcmlwdG9yLmVudW1lcmFibGUgPSBkZXNjcmlwdG9yLmVudW1lcmFibGUgfHwgZmFsc2U7IGRlc2NyaXB0b3IuY29uZmlndXJhYmxlID0gdHJ1ZTsgaWYgKCd2YWx1ZScgaW4gZGVzY3JpcHRvcikgZGVzY3JpcHRvci53cml0YWJsZSA9IHRydWU7IE9iamVjdC5kZWZpbmVQcm9wZXJ0eSh0YXJnZXQsIGRlc2NyaXB0b3Iua2V5LCBkZXNjcmlwdG9yKTsgfSB9IHJldHVybiBmdW5jdGlvbiAoQ29uc3RydWN0b3IsIHByb3RvUHJvcHMsIHN0YXRpY1Byb3BzKSB7IGlmIChwcm90b1Byb3BzKSBkZWZpbmVQcm9wZXJ0aWVzKENvbnN0cnVjdG9yLnByb3RvdHlwZSwgcHJvdG9Qcm9wcyk7IGlmIChzdGF0aWNQcm9wcykgZGVmaW5lUHJvcGVydGllcyhDb25zdHJ1Y3Rvciwgc3RhdGljUHJvcHMpOyByZXR1cm4gQ29uc3RydWN0b3I7IH07IH0pKCk7CgpmdW5jdGlvbiBfaW50ZXJvcFJlcXVpcmVEZWZhdWx0KG9iaikgeyByZXR1cm4gb2JqICYmIG9iai5fX2VzTW9kdWxlID8gb2JqIDogeyAnZGVmYXVsdCc6IG9iaiB9OyB9CgpmdW5jdGlvbiBfY2xhc3NDYWxsQ2hlY2soaW5zdGFuY2UsIENvbnN0cnVjdG9yKSB7IGlmICghKGluc3RhbmNlIGluc3RhbmNlb2YgQ29uc3RydWN0b3IpKSB7IHRocm93IG5ldyBUeXBlRXJyb3IoJ0Nhbm5vdCBjYWxsIGEgY2xhc3MgYXMgYSBmdW5jdGlvbicpOyB9IH0KCnZhciBfRGF0YU9iamVjdFJlcG9ydGVyID0gcmVxdWlyZSgnLi9EYXRhT2JqZWN0UmVwb3J0ZXInKTsKCnZhciBfRGF0YU9iamVjdFJlcG9ydGVyMiA9IF9pbnRlcm9wUmVxdWlyZURlZmF1bHQoX0RhdGFPYmplY3RSZXBvcnRlcik7Cgp2YXIgX0RhdGFPYmplY3RPYnNlcnZlciA9IHJlcXVpcmUoJy4vRGF0YU9iamVjdE9ic2VydmVyJyk7Cgp2YXIgX0RhdGFPYmplY3RPYnNlcnZlcjIgPSBfaW50ZXJvcFJlcXVpcmVEZWZhdWx0KF9EYXRhT2JqZWN0T2JzZXJ2ZXIpOwoKLyoqCiAqIEBhdXRob3IgbWljYWVscGVkcm9zYUBnbWFpbC5jb20KICogQ2xpZW50IEFQSSBTeW5jcm9uaXphdGlvbiBzeXN0ZW0uCiAqLwoKdmFyIFN5bmNoZXIgPSAoZnVuY3Rpb24gKCkgewogIC8qIHByaXZhdGUKICBfb3duZXI6IFVSTAogIF9idXM6IE1pbmlCdXMKICAgX3N1YlVSTDogVVJMCiAgIF9yZXBvcnRlcnM6IDx1cmw6IERhdGFPYmplY3RSZXBvcnRlcj4KICBfb2JzZXJ2ZXJzOiA8dXJsOiBEYXRhT2JqZWN0T2JzZXJ2ZXI+CiAgIC0tLS1ldmVudCBoYW5kbGVycy0tLS0KICBfb25SZXNwb25zZUhhbmRsZXI6IChldmVudCkgPT4gdm9pZAogIF9vbk5vdGlmaWNhdGlvbkhhbmRsZXI6IChldmVudCkgPT4gdm9pZAogICovCgogIGZ1bmN0aW9uIFN5bmNoZXIob3duZXIsIGJ1cywgY29uZmlnKSB7CiAgICBfY2xhc3NDYWxsQ2hlY2sodGhpcywgU3luY2hlcik7CgogICAgdmFyIF90aGlzID0gdGhpczsKCiAgICBfdGhpcy5fb3duZXIgPSBvd25lcjsKICAgIF90aGlzLl9idXMgPSBidXM7CgogICAgX3RoaXMuX3N1YlVSTCA9IGNvbmZpZy5ydW50aW1lVVJMICsgJy9zbSc7CgogICAgX3RoaXMuX3JlcG9ydGVycyA9IHt9OwogICAgX3RoaXMuX29ic2VydmVycyA9IHt9OwoKICAgIGJ1cy5hZGRMaXN0ZW5lcihvd25lciwgZnVuY3Rpb24gKG1zZykgewogICAgICBjb25zb2xlLmxvZygnU3luY2hlci1SQ1Y6ICcsIG1zZyk7CiAgICAgIHN3aXRjaCAobXNnLnR5cGUpIHsKICAgICAgICBjYXNlICdyZXNwb25zZSc6CiAgICAgICAgICBfdGhpcy5fb25SZXNwb25zZShtc2cpO2JyZWFrOwogICAgICAgIGNhc2UgJ2ZvcndhcmQnOgogICAgICAgICAgX3RoaXMuX29uRm9yd2FyZChtc2cpO2JyZWFrOwogICAgICAgIGNhc2UgJ2NyZWF0ZSc6CiAgICAgICAgICBfdGhpcy5fb25DcmVhdGUobXNnKTticmVhazsKICAgICAgICBjYXNlICd1cGRhdGUnOgogICAgICAgICAgX3RoaXMuX29uQ2hhbmdlKG1zZyk7YnJlYWs7CiAgICAgICAgY2FzZSAnYWRkJzoKICAgICAgICAgIF90aGlzLl9vbkNoYW5nZShtc2cpO2JyZWFrOwogICAgICAgIGNhc2UgJ3JlbW92ZSc6CiAgICAgICAgICBfdGhpcy5fb25DaGFuZ2UobXNnKTticmVhazsKICAgICAgfQogICAgfSk7CiAgfQoKICBfY3JlYXRlQ2xhc3MoU3luY2hlciwgW3sKICAgIGtleTogJ2NyZWF0ZScsCgogICAgLyoqCiAgICAgKiBSZXF1ZXN0IGEgRGF0YU9iamVjdFJlcG9ydGVyIGNyZWF0aW9uLiBUaGUgVVJMIHdpbGwgYmUgYmUgcmVxdWVzdGVkIGJ5IHRoZSBhbGxvY2F0aW9uIG1lY2hhbmlzbS4KICAgICAqIEBwYXJhbSAge1NjaGVtYX0gc2NoZW1hIFNjaGVtYSBvZiB0aGUgb2JqZWN0CiAgICAgKiBAcGFyYW0gIHtIeXBlcnR5VVJMW119IExpc3Qgb2YgaHlwZXJ0aWVzIHRvIHNlbmQgdGhlIGNyZWF0ZQogICAgICogQHBhcmFtICB7SlNPTn0gaW5pdGlhbERhdGEgT2JqZWN0IGluaXRpYWwgZGF0YQogICAgICogQHJldHVybiB7UHJvbWlzZTxEYXRhT2JqZWN0UmVwb3J0ZXI+fSBSZXR1cm4gUHJvbWlzZSB0byBhIG5ldyBSZXBvcnRlci4gVGhlIHJlcG9ydGVyIGNhbiBiZSBhY2NlcHRlZCBvciByZWplY3RlZCBieSB0aGUgUEVQCiAgICAgKi8KICAgIHZhbHVlOiBmdW5jdGlvbiBjcmVhdGUoc2NoZW1hLCBvYnNlcnZlcnMsIGluaXRpYWxEYXRhKSB7CiAgICAgIHZhciBfdGhpcyA9IHRoaXM7CgogICAgICAvL1RPRE86IHdoYXQgdG8gZG8gd2l0aCBzY2hlbWE/CgogICAgICB2YXIgcmVxdWVzdE1zZyA9IHsKICAgICAgICB0eXBlOiAnY3JlYXRlJywgZnJvbTogX3RoaXMuX293bmVyLCB0bzogX3RoaXMuX3N1YlVSTCwKICAgICAgICBib2R5OiB7IHNjaGVtYTogc2NoZW1hLCB2YWx1ZTogaW5pdGlhbERhdGEsIGF1dGhvcmlzZTogb2JzZXJ2ZXJzIH0KICAgICAgfTsKCiAgICAgIHJldHVybiBuZXcgUHJvbWlzZShmdW5jdGlvbiAocmVzb2x2ZSwgcmVqZWN0KSB7CiAgICAgICAgLy9yZXF1ZXN0IGNyZWF0ZSB0byB0aGUgQWxsb2NhdGlvbiBzeXN0ZW0/IENhbiBiZSByZWplY3RlZCBieSB0aGUgUG9saWN5RW5naW5lLgogICAgICAgIF90aGlzLl9idXMucG9zdE1lc3NhZ2UocmVxdWVzdE1zZywgZnVuY3Rpb24gKHJlcGx5KSB7CiAgICAgICAgICBjb25zb2xlLmxvZygnY3JlYXRlLXJlc3BvbnNlOiAnLCByZXBseSk7CiAgICAgICAgICBpZiAocmVwbHkuYm9keS5jb2RlID09PSAyMDApIHsKICAgICAgICAgICAgdmFyIG9ialVybCA9IHJlcGx5LmJvZHkucmVzb3VyY2U7CgogICAgICAgICAgICAvL3JlcG9ydGVyIGNyZWF0aW9uIGFjY2VwdGVkCiAgICAgICAgICAgIHZhciBuZXdPYmogPSBuZXcgX0RhdGFPYmplY3RSZXBvcnRlcjJbJ2RlZmF1bHQnXShfdGhpcy5fb3duZXIsIG9ialVybCwgc2NoZW1hLCBfdGhpcy5fYnVzLCAnb24nLCBpbml0aWFsRGF0YSk7CiAgICAgICAgICAgIF90aGlzLl9yZXBvcnRlcnNbb2JqVXJsXSA9IG5ld09iajsKICAgICAgICAgICAgcmVzb2x2ZShuZXdPYmopOwogICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgLy9yZXBvcnRlciBjcmVhdGlvbiByZWplY3RlZAogICAgICAgICAgICByZWplY3QocmVwbHkuYm9keS5kZXNjKTsKICAgICAgICAgIH0KICAgICAgICB9KTsKICAgICAgfSk7CiAgICB9CgogICAgLyoqCiAgICAgKiBSZXF1ZXN0IGEgc3Vic2NyaXB0aW9uIHRvIGFuIGV4aXN0ZW50IG9iamVjdC4KICAgICAqIEBwYXJhbSAge09iamVjdFVSTH0gb2JqVVJMIEFkZHJlc3Mgb2YgdGhlIGV4aXN0ZW50IG9iamVjdC4KICAgICAqIEByZXR1cm4ge1Byb21pc2U8RGF0YU9iamVjdE9ic2VydmVyPn0gUmV0dXJuIFByb21pc2UgdG8gYSBuZXcgT2JzZXJ2ZXIuCiAgICAgKi8KICB9LCB7CiAgICBrZXk6ICdzdWJzY3JpYmUnLAogICAgdmFsdWU6IGZ1bmN0aW9uIHN1YnNjcmliZShvYmpVUkwpIHsKICAgICAgdmFyIF90aGlzID0gdGhpczsKICAgICAgdmFyIG9ialN1YnNjcmlwdG9yVVJMID0gb2JqVVJMICsgJy9zdWJzY3JpcHRpb24nOwoKICAgICAgLy9UT0RPOiB2YWxpZGF0ZSBpZiBzdWJzY3JpcHRpb24gYWxyZWFkeSBleGlzdHMgPwogICAgICAvL1RPRE86IHJlbW92ZSBmcm9tIGJvZHkgaHlwZXJ0eVVSTCAod2FzIGFkZGVkIGJlY2F1c2UgdGhlIFBvbGljeUVuZ2luZSkKICAgICAgdmFyIHN1YnNjcmliZU1zZyA9IHsKICAgICAgICB0eXBlOiAnc3Vic2NyaWJlJywgZnJvbTogX3RoaXMuX293bmVyLCB0bzogb2JqU3Vic2NyaXB0b3JVUkwKICAgICAgfTsKCiAgICAgIHJldHVybiBuZXcgUHJvbWlzZShmdW5jdGlvbiAocmVzb2x2ZSwgcmVqZWN0KSB7CiAgICAgICAgLy9yZXF1ZXN0IHN1YnNjcmlwdGlvbgogICAgICAgIF90aGlzLl9idXMucG9zdE1lc3NhZ2Uoc3Vic2NyaWJlTXNnLCBmdW5jdGlvbiAocmVwbHkpIHsKICAgICAgICAgIGNvbnNvbGUubG9nKCdzdWJzY3JpYmUtcmVzcG9uc2U6ICcsIHJlcGx5KTsKICAgICAgICAgIGlmIChyZXBseS5ib2R5LmNvZGUgPT09IDIwMCkgewogICAgICAgICAgICAvL3N1YnNjcmlwdGlvbiBhY2NlcHRlZAogICAgICAgICAgICB2YXIgbmV3T2JqID0gX3RoaXMuX2FkZE9ic2VydmVyKG9ialVSTCwgcmVwbHkuYm9keS5zY2hlbWEsIHJlcGx5LmJvZHkudmFsdWUpOwogICAgICAgICAgICByZXNvbHZlKG5ld09iaik7CiAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAvL3N1YnNjcmlwdGlvbiByZWplY3RlZAogICAgICAgICAgICByZWplY3QocmVwbHkuYm9keS5kZXNjKTsKICAgICAgICAgIH0KICAgICAgICB9KTsKICAgICAgfSk7CiAgICB9CiAgfSwgewogICAga2V5OiAnb25SZXNwb25zZScsCiAgICB2YWx1ZTogZnVuY3Rpb24gb25SZXNwb25zZShjYWxsYmFjaykgewogICAgICB0aGlzLl9vblJlc3BvbnNlSGFuZGxlciA9IGNhbGxiYWNrOwogICAgfQogIH0sIHsKICAgIGtleTogJ29uTm90aWZpY2F0aW9uJywKICAgIHZhbHVlOiBmdW5jdGlvbiBvbk5vdGlmaWNhdGlvbihjYWxsYmFjaykgewogICAgICB0aGlzLl9vbk5vdGlmaWNhdGlvbkhhbmRsZXIgPSBjYWxsYmFjazsKICAgIH0KICB9LCB7CiAgICBrZXk6ICdfb25SZXNwb25zZScsCiAgICB2YWx1ZTogZnVuY3Rpb24gX29uUmVzcG9uc2UobXNnKSB7CiAgICAgIHZhciBfdGhpcyA9IHRoaXM7CgogICAgICAvL1RPRE86IHByb2Nlc3Mgbm90aWZpY2F0aW9uIHJlcG9uc2VzIQogICAgICBjb25zb2xlLmxvZygnb25SZXNwb25zZTonLCBtc2cpOwogICAgfQogIH0sIHsKICAgIGtleTogJ19vbkZvcndhcmQnLAogICAgdmFsdWU6IGZ1bmN0aW9uIF9vbkZvcndhcmQobXNnKSB7CiAgICAgIHZhciBfdGhpcyA9IHRoaXM7CgogICAgICB2YXIgcmVwb3J0ZXIgPSBfdGhpcy5fcmVwb3J0ZXJzW21zZy5ib2R5LnRvXTsKICAgICAgcmVwb3J0ZXIuX29uRm9yd2FyZChtc2cpOwogICAgfQogIH0sIHsKICAgIGtleTogJ19vbkNyZWF0ZScsCiAgICB2YWx1ZTogZnVuY3Rpb24gX29uQ3JlYXRlKG1zZykgewogICAgICB2YXIgX3RoaXMgPSB0aGlzOwoKICAgICAgdmFyIGV2ZW50ID0gewogICAgICAgIHR5cGU6IG1zZy50eXBlLAogICAgICAgIGZyb206IG1zZy5mcm9tLAogICAgICAgIHVybDogbXNnLmJvZHkucmVzb3VyY2UsCiAgICAgICAgc2NoZW1hOiBtc2cuYm9keS5zY2hlbWEsCiAgICAgICAgdmFsdWU6IG1zZy5ib2R5LnZhbHVlLAoKICAgICAgICBhY2s6IGZ1bmN0aW9uIGFjaygpIHsKICAgICAgICAgIC8vc2VuZCBhY2sgcmVzcG9uc2UgbWVzc2FnZQogICAgICAgICAgX3RoaXMuX2J1cy5wb3N0TWVzc2FnZSh7CiAgICAgICAgICAgIGlkOiBtc2cuaWQsIHR5cGU6ICdyZXNwb25zZScsIGZyb206IG1zZy50bywgdG86IG1zZy5mcm9tLAogICAgICAgICAgICBib2R5OiB7IGNvZGU6IDIwMCB9CiAgICAgICAgICB9KTsKICAgICAgICB9CiAgICAgIH07CgogICAgICBpZiAoX3RoaXMuX29uTm90aWZpY2F0aW9uSGFuZGxlcikgewogICAgICAgIF90aGlzLl9vbk5vdGlmaWNhdGlvbkhhbmRsZXIoZXZlbnQpOwogICAgICB9CiAgICB9CiAgfSwgewogICAga2V5OiAnX29uQ2hhbmdlJywKICAgIHZhbHVlOiBmdW5jdGlvbiBfb25DaGFuZ2UobXNnKSB7CiAgICAgIHZhciBfdGhpcyA9IHRoaXM7CgogICAgICB2YXIgb2JzZXJ2ZXIgPSBfdGhpcy5fb2JzZXJ2ZXJzW21zZy5mcm9tXTsKICAgICAgb2JzZXJ2ZXIuX2NoYW5nZU9iamVjdChtc2cpOwogICAgfQogIH0sIHsKICAgIGtleTogJ19hZGRPYnNlcnZlcicsCiAgICB2YWx1ZTogZnVuY3Rpb24gX2FkZE9ic2VydmVyKG9ialVSTCwgc2NoZW1hVVJMLCBpbml0aWFsRGF0YSkgewogICAgICB2YXIgX3RoaXMgPSB0aGlzOwoKICAgICAgdmFyIG5ld09iaiA9IG5ldyBfRGF0YU9iamVjdE9ic2VydmVyMlsnZGVmYXVsdCddKF90aGlzLl9vd25lciwgb2JqVVJMLCBzY2hlbWFVUkwsICdvbicsIGluaXRpYWxEYXRhKTsKICAgICAgX3RoaXMuX29ic2VydmVyc1tvYmpVUkxdID0gbmV3T2JqOwoKICAgICAgcmV0dXJuIG5ld09iajsKICAgIH0KICB9LCB7CiAgICBrZXk6ICdvd25lcicsCiAgICBnZXQ6IGZ1bmN0aW9uIGdldCgpIHsKICAgICAgcmV0dXJuIHRoaXMuX293bmVyOwogICAgfQogIH0sIHsKICAgIGtleTogJ3JlcG9ydGVycycsCiAgICBnZXQ6IGZ1bmN0aW9uIGdldCgpIHsKICAgICAgcmV0dXJuIHRoaXMuX3JlcG9ydGVyczsKICAgIH0KICB9LCB7CiAgICBrZXk6ICdvYnNlcnZlcnMnLAogICAgZ2V0OiBmdW5jdGlvbiBnZXQoKSB7CiAgICAgIHJldHVybiB0aGlzLl9vYnNlcnZlcnM7CiAgICB9CiAgfV0pOwoKICByZXR1cm4gU3luY2hlcjsKfSkoKTsKCmV4cG9ydHNbJ2RlZmF1bHQnXSA9IFN5bmNoZXI7Cm1vZHVsZS5leHBvcnRzID0gZXhwb3J0c1snZGVmYXVsdCddOwoKfSx7Ii4vRGF0YU9iamVjdE9ic2VydmVyIjoxOSwiLi9EYXRhT2JqZWN0UmVwb3J0ZXIiOjIwfV0sMjM6W2Z1bmN0aW9uKHJlcXVpcmUsbW9kdWxlLGV4cG9ydHMpewovKioKICogRXZlbnRFbWl0dGVyCiAqIEFsbCBjbGFzc2VzIHdoaWNoIGV4dGVuZHMgdGhpcywgY2FuIGhhdmUgYWRkRXZlbnRMaXN0ZW5lciBhbmQgdHJpZ2dlciBldmVudHM7CiAqLwoidXNlIHN0cmljdCI7CgpPYmplY3QuZGVmaW5lUHJvcGVydHkoZXhwb3J0cywgIl9fZXNNb2R1bGUiLCB7CiAgdmFsdWU6IHRydWUKfSk7Cgp2YXIgX2NyZWF0ZUNsYXNzID0gKGZ1bmN0aW9uICgpIHsgZnVuY3Rpb24gZGVmaW5lUHJvcGVydGllcyh0YXJnZXQsIHByb3BzKSB7IGZvciAodmFyIGkgPSAwOyBpIDwgcHJvcHMubGVuZ3RoOyBpKyspIHsgdmFyIGRlc2NyaXB0b3IgPSBwcm9wc1tpXTsgZGVzY3JpcHRvci5lbnVtZXJhYmxlID0gZGVzY3JpcHRvci5lbnVtZXJhYmxlIHx8IGZhbHNlOyBkZXNjcmlwdG9yLmNvbmZpZ3VyYWJsZSA9IHRydWU7IGlmICgidmFsdWUiIGluIGRlc2NyaXB0b3IpIGRlc2NyaXB0b3Iud3JpdGFibGUgPSB0cnVlOyBPYmplY3QuZGVmaW5lUHJvcGVydHkodGFyZ2V0LCBkZXNjcmlwdG9yLmtleSwgZGVzY3JpcHRvcik7IH0gfSByZXR1cm4gZnVuY3Rpb24gKENvbnN0cnVjdG9yLCBwcm90b1Byb3BzLCBzdGF0aWNQcm9wcykgeyBpZiAocHJvdG9Qcm9wcykgZGVmaW5lUHJvcGVydGllcyhDb25zdHJ1Y3Rvci5wcm90b3R5cGUsIHByb3RvUHJvcHMpOyBpZiAoc3RhdGljUHJvcHMpIGRlZmluZVByb3BlcnRpZXMoQ29uc3RydWN0b3IsIHN0YXRpY1Byb3BzKTsgcmV0dXJuIENvbnN0cnVjdG9yOyB9OyB9KSgpOwoKZnVuY3Rpb24gX2NsYXNzQ2FsbENoZWNrKGluc3RhbmNlLCBDb25zdHJ1Y3RvcikgeyBpZiAoIShpbnN0YW5jZSBpbnN0YW5jZW9mIENvbnN0cnVjdG9yKSkgeyB0aHJvdyBuZXcgVHlwZUVycm9yKCJDYW5ub3QgY2FsbCBhIGNsYXNzIGFzIGEgZnVuY3Rpb24iKTsgfSB9Cgp2YXIgRXZlbnRFbWl0dGVyID0gKGZ1bmN0aW9uICgpIHsKICBmdW5jdGlvbiBFdmVudEVtaXR0ZXIoKSB7CiAgICBfY2xhc3NDYWxsQ2hlY2sodGhpcywgRXZlbnRFbWl0dGVyKTsKICB9CgogIF9jcmVhdGVDbGFzcyhFdmVudEVtaXR0ZXIsIFt7CiAgICBrZXk6ICJhZGRFdmVudExpc3RlbmVyIiwKCiAgICAvKioKICAgICAqIGFkZEV2ZW50TGlzdGVuZXIgbGlzdGVuIGZvciBhbiBldmVudFR5cGUKICAgICAqIEBwYXJhbSAge3N0cmluZ30gICAgICAgICBldmVudFR5cGUgLSBsaXN0ZW5pbmcgZm9yIHRoaXMgdHlwZSBvZiBldmVudAogICAgICogQHBhcmFtICB7RnVuY3Rpb259ICAgICAgIGNiICAgICAgICAtIGNhbGxiYWNrIGZ1bmN0aW9uIHdpbGwgYmUgZXhlY3V0ZWQgd2hlbiB0aGUgZXZlbnQgaXQgaXMgaW52b2tlZAogICAgICovCiAgICB2YWx1ZTogZnVuY3Rpb24gYWRkRXZlbnRMaXN0ZW5lcihldmVudFR5cGUsIGNiKSB7CiAgICAgIHZhciBfdGhpcyA9IHRoaXM7CiAgICAgIF90aGlzW2V2ZW50VHlwZV0gPSBjYjsKICAgIH0KCiAgICAvKioKICAgICAqIEludm9rZSB0aGUgZXZlbnRUeXBlCiAgICAgKiBAcGFyYW0gIHtzdHJpbmd9IGV2ZW50VHlwZSAtIGV2ZW50IHdpbGwgYmUgaW52b2tlZAogICAgICogQHBhcmFtICB7b2JqZWN0fSBwYXJhbXMgLSBwYXJhbWV0ZXJzIHdpbGwgYmUgcGFzc2VkIHRvIHRoZSBhZGRFdmVudExpc3RlbmVyCiAgICAgKi8KICB9LCB7CiAgICBrZXk6ICJ0cmlnZ2VyIiwKICAgIHZhbHVlOiBmdW5jdGlvbiB0cmlnZ2VyKGV2ZW50VHlwZSwgcGFyYW1zKSB7CiAgICAgIHZhciBfdGhpcyA9IHRoaXM7CgogICAgICBpZiAoX3RoaXNbZXZlbnRUeXBlXSkgewogICAgICAgIF90aGlzW2V2ZW50VHlwZV0ocGFyYW1zKTsKICAgICAgfQogICAgfQogIH1dKTsKCiAgcmV0dXJuIEV2ZW50RW1pdHRlcjsKfSkoKTsKCmV4cG9ydHNbImRlZmF1bHQiXSA9IEV2ZW50RW1pdHRlcjsKbW9kdWxlLmV4cG9ydHMgPSBleHBvcnRzWyJkZWZhdWx0Il07Cgp9LHt9XSwyNDpbZnVuY3Rpb24ocmVxdWlyZSxtb2R1bGUsZXhwb3J0cyl7Ci8qKgogKiBTdXBwb3J0IG1vZHVsZSB3aXRoIHNvbWUgZnVuY3Rpb25zIHdpbGwgYmUgdXNlZnVsCiAqIEBtb2R1bGUgdXRpbHMKICovCgovKioKICogQHR5cGVkZWYgZGl2aWRlVVJMCiAqIEB0eXBlIE9iamVjdAogKiBAcHJvcGVydHkge3N0cmluZ30gdHlwZSBUaGUgdHlwZSBvZiBVUkwKICogQHByb3BlcnR5IHtzdHJpbmd9IGRvbWFpbiBUaGUgZG9tYWluIG9mIFVSTAogKiBAcHJvcGVydHkge3N0cmluZ30gaWRlbnRpdHkgVGhlIGlkZW50aXR5IG9mIFVSTAogKi8KCi8qKgogKiBEaXZpZGUgYW4gdXJsIGluIHR5cGUsIGRvbWFpbiBhbmQgaWRlbnRpdHkKICogQHBhcmFtICB7VVJMLlVSTH0gdXJsIC0gdXJsIGFkZHJlc3MKICogQHJldHVybiB7ZGl2aWRlVVJMfSB0aGUgcmVzdWx0IG9mIGRpdmlkZVVSTAogKi8KJ3VzZSBzdHJpY3QnOwoKT2JqZWN0LmRlZmluZVByb3BlcnR5KGV4cG9ydHMsICdfX2VzTW9kdWxlJywgewogIHZhbHVlOiB0cnVlCn0pOwpleHBvcnRzLmRpdmlkZVVSTCA9IGRpdmlkZVVSTDsKZXhwb3J0cy5kZWVwQ2xvbmUgPSBkZWVwQ2xvbmU7CgpmdW5jdGlvbiBkaXZpZGVVUkwodXJsKSB7CgogIC8vIGxldCByZSA9IC8oW2EtekEtWi1dKik/OlwvXC8oPzpcLik/KFstYS16QS1aMC05QDolLl9cK34jPV17MiwyNTZ9XC5bYS16XXsyLDZ9XGIpKihcL1tcL1xkXHdcLi1dKikqKD86W1w/XSkqKC4rKSovZ2k7CiAgdmFyIHJlID0gLyhbYS16QS1aLV0qKTpcL1wvKD86XC4pPyhbLWEtekEtWjAtOUA6JS5fXCt+Iz1dezIsMjU2fSkoWy1hLXpBLVowLTlAOiUuX1wrfiM9XC9dKikvZ2k7CiAgdmFyIHN1YnN0ID0gJyQxLCQyLCQzJzsKICB2YXIgcGFydHMgPSB1cmwucmVwbGFjZShyZSwgc3Vic3QpLnNwbGl0KCcsJyk7CiAgdmFyIHJlc3VsdCA9IHsKICAgIHR5cGU6IHBhcnRzWzBdLAogICAgZG9tYWluOiBwYXJ0c1sxXSwKICAgIGlkZW50aXR5OiBwYXJ0c1syXQogIH07CgogIHJldHVybiByZXN1bHQ7Cn0KCi8qKgogKiBNYWtlIGEgQ09QWSBvZiB0aGUgb3JpZ2luYWwgZGF0YQogKiBAcGFyYW0gIHtPYmplY3R9ICBvYmogLSBvYmplY3QgdG8gYmUgY2xvbmVkCiAqIEByZXR1cm4ge09iamVjdH0KICovCgpmdW5jdGlvbiBkZWVwQ2xvbmUob2JqKSB7CiAgLy9UT0RPOiBzaW1wbGUgYnV0IGluZWZmaWNpZW50IEpTT04gZGVlcCBjbG9uZS4uLgogIHJldHVybiBKU09OLnBhcnNlKEpTT04uc3RyaW5naWZ5KG9iaikpOwp9Cgp9LHt9XX0se30sWzNdKSgzKQp9KTs=",
      "sourceCodeClassname": "HelloHyperty",
      "encoding": "Base64",
      "signature": ""
    },
    "language": "Javascript ECMA5",
    "signature": "",
    "messageSchemas": "",
    "configuration": "",
    "constraints": "",
    "hypertyCapabilities": "",
    "protocolCapabilities": "",
    "policies": "",
    "dataObjects": []
  },
  "WorldHyperty": {
    "cguid": "2",
    "type": "0",
    "version": "0.1",
    "description": "description of World Hyperty",
    "objectName": "WorldHyperty",
    "sourcePackageURL": "/sourcePackage",
    "sourcePackage": {},
    "language": "Javascript ECMA5",
    "signature": "",
    "messageSchemas": "",
    "configuration": "",
    "constraints": "",
    "hypertyCapabilities": "",
    "protocolCapabilities": "",
    "policies": "",
    "dataObjects": []
  },
  "HypertyConnector": {
    "sourcePackage": {
      "sourceCode": "KGZ1bmN0aW9uKGYpe2lmKHR5cGVvZiBleHBvcnRzPT09Im9iamVjdCImJnR5cGVvZiBtb2R1bGUhPT0idW5kZWZpbmVkIil7bW9kdWxlLmV4cG9ydHM9ZigpfWVsc2UgaWYodHlwZW9mIGRlZmluZT09PSJmdW5jdGlvbiImJmRlZmluZS5hbWQpe2RlZmluZShbXSxmKX1lbHNle3ZhciBnO2lmKHR5cGVvZiB3aW5kb3chPT0idW5kZWZpbmVkIil7Zz13aW5kb3d9ZWxzZSBpZih0eXBlb2YgZ2xvYmFsIT09InVuZGVmaW5lZCIpe2c9Z2xvYmFsfWVsc2UgaWYodHlwZW9mIHNlbGYhPT0idW5kZWZpbmVkIil7Zz1zZWxmfWVsc2V7Zz10aGlzfWcuYWN0aXZhdGUgPSBmKCl9fSkoZnVuY3Rpb24oKXt2YXIgZGVmaW5lLG1vZHVsZSxleHBvcnRzO3JldHVybiAoZnVuY3Rpb24gZSh0LG4scil7ZnVuY3Rpb24gcyhvLHUpe2lmKCFuW29dKXtpZighdFtvXSl7dmFyIGE9dHlwZW9mIHJlcXVpcmU9PSJmdW5jdGlvbiImJnJlcXVpcmU7aWYoIXUmJmEpcmV0dXJuIGEobywhMCk7aWYoaSlyZXR1cm4gaShvLCEwKTt2YXIgZj1uZXcgRXJyb3IoIkNhbm5vdCBmaW5kIG1vZHVsZSAnIitvKyInIik7dGhyb3cgZi5jb2RlPSJNT0RVTEVfTk9UX0ZPVU5EIixmfXZhciBsPW5bb109e2V4cG9ydHM6e319O3Rbb11bMF0uY2FsbChsLmV4cG9ydHMsZnVuY3Rpb24oZSl7dmFyIG49dFtvXVsxXVtlXTtyZXR1cm4gcyhuP246ZSl9LGwsbC5leHBvcnRzLGUsdCxuLHIpfXJldHVybiBuW29dLmV4cG9ydHN9dmFyIGk9dHlwZW9mIHJlcXVpcmU9PSJmdW5jdGlvbiImJnJlcXVpcmU7Zm9yKHZhciBvPTA7bzxyLmxlbmd0aDtvKyspcyhyW29dKTtyZXR1cm4gc30pKHsxOltmdW5jdGlvbihyZXF1aXJlLG1vZHVsZSxleHBvcnRzKXsKLyoKICogIENvcHlyaWdodCAoYykgMjAxNiBUaGUgV2ViUlRDIHByb2plY3QgYXV0aG9ycy4gQWxsIFJpZ2h0cyBSZXNlcnZlZC4KICoKICogIFVzZSBvZiB0aGlzIHNvdXJjZSBjb2RlIGlzIGdvdmVybmVkIGJ5IGEgQlNELXN0eWxlIGxpY2Vuc2UKICogIHRoYXQgY2FuIGJlIGZvdW5kIGluIHRoZSBMSUNFTlNFIGZpbGUgaW4gdGhlIHJvb3Qgb2YgdGhlIHNvdXJjZQogKiAgdHJlZS4KICovCgovKiBNb3JlIGluZm9ybWF0aW9uIGFib3V0IHRoZXNlIG9wdGlvbnMgYXQganNoaW50LmNvbS9kb2NzL29wdGlvbnMgKi8KLyoganNoaW50IGJyb3dzZXI6IHRydWUsIGNhbWVsY2FzZTogdHJ1ZSwgY3VybHk6IHRydWUsIGRldmVsOiB0cnVlLAogICBlcWVxZXE6IHRydWUsIGZvcmluOiBmYWxzZSwgZ2xvYmFsc3RyaWN0OiB0cnVlLCBub2RlOiB0cnVlLAogICBxdW90bWFyazogc2luZ2xlLCB1bmRlZjogdHJ1ZSwgdW51c2VkOiBzdHJpY3QgKi8KLyogZ2xvYmFsIG1velJUQ0ljZUNhbmRpZGF0ZSwgbW96UlRDUGVlckNvbm5lY3Rpb24sIFByb21pc2UsCm1velJUQ1Nlc3Npb25EZXNjcmlwdGlvbiwgd2Via2l0UlRDUGVlckNvbm5lY3Rpb24sIE1lZGlhU3RyZWFtVHJhY2ssCk1lZGlhU3RyZWFtLCBSVENJY2VHYXRoZXJlciwgUlRDSWNlVHJhbnNwb3J0LCBSVENEdGxzVHJhbnNwb3J0LApSVENSdHBTZW5kZXIsIFJUQ1J0cFJlY2VpdmVyKi8KLyogZXhwb3J0ZWQgdHJhY2UscmVxdWVzdFVzZXJNZWRpYSAqLwoKJ3VzZSBzdHJpY3QnOwoKdmFyIGdldFVzZXJNZWRpYSA9IG51bGw7CnZhciBhdHRhY2hNZWRpYVN0cmVhbSA9IG51bGw7CnZhciByZWF0dGFjaE1lZGlhU3RyZWFtID0gbnVsbDsKdmFyIHdlYnJ0Y0RldGVjdGVkQnJvd3NlciA9IG51bGw7CnZhciB3ZWJydGNEZXRlY3RlZFZlcnNpb24gPSBudWxsOwp2YXIgd2VicnRjTWluaW11bVZlcnNpb24gPSBudWxsOwp2YXIgd2VicnRjVXRpbHMgPSB7CiAgbG9nOiBmdW5jdGlvbigpIHsKICAgIC8vIHN1cHByZXNzIGNvbnNvbGUubG9nIG91dHB1dCB3aGVuIGJlaW5nIGluY2x1ZGVkIGFzIGEgbW9kdWxlLgogICAgaWYgKHR5cGVvZiBtb2R1bGUgIT09ICd1bmRlZmluZWQnIHx8CiAgICAgICAgdHlwZW9mIHJlcXVpcmUgPT09ICdmdW5jdGlvbicgJiYgdHlwZW9mIGRlZmluZSA9PT0gJ2Z1bmN0aW9uJykgewogICAgICByZXR1cm47CiAgICB9CiAgICBjb25zb2xlLmxvZy5hcHBseShjb25zb2xlLCBhcmd1bWVudHMpOwogIH0sCiAgZXh0cmFjdFZlcnNpb246IGZ1bmN0aW9uKHVhc3RyaW5nLCBleHByLCBwb3MpIHsKICAgIHZhciBtYXRjaCA9IHVhc3RyaW5nLm1hdGNoKGV4cHIpOwogICAgcmV0dXJuIG1hdGNoICYmIG1hdGNoLmxlbmd0aCA+PSBwb3MgJiYgcGFyc2VJbnQobWF0Y2hbcG9zXSwgMTApOwogIH0KfTsKCmZ1bmN0aW9uIHRyYWNlKHRleHQpIHsKICAvLyBUaGlzIGZ1bmN0aW9uIGlzIHVzZWQgZm9yIGxvZ2dpbmcuCiAgaWYgKHRleHRbdGV4dC5sZW5ndGggLSAxXSA9PT0gJ1xuJykgewogICAgdGV4dCA9IHRleHQuc3Vic3RyaW5nKDAsIHRleHQubGVuZ3RoIC0gMSk7CiAgfQogIGlmICh3aW5kb3cucGVyZm9ybWFuY2UpIHsKICAgIHZhciBub3cgPSAod2luZG93LnBlcmZvcm1hbmNlLm5vdygpIC8gMTAwMCkudG9GaXhlZCgzKTsKICAgIHdlYnJ0Y1V0aWxzLmxvZyhub3cgKyAnOiAnICsgdGV4dCk7CiAgfSBlbHNlIHsKICAgIHdlYnJ0Y1V0aWxzLmxvZyh0ZXh0KTsKICB9Cn0KCmlmICh0eXBlb2Ygd2luZG93ID09PSAnb2JqZWN0JykgewogIGlmICh3aW5kb3cuSFRNTE1lZGlhRWxlbWVudCAmJgogICAgISgnc3JjT2JqZWN0JyBpbiB3aW5kb3cuSFRNTE1lZGlhRWxlbWVudC5wcm90b3R5cGUpKSB7CiAgICAvLyBTaGltIHRoZSBzcmNPYmplY3QgcHJvcGVydHksIG9uY2UsIHdoZW4gSFRNTE1lZGlhRWxlbWVudCBpcyBmb3VuZC4KICAgIE9iamVjdC5kZWZpbmVQcm9wZXJ0eSh3aW5kb3cuSFRNTE1lZGlhRWxlbWVudC5wcm90b3R5cGUsICdzcmNPYmplY3QnLCB7CiAgICAgIGdldDogZnVuY3Rpb24oKSB7CiAgICAgICAgLy8gSWYgcHJlZml4ZWQgc3JjT2JqZWN0IHByb3BlcnR5IGV4aXN0cywgcmV0dXJuIGl0LgogICAgICAgIC8vIE90aGVyd2lzZSB1c2UgdGhlIHNoaW1tZWQgcHJvcGVydHksIF9zcmNPYmplY3QKICAgICAgICByZXR1cm4gJ21velNyY09iamVjdCcgaW4gdGhpcyA/IHRoaXMubW96U3JjT2JqZWN0IDogdGhpcy5fc3JjT2JqZWN0OwogICAgICB9LAogICAgICBzZXQ6IGZ1bmN0aW9uKHN0cmVhbSkgewogICAgICAgIGlmICgnbW96U3JjT2JqZWN0JyBpbiB0aGlzKSB7CiAgICAgICAgICB0aGlzLm1velNyY09iamVjdCA9IHN0cmVhbTsKICAgICAgICB9IGVsc2UgewogICAgICAgICAgLy8gVXNlIF9zcmNPYmplY3QgYXMgYSBwcml2YXRlIHByb3BlcnR5IGZvciB0aGlzIHNoaW0KICAgICAgICAgIHRoaXMuX3NyY09iamVjdCA9IHN0cmVhbTsKICAgICAgICAgIC8vIFRPRE86IHJldm9rZU9iamVjdFVybCh0aGlzLnNyYykgd2hlbiAhc3RyZWFtIHRvIHJlbGVhc2UgcmVzb3VyY2VzPwogICAgICAgICAgdGhpcy5zcmMgPSBVUkwuY3JlYXRlT2JqZWN0VVJMKHN0cmVhbSk7CiAgICAgICAgfQogICAgICB9CiAgICB9KTsKICB9CiAgLy8gUHJveHkgZXhpc3RpbmcgZ2xvYmFscwogIGdldFVzZXJNZWRpYSA9IHdpbmRvdy5uYXZpZ2F0b3IgJiYgd2luZG93Lm5hdmlnYXRvci5nZXRVc2VyTWVkaWE7Cn0KCi8vIEF0dGFjaCBhIG1lZGlhIHN0cmVhbSB0byBhbiBlbGVtZW50LgphdHRhY2hNZWRpYVN0cmVhbSA9IGZ1bmN0aW9uKGVsZW1lbnQsIHN0cmVhbSkgewogIGVsZW1lbnQuc3JjT2JqZWN0ID0gc3RyZWFtOwp9OwoKcmVhdHRhY2hNZWRpYVN0cmVhbSA9IGZ1bmN0aW9uKHRvLCBmcm9tKSB7CiAgdG8uc3JjT2JqZWN0ID0gZnJvbS5zcmNPYmplY3Q7Cn07CgppZiAodHlwZW9mIHdpbmRvdyA9PT0gJ3VuZGVmaW5lZCcgfHwgIXdpbmRvdy5uYXZpZ2F0b3IpIHsKICB3ZWJydGNVdGlscy5sb2coJ1RoaXMgZG9lcyBub3QgYXBwZWFyIHRvIGJlIGEgYnJvd3NlcicpOwogIHdlYnJ0Y0RldGVjdGVkQnJvd3NlciA9ICdub3QgYSBicm93c2VyJzsKfSBlbHNlIGlmIChuYXZpZ2F0b3IubW96R2V0VXNlck1lZGlhKSB7CiAgd2VicnRjVXRpbHMubG9nKCdUaGlzIGFwcGVhcnMgdG8gYmUgRmlyZWZveCcpOwoKICB3ZWJydGNEZXRlY3RlZEJyb3dzZXIgPSAnZmlyZWZveCc7CgogIC8vIHRoZSBkZXRlY3RlZCBmaXJlZm94IHZlcnNpb24uCiAgd2VicnRjRGV0ZWN0ZWRWZXJzaW9uID0gd2VicnRjVXRpbHMuZXh0cmFjdFZlcnNpb24obmF2aWdhdG9yLnVzZXJBZ2VudCwKICAgICAgL0ZpcmVmb3hcLyhbMC05XSspXC4vLCAxKTsKCiAgLy8gdGhlIG1pbmltdW0gZmlyZWZveCB2ZXJzaW9uIHN0aWxsIHN1cHBvcnRlZCBieSBhZGFwdGVyLgogIHdlYnJ0Y01pbmltdW1WZXJzaW9uID0gMzE7CgogIC8vIFNoaW0gZm9yIFJUQ1BlZXJDb25uZWN0aW9uIG9uIG9sZGVyIHZlcnNpb25zLgogIGlmICghd2luZG93LlJUQ1BlZXJDb25uZWN0aW9uKSB7CiAgICB3aW5kb3cuUlRDUGVlckNvbm5lY3Rpb24gPSBmdW5jdGlvbihwY0NvbmZpZywgcGNDb25zdHJhaW50cykgewogICAgICBpZiAod2VicnRjRGV0ZWN0ZWRWZXJzaW9uIDwgMzgpIHsKICAgICAgICAvLyAudXJscyBpcyBub3Qgc3VwcG9ydGVkIGluIEZGIDwgMzguCiAgICAgICAgLy8gY3JlYXRlIFJUQ0ljZVNlcnZlcnMgd2l0aCBhIHNpbmdsZSB1cmwuCiAgICAgICAgaWYgKHBjQ29uZmlnICYmIHBjQ29uZmlnLmljZVNlcnZlcnMpIHsKICAgICAgICAgIHZhciBuZXdJY2VTZXJ2ZXJzID0gW107CiAgICAgICAgICBmb3IgKHZhciBpID0gMDsgaSA8IHBjQ29uZmlnLmljZVNlcnZlcnMubGVuZ3RoOyBpKyspIHsKICAgICAgICAgICAgdmFyIHNlcnZlciA9IHBjQ29uZmlnLmljZVNlcnZlcnNbaV07CiAgICAgICAgICAgIGlmIChzZXJ2ZXIuaGFzT3duUHJvcGVydHkoJ3VybHMnKSkgewogICAgICAgICAgICAgIGZvciAodmFyIGogPSAwOyBqIDwgc2VydmVyLnVybHMubGVuZ3RoOyBqKyspIHsKICAgICAgICAgICAgICAgIHZhciBuZXdTZXJ2ZXIgPSB7CiAgICAgICAgICAgICAgICAgIHVybDogc2VydmVyLnVybHNbal0KICAgICAgICAgICAgICAgIH07CiAgICAgICAgICAgICAgICBpZiAoc2VydmVyLnVybHNbal0uaW5kZXhPZigndHVybicpID09PSAwKSB7CiAgICAgICAgICAgICAgICAgIG5ld1NlcnZlci51c2VybmFtZSA9IHNlcnZlci51c2VybmFtZTsKICAgICAgICAgICAgICAgICAgbmV3U2VydmVyLmNyZWRlbnRpYWwgPSBzZXJ2ZXIuY3JlZGVudGlhbDsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIG5ld0ljZVNlcnZlcnMucHVzaChuZXdTZXJ2ZXIpOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICBuZXdJY2VTZXJ2ZXJzLnB1c2gocGNDb25maWcuaWNlU2VydmVyc1tpXSk7CiAgICAgICAgICAgIH0KICAgICAgICAgIH0KICAgICAgICAgIHBjQ29uZmlnLmljZVNlcnZlcnMgPSBuZXdJY2VTZXJ2ZXJzOwogICAgICAgIH0KICAgICAgfQogICAgICByZXR1cm4gbmV3IG1velJUQ1BlZXJDb25uZWN0aW9uKHBjQ29uZmlnLCBwY0NvbnN0cmFpbnRzKTsgLy8ganNjczppZ25vcmUgcmVxdWlyZUNhcGl0YWxpemVkQ29uc3RydWN0b3JzCiAgICB9OwogICAgd2luZG93LlJUQ1BlZXJDb25uZWN0aW9uLnByb3RvdHlwZSA9IG1velJUQ1BlZXJDb25uZWN0aW9uLnByb3RvdHlwZTsKCiAgICAvLyB3cmFwIHN0YXRpYyBtZXRob2RzLiBDdXJyZW50bHkganVzdCBnZW5lcmF0ZUNlcnRpZmljYXRlLgogICAgaWYgKG1velJUQ1BlZXJDb25uZWN0aW9uLmdlbmVyYXRlQ2VydGlmaWNhdGUpIHsKICAgICAgT2JqZWN0LmRlZmluZVByb3BlcnR5KHdpbmRvdy5SVENQZWVyQ29ubmVjdGlvbiwgJ2dlbmVyYXRlQ2VydGlmaWNhdGUnLCB7CiAgICAgICAgZ2V0OiBmdW5jdGlvbigpIHsKICAgICAgICAgIGlmIChhcmd1bWVudHMubGVuZ3RoKSB7CiAgICAgICAgICAgIHJldHVybiBtb3pSVENQZWVyQ29ubmVjdGlvbi5nZW5lcmF0ZUNlcnRpZmljYXRlLmFwcGx5KG51bGwsCiAgICAgICAgICAgICAgICBhcmd1bWVudHMpOwogICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgcmV0dXJuIG1velJUQ1BlZXJDb25uZWN0aW9uLmdlbmVyYXRlQ2VydGlmaWNhdGU7CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICB9KTsKICAgIH0KCiAgICB3aW5kb3cuUlRDU2Vzc2lvbkRlc2NyaXB0aW9uID0gbW96UlRDU2Vzc2lvbkRlc2NyaXB0aW9uOwogICAgd2luZG93LlJUQ0ljZUNhbmRpZGF0ZSA9IG1velJUQ0ljZUNhbmRpZGF0ZTsKICB9CgogIC8vIGdldFVzZXJNZWRpYSBjb25zdHJhaW50cyBzaGltLgogIGdldFVzZXJNZWRpYSA9IGZ1bmN0aW9uKGNvbnN0cmFpbnRzLCBvblN1Y2Nlc3MsIG9uRXJyb3IpIHsKICAgIHZhciBjb25zdHJhaW50c1RvRkYzNyA9IGZ1bmN0aW9uKGMpIHsKICAgICAgaWYgKHR5cGVvZiBjICE9PSAnb2JqZWN0JyB8fCBjLnJlcXVpcmUpIHsKICAgICAgICByZXR1cm4gYzsKICAgICAgfQogICAgICB2YXIgcmVxdWlyZSA9IFtdOwogICAgICBPYmplY3Qua2V5cyhjKS5mb3JFYWNoKGZ1bmN0aW9uKGtleSkgewogICAgICAgIGlmIChrZXkgPT09ICdyZXF1aXJlJyB8fCBrZXkgPT09ICdhZHZhbmNlZCcgfHwga2V5ID09PSAnbWVkaWFTb3VyY2UnKSB7CiAgICAgICAgICByZXR1cm47CiAgICAgICAgfQogICAgICAgIHZhciByID0gY1trZXldID0gKHR5cGVvZiBjW2tleV0gPT09ICdvYmplY3QnKSA/CiAgICAgICAgICAgIGNba2V5XSA6IHtpZGVhbDogY1trZXldfTsKICAgICAgICBpZiAoci5taW4gIT09IHVuZGVmaW5lZCB8fAogICAgICAgICAgICByLm1heCAhPT0gdW5kZWZpbmVkIHx8IHIuZXhhY3QgIT09IHVuZGVmaW5lZCkgewogICAgICAgICAgcmVxdWlyZS5wdXNoKGtleSk7CiAgICAgICAgfQogICAgICAgIGlmIChyLmV4YWN0ICE9PSB1bmRlZmluZWQpIHsKICAgICAgICAgIGlmICh0eXBlb2Ygci5leGFjdCA9PT0gJ251bWJlcicpIHsKICAgICAgICAgICAgci5taW4gPSByLm1heCA9IHIuZXhhY3Q7CiAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICBjW2tleV0gPSByLmV4YWN0OwogICAgICAgICAgfQogICAgICAgICAgZGVsZXRlIHIuZXhhY3Q7CiAgICAgICAgfQogICAgICAgIGlmIChyLmlkZWFsICE9PSB1bmRlZmluZWQpIHsKICAgICAgICAgIGMuYWR2YW5jZWQgPSBjLmFkdmFuY2VkIHx8IFtdOwogICAgICAgICAgdmFyIG9jID0ge307CiAgICAgICAgICBpZiAodHlwZW9mIHIuaWRlYWwgPT09ICdudW1iZXInKSB7CiAgICAgICAgICAgIG9jW2tleV0gPSB7bWluOiByLmlkZWFsLCBtYXg6IHIuaWRlYWx9OwogICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgb2Nba2V5XSA9IHIuaWRlYWw7CiAgICAgICAgICB9CiAgICAgICAgICBjLmFkdmFuY2VkLnB1c2gob2MpOwogICAgICAgICAgZGVsZXRlIHIuaWRlYWw7CiAgICAgICAgICBpZiAoIU9iamVjdC5rZXlzKHIpLmxlbmd0aCkgewogICAgICAgICAgICBkZWxldGUgY1trZXldOwogICAgICAgICAgfQogICAgICAgIH0KICAgICAgfSk7CiAgICAgIGlmIChyZXF1aXJlLmxlbmd0aCkgewogICAgICAgIGMucmVxdWlyZSA9IHJlcXVpcmU7CiAgICAgIH0KICAgICAgcmV0dXJuIGM7CiAgICB9OwogICAgaWYgKHdlYnJ0Y0RldGVjdGVkVmVyc2lvbiA8IDM4KSB7CiAgICAgIHdlYnJ0Y1V0aWxzLmxvZygnc3BlYzogJyArIEpTT04uc3RyaW5naWZ5KGNvbnN0cmFpbnRzKSk7CiAgICAgIGlmIChjb25zdHJhaW50cy5hdWRpbykgewogICAgICAgIGNvbnN0cmFpbnRzLmF1ZGlvID0gY29uc3RyYWludHNUb0ZGMzcoY29uc3RyYWludHMuYXVkaW8pOwogICAgICB9CiAgICAgIGlmIChjb25zdHJhaW50cy52aWRlbykgewogICAgICAgIGNvbnN0cmFpbnRzLnZpZGVvID0gY29uc3RyYWludHNUb0ZGMzcoY29uc3RyYWludHMudmlkZW8pOwogICAgICB9CiAgICAgIHdlYnJ0Y1V0aWxzLmxvZygnZmYzNzogJyArIEpTT04uc3RyaW5naWZ5KGNvbnN0cmFpbnRzKSk7CiAgICB9CiAgICByZXR1cm4gbmF2aWdhdG9yLm1vekdldFVzZXJNZWRpYShjb25zdHJhaW50cywgb25TdWNjZXNzLCBvbkVycm9yKTsKICB9OwoKICBuYXZpZ2F0b3IuZ2V0VXNlck1lZGlhID0gZ2V0VXNlck1lZGlhOwoKICAvLyBTaGltIGZvciBtZWRpYURldmljZXMgb24gb2xkZXIgdmVyc2lvbnMuCiAgaWYgKCFuYXZpZ2F0b3IubWVkaWFEZXZpY2VzKSB7CiAgICBuYXZpZ2F0b3IubWVkaWFEZXZpY2VzID0ge2dldFVzZXJNZWRpYTogcmVxdWVzdFVzZXJNZWRpYSwKICAgICAgYWRkRXZlbnRMaXN0ZW5lcjogZnVuY3Rpb24oKSB7IH0sCiAgICAgIHJlbW92ZUV2ZW50TGlzdGVuZXI6IGZ1bmN0aW9uKCkgeyB9CiAgICB9OwogIH0KICBuYXZpZ2F0b3IubWVkaWFEZXZpY2VzLmVudW1lcmF0ZURldmljZXMgPQogICAgICBuYXZpZ2F0b3IubWVkaWFEZXZpY2VzLmVudW1lcmF0ZURldmljZXMgfHwgZnVuY3Rpb24oKSB7CiAgICByZXR1cm4gbmV3IFByb21pc2UoZnVuY3Rpb24ocmVzb2x2ZSkgewogICAgICB2YXIgaW5mb3MgPSBbCiAgICAgICAge2tpbmQ6ICdhdWRpb2lucHV0JywgZGV2aWNlSWQ6ICdkZWZhdWx0JywgbGFiZWw6ICcnLCBncm91cElkOiAnJ30sCiAgICAgICAge2tpbmQ6ICd2aWRlb2lucHV0JywgZGV2aWNlSWQ6ICdkZWZhdWx0JywgbGFiZWw6ICcnLCBncm91cElkOiAnJ30KICAgICAgXTsKICAgICAgcmVzb2x2ZShpbmZvcyk7CiAgICB9KTsKICB9OwoKICBpZiAod2VicnRjRGV0ZWN0ZWRWZXJzaW9uIDwgNDEpIHsKICAgIC8vIFdvcmsgYXJvdW5kIGh0dHA6Ly9idWd6aWwubGEvMTE2OTY2NQogICAgdmFyIG9yZ0VudW1lcmF0ZURldmljZXMgPQogICAgICAgIG5hdmlnYXRvci5tZWRpYURldmljZXMuZW51bWVyYXRlRGV2aWNlcy5iaW5kKG5hdmlnYXRvci5tZWRpYURldmljZXMpOwogICAgbmF2aWdhdG9yLm1lZGlhRGV2aWNlcy5lbnVtZXJhdGVEZXZpY2VzID0gZnVuY3Rpb24oKSB7CiAgICAgIHJldHVybiBvcmdFbnVtZXJhdGVEZXZpY2VzKCkudGhlbih1bmRlZmluZWQsIGZ1bmN0aW9uKGUpIHsKICAgICAgICBpZiAoZS5uYW1lID09PSAnTm90Rm91bmRFcnJvcicpIHsKICAgICAgICAgIHJldHVybiBbXTsKICAgICAgICB9CiAgICAgICAgdGhyb3cgZTsKICAgICAgfSk7CiAgICB9OwogIH0KfSBlbHNlIGlmIChuYXZpZ2F0b3Iud2Via2l0R2V0VXNlck1lZGlhICYmIHdpbmRvdy53ZWJraXRSVENQZWVyQ29ubmVjdGlvbikgewogIHdlYnJ0Y1V0aWxzLmxvZygnVGhpcyBhcHBlYXJzIHRvIGJlIENocm9tZScpOwoKICB3ZWJydGNEZXRlY3RlZEJyb3dzZXIgPSAnY2hyb21lJzsKCiAgLy8gdGhlIGRldGVjdGVkIGNocm9tZSB2ZXJzaW9uLgogIHdlYnJ0Y0RldGVjdGVkVmVyc2lvbiA9IHdlYnJ0Y1V0aWxzLmV4dHJhY3RWZXJzaW9uKG5hdmlnYXRvci51c2VyQWdlbnQsCiAgICAgIC9DaHJvbShlfGl1bSlcLyhbMC05XSspXC4vLCAyKTsKCiAgLy8gdGhlIG1pbmltdW0gY2hyb21lIHZlcnNpb24gc3RpbGwgc3VwcG9ydGVkIGJ5IGFkYXB0ZXIuCiAgd2VicnRjTWluaW11bVZlcnNpb24gPSAzODsKCiAgLy8gVGhlIFJUQ1BlZXJDb25uZWN0aW9uIG9iamVjdC4KICB3aW5kb3cuUlRDUGVlckNvbm5lY3Rpb24gPSBmdW5jdGlvbihwY0NvbmZpZywgcGNDb25zdHJhaW50cykgewogICAgLy8gVHJhbnNsYXRlIGljZVRyYW5zcG9ydFBvbGljeSB0byBpY2VUcmFuc3BvcnRzLAogICAgLy8gc2VlIGh0dHBzOi8vY29kZS5nb29nbGUuY29tL3Avd2VicnRjL2lzc3Vlcy9kZXRhaWw/aWQ9NDg2OQogICAgaWYgKHBjQ29uZmlnICYmIHBjQ29uZmlnLmljZVRyYW5zcG9ydFBvbGljeSkgewogICAgICBwY0NvbmZpZy5pY2VUcmFuc3BvcnRzID0gcGNDb25maWcuaWNlVHJhbnNwb3J0UG9saWN5OwogICAgfQoKICAgIHZhciBwYyA9IG5ldyB3ZWJraXRSVENQZWVyQ29ubmVjdGlvbihwY0NvbmZpZywgcGNDb25zdHJhaW50cyk7IC8vIGpzY3M6aWdub3JlIHJlcXVpcmVDYXBpdGFsaXplZENvbnN0cnVjdG9ycwogICAgdmFyIG9yaWdHZXRTdGF0cyA9IHBjLmdldFN0YXRzLmJpbmQocGMpOwogICAgcGMuZ2V0U3RhdHMgPSBmdW5jdGlvbihzZWxlY3Rvciwgc3VjY2Vzc0NhbGxiYWNrLCBlcnJvckNhbGxiYWNrKSB7IC8vIGpzaGludCBpZ25vcmU6IGxpbmUKICAgICAgdmFyIHNlbGYgPSB0aGlzOwogICAgICB2YXIgYXJncyA9IGFyZ3VtZW50czsKCiAgICAgIC8vIElmIHNlbGVjdG9yIGlzIGEgZnVuY3Rpb24gdGhlbiB3ZSBhcmUgaW4gdGhlIG9sZCBzdHlsZSBzdGF0cyBzbyBqdXN0CiAgICAgIC8vIHBhc3MgYmFjayB0aGUgb3JpZ2luYWwgZ2V0U3RhdHMgZm9ybWF0IHRvIGF2b2lkIGJyZWFraW5nIG9sZCB1c2Vycy4KICAgICAgaWYgKGFyZ3VtZW50cy5sZW5ndGggPiAwICYmIHR5cGVvZiBzZWxlY3RvciA9PT0gJ2Z1bmN0aW9uJykgewogICAgICAgIHJldHVybiBvcmlnR2V0U3RhdHMoc2VsZWN0b3IsIHN1Y2Nlc3NDYWxsYmFjayk7CiAgICAgIH0KCiAgICAgIHZhciBmaXhDaHJvbWVTdGF0cyA9IGZ1bmN0aW9uKHJlc3BvbnNlKSB7CiAgICAgICAgdmFyIHN0YW5kYXJkUmVwb3J0ID0ge307CiAgICAgICAgdmFyIHJlcG9ydHMgPSByZXNwb25zZS5yZXN1bHQoKTsKICAgICAgICByZXBvcnRzLmZvckVhY2goZnVuY3Rpb24ocmVwb3J0KSB7CiAgICAgICAgICB2YXIgc3RhbmRhcmRTdGF0cyA9IHsKICAgICAgICAgICAgaWQ6IHJlcG9ydC5pZCwKICAgICAgICAgICAgdGltZXN0YW1wOiByZXBvcnQudGltZXN0YW1wLAogICAgICAgICAgICB0eXBlOiByZXBvcnQudHlwZQogICAgICAgICAgfTsKICAgICAgICAgIHJlcG9ydC5uYW1lcygpLmZvckVhY2goZnVuY3Rpb24obmFtZSkgewogICAgICAgICAgICBzdGFuZGFyZFN0YXRzW25hbWVdID0gcmVwb3J0LnN0YXQobmFtZSk7CiAgICAgICAgICB9KTsKICAgICAgICAgIHN0YW5kYXJkUmVwb3J0W3N0YW5kYXJkU3RhdHMuaWRdID0gc3RhbmRhcmRTdGF0czsKICAgICAgICB9KTsKCiAgICAgICAgcmV0dXJuIHN0YW5kYXJkUmVwb3J0OwogICAgICB9OwoKICAgICAgaWYgKGFyZ3VtZW50cy5sZW5ndGggPj0gMikgewogICAgICAgIHZhciBzdWNjZXNzQ2FsbGJhY2tXcmFwcGVyID0gZnVuY3Rpb24ocmVzcG9uc2UpIHsKICAgICAgICAgIGFyZ3NbMV0oZml4Q2hyb21lU3RhdHMocmVzcG9uc2UpKTsKICAgICAgICB9OwoKICAgICAgICByZXR1cm4gb3JpZ0dldFN0YXRzLmFwcGx5KHRoaXMsIFtzdWNjZXNzQ2FsbGJhY2tXcmFwcGVyLCBhcmd1bWVudHNbMF1dKTsKICAgICAgfQoKICAgICAgLy8gcHJvbWlzZS1zdXBwb3J0CiAgICAgIHJldHVybiBuZXcgUHJvbWlzZShmdW5jdGlvbihyZXNvbHZlLCByZWplY3QpIHsKICAgICAgICBpZiAoYXJncy5sZW5ndGggPT09IDEgJiYgc2VsZWN0b3IgPT09IG51bGwpIHsKICAgICAgICAgIG9yaWdHZXRTdGF0cy5hcHBseShzZWxmLCBbCiAgICAgICAgICAgICAgZnVuY3Rpb24ocmVzcG9uc2UpIHsKICAgICAgICAgICAgICAgIHJlc29sdmUuYXBwbHkobnVsbCwgW2ZpeENocm9tZVN0YXRzKHJlc3BvbnNlKV0pOwogICAgICAgICAgICAgIH0sIHJlamVjdF0pOwogICAgICAgIH0gZWxzZSB7CiAgICAgICAgICBvcmlnR2V0U3RhdHMuYXBwbHkoc2VsZiwgW3Jlc29sdmUsIHJlamVjdF0pOwogICAgICAgIH0KICAgICAgfSk7CiAgICB9OwoKICAgIHJldHVybiBwYzsKICB9OwogIHdpbmRvdy5SVENQZWVyQ29ubmVjdGlvbi5wcm90b3R5cGUgPSB3ZWJraXRSVENQZWVyQ29ubmVjdGlvbi5wcm90b3R5cGU7CgogIC8vIHdyYXAgc3RhdGljIG1ldGhvZHMuIEN1cnJlbnRseSBqdXN0IGdlbmVyYXRlQ2VydGlmaWNhdGUuCiAgaWYgKHdlYmtpdFJUQ1BlZXJDb25uZWN0aW9uLmdlbmVyYXRlQ2VydGlmaWNhdGUpIHsKICAgIE9iamVjdC5kZWZpbmVQcm9wZXJ0eSh3aW5kb3cuUlRDUGVlckNvbm5lY3Rpb24sICdnZW5lcmF0ZUNlcnRpZmljYXRlJywgewogICAgICBnZXQ6IGZ1bmN0aW9uKCkgewogICAgICAgIGlmIChhcmd1bWVudHMubGVuZ3RoKSB7CiAgICAgICAgICByZXR1cm4gd2Via2l0UlRDUGVlckNvbm5lY3Rpb24uZ2VuZXJhdGVDZXJ0aWZpY2F0ZS5hcHBseShudWxsLAogICAgICAgICAgICAgIGFyZ3VtZW50cyk7CiAgICAgICAgfSBlbHNlIHsKICAgICAgICAgIHJldHVybiB3ZWJraXRSVENQZWVyQ29ubmVjdGlvbi5nZW5lcmF0ZUNlcnRpZmljYXRlOwogICAgICAgIH0KICAgICAgfQogICAgfSk7CiAgfQoKICAvLyBhZGQgcHJvbWlzZSBzdXBwb3J0CiAgWydjcmVhdGVPZmZlcicsICdjcmVhdGVBbnN3ZXInXS5mb3JFYWNoKGZ1bmN0aW9uKG1ldGhvZCkgewogICAgdmFyIG5hdGl2ZU1ldGhvZCA9IHdlYmtpdFJUQ1BlZXJDb25uZWN0aW9uLnByb3RvdHlwZVttZXRob2RdOwogICAgd2Via2l0UlRDUGVlckNvbm5lY3Rpb24ucHJvdG90eXBlW21ldGhvZF0gPSBmdW5jdGlvbigpIHsKICAgICAgdmFyIHNlbGYgPSB0aGlzOwogICAgICBpZiAoYXJndW1lbnRzLmxlbmd0aCA8IDEgfHwgKGFyZ3VtZW50cy5sZW5ndGggPT09IDEgJiYKICAgICAgICAgIHR5cGVvZihhcmd1bWVudHNbMF0pID09PSAnb2JqZWN0JykpIHsKICAgICAgICB2YXIgb3B0cyA9IGFyZ3VtZW50cy5sZW5ndGggPT09IDEgPyBhcmd1bWVudHNbMF0gOiB1bmRlZmluZWQ7CiAgICAgICAgcmV0dXJuIG5ldyBQcm9taXNlKGZ1bmN0aW9uKHJlc29sdmUsIHJlamVjdCkgewogICAgICAgICAgbmF0aXZlTWV0aG9kLmFwcGx5KHNlbGYsIFtyZXNvbHZlLCByZWplY3QsIG9wdHNdKTsKICAgICAgICB9KTsKICAgICAgfSBlbHNlIHsKICAgICAgICByZXR1cm4gbmF0aXZlTWV0aG9kLmFwcGx5KHRoaXMsIGFyZ3VtZW50cyk7CiAgICAgIH0KICAgIH07CiAgfSk7CgogIFsnc2V0TG9jYWxEZXNjcmlwdGlvbicsICdzZXRSZW1vdGVEZXNjcmlwdGlvbicsCiAgICAgICdhZGRJY2VDYW5kaWRhdGUnXS5mb3JFYWNoKGZ1bmN0aW9uKG1ldGhvZCkgewogICAgdmFyIG5hdGl2ZU1ldGhvZCA9IHdlYmtpdFJUQ1BlZXJDb25uZWN0aW9uLnByb3RvdHlwZVttZXRob2RdOwogICAgd2Via2l0UlRDUGVlckNvbm5lY3Rpb24ucHJvdG90eXBlW21ldGhvZF0gPSBmdW5jdGlvbigpIHsKICAgICAgdmFyIGFyZ3MgPSBhcmd1bWVudHM7CiAgICAgIHZhciBzZWxmID0gdGhpczsKICAgICAgcmV0dXJuIG5ldyBQcm9taXNlKGZ1bmN0aW9uKHJlc29sdmUsIHJlamVjdCkgewogICAgICAgIG5hdGl2ZU1ldGhvZC5hcHBseShzZWxmLCBbYXJnc1swXSwKICAgICAgICAgICAgZnVuY3Rpb24oKSB7CiAgICAgICAgICAgICAgcmVzb2x2ZSgpOwogICAgICAgICAgICAgIGlmIChhcmdzLmxlbmd0aCA+PSAyKSB7CiAgICAgICAgICAgICAgICBhcmdzWzFdLmFwcGx5KG51bGwsIFtdKTsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0sCiAgICAgICAgICAgIGZ1bmN0aW9uKGVycikgewogICAgICAgICAgICAgIHJlamVjdChlcnIpOwogICAgICAgICAgICAgIGlmIChhcmdzLmxlbmd0aCA+PSAzKSB7CiAgICAgICAgICAgICAgICBhcmdzWzJdLmFwcGx5KG51bGwsIFtlcnJdKTsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH1dCiAgICAgICAgICApOwogICAgICB9KTsKICAgIH07CiAgfSk7CgogIC8vIGdldFVzZXJNZWRpYSBjb25zdHJhaW50cyBzaGltLgogIHZhciBjb25zdHJhaW50c1RvQ2hyb21lID0gZnVuY3Rpb24oYykgewogICAgaWYgKHR5cGVvZiBjICE9PSAnb2JqZWN0JyB8fCBjLm1hbmRhdG9yeSB8fCBjLm9wdGlvbmFsKSB7CiAgICAgIHJldHVybiBjOwogICAgfQogICAgdmFyIGNjID0ge307CiAgICBPYmplY3Qua2V5cyhjKS5mb3JFYWNoKGZ1bmN0aW9uKGtleSkgewogICAgICBpZiAoa2V5ID09PSAncmVxdWlyZScgfHwga2V5ID09PSAnYWR2YW5jZWQnIHx8IGtleSA9PT0gJ21lZGlhU291cmNlJykgewogICAgICAgIHJldHVybjsKICAgICAgfQogICAgICB2YXIgciA9ICh0eXBlb2YgY1trZXldID09PSAnb2JqZWN0JykgPyBjW2tleV0gOiB7aWRlYWw6IGNba2V5XX07CiAgICAgIGlmIChyLmV4YWN0ICE9PSB1bmRlZmluZWQgJiYgdHlwZW9mIHIuZXhhY3QgPT09ICdudW1iZXInKSB7CiAgICAgICAgci5taW4gPSByLm1heCA9IHIuZXhhY3Q7CiAgICAgIH0KICAgICAgdmFyIG9sZG5hbWUgPSBmdW5jdGlvbihwcmVmaXgsIG5hbWUpIHsKICAgICAgICBpZiAocHJlZml4KSB7CiAgICAgICAgICByZXR1cm4gcHJlZml4ICsgbmFtZS5jaGFyQXQoMCkudG9VcHBlckNhc2UoKSArIG5hbWUuc2xpY2UoMSk7CiAgICAgICAgfQogICAgICAgIHJldHVybiAobmFtZSA9PT0gJ2RldmljZUlkJykgPyAnc291cmNlSWQnIDogbmFtZTsKICAgICAgfTsKICAgICAgaWYgKHIuaWRlYWwgIT09IHVuZGVmaW5lZCkgewogICAgICAgIGNjLm9wdGlvbmFsID0gY2Mub3B0aW9uYWwgfHwgW107CiAgICAgICAgdmFyIG9jID0ge307CiAgICAgICAgaWYgKHR5cGVvZiByLmlkZWFsID09PSAnbnVtYmVyJykgewogICAgICAgICAgb2Nbb2xkbmFtZSgnbWluJywga2V5KV0gPSByLmlkZWFsOwogICAgICAgICAgY2Mub3B0aW9uYWwucHVzaChvYyk7CiAgICAgICAgICBvYyA9IHt9OwogICAgICAgICAgb2Nbb2xkbmFtZSgnbWF4Jywga2V5KV0gPSByLmlkZWFsOwogICAgICAgICAgY2Mub3B0aW9uYWwucHVzaChvYyk7CiAgICAgICAgfSBlbHNlIHsKICAgICAgICAgIG9jW29sZG5hbWUoJycsIGtleSldID0gci5pZGVhbDsKICAgICAgICAgIGNjLm9wdGlvbmFsLnB1c2gob2MpOwogICAgICAgIH0KICAgICAgfQogICAgICBpZiAoci5leGFjdCAhPT0gdW5kZWZpbmVkICYmIHR5cGVvZiByLmV4YWN0ICE9PSAnbnVtYmVyJykgewogICAgICAgIGNjLm1hbmRhdG9yeSA9IGNjLm1hbmRhdG9yeSB8fCB7fTsKICAgICAgICBjYy5tYW5kYXRvcnlbb2xkbmFtZSgnJywga2V5KV0gPSByLmV4YWN0OwogICAgICB9IGVsc2UgewogICAgICAgIFsnbWluJywgJ21heCddLmZvckVhY2goZnVuY3Rpb24obWl4KSB7CiAgICAgICAgICBpZiAoclttaXhdICE9PSB1bmRlZmluZWQpIHsKICAgICAgICAgICAgY2MubWFuZGF0b3J5ID0gY2MubWFuZGF0b3J5IHx8IHt9OwogICAgICAgICAgICBjYy5tYW5kYXRvcnlbb2xkbmFtZShtaXgsIGtleSldID0gclttaXhdOwogICAgICAgICAgfQogICAgICAgIH0pOwogICAgICB9CiAgICB9KTsKICAgIGlmIChjLmFkdmFuY2VkKSB7CiAgICAgIGNjLm9wdGlvbmFsID0gKGNjLm9wdGlvbmFsIHx8IFtdKS5jb25jYXQoYy5hZHZhbmNlZCk7CiAgICB9CiAgICByZXR1cm4gY2M7CiAgfTsKCiAgZ2V0VXNlck1lZGlhID0gZnVuY3Rpb24oY29uc3RyYWludHMsIG9uU3VjY2Vzcywgb25FcnJvcikgewogICAgaWYgKGNvbnN0cmFpbnRzLmF1ZGlvKSB7CiAgICAgIGNvbnN0cmFpbnRzLmF1ZGlvID0gY29uc3RyYWludHNUb0Nocm9tZShjb25zdHJhaW50cy5hdWRpbyk7CiAgICB9CiAgICBpZiAoY29uc3RyYWludHMudmlkZW8pIHsKICAgICAgY29uc3RyYWludHMudmlkZW8gPSBjb25zdHJhaW50c1RvQ2hyb21lKGNvbnN0cmFpbnRzLnZpZGVvKTsKICAgIH0KICAgIHdlYnJ0Y1V0aWxzLmxvZygnY2hyb21lOiAnICsgSlNPTi5zdHJpbmdpZnkoY29uc3RyYWludHMpKTsKICAgIHJldHVybiBuYXZpZ2F0b3Iud2Via2l0R2V0VXNlck1lZGlhKGNvbnN0cmFpbnRzLCBvblN1Y2Nlc3MsIG9uRXJyb3IpOwogIH07CiAgbmF2aWdhdG9yLmdldFVzZXJNZWRpYSA9IGdldFVzZXJNZWRpYTsKCiAgaWYgKCFuYXZpZ2F0b3IubWVkaWFEZXZpY2VzKSB7CiAgICBuYXZpZ2F0b3IubWVkaWFEZXZpY2VzID0ge2dldFVzZXJNZWRpYTogcmVxdWVzdFVzZXJNZWRpYSwKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgZW51bWVyYXRlRGV2aWNlczogZnVuY3Rpb24oKSB7CiAgICAgIHJldHVybiBuZXcgUHJvbWlzZShmdW5jdGlvbihyZXNvbHZlKSB7CiAgICAgICAgdmFyIGtpbmRzID0ge2F1ZGlvOiAnYXVkaW9pbnB1dCcsIHZpZGVvOiAndmlkZW9pbnB1dCd9OwogICAgICAgIHJldHVybiBNZWRpYVN0cmVhbVRyYWNrLmdldFNvdXJjZXMoZnVuY3Rpb24oZGV2aWNlcykgewogICAgICAgICAgcmVzb2x2ZShkZXZpY2VzLm1hcChmdW5jdGlvbihkZXZpY2UpIHsKICAgICAgICAgICAgcmV0dXJuIHtsYWJlbDogZGV2aWNlLmxhYmVsLAogICAgICAgICAgICAgICAgICAgIGtpbmQ6IGtpbmRzW2RldmljZS5raW5kXSwKICAgICAgICAgICAgICAgICAgICBkZXZpY2VJZDogZGV2aWNlLmlkLAogICAgICAgICAgICAgICAgICAgIGdyb3VwSWQ6ICcnfTsKICAgICAgICAgIH0pKTsKICAgICAgICB9KTsKICAgICAgfSk7CiAgICB9fTsKICB9CgogIC8vIEEgc2hpbSBmb3IgZ2V0VXNlck1lZGlhIG1ldGhvZCBvbiB0aGUgbWVkaWFEZXZpY2VzIG9iamVjdC4KICAvLyBUT0RPKEthcHRlbkphbnNzb24pIHJlbW92ZSBvbmNlIGltcGxlbWVudGVkIGluIENocm9tZSBzdGFibGUuCiAgaWYgKCFuYXZpZ2F0b3IubWVkaWFEZXZpY2VzLmdldFVzZXJNZWRpYSkgewogICAgbmF2aWdhdG9yLm1lZGlhRGV2aWNlcy5nZXRVc2VyTWVkaWEgPSBmdW5jdGlvbihjb25zdHJhaW50cykgewogICAgICByZXR1cm4gcmVxdWVzdFVzZXJNZWRpYShjb25zdHJhaW50cyk7CiAgICB9OwogIH0gZWxzZSB7CiAgICAvLyBFdmVuIHRob3VnaCBDaHJvbWUgNDUgaGFzIG5hdmlnYXRvci5tZWRpYURldmljZXMgYW5kIGEgZ2V0VXNlck1lZGlhCiAgICAvLyBmdW5jdGlvbiB3aGljaCByZXR1cm5zIGEgUHJvbWlzZSwgaXQgZG9lcyBub3QgYWNjZXB0IHNwZWMtc3R5bGUKICAgIC8vIGNvbnN0cmFpbnRzLgogICAgdmFyIG9yaWdHZXRVc2VyTWVkaWEgPSBuYXZpZ2F0b3IubWVkaWFEZXZpY2VzLmdldFVzZXJNZWRpYS4KICAgICAgICBiaW5kKG5hdmlnYXRvci5tZWRpYURldmljZXMpOwogICAgbmF2aWdhdG9yLm1lZGlhRGV2aWNlcy5nZXRVc2VyTWVkaWEgPSBmdW5jdGlvbihjKSB7CiAgICAgIHdlYnJ0Y1V0aWxzLmxvZygnc3BlYzogICAnICsgSlNPTi5zdHJpbmdpZnkoYykpOyAvLyB3aGl0ZXNwYWNlIGZvciBhbGlnbm1lbnQKICAgICAgYy5hdWRpbyA9IGNvbnN0cmFpbnRzVG9DaHJvbWUoYy5hdWRpbyk7CiAgICAgIGMudmlkZW8gPSBjb25zdHJhaW50c1RvQ2hyb21lKGMudmlkZW8pOwogICAgICB3ZWJydGNVdGlscy5sb2coJ2Nocm9tZTogJyArIEpTT04uc3RyaW5naWZ5KGMpKTsKICAgICAgcmV0dXJuIG9yaWdHZXRVc2VyTWVkaWEoYyk7CiAgICB9OwogIH0KCiAgLy8gRHVtbXkgZGV2aWNlY2hhbmdlIGV2ZW50IG1ldGhvZHMuCiAgLy8gVE9ETyhLYXB0ZW5KYW5zc29uKSByZW1vdmUgb25jZSBpbXBsZW1lbnRlZCBpbiBDaHJvbWUgc3RhYmxlLgogIGlmICh0eXBlb2YgbmF2aWdhdG9yLm1lZGlhRGV2aWNlcy5hZGRFdmVudExpc3RlbmVyID09PSAndW5kZWZpbmVkJykgewogICAgbmF2aWdhdG9yLm1lZGlhRGV2aWNlcy5hZGRFdmVudExpc3RlbmVyID0gZnVuY3Rpb24oKSB7CiAgICAgIHdlYnJ0Y1V0aWxzLmxvZygnRHVtbXkgbWVkaWFEZXZpY2VzLmFkZEV2ZW50TGlzdGVuZXIgY2FsbGVkLicpOwogICAgfTsKICB9CiAgaWYgKHR5cGVvZiBuYXZpZ2F0b3IubWVkaWFEZXZpY2VzLnJlbW92ZUV2ZW50TGlzdGVuZXIgPT09ICd1bmRlZmluZWQnKSB7CiAgICBuYXZpZ2F0b3IubWVkaWFEZXZpY2VzLnJlbW92ZUV2ZW50TGlzdGVuZXIgPSBmdW5jdGlvbigpIHsKICAgICAgd2VicnRjVXRpbHMubG9nKCdEdW1teSBtZWRpYURldmljZXMucmVtb3ZlRXZlbnRMaXN0ZW5lciBjYWxsZWQuJyk7CiAgICB9OwogIH0KCiAgLy8gQXR0YWNoIGEgbWVkaWEgc3RyZWFtIHRvIGFuIGVsZW1lbnQuCiAgYXR0YWNoTWVkaWFTdHJlYW0gPSBmdW5jdGlvbihlbGVtZW50LCBzdHJlYW0pIHsKICAgIGlmICh3ZWJydGNEZXRlY3RlZFZlcnNpb24gPj0gNDMpIHsKICAgICAgZWxlbWVudC5zcmNPYmplY3QgPSBzdHJlYW07CiAgICB9IGVsc2UgaWYgKHR5cGVvZiBlbGVtZW50LnNyYyAhPT0gJ3VuZGVmaW5lZCcpIHsKICAgICAgZWxlbWVudC5zcmMgPSBVUkwuY3JlYXRlT2JqZWN0VVJMKHN0cmVhbSk7CiAgICB9IGVsc2UgewogICAgICB3ZWJydGNVdGlscy5sb2coJ0Vycm9yIGF0dGFjaGluZyBzdHJlYW0gdG8gZWxlbWVudC4nKTsKICAgIH0KICB9OwogIHJlYXR0YWNoTWVkaWFTdHJlYW0gPSBmdW5jdGlvbih0bywgZnJvbSkgewogICAgaWYgKHdlYnJ0Y0RldGVjdGVkVmVyc2lvbiA+PSA0MykgewogICAgICB0by5zcmNPYmplY3QgPSBmcm9tLnNyY09iamVjdDsKICAgIH0gZWxzZSB7CiAgICAgIHRvLnNyYyA9IGZyb20uc3JjOwogICAgfQogIH07Cgp9IGVsc2UgaWYgKG5hdmlnYXRvci5tZWRpYURldmljZXMgJiYgbmF2aWdhdG9yLnVzZXJBZ2VudC5tYXRjaCgKICAgIC9FZGdlXC8oXGQrKS4oXGQrKSQvKSkgewogIHdlYnJ0Y1V0aWxzLmxvZygnVGhpcyBhcHBlYXJzIHRvIGJlIEVkZ2UnKTsKICB3ZWJydGNEZXRlY3RlZEJyb3dzZXIgPSAnZWRnZSc7CgogIHdlYnJ0Y0RldGVjdGVkVmVyc2lvbiA9IHdlYnJ0Y1V0aWxzLmV4dHJhY3RWZXJzaW9uKG5hdmlnYXRvci51c2VyQWdlbnQsCiAgICAgIC9FZGdlXC8oXGQrKS4oXGQrKSQvLCAyKTsKCiAgLy8gVGhlIG1pbmltdW0gdmVyc2lvbiBzdGlsbCBzdXBwb3J0ZWQgYnkgYWRhcHRlci4KICAvLyBUaGlzIGlzIHRoZSBidWlsZCBudW1iZXIgZm9yIEVkZ2UuCiAgd2VicnRjTWluaW11bVZlcnNpb24gPSAxMDU0NzsKCiAgaWYgKHdpbmRvdy5SVENJY2VHYXRoZXJlcikgewogICAgLy8gR2VuZXJhdGUgYW4gYWxwaGFudW1lcmljIGlkZW50aWZpZXIgZm9yIGNuYW1lIG9yIG1pZHMuCiAgICAvLyBUT0RPOiB1c2UgVVVJRHMgaW5zdGVhZD8gaHR0cHM6Ly9naXN0LmdpdGh1Yi5jb20vamVkLzk4Mjg4MwogICAgdmFyIGdlbmVyYXRlSWRlbnRpZmllciA9IGZ1bmN0aW9uKCkgewogICAgICByZXR1cm4gTWF0aC5yYW5kb20oKS50b1N0cmluZygzNikuc3Vic3RyKDIsIDEwKTsKICAgIH07CgogICAgLy8gVGhlIFJUQ1AgQ05BTUUgdXNlZCBieSBhbGwgcGVlcmNvbm5lY3Rpb25zIGZyb20gdGhlIHNhbWUgSlMuCiAgICB2YXIgbG9jYWxDTmFtZSA9IGdlbmVyYXRlSWRlbnRpZmllcigpOwoKICAgIC8vIFNEUCBoZWxwZXJzIC0gdG8gYmUgbW92ZWQgaW50byBzZXBhcmF0ZSBtb2R1bGUuCiAgICB2YXIgU0RQVXRpbHMgPSB7fTsKCiAgICAvLyBTcGxpdHMgU0RQIGludG8gbGluZXMsIGRlYWxpbmcgd2l0aCBib3RoIENSTEYgYW5kIExGLgogICAgU0RQVXRpbHMuc3BsaXRMaW5lcyA9IGZ1bmN0aW9uKGJsb2IpIHsKICAgICAgcmV0dXJuIGJsb2IudHJpbSgpLnNwbGl0KCdcbicpLm1hcChmdW5jdGlvbihsaW5lKSB7CiAgICAgICAgcmV0dXJuIGxpbmUudHJpbSgpOwogICAgICB9KTsKICAgIH07CgogICAgLy8gU3BsaXRzIFNEUCBpbnRvIHNlc3Npb25wYXJ0IGFuZCBtZWRpYXNlY3Rpb25zLiBFbnN1cmVzIENSTEYuCiAgICBTRFBVdGlscy5zcGxpdFNlY3Rpb25zID0gZnVuY3Rpb24oYmxvYikgewogICAgICB2YXIgcGFydHMgPSBibG9iLnNwbGl0KCdcclxubT0nKTsKICAgICAgcmV0dXJuIHBhcnRzLm1hcChmdW5jdGlvbihwYXJ0LCBpbmRleCkgewogICAgICAgIHJldHVybiAoaW5kZXggPiAwID8gJ209JyArIHBhcnQgOiBwYXJ0KS50cmltKCkgKyAnXHJcbic7CiAgICAgIH0pOwogICAgfTsKCiAgICAvLyBSZXR1cm5zIGxpbmVzIHRoYXQgc3RhcnQgd2l0aCBhIGNlcnRhaW4gcHJlZml4LgogICAgU0RQVXRpbHMubWF0Y2hQcmVmaXggPSBmdW5jdGlvbihibG9iLCBwcmVmaXgpIHsKICAgICAgcmV0dXJuIFNEUFV0aWxzLnNwbGl0TGluZXMoYmxvYikuZmlsdGVyKGZ1bmN0aW9uKGxpbmUpIHsKICAgICAgICByZXR1cm4gbGluZS5pbmRleE9mKHByZWZpeCkgPT09IDA7CiAgICAgIH0pOwogICAgfTsKCiAgICAvLyBQYXJzZXMgYW4gSUNFIGNhbmRpZGF0ZSBsaW5lLiBTYW1wbGUgaW5wdXQ6CiAgICAvLyBjYW5kaWRhdGU6NzAyNzg2MzUwIDIgdWRwIDQxODE5OTAyIDguOC44LjggNjA3NjkgdHlwIHJlbGF5IHJhZGRyIDguOC44LjggcnBvcnQgNTU5OTYiCiAgICBTRFBVdGlscy5wYXJzZUNhbmRpZGF0ZSA9IGZ1bmN0aW9uKGxpbmUpIHsKICAgICAgdmFyIHBhcnRzOwogICAgICAvLyBQYXJzZSBib3RoIHZhcmlhbnRzLgogICAgICBpZiAobGluZS5pbmRleE9mKCdhPWNhbmRpZGF0ZTonKSA9PT0gMCkgewogICAgICAgIHBhcnRzID0gbGluZS5zdWJzdHJpbmcoMTIpLnNwbGl0KCcgJyk7CiAgICAgIH0gZWxzZSB7CiAgICAgICAgcGFydHMgPSBsaW5lLnN1YnN0cmluZygxMCkuc3BsaXQoJyAnKTsKICAgICAgfQoKICAgICAgdmFyIGNhbmRpZGF0ZSA9IHsKICAgICAgICBmb3VuZGF0aW9uOiBwYXJ0c1swXSwKICAgICAgICBjb21wb25lbnQ6IHBhcnRzWzFdLAogICAgICAgIHByb3RvY29sOiBwYXJ0c1syXS50b0xvd2VyQ2FzZSgpLAogICAgICAgIHByaW9yaXR5OiBwYXJzZUludChwYXJ0c1szXSwgMTApLAogICAgICAgIGlwOiBwYXJ0c1s0XSwKICAgICAgICBwb3J0OiBwYXJzZUludChwYXJ0c1s1XSwgMTApLAogICAgICAgIC8vIHNraXAgcGFydHNbNl0gPT0gJ3R5cCcKICAgICAgICB0eXBlOiBwYXJ0c1s3XQogICAgICB9OwoKICAgICAgZm9yICh2YXIgaSA9IDg7IGkgPCBwYXJ0cy5sZW5ndGg7IGkgKz0gMikgewogICAgICAgIHN3aXRjaCAocGFydHNbaV0pIHsKICAgICAgICAgIGNhc2UgJ3JhZGRyJzoKICAgICAgICAgICAgY2FuZGlkYXRlLnJlbGF0ZWRBZGRyZXNzID0gcGFydHNbaSArIDFdOwogICAgICAgICAgICBicmVhazsKICAgICAgICAgIGNhc2UgJ3Jwb3J0JzoKICAgICAgICAgICAgY2FuZGlkYXRlLnJlbGF0ZWRQb3J0ID0gcGFyc2VJbnQocGFydHNbaSArIDFdLCAxMCk7CiAgICAgICAgICAgIGJyZWFrOwogICAgICAgICAgY2FzZSAndGNwdHlwZSc6CiAgICAgICAgICAgIGNhbmRpZGF0ZS50Y3BUeXBlID0gcGFydHNbaSArIDFdOwogICAgICAgICAgICBicmVhazsKICAgICAgICAgIGRlZmF1bHQ6IC8vIFVua25vd24gZXh0ZW5zaW9ucyBhcmUgc2lsZW50bHkgaWdub3JlZC4KICAgICAgICAgICAgYnJlYWs7CiAgICAgICAgfQogICAgICB9CiAgICAgIHJldHVybiBjYW5kaWRhdGU7CiAgICB9OwoKICAgIC8vIFRyYW5zbGF0ZXMgYSBjYW5kaWRhdGUgb2JqZWN0IGludG8gU0RQIGNhbmRpZGF0ZSBhdHRyaWJ1dGUuCiAgICBTRFBVdGlscy53cml0ZUNhbmRpZGF0ZSA9IGZ1bmN0aW9uKGNhbmRpZGF0ZSkgewogICAgICB2YXIgc2RwID0gW107CiAgICAgIHNkcC5wdXNoKGNhbmRpZGF0ZS5mb3VuZGF0aW9uKTsKICAgICAgc2RwLnB1c2goY2FuZGlkYXRlLmNvbXBvbmVudCk7CiAgICAgIHNkcC5wdXNoKGNhbmRpZGF0ZS5wcm90b2NvbC50b1VwcGVyQ2FzZSgpKTsKICAgICAgc2RwLnB1c2goY2FuZGlkYXRlLnByaW9yaXR5KTsKICAgICAgc2RwLnB1c2goY2FuZGlkYXRlLmlwKTsKICAgICAgc2RwLnB1c2goY2FuZGlkYXRlLnBvcnQpOwoKICAgICAgdmFyIHR5cGUgPSBjYW5kaWRhdGUudHlwZTsKICAgICAgc2RwLnB1c2goJ3R5cCcpOwogICAgICBzZHAucHVzaCh0eXBlKTsKICAgICAgaWYgKHR5cGUgIT09ICdob3N0JyAmJiBjYW5kaWRhdGUucmVsYXRlZEFkZHJlc3MgJiYKICAgICAgICAgIGNhbmRpZGF0ZS5yZWxhdGVkUG9ydCkgewogICAgICAgIHNkcC5wdXNoKCdyYWRkcicpOwogICAgICAgIHNkcC5wdXNoKGNhbmRpZGF0ZS5yZWxhdGVkQWRkcmVzcyk7IC8vIHdhczogcmVsQWRkcgogICAgICAgIHNkcC5wdXNoKCdycG9ydCcpOwogICAgICAgIHNkcC5wdXNoKGNhbmRpZGF0ZS5yZWxhdGVkUG9ydCk7IC8vIHdhczogcmVsUG9ydAogICAgICB9CiAgICAgIGlmIChjYW5kaWRhdGUudGNwVHlwZSAmJiBjYW5kaWRhdGUucHJvdG9jb2wudG9Mb3dlckNhc2UoKSA9PT0gJ3RjcCcpIHsKICAgICAgICBzZHAucHVzaCgndGNwdHlwZScpOwogICAgICAgIHNkcC5wdXNoKGNhbmRpZGF0ZS50Y3BUeXBlKTsKICAgICAgfQogICAgICByZXR1cm4gJ2NhbmRpZGF0ZTonICsgc2RwLmpvaW4oJyAnKTsKICAgIH07CgogICAgLy8gUGFyc2VzIGFuIHJ0cG1hcCBsaW5lLCByZXR1cm5zIFJUQ1J0cENvZGRlY1BhcmFtZXRlcnMuIFNhbXBsZSBpbnB1dDoKICAgIC8vIGE9cnRwbWFwOjExMSBvcHVzLzQ4MDAwLzIKICAgIFNEUFV0aWxzLnBhcnNlUnRwTWFwID0gZnVuY3Rpb24obGluZSkgewogICAgICB2YXIgcGFydHMgPSBsaW5lLnN1YnN0cig5KS5zcGxpdCgnICcpOwogICAgICB2YXIgcGFyc2VkID0gewogICAgICAgIHBheWxvYWRUeXBlOiBwYXJzZUludChwYXJ0cy5zaGlmdCgpLCAxMCkgLy8gd2FzOiBpZAogICAgICB9OwoKICAgICAgcGFydHMgPSBwYXJ0c1swXS5zcGxpdCgnLycpOwoKICAgICAgcGFyc2VkLm5hbWUgPSBwYXJ0c1swXTsKICAgICAgcGFyc2VkLmNsb2NrUmF0ZSA9IHBhcnNlSW50KHBhcnRzWzFdLCAxMCk7IC8vIHdhczogY2xvY2tyYXRlCiAgICAgIHBhcnNlZC5udW1DaGFubmVscyA9IHBhcnRzLmxlbmd0aCA9PT0gMyA/IHBhcnNlSW50KHBhcnRzWzJdLCAxMCkgOiAxOyAvLyB3YXM6IGNoYW5uZWxzCiAgICAgIHJldHVybiBwYXJzZWQ7CiAgICB9OwoKICAgIC8vIEdlbmVyYXRlIGFuIGE9cnRwbWFwIGxpbmUgZnJvbSBSVENSdHBDb2RlY0NhcGFiaWxpdHkgb3IgUlRDUnRwQ29kZWNQYXJhbWV0ZXJzLgogICAgU0RQVXRpbHMud3JpdGVSdHBNYXAgPSBmdW5jdGlvbihjb2RlYykgewogICAgICB2YXIgcHQgPSBjb2RlYy5wYXlsb2FkVHlwZTsKICAgICAgaWYgKGNvZGVjLnByZWZlcnJlZFBheWxvYWRUeXBlICE9PSB1bmRlZmluZWQpIHsKICAgICAgICBwdCA9IGNvZGVjLnByZWZlcnJlZFBheWxvYWRUeXBlOwogICAgICB9CiAgICAgIHJldHVybiAnYT1ydHBtYXA6JyArIHB0ICsgJyAnICsgY29kZWMubmFtZSArICcvJyArIGNvZGVjLmNsb2NrUmF0ZSArCiAgICAgICAgICAoY29kZWMubnVtQ2hhbm5lbHMgIT09IDEgPyAnLycgKyBjb2RlYy5udW1DaGFubmVscyA6ICcnKSArICdcclxuJzsKICAgIH07CgogICAgLy8gUGFyc2VzIGFuIGZ0bXAgbGluZSwgcmV0dXJucyBkaWN0aW9uYXJ5LiBTYW1wbGUgaW5wdXQ6CiAgICAvLyBhPWZtdHA6OTYgdmJyPW9uO2NuZz1vbgogICAgLy8gQWxzbyBkZWFscyB3aXRoIHZicj1vbjsgY25nPW9uCiAgICBTRFBVdGlscy5wYXJzZUZtdHAgPSBmdW5jdGlvbihsaW5lKSB7CiAgICAgIHZhciBwYXJzZWQgPSB7fTsKICAgICAgdmFyIGt2OwogICAgICB2YXIgcGFydHMgPSBsaW5lLnN1YnN0cihsaW5lLmluZGV4T2YoJyAnKSArIDEpLnNwbGl0KCc7Jyk7CiAgICAgIGZvciAodmFyIGogPSAwOyBqIDwgcGFydHMubGVuZ3RoOyBqKyspIHsKICAgICAgICBrdiA9IHBhcnRzW2pdLnRyaW0oKS5zcGxpdCgnPScpOwogICAgICAgIHBhcnNlZFtrdlswXS50cmltKCldID0ga3ZbMV07CiAgICAgIH0KICAgICAgcmV0dXJuIHBhcnNlZDsKICAgIH07CgogICAgLy8gR2VuZXJhdGVzIGFuIGE9ZnRtcCBsaW5lIGZyb20gUlRDUnRwQ29kZWNDYXBhYmlsaXR5IG9yIFJUQ1J0cENvZGVjUGFyYW1ldGVycy4KICAgIFNEUFV0aWxzLndyaXRlRnRtcCA9IGZ1bmN0aW9uKGNvZGVjKSB7CiAgICAgIHZhciBsaW5lID0gJyc7CiAgICAgIHZhciBwdCA9IGNvZGVjLnBheWxvYWRUeXBlOwogICAgICBpZiAoY29kZWMucHJlZmVycmVkUGF5bG9hZFR5cGUgIT09IHVuZGVmaW5lZCkgewogICAgICAgIHB0ID0gY29kZWMucHJlZmVycmVkUGF5bG9hZFR5cGU7CiAgICAgIH0KICAgICAgaWYgKGNvZGVjLnBhcmFtZXRlcnMgJiYgY29kZWMucGFyYW1ldGVycy5sZW5ndGgpIHsKICAgICAgICB2YXIgcGFyYW1zID0gW107CiAgICAgICAgT2JqZWN0LmtleXMoY29kZWMucGFyYW1ldGVycykuZm9yRWFjaChmdW5jdGlvbihwYXJhbSkgewogICAgICAgICAgcGFyYW1zLnB1c2gocGFyYW0gKyAnPScgKyBjb2RlYy5wYXJhbWV0ZXJzW3BhcmFtXSk7CiAgICAgICAgfSk7CiAgICAgICAgbGluZSArPSAnYT1mbXRwOicgKyBwdCArICcgJyArIHBhcmFtcy5qb2luKCc7JykgKyAnXHJcbic7CiAgICAgIH0KICAgICAgcmV0dXJuIGxpbmU7CiAgICB9OwoKICAgIC8vIFBhcnNlcyBhbiBydGNwLWZiIGxpbmUsIHJldHVybnMgUlRDUFJ0Y3BGZWVkYmFjayBvYmplY3QuIFNhbXBsZSBpbnB1dDoKICAgIC8vIGE9cnRjcC1mYjo5OCBuYWNrIHJwc2kKICAgIFNEUFV0aWxzLnBhcnNlUnRjcEZiID0gZnVuY3Rpb24obGluZSkgewogICAgICB2YXIgcGFydHMgPSBsaW5lLnN1YnN0cihsaW5lLmluZGV4T2YoJyAnKSArIDEpLnNwbGl0KCcgJyk7CiAgICAgIHJldHVybiB7CiAgICAgICAgdHlwZTogcGFydHMuc2hpZnQoKSwKICAgICAgICBwYXJhbWV0ZXI6IHBhcnRzLmpvaW4oJyAnKQogICAgICB9OwogICAgfTsKICAgIC8vIEdlbmVyYXRlIGE9cnRjcC1mYiBsaW5lcyBmcm9tIFJUQ1J0cENvZGVjQ2FwYWJpbGl0eSBvciBSVENSdHBDb2RlY1BhcmFtZXRlcnMuCiAgICBTRFBVdGlscy53cml0ZVJ0Y3BGYiA9IGZ1bmN0aW9uKGNvZGVjKSB7CiAgICAgIHZhciBsaW5lcyA9ICcnOwogICAgICB2YXIgcHQgPSBjb2RlYy5wYXlsb2FkVHlwZTsKICAgICAgaWYgKGNvZGVjLnByZWZlcnJlZFBheWxvYWRUeXBlICE9PSB1bmRlZmluZWQpIHsKICAgICAgICBwdCA9IGNvZGVjLnByZWZlcnJlZFBheWxvYWRUeXBlOwogICAgICB9CiAgICAgIGlmIChjb2RlYy5ydGNwRmVlZGJhY2sgJiYgY29kZWMucnRjcEZlZWRiYWNrLmxlbmd0aCkgewogICAgICAgIC8vIEZJWE1FOiBzcGVjaWFsIGhhbmRsaW5nIGZvciB0cnItaW50PwogICAgICAgIGNvZGVjLnJ0Y3BGZWVkYmFjay5mb3JFYWNoKGZ1bmN0aW9uKGZiKSB7CiAgICAgICAgICBsaW5lcyArPSAnYT1ydGNwLWZiOicgKyBwdCArICcgJyArIGZiLnR5cGUgKyAnICcgKyBmYi5wYXJhbWV0ZXIgKwogICAgICAgICAgICAgICdcclxuJzsKICAgICAgICB9KTsKICAgICAgfQogICAgICByZXR1cm4gbGluZXM7CiAgICB9OwoKICAgIC8vIFBhcnNlcyBhbiBSRkMgNTU3NiBzc3JjIG1lZGlhIGF0dHJpYnV0ZS4gU2FtcGxlIGlucHV0OgogICAgLy8gYT1zc3JjOjM3MzU5Mjg1NTkgY25hbWU6c29tZXRoaW5nCiAgICBTRFBVdGlscy5wYXJzZVNzcmNNZWRpYSA9IGZ1bmN0aW9uKGxpbmUpIHsKICAgICAgdmFyIHNwID0gbGluZS5pbmRleE9mKCcgJyk7CiAgICAgIHZhciBwYXJ0cyA9IHsKICAgICAgICBzc3JjOiBsaW5lLnN1YnN0cig3LCBzcCAtIDcpLAogICAgICB9OwogICAgICB2YXIgY29sb24gPSBsaW5lLmluZGV4T2YoJzonLCBzcCk7CiAgICAgIGlmIChjb2xvbiA+IC0xKSB7CiAgICAgICAgcGFydHMuYXR0cmlidXRlID0gbGluZS5zdWJzdHIoc3AgKyAxLCBjb2xvbiAtIHNwIC0gMSk7CiAgICAgICAgcGFydHMudmFsdWUgPSBsaW5lLnN1YnN0cihjb2xvbiArIDEpOwogICAgICB9IGVsc2UgewogICAgICAgIHBhcnRzLmF0dHJpYnV0ZSA9IGxpbmUuc3Vic3RyKHNwICsgMSk7CiAgICAgIH0KICAgICAgcmV0dXJuIHBhcnRzOwogICAgfTsKCiAgICAvLyBFeHRyYWN0cyBEVExTIHBhcmFtZXRlcnMgZnJvbSBTRFAgbWVkaWEgc2VjdGlvbiBvciBzZXNzaW9ucGFydC4KICAgIC8vIEZJWE1FOiBmb3IgY29uc2lzdGVuY3kgd2l0aCBvdGhlciBmdW5jdGlvbnMgdGhpcyBzaG91bGQgb25seQogICAgLy8gICBnZXQgdGhlIGZpbmdlcnByaW50IGxpbmUgYXMgaW5wdXQuIFNlZSBhbHNvIGdldEljZVBhcmFtZXRlcnMuCiAgICBTRFBVdGlscy5nZXREdGxzUGFyYW1ldGVycyA9IGZ1bmN0aW9uKG1lZGlhU2VjdGlvbiwgc2Vzc2lvbnBhcnQpIHsKICAgICAgdmFyIGxpbmVzID0gU0RQVXRpbHMuc3BsaXRMaW5lcyhtZWRpYVNlY3Rpb24pOwogICAgICBsaW5lcyA9IGxpbmVzLmNvbmNhdChTRFBVdGlscy5zcGxpdExpbmVzKHNlc3Npb25wYXJ0KSk7IC8vIFNlYXJjaCBpbiBzZXNzaW9uIHBhcnQsIHRvby4KICAgICAgdmFyIGZwTGluZSA9IGxpbmVzLmZpbHRlcihmdW5jdGlvbihsaW5lKSB7CiAgICAgICAgcmV0dXJuIGxpbmUuaW5kZXhPZignYT1maW5nZXJwcmludDonKSA9PT0gMDsKICAgICAgfSlbMF0uc3Vic3RyKDE0KTsKICAgICAgLy8gTm90ZTogYT1zZXR1cCBsaW5lIGlzIGlnbm9yZWQgc2luY2Ugd2UgdXNlIHRoZSAnYXV0bycgcm9sZS4KICAgICAgdmFyIGR0bHNQYXJhbWV0ZXJzID0gewogICAgICAgIHJvbGU6ICdhdXRvJywKICAgICAgICBmaW5nZXJwcmludHM6IFt7CiAgICAgICAgICBhbGdvcml0aG06IGZwTGluZS5zcGxpdCgnICcpWzBdLAogICAgICAgICAgdmFsdWU6IGZwTGluZS5zcGxpdCgnICcpWzFdCiAgICAgICAgfV0KICAgICAgfTsKICAgICAgcmV0dXJuIGR0bHNQYXJhbWV0ZXJzOwogICAgfTsKCiAgICAvLyBTZXJpYWxpemVzIERUTFMgcGFyYW1ldGVycyB0byBTRFAuCiAgICBTRFBVdGlscy53cml0ZUR0bHNQYXJhbWV0ZXJzID0gZnVuY3Rpb24ocGFyYW1zLCBzZXR1cFR5cGUpIHsKICAgICAgdmFyIHNkcCA9ICdhPXNldHVwOicgKyBzZXR1cFR5cGUgKyAnXHJcbic7CiAgICAgIHBhcmFtcy5maW5nZXJwcmludHMuZm9yRWFjaChmdW5jdGlvbihmcCkgewogICAgICAgIHNkcCArPSAnYT1maW5nZXJwcmludDonICsgZnAuYWxnb3JpdGhtICsgJyAnICsgZnAudmFsdWUgKyAnXHJcbic7CiAgICAgIH0pOwogICAgICByZXR1cm4gc2RwOwogICAgfTsKICAgIC8vIFBhcnNlcyBJQ0UgaW5mb3JtYXRpb24gZnJvbSBTRFAgbWVkaWEgc2VjdGlvbiBvciBzZXNzaW9ucGFydC4KICAgIC8vIEZJWE1FOiBmb3IgY29uc2lzdGVuY3kgd2l0aCBvdGhlciBmdW5jdGlvbnMgdGhpcyBzaG91bGQgb25seQogICAgLy8gICBnZXQgdGhlIGljZS11ZnJhZyBhbmQgaWNlLXB3ZCBsaW5lcyBhcyBpbnB1dC4KICAgIFNEUFV0aWxzLmdldEljZVBhcmFtZXRlcnMgPSBmdW5jdGlvbihtZWRpYVNlY3Rpb24sIHNlc3Npb25wYXJ0KSB7CiAgICAgIHZhciBsaW5lcyA9IFNEUFV0aWxzLnNwbGl0TGluZXMobWVkaWFTZWN0aW9uKTsKICAgICAgbGluZXMgPSBsaW5lcy5jb25jYXQoU0RQVXRpbHMuc3BsaXRMaW5lcyhzZXNzaW9ucGFydCkpOyAvLyBTZWFyY2ggaW4gc2Vzc2lvbiBwYXJ0LCB0b28uCiAgICAgIHZhciBpY2VQYXJhbWV0ZXJzID0gewogICAgICAgIHVzZXJuYW1lRnJhZ21lbnQ6IGxpbmVzLmZpbHRlcihmdW5jdGlvbihsaW5lKSB7CiAgICAgICAgICByZXR1cm4gbGluZS5pbmRleE9mKCdhPWljZS11ZnJhZzonKSA9PT0gMDsKICAgICAgICB9KVswXS5zdWJzdHIoMTIpLAogICAgICAgIHBhc3N3b3JkOiBsaW5lcy5maWx0ZXIoZnVuY3Rpb24obGluZSkgewogICAgICAgICAgcmV0dXJuIGxpbmUuaW5kZXhPZignYT1pY2UtcHdkOicpID09PSAwOwogICAgICAgIH0pWzBdLnN1YnN0cigxMCkKICAgICAgfTsKICAgICAgcmV0dXJuIGljZVBhcmFtZXRlcnM7CiAgICB9OwoKICAgIC8vIFNlcmlhbGl6ZXMgSUNFIHBhcmFtZXRlcnMgdG8gU0RQLgogICAgU0RQVXRpbHMud3JpdGVJY2VQYXJhbWV0ZXJzID0gZnVuY3Rpb24ocGFyYW1zKSB7CiAgICAgIHJldHVybiAnYT1pY2UtdWZyYWc6JyArIHBhcmFtcy51c2VybmFtZUZyYWdtZW50ICsgJ1xyXG4nICsKICAgICAgICAgICdhPWljZS1wd2Q6JyArIHBhcmFtcy5wYXNzd29yZCArICdcclxuJzsKICAgIH07CgogICAgLy8gUGFyc2VzIHRoZSBTRFAgbWVkaWEgc2VjdGlvbiBhbmQgcmV0dXJucyBSVENSdHBQYXJhbWV0ZXJzLgogICAgU0RQVXRpbHMucGFyc2VSdHBQYXJhbWV0ZXJzID0gZnVuY3Rpb24obWVkaWFTZWN0aW9uKSB7CiAgICAgIHZhciBkZXNjcmlwdGlvbiA9IHsKICAgICAgICBjb2RlY3M6IFtdLAogICAgICAgIGhlYWRlckV4dGVuc2lvbnM6IFtdLAogICAgICAgIGZlY01lY2hhbmlzbXM6IFtdLAogICAgICAgIHJ0Y3A6IFtdCiAgICAgIH07CiAgICAgIHZhciBsaW5lcyA9IFNEUFV0aWxzLnNwbGl0TGluZXMobWVkaWFTZWN0aW9uKTsKICAgICAgdmFyIG1saW5lID0gbGluZXNbMF0uc3BsaXQoJyAnKTsKICAgICAgZm9yICh2YXIgaSA9IDM7IGkgPCBtbGluZS5sZW5ndGg7IGkrKykgeyAvLyBmaW5kIGFsbCBjb2RlY3MgZnJvbSBtbGluZVszLi5dCiAgICAgICAgdmFyIHB0ID0gbWxpbmVbaV07CiAgICAgICAgdmFyIHJ0cG1hcGxpbmUgPSBTRFBVdGlscy5tYXRjaFByZWZpeCgKICAgICAgICAgICAgbWVkaWFTZWN0aW9uLCAnYT1ydHBtYXA6JyArIHB0ICsgJyAnKVswXTsKICAgICAgICBpZiAocnRwbWFwbGluZSkgewogICAgICAgICAgdmFyIGNvZGVjID0gU0RQVXRpbHMucGFyc2VSdHBNYXAocnRwbWFwbGluZSk7CiAgICAgICAgICB2YXIgZm10cHMgPSBTRFBVdGlscy5tYXRjaFByZWZpeCgKICAgICAgICAgICAgICBtZWRpYVNlY3Rpb24sICdhPWZtdHA6JyArIHB0ICsgJyAnKTsKICAgICAgICAgIC8vIE9ubHkgdGhlIGZpcnN0IGE9Zm10cDo8cHQ+IGlzIGNvbnNpZGVyZWQuCiAgICAgICAgICBjb2RlYy5wYXJhbWV0ZXJzID0gZm10cHMubGVuZ3RoID8gU0RQVXRpbHMucGFyc2VGbXRwKGZtdHBzWzBdKSA6IHt9OwogICAgICAgICAgY29kZWMucnRjcEZlZWRiYWNrID0gU0RQVXRpbHMubWF0Y2hQcmVmaXgoCiAgICAgICAgICAgICAgbWVkaWFTZWN0aW9uLCAnYT1ydGNwLWZiOicgKyBwdCArICcgJykKICAgICAgICAgICAgLm1hcChTRFBVdGlscy5wYXJzZVJ0Y3BGYik7CiAgICAgICAgICBkZXNjcmlwdGlvbi5jb2RlY3MucHVzaChjb2RlYyk7CiAgICAgICAgfQogICAgICB9CiAgICAgIC8vIEZJWE1FOiBwYXJzZSBoZWFkZXJFeHRlbnNpb25zLCBmZWNNZWNoYW5pc21zIGFuZCBydGNwLgogICAgICByZXR1cm4gZGVzY3JpcHRpb247CiAgICB9OwoKICAgIC8vIEdlbmVyYXRlcyBwYXJ0cyBvZiB0aGUgU0RQIG1lZGlhIHNlY3Rpb24gZGVzY3JpYmluZyB0aGUgY2FwYWJpbGl0aWVzIC8gcGFyYW1ldGVycy4KICAgIFNEUFV0aWxzLndyaXRlUnRwRGVzY3JpcHRpb24gPSBmdW5jdGlvbihraW5kLCBjYXBzKSB7CiAgICAgIHZhciBzZHAgPSAnJzsKCiAgICAgIC8vIEJ1aWxkIHRoZSBtbGluZS4KICAgICAgc2RwICs9ICdtPScgKyBraW5kICsgJyAnOwogICAgICBzZHAgKz0gY2Fwcy5jb2RlY3MubGVuZ3RoID4gMCA/ICc5JyA6ICcwJzsgLy8gcmVqZWN0IGlmIG5vIGNvZGVjcy4KICAgICAgc2RwICs9ICcgVURQL1RMUy9SVFAvU0FWUEYgJzsKICAgICAgc2RwICs9IGNhcHMuY29kZWNzLm1hcChmdW5jdGlvbihjb2RlYykgewogICAgICAgIGlmIChjb2RlYy5wcmVmZXJyZWRQYXlsb2FkVHlwZSAhPT0gdW5kZWZpbmVkKSB7CiAgICAgICAgICByZXR1cm4gY29kZWMucHJlZmVycmVkUGF5bG9hZFR5cGU7CiAgICAgICAgfQogICAgICAgIHJldHVybiBjb2RlYy5wYXlsb2FkVHlwZTsKICAgICAgfSkuam9pbignICcpICsgJ1xyXG4nOwoKICAgICAgc2RwICs9ICdjPUlOIElQNCAwLjAuMC4wXHJcbic7CiAgICAgIHNkcCArPSAnYT1ydGNwOjkgSU4gSVA0IDAuMC4wLjBcclxuJzsKCiAgICAgIC8vIEFkZCBhPXJ0cG1hcCBsaW5lcyBmb3IgZWFjaCBjb2RlYy4gQWxzbyBmbXRwIGFuZCBydGNwLWZiLgogICAgICBjYXBzLmNvZGVjcy5mb3JFYWNoKGZ1bmN0aW9uKGNvZGVjKSB7CiAgICAgICAgc2RwICs9IFNEUFV0aWxzLndyaXRlUnRwTWFwKGNvZGVjKTsKICAgICAgICBzZHAgKz0gU0RQVXRpbHMud3JpdGVGdG1wKGNvZGVjKTsKICAgICAgICBzZHAgKz0gU0RQVXRpbHMud3JpdGVSdGNwRmIoY29kZWMpOwogICAgICB9KTsKICAgICAgLy8gRklYTUU6IGFkZCBoZWFkZXJFeHRlbnNpb25zLCBmZWNNZWNoYW5pc23FnyBhbmQgcnRjcC4KICAgICAgc2RwICs9ICdhPXJ0Y3AtbXV4XHJcbic7CiAgICAgIHJldHVybiBzZHA7CiAgICB9OwoKICAgIFNEUFV0aWxzLndyaXRlU2Vzc2lvbkJvaWxlcnBsYXRlID0gZnVuY3Rpb24oKSB7CiAgICAgIC8vIEZJWE1FOiBzZXNzLWlkIHNob3VsZCBiZSBhbiBOVFAgdGltZXN0YW1wLgogICAgICByZXR1cm4gJ3Y9MFxyXG4nICsKICAgICAgICAgICdvPXRoaXNpc2FkYXB0ZXJvcnRjIDgxNjk2Mzk5MTU2NDY5NDMxMzcgMiBJTiBJUDQgMTI3LjAuMC4xXHJcbicgKwogICAgICAgICAgJ3M9LVxyXG4nICsKICAgICAgICAgICd0PTAgMFxyXG4nOwogICAgfTsKCiAgICBTRFBVdGlscy53cml0ZU1lZGlhU2VjdGlvbiA9IGZ1bmN0aW9uKHRyYW5zY2VpdmVyLCBjYXBzLCB0eXBlLCBzdHJlYW0pIHsKICAgICAgdmFyIHNkcCA9IFNEUFV0aWxzLndyaXRlUnRwRGVzY3JpcHRpb24odHJhbnNjZWl2ZXIua2luZCwgY2Fwcyk7CgogICAgICAvLyBNYXAgSUNFIHBhcmFtZXRlcnMgKHVmcmFnLCBwd2QpIHRvIFNEUC4KICAgICAgc2RwICs9IFNEUFV0aWxzLndyaXRlSWNlUGFyYW1ldGVycygKICAgICAgICAgIHRyYW5zY2VpdmVyLmljZUdhdGhlcmVyLmdldExvY2FsUGFyYW1ldGVycygpKTsKCiAgICAgIC8vIE1hcCBEVExTIHBhcmFtZXRlcnMgdG8gU0RQLgogICAgICBzZHAgKz0gU0RQVXRpbHMud3JpdGVEdGxzUGFyYW1ldGVycygKICAgICAgICAgIHRyYW5zY2VpdmVyLmR0bHNUcmFuc3BvcnQuZ2V0TG9jYWxQYXJhbWV0ZXJzKCksCiAgICAgICAgICB0eXBlID09PSAnb2ZmZXInID8gJ2FjdHBhc3MnIDogJ2FjdGl2ZScpOwoKICAgICAgc2RwICs9ICdhPW1pZDonICsgdHJhbnNjZWl2ZXIubWlkICsgJ1xyXG4nOwoKICAgICAgaWYgKHRyYW5zY2VpdmVyLnJ0cFNlbmRlciAmJiB0cmFuc2NlaXZlci5ydHBSZWNlaXZlcikgewogICAgICAgIHNkcCArPSAnYT1zZW5kcmVjdlxyXG4nOwogICAgICB9IGVsc2UgaWYgKHRyYW5zY2VpdmVyLnJ0cFNlbmRlcikgewogICAgICAgIHNkcCArPSAnYT1zZW5kb25seVxyXG4nOwogICAgICB9IGVsc2UgaWYgKHRyYW5zY2VpdmVyLnJ0cFJlY2VpdmVyKSB7CiAgICAgICAgc2RwICs9ICdhPXJlY3Zvbmx5XHJcbic7CiAgICAgIH0gZWxzZSB7CiAgICAgICAgc2RwICs9ICdhPWluYWN0aXZlXHJcbic7CiAgICAgIH0KCiAgICAgIC8vIEZJWE1FOiBmb3IgUlRYIHRoZXJlIG1pZ2h0IGJlIG11bHRpcGxlIFNTUkNzLiBOb3QgaW1wbGVtZW50ZWQgaW4gRWRnZSB5ZXQuCiAgICAgIGlmICh0cmFuc2NlaXZlci5ydHBTZW5kZXIpIHsKICAgICAgICB2YXIgbXNpZCA9ICdtc2lkOicgKyBzdHJlYW0uaWQgKyAnICcgKwogICAgICAgICAgICB0cmFuc2NlaXZlci5ydHBTZW5kZXIudHJhY2suaWQgKyAnXHJcbic7CiAgICAgICAgc2RwICs9ICdhPScgKyBtc2lkOwogICAgICAgIHNkcCArPSAnYT1zc3JjOicgKyB0cmFuc2NlaXZlci5zZW5kU3NyYyArICcgJyArIG1zaWQ7CiAgICAgIH0KICAgICAgLy8gRklYTUU6IHRoaXMgc2hvdWxkIGJlIHdyaXR0ZW4gYnkgd3JpdGVSdHBEZXNjcmlwdGlvbi4KICAgICAgc2RwICs9ICdhPXNzcmM6JyArIHRyYW5zY2VpdmVyLnNlbmRTc3JjICsgJyBjbmFtZTonICsKICAgICAgICAgIGxvY2FsQ05hbWUgKyAnXHJcbic7CiAgICAgIHJldHVybiBzZHA7CiAgICB9OwoKICAgIC8vIEdldHMgdGhlIGRpcmVjdGlvbiBmcm9tIHRoZSBtZWRpYVNlY3Rpb24gb3IgdGhlIHNlc3Npb25wYXJ0LgogICAgU0RQVXRpbHMuZ2V0RGlyZWN0aW9uID0gZnVuY3Rpb24obWVkaWFTZWN0aW9uLCBzZXNzaW9ucGFydCkgewogICAgICAvLyBMb29rIGZvciBzZW5kcmVjdiwgc2VuZG9ubHksIHJlY3Zvbmx5LCBpbmFjdGl2ZSwgZGVmYXVsdCB0byBzZW5kcmVjdi4KICAgICAgdmFyIGxpbmVzID0gU0RQVXRpbHMuc3BsaXRMaW5lcyhtZWRpYVNlY3Rpb24pOwogICAgICBmb3IgKHZhciBpID0gMDsgaSA8IGxpbmVzLmxlbmd0aDsgaSsrKSB7CiAgICAgICAgc3dpdGNoIChsaW5lc1tpXSkgewogICAgICAgICAgY2FzZSAnYT1zZW5kcmVjdic6CiAgICAgICAgICBjYXNlICdhPXNlbmRvbmx5JzoKICAgICAgICAgIGNhc2UgJ2E9cmVjdm9ubHknOgogICAgICAgICAgY2FzZSAnYT1pbmFjdGl2ZSc6CiAgICAgICAgICAgIHJldHVybiBsaW5lc1tpXS5zdWJzdHIoMik7CiAgICAgICAgfQogICAgICB9CiAgICAgIGlmIChzZXNzaW9ucGFydCkgewogICAgICAgIHJldHVybiBTRFBVdGlscy5nZXREaXJlY3Rpb24oc2Vzc2lvbnBhcnQpOwogICAgICB9CiAgICAgIHJldHVybiAnc2VuZHJlY3YnOwogICAgfTsKCiAgICAvLyBPUlRDIGRlZmluZXMgYW4gUlRDSWNlQ2FuZGlkYXRlIG9iamVjdCBidXQgbm8gY29uc3RydWN0b3IuCiAgICAvLyBOb3QgaW1wbGVtZW50ZWQgaW4gRWRnZS4KICAgIGlmICghd2luZG93LlJUQ0ljZUNhbmRpZGF0ZSkgewogICAgICB3aW5kb3cuUlRDSWNlQ2FuZGlkYXRlID0gZnVuY3Rpb24oYXJncykgewogICAgICAgIHJldHVybiBhcmdzOwogICAgICB9OwogICAgfQogICAgLy8gT1JUQyBkb2VzIG5vdCBoYXZlIGEgc2Vzc2lvbiBkZXNjcmlwdGlvbiBvYmplY3QgYnV0CiAgICAvLyBvdGhlciBicm93c2VycyAoaS5lLiBDaHJvbWUpIHRoYXQgd2lsbCBzdXBwb3J0IGJvdGggUEMgYW5kIE9SVEMKICAgIC8vIGluIHRoZSBmdXR1cmUgbWlnaHQgaGF2ZSB0aGlzIGRlZmluZWQgYWxyZWFkeS4KICAgIGlmICghd2luZG93LlJUQ1Nlc3Npb25EZXNjcmlwdGlvbikgewogICAgICB3aW5kb3cuUlRDU2Vzc2lvbkRlc2NyaXB0aW9uID0gZnVuY3Rpb24oYXJncykgewogICAgICAgIHJldHVybiBhcmdzOwogICAgICB9OwogICAgfQoKICAgIHdpbmRvdy5SVENQZWVyQ29ubmVjdGlvbiA9IGZ1bmN0aW9uKGNvbmZpZykgewogICAgICB2YXIgc2VsZiA9IHRoaXM7CgogICAgICB0aGlzLm9uaWNlY2FuZGlkYXRlID0gbnVsbDsKICAgICAgdGhpcy5vbmFkZHN0cmVhbSA9IG51bGw7CiAgICAgIHRoaXMub25yZW1vdmVzdHJlYW0gPSBudWxsOwogICAgICB0aGlzLm9uc2lnbmFsaW5nc3RhdGVjaGFuZ2UgPSBudWxsOwogICAgICB0aGlzLm9uaWNlY29ubmVjdGlvbnN0YXRlY2hhbmdlID0gbnVsbDsKICAgICAgdGhpcy5vbm5lZ290aWF0aW9ubmVlZGVkID0gbnVsbDsKICAgICAgdGhpcy5vbmRhdGFjaGFubmVsID0gbnVsbDsKCiAgICAgIHRoaXMubG9jYWxTdHJlYW1zID0gW107CiAgICAgIHRoaXMucmVtb3RlU3RyZWFtcyA9IFtdOwogICAgICB0aGlzLmdldExvY2FsU3RyZWFtcyA9IGZ1bmN0aW9uKCkgeyByZXR1cm4gc2VsZi5sb2NhbFN0cmVhbXM7IH07CiAgICAgIHRoaXMuZ2V0UmVtb3RlU3RyZWFtcyA9IGZ1bmN0aW9uKCkgeyByZXR1cm4gc2VsZi5yZW1vdGVTdHJlYW1zOyB9OwoKICAgICAgdGhpcy5sb2NhbERlc2NyaXB0aW9uID0gbmV3IFJUQ1Nlc3Npb25EZXNjcmlwdGlvbih7CiAgICAgICAgdHlwZTogJycsCiAgICAgICAgc2RwOiAnJwogICAgICB9KTsKICAgICAgdGhpcy5yZW1vdGVEZXNjcmlwdGlvbiA9IG5ldyBSVENTZXNzaW9uRGVzY3JpcHRpb24oewogICAgICAgIHR5cGU6ICcnLAogICAgICAgIHNkcDogJycKICAgICAgfSk7CiAgICAgIHRoaXMuc2lnbmFsaW5nU3RhdGUgPSAnc3RhYmxlJzsKICAgICAgdGhpcy5pY2VDb25uZWN0aW9uU3RhdGUgPSAnbmV3JzsKCiAgICAgIHRoaXMuaWNlT3B0aW9ucyA9IHsKICAgICAgICBnYXRoZXJQb2xpY3k6ICdhbGwnLAogICAgICAgIGljZVNlcnZlcnM6IFtdCiAgICAgIH07CiAgICAgIGlmIChjb25maWcgJiYgY29uZmlnLmljZVRyYW5zcG9ydFBvbGljeSkgewogICAgICAgIHN3aXRjaCAoY29uZmlnLmljZVRyYW5zcG9ydFBvbGljeSkgewogICAgICAgICAgY2FzZSAnYWxsJzoKICAgICAgICAgIGNhc2UgJ3JlbGF5JzoKICAgICAgICAgICAgdGhpcy5pY2VPcHRpb25zLmdhdGhlclBvbGljeSA9IGNvbmZpZy5pY2VUcmFuc3BvcnRQb2xpY3k7CiAgICAgICAgICAgIGJyZWFrOwogICAgICAgICAgY2FzZSAnbm9uZSc6CiAgICAgICAgICAgIC8vIEZJWE1FOiByZW1vdmUgb25jZSBpbXBsZW1lbnRhdGlvbiBhbmQgc3BlYyBoYXZlIGFkZGVkIHRoaXMuCiAgICAgICAgICAgIHRocm93IG5ldyBUeXBlRXJyb3IoJ2ljZVRyYW5zcG9ydFBvbGljeSAibm9uZSIgbm90IHN1cHBvcnRlZCcpOwogICAgICAgIH0KICAgICAgfQogICAgICBpZiAoY29uZmlnICYmIGNvbmZpZy5pY2VTZXJ2ZXJzKSB7CiAgICAgICAgLy8gRWRnZSBkb2VzIG5vdCBsaWtlCiAgICAgICAgLy8gMSkgc3R1bjoKICAgICAgICAvLyAyKSB0dXJuOiB0aGF0IGRvZXMgbm90IGhhdmUgYWxsIG9mIHR1cm46aG9zdDpwb3J0P3RyYW5zcG9ydD11ZHAKICAgICAgICAvLyAzKSBhbiBhcnJheSBvZiB1cmxzCiAgICAgICAgY29uZmlnLmljZVNlcnZlcnMuZm9yRWFjaChmdW5jdGlvbihzZXJ2ZXIpIHsKICAgICAgICAgIGlmIChzZXJ2ZXIudXJscykgewogICAgICAgICAgICB2YXIgdXJsOwogICAgICAgICAgICBpZiAodHlwZW9mKHNlcnZlci51cmxzKSA9PT0gJ3N0cmluZycpIHsKICAgICAgICAgICAgICB1cmwgPSBzZXJ2ZXIudXJsczsKICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICB1cmwgPSBzZXJ2ZXIudXJsc1swXTsKICAgICAgICAgICAgfQogICAgICAgICAgICBpZiAodXJsLmluZGV4T2YoJ3RyYW5zcG9ydD11ZHAnKSAhPT0gLTEpIHsKICAgICAgICAgICAgICBzZWxmLmljZVNlcnZlcnMucHVzaCh7CiAgICAgICAgICAgICAgICB1c2VybmFtZTogc2VydmVyLnVzZXJuYW1lLAogICAgICAgICAgICAgICAgY3JlZGVudGlhbDogc2VydmVyLmNyZWRlbnRpYWwsCiAgICAgICAgICAgICAgICB1cmxzOiB1cmwKICAgICAgICAgICAgICB9KTsKICAgICAgICAgICAgfQogICAgICAgICAgfQogICAgICAgIH0pOwogICAgICB9CgogICAgICAvLyBwZXItdHJhY2sgaWNlR2F0aGVycywgaWNlVHJhbnNwb3J0cywgZHRsc1RyYW5zcG9ydHMsIHJ0cFNlbmRlcnMsIC4uLgogICAgICAvLyBldmVyeXRoaW5nIHRoYXQgaXMgbmVlZGVkIHRvIGRlc2NyaWJlIGEgU0RQIG0tbGluZS4KICAgICAgdGhpcy50cmFuc2NlaXZlcnMgPSBbXTsKCiAgICAgIC8vIHNpbmNlIHRoZSBpY2VHYXRoZXJlciBpcyBjdXJyZW50bHkgY3JlYXRlZCBpbiBjcmVhdGVPZmZlciBidXQgd2UKICAgICAgLy8gbXVzdCBub3QgZW1pdCBjYW5kaWRhdGVzIHVudGlsIGFmdGVyIHNldExvY2FsRGVzY3JpcHRpb24gd2UgYnVmZmVyCiAgICAgIC8vIHRoZW0gaW4gdGhpcyBhcnJheS4KICAgICAgdGhpcy5fbG9jYWxJY2VDYW5kaWRhdGVzQnVmZmVyID0gW107CiAgICB9OwoKICAgIHdpbmRvdy5SVENQZWVyQ29ubmVjdGlvbi5wcm90b3R5cGUuX2VtaXRCdWZmZXJlZENhbmRpZGF0ZXMgPSBmdW5jdGlvbigpIHsKICAgICAgdmFyIHNlbGYgPSB0aGlzOwogICAgICAvLyBGSVhNRTogbmVlZCB0byBhcHBseSBpY2UgY2FuZGlkYXRlcyBpbiBhIHdheSB3aGljaCBpcyBhc3luYyBidXQgaW4tb3JkZXIKICAgICAgdGhpcy5fbG9jYWxJY2VDYW5kaWRhdGVzQnVmZmVyLmZvckVhY2goZnVuY3Rpb24oZXZlbnQpIHsKICAgICAgICBpZiAoc2VsZi5vbmljZWNhbmRpZGF0ZSAhPT0gbnVsbCkgewogICAgICAgICAgc2VsZi5vbmljZWNhbmRpZGF0ZShldmVudCk7CiAgICAgICAgfQogICAgICB9KTsKICAgICAgdGhpcy5fbG9jYWxJY2VDYW5kaWRhdGVzQnVmZmVyID0gW107CiAgICB9OwoKICAgIHdpbmRvdy5SVENQZWVyQ29ubmVjdGlvbi5wcm90b3R5cGUuYWRkU3RyZWFtID0gZnVuY3Rpb24oc3RyZWFtKSB7CiAgICAgIC8vIENsb25lIGlzIG5lY2Vzc2FyeSBmb3IgbG9jYWwgZGVtb3MgbW9zdGx5LCBhdHRhY2hpbmcgZGlyZWN0bHkKICAgICAgLy8gdG8gdHdvIGRpZmZlcmVudCBzZW5kZXJzIGRvZXMgbm90IHdvcmsgKGJ1aWxkIDEwNTQ3KS4KICAgICAgdGhpcy5sb2NhbFN0cmVhbXMucHVzaChzdHJlYW0uY2xvbmUoKSk7CiAgICAgIHRoaXMuX21heWJlRmlyZU5lZ290aWF0aW9uTmVlZGVkKCk7CiAgICB9OwoKICAgIHdpbmRvdy5SVENQZWVyQ29ubmVjdGlvbi5wcm90b3R5cGUucmVtb3ZlU3RyZWFtID0gZnVuY3Rpb24oc3RyZWFtKSB7CiAgICAgIHZhciBpZHggPSB0aGlzLmxvY2FsU3RyZWFtcy5pbmRleE9mKHN0cmVhbSk7CiAgICAgIGlmIChpZHggPiAtMSkgewogICAgICAgIHRoaXMubG9jYWxTdHJlYW1zLnNwbGljZShpZHgsIDEpOwogICAgICAgIHRoaXMuX21heWJlRmlyZU5lZ290aWF0aW9uTmVlZGVkKCk7CiAgICAgIH0KICAgIH07CgogICAgLy8gRGV0ZXJtaW5lcyB0aGUgaW50ZXJzZWN0aW9uIG9mIGxvY2FsIGFuZCByZW1vdGUgY2FwYWJpbGl0aWVzLgogICAgd2luZG93LlJUQ1BlZXJDb25uZWN0aW9uLnByb3RvdHlwZS5fZ2V0Q29tbW9uQ2FwYWJpbGl0aWVzID0KICAgICAgICBmdW5jdGlvbihsb2NhbENhcGFiaWxpdGllcywgcmVtb3RlQ2FwYWJpbGl0aWVzKSB7CiAgICAgIHZhciBjb21tb25DYXBhYmlsaXRpZXMgPSB7CiAgICAgICAgY29kZWNzOiBbXSwKICAgICAgICBoZWFkZXJFeHRlbnNpb25zOiBbXSwKICAgICAgICBmZWNNZWNoYW5pc21zOiBbXQogICAgICB9OwogICAgICBsb2NhbENhcGFiaWxpdGllcy5jb2RlY3MuZm9yRWFjaChmdW5jdGlvbihsQ29kZWMpIHsKICAgICAgICBmb3IgKHZhciBpID0gMDsgaSA8IHJlbW90ZUNhcGFiaWxpdGllcy5jb2RlY3MubGVuZ3RoOyBpKyspIHsKICAgICAgICAgIHZhciByQ29kZWMgPSByZW1vdGVDYXBhYmlsaXRpZXMuY29kZWNzW2ldOwogICAgICAgICAgaWYgKGxDb2RlYy5uYW1lLnRvTG93ZXJDYXNlKCkgPT09IHJDb2RlYy5uYW1lLnRvTG93ZXJDYXNlKCkgJiYKICAgICAgICAgICAgICBsQ29kZWMuY2xvY2tSYXRlID09PSByQ29kZWMuY2xvY2tSYXRlICYmCiAgICAgICAgICAgICAgbENvZGVjLm51bUNoYW5uZWxzID09PSByQ29kZWMubnVtQ2hhbm5lbHMpIHsKICAgICAgICAgICAgLy8gcHVzaCByQ29kZWMgc28gd2UgcmVwbHkgd2l0aCBvZmZlcmVyIHBheWxvYWQgdHlwZQogICAgICAgICAgICBjb21tb25DYXBhYmlsaXRpZXMuY29kZWNzLnB1c2gockNvZGVjKTsKCiAgICAgICAgICAgIC8vIEZJWE1FOiBhbHNvIG5lZWQgdG8gZGV0ZXJtaW5lIGludGVyc2VjdGlvbiBiZXR3ZWVuCiAgICAgICAgICAgIC8vIC5ydGNwRmVlZGJhY2sgYW5kIC5wYXJhbWV0ZXJzCiAgICAgICAgICAgIGJyZWFrOwogICAgICAgICAgfQogICAgICAgIH0KICAgICAgfSk7CgogICAgICBsb2NhbENhcGFiaWxpdGllcy5oZWFkZXJFeHRlbnNpb25zLmZvckVhY2goZnVuY3Rpb24obEhlYWRlckV4dGVuc2lvbikgewogICAgICAgIGZvciAodmFyIGkgPSAwOyBpIDwgcmVtb3RlQ2FwYWJpbGl0aWVzLmhlYWRlckV4dGVuc2lvbnMubGVuZ3RoOyBpKyspIHsKICAgICAgICAgIHZhciBySGVhZGVyRXh0ZW5zaW9uID0gcmVtb3RlQ2FwYWJpbGl0aWVzLmhlYWRlckV4dGVuc2lvbnNbaV07CiAgICAgICAgICBpZiAobEhlYWRlckV4dGVuc2lvbi51cmkgPT09IHJIZWFkZXJFeHRlbnNpb24udXJpKSB7CiAgICAgICAgICAgIGNvbW1vbkNhcGFiaWxpdGllcy5oZWFkZXJFeHRlbnNpb25zLnB1c2gockhlYWRlckV4dGVuc2lvbik7CiAgICAgICAgICAgIGJyZWFrOwogICAgICAgICAgfQogICAgICAgIH0KICAgICAgfSk7CgogICAgICAvLyBGSVhNRTogZmVjTWVjaGFuaXNtcwogICAgICByZXR1cm4gY29tbW9uQ2FwYWJpbGl0aWVzOwogICAgfTsKCiAgICAvLyBDcmVhdGUgSUNFIGdhdGhlcmVyLCBJQ0UgdHJhbnNwb3J0IGFuZCBEVExTIHRyYW5zcG9ydC4KICAgIHdpbmRvdy5SVENQZWVyQ29ubmVjdGlvbi5wcm90b3R5cGUuX2NyZWF0ZUljZUFuZER0bHNUcmFuc3BvcnRzID0KICAgICAgICBmdW5jdGlvbihtaWQsIHNkcE1MaW5lSW5kZXgpIHsKICAgICAgdmFyIHNlbGYgPSB0aGlzOwogICAgICB2YXIgaWNlR2F0aGVyZXIgPSBuZXcgUlRDSWNlR2F0aGVyZXIoc2VsZi5pY2VPcHRpb25zKTsKICAgICAgdmFyIGljZVRyYW5zcG9ydCA9IG5ldyBSVENJY2VUcmFuc3BvcnQoaWNlR2F0aGVyZXIpOwogICAgICBpY2VHYXRoZXJlci5vbmxvY2FsY2FuZGlkYXRlID0gZnVuY3Rpb24oZXZ0KSB7CiAgICAgICAgdmFyIGV2ZW50ID0ge307CiAgICAgICAgZXZlbnQuY2FuZGlkYXRlID0ge3NkcE1pZDogbWlkLCBzZHBNTGluZUluZGV4OiBzZHBNTGluZUluZGV4fTsKCiAgICAgICAgdmFyIGNhbmQgPSBldnQuY2FuZGlkYXRlOwogICAgICAgIC8vIEVkZ2UgZW1pdHMgYW4gZW1wdHkgb2JqZWN0IGZvciBSVENJY2VDYW5kaWRhdGVDb21wbGV0ZeKApQogICAgICAgIGlmICghY2FuZCB8fCBPYmplY3Qua2V5cyhjYW5kKS5sZW5ndGggPT09IDApIHsKICAgICAgICAgIC8vIHBvbHlmaWxsIHNpbmNlIFJUQ0ljZUdhdGhlcmVyLnN0YXRlIGlzIG5vdCBpbXBsZW1lbnRlZCBpbiBFZGdlIDEwNTQ3IHlldC4KICAgICAgICAgIGlmIChpY2VHYXRoZXJlci5zdGF0ZSA9PT0gdW5kZWZpbmVkKSB7CiAgICAgICAgICAgIGljZUdhdGhlcmVyLnN0YXRlID0gJ2NvbXBsZXRlZCc7CiAgICAgICAgICB9CgogICAgICAgICAgLy8gRW1pdCBhIGNhbmRpZGF0ZSB3aXRoIHR5cGUgZW5kT2ZDYW5kaWRhdGVzIHRvIG1ha2UgdGhlIHNhbXBsZXMgd29yay4KICAgICAgICAgIC8vIEVkZ2UgcmVxdWlyZXMgYWRkSWNlQ2FuZGlkYXRlIHdpdGggdGhpcyBlbXB0eSBjYW5kaWRhdGUgdG8gc3RhcnQgY2hlY2tpbmcuCiAgICAgICAgICAvLyBUaGUgcmVhbCBzb2x1dGlvbiBpcyB0byBzaWduYWwgZW5kLW9mLWNhbmRpZGF0ZXMgdG8gdGhlIG90aGVyIHNpZGUgd2hlbgogICAgICAgICAgLy8gZ2V0dGluZyB0aGUgbnVsbCBjYW5kaWRhdGUgYnV0IHNvbWUgYXBwcyAobGlrZSB0aGUgc2FtcGxlcykgZG9uJ3QgZG8gdGhhdC4KICAgICAgICAgIGV2ZW50LmNhbmRpZGF0ZS5jYW5kaWRhdGUgPQogICAgICAgICAgICAgICdjYW5kaWRhdGU6MSAxIHVkcCAxIDAuMC4wLjAgOSB0eXAgZW5kT2ZDYW5kaWRhdGVzJzsKICAgICAgICB9IGVsc2UgewogICAgICAgICAgLy8gUlRDSWNlQ2FuZGlkYXRlIGRvZXNuJ3QgaGF2ZSBhIGNvbXBvbmVudCwgbmVlZHMgdG8gYmUgYWRkZWQKICAgICAgICAgIGNhbmQuY29tcG9uZW50ID0gaWNlVHJhbnNwb3J0LmNvbXBvbmVudCA9PT0gJ1JUQ1AnID8gMiA6IDE7CiAgICAgICAgICBldmVudC5jYW5kaWRhdGUuY2FuZGlkYXRlID0gU0RQVXRpbHMud3JpdGVDYW5kaWRhdGUoY2FuZCk7CiAgICAgICAgfQoKICAgICAgICB2YXIgY29tcGxldGUgPSBzZWxmLnRyYW5zY2VpdmVycy5ldmVyeShmdW5jdGlvbih0cmFuc2NlaXZlcikgewogICAgICAgICAgcmV0dXJuIHRyYW5zY2VpdmVyLmljZUdhdGhlcmVyICYmCiAgICAgICAgICAgICAgdHJhbnNjZWl2ZXIuaWNlR2F0aGVyZXIuc3RhdGUgPT09ICdjb21wbGV0ZWQnOwogICAgICAgIH0pOwogICAgICAgIC8vIEZJWE1FOiB1cGRhdGUgLmxvY2FsRGVzY3JpcHRpb24gd2l0aCBjYW5kaWRhdGUgYW5kIChwb3RlbnRpYWxseSkgZW5kLW9mLWNhbmRpZGF0ZXMuCiAgICAgICAgLy8gICAgIFRvIG1ha2UgdGhpcyBoYXJkZXIsIHRoZSBnYXRoZXJlciBtaWdodCBlbWl0IGNhbmRpZGF0ZXMgYmVmb3JlIGxvY2FsZGVzY3JpcHRpb24KICAgICAgICAvLyAgICAgaXMgc2V0LiBUbyBtYWtlIHRoaW5ncyB3b3JzZSwgZ2F0aGVyLmdldExvY2FsQ2FuZGlkYXRlcyBzdGlsbCBlcnJvcnMgaW4KICAgICAgICAvLyAgICAgRWRnZSAxMDU0NyB3aGVuIG5vIGNhbmRpZGF0ZXMgaGF2ZSBiZWVuIGdhdGhlcmVkIHlldC4KCiAgICAgICAgaWYgKHNlbGYub25pY2VjYW5kaWRhdGUgIT09IG51bGwpIHsKICAgICAgICAgIC8vIEVtaXQgY2FuZGlkYXRlIGlmIGxvY2FsRGVzY3JpcHRpb24gaXMgc2V0LgogICAgICAgICAgLy8gQWxzbyBlbWl0cyBudWxsIGNhbmRpZGF0ZSB3aGVuIGFsbCBnYXRoZXJlcnMgYXJlIGNvbXBsZXRlLgogICAgICAgICAgaWYgKHNlbGYubG9jYWxEZXNjcmlwdGlvbiAmJiBzZWxmLmxvY2FsRGVzY3JpcHRpb24udHlwZSA9PT0gJycpIHsKICAgICAgICAgICAgc2VsZi5fbG9jYWxJY2VDYW5kaWRhdGVzQnVmZmVyLnB1c2goZXZlbnQpOwogICAgICAgICAgICBpZiAoY29tcGxldGUpIHsKICAgICAgICAgICAgICBzZWxmLl9sb2NhbEljZUNhbmRpZGF0ZXNCdWZmZXIucHVzaCh7fSk7CiAgICAgICAgICAgIH0KICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgIHNlbGYub25pY2VjYW5kaWRhdGUoZXZlbnQpOwogICAgICAgICAgICBpZiAoY29tcGxldGUpIHsKICAgICAgICAgICAgICBzZWxmLm9uaWNlY2FuZGlkYXRlKHt9KTsKICAgICAgICAgICAgfQogICAgICAgICAgfQogICAgICAgIH0KICAgICAgfTsKICAgICAgaWNlVHJhbnNwb3J0Lm9uaWNlc3RhdGVjaGFuZ2UgPSBmdW5jdGlvbigpIHsKICAgICAgICBzZWxmLl91cGRhdGVDb25uZWN0aW9uU3RhdGUoKTsKICAgICAgfTsKCiAgICAgIHZhciBkdGxzVHJhbnNwb3J0ID0gbmV3IFJUQ0R0bHNUcmFuc3BvcnQoaWNlVHJhbnNwb3J0KTsKICAgICAgZHRsc1RyYW5zcG9ydC5vbmR0bHNzdGF0ZWNoYW5nZSA9IGZ1bmN0aW9uKCkgewogICAgICAgIHNlbGYuX3VwZGF0ZUNvbm5lY3Rpb25TdGF0ZSgpOwogICAgICB9OwogICAgICBkdGxzVHJhbnNwb3J0Lm9uZXJyb3IgPSBmdW5jdGlvbigpIHsKICAgICAgICAvLyBvbmVycm9yIGRvZXMgbm90IHNldCBzdGF0ZSB0byBmYWlsZWQgYnkgaXRzZWxmLgogICAgICAgIGR0bHNUcmFuc3BvcnQuc3RhdGUgPSAnZmFpbGVkJzsKICAgICAgICBzZWxmLl91cGRhdGVDb25uZWN0aW9uU3RhdGUoKTsKICAgICAgfTsKCiAgICAgIHJldHVybiB7CiAgICAgICAgaWNlR2F0aGVyZXI6IGljZUdhdGhlcmVyLAogICAgICAgIGljZVRyYW5zcG9ydDogaWNlVHJhbnNwb3J0LAogICAgICAgIGR0bHNUcmFuc3BvcnQ6IGR0bHNUcmFuc3BvcnQKICAgICAgfTsKICAgIH07CgogICAgLy8gU3RhcnQgdGhlIFJUUCBTZW5kZXIgYW5kIFJlY2VpdmVyIGZvciBhIHRyYW5zY2VpdmVyLgogICAgd2luZG93LlJUQ1BlZXJDb25uZWN0aW9uLnByb3RvdHlwZS5fdHJhbnNjZWl2ZSA9IGZ1bmN0aW9uKHRyYW5zY2VpdmVyLAogICAgICAgIHNlbmQsIHJlY3YpIHsKICAgICAgdmFyIHBhcmFtcyA9IHRoaXMuX2dldENvbW1vbkNhcGFiaWxpdGllcyh0cmFuc2NlaXZlci5sb2NhbENhcGFiaWxpdGllcywKICAgICAgICAgIHRyYW5zY2VpdmVyLnJlbW90ZUNhcGFiaWxpdGllcyk7CiAgICAgIGlmIChzZW5kICYmIHRyYW5zY2VpdmVyLnJ0cFNlbmRlcikgewogICAgICAgIHBhcmFtcy5lbmNvZGluZ3MgPSBbewogICAgICAgICAgc3NyYzogdHJhbnNjZWl2ZXIuc2VuZFNzcmMKICAgICAgICB9XTsKICAgICAgICBwYXJhbXMucnRjcCA9IHsKICAgICAgICAgIGNuYW1lOiBsb2NhbENOYW1lLAogICAgICAgICAgc3NyYzogdHJhbnNjZWl2ZXIucmVjdlNzcmMKICAgICAgICB9OwogICAgICAgIHRyYW5zY2VpdmVyLnJ0cFNlbmRlci5zZW5kKHBhcmFtcyk7CiAgICAgIH0KICAgICAgaWYgKHJlY3YgJiYgdHJhbnNjZWl2ZXIucnRwUmVjZWl2ZXIpIHsKICAgICAgICBwYXJhbXMuZW5jb2RpbmdzID0gW3sKICAgICAgICAgIHNzcmM6IHRyYW5zY2VpdmVyLnJlY3ZTc3JjCiAgICAgICAgfV07CiAgICAgICAgcGFyYW1zLnJ0Y3AgPSB7CiAgICAgICAgICBjbmFtZTogdHJhbnNjZWl2ZXIuY25hbWUsCiAgICAgICAgICBzc3JjOiB0cmFuc2NlaXZlci5zZW5kU3NyYwogICAgICAgIH07CiAgICAgICAgdHJhbnNjZWl2ZXIucnRwUmVjZWl2ZXIucmVjZWl2ZShwYXJhbXMpOwogICAgICB9CiAgICB9OwoKICAgIHdpbmRvdy5SVENQZWVyQ29ubmVjdGlvbi5wcm90b3R5cGUuc2V0TG9jYWxEZXNjcmlwdGlvbiA9CiAgICAgICAgZnVuY3Rpb24oZGVzY3JpcHRpb24pIHsKICAgICAgdmFyIHNlbGYgPSB0aGlzOwogICAgICBpZiAoZGVzY3JpcHRpb24udHlwZSA9PT0gJ29mZmVyJykgewogICAgICAgIGlmICghdGhpcy5fcGVuZGluZ09mZmVyKSB7CiAgICAgICAgfSBlbHNlIHsKICAgICAgICAgIHRoaXMudHJhbnNjZWl2ZXJzID0gdGhpcy5fcGVuZGluZ09mZmVyOwogICAgICAgICAgZGVsZXRlIHRoaXMuX3BlbmRpbmdPZmZlcjsKICAgICAgICB9CiAgICAgIH0gZWxzZSBpZiAoZGVzY3JpcHRpb24udHlwZSA9PT0gJ2Fuc3dlcicpIHsKICAgICAgICB2YXIgc2VjdGlvbnMgPSBTRFBVdGlscy5zcGxpdFNlY3Rpb25zKHNlbGYucmVtb3RlRGVzY3JpcHRpb24uc2RwKTsKICAgICAgICB2YXIgc2Vzc2lvbnBhcnQgPSBzZWN0aW9ucy5zaGlmdCgpOwogICAgICAgIHNlY3Rpb25zLmZvckVhY2goZnVuY3Rpb24obWVkaWFTZWN0aW9uLCBzZHBNTGluZUluZGV4KSB7CiAgICAgICAgICB2YXIgdHJhbnNjZWl2ZXIgPSBzZWxmLnRyYW5zY2VpdmVyc1tzZHBNTGluZUluZGV4XTsKICAgICAgICAgIHZhciBpY2VHYXRoZXJlciA9IHRyYW5zY2VpdmVyLmljZUdhdGhlcmVyOwogICAgICAgICAgdmFyIGljZVRyYW5zcG9ydCA9IHRyYW5zY2VpdmVyLmljZVRyYW5zcG9ydDsKICAgICAgICAgIHZhciBkdGxzVHJhbnNwb3J0ID0gdHJhbnNjZWl2ZXIuZHRsc1RyYW5zcG9ydDsKICAgICAgICAgIHZhciBsb2NhbENhcGFiaWxpdGllcyA9IHRyYW5zY2VpdmVyLmxvY2FsQ2FwYWJpbGl0aWVzOwogICAgICAgICAgdmFyIHJlbW90ZUNhcGFiaWxpdGllcyA9IHRyYW5zY2VpdmVyLnJlbW90ZUNhcGFiaWxpdGllczsKICAgICAgICAgIHZhciByZWplY3RlZCA9IG1lZGlhU2VjdGlvbi5zcGxpdCgnXG4nLCAxKVswXQogICAgICAgICAgICAgIC5zcGxpdCgnICcsIDIpWzFdID09PSAnMCc7CgogICAgICAgICAgaWYgKCFyZWplY3RlZCkgewogICAgICAgICAgICB2YXIgcmVtb3RlSWNlUGFyYW1ldGVycyA9IFNEUFV0aWxzLmdldEljZVBhcmFtZXRlcnMobWVkaWFTZWN0aW9uLAogICAgICAgICAgICAgICAgc2Vzc2lvbnBhcnQpOwogICAgICAgICAgICBpY2VUcmFuc3BvcnQuc3RhcnQoaWNlR2F0aGVyZXIsIHJlbW90ZUljZVBhcmFtZXRlcnMsICdjb250cm9sbGVkJyk7CgogICAgICAgICAgICB2YXIgcmVtb3RlRHRsc1BhcmFtZXRlcnMgPSBTRFBVdGlscy5nZXREdGxzUGFyYW1ldGVycyhtZWRpYVNlY3Rpb24sCiAgICAgICAgICAgICAgc2Vzc2lvbnBhcnQpOwogICAgICAgICAgICBkdGxzVHJhbnNwb3J0LnN0YXJ0KHJlbW90ZUR0bHNQYXJhbWV0ZXJzKTsKCiAgICAgICAgICAgIC8vIENhbGN1bGF0ZSBpbnRlcnNlY3Rpb24gb2YgY2FwYWJpbGl0aWVzLgogICAgICAgICAgICB2YXIgcGFyYW1zID0gc2VsZi5fZ2V0Q29tbW9uQ2FwYWJpbGl0aWVzKGxvY2FsQ2FwYWJpbGl0aWVzLAogICAgICAgICAgICAgICAgcmVtb3RlQ2FwYWJpbGl0aWVzKTsKCiAgICAgICAgICAgIC8vIFN0YXJ0IHRoZSBSVENSdHBTZW5kZXIuIFRoZSBSVENSdHBSZWNlaXZlciBmb3IgdGhpcyB0cmFuc2NlaXZlcgogICAgICAgICAgICAvLyBoYXMgYWxyZWFkeSBiZWVuIHN0YXJ0ZWQgaW4gc2V0UmVtb3RlRGVzY3JpcHRpb24uCiAgICAgICAgICAgIHNlbGYuX3RyYW5zY2VpdmUodHJhbnNjZWl2ZXIsCiAgICAgICAgICAgICAgICBwYXJhbXMuY29kZWNzLmxlbmd0aCA+IDAsCiAgICAgICAgICAgICAgICBmYWxzZSk7CiAgICAgICAgICB9CiAgICAgICAgfSk7CiAgICAgIH0KCiAgICAgIHRoaXMubG9jYWxEZXNjcmlwdGlvbiA9IGRlc2NyaXB0aW9uOwogICAgICBzd2l0Y2ggKGRlc2NyaXB0aW9uLnR5cGUpIHsKICAgICAgICBjYXNlICdvZmZlcic6CiAgICAgICAgICB0aGlzLl91cGRhdGVTaWduYWxpbmdTdGF0ZSgnaGF2ZS1sb2NhbC1vZmZlcicpOwogICAgICAgICAgYnJlYWs7CiAgICAgICAgY2FzZSAnYW5zd2VyJzoKICAgICAgICAgIHRoaXMuX3VwZGF0ZVNpZ25hbGluZ1N0YXRlKCdzdGFibGUnKTsKICAgICAgICAgIGJyZWFrOwogICAgICAgIGRlZmF1bHQ6CiAgICAgICAgICB0aHJvdyBuZXcgVHlwZUVycm9yKCd1bnN1cHBvcnRlZCB0eXBlICInICsgZGVzY3JpcHRpb24udHlwZSArICciJyk7CiAgICAgIH0KCiAgICAgIC8vIElmIGEgc3VjY2VzcyBjYWxsYmFjayB3YXMgcHJvdmlkZWQsIGVtaXQgSUNFIGNhbmRpZGF0ZXMgYWZ0ZXIgaXQgaGFzIGJlZW4KICAgICAgLy8gZXhlY3V0ZWQuIE90aGVyd2lzZSwgZW1pdCBjYWxsYmFjayBhZnRlciB0aGUgUHJvbWlzZSBpcyByZXNvbHZlZC4KICAgICAgdmFyIGhhc0NhbGxiYWNrID0gYXJndW1lbnRzLmxlbmd0aCA+IDEgJiYKICAgICAgICB0eXBlb2YgYXJndW1lbnRzWzFdID09PSAnZnVuY3Rpb24nOwogICAgICBpZiAoaGFzQ2FsbGJhY2spIHsKICAgICAgICB2YXIgY2IgPSBhcmd1bWVudHNbMV07CiAgICAgICAgd2luZG93LnNldFRpbWVvdXQoZnVuY3Rpb24oKSB7CiAgICAgICAgICBjYigpOwogICAgICAgICAgc2VsZi5fZW1pdEJ1ZmZlcmVkQ2FuZGlkYXRlcygpOwogICAgICAgIH0sIDApOwogICAgICB9CiAgICAgIHZhciBwID0gUHJvbWlzZS5yZXNvbHZlKCk7CiAgICAgIHAudGhlbihmdW5jdGlvbigpIHsKICAgICAgICBpZiAoIWhhc0NhbGxiYWNrKSB7CiAgICAgICAgICB3aW5kb3cuc2V0VGltZW91dChzZWxmLl9lbWl0QnVmZmVyZWRDYW5kaWRhdGVzLmJpbmQoc2VsZiksIDApOwogICAgICAgIH0KICAgICAgfSk7CiAgICAgIHJldHVybiBwOwogICAgfTsKCiAgICB3aW5kb3cuUlRDUGVlckNvbm5lY3Rpb24ucHJvdG90eXBlLnNldFJlbW90ZURlc2NyaXB0aW9uID0KICAgICAgICBmdW5jdGlvbihkZXNjcmlwdGlvbikgewogICAgICB2YXIgc2VsZiA9IHRoaXM7CiAgICAgIHZhciBzdHJlYW0gPSBuZXcgTWVkaWFTdHJlYW0oKTsKICAgICAgdmFyIHNlY3Rpb25zID0gU0RQVXRpbHMuc3BsaXRTZWN0aW9ucyhkZXNjcmlwdGlvbi5zZHApOwogICAgICB2YXIgc2Vzc2lvbnBhcnQgPSBzZWN0aW9ucy5zaGlmdCgpOwogICAgICBzZWN0aW9ucy5mb3JFYWNoKGZ1bmN0aW9uKG1lZGlhU2VjdGlvbiwgc2RwTUxpbmVJbmRleCkgewogICAgICAgIHZhciBsaW5lcyA9IFNEUFV0aWxzLnNwbGl0TGluZXMobWVkaWFTZWN0aW9uKTsKICAgICAgICB2YXIgbWxpbmUgPSBsaW5lc1swXS5zdWJzdHIoMikuc3BsaXQoJyAnKTsKICAgICAgICB2YXIga2luZCA9IG1saW5lWzBdOwogICAgICAgIHZhciByZWplY3RlZCA9IG1saW5lWzFdID09PSAnMCc7CiAgICAgICAgdmFyIGRpcmVjdGlvbiA9IFNEUFV0aWxzLmdldERpcmVjdGlvbihtZWRpYVNlY3Rpb24sIHNlc3Npb25wYXJ0KTsKCiAgICAgICAgdmFyIHRyYW5zY2VpdmVyOwogICAgICAgIHZhciBpY2VHYXRoZXJlcjsKICAgICAgICB2YXIgaWNlVHJhbnNwb3J0OwogICAgICAgIHZhciBkdGxzVHJhbnNwb3J0OwogICAgICAgIHZhciBydHBTZW5kZXI7CiAgICAgICAgdmFyIHJ0cFJlY2VpdmVyOwogICAgICAgIHZhciBzZW5kU3NyYzsKICAgICAgICB2YXIgcmVjdlNzcmM7CiAgICAgICAgdmFyIGxvY2FsQ2FwYWJpbGl0aWVzOwoKICAgICAgICAvLyBGSVhNRTogZW5zdXJlIHRoZSBtZWRpYVNlY3Rpb24gaGFzIHJ0Y3AtbXV4IHNldC4KICAgICAgICB2YXIgcmVtb3RlQ2FwYWJpbGl0aWVzID0gU0RQVXRpbHMucGFyc2VSdHBQYXJhbWV0ZXJzKG1lZGlhU2VjdGlvbik7CiAgICAgICAgdmFyIHJlbW90ZUljZVBhcmFtZXRlcnM7CiAgICAgICAgdmFyIHJlbW90ZUR0bHNQYXJhbWV0ZXJzOwogICAgICAgIGlmICghcmVqZWN0ZWQpIHsKICAgICAgICAgIHJlbW90ZUljZVBhcmFtZXRlcnMgPSBTRFBVdGlscy5nZXRJY2VQYXJhbWV0ZXJzKG1lZGlhU2VjdGlvbiwKICAgICAgICAgICAgICBzZXNzaW9ucGFydCk7CiAgICAgICAgICByZW1vdGVEdGxzUGFyYW1ldGVycyA9IFNEUFV0aWxzLmdldER0bHNQYXJhbWV0ZXJzKG1lZGlhU2VjdGlvbiwKICAgICAgICAgICAgICBzZXNzaW9ucGFydCk7CiAgICAgICAgfQogICAgICAgIHZhciBtaWQgPSBTRFBVdGlscy5tYXRjaFByZWZpeChtZWRpYVNlY3Rpb24sICdhPW1pZDonKVswXS5zdWJzdHIoNik7CgogICAgICAgIHZhciBjbmFtZTsKICAgICAgICAvLyBHZXRzIHRoZSBmaXJzdCBTU1JDLiBOb3RlIHRoYXQgd2l0aCBSVFggdGhlcmUgbWlnaHQgYmUgbXVsdGlwbGUgU1NSQ3MuCiAgICAgICAgdmFyIHJlbW90ZVNzcmMgPSBTRFBVdGlscy5tYXRjaFByZWZpeChtZWRpYVNlY3Rpb24sICdhPXNzcmM6JykKICAgICAgICAgICAgLm1hcChmdW5jdGlvbihsaW5lKSB7CiAgICAgICAgICAgICAgcmV0dXJuIFNEUFV0aWxzLnBhcnNlU3NyY01lZGlhKGxpbmUpOwogICAgICAgICAgICB9KQogICAgICAgICAgICAuZmlsdGVyKGZ1bmN0aW9uKG9iaikgewogICAgICAgICAgICAgIHJldHVybiBvYmouYXR0cmlidXRlID09PSAnY25hbWUnOwogICAgICAgICAgICB9KVswXTsKICAgICAgICBpZiAocmVtb3RlU3NyYykgewogICAgICAgICAgcmVjdlNzcmMgPSBwYXJzZUludChyZW1vdGVTc3JjLnNzcmMsIDEwKTsKICAgICAgICAgIGNuYW1lID0gcmVtb3RlU3NyYy52YWx1ZTsKICAgICAgICB9CgogICAgICAgIGlmIChkZXNjcmlwdGlvbi50eXBlID09PSAnb2ZmZXInKSB7CiAgICAgICAgICB2YXIgdHJhbnNwb3J0cyA9IHNlbGYuX2NyZWF0ZUljZUFuZER0bHNUcmFuc3BvcnRzKG1pZCwgc2RwTUxpbmVJbmRleCk7CgogICAgICAgICAgbG9jYWxDYXBhYmlsaXRpZXMgPSBSVENSdHBSZWNlaXZlci5nZXRDYXBhYmlsaXRpZXMoa2luZCk7CiAgICAgICAgICBzZW5kU3NyYyA9ICgyICogc2RwTUxpbmVJbmRleCArIDIpICogMTAwMTsKCiAgICAgICAgICBydHBSZWNlaXZlciA9IG5ldyBSVENSdHBSZWNlaXZlcih0cmFuc3BvcnRzLmR0bHNUcmFuc3BvcnQsIGtpbmQpOwoKICAgICAgICAgIC8vIEZJWE1FOiBub3QgY29ycmVjdCB3aGVuIHRoZXJlIGFyZSBtdWx0aXBsZSBzdHJlYW1zIGJ1dCB0aGF0IGlzCiAgICAgICAgICAvLyBub3QgY3VycmVudGx5IHN1cHBvcnRlZCBpbiB0aGlzIHNoaW0uCiAgICAgICAgICBzdHJlYW0uYWRkVHJhY2socnRwUmVjZWl2ZXIudHJhY2spOwoKICAgICAgICAgIC8vIEZJWE1FOiBsb29rIGF0IGRpcmVjdGlvbi4KICAgICAgICAgIGlmIChzZWxmLmxvY2FsU3RyZWFtcy5sZW5ndGggPiAwICYmCiAgICAgICAgICAgICAgc2VsZi5sb2NhbFN0cmVhbXNbMF0uZ2V0VHJhY2tzKCkubGVuZ3RoID49IHNkcE1MaW5lSW5kZXgpIHsKICAgICAgICAgICAgLy8gRklYTUU6IGFjdHVhbGx5IG1vcmUgY29tcGxpY2F0ZWQsIG5lZWRzIHRvIG1hdGNoIHR5cGVzIGV0YwogICAgICAgICAgICB2YXIgbG9jYWx0cmFjayA9IHNlbGYubG9jYWxTdHJlYW1zWzBdLmdldFRyYWNrcygpW3NkcE1MaW5lSW5kZXhdOwogICAgICAgICAgICBydHBTZW5kZXIgPSBuZXcgUlRDUnRwU2VuZGVyKGxvY2FsdHJhY2ssIHRyYW5zcG9ydHMuZHRsc1RyYW5zcG9ydCk7CiAgICAgICAgICB9CgogICAgICAgICAgc2VsZi50cmFuc2NlaXZlcnNbc2RwTUxpbmVJbmRleF0gPSB7CiAgICAgICAgICAgIGljZUdhdGhlcmVyOiB0cmFuc3BvcnRzLmljZUdhdGhlcmVyLAogICAgICAgICAgICBpY2VUcmFuc3BvcnQ6IHRyYW5zcG9ydHMuaWNlVHJhbnNwb3J0LAogICAgICAgICAgICBkdGxzVHJhbnNwb3J0OiB0cmFuc3BvcnRzLmR0bHNUcmFuc3BvcnQsCiAgICAgICAgICAgIGxvY2FsQ2FwYWJpbGl0aWVzOiBsb2NhbENhcGFiaWxpdGllcywKICAgICAgICAgICAgcmVtb3RlQ2FwYWJpbGl0aWVzOiByZW1vdGVDYXBhYmlsaXRpZXMsCiAgICAgICAgICAgIHJ0cFNlbmRlcjogcnRwU2VuZGVyLAogICAgICAgICAgICBydHBSZWNlaXZlcjogcnRwUmVjZWl2ZXIsCiAgICAgICAgICAgIGtpbmQ6IGtpbmQsCiAgICAgICAgICAgIG1pZDogbWlkLAogICAgICAgICAgICBjbmFtZTogY25hbWUsCiAgICAgICAgICAgIHNlbmRTc3JjOiBzZW5kU3NyYywKICAgICAgICAgICAgcmVjdlNzcmM6IHJlY3ZTc3JjCiAgICAgICAgICB9OwogICAgICAgICAgLy8gU3RhcnQgdGhlIFJUQ1J0cFJlY2VpdmVyIG5vdy4gVGhlIFJUUFNlbmRlciBpcyBzdGFydGVkIGluIHNldExvY2FsRGVzY3JpcHRpb24uCiAgICAgICAgICBzZWxmLl90cmFuc2NlaXZlKHNlbGYudHJhbnNjZWl2ZXJzW3NkcE1MaW5lSW5kZXhdLAogICAgICAgICAgICAgIGZhbHNlLAogICAgICAgICAgICAgIGRpcmVjdGlvbiA9PT0gJ3NlbmRyZWN2JyB8fCBkaXJlY3Rpb24gPT09ICdzZW5kb25seScpOwogICAgICAgIH0gZWxzZSBpZiAoZGVzY3JpcHRpb24udHlwZSA9PT0gJ2Fuc3dlcicgJiYgIXJlamVjdGVkKSB7CiAgICAgICAgICB0cmFuc2NlaXZlciA9IHNlbGYudHJhbnNjZWl2ZXJzW3NkcE1MaW5lSW5kZXhdOwogICAgICAgICAgaWNlR2F0aGVyZXIgPSB0cmFuc2NlaXZlci5pY2VHYXRoZXJlcjsKICAgICAgICAgIGljZVRyYW5zcG9ydCA9IHRyYW5zY2VpdmVyLmljZVRyYW5zcG9ydDsKICAgICAgICAgIGR0bHNUcmFuc3BvcnQgPSB0cmFuc2NlaXZlci5kdGxzVHJhbnNwb3J0OwogICAgICAgICAgcnRwU2VuZGVyID0gdHJhbnNjZWl2ZXIucnRwU2VuZGVyOwogICAgICAgICAgcnRwUmVjZWl2ZXIgPSB0cmFuc2NlaXZlci5ydHBSZWNlaXZlcjsKICAgICAgICAgIHNlbmRTc3JjID0gdHJhbnNjZWl2ZXIuc2VuZFNzcmM7CiAgICAgICAgICAvL3JlY3ZTc3JjID0gdHJhbnNjZWl2ZXIucmVjdlNzcmM7CiAgICAgICAgICBsb2NhbENhcGFiaWxpdGllcyA9IHRyYW5zY2VpdmVyLmxvY2FsQ2FwYWJpbGl0aWVzOwoKICAgICAgICAgIHNlbGYudHJhbnNjZWl2ZXJzW3NkcE1MaW5lSW5kZXhdLnJlY3ZTc3JjID0gcmVjdlNzcmM7CiAgICAgICAgICBzZWxmLnRyYW5zY2VpdmVyc1tzZHBNTGluZUluZGV4XS5yZW1vdGVDYXBhYmlsaXRpZXMgPQogICAgICAgICAgICAgIHJlbW90ZUNhcGFiaWxpdGllczsKICAgICAgICAgIHNlbGYudHJhbnNjZWl2ZXJzW3NkcE1MaW5lSW5kZXhdLmNuYW1lID0gY25hbWU7CgogICAgICAgICAgaWNlVHJhbnNwb3J0LnN0YXJ0KGljZUdhdGhlcmVyLCByZW1vdGVJY2VQYXJhbWV0ZXJzLCAnY29udHJvbGxpbmcnKTsKICAgICAgICAgIGR0bHNUcmFuc3BvcnQuc3RhcnQocmVtb3RlRHRsc1BhcmFtZXRlcnMpOwoKICAgICAgICAgIHNlbGYuX3RyYW5zY2VpdmUodHJhbnNjZWl2ZXIsCiAgICAgICAgICAgICAgZGlyZWN0aW9uID09PSAnc2VuZHJlY3YnIHx8IGRpcmVjdGlvbiA9PT0gJ3JlY3Zvbmx5JywKICAgICAgICAgICAgICBkaXJlY3Rpb24gPT09ICdzZW5kcmVjdicgfHwgZGlyZWN0aW9uID09PSAnc2VuZG9ubHknKTsKCiAgICAgICAgICBpZiAocnRwUmVjZWl2ZXIgJiYKICAgICAgICAgICAgICAoZGlyZWN0aW9uID09PSAnc2VuZHJlY3YnIHx8IGRpcmVjdGlvbiA9PT0gJ3NlbmRvbmx5JykpIHsKICAgICAgICAgICAgc3RyZWFtLmFkZFRyYWNrKHJ0cFJlY2VpdmVyLnRyYWNrKTsKICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgIC8vIEZJWE1FOiBhY3R1YWxseSB0aGUgcmVjZWl2ZXIgc2hvdWxkIGJlIGNyZWF0ZWQgbGF0ZXIuCiAgICAgICAgICAgIGRlbGV0ZSB0cmFuc2NlaXZlci5ydHBSZWNlaXZlcjsKICAgICAgICAgIH0KICAgICAgICB9CiAgICAgIH0pOwoKICAgICAgdGhpcy5yZW1vdGVEZXNjcmlwdGlvbiA9IGRlc2NyaXB0aW9uOwogICAgICBzd2l0Y2ggKGRlc2NyaXB0aW9uLnR5cGUpIHsKICAgICAgICBjYXNlICdvZmZlcic6CiAgICAgICAgICB0aGlzLl91cGRhdGVTaWduYWxpbmdTdGF0ZSgnaGF2ZS1yZW1vdGUtb2ZmZXInKTsKICAgICAgICAgIGJyZWFrOwogICAgICAgIGNhc2UgJ2Fuc3dlcic6CiAgICAgICAgICB0aGlzLl91cGRhdGVTaWduYWxpbmdTdGF0ZSgnc3RhYmxlJyk7CiAgICAgICAgICBicmVhazsKICAgICAgICBkZWZhdWx0OgogICAgICAgICAgdGhyb3cgbmV3IFR5cGVFcnJvcigndW5zdXBwb3J0ZWQgdHlwZSAiJyArIGRlc2NyaXB0aW9uLnR5cGUgKyAnIicpOwogICAgICB9CiAgICAgIHdpbmRvdy5zZXRUaW1lb3V0KGZ1bmN0aW9uKCkgewogICAgICAgIGlmIChzZWxmLm9uYWRkc3RyZWFtICE9PSBudWxsICYmIHN0cmVhbS5nZXRUcmFja3MoKS5sZW5ndGgpIHsKICAgICAgICAgIHNlbGYucmVtb3RlU3RyZWFtcy5wdXNoKHN0cmVhbSk7CiAgICAgICAgICB3aW5kb3cuc2V0VGltZW91dChmdW5jdGlvbigpIHsKICAgICAgICAgICAgc2VsZi5vbmFkZHN0cmVhbSh7c3RyZWFtOiBzdHJlYW19KTsKICAgICAgICAgIH0sIDApOwogICAgICAgIH0KICAgICAgfSwgMCk7CiAgICAgIGlmIChhcmd1bWVudHMubGVuZ3RoID4gMSAmJiB0eXBlb2YgYXJndW1lbnRzWzFdID09PSAnZnVuY3Rpb24nKSB7CiAgICAgICAgd2luZG93LnNldFRpbWVvdXQoYXJndW1lbnRzWzFdLCAwKTsKICAgICAgfQogICAgICByZXR1cm4gUHJvbWlzZS5yZXNvbHZlKCk7CiAgICB9OwoKICAgIHdpbmRvdy5SVENQZWVyQ29ubmVjdGlvbi5wcm90b3R5cGUuY2xvc2UgPSBmdW5jdGlvbigpIHsKICAgICAgdGhpcy50cmFuc2NlaXZlcnMuZm9yRWFjaChmdW5jdGlvbih0cmFuc2NlaXZlcikgewogICAgICAgIC8qIG5vdCB5ZXQKICAgICAgICBpZiAodHJhbnNjZWl2ZXIuaWNlR2F0aGVyZXIpIHsKICAgICAgICAgIHRyYW5zY2VpdmVyLmljZUdhdGhlcmVyLmNsb3NlKCk7CiAgICAgICAgfQogICAgICAgICovCiAgICAgICAgaWYgKHRyYW5zY2VpdmVyLmljZVRyYW5zcG9ydCkgewogICAgICAgICAgdHJhbnNjZWl2ZXIuaWNlVHJhbnNwb3J0LnN0b3AoKTsKICAgICAgICB9CiAgICAgICAgaWYgKHRyYW5zY2VpdmVyLmR0bHNUcmFuc3BvcnQpIHsKICAgICAgICAgIHRyYW5zY2VpdmVyLmR0bHNUcmFuc3BvcnQuc3RvcCgpOwogICAgICAgIH0KICAgICAgICBpZiAodHJhbnNjZWl2ZXIucnRwU2VuZGVyKSB7CiAgICAgICAgICB0cmFuc2NlaXZlci5ydHBTZW5kZXIuc3RvcCgpOwogICAgICAgIH0KICAgICAgICBpZiAodHJhbnNjZWl2ZXIucnRwUmVjZWl2ZXIpIHsKICAgICAgICAgIHRyYW5zY2VpdmVyLnJ0cFJlY2VpdmVyLnN0b3AoKTsKICAgICAgICB9CiAgICAgIH0pOwogICAgICAvLyBGSVhNRTogY2xlYW4gdXAgdHJhY2tzLCBsb2NhbCBzdHJlYW1zLCByZW1vdGUgc3RyZWFtcywgZXRjCiAgICAgIHRoaXMuX3VwZGF0ZVNpZ25hbGluZ1N0YXRlKCdjbG9zZWQnKTsKICAgIH07CgogICAgLy8gVXBkYXRlIHRoZSBzaWduYWxpbmcgc3RhdGUuCiAgICB3aW5kb3cuUlRDUGVlckNvbm5lY3Rpb24ucHJvdG90eXBlLl91cGRhdGVTaWduYWxpbmdTdGF0ZSA9CiAgICAgICAgZnVuY3Rpb24obmV3U3RhdGUpIHsKICAgICAgdGhpcy5zaWduYWxpbmdTdGF0ZSA9IG5ld1N0YXRlOwogICAgICBpZiAodGhpcy5vbnNpZ25hbGluZ3N0YXRlY2hhbmdlICE9PSBudWxsKSB7CiAgICAgICAgdGhpcy5vbnNpZ25hbGluZ3N0YXRlY2hhbmdlKCk7CiAgICAgIH0KICAgIH07CgogICAgLy8gRGV0ZXJtaW5lIHdoZXRoZXIgdG8gZmlyZSB0aGUgbmVnb3RpYXRpb25uZWVkZWQgZXZlbnQuCiAgICB3aW5kb3cuUlRDUGVlckNvbm5lY3Rpb24ucHJvdG90eXBlLl9tYXliZUZpcmVOZWdvdGlhdGlvbk5lZWRlZCA9CiAgICAgICAgZnVuY3Rpb24oKSB7CiAgICAgIC8vIEZpcmUgYXdheSAoZm9yIG5vdykuCiAgICAgIGlmICh0aGlzLm9ubmVnb3RpYXRpb25uZWVkZWQgIT09IG51bGwpIHsKICAgICAgICB0aGlzLm9ubmVnb3RpYXRpb25uZWVkZWQoKTsKICAgICAgfQogICAgfTsKCiAgICAvLyBVcGRhdGUgdGhlIGNvbm5lY3Rpb24gc3RhdGUuCiAgICB3aW5kb3cuUlRDUGVlckNvbm5lY3Rpb24ucHJvdG90eXBlLl91cGRhdGVDb25uZWN0aW9uU3RhdGUgPQogICAgICAgIGZ1bmN0aW9uKCkgewogICAgICB2YXIgc2VsZiA9IHRoaXM7CiAgICAgIHZhciBuZXdTdGF0ZTsKICAgICAgdmFyIHN0YXRlcyA9IHsKICAgICAgICAnbmV3JzogMCwKICAgICAgICBjbG9zZWQ6IDAsCiAgICAgICAgY29ubmVjdGluZzogMCwKICAgICAgICBjaGVja2luZzogMCwKICAgICAgICBjb25uZWN0ZWQ6IDAsCiAgICAgICAgY29tcGxldGVkOiAwLAogICAgICAgIGZhaWxlZDogMAogICAgICB9OwogICAgICB0aGlzLnRyYW5zY2VpdmVycy5mb3JFYWNoKGZ1bmN0aW9uKHRyYW5zY2VpdmVyKSB7CiAgICAgICAgc3RhdGVzW3RyYW5zY2VpdmVyLmljZVRyYW5zcG9ydC5zdGF0ZV0rKzsKICAgICAgICBzdGF0ZXNbdHJhbnNjZWl2ZXIuZHRsc1RyYW5zcG9ydC5zdGF0ZV0rKzsKICAgICAgfSk7CiAgICAgIC8vIElDRVRyYW5zcG9ydC5jb21wbGV0ZWQgYW5kIGNvbm5lY3RlZCBhcmUgdGhlIHNhbWUgZm9yIHRoaXMgcHVycG9zZS4KICAgICAgc3RhdGVzLmNvbm5lY3RlZCArPSBzdGF0ZXMuY29tcGxldGVkOwoKICAgICAgbmV3U3RhdGUgPSAnbmV3JzsKICAgICAgaWYgKHN0YXRlcy5mYWlsZWQgPiAwKSB7CiAgICAgICAgbmV3U3RhdGUgPSAnZmFpbGVkJzsKICAgICAgfSBlbHNlIGlmIChzdGF0ZXMuY29ubmVjdGluZyA+IDAgfHwgc3RhdGVzLmNoZWNraW5nID4gMCkgewogICAgICAgIG5ld1N0YXRlID0gJ2Nvbm5lY3RpbmcnOwogICAgICB9IGVsc2UgaWYgKHN0YXRlcy5kaXNjb25uZWN0ZWQgPiAwKSB7CiAgICAgICAgbmV3U3RhdGUgPSAnZGlzY29ubmVjdGVkJzsKICAgICAgfSBlbHNlIGlmIChzdGF0ZXMubmV3ID4gMCkgewogICAgICAgIG5ld1N0YXRlID0gJ25ldyc7CiAgICAgIH0gZWxzZSBpZiAoc3RhdGVzLmNvbm5lY3RpbmcgPiAwIHx8IHN0YXRlcy5jb21wbGV0ZWQgPiAwKSB7CiAgICAgICAgbmV3U3RhdGUgPSAnY29ubmVjdGVkJzsKICAgICAgfQoKICAgICAgaWYgKG5ld1N0YXRlICE9PSBzZWxmLmljZUNvbm5lY3Rpb25TdGF0ZSkgewogICAgICAgIHNlbGYuaWNlQ29ubmVjdGlvblN0YXRlID0gbmV3U3RhdGU7CiAgICAgICAgaWYgKHRoaXMub25pY2Vjb25uZWN0aW9uc3RhdGVjaGFuZ2UgIT09IG51bGwpIHsKICAgICAgICAgIHRoaXMub25pY2Vjb25uZWN0aW9uc3RhdGVjaGFuZ2UoKTsKICAgICAgICB9CiAgICAgIH0KICAgIH07CgogICAgd2luZG93LlJUQ1BlZXJDb25uZWN0aW9uLnByb3RvdHlwZS5jcmVhdGVPZmZlciA9IGZ1bmN0aW9uKCkgewogICAgICB2YXIgc2VsZiA9IHRoaXM7CiAgICAgIGlmICh0aGlzLl9wZW5kaW5nT2ZmZXIpIHsKICAgICAgICB0aHJvdyBuZXcgRXJyb3IoJ2NyZWF0ZU9mZmVyIGNhbGxlZCB3aGlsZSB0aGVyZSBpcyBhIHBlbmRpbmcgb2ZmZXIuJyk7CiAgICAgIH0KICAgICAgdmFyIG9mZmVyT3B0aW9uczsKICAgICAgaWYgKGFyZ3VtZW50cy5sZW5ndGggPT09IDEgJiYgdHlwZW9mIGFyZ3VtZW50c1swXSAhPT0gJ2Z1bmN0aW9uJykgewogICAgICAgIG9mZmVyT3B0aW9ucyA9IGFyZ3VtZW50c1swXTsKICAgICAgfSBlbHNlIGlmIChhcmd1bWVudHMubGVuZ3RoID09PSAzKSB7CiAgICAgICAgb2ZmZXJPcHRpb25zID0gYXJndW1lbnRzWzJdOwogICAgICB9CgogICAgICB2YXIgdHJhY2tzID0gW107CiAgICAgIHZhciBudW1BdWRpb1RyYWNrcyA9IDA7CiAgICAgIHZhciBudW1WaWRlb1RyYWNrcyA9IDA7CiAgICAgIC8vIERlZmF1bHQgdG8gc2VuZHJlY3YuCiAgICAgIGlmICh0aGlzLmxvY2FsU3RyZWFtcy5sZW5ndGgpIHsKICAgICAgICBudW1BdWRpb1RyYWNrcyA9IHRoaXMubG9jYWxTdHJlYW1zWzBdLmdldEF1ZGlvVHJhY2tzKCkubGVuZ3RoOwogICAgICAgIG51bVZpZGVvVHJhY2tzID0gdGhpcy5sb2NhbFN0cmVhbXNbMF0uZ2V0VmlkZW9UcmFja3MoKS5sZW5ndGg7CiAgICAgIH0KICAgICAgLy8gRGV0ZXJtaW5lIG51bWJlciBvZiBhdWRpbyBhbmQgdmlkZW8gdHJhY2tzIHdlIG5lZWQgdG8gc2VuZC9yZWN2LgogICAgICBpZiAob2ZmZXJPcHRpb25zKSB7CiAgICAgICAgLy8gUmVqZWN0IENocm9tZSBsZWdhY3kgY29uc3RyYWludHMuCiAgICAgICAgaWYgKG9mZmVyT3B0aW9ucy5tYW5kYXRvcnkgfHwgb2ZmZXJPcHRpb25zLm9wdGlvbmFsKSB7CiAgICAgICAgICB0aHJvdyBuZXcgVHlwZUVycm9yKAogICAgICAgICAgICAgICdMZWdhY3kgbWFuZGF0b3J5L29wdGlvbmFsIGNvbnN0cmFpbnRzIG5vdCBzdXBwb3J0ZWQuJyk7CiAgICAgICAgfQogICAgICAgIGlmIChvZmZlck9wdGlvbnMub2ZmZXJUb1JlY2VpdmVBdWRpbyAhPT0gdW5kZWZpbmVkKSB7CiAgICAgICAgICBudW1BdWRpb1RyYWNrcyA9IG9mZmVyT3B0aW9ucy5vZmZlclRvUmVjZWl2ZUF1ZGlvOwogICAgICAgIH0KICAgICAgICBpZiAob2ZmZXJPcHRpb25zLm9mZmVyVG9SZWNlaXZlVmlkZW8gIT09IHVuZGVmaW5lZCkgewogICAgICAgICAgbnVtVmlkZW9UcmFja3MgPSBvZmZlck9wdGlvbnMub2ZmZXJUb1JlY2VpdmVWaWRlbzsKICAgICAgICB9CiAgICAgIH0KICAgICAgaWYgKHRoaXMubG9jYWxTdHJlYW1zLmxlbmd0aCkgewogICAgICAgIC8vIFB1c2ggbG9jYWwgc3RyZWFtcy4KICAgICAgICB0aGlzLmxvY2FsU3RyZWFtc1swXS5nZXRUcmFja3MoKS5mb3JFYWNoKGZ1bmN0aW9uKHRyYWNrKSB7CiAgICAgICAgICB0cmFja3MucHVzaCh7CiAgICAgICAgICAgIGtpbmQ6IHRyYWNrLmtpbmQsCiAgICAgICAgICAgIHRyYWNrOiB0cmFjaywKICAgICAgICAgICAgd2FudFJlY2VpdmU6IHRyYWNrLmtpbmQgPT09ICdhdWRpbycgPwogICAgICAgICAgICAgICAgbnVtQXVkaW9UcmFja3MgPiAwIDogbnVtVmlkZW9UcmFja3MgPiAwCiAgICAgICAgICB9KTsKICAgICAgICAgIGlmICh0cmFjay5raW5kID09PSAnYXVkaW8nKSB7CiAgICAgICAgICAgIG51bUF1ZGlvVHJhY2tzLS07CiAgICAgICAgICB9IGVsc2UgaWYgKHRyYWNrLmtpbmQgPT09ICd2aWRlbycpIHsKICAgICAgICAgICAgbnVtVmlkZW9UcmFja3MtLTsKICAgICAgICAgIH0KICAgICAgICB9KTsKICAgICAgfQogICAgICAvLyBDcmVhdGUgTS1saW5lcyBmb3IgcmVjdm9ubHkgc3RyZWFtcy4KICAgICAgd2hpbGUgKG51bUF1ZGlvVHJhY2tzID4gMCB8fCBudW1WaWRlb1RyYWNrcyA+IDApIHsKICAgICAgICBpZiAobnVtQXVkaW9UcmFja3MgPiAwKSB7CiAgICAgICAgICB0cmFja3MucHVzaCh7CiAgICAgICAgICAgIGtpbmQ6ICdhdWRpbycsCiAgICAgICAgICAgIHdhbnRSZWNlaXZlOiB0cnVlCiAgICAgICAgICB9KTsKICAgICAgICAgIG51bUF1ZGlvVHJhY2tzLS07CiAgICAgICAgfQogICAgICAgIGlmIChudW1WaWRlb1RyYWNrcyA+IDApIHsKICAgICAgICAgIHRyYWNrcy5wdXNoKHsKICAgICAgICAgICAga2luZDogJ3ZpZGVvJywKICAgICAgICAgICAgd2FudFJlY2VpdmU6IHRydWUKICAgICAgICAgIH0pOwogICAgICAgICAgbnVtVmlkZW9UcmFja3MtLTsKICAgICAgICB9CiAgICAgIH0KCiAgICAgIHZhciBzZHAgPSBTRFBVdGlscy53cml0ZVNlc3Npb25Cb2lsZXJwbGF0ZSgpOwogICAgICB2YXIgdHJhbnNjZWl2ZXJzID0gW107CiAgICAgIHRyYWNrcy5mb3JFYWNoKGZ1bmN0aW9uKG1saW5lLCBzZHBNTGluZUluZGV4KSB7CiAgICAgICAgLy8gRm9yIGVhY2ggdHJhY2ssIGNyZWF0ZSBhbiBpY2UgZ2F0aGVyZXIsIGljZSB0cmFuc3BvcnQsIGR0bHMgdHJhbnNwb3J0LAogICAgICAgIC8vIHBvdGVudGlhbGx5IHJ0cHNlbmRlciBhbmQgcnRwcmVjZWl2ZXIuCiAgICAgICAgdmFyIHRyYWNrID0gbWxpbmUudHJhY2s7CiAgICAgICAgdmFyIGtpbmQgPSBtbGluZS5raW5kOwogICAgICAgIHZhciBtaWQgPSBnZW5lcmF0ZUlkZW50aWZpZXIoKTsKCiAgICAgICAgdmFyIHRyYW5zcG9ydHMgPSBzZWxmLl9jcmVhdGVJY2VBbmREdGxzVHJhbnNwb3J0cyhtaWQsIHNkcE1MaW5lSW5kZXgpOwoKICAgICAgICB2YXIgbG9jYWxDYXBhYmlsaXRpZXMgPSBSVENSdHBTZW5kZXIuZ2V0Q2FwYWJpbGl0aWVzKGtpbmQpOwogICAgICAgIHZhciBydHBTZW5kZXI7CiAgICAgICAgdmFyIHJ0cFJlY2VpdmVyOwoKICAgICAgICAvLyBnZW5lcmF0ZSBhbiBzc3JjIG5vdywgdG8gYmUgdXNlZCBsYXRlciBpbiBydHBTZW5kZXIuc2VuZAogICAgICAgIHZhciBzZW5kU3NyYyA9ICgyICogc2RwTUxpbmVJbmRleCArIDEpICogMTAwMTsKICAgICAgICBpZiAodHJhY2spIHsKICAgICAgICAgIHJ0cFNlbmRlciA9IG5ldyBSVENSdHBTZW5kZXIodHJhY2ssIHRyYW5zcG9ydHMuZHRsc1RyYW5zcG9ydCk7CiAgICAgICAgfQoKICAgICAgICBpZiAobWxpbmUud2FudFJlY2VpdmUpIHsKICAgICAgICAgIHJ0cFJlY2VpdmVyID0gbmV3IFJUQ1J0cFJlY2VpdmVyKHRyYW5zcG9ydHMuZHRsc1RyYW5zcG9ydCwga2luZCk7CiAgICAgICAgfQoKICAgICAgICB0cmFuc2NlaXZlcnNbc2RwTUxpbmVJbmRleF0gPSB7CiAgICAgICAgICBpY2VHYXRoZXJlcjogdHJhbnNwb3J0cy5pY2VHYXRoZXJlciwKICAgICAgICAgIGljZVRyYW5zcG9ydDogdHJhbnNwb3J0cy5pY2VUcmFuc3BvcnQsCiAgICAgICAgICBkdGxzVHJhbnNwb3J0OiB0cmFuc3BvcnRzLmR0bHNUcmFuc3BvcnQsCiAgICAgICAgICBsb2NhbENhcGFiaWxpdGllczogbG9jYWxDYXBhYmlsaXRpZXMsCiAgICAgICAgICByZW1vdGVDYXBhYmlsaXRpZXM6IG51bGwsCiAgICAgICAgICBydHBTZW5kZXI6IHJ0cFNlbmRlciwKICAgICAgICAgIHJ0cFJlY2VpdmVyOiBydHBSZWNlaXZlciwKICAgICAgICAgIGtpbmQ6IGtpbmQsCiAgICAgICAgICBtaWQ6IG1pZCwKICAgICAgICAgIHNlbmRTc3JjOiBzZW5kU3NyYywKICAgICAgICAgIHJlY3ZTc3JjOiBudWxsCiAgICAgICAgfTsKICAgICAgICB2YXIgdHJhbnNjZWl2ZXIgPSB0cmFuc2NlaXZlcnNbc2RwTUxpbmVJbmRleF07CiAgICAgICAgc2RwICs9IFNEUFV0aWxzLndyaXRlTWVkaWFTZWN0aW9uKHRyYW5zY2VpdmVyLAogICAgICAgICAgICB0cmFuc2NlaXZlci5sb2NhbENhcGFiaWxpdGllcywgJ29mZmVyJywgc2VsZi5sb2NhbFN0cmVhbXNbMF0pOwogICAgICB9KTsKCiAgICAgIHRoaXMuX3BlbmRpbmdPZmZlciA9IHRyYW5zY2VpdmVyczsKICAgICAgdmFyIGRlc2MgPSBuZXcgUlRDU2Vzc2lvbkRlc2NyaXB0aW9uKHsKICAgICAgICB0eXBlOiAnb2ZmZXInLAogICAgICAgIHNkcDogc2RwCiAgICAgIH0pOwogICAgICBpZiAoYXJndW1lbnRzLmxlbmd0aCAmJiB0eXBlb2YgYXJndW1lbnRzWzBdID09PSAnZnVuY3Rpb24nKSB7CiAgICAgICAgd2luZG93LnNldFRpbWVvdXQoYXJndW1lbnRzWzBdLCAwLCBkZXNjKTsKICAgICAgfQogICAgICByZXR1cm4gUHJvbWlzZS5yZXNvbHZlKGRlc2MpOwogICAgfTsKCiAgICB3aW5kb3cuUlRDUGVlckNvbm5lY3Rpb24ucHJvdG90eXBlLmNyZWF0ZUFuc3dlciA9IGZ1bmN0aW9uKCkgewogICAgICB2YXIgc2VsZiA9IHRoaXM7CiAgICAgIHZhciBhbnN3ZXJPcHRpb25zOwogICAgICBpZiAoYXJndW1lbnRzLmxlbmd0aCA9PT0gMSAmJiB0eXBlb2YgYXJndW1lbnRzWzBdICE9PSAnZnVuY3Rpb24nKSB7CiAgICAgICAgYW5zd2VyT3B0aW9ucyA9IGFyZ3VtZW50c1swXTsKICAgICAgfSBlbHNlIGlmIChhcmd1bWVudHMubGVuZ3RoID09PSAzKSB7CiAgICAgICAgYW5zd2VyT3B0aW9ucyA9IGFyZ3VtZW50c1syXTsKICAgICAgfQoKICAgICAgdmFyIHNkcCA9IFNEUFV0aWxzLndyaXRlU2Vzc2lvbkJvaWxlcnBsYXRlKCk7CiAgICAgIHRoaXMudHJhbnNjZWl2ZXJzLmZvckVhY2goZnVuY3Rpb24odHJhbnNjZWl2ZXIpIHsKICAgICAgICAvLyBDYWxjdWxhdGUgaW50ZXJzZWN0aW9uIG9mIGNhcGFiaWxpdGllcy4KICAgICAgICB2YXIgY29tbW9uQ2FwYWJpbGl0aWVzID0gc2VsZi5fZ2V0Q29tbW9uQ2FwYWJpbGl0aWVzKAogICAgICAgICAgICB0cmFuc2NlaXZlci5sb2NhbENhcGFiaWxpdGllcywKICAgICAgICAgICAgdHJhbnNjZWl2ZXIucmVtb3RlQ2FwYWJpbGl0aWVzKTsKCiAgICAgICAgc2RwICs9IFNEUFV0aWxzLndyaXRlTWVkaWFTZWN0aW9uKHRyYW5zY2VpdmVyLCBjb21tb25DYXBhYmlsaXRpZXMsCiAgICAgICAgICAgICdhbnN3ZXInLCBzZWxmLmxvY2FsU3RyZWFtc1swXSk7CiAgICAgIH0pOwoKICAgICAgdmFyIGRlc2MgPSBuZXcgUlRDU2Vzc2lvbkRlc2NyaXB0aW9uKHsKICAgICAgICB0eXBlOiAnYW5zd2VyJywKICAgICAgICBzZHA6IHNkcAogICAgICB9KTsKICAgICAgaWYgKGFyZ3VtZW50cy5sZW5ndGggJiYgdHlwZW9mIGFyZ3VtZW50c1swXSA9PT0gJ2Z1bmN0aW9uJykgewogICAgICAgIHdpbmRvdy5zZXRUaW1lb3V0KGFyZ3VtZW50c1swXSwgMCwgZGVzYyk7CiAgICAgIH0KICAgICAgcmV0dXJuIFByb21pc2UucmVzb2x2ZShkZXNjKTsKICAgIH07CgogICAgd2luZG93LlJUQ1BlZXJDb25uZWN0aW9uLnByb3RvdHlwZS5hZGRJY2VDYW5kaWRhdGUgPSBmdW5jdGlvbihjYW5kaWRhdGUpIHsKICAgICAgdmFyIG1MaW5lSW5kZXggPSBjYW5kaWRhdGUuc2RwTUxpbmVJbmRleDsKICAgICAgaWYgKGNhbmRpZGF0ZS5zZHBNaWQpIHsKICAgICAgICBmb3IgKHZhciBpID0gMDsgaSA8IHRoaXMudHJhbnNjZWl2ZXJzLmxlbmd0aDsgaSsrKSB7CiAgICAgICAgICBpZiAodGhpcy50cmFuc2NlaXZlcnNbaV0ubWlkID09PSBjYW5kaWRhdGUuc2RwTWlkKSB7CiAgICAgICAgICAgIG1MaW5lSW5kZXggPSBpOwogICAgICAgICAgICBicmVhazsKICAgICAgICAgIH0KICAgICAgICB9CiAgICAgIH0KICAgICAgdmFyIHRyYW5zY2VpdmVyID0gdGhpcy50cmFuc2NlaXZlcnNbbUxpbmVJbmRleF07CiAgICAgIGlmICh0cmFuc2NlaXZlcikgewogICAgICAgIHZhciBjYW5kID0gT2JqZWN0LmtleXMoY2FuZGlkYXRlLmNhbmRpZGF0ZSkubGVuZ3RoID4gMCA/CiAgICAgICAgICAgIFNEUFV0aWxzLnBhcnNlQ2FuZGlkYXRlKGNhbmRpZGF0ZS5jYW5kaWRhdGUpIDoge307CiAgICAgICAgLy8gSWdub3JlIENocm9tZSdzIGludmFsaWQgY2FuZGlkYXRlcyBzaW5jZSBFZGdlIGRvZXMgbm90IGxpa2UgdGhlbS4KICAgICAgICBpZiAoY2FuZC5wcm90b2NvbCA9PT0gJ3RjcCcgJiYgY2FuZC5wb3J0ID09PSAwKSB7CiAgICAgICAgICByZXR1cm47CiAgICAgICAgfQogICAgICAgIC8vIElnbm9yZSBSVENQIGNhbmRpZGF0ZXMsIHdlIGFzc3VtZSBSVENQLU1VWC4KICAgICAgICBpZiAoY2FuZC5jb21wb25lbnQgIT09ICcxJykgewogICAgICAgICAgcmV0dXJuOwogICAgICAgIH0KICAgICAgICAvLyBBIGRpcnR5IGhhY2sgdG8gbWFrZSBzYW1wbGVzIHdvcmsuCiAgICAgICAgaWYgKGNhbmQudHlwZSA9PT0gJ2VuZE9mQ2FuZGlkYXRlcycpIHsKICAgICAgICAgIGNhbmQgPSB7fTsKICAgICAgICB9CiAgICAgICAgdHJhbnNjZWl2ZXIuaWNlVHJhbnNwb3J0LmFkZFJlbW90ZUNhbmRpZGF0ZShjYW5kKTsKICAgICAgfQogICAgICBpZiAoYXJndW1lbnRzLmxlbmd0aCA+IDEgJiYgdHlwZW9mIGFyZ3VtZW50c1sxXSA9PT0gJ2Z1bmN0aW9uJykgewogICAgICAgIHdpbmRvdy5zZXRUaW1lb3V0KGFyZ3VtZW50c1sxXSwgMCk7CiAgICAgIH0KICAgICAgcmV0dXJuIFByb21pc2UucmVzb2x2ZSgpOwogICAgfTsKCiAgICB3aW5kb3cuUlRDUGVlckNvbm5lY3Rpb24ucHJvdG90eXBlLmdldFN0YXRzID0gZnVuY3Rpb24oKSB7CiAgICAgIHZhciBwcm9taXNlcyA9IFtdOwogICAgICB0aGlzLnRyYW5zY2VpdmVycy5mb3JFYWNoKGZ1bmN0aW9uKHRyYW5zY2VpdmVyKSB7CiAgICAgICAgWydydHBTZW5kZXInLCAncnRwUmVjZWl2ZXInLCAnaWNlR2F0aGVyZXInLCAnaWNlVHJhbnNwb3J0JywKICAgICAgICAgICAgJ2R0bHNUcmFuc3BvcnQnXS5mb3JFYWNoKGZ1bmN0aW9uKG1ldGhvZCkgewogICAgICAgICAgaWYgKHRyYW5zY2VpdmVyW21ldGhvZF0pIHsKICAgICAgICAgICAgcHJvbWlzZXMucHVzaCh0cmFuc2NlaXZlclttZXRob2RdLmdldFN0YXRzKCkpOwogICAgICAgICAgfQogICAgICAgIH0pOwogICAgICB9KTsKICAgICAgdmFyIGNiID0gYXJndW1lbnRzLmxlbmd0aCA+IDEgJiYgdHlwZW9mIGFyZ3VtZW50c1sxXSA9PT0gJ2Z1bmN0aW9uJyAmJgogICAgICAgICAgYXJndW1lbnRzWzFdOwogICAgICByZXR1cm4gbmV3IFByb21pc2UoZnVuY3Rpb24ocmVzb2x2ZSkgewogICAgICAgIHZhciByZXN1bHRzID0ge307CiAgICAgICAgUHJvbWlzZS5hbGwocHJvbWlzZXMpLnRoZW4oZnVuY3Rpb24ocmVzKSB7CiAgICAgICAgICByZXMuZm9yRWFjaChmdW5jdGlvbihyZXN1bHQpIHsKICAgICAgICAgICAgT2JqZWN0LmtleXMocmVzdWx0KS5mb3JFYWNoKGZ1bmN0aW9uKGlkKSB7CiAgICAgICAgICAgICAgcmVzdWx0c1tpZF0gPSByZXN1bHRbaWRdOwogICAgICAgICAgICB9KTsKICAgICAgICAgIH0pOwogICAgICAgICAgaWYgKGNiKSB7CiAgICAgICAgICAgIHdpbmRvdy5zZXRUaW1lb3V0KGNiLCAwLCByZXN1bHRzKTsKICAgICAgICAgIH0KICAgICAgICAgIHJlc29sdmUocmVzdWx0cyk7CiAgICAgICAgfSk7CiAgICAgIH0pOwogICAgfTsKICB9Cn0gZWxzZSB7CiAgd2VicnRjVXRpbHMubG9nKCdCcm93c2VyIGRvZXMgbm90IGFwcGVhciB0byBiZSBXZWJSVEMtY2FwYWJsZScpOwp9CgovLyBQb2x5ZmlsbCBvbnRyYWNrIG9uIGJyb3dzZXJzIHRoYXQgZG9uJ3QgeWV0IGhhdmUgaXQKaWYgKHR5cGVvZiB3aW5kb3cgPT09ICdvYmplY3QnICYmIHdpbmRvdy5SVENQZWVyQ29ubmVjdGlvbiAmJiAhKCdvbnRyYWNrJyBpbgogICAgd2luZG93LlJUQ1BlZXJDb25uZWN0aW9uLnByb3RvdHlwZSkpIHsKICBPYmplY3QuZGVmaW5lUHJvcGVydHkod2luZG93LlJUQ1BlZXJDb25uZWN0aW9uLnByb3RvdHlwZSwgJ29udHJhY2snLCB7CiAgICBnZXQ6IGZ1bmN0aW9uKCkgeyByZXR1cm4gdGhpcy5fb250cmFjazsgfSwKICAgIHNldDogZnVuY3Rpb24oZikgewogICAgICB2YXIgc2VsZiA9IHRoaXM7CiAgICAgIGlmICh0aGlzLl9vbnRyYWNrKSB7CiAgICAgICAgdGhpcy5yZW1vdmVFdmVudExpc3RlbmVyKCd0cmFjaycsIHRoaXMuX29udHJhY2spOwogICAgICAgIHRoaXMucmVtb3ZlRXZlbnRMaXN0ZW5lcignYWRkc3RyZWFtJywgdGhpcy5fb250cmFja3BvbHkpOwogICAgICB9CiAgICAgIHRoaXMuYWRkRXZlbnRMaXN0ZW5lcigndHJhY2snLCB0aGlzLl9vbnRyYWNrID0gZik7CiAgICAgIHRoaXMuYWRkRXZlbnRMaXN0ZW5lcignYWRkc3RyZWFtJywgdGhpcy5fb250cmFja3BvbHkgPSBmdW5jdGlvbihlKSB7CiAgICAgICAgaWYgKHdlYnJ0Y0RldGVjdGVkQnJvd3NlciA9PT0gJ2Nocm9tZScpIHsKICAgICAgICAgIC8vIG9uYWRkc3RyZWFtIGRvZXMgbm90IGZpcmUgd2hlbiBhIHRyYWNrIGlzIGFkZGVkIHRvIGFuIGV4aXN0aW5nIHN0cmVhbS4KICAgICAgICAgIC8vIGJ1dCBzdHJlYW0ub25hZGR0cmFjayBpcyBpbXBsZW1lbnRlZCBzbyB3ZSB1c2UgdGjjgZ90CiAgICAgICAgICBlLnN0cmVhbS5hZGRFdmVudExpc3RlbmVyKCdhZGR0cmFjaycsIGZ1bmN0aW9uKHRlKSB7CiAgICAgICAgICAgIHZhciBldmVudCA9IG5ldyBFdmVudCgndHJhY2snKTsKICAgICAgICAgICAgZXZlbnQudHJhY2sgPSB0ZS50cmFjazsKICAgICAgICAgICAgZXZlbnQucmVjZWl2ZXIgPSB7dHJhY2s6IHRlLnRyYWNrfTsKICAgICAgICAgICAgZXZlbnQuc3RyZWFtcyA9IFtlLnN0cmVhbV07CiAgICAgICAgICAgIHNlbGYuZGlzcGF0Y2hFdmVudChldmVudCk7CiAgICAgICAgICB9KTsKICAgICAgICB9CiAgICAgICAgZS5zdHJlYW0uZ2V0VHJhY2tzKCkuZm9yRWFjaChmdW5jdGlvbih0cmFjaykgewogICAgICAgICAgdmFyIGV2ZW50ID0gbmV3IEV2ZW50KCd0cmFjaycpOwogICAgICAgICAgZXZlbnQudHJhY2sgPSB0cmFjazsKICAgICAgICAgIGV2ZW50LnJlY2VpdmVyID0ge3RyYWNrOiB0cmFja307CiAgICAgICAgICBldmVudC5zdHJlYW1zID0gW2Uuc3RyZWFtXTsKICAgICAgICAgIHRoaXMuZGlzcGF0Y2hFdmVudChldmVudCk7CiAgICAgICAgfS5iaW5kKHRoaXMpKTsKICAgICAgfS5iaW5kKHRoaXMpKTsKICAgIH0KICB9KTsKfQoKLy8gUmV0dXJucyB0aGUgcmVzdWx0IG9mIGdldFVzZXJNZWRpYSBhcyBhIFByb21pc2UuCmZ1bmN0aW9uIHJlcXVlc3RVc2VyTWVkaWEoY29uc3RyYWludHMpIHsKICByZXR1cm4gbmV3IFByb21pc2UoZnVuY3Rpb24ocmVzb2x2ZSwgcmVqZWN0KSB7CiAgICBnZXRVc2VyTWVkaWEoY29uc3RyYWludHMsIHJlc29sdmUsIHJlamVjdCk7CiAgfSk7Cn0KCnZhciB3ZWJydGNUZXN0aW5nID0ge307CnRyeSB7CiAgT2JqZWN0LmRlZmluZVByb3BlcnR5KHdlYnJ0Y1Rlc3RpbmcsICd2ZXJzaW9uJywgewogICAgc2V0OiBmdW5jdGlvbih2ZXJzaW9uKSB7CiAgICAgIHdlYnJ0Y0RldGVjdGVkVmVyc2lvbiA9IHZlcnNpb247CiAgICB9CiAgfSk7Cn0gY2F0Y2ggKGUpIHt9CgppZiAodHlwZW9mIG1vZHVsZSAhPT0gJ3VuZGVmaW5lZCcpIHsKICB2YXIgUlRDUGVlckNvbm5lY3Rpb247CiAgdmFyIFJUQ0ljZUNhbmRpZGF0ZTsKICB2YXIgUlRDU2Vzc2lvbkRlc2NyaXB0aW9uOwogIGlmICh0eXBlb2Ygd2luZG93ICE9PSAndW5kZWZpbmVkJykgewogICAgUlRDUGVlckNvbm5lY3Rpb24gPSB3aW5kb3cuUlRDUGVlckNvbm5lY3Rpb247CiAgICBSVENJY2VDYW5kaWRhdGUgPSB3aW5kb3cuUlRDSWNlQ2FuZGlkYXRlOwogICAgUlRDU2Vzc2lvbkRlc2NyaXB0aW9uID0gd2luZG93LlJUQ1Nlc3Npb25EZXNjcmlwdGlvbjsKICB9CiAgbW9kdWxlLmV4cG9ydHMgPSB7CiAgICBSVENQZWVyQ29ubmVjdGlvbjogUlRDUGVlckNvbm5lY3Rpb24sCiAgICBSVENJY2VDYW5kaWRhdGU6IFJUQ0ljZUNhbmRpZGF0ZSwKICAgIFJUQ1Nlc3Npb25EZXNjcmlwdGlvbjogUlRDU2Vzc2lvbkRlc2NyaXB0aW9uLAogICAgZ2V0VXNlck1lZGlhOiBnZXRVc2VyTWVkaWEsCiAgICBhdHRhY2hNZWRpYVN0cmVhbTogYXR0YWNoTWVkaWFTdHJlYW0sCiAgICByZWF0dGFjaE1lZGlhU3RyZWFtOiByZWF0dGFjaE1lZGlhU3RyZWFtLAogICAgd2VicnRjRGV0ZWN0ZWRCcm93c2VyOiB3ZWJydGNEZXRlY3RlZEJyb3dzZXIsCiAgICB3ZWJydGNEZXRlY3RlZFZlcnNpb246IHdlYnJ0Y0RldGVjdGVkVmVyc2lvbiwKICAgIHdlYnJ0Y01pbmltdW1WZXJzaW9uOiB3ZWJydGNNaW5pbXVtVmVyc2lvbiwKICAgIHdlYnJ0Y1Rlc3Rpbmc6IHdlYnJ0Y1Rlc3RpbmcsCiAgICB3ZWJydGNVdGlsczogd2VicnRjVXRpbHMKICAgIC8vcmVxdWVzdFVzZXJNZWRpYTogbm90IGV4cG9zZWQgb24gcHVycG9zZS4KICAgIC8vdHJhY2U6IG5vdCBleHBvc2VkIG9uIHB1cnBvc2UuCiAgfTsKfSBlbHNlIGlmICgodHlwZW9mIHJlcXVpcmUgPT09ICdmdW5jdGlvbicpICYmICh0eXBlb2YgZGVmaW5lID09PSAnZnVuY3Rpb24nKSkgewogIC8vIEV4cG9zZSBvYmplY3RzIGFuZCBmdW5jdGlvbnMgd2hlbiBSZXF1aXJlSlMgaXMgZG9pbmcgdGhlIGxvYWRpbmcuCiAgZGVmaW5lKFtdLCBmdW5jdGlvbigpIHsKICAgIHJldHVybiB7CiAgICAgIFJUQ1BlZXJDb25uZWN0aW9uOiB3aW5kb3cuUlRDUGVlckNvbm5lY3Rpb24sCiAgICAgIFJUQ0ljZUNhbmRpZGF0ZTogd2luZG93LlJUQ0ljZUNhbmRpZGF0ZSwKICAgICAgUlRDU2Vzc2lvbkRlc2NyaXB0aW9uOiB3aW5kb3cuUlRDU2Vzc2lvbkRlc2NyaXB0aW9uLAogICAgICBnZXRVc2VyTWVkaWE6IGdldFVzZXJNZWRpYSwKICAgICAgYXR0YWNoTWVkaWFTdHJlYW06IGF0dGFjaE1lZGlhU3RyZWFtLAogICAgICByZWF0dGFjaE1lZGlhU3RyZWFtOiByZWF0dGFjaE1lZGlhU3RyZWFtLAogICAgICB3ZWJydGNEZXRlY3RlZEJyb3dzZXI6IHdlYnJ0Y0RldGVjdGVkQnJvd3NlciwKICAgICAgd2VicnRjRGV0ZWN0ZWRWZXJzaW9uOiB3ZWJydGNEZXRlY3RlZFZlcnNpb24sCiAgICAgIHdlYnJ0Y01pbmltdW1WZXJzaW9uOiB3ZWJydGNNaW5pbXVtVmVyc2lvbiwKICAgICAgd2VicnRjVGVzdGluZzogd2VicnRjVGVzdGluZywKICAgICAgd2VicnRjVXRpbHM6IHdlYnJ0Y1V0aWxzCiAgICAgIC8vcmVxdWVzdFVzZXJNZWRpYTogbm90IGV4cG9zZWQgb24gcHVycG9zZS4KICAgICAgLy90cmFjZTogbm90IGV4cG9zZWQgb24gcHVycG9zZS4KICAgIH07CiAgfSk7Cn0KCn0se31dLDI6W2Z1bmN0aW9uKHJlcXVpcmUsbW9kdWxlLGV4cG9ydHMpewovLyBkYXRhT2JqZWN0UmVwb3J0ZXIuZGF0YSA9IHsKLy8gICAgc3RhdHVzIDogImNvbm5lY3RlZCIsCi8vICAgIG93bmVyIDogImh5cGVydHk6Ly9leGFtcGxlLmNvbS9hbGljZWh5IiwKLy8gICAgcGVlciA6ICJjb25uZWN0aW9uOi8vZXhhbXBsZS5jb20vYWxpY2UvYm9iMjcwMTIwMTYiLAovLyAgICBvd25lclBlZXIgOiB7Ci8vICAgICAgICAgIGNvbm5lY3Rpb25EZXNjcmlwdGlvbjogewovLyAgICAgICAgICAgICBzZHA6ICdzNGRmYWYxc2EzZjFhc2Q1ZjRzZGFmYScsCi8vICAgICAgICAgICAgIHR5cGU6ICdvZmZlcicKLy8gICAgICAgICAgfSwKLy8gICAgICAgICAgaWNlQ2FuZGlkYXRlczogW3sKLy8gICAgICAgICAgICAgIHR5cGU6ICdjYW5kaWRhdGUnLAovLyAgICAgICAgICAgICAgY2FuZGlkYXRlOiBldmVudC5jYW5kaWRhdGUuY2FuZGlkYXRlLAovLyAgICAgICAgICAgICAgc2RwTWlkOiBldmVudC5jYW5kaWRhdGUuc2RwTWlkLAovLyAgICAgICAgICAgICAgc2RwTUxpbmVJbmRleDogZXZlbnQuY2FuZGlkYXRlLnNkcE1MaW5lSW5kZXgKLy8gICAgICAgICAgICB9LAovLyAgICAgICAgICAgIHsKLy8gICAgICAgICAgICAgIHR5cGU6ICdjYW5kaWRhdGUnLAovLyAgICAgICAgICAgICAgY2FuZGlkYXRlOiBldmVudC5jYW5kaWRhdGUuY2FuZGlkYXRlLAovLyAgICAgICAgICAgICAgc2RwTWlkOiBldmVudC5jYW5kaWRhdGUuc2RwTWlkLAovLyAgICAgICAgICAgICAgc2RwTUxpbmVJbmRleDogZXZlbnQuY2FuZGlkYXRlLnNkcE1MaW5lSW5kZXgKLy8gICAgICAgICAgICB9LAovLyAgICAgICAgICAgIC4uLi4uCi8vICAgICAgICBdCi8vICAgICAgfQovLyAgfQoKJ3VzZSBzdHJpY3QnOwoKT2JqZWN0LmRlZmluZVByb3BlcnR5KGV4cG9ydHMsICdfX2VzTW9kdWxlJywgewogIHZhbHVlOiB0cnVlCn0pOwoKdmFyIF9nZXQgPSBmdW5jdGlvbiBnZXQoX3gsIF94MiwgX3gzKSB7IHZhciBfYWdhaW4gPSB0cnVlOyBfZnVuY3Rpb246IHdoaWxlIChfYWdhaW4pIHsgdmFyIG9iamVjdCA9IF94LCBwcm9wZXJ0eSA9IF94MiwgcmVjZWl2ZXIgPSBfeDM7IF9hZ2FpbiA9IGZhbHNlOyBpZiAob2JqZWN0ID09PSBudWxsKSBvYmplY3QgPSBGdW5jdGlvbi5wcm90b3R5cGU7IHZhciBkZXNjID0gT2JqZWN0LmdldE93blByb3BlcnR5RGVzY3JpcHRvcihvYmplY3QsIHByb3BlcnR5KTsgaWYgKGRlc2MgPT09IHVuZGVmaW5lZCkgeyB2YXIgcGFyZW50ID0gT2JqZWN0LmdldFByb3RvdHlwZU9mKG9iamVjdCk7IGlmIChwYXJlbnQgPT09IG51bGwpIHsgcmV0dXJuIHVuZGVmaW5lZDsgfSBlbHNlIHsgX3ggPSBwYXJlbnQ7IF94MiA9IHByb3BlcnR5OyBfeDMgPSByZWNlaXZlcjsgX2FnYWluID0gdHJ1ZTsgZGVzYyA9IHBhcmVudCA9IHVuZGVmaW5lZDsgY29udGludWUgX2Z1bmN0aW9uOyB9IH0gZWxzZSBpZiAoJ3ZhbHVlJyBpbiBkZXNjKSB7IHJldHVybiBkZXNjLnZhbHVlOyB9IGVsc2UgeyB2YXIgZ2V0dGVyID0gZGVzYy5nZXQ7IGlmIChnZXR0ZXIgPT09IHVuZGVmaW5lZCkgeyByZXR1cm4gdW5kZWZpbmVkOyB9IHJldHVybiBnZXR0ZXIuY2FsbChyZWNlaXZlcik7IH0gfSB9OwoKZnVuY3Rpb24gX2ludGVyb3BSZXF1aXJlRGVmYXVsdChvYmopIHsgcmV0dXJuIG9iaiAmJiBvYmouX19lc01vZHVsZSA/IG9iaiA6IHsgJ2RlZmF1bHQnOiBvYmogfTsgfQoKZnVuY3Rpb24gX2NsYXNzQ2FsbENoZWNrKGluc3RhbmNlLCBDb25zdHJ1Y3RvcikgeyBpZiAoIShpbnN0YW5jZSBpbnN0YW5jZW9mIENvbnN0cnVjdG9yKSkgeyB0aHJvdyBuZXcgVHlwZUVycm9yKCdDYW5ub3QgY2FsbCBhIGNsYXNzIGFzIGEgZnVuY3Rpb24nKTsgfSB9CgpmdW5jdGlvbiBfaW5oZXJpdHMoc3ViQ2xhc3MsIHN1cGVyQ2xhc3MpIHsgaWYgKHR5cGVvZiBzdXBlckNsYXNzICE9PSAnZnVuY3Rpb24nICYmIHN1cGVyQ2xhc3MgIT09IG51bGwpIHsgdGhyb3cgbmV3IFR5cGVFcnJvcignU3VwZXIgZXhwcmVzc2lvbiBtdXN0IGVpdGhlciBiZSBudWxsIG9yIGEgZnVuY3Rpb24sIG5vdCAnICsgdHlwZW9mIHN1cGVyQ2xhc3MpOyB9IHN1YkNsYXNzLnByb3RvdHlwZSA9IE9iamVjdC5jcmVhdGUoc3VwZXJDbGFzcyAmJiBzdXBlckNsYXNzLnByb3RvdHlwZSwgeyBjb25zdHJ1Y3RvcjogeyB2YWx1ZTogc3ViQ2xhc3MsIGVudW1lcmFibGU6IGZhbHNlLCB3cml0YWJsZTogdHJ1ZSwgY29uZmlndXJhYmxlOiB0cnVlIH0gfSk7IGlmIChzdXBlckNsYXNzKSBPYmplY3Quc2V0UHJvdG90eXBlT2YgPyBPYmplY3Quc2V0UHJvdG90eXBlT2Yoc3ViQ2xhc3MsIHN1cGVyQ2xhc3MpIDogc3ViQ2xhc3MuX19wcm90b19fID0gc3VwZXJDbGFzczsgfQoKdmFyIF9Pd25lclBlZXIgPSByZXF1aXJlKCcuL093bmVyUGVlcicpOwoKdmFyIF9Pd25lclBlZXIyID0gX2ludGVyb3BSZXF1aXJlRGVmYXVsdChfT3duZXJQZWVyKTsKCnZhciBDb25uZWN0aW9uID0gKGZ1bmN0aW9uIChfT2JqZWN0KSB7CiAgX2luaGVyaXRzKENvbm5lY3Rpb24sIF9PYmplY3QpOwoKICBmdW5jdGlvbiBDb25uZWN0aW9uKCkgewogICAgX2NsYXNzQ2FsbENoZWNrKHRoaXMsIENvbm5lY3Rpb24pOwoKICAgIF9nZXQoT2JqZWN0LmdldFByb3RvdHlwZU9mKENvbm5lY3Rpb24ucHJvdG90eXBlKSwgJ2NvbnN0cnVjdG9yJywgdGhpcykuY2FsbCh0aGlzKTsKCiAgICB2YXIgX3RoaXMgPSB0aGlzOwoKICAgIF90aGlzLnN0YXR1cyA9ICcnOwogICAgX3RoaXMub3duZXIgPSAnJzsKICAgIF90aGlzLnBlZXIgPSAnJzsKCiAgICBfdGhpcy5vd25lclBlZXIgPSBuZXcgX093bmVyUGVlcjJbJ2RlZmF1bHQnXSgpOwogIH0KCiAgLy8gc2V0IHN0YXR1cyh2YWx1ZSkgewogIC8vICAgaWYgKCF2YWx1ZSkgdGhyb3cgbmV3IEVycm9yKCdUaGUgc3RhdHVzIG5lZWQgYSB2YWx1ZScpOwogIC8vCiAgLy8gICBsZXQgX3RoaXMgPSB0aGlzOwogIC8vICAgX3RoaXMuX3N0YXR1cyA9IHZhbHVlOwogIC8vIH0KICAvLwogIC8vIGdldCBzdGF0dXMoKSB7CiAgLy8gICBsZXQgX3RoaXMgPSB0aGlzOwogIC8vICAgcmV0dXJuIF90aGlzLl9zdGF0dXM7CiAgLy8gfQogIC8vCiAgLy8gc2V0IG93bmVyKHZhbHVlKSB7CiAgLy8gICBpZiAoIXZhbHVlKSB0aHJvdyBuZXcgRXJyb3IoJ1RoZSBvd25lciBuZWVkIGEgdmFsdWUnKTsKICAvLwogIC8vICAgbGV0IF90aGlzID0gdGhpczsKICAvLyAgIF90aGlzLl9vd25lciA9IHZhbHVlOwogIC8vIH0KICAvLwogIC8vIGdldCBvd25lcigpIHsKICAvLyAgIGxldCBfdGhpcyA9IHRoaXM7CiAgLy8gICByZXR1cm4gX3RoaXMuX293bmVyOwogIC8vIH0KICAvLwogIC8vIHNldCBwZWVyKHZhbHVlKSB7CiAgLy8gICBpZiAoIXZhbHVlKSB0aHJvdyBuZXcgRXJyb3IoJ1RoZSBwZWVyIG5lZWQgYSB2YWx1ZScpOwogIC8vCiAgLy8gICBsZXQgX3RoaXMgPSB0aGlzOwogIC8vICAgX3RoaXMuX3BlZXIgPSB2YWx1ZTsKICAvLyB9CiAgLy8KICAvLyBnZXQgcGVlcigpIHsKICAvLyAgIGxldCBfdGhpcyA9IHRoaXM7CiAgLy8gICByZXR1cm4gX3RoaXMuX3BlZXI7CiAgLy8gfQogIC8vCiAgLy8gZ2V0IG93bmVyUGVlcigpIHsKICAvLyAgIGxldCBfdGhpcyA9IHRoaXM7CiAgLy8gICByZXR1cm4gX3RoaXMuX293bmVyUGVlcjsKICAvLyB9CgogIHJldHVybiBDb25uZWN0aW9uOwp9KShPYmplY3QpOwoKZXhwb3J0c1snZGVmYXVsdCddID0gQ29ubmVjdGlvbjsKbW9kdWxlLmV4cG9ydHMgPSBleHBvcnRzWydkZWZhdWx0J107Cgp9LHsiLi9Pd25lclBlZXIiOjV9XSwzOltmdW5jdGlvbihyZXF1aXJlLG1vZHVsZSxleHBvcnRzKXsKLyoganNoaW50IHVuZGVmOiB0cnVlICovCi8qIGdsb2JhbHMgUlRDUGVlckNvbm5lY3Rpb24gKi8KLyogZ2xvYmFscyBSVENTZXNzaW9uRGVzY3JpcHRpb24gKi8KLyogZ2xvYmFscyBSVENJY2VDYW5kaWRhdGUgKi8KCid1c2Ugc3RyaWN0JzsKCk9iamVjdC5kZWZpbmVQcm9wZXJ0eShleHBvcnRzLCAnX19lc01vZHVsZScsIHsKICB2YWx1ZTogdHJ1ZQp9KTsKCnZhciBfY3JlYXRlQ2xhc3MgPSAoZnVuY3Rpb24gKCkgeyBmdW5jdGlvbiBkZWZpbmVQcm9wZXJ0aWVzKHRhcmdldCwgcHJvcHMpIHsgZm9yICh2YXIgaSA9IDA7IGkgPCBwcm9wcy5sZW5ndGg7IGkrKykgeyB2YXIgZGVzY3JpcHRvciA9IHByb3BzW2ldOyBkZXNjcmlwdG9yLmVudW1lcmFibGUgPSBkZXNjcmlwdG9yLmVudW1lcmFibGUgfHwgZmFsc2U7IGRlc2NyaXB0b3IuY29uZmlndXJhYmxlID0gdHJ1ZTsgaWYgKCd2YWx1ZScgaW4gZGVzY3JpcHRvcikgZGVzY3JpcHRvci53cml0YWJsZSA9IHRydWU7IE9iamVjdC5kZWZpbmVQcm9wZXJ0eSh0YXJnZXQsIGRlc2NyaXB0b3Iua2V5LCBkZXNjcmlwdG9yKTsgfSB9IHJldHVybiBmdW5jdGlvbiAoQ29uc3RydWN0b3IsIHByb3RvUHJvcHMsIHN0YXRpY1Byb3BzKSB7IGlmIChwcm90b1Byb3BzKSBkZWZpbmVQcm9wZXJ0aWVzKENvbnN0cnVjdG9yLnByb3RvdHlwZSwgcHJvdG9Qcm9wcyk7IGlmIChzdGF0aWNQcm9wcykgZGVmaW5lUHJvcGVydGllcyhDb25zdHJ1Y3Rvciwgc3RhdGljUHJvcHMpOyByZXR1cm4gQ29uc3RydWN0b3I7IH07IH0pKCk7Cgp2YXIgX2dldCA9IGZ1bmN0aW9uIGdldChfeCwgX3gyLCBfeDMpIHsgdmFyIF9hZ2FpbiA9IHRydWU7IF9mdW5jdGlvbjogd2hpbGUgKF9hZ2FpbikgeyB2YXIgb2JqZWN0ID0gX3gsIHByb3BlcnR5ID0gX3gyLCByZWNlaXZlciA9IF94MzsgX2FnYWluID0gZmFsc2U7IGlmIChvYmplY3QgPT09IG51bGwpIG9iamVjdCA9IEZ1bmN0aW9uLnByb3RvdHlwZTsgdmFyIGRlc2MgPSBPYmplY3QuZ2V0T3duUHJvcGVydHlEZXNjcmlwdG9yKG9iamVjdCwgcHJvcGVydHkpOyBpZiAoZGVzYyA9PT0gdW5kZWZpbmVkKSB7IHZhciBwYXJlbnQgPSBPYmplY3QuZ2V0UHJvdG90eXBlT2Yob2JqZWN0KTsgaWYgKHBhcmVudCA9PT0gbnVsbCkgeyByZXR1cm4gdW5kZWZpbmVkOyB9IGVsc2UgeyBfeCA9IHBhcmVudDsgX3gyID0gcHJvcGVydHk7IF94MyA9IHJlY2VpdmVyOyBfYWdhaW4gPSB0cnVlOyBkZXNjID0gcGFyZW50ID0gdW5kZWZpbmVkOyBjb250aW51ZSBfZnVuY3Rpb247IH0gfSBlbHNlIGlmICgndmFsdWUnIGluIGRlc2MpIHsgcmV0dXJuIGRlc2MudmFsdWU7IH0gZWxzZSB7IHZhciBnZXR0ZXIgPSBkZXNjLmdldDsgaWYgKGdldHRlciA9PT0gdW5kZWZpbmVkKSB7IHJldHVybiB1bmRlZmluZWQ7IH0gcmV0dXJuIGdldHRlci5jYWxsKHJlY2VpdmVyKTsgfSB9IH07CgpmdW5jdGlvbiBfaW50ZXJvcFJlcXVpcmVEZWZhdWx0KG9iaikgeyByZXR1cm4gb2JqICYmIG9iai5fX2VzTW9kdWxlID8gb2JqIDogeyAnZGVmYXVsdCc6IG9iaiB9OyB9CgpmdW5jdGlvbiBfY2xhc3NDYWxsQ2hlY2soaW5zdGFuY2UsIENvbnN0cnVjdG9yKSB7IGlmICghKGluc3RhbmNlIGluc3RhbmNlb2YgQ29uc3RydWN0b3IpKSB7IHRocm93IG5ldyBUeXBlRXJyb3IoJ0Nhbm5vdCBjYWxsIGEgY2xhc3MgYXMgYSBmdW5jdGlvbicpOyB9IH0KCmZ1bmN0aW9uIF9pbmhlcml0cyhzdWJDbGFzcywgc3VwZXJDbGFzcykgeyBpZiAodHlwZW9mIHN1cGVyQ2xhc3MgIT09ICdmdW5jdGlvbicgJiYgc3VwZXJDbGFzcyAhPT0gbnVsbCkgeyB0aHJvdyBuZXcgVHlwZUVycm9yKCdTdXBlciBleHByZXNzaW9uIG11c3QgZWl0aGVyIGJlIG51bGwgb3IgYSBmdW5jdGlvbiwgbm90ICcgKyB0eXBlb2Ygc3VwZXJDbGFzcyk7IH0gc3ViQ2xhc3MucHJvdG90eXBlID0gT2JqZWN0LmNyZWF0ZShzdXBlckNsYXNzICYmIHN1cGVyQ2xhc3MucHJvdG90eXBlLCB7IGNvbnN0cnVjdG9yOiB7IHZhbHVlOiBzdWJDbGFzcywgZW51bWVyYWJsZTogZmFsc2UsIHdyaXRhYmxlOiB0cnVlLCBjb25maWd1cmFibGU6IHRydWUgfSB9KTsgaWYgKHN1cGVyQ2xhc3MpIE9iamVjdC5zZXRQcm90b3R5cGVPZiA/IE9iamVjdC5zZXRQcm90b3R5cGVPZihzdWJDbGFzcywgc3VwZXJDbGFzcykgOiBzdWJDbGFzcy5fX3Byb3RvX18gPSBzdXBlckNsYXNzOyB9CgpyZXF1aXJlKCd3ZWJydGMtYWRhcHRlci10ZXN0Jyk7Cgp2YXIgX3V0aWxzRXZlbnRFbWl0dGVyID0gcmVxdWlyZSgnLi4vdXRpbHMvRXZlbnRFbWl0dGVyJyk7Cgp2YXIgX3V0aWxzRXZlbnRFbWl0dGVyMiA9IF9pbnRlcm9wUmVxdWlyZURlZmF1bHQoX3V0aWxzRXZlbnRFbWl0dGVyKTsKCnZhciBfQ29ubmVjdGlvbiA9IHJlcXVpcmUoJy4vQ29ubmVjdGlvbicpOwoKdmFyIF9Db25uZWN0aW9uMiA9IF9pbnRlcm9wUmVxdWlyZURlZmF1bHQoX0Nvbm5lY3Rpb24pOwoKdmFyIF9QZWVyID0gcmVxdWlyZSgnLi9QZWVyJyk7Cgp2YXIgX1BlZXIyID0gX2ludGVyb3BSZXF1aXJlRGVmYXVsdChfUGVlcik7Cgp2YXIgQ29ubmVjdGlvbkNvbnRyb2xsZXIgPSAoZnVuY3Rpb24gKF9FdmVudEVtaXR0ZXIpIHsKICBfaW5oZXJpdHMoQ29ubmVjdGlvbkNvbnRyb2xsZXIsIF9FdmVudEVtaXR0ZXIpOwoKICBmdW5jdGlvbiBDb25uZWN0aW9uQ29udHJvbGxlcihzeW5jaGVyKSB7CiAgICBfY2xhc3NDYWxsQ2hlY2sodGhpcywgQ29ubmVjdGlvbkNvbnRyb2xsZXIpOwoKICAgIF9nZXQoT2JqZWN0LmdldFByb3RvdHlwZU9mKENvbm5lY3Rpb25Db250cm9sbGVyLnByb3RvdHlwZSksICdjb25zdHJ1Y3RvcicsIHRoaXMpLmNhbGwodGhpcywgc3luY2hlcik7CgogICAgdmFyIF90aGlzID0gdGhpczsKCiAgICBfdGhpcy5zeW5jaGVyID0gc3luY2hlcjsKICAgIF90aGlzLm1vZGUgPSAnb2ZmZXInOwoKICAgIF90aGlzLl9vYmplY3REZXNjVVJMID0gJ2h5cGVydHktY2F0YWxvZ3VlOi8vbG9jYWxob3N0Ly53ZWxsLWtub3duL2RhdGFzY2hlbWFzL0Zha2VEYXRhU2NoZW1hJzsKCiAgICBfdGhpcy5tZWRpYUNvbnN0cmFpbnRzID0gewogICAgICBvcHRpb25hbDogW10sCiAgICAgIG1hbmRhdG9yeTogewogICAgICAgIG9mZmVyVG9SZWNlaXZlQXVkaW86IHRydWUsCiAgICAgICAgb2ZmZXJUb1JlY2VpdmVWaWRlbzogdHJ1ZQogICAgICB9CiAgICB9OwoKICAgIC8vIFByZXBhcmUgdGhlIFBlZXJDb25uZWN0aW9uCiAgICB2YXIgcGVlckNvbm5lY3Rpb24gPSBuZXcgUlRDUGVlckNvbm5lY3Rpb24oKTsKCiAgICBwZWVyQ29ubmVjdGlvbi5hZGRFdmVudExpc3RlbmVyKCdzaWduYWxpbmdzdGF0ZWNoYW5nZScsIGZ1bmN0aW9uIChldmVudCkgewoKICAgICAgY29uc29sZS5pbmZvKCdzaWduYWxpbmdzdGF0ZWNoYW5nZScsIGV2ZW50LmN1cnJlbnRUYXJnZXQuc2lnbmFsaW5nU3RhdGUpOwoKICAgICAgaWYgKGV2ZW50LmN1cnJlbnRUYXJnZXQuc2lnbmFsaW5nU3RhdGUgPT09ICdoYXZlLWxvY2FsLW9mZmVyJykgewogICAgICAgIF90aGlzLnRyaWdnZXIoJ2NvbnRyb2xsZXI6c3RhdGU6Y2hhbmdlJywgX3RoaXMubW9kZSk7CiAgICAgIH0KCiAgICAgIGlmIChldmVudC5jdXJyZW50VGFyZ2V0LnNpZ25hbGluZ1N0YXRlID09PSAnaGF2ZS1yZW1vdGUtb2ZmZXInKSB7CiAgICAgICAgX3RoaXMubW9kZSA9ICdhbnN3ZXInOwogICAgICAgIF90aGlzLnRyaWdnZXIoJ2NvbnRyb2xsZXI6c3RhdGU6Y2hhbmdlJywgX3RoaXMubW9kZSk7CiAgICAgIH0KICAgIH0pOwoKICAgIHBlZXJDb25uZWN0aW9uLmFkZEV2ZW50TGlzdGVuZXIoJ2ljZWNvbm5lY3Rpb25zdGF0ZWNoYW5nZScsIGZ1bmN0aW9uIChldmVudCkgewogICAgICBjb25zb2xlLmluZm8oJ2ljZWNvbm5lY3Rpb25zdGF0ZWNoYW5nZScsIGV2ZW50LmN1cnJlbnRUYXJnZXQuaWNlQ29ubmVjdGlvblN0YXRlKTsKICAgICAgdmFyIGRhdGEgPSBfdGhpcy5fZGF0YU9iamVjdFJlcG9ydGVyLmRhdGE7CiAgICAgIGlmIChkYXRhLmhhc093blByb3BlcnR5KCdjb25uZWN0aW9uJykpIHsKICAgICAgICBkYXRhLmNvbm5lY3Rpb24uc3RhdHVzID0gZXZlbnQuY3VycmVudFRhcmdldC5pY2VDb25uZWN0aW9uU3RhdGU7CiAgICAgIH0KICAgIH0pOwoKICAgIHBlZXJDb25uZWN0aW9uLmFkZEV2ZW50TGlzdGVuZXIoJ2ljZWNhbmRpZGF0ZScsIGZ1bmN0aW9uIChldmVudCkgewoKICAgICAgaWYgKCFldmVudC5jYW5kaWRhdGUpIHJldHVybjsKCiAgICAgIHZhciBpY2VjYW5kaWRhdGUgPSB7CiAgICAgICAgdHlwZTogJ2NhbmRpZGF0ZScsCiAgICAgICAgY2FuZGlkYXRlOiBldmVudC5jYW5kaWRhdGUuY2FuZGlkYXRlLAogICAgICAgIHNkcE1pZDogZXZlbnQuY2FuZGlkYXRlLnNkcE1pZCwKICAgICAgICBzZHBNTGluZUluZGV4OiBldmVudC5jYW5kaWRhdGUuc2RwTUxpbmVJbmRleAogICAgICB9OwoKICAgICAgdmFyIGRhdGEgPSBfdGhpcy5fZGF0YU9iamVjdFJlcG9ydGVyLmRhdGE7CgogICAgICBpZiAoX3RoaXMubW9kZSA9PT0gJ29mZmVyJykgewogICAgICAgIGRhdGEuY29ubmVjdGlvbi5vd25lclBlZXIuaWNlQ2FuZGlkYXRlcy5wdXNoKGljZWNhbmRpZGF0ZSk7CiAgICAgIH0gZWxzZSB7CiAgICAgICAgZGF0YS5wZWVyLmljZUNhbmRpZGF0ZXMucHVzaChpY2VjYW5kaWRhdGUpOwogICAgICB9CiAgICB9KTsKCiAgICAvLyBBZGQgc3RyZWFtIHRvIFBlZXJDb25uZWN0aW9uCiAgICBwZWVyQ29ubmVjdGlvbi5hZGRFdmVudExpc3RlbmVyKCdhZGRzdHJlYW0nLCBmdW5jdGlvbiAoZXZlbnQpIHsKICAgICAgX3RoaXMudHJpZ2dlcignc3RyZWFtOmFkZGVkJywgVVJMLmNyZWF0ZU9iamVjdFVSTChldmVudC5zdHJlYW0pLCBfdGhpcy5kYXRhT2JqZWN0UmVwb3J0ZXIsIF90aGlzLmRhdGFPYmplY3RPYnNlcnZlcik7CiAgICB9KTsKCiAgICBfdGhpcy5wZWVyQ29ubmVjdGlvbiA9IHBlZXJDb25uZWN0aW9uOwogIH0KCiAgLy8gVE9ETzogY2hlY2sgaWYgaXQgaXMgcmVhbHkgbmVjZXNzYXJ5IHRoaXMgcmVtb3RlUGVlckluZm9ybWF0aW9uOwogIC8qKgogICAqIFNldCBSZW1vdGUgcGVlciBpbmZvcm1hdGlvbiwgbGlrZSBIeXBlcnR5LgogICAqIEBwYXJhbSAge09iamVjdH0gcmVtb3RlUGVlckluZm9ybWF0aW9uIGluZm9ybWF0aW9uIGFib3V0IHRoZSBwZWVyOwogICAqLwoKICBfY3JlYXRlQ2xhc3MoQ29ubmVjdGlvbkNvbnRyb2xsZXIsIFt7CiAgICBrZXk6ICdnZXRVc2VyTWVkaWEnLAoKICAgIC8qKgogICAgICogR2V0IFdlYlJUQyBBUEkgcmVzb3VyY2VzCiAgICAgKiBAcGFyYW0gIHtPYmplY3R9ICAgICBvcHRpb25zIE9iamVjdCBjb250YWluaW5nIHRoZSBpbmZvcm1hdGlvbiB0aGF0IHJlc291cmNlcyB3aWxsIGJlIHVzZWQgKGNhbWVyYSwgbWljLCByZXNvbHV0aW9uLCBldGMpOwogICAgICogQHJldHVybiB7UHJvbWlzZX0KICAgICAqLwogICAgdmFsdWU6IGZ1bmN0aW9uIGdldFVzZXJNZWRpYShjb25zdHJhaW50cykgewoKICAgICAgdmFyIF90aGlzID0gdGhpczsKCiAgICAgIHJldHVybiBuZXcgUHJvbWlzZShmdW5jdGlvbiAocmVzb2x2ZSwgcmVqZWN0KSB7CgogICAgICAgIG5hdmlnYXRvci5tZWRpYURldmljZXMuZ2V0VXNlck1lZGlhKGNvbnN0cmFpbnRzKS50aGVuKGZ1bmN0aW9uIChtZWRpYVN0cmVhbSkgewogICAgICAgICAgX3RoaXMucGVlckNvbm5lY3Rpb24uYWRkU3RyZWFtKG1lZGlhU3RyZWFtKTsKICAgICAgICAgIHJlc29sdmUobWVkaWFTdHJlYW0pOwogICAgICAgIH0pWydjYXRjaCddKGZ1bmN0aW9uIChyZWFzb24pIHsKICAgICAgICAgIHJlamVjdChyZWFzb24pOwogICAgICAgIH0pOwogICAgICB9KTsKICAgIH0KICB9LCB7CiAgICBrZXk6ICdjaGFuZ2VQZWVySW5mb3JtYXRpb24nLAogICAgdmFsdWU6IGZ1bmN0aW9uIGNoYW5nZVBlZXJJbmZvcm1hdGlvbihkYXRhT2JqZWN0T2JzZXJ2ZXIpIHsKCiAgICAgIHZhciBfdGhpcyA9IHRoaXM7CgogICAgICBfdGhpcy5wcm9jZXNzUGVlckluZm9ybWF0aW9uKGRhdGFPYmplY3RPYnNlcnZlci5kYXRhKTsKCiAgICAgIGRhdGFPYmplY3RPYnNlcnZlci5vbkNoYW5nZSgnKicsIGZ1bmN0aW9uIChldmVudCkgewogICAgICAgIGNvbnNvbGUuaW5mbygnT2JzZXJ2ZXIgb24gY2hhbmdlIG1lc3NhZ2U6ICcsIGV2ZW50LmRhdGEpOwogICAgICAgIF90aGlzLnByb2Nlc3NQZWVySW5mb3JtYXRpb24oZXZlbnQuZGF0YSk7CiAgICAgIH0pOwogICAgfQogIH0sIHsKICAgIGtleTogJ3Byb2Nlc3NQZWVySW5mb3JtYXRpb24nLAogICAgdmFsdWU6IGZ1bmN0aW9uIHByb2Nlc3NQZWVySW5mb3JtYXRpb24oZGF0YSkgewogICAgICB2YXIgX3RoaXMgPSB0aGlzOwogICAgICB2YXIgaXNPd25lciA9IGRhdGEuaGFzT3duUHJvcGVydHkoJ2Nvbm5lY3Rpb24nKTsKCiAgICAgIHZhciBjb25uZWN0aW9uRGVzY3JpcHRpb24gPSBpc093bmVyID8gZGF0YS5jb25uZWN0aW9uLm93bmVyUGVlci5jb25uZWN0aW9uRGVzY3JpcHRpb24gOiBkYXRhLnBlZXIuY29ubmVjdGlvbkRlc2NyaXB0aW9uOwogICAgICB2YXIgaWNlQ2FuZGlkYXRlcyA9IGlzT3duZXIgPyBkYXRhLmNvbm5lY3Rpb24ub3duZXJQZWVyLmljZUNhbmRpZGF0ZXMgOiBkYXRhLnBlZXIuaWNlQ2FuZGlkYXRlczsKCiAgICAgIGlmICghY29ubmVjdGlvbkRlc2NyaXB0aW9uKSByZXR1cm47CgogICAgICBpZiAoY29ubmVjdGlvbkRlc2NyaXB0aW9uLnR5cGUgPT09ICdvZmZlcicgfHwgY29ubmVjdGlvbkRlc2NyaXB0aW9uLnR5cGUgPT09ICdhbnN3ZXInKSB7CiAgICAgICAgY29uc29sZS5pbmZvKCdQcm9jZXNzIENvbm5lY3Rpb24gRGVzY3JpcHRpb246ICcsIGNvbm5lY3Rpb25EZXNjcmlwdGlvbik7CiAgICAgICAgX3RoaXMucGVlckNvbm5lY3Rpb24uc2V0UmVtb3RlRGVzY3JpcHRpb24obmV3IFJUQ1Nlc3Npb25EZXNjcmlwdGlvbihjb25uZWN0aW9uRGVzY3JpcHRpb24pLCBfdGhpcy5yZW1vdGVEZXNjcmlwdGlvblN1Y2Nlc3MsIF90aGlzLnJlbW90ZURlc2NyaXB0aW9uRXJyb3IpOwogICAgICB9CgogICAgICBpZiAoaWNlQ2FuZGlkYXRlcykgewogICAgICAgIGljZUNhbmRpZGF0ZXMuZm9yRWFjaChmdW5jdGlvbiAoaWNlKSB7CiAgICAgICAgICBpZiAoaWNlLnR5cGUgPT09ICdjYW5kaWRhdGUnKSB7CiAgICAgICAgICAgIGNvbnNvbGUuaW5mbygnUHJvY2VzcyBJY2UgQ2FuZGlkYXRlOiAnLCBpY2UpOwogICAgICAgICAgICBfdGhpcy5wZWVyQ29ubmVjdGlvbi5hZGRJY2VDYW5kaWRhdGUobmV3IFJUQ0ljZUNhbmRpZGF0ZSh7IGNhbmRpZGF0ZTogaWNlLmNhbmRpZGF0ZSB9KSwgX3RoaXMucmVtb3RlRGVzY3JpcHRpb25TdWNjZXNzLCBfdGhpcy5yZW1vdGVEZXNjcmlwdGlvbkVycm9yKTsKICAgICAgICAgIH0KICAgICAgICB9KTsKICAgICAgfQogICAgfQogIH0sIHsKICAgIGtleTogJ3JlbW90ZURlc2NyaXB0aW9uU3VjY2VzcycsCiAgICB2YWx1ZTogZnVuY3Rpb24gcmVtb3RlRGVzY3JpcHRpb25TdWNjZXNzKCkgewogICAgICBjb25zb2xlLmluZm8oJ3JlbW90ZSBzdWNjZXNzJyk7CiAgICB9CiAgfSwgewogICAga2V5OiAncmVtb3RlRGVzY3JpcHRpb25FcnJvcicsCiAgICB2YWx1ZTogZnVuY3Rpb24gcmVtb3RlRGVzY3JpcHRpb25FcnJvcihlcnJvcikgewogICAgICBjb25zb2xlLmVycm9yKCdlcnJvcjogJywgZXJyb3IpOwogICAgfQogIH0sIHsKICAgIGtleTogJ2NyZWF0ZU9mZmVyJywKICAgIHZhbHVlOiBmdW5jdGlvbiBjcmVhdGVPZmZlcigpIHsKICAgICAgdmFyIF90aGlzID0gdGhpczsKCiAgICAgIF90aGlzLnBlZXJDb25uZWN0aW9uLmNyZWF0ZU9mZmVyKGZ1bmN0aW9uIChkZXNjcmlwdGlvbikgewogICAgICAgIF90aGlzLm9uTG9jYWxTZXNzaW9uQ3JlYXRlZChkZXNjcmlwdGlvbik7CiAgICAgIH0sIF90aGlzLmluZm9FcnJvciwgX3RoaXMubWVkaWFDb25zdHJhaW50cyk7CiAgICB9CiAgfSwgewogICAga2V5OiAnY3JlYXRlQW5zd2VyJywKICAgIHZhbHVlOiBmdW5jdGlvbiBjcmVhdGVBbnN3ZXIoKSB7CiAgICAgIHZhciBfdGhpcyA9IHRoaXM7CgogICAgICBfdGhpcy5wZWVyQ29ubmVjdGlvbi5jcmVhdGVBbnN3ZXIoZnVuY3Rpb24gKGRlc2NyaXB0aW9uKSB7CiAgICAgICAgX3RoaXMub25Mb2NhbFNlc3Npb25DcmVhdGVkKGRlc2NyaXB0aW9uKTsKICAgICAgfSwgX3RoaXMuaW5mb0Vycm9yKTsKICAgIH0KICB9LCB7CiAgICBrZXk6ICdvbkxvY2FsU2Vzc2lvbkNyZWF0ZWQnLAogICAgdmFsdWU6IGZ1bmN0aW9uIG9uTG9jYWxTZXNzaW9uQ3JlYXRlZChkZXNjcmlwdGlvbikgewoKICAgICAgdmFyIF90aGlzID0gdGhpczsKCiAgICAgIF90aGlzLnBlZXJDb25uZWN0aW9uLnNldExvY2FsRGVzY3JpcHRpb24oZGVzY3JpcHRpb24sIGZ1bmN0aW9uICgpIHsKCiAgICAgICAgdmFyIGRhdGEgPSBfdGhpcy5fZGF0YU9iamVjdFJlcG9ydGVyLmRhdGE7CiAgICAgICAgdmFyIHNkcCA9IHsKICAgICAgICAgIHNkcDogZGVzY3JpcHRpb24uc2RwLAogICAgICAgICAgdHlwZTogZGVzY3JpcHRpb24udHlwZQogICAgICAgIH07CgogICAgICAgIGlmIChfdGhpcy5tb2RlID09PSAnb2ZmZXInKSB7CiAgICAgICAgICBkYXRhLmNvbm5lY3Rpb24ub3duZXJQZWVyLmNvbm5lY3Rpb25EZXNjcmlwdGlvbiA9IHNkcDsKICAgICAgICB9IGVsc2UgewogICAgICAgICAgZGF0YS5wZWVyLmNvbm5lY3Rpb25EZXNjcmlwdGlvbiA9IHNkcDsKICAgICAgICB9CiAgICAgIH0sIF90aGlzLmluZm9FcnJvcik7CiAgICB9CiAgfSwgewogICAga2V5OiAnaW5mb0Vycm9yJywKICAgIHZhbHVlOiBmdW5jdGlvbiBpbmZvRXJyb3IoZXJyKSB7CiAgICAgIGNvbnNvbGUuZXJyb3IoZXJyLnRvU3RyaW5nKCksIGVycik7CiAgICB9CgogICAgLyoqCiAgICAgKiBVc2VkIHRvIGFjY2VwdCBhbiBpbmNvbWluZyBjb25uZWN0aW9uIHJlcXVlc3QuCiAgICAgKiBAbWV0aG9kIGFjY2VwdAogICAgICogQHJldHVybiB7UHJvbWlzZX0KICAgICAqLwogIH0sIHsKICAgIGtleTogJ2FjY2VwdCcsCiAgICB2YWx1ZTogZnVuY3Rpb24gYWNjZXB0KG9wdGlvbnMpIHsKCiAgICAgIHZhciBfdGhpcyA9IHRoaXM7CiAgICAgIHZhciBzeW5jaGVyID0gX3RoaXMuc3luY2hlcjsKCiAgICAgIG9wdGlvbnMgPSBvcHRpb25zIHx8IHsgdmlkZW86IHRydWUsIGF1ZGlvOiB0cnVlIH07CgogICAgICBjb25zb2xlLmxvZygnUmVtb3RlIFBlZXIgSW5mb3JtYXRpb246ICcsIF90aGlzLl9yZW1vdGVQZWVySW5mb3JtYXRpb24pOwogICAgICB2YXIgcmVtb3RlUGVlciA9IF90aGlzLl9yZW1vdGVQZWVySW5mb3JtYXRpb24uZnJvbTsKCiAgICAgIHJldHVybiBuZXcgUHJvbWlzZShmdW5jdGlvbiAocmVzb2x2ZSwgcmVqZWN0KSB7CgogICAgICAgIHRyeSB7CgogICAgICAgICAgY29uc29sZS5pbmZvKCctLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0gU3luY2hlciBDcmVhdGUgLS0tLS0tLS0tLS0tLS0tLS0tLS0tLSBcbicpOwogICAgICAgICAgX3RoaXMuZ2V0VXNlck1lZGlhKG9wdGlvbnMpLnRoZW4oZnVuY3Rpb24gKG1lZGlhQ29uc3RyYWludHMpIHsKICAgICAgICAgICAgY29uc29sZS5pbmZvKCcxLiBSZXR1cm4gbWVkaWEgY29uc3RyYWludHMgJywgbWVkaWFDb25zdHJhaW50cyk7CiAgICAgICAgICAgIHJldHVybiBzeW5jaGVyLmNyZWF0ZShfdGhpcy5fb2JqZWN0RGVzY1VSTCwgW3JlbW90ZVBlZXJdLCB7fSk7CiAgICAgICAgICB9KS50aGVuKGZ1bmN0aW9uIChkYXRhT2JqZWN0UmVwb3J0ZXIpIHsKICAgICAgICAgICAgY29uc29sZS5pbmZvKCcyLiBSZXR1cm4gdGhlIERhdGEgT2JqZWN0IFJlcG9ydGVyICcsIGRhdGFPYmplY3RSZXBvcnRlcik7CiAgICAgICAgICAgIF90aGlzLmRhdGFPYmplY3RSZXBvcnRlciA9IGRhdGFPYmplY3RSZXBvcnRlcjsKCiAgICAgICAgICAgIHJlc29sdmUoJ2FjY2VwdGVkJyk7CiAgICAgICAgICB9KVsnY2F0Y2gnXShmdW5jdGlvbiAocmVhc29uKSB7CiAgICAgICAgICAgIHJlamVjdChyZWFzb24pOwogICAgICAgICAgfSk7CiAgICAgICAgfSBjYXRjaCAoZSkgewogICAgICAgICAgcmVqZWN0KCdlcnJvciBhY2NlcHRpbmcgY29ubmVjdGlvbicpOwogICAgICAgIH0KICAgICAgfSk7CiAgICB9CgogICAgLyoqCiAgICAqIFVzZWQgdG8gZGVjbGluZSBhbiBpbmNvbWluZyBjb25uZWN0aW9uIHJlcXVlc3QuCiAgICAqIEBtZXRob2QgZGVjbGluZQogICAgKiBAcmV0dXJuIHtQcm9taXNlfQogICAgKi8KICB9LCB7CiAgICBrZXk6ICdkZWNsaW5lJywKICAgIHZhbHVlOiBmdW5jdGlvbiBkZWNsaW5lKCkgewoKICAgICAgdmFyIF90aGlzID0gdGhpczsKICAgICAgdmFyIHN5bmNoZXIgPSBfdGhpcy5zeW5jaGVyOwoKICAgICAgcmV0dXJuIG5ldyBQcm9taXNlKGZ1bmN0aW9uIChyZXNvbHZlLCByZWplY3QpIHsKCiAgICAgICAgdHJ5IHsKICAgICAgICAgIGNvbnNvbGUubG9nKCdzeW5jaGVyOiAnLCBzeW5jaGVyKTsKICAgICAgICAgIHJlc29sdmUoJ0RlY2xpbmVkJyk7CiAgICAgICAgfSBjYXRjaCAoZSkgewogICAgICAgICAgcmVqZWN0KGUpOwogICAgICAgIH0KICAgICAgfSk7CiAgICB9CgogICAgLyoqCiAgICAgKiBVc2VkIHRvIGNsb3NlIGFuIGV4aXN0aW5nIGNvbm5lY3Rpb24gaW5zdGFuY2UuCiAgICAgKiBAbWV0aG9kIGRpc2Nvbm5lY3QKICAgICAqIEByZXR1cm4ge1Byb21pc2V9CiAgICAgKi8KICB9LCB7CiAgICBrZXk6ICdkaXNjb25uZWN0JywKICAgIHZhbHVlOiBmdW5jdGlvbiBkaXNjb25uZWN0KCkgewoKICAgICAgLy8gVE9ETzogb3B0aW1pemUgdGhlIGRpc2Nvbm5lY3QgZnVuY3Rpb24KCiAgICAgIHZhciBfdGhpcyA9IHRoaXM7CgogICAgICByZXR1cm4gbmV3IFByb21pc2UoZnVuY3Rpb24gKHJlc29sdmUsIHJlamVjdCkgewoKICAgICAgICB0cnkgewoKICAgICAgICAgIF90aGlzLnBlZXJDb25uZWN0aW9uLmNsb3NlKCk7CgogICAgICAgICAgcmVzb2x2ZSh0cnVlKTsKICAgICAgICB9IGNhdGNoIChlKSB7CiAgICAgICAgICByZWplY3QoJ2Vycm9yIGRpc2Nvbm5lY3RpbmcgY29ubmVjdGlvbicpOwogICAgICAgIH0KICAgICAgfSk7CiAgICB9CgogICAgLyoqCiAgICAgKiBVc2VkIHRvIGFkZC9pbnZpdGUgbmV3IHBlZXJzIG9uIGFuIGV4aXN0aW5nIGNvbm5lY3Rpb24gaW5zdGFuY2UgKGZvciBtdWx0aXBhcnR5IGNvbm5lY3Rpb25zKS4KICAgICAqIEBtZXRob2QgYWRkUGVlcgogICAgICogQHJldHVybiB7UHJvbWlzZX0KICAgICAqLwogIH0sIHsKICAgIGtleTogJ2FkZFBlZXInLAogICAgdmFsdWU6IGZ1bmN0aW9uIGFkZFBlZXIoKSB7fQoKICAgIC8qKgogICAgICogVXNlZCB0byByZW1vdmUgYSBwZWVyIGZyb20gYW4gZXhpc3RpbmcgY29ubmVjdGlvbiBpbnN0YW5jZS4KICAgICAqIEBtZXRob2QgcmVtb3ZlUGVlcgogICAgICogQHJldHVybiB7UHJvbWlzZX0KICAgICAqLwogIH0sIHsKICAgIGtleTogJ3JlbW92ZVBlZXInLAogICAgdmFsdWU6IGZ1bmN0aW9uIHJlbW92ZVBlZXIoKSB7fQoKICAgIC8vIFBlZXIgQWN0aW9ucwogIH0sIHsKICAgIGtleTogJ2Rpc2FibGVNaWMnLAogICAgdmFsdWU6IGZ1bmN0aW9uIGRpc2FibGVNaWMoKSB7CiAgICAgIHZhciBfdGhpcyA9IHRoaXM7CgogICAgICByZXR1cm4gbmV3IFByb21pc2UoZnVuY3Rpb24gKHJlc29sdmUsIHJlamVjdCkgewoKICAgICAgICB0cnkgewogICAgICAgICAgdmFyIGxvY2FsU3RyZWFtID0gX3RoaXMucGVlckNvbm5lY3Rpb24uZ2V0TG9jYWxTdHJlYW1zKClbMF07CiAgICAgICAgICB2YXIgYXVkaW9UcmFjayA9IGxvY2FsU3RyZWFtLmdldEF1ZGlvVHJhY2tzKClbMF07CgogICAgICAgICAgYXVkaW9UcmFjay5lbmFibGVkID0gYXVkaW9UcmFjay5lbmFibGVkID8gZmFsc2UgOiB0cnVlOwogICAgICAgICAgcmVzb2x2ZShhdWRpb1RyYWNrLmVuYWJsZWQpOwogICAgICAgIH0gY2F0Y2ggKGUpIHsKICAgICAgICAgIHJlamVjdChlKTsKICAgICAgICB9CiAgICAgIH0pOwogICAgfQogIH0sIHsKICAgIGtleTogJ2Rpc2FibGVDYW0nLAogICAgdmFsdWU6IGZ1bmN0aW9uIGRpc2FibGVDYW0oKSB7CiAgICAgIHZhciBfdGhpcyA9IHRoaXM7CgogICAgICByZXR1cm4gbmV3IFByb21pc2UoZnVuY3Rpb24gKHJlc29sdmUsIHJlamVjdCkgewoKICAgICAgICB0cnkgewogICAgICAgICAgdmFyIGxvY2FsU3RyZWFtID0gX3RoaXMucGVlckNvbm5lY3Rpb24uZ2V0TG9jYWxTdHJlYW1zKClbMF07CiAgICAgICAgICB2YXIgdmlkZW9UcmFjayA9IGxvY2FsU3RyZWFtLmdldFZpZGVvVHJhY2tzKClbMF07CgogICAgICAgICAgdmlkZW9UcmFjay5lbmFibGVkID0gdmlkZW9UcmFjay5lbmFibGVkID8gZmFsc2UgOiB0cnVlOwoKICAgICAgICAgIHJlc29sdmUodmlkZW9UcmFjay5lbmFibGVkKTsKICAgICAgICB9IGNhdGNoIChlKSB7CiAgICAgICAgICByZWplY3QoZSk7CiAgICAgICAgfQogICAgICB9KTsKICAgIH0KICB9LCB7CiAgICBrZXk6ICdtdXRlJywKICAgIHZhbHVlOiBmdW5jdGlvbiBtdXRlKCkgewoKICAgICAgdmFyIF90aGlzID0gdGhpczsKCiAgICAgIHJldHVybiBuZXcgUHJvbWlzZShmdW5jdGlvbiAocmVzb2x2ZSwgcmVqZWN0KSB7CgogICAgICAgIHRyeSB7CiAgICAgICAgICB2YXIgcmVtb3RlU3RyZWFtID0gX3RoaXMucGVlckNvbm5lY3Rpb24uZ2V0UmVtb3RlU3RyZWFtcygpWzBdOwogICAgICAgICAgdmFyIGF1ZGlvVHJhY2sgPSByZW1vdGVTdHJlYW0uZ2V0QXVkaW9UcmFja3MoKVswXTsKCiAgICAgICAgICBhdWRpb1RyYWNrLmVuYWJsZWQgPSBhdWRpb1RyYWNrLmVuYWJsZWQgPyBmYWxzZSA6IHRydWU7CgogICAgICAgICAgcmVzb2x2ZShhdWRpb1RyYWNrLmVuYWJsZWQpOwogICAgICAgIH0gY2F0Y2ggKGUpIHsKICAgICAgICAgIHJlamVjdChlKTsKICAgICAgICB9CiAgICAgIH0pOwogICAgfQogIH0sIHsKICAgIGtleTogJ3JlbW90ZVBlZXJJbmZvcm1hdGlvbicsCiAgICBzZXQ6IGZ1bmN0aW9uIHNldChyZW1vdGVQZWVySW5mb3JtYXRpb24pIHsKICAgICAgdmFyIF90aGlzID0gdGhpczsKICAgICAgX3RoaXMuX3JlbW90ZVBlZXJJbmZvcm1hdGlvbiA9IHJlbW90ZVBlZXJJbmZvcm1hdGlvbjsKICAgIH0sCgogICAgLyoqCiAgICAgKiBHZXQgaW5mb3JtYXRpb24gcmVsYXRpdmUgdG8gdGhlIFJlbW90ZSBQZWVyOwogICAgICogQHJldHVybiB7T2JqZWN0fSByZW1vdGVQZWVySW5mb3JtYXRpb247CiAgICAgKi8KICAgIGdldDogZnVuY3Rpb24gZ2V0KCkgewogICAgICB2YXIgX3RoaXMgPSB0aGlzOwogICAgICByZXR1cm4gX3RoaXMuX3JlbW90ZVBlZXJJbmZvcm1hdGlvbjsKICAgIH0KCiAgICAvKioKICAgICogU2V0IHRoZSBkYXRhT2JqZWN0IGluIHRoZSBjb250cm9sbGVyCiAgICAqIEBwYXJhbSB7Q29ubmVjdGlvbkRhdGFPYmplY3R9IGRhdGFPYmplY3QgLSBoYXZlIGFsbCBpbmZvcm1hdGlvbiBhYm91dCB0aGUgc3luY2hlciBvYmplY3Q7CiAgICAqLwogIH0sIHsKICAgIGtleTogJ2RhdGFPYmplY3RSZXBvcnRlcicsCiAgICBzZXQ6IGZ1bmN0aW9uIHNldChkYXRhT2JqZWN0UmVwb3J0ZXIpIHsKICAgICAgaWYgKCFkYXRhT2JqZWN0UmVwb3J0ZXIpIHRocm93IG5ldyBFcnJvcignVGhlIERhdGEgT2JqZWN0IFJlcG9ydGVyIGlzIGEgbmVlZGVkIHBhcmFtZXRlcicpOwoKICAgICAgdmFyIF90aGlzID0gdGhpczsKICAgICAgX3RoaXMuX2RhdGFPYmplY3RSZXBvcnRlciA9IGRhdGFPYmplY3RSZXBvcnRlcjsKCiAgICAgIHZhciBkYXRhID0gX3RoaXMuX2RhdGFPYmplY3RSZXBvcnRlci5kYXRhOwoKICAgICAgZGF0YU9iamVjdFJlcG9ydGVyLm9uU3Vic2NyaXB0aW9uKGZ1bmN0aW9uIChldmVudCkgewoKICAgICAgICBzZXRUaW1lb3V0KGZ1bmN0aW9uICgpIHsKICAgICAgICAgIGV2ZW50LmFjY2VwdCgpOwogICAgICAgIH0sIDIwMCk7CiAgICAgIH0pOwoKICAgICAgLy8gVE9ETzogQ2hlY2sgaWYgaXMgcmVhbHkgbmVjZXNzYXJ5IHRoZSBzZXRUaW1lb3V0CgogICAgICBpZiAoX3RoaXMubW9kZSA9PT0gJ29mZmVyJykgewogICAgICAgIHZhciBjb25uZWN0aW9uID0gbmV3IF9Db25uZWN0aW9uMlsnZGVmYXVsdCddKCk7CgogICAgICAgIC8vIFRPRE86IFNldCBvbiBjb25uZWN0aW9uIG9iamVjdCB0aGUgb3duZXIsIHBlZXIsIGFuZCBzdGF0dXM7CiAgICAgICAgY29ubmVjdGlvbi5vd25lciA9IF90aGlzLl9kYXRhT2JqZWN0UmVwb3J0ZXIuX293bmVyOwogICAgICAgIGRhdGEuY29ubmVjdGlvbiA9IGNvbm5lY3Rpb247CgogICAgICAgIF90aGlzLmNyZWF0ZU9mZmVyKCk7CiAgICAgIH0gZWxzZSB7CiAgICAgICAgdmFyIHBlZXIgPSBuZXcgX1BlZXIyWydkZWZhdWx0J10oKTsKICAgICAgICBkYXRhLnBlZXIgPSBwZWVyOwoKICAgICAgICBfdGhpcy5jcmVhdGVBbnN3ZXIoKTsKICAgICAgfQoKICAgICAgY29uc29sZS5kZWJ1ZyhfdGhpcy5fZGF0YU9iamVjdFJlcG9ydGVyKTsKICAgIH0sCgogICAgLyoqCiAgICAqIHJldHVybiB0aGUgZGF0YU9iamVjdCBpbiB0aGUgY29udHJvbGxlcgogICAgKiBAcmV0dXJuIHtDb25uZWN0aW9uRGF0YU9iamVjdH0gZGF0YU9iamVjdAogICAgKi8KICAgIGdldDogZnVuY3Rpb24gZ2V0KCkgewogICAgICB2YXIgX3RoaXMgPSB0aGlzOwogICAgICByZXR1cm4gX3RoaXMuX2RhdGFPYmplY3RSZXBvcnRlcjsKICAgIH0KCiAgICAvKioKICAgICogU2V0IHRoZSBkYXRhT2JqZWN0IGluIHRoZSBjb250cm9sbGVyCiAgICAqIEBwYXJhbSB7Q29ubmVjdGlvbkRhdGFPYmplY3R9IGRhdGFPYmplY3QgLSBoYXZlIGFsbCBpbmZvcm1hdGlvbiBhYm91dCB0aGUgc3luY2hlciBvYmplY3Q7CiAgICAqLwogIH0sIHsKICAgIGtleTogJ2RhdGFPYmplY3RPYnNlcnZlcicsCiAgICBzZXQ6IGZ1bmN0aW9uIHNldChkYXRhT2JqZWN0T2JzZXJ2ZXIpIHsKICAgICAgaWYgKCFkYXRhT2JqZWN0T2JzZXJ2ZXIpIHRocm93IG5ldyBFcnJvcignVGhlIERhdGEgT2JqZWN0IE9ic2VydmVyIGlzIGEgbmVlZGVkIHBhcmFtZXRlcicpOwoKICAgICAgdmFyIF90aGlzID0gdGhpczsKICAgICAgX3RoaXMuX2RhdGFPYmplY3RPYnNlcnZlciA9IGRhdGFPYmplY3RPYnNlcnZlcjsKICAgICAgX3RoaXMuY2hhbmdlUGVlckluZm9ybWF0aW9uKGRhdGFPYmplY3RPYnNlcnZlcik7CiAgICB9LAoKICAgIC8qKgogICAgKiByZXR1cm4gdGhlIGRhdGFPYmplY3QgaW4gdGhlIGNvbnRyb2xsZXIKICAgICogQHJldHVybiB7Q29ubmVjdGlvbkRhdGFPYmplY3R9IGRhdGFPYmplY3QKICAgICovCiAgICBnZXQ6IGZ1bmN0aW9uIGdldCgpIHsKICAgICAgdmFyIF90aGlzID0gdGhpczsKICAgICAgcmV0dXJuIF90aGlzLl9kYXRhT2JqZWN0T2JzZXJ2ZXI7CiAgICB9CiAgfV0pOwoKICByZXR1cm4gQ29ubmVjdGlvbkNvbnRyb2xsZXI7Cn0pKF91dGlsc0V2ZW50RW1pdHRlcjJbJ2RlZmF1bHQnXSk7CgpleHBvcnRzWydkZWZhdWx0J10gPSBDb25uZWN0aW9uQ29udHJvbGxlcjsKbW9kdWxlLmV4cG9ydHMgPSBleHBvcnRzWydkZWZhdWx0J107Cgp9LHsiLi4vdXRpbHMvRXZlbnRFbWl0dGVyIjoxNCwiLi9Db25uZWN0aW9uIjoyLCIuL1BlZXIiOjYsIndlYnJ0Yy1hZGFwdGVyLXRlc3QiOjF9XSw0OltmdW5jdGlvbihyZXF1aXJlLG1vZHVsZSxleHBvcnRzKXsKLyoganNoaW50IHVuZGVmOiB0cnVlICovCgondXNlIHN0cmljdCc7CgpPYmplY3QuZGVmaW5lUHJvcGVydHkoZXhwb3J0cywgJ19fZXNNb2R1bGUnLCB7CiAgdmFsdWU6IHRydWUKfSk7Cgp2YXIgX2NyZWF0ZUNsYXNzID0gKGZ1bmN0aW9uICgpIHsgZnVuY3Rpb24gZGVmaW5lUHJvcGVydGllcyh0YXJnZXQsIHByb3BzKSB7IGZvciAodmFyIGkgPSAwOyBpIDwgcHJvcHMubGVuZ3RoOyBpKyspIHsgdmFyIGRlc2NyaXB0b3IgPSBwcm9wc1tpXTsgZGVzY3JpcHRvci5lbnVtZXJhYmxlID0gZGVzY3JpcHRvci5lbnVtZXJhYmxlIHx8IGZhbHNlOyBkZXNjcmlwdG9yLmNvbmZpZ3VyYWJsZSA9IHRydWU7IGlmICgndmFsdWUnIGluIGRlc2NyaXB0b3IpIGRlc2NyaXB0b3Iud3JpdGFibGUgPSB0cnVlOyBPYmplY3QuZGVmaW5lUHJvcGVydHkodGFyZ2V0LCBkZXNjcmlwdG9yLmtleSwgZGVzY3JpcHRvcik7IH0gfSByZXR1cm4gZnVuY3Rpb24gKENvbnN0cnVjdG9yLCBwcm90b1Byb3BzLCBzdGF0aWNQcm9wcykgeyBpZiAocHJvdG9Qcm9wcykgZGVmaW5lUHJvcGVydGllcyhDb25zdHJ1Y3Rvci5wcm90b3R5cGUsIHByb3RvUHJvcHMpOyBpZiAoc3RhdGljUHJvcHMpIGRlZmluZVByb3BlcnRpZXMoQ29uc3RydWN0b3IsIHN0YXRpY1Byb3BzKTsgcmV0dXJuIENvbnN0cnVjdG9yOyB9OyB9KSgpOwoKdmFyIF9nZXQgPSBmdW5jdGlvbiBnZXQoX3gsIF94MiwgX3gzKSB7IHZhciBfYWdhaW4gPSB0cnVlOyBfZnVuY3Rpb246IHdoaWxlIChfYWdhaW4pIHsgdmFyIG9iamVjdCA9IF94LCBwcm9wZXJ0eSA9IF94MiwgcmVjZWl2ZXIgPSBfeDM7IF9hZ2FpbiA9IGZhbHNlOyBpZiAob2JqZWN0ID09PSBudWxsKSBvYmplY3QgPSBGdW5jdGlvbi5wcm90b3R5cGU7IHZhciBkZXNjID0gT2JqZWN0LmdldE93blByb3BlcnR5RGVzY3JpcHRvcihvYmplY3QsIHByb3BlcnR5KTsgaWYgKGRlc2MgPT09IHVuZGVmaW5lZCkgeyB2YXIgcGFyZW50ID0gT2JqZWN0LmdldFByb3RvdHlwZU9mKG9iamVjdCk7IGlmIChwYXJlbnQgPT09IG51bGwpIHsgcmV0dXJuIHVuZGVmaW5lZDsgfSBlbHNlIHsgX3ggPSBwYXJlbnQ7IF94MiA9IHByb3BlcnR5OyBfeDMgPSByZWNlaXZlcjsgX2FnYWluID0gdHJ1ZTsgZGVzYyA9IHBhcmVudCA9IHVuZGVmaW5lZDsgY29udGludWUgX2Z1bmN0aW9uOyB9IH0gZWxzZSBpZiAoJ3ZhbHVlJyBpbiBkZXNjKSB7IHJldHVybiBkZXNjLnZhbHVlOyB9IGVsc2UgeyB2YXIgZ2V0dGVyID0gZGVzYy5nZXQ7IGlmIChnZXR0ZXIgPT09IHVuZGVmaW5lZCkgeyByZXR1cm4gdW5kZWZpbmVkOyB9IHJldHVybiBnZXR0ZXIuY2FsbChyZWNlaXZlcik7IH0gfSB9OwoKZXhwb3J0c1snZGVmYXVsdCddID0gYWN0aXZhdGU7CgpmdW5jdGlvbiBfaW50ZXJvcFJlcXVpcmVEZWZhdWx0KG9iaikgeyByZXR1cm4gb2JqICYmIG9iai5fX2VzTW9kdWxlID8gb2JqIDogeyAnZGVmYXVsdCc6IG9iaiB9OyB9CgpmdW5jdGlvbiBfY2xhc3NDYWxsQ2hlY2soaW5zdGFuY2UsIENvbnN0cnVjdG9yKSB7IGlmICghKGluc3RhbmNlIGluc3RhbmNlb2YgQ29uc3RydWN0b3IpKSB7IHRocm93IG5ldyBUeXBlRXJyb3IoJ0Nhbm5vdCBjYWxsIGEgY2xhc3MgYXMgYSBmdW5jdGlvbicpOyB9IH0KCmZ1bmN0aW9uIF9pbmhlcml0cyhzdWJDbGFzcywgc3VwZXJDbGFzcykgeyBpZiAodHlwZW9mIHN1cGVyQ2xhc3MgIT09ICdmdW5jdGlvbicgJiYgc3VwZXJDbGFzcyAhPT0gbnVsbCkgeyB0aHJvdyBuZXcgVHlwZUVycm9yKCdTdXBlciBleHByZXNzaW9uIG11c3QgZWl0aGVyIGJlIG51bGwgb3IgYSBmdW5jdGlvbiwgbm90ICcgKyB0eXBlb2Ygc3VwZXJDbGFzcyk7IH0gc3ViQ2xhc3MucHJvdG90eXBlID0gT2JqZWN0LmNyZWF0ZShzdXBlckNsYXNzICYmIHN1cGVyQ2xhc3MucHJvdG90eXBlLCB7IGNvbnN0cnVjdG9yOiB7IHZhbHVlOiBzdWJDbGFzcywgZW51bWVyYWJsZTogZmFsc2UsIHdyaXRhYmxlOiB0cnVlLCBjb25maWd1cmFibGU6IHRydWUgfSB9KTsgaWYgKHN1cGVyQ2xhc3MpIE9iamVjdC5zZXRQcm90b3R5cGVPZiA/IE9iamVjdC5zZXRQcm90b3R5cGVPZihzdWJDbGFzcywgc3VwZXJDbGFzcykgOiBzdWJDbGFzcy5fX3Byb3RvX18gPSBzdXBlckNsYXNzOyB9Cgp2YXIgX0Nvbm5lY3Rpb25Db250cm9sbGVyID0gcmVxdWlyZSgnLi9Db25uZWN0aW9uQ29udHJvbGxlcicpOwoKdmFyIF9Db25uZWN0aW9uQ29udHJvbGxlcjIgPSBfaW50ZXJvcFJlcXVpcmVEZWZhdWx0KF9Db25uZWN0aW9uQ29udHJvbGxlcik7Cgp2YXIgX3V0aWxzRXZlbnRFbWl0dGVyID0gcmVxdWlyZSgnLi4vdXRpbHMvRXZlbnRFbWl0dGVyJyk7Cgp2YXIgX3V0aWxzRXZlbnRFbWl0dGVyMiA9IF9pbnRlcm9wUmVxdWlyZURlZmF1bHQoX3V0aWxzRXZlbnRFbWl0dGVyKTsKCnZhciBfc3luY2hlclN5bmNoZXIgPSByZXF1aXJlKCcuLi9zeW5jaGVyL1N5bmNoZXInKTsKCnZhciBfc3luY2hlclN5bmNoZXIyID0gX2ludGVyb3BSZXF1aXJlRGVmYXVsdChfc3luY2hlclN5bmNoZXIpOwoKLyoqCiogSHlwZXJ0eSBDb25uZWN0b3I7CiogQGF1dGhvciBWaXRvciBTaWx2YSBbdml0b3ItdC1zaWx2YUB0ZWxlY29tLnB0XQoqIEB2ZXJzaW9uIDAuMS4wCiovCgp2YXIgSHlwZXJ0eUNvbm5lY3RvciA9IChmdW5jdGlvbiAoX0V2ZW50RW1pdHRlcikgewogIF9pbmhlcml0cyhIeXBlcnR5Q29ubmVjdG9yLCBfRXZlbnRFbWl0dGVyKTsKCiAgLyoqCiAgKiBDcmVhdGUgYSBuZXcgSHlwZXJ0eSBDb25uZWN0b3IKICAqIEBwYXJhbSAge1N5bmNoZXJ9IHN5bmNoZXIgLSBTeW5jaGVyIHByb3ZpZGVkIGZyb20gdGhlIHJ1bnRpbWUgY29yZQogICovCgogIGZ1bmN0aW9uIEh5cGVydHlDb25uZWN0b3IoaHlwZXJ0eVVSTCwgYnVzLCBjb25maWd1cmF0aW9uKSB7CiAgICBfY2xhc3NDYWxsQ2hlY2sodGhpcywgSHlwZXJ0eUNvbm5lY3Rvcik7CgogICAgaWYgKCFoeXBlcnR5VVJMKSB0aHJvdyBuZXcgRXJyb3IoJ1RoZSBoeXBlcnR5VVJMIGlzIGEgbmVlZGVkIHBhcmFtZXRlcicpOwogICAgaWYgKCFidXMpIHRocm93IG5ldyBFcnJvcignVGhlIE1pbmlCdXMgaXMgYSBuZWVkZWQgcGFyYW1ldGVyJyk7CiAgICBpZiAoIWNvbmZpZ3VyYXRpb24pIHRocm93IG5ldyBFcnJvcignVGhlIGNvbmZpZ3VyYXRpb24gaXMgYSBuZWVkZWQgcGFyYW1ldGVyJyk7CgogICAgX2dldChPYmplY3QuZ2V0UHJvdG90eXBlT2YoSHlwZXJ0eUNvbm5lY3Rvci5wcm90b3R5cGUpLCAnY29uc3RydWN0b3InLCB0aGlzKS5jYWxsKHRoaXMsIGh5cGVydHlVUkwsIGJ1cywgY29uZmlndXJhdGlvbik7CgogICAgdmFyIF90aGlzID0gdGhpczsKICAgIF90aGlzLl9oeXBlcnR5VVJMID0gaHlwZXJ0eVVSTDsKICAgIF90aGlzLl9idXMgPSBidXM7CiAgICBfdGhpcy5fY29uZmlndXJhdGlvbiA9IGNvbmZpZ3VyYXRpb247CgogICAgX3RoaXMuX29iamVjdERlc2NVUkwgPSAnaHlwZXJ0eS1jYXRhbG9ndWU6Ly9sb2NhbGhvc3QvLndlbGwta25vd24vZGF0YXNjaGVtYXMvRmFrZURhdGFTY2hlbWEnOwoKICAgIF90aGlzLl9jb250cm9sbGVycyA9IHt9OwoKICAgIHZhciBzeW5jaGVyID0gbmV3IF9zeW5jaGVyU3luY2hlcjJbJ2RlZmF1bHQnXShoeXBlcnR5VVJMLCBidXMsIGNvbmZpZ3VyYXRpb24pOwogICAgc3luY2hlci5vbk5vdGlmaWNhdGlvbihmdW5jdGlvbiAoZXZlbnQpIHsKICAgICAgX3RoaXMuX29uTm90aWZpY2F0aW9uKGV2ZW50KTsKICAgIH0pOwoKICAgIF90aGlzLl9zeW5jaGVyID0gc3luY2hlcjsKICB9CgogIF9jcmVhdGVDbGFzcyhIeXBlcnR5Q29ubmVjdG9yLCBbewogICAga2V5OiAnX29uTm90aWZpY2F0aW9uJywKICAgIHZhbHVlOiBmdW5jdGlvbiBfb25Ob3RpZmljYXRpb24oZXZlbnQpIHsKCiAgICAgIHZhciBfdGhpcyA9IHRoaXM7CgogICAgICBjb25zb2xlLmluZm8oJy0tLS0tLS0tLS0tLSBBY2tub3dsZWRnZXMgdGhlIFJlcG9ydGVyIC0tLS0tLS0tLS0tLSBcbicpOwogICAgICBldmVudC5hY2soKTsKICAgICAgY29uc29sZS5pbmZvKCctLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0gRU5EIC0tLS0tLS0tLS0tLS0tLS0tLS0tLS0gXG4nKTsKCiAgICAgIGNvbnNvbGUubG9nKF90aGlzLl9jb250cm9sbGVyc1tldmVudC5mcm9tXSk7CiAgICAgIGlmIChfdGhpcy5fY29udHJvbGxlcnNbZXZlbnQuZnJvbV0pIHsKICAgICAgICBfdGhpcy5fYXV0b1N1YnNjcmliZShldmVudCk7CiAgICAgIH0gZWxzZSB7CgogICAgICAgIHNldFRpbWVvdXQoZnVuY3Rpb24gKCkgewogICAgICAgICAgX3RoaXMuX2F1dG9BY2NlcHQoZXZlbnQpOwogICAgICAgIH0sIDMwMDApOwogICAgICB9CiAgICB9CiAgfSwgewogICAga2V5OiAnX2F1dG9BY2NlcHQnLAogICAgdmFsdWU6IGZ1bmN0aW9uIF9hdXRvQWNjZXB0KGV2ZW50KSB7CiAgICAgIHZhciBfdGhpcyA9IHRoaXM7CiAgICAgIHZhciBzeW5jaGVyID0gX3RoaXMuX3N5bmNoZXI7CgogICAgICBjb25zb2xlLmluZm8oJy0tLS0tLS0tLS0tLS0tLS0gU3luY2hlciBTdWJzY3JpYmUgLS0tLS0tLS0tLS0tLS0tLSBcbicpOwogICAgICBjb25zb2xlLmluZm8oJ1N1YnNjcmliZSBVUkwgT2JqZWN0ICcsIGV2ZW50LCBzeW5jaGVyKTsKCiAgICAgIHN5bmNoZXIuc3Vic2NyaWJlKF90aGlzLl9vYmplY3REZXNjVVJMLCBldmVudC51cmwpLnRoZW4oZnVuY3Rpb24gKGRhdGFPYmplY3RPYnNlcnZlcikgewogICAgICAgIGNvbnNvbGUuaW5mbygnMS4gUmV0dXJuIFN1YnNjcmliZSBEYXRhIE9iamVjdCBPYnNlcnZlcicsIGRhdGFPYmplY3RPYnNlcnZlcik7CgogICAgICAgIHZhciBjb25uZWN0aW9uQ29udHJvbGxlciA9IG5ldyBfQ29ubmVjdGlvbkNvbnRyb2xsZXIyWydkZWZhdWx0J10oc3luY2hlcik7CgogICAgICAgIC8vIFRPRE86IHJlbW92ZSB0aGlzIHJlbW90ZVBlZXJJbmZvcm1hdGlvbjsKICAgICAgICBjb25uZWN0aW9uQ29udHJvbGxlci5yZW1vdGVQZWVySW5mb3JtYXRpb24gPSBldmVudDsKICAgICAgICBjb25uZWN0aW9uQ29udHJvbGxlci5kYXRhT2JqZWN0T2JzZXJ2ZXIgPSBkYXRhT2JqZWN0T2JzZXJ2ZXI7CiAgICAgICAgX3RoaXMudHJpZ2dlcignY29ubmVjdG9yOmNvbm5lY3RlZCcsIGNvbm5lY3Rpb25Db250cm9sbGVyKTsKICAgICAgICBfdGhpcy50cmlnZ2VyKCdoYXZlOm5vdGlmaWNhdGlvbicsIGV2ZW50KTsKCiAgICAgICAgY29uc29sZS5pbmZvKCctLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0gRU5EIC0tLS0tLS0tLS0tLS0tLS0tLS0tLS0gXG4nKTsKICAgICAgfSlbJ2NhdGNoJ10oZnVuY3Rpb24gKHJlYXNvbikgewogICAgICAgIGNvbnNvbGUuZXJyb3IocmVhc29uKTsKICAgICAgfSk7CiAgICB9CiAgfSwgewogICAga2V5OiAnX2F1dG9TdWJzY3JpYmUnLAogICAgdmFsdWU6IGZ1bmN0aW9uIF9hdXRvU3Vic2NyaWJlKGV2ZW50KSB7CiAgICAgIHZhciBfdGhpcyA9IHRoaXM7CiAgICAgIHZhciBzeW5jaGVyID0gX3RoaXMuX3N5bmNoZXI7CgogICAgICBjb25zb2xlLmluZm8oJy0tLS0tLS0tLS0tLS0tLS0gU3luY2hlciBTdWJzY3JpYmUgLS0tLS0tLS0tLS0tLS0tLSBcbicpOwogICAgICBjb25zb2xlLmluZm8oJ1N1YnNjcmliZSBVUkwgT2JqZWN0ICcsIGV2ZW50LCBzeW5jaGVyKTsKICAgICAgc3luY2hlci5zdWJzY3JpYmUoX3RoaXMuX29iamVjdERlc2NVUkwsIGV2ZW50LnVybCkudGhlbihmdW5jdGlvbiAoZGF0YU9iamVjdE9ic2VydmVyKSB7CiAgICAgICAgY29uc29sZS5pbmZvKCcxLiBSZXR1cm4gU3Vic2NyaWJlIERhdGEgT2JqZWN0IE9ic2VydmVyJywgZGF0YU9iamVjdE9ic2VydmVyKTsKCiAgICAgICAgX3RoaXMuX2NvbnRyb2xsZXJzW2V2ZW50LmZyb21dLmRhdGFPYmplY3RPYnNlcnZlciA9IGRhdGFPYmplY3RPYnNlcnZlcjsKICAgICAgfSlbJ2NhdGNoJ10oZnVuY3Rpb24gKHJlYXNvbikgewogICAgICAgIGNvbnNvbGUuZXJyb3IocmVhc29uKTsKICAgICAgfSk7CiAgICB9CgogICAgLyoqCiAgICAqIEVzdGFibGlzaCBjb25uZWN0aW9uIHdpdGggb3RoZXIgY2xpZW50IGlkZW50aWZpZXIKICAgICogQHBhcmFtICB7SHlwZXJ0eVVSTH0gSHlwZXJ0eVVSTCAtIERlZmluZSB0aGUgaWRlbnRpZmllciBvZiB0aGUgb3RoZXIgY29tcG9uZW50CiAgICAqIEBwYXJhbSAge09iamVjdH0gb3B0aW9ucyAtIE9iamVjdCB3aXRoIG9wdGlvbnMgdG8gaW1wcm92ZSB0aGUgY29ubmVjdAogICAgKi8KICB9LCB7CiAgICBrZXk6ICdjb25uZWN0JywKICAgIHZhbHVlOiBmdW5jdGlvbiBjb25uZWN0KGh5cGVydHlVUkwsIG9wdGlvbnMpIHsKICAgICAgLy8gVE9ETzogQ0hhbmdlIHRoZSBoeXBlcnR5VVJMIGZvciBhIGxpc3Qgb2YgVVJMUwogICAgICB2YXIgX3RoaXMgPSB0aGlzOwogICAgICB2YXIgc3luY2hlciA9IF90aGlzLl9zeW5jaGVyOwoKICAgICAgb3B0aW9ucyA9IG9wdGlvbnMgfHwgeyB2aWRlbzogdHJ1ZSwgYXVkaW86IHRydWUgfTsKCiAgICAgIHJldHVybiBuZXcgUHJvbWlzZShmdW5jdGlvbiAocmVzb2x2ZSwgcmVqZWN0KSB7CgogICAgICAgIHZhciBjb25uZWN0aW9uQ29udHJvbGxlciA9IHVuZGVmaW5lZDsKICAgICAgICB2YXIgX2RhdGFPYmplY3RSZXBvcnRlciA9IHVuZGVmaW5lZDsKCiAgICAgICAgY29uc29sZS5pbmZvKCctLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0gU3luY2hlciBDcmVhdGUgLS0tLS0tLS0tLS0tLS0tLS0tLS0tLSBcbicpOwogICAgICAgIHN5bmNoZXIuY3JlYXRlKF90aGlzLl9vYmplY3REZXNjVVJMLCBbaHlwZXJ0eVVSTF0sIHt9KS50aGVuKGZ1bmN0aW9uIChkYXRhT2JqZWN0UmVwb3J0ZXIpIHsKICAgICAgICAgIGNvbnNvbGUuaW5mbygnMS4gUmV0dXJuIENyZWF0ZSBEYXRhIE9iamVjdCBSZXBvcnRlcicsIGRhdGFPYmplY3RSZXBvcnRlcik7CgogICAgICAgICAgX2RhdGFPYmplY3RSZXBvcnRlciA9IGRhdGFPYmplY3RSZXBvcnRlcjsKCiAgICAgICAgICBjb25uZWN0aW9uQ29udHJvbGxlciA9IG5ldyBfQ29ubmVjdGlvbkNvbnRyb2xsZXIyWydkZWZhdWx0J10oc3luY2hlcik7CiAgICAgICAgICByZXR1cm4gY29ubmVjdGlvbkNvbnRyb2xsZXIuZ2V0VXNlck1lZGlhKG9wdGlvbnMpOwogICAgICAgIH0pLnRoZW4oZnVuY3Rpb24gKG1lZGlhQ29uc3RyYWludHMpIHsKICAgICAgICAgIGNvbnNvbGUuaW5mbygnMi4gUmV0dXJuIHRoZSBtZWRpYSBjb25zdHJhaW50cyBmcm9tIGNvbnRyb2xsZXI6ICcsIG1lZGlhQ29uc3RyYWludHMpOwoKICAgICAgICAgIGNvbm5lY3Rpb25Db250cm9sbGVyLmRhdGFPYmplY3RSZXBvcnRlciA9IF9kYXRhT2JqZWN0UmVwb3J0ZXI7CiAgICAgICAgICBfdGhpcy5fY29udHJvbGxlcnNbaHlwZXJ0eVVSTF0gPSBjb25uZWN0aW9uQ29udHJvbGxlcjsKCiAgICAgICAgICByZXNvbHZlKGNvbm5lY3Rpb25Db250cm9sbGVyKTsKICAgICAgICAgIGNvbnNvbGUuaW5mbygnLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tIEVORCAtLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0gXG4nKTsKICAgICAgICB9KVsnY2F0Y2gnXShmdW5jdGlvbiAocmVhc29uKSB7CiAgICAgICAgICBjb25zb2xlLmVycm9yKHJlYXNvbik7CiAgICAgICAgICByZWplY3QocmVhc29uKTsKICAgICAgICB9KTsKICAgICAgfSk7CiAgICB9CgogICAgLy8gLyoqCiAgICAvLyAqIEFjY2VwdCB0aGUgaW5jb21pbmcgY2FsbAogICAgLy8gKiBAbWV0aG9kIGFjY2VwdAogICAgLy8gKiBAcmV0dXJuIHtQcm9taXNlfQogICAgLy8gKi8KICAgIC8vIGFjY2VwdCgpIHsKICAgIC8vICAgbGV0IF90aGlzID0gdGhpczsKICAgIC8vCiAgICAvLyAgIHJldHVybiBuZXcgUHJvbWlzZShmdW5jdGlvbihyZXNvbHZlLCByZWplY3QpIHsKICAgIC8vCiAgICAvLyAgICAgbGV0IG9iamVjdFVSTCA9IF90aGlzLm5vdGlmaWNhdGlvbkV2ZW50LnVybDsKICAgIC8vCiAgICAvLyAgICAgLy8gc3RlcCA2IC0gaHR0cHM6Ly9naXRodWIuY29tL3JlVEhJTkstcHJvamVjdC9zY2VuYXJpby1zZXJ2aWNlLWltcGxlbWVudGF0aW9uL3RyZWUvbWFzdGVyL2RvY3MvaHlwZXJ0aWVzL2Nvbm5lY3RvciNub3RpZmljYXRpb24tYWJvdXQtaW5jb21pbmctY29ubmVjdGlvbi1yZXF1ZXN0CiAgICAvLyAgICAgLy8gYWZ0ZXIgd2FpdGluZyBmb3IgYW4gYW5zd2VyLCB3ZSBjYW4gbm93IHN1YnNjcmliZSB0aGUgb2JqZWN0VVJMCiAgICAvLyAgICAgX3RoaXMuX3N5bmNoZXIuc3Vic2NyaWJlKG9iamVjdFVSTCkudGhlbihmdW5jdGlvbihjb25uZWN0aW9uRGF0YU9iamVjdCkgewogICAgLy8gICAgICAgY29uc29sZS5pbmZvKCdSZXR1cm4gU3Vic2NyaWJlIENvbm5lY3Rpb24gRGF0YSBPYmplY3QnLCBjb25uZWN0aW9uRGF0YU9iamVjdCk7CiAgICAvLwogICAgLy8gICAgICAgLy8gc3RlcCA3IGFuZCAxMCAtIGh0dHBzOi8vZ2l0aHViLmNvbS9yZVRISU5LLXByb2plY3Qvc2NlbmFyaW8tc2VydmljZS1pbXBsZW1lbnRhdGlvbi90cmVlL21hc3Rlci9kb2NzL2h5cGVydGllcy9jb25uZWN0b3Ijbm90aWZpY2F0aW9uLWFib3V0LWluY29taW5nLWNvbm5lY3Rpb24tcmVxdWVzdAogICAgLy8gICAgICAgX3RoaXMuY29ubmVjdGlvbkNvbnRyb2xsZXIuZGF0YU9iamVjdE9ic2VydmVyID0gY29ubmVjdGlvbkRhdGFPYmplY3Q7CiAgICAvLyAgICAgICByZXNvbHZlKF90aGlzLmNvbm5lY3Rpb25Db250cm9sbGVyKTsKICAgIC8vCiAgICAvLyAgICAgICBsZXQgcmVzb3VyY2VzID0gY29ubmVjdGlvbkRhdGFPYmplY3QuZGF0YS5yZXNvdXJjZXM7CiAgICAvLyAgICAgICByZXR1cm4gX3RoaXMuY29ubmVjdGlvbkNvbnRyb2xsZXIuZ2V0VXNlck1lZGlhKHJlc291cmNlcyk7CiAgICAvLyAgICAgfSkKICAgIC8vICAgICAudGhlbihmdW5jdGlvbihjb21tUmVzb3VyY2VzKSB7CiAgICAvLyAgICAgICBjb25zb2xlLmluZm8oJ0dldCB3ZWJSVEMgY29tbW9uIHJlc291cmNlcycsIGNvbW1SZXNvdXJjZXMpOwogICAgLy8gICAgIH0pCiAgICAvLyAgICAgLmNhdGNoKGZ1bmN0aW9uKHJlYXNvbikgewogICAgLy8gICAgICAgY29uc29sZS5lcnJvcihyZWFzb24pOwogICAgLy8gICAgICAgcmVqZWN0KHJlYXNvbik7CiAgICAvLyAgICAgfSk7CiAgICAvLyAgIH0pOwogICAgLy8gfQogICAgLy8KICAgIC8vIC8qKgogICAgLy8gKiBDb25uZWN0aW9uIGlzIGNsb3NlZCBieSBsb2NhbCBwZWVyIGFuZCBkaXNjb25uZWN0ZWQ7CiAgICAvLyAqIEBtZXRob2QgZGlzY29ubmVjdAogICAgLy8gKiBAcmV0dXJuIHtQcm9taXNlfQogICAgLy8gKi8KICAgIC8vIGRpc2Nvbm5lY3QoKSB7CiAgICAvLwogICAgLy8gICBsZXQgX3RoaXMgPSB0aGlzOwogICAgLy8KICAgIC8vICAgcmV0dXJuIG5ldyBQcm9taXNlKGZ1bmN0aW9uKHJlc29sdmUsIHJlamVjdCkgewogICAgLy8KICAgIC8vICAgICBfdGhpcy5jb25uZWN0aW9uQ29udHJvbGxlci5kaXNjb25uZWN0KCkKICAgIC8vICAgICAudGhlbihmdW5jdGlvbihkaXNjb25uZWN0ZWQpIHsKICAgIC8vCiAgICAvLyAgICAgICBjb25zb2xlLmluZm8oJ2Rpc2Nvbm5lY3RlZDogJywgZGlzY29ubmVjdGVkKTsKICAgIC8vCiAgICAvLyAgICAgICByZXNvbHZlKGRpc2Nvbm5lY3RlZCk7CiAgICAvLyAgICAgfSkKICAgIC8vICAgICAuY2F0Y2goZnVuY3Rpb24ocmVhc29uKSB7CiAgICAvLyAgICAgICByZWplY3QocmVhc29uKTsKICAgIC8vICAgICB9KTsKICAgIC8vCiAgICAvLyAgIH0pOwogICAgLy8KICAgIC8vIH0KICAgIC8vCiAgICAvLyBfYXV0b0Nvbm5lY3QoaHlwZXJ0eVVSTCkgewogICAgLy8gICBsZXQgX3RoaXMgPSB0aGlzOwogICAgLy8KICAgIC8vICAgX3RoaXMuX3N5bmNoZXIuY3JlYXRlKHt9LCBbaHlwZXJ0eVVSTF0sIHt9KS50aGVuKGZ1bmN0aW9uKGNvbm5lY3Rpb25EYXRhT2JqZWN0KSB7CiAgICAvLyAgICAgY29uc29sZS5pbmZvKCdSZXR1cm4gQ3JlYXRlIENvbm5lY3Rpb24gRGF0YSBPYmplY3QnLCBjb25uZWN0aW9uRGF0YU9iamVjdCk7CiAgICAvLyAgICAgX3RoaXMuY29ubmVjdGlvbkNvbnRyb2xsZXIuY29ubmVjdGlvbkRhdGFPYmplY3RSZXBvcnRlciA9IGNvbm5lY3Rpb25EYXRhT2JqZWN0OwogICAgLy8gICB9KS5jYXRjaChmdW5jdGlvbihyZWFzb24pIHsKICAgIC8vICAgICBjb25zb2xlLmVycm9yKHJlYXNvbik7CiAgICAvLyAgIH0pOwogICAgLy8gfQoKICB9XSk7CgogIHJldHVybiBIeXBlcnR5Q29ubmVjdG9yOwp9KShfdXRpbHNFdmVudEVtaXR0ZXIyWydkZWZhdWx0J10pOwoKZnVuY3Rpb24gYWN0aXZhdGUoaHlwZXJ0eVVSTCwgYnVzLCBjb25maWd1cmF0aW9uKSB7CgogIHJldHVybiB7CiAgICBuYW1lOiAnSHlwZXJ0eUNvbm5lY3RvcicsCiAgICBpbnN0YW5jZTogbmV3IEh5cGVydHlDb25uZWN0b3IoaHlwZXJ0eVVSTCwgYnVzLCBjb25maWd1cmF0aW9uKQogIH07Cn0KCm1vZHVsZS5leHBvcnRzID0gZXhwb3J0c1snZGVmYXVsdCddOwoKfSx7Ii4uL3N5bmNoZXIvU3luY2hlciI6MTMsIi4uL3V0aWxzL0V2ZW50RW1pdHRlciI6MTQsIi4vQ29ubmVjdGlvbkNvbnRyb2xsZXIiOjN9XSw1OltmdW5jdGlvbihyZXF1aXJlLG1vZHVsZSxleHBvcnRzKXsKJ3VzZSBzdHJpY3QnOwoKT2JqZWN0LmRlZmluZVByb3BlcnR5KGV4cG9ydHMsICdfX2VzTW9kdWxlJywgewogIHZhbHVlOiB0cnVlCn0pOwoKZnVuY3Rpb24gX2NsYXNzQ2FsbENoZWNrKGluc3RhbmNlLCBDb25zdHJ1Y3RvcikgeyBpZiAoIShpbnN0YW5jZSBpbnN0YW5jZW9mIENvbnN0cnVjdG9yKSkgeyB0aHJvdyBuZXcgVHlwZUVycm9yKCdDYW5ub3QgY2FsbCBhIGNsYXNzIGFzIGEgZnVuY3Rpb24nKTsgfSB9Cgp2YXIgT3duZXJQZWVyID0gZnVuY3Rpb24gT3duZXJQZWVyKCkgewogIF9jbGFzc0NhbGxDaGVjayh0aGlzLCBPd25lclBlZXIpOwoKICBjb25zb2xlLmxvZygnT3duZXJQZWVyJyk7CgogIHZhciBfdGhpcyA9IHRoaXM7CgogIF90aGlzLmNvbm5lY3Rpb25EZXNjcmlwdGlvbiA9IHt9OwogIF90aGlzLmljZUNhbmRpZGF0ZXMgPSBbXTsKfQoKLy8gc2V0IGNvbm5lY3Rpb25EZXNjcmlwdGlvbih2YWx1ZSkgewovLyAgIGlmICghdmFsdWUpIHRocm93IG5ldyBFcnJvcignVGhlIGNvbm5lY3Rpb25EZXNjcmlwdGlvbiBuZWVkIGEgdmFsdWUnKTsKLy8KLy8gICBsZXQgX3RoaXMgPSB0aGlzOwovLwovLyAgIF90aGlzLl9jb25uZWN0aW9uRGVzY3JpcHRpb24gPSB2YWx1ZTsKLy8gfQovLwovLyBnZXQgY29ubmVjdGlvbkRlc2NyaXB0aW9uKCkgewovLyAgIGxldCBfdGhpcyA9IHRoaXM7Ci8vCi8vICAgcmV0dXJuIF90aGlzLl9jb25uZWN0aW9uRGVzY3JpcHRpb247Ci8vIH0KLy8KLy8gc2V0IGljZUNhbmRpZGF0ZXModmFsdWUpIHsKLy8gICBpZiAoIXZhbHVlKSB0aHJvdyBuZXcgRXJyb3IoJ1RoZSBpY2VDYW5kaWRhdGVzIG5lZWQgYSB2YWx1ZScpOwovLwovLyAgIGxldCBfdGhpcyA9IHRoaXM7Ci8vICAgaWYgKCFfdGhpcy5faWNlY2FuZGlkYXRlcykgX3RoaXMuX2ljZWNhbmRpZGF0ZXMgPSBbXTsKLy8KLy8gICBfdGhpcy5faWNlY2FuZGlkYXRlcy5wdXNoKHZhbHVlKTsKLy8KLy8gICBjb25zb2xlLmxvZyhfdGhpcy5faWNlY2FuZGlkYXRlcyk7Ci8vIH0KLy8KLy8gZ2V0IGljZUNhbmRpZGF0ZXMoKSB7Ci8vICAgbGV0IF90aGlzID0gdGhpczsKLy8gICByZXR1cm4gX3RoaXMuX2ljZWNhbmRpZGF0ZXM7Ci8vIH0KCjsKCmV4cG9ydHNbJ2RlZmF1bHQnXSA9IE93bmVyUGVlcjsKbW9kdWxlLmV4cG9ydHMgPSBleHBvcnRzWydkZWZhdWx0J107Cgp9LHt9XSw2OltmdW5jdGlvbihyZXF1aXJlLG1vZHVsZSxleHBvcnRzKXsKJ3VzZSBzdHJpY3QnOwoKT2JqZWN0LmRlZmluZVByb3BlcnR5KGV4cG9ydHMsICdfX2VzTW9kdWxlJywgewogIHZhbHVlOiB0cnVlCn0pOwoKZnVuY3Rpb24gX2NsYXNzQ2FsbENoZWNrKGluc3RhbmNlLCBDb25zdHJ1Y3RvcikgeyBpZiAoIShpbnN0YW5jZSBpbnN0YW5jZW9mIENvbnN0cnVjdG9yKSkgeyB0aHJvdyBuZXcgVHlwZUVycm9yKCdDYW5ub3QgY2FsbCBhIGNsYXNzIGFzIGEgZnVuY3Rpb24nKTsgfSB9Cgp2YXIgUGVlciA9IGZ1bmN0aW9uIFBlZXIoKSB7CiAgX2NsYXNzQ2FsbENoZWNrKHRoaXMsIFBlZXIpOwoKICBjb25zb2xlLmxvZygnUEVFUicpOwoKICB2YXIgX3RoaXMgPSB0aGlzOwoKICBfdGhpcy5jb25uZWN0aW9uRGVzY3JpcHRpb24gPSB7fTsKICBfdGhpcy5pY2VDYW5kaWRhdGVzID0gW107Cn0KCi8vIHNldCBjb25uZWN0aW9uRGVzY3JpcHRpb24odmFsdWUpIHsKLy8gICBpZiAoIXZhbHVlKSB0aHJvdyBuZXcgRXJyb3IoJ1RoZSBjb25uZWN0aW9uRGVzY3JpcHRpb24gbmVlZCBhIHZhbHVlJyk7Ci8vCi8vICAgbGV0IF90aGlzID0gdGhpczsKLy8KLy8gICBfdGhpcy5fY29ubmVjdGlvbkRlc2NyaXB0aW9uID0gdmFsdWU7Ci8vIH0KLy8KLy8gZ2V0IGNvbm5lY3Rpb25EZXNjcmlwdGlvbigpIHsKLy8gICBsZXQgX3RoaXMgPSB0aGlzOwovLwovLyAgIHJldHVybiBfdGhpcy5fY29ubmVjdGlvbkRlc2NyaXB0aW9uOwovLyB9Ci8vCi8vIHNldCBpY2VDYW5kaWRhdGVzKHZhbHVlKSB7Ci8vICAgaWYgKCF2YWx1ZSkgdGhyb3cgbmV3IEVycm9yKCdUaGUgaWNlQ2FuZGlkYXRlcyBuZWVkIGEgdmFsdWUnKTsKLy8KLy8gICBsZXQgX3RoaXMgPSB0aGlzOwovLyAgIGlmICghX3RoaXMuX2ljZWNhbmRpZGF0ZXMpIF90aGlzLl9pY2VjYW5kaWRhdGVzID0gW107Ci8vCi8vICAgX3RoaXMuX2ljZWNhbmRpZGF0ZXMucHVzaCh2YWx1ZSk7Ci8vCi8vICAgY29uc29sZS5sb2coX3RoaXMuX2ljZWNhbmRpZGF0ZXMpOwovLyB9Ci8vCi8vIGdldCBpY2VDYW5kaWRhdGVzKCkgewovLyAgIGxldCBfdGhpcyA9IHRoaXM7Ci8vICAgcmV0dXJuIF90aGlzLl9pY2VjYW5kaWRhdGVzOwovLyB9Cgo7CgpleHBvcnRzWydkZWZhdWx0J10gPSBQZWVyOwptb2R1bGUuZXhwb3J0cyA9IGV4cG9ydHNbJ2RlZmF1bHQnXTsKCn0se31dLDc6W2Z1bmN0aW9uKHJlcXVpcmUsbW9kdWxlLGV4cG9ydHMpewondXNlIHN0cmljdCc7CgpPYmplY3QuZGVmaW5lUHJvcGVydHkoZXhwb3J0cywgJ19fZXNNb2R1bGUnLCB7CiAgdmFsdWU6IHRydWUKfSk7Cgp2YXIgX2NyZWF0ZUNsYXNzID0gKGZ1bmN0aW9uICgpIHsgZnVuY3Rpb24gZGVmaW5lUHJvcGVydGllcyh0YXJnZXQsIHByb3BzKSB7IGZvciAodmFyIGkgPSAwOyBpIDwgcHJvcHMubGVuZ3RoOyBpKyspIHsgdmFyIGRlc2NyaXB0b3IgPSBwcm9wc1tpXTsgZGVzY3JpcHRvci5lbnVtZXJhYmxlID0gZGVzY3JpcHRvci5lbnVtZXJhYmxlIHx8IGZhbHNlOyBkZXNjcmlwdG9yLmNvbmZpZ3VyYWJsZSA9IHRydWU7IGlmICgndmFsdWUnIGluIGRlc2NyaXB0b3IpIGRlc2NyaXB0b3Iud3JpdGFibGUgPSB0cnVlOyBPYmplY3QuZGVmaW5lUHJvcGVydHkodGFyZ2V0LCBkZXNjcmlwdG9yLmtleSwgZGVzY3JpcHRvcik7IH0gfSByZXR1cm4gZnVuY3Rpb24gKENvbnN0cnVjdG9yLCBwcm90b1Byb3BzLCBzdGF0aWNQcm9wcykgeyBpZiAocHJvdG9Qcm9wcykgZGVmaW5lUHJvcGVydGllcyhDb25zdHJ1Y3Rvci5wcm90b3R5cGUsIHByb3RvUHJvcHMpOyBpZiAoc3RhdGljUHJvcHMpIGRlZmluZVByb3BlcnRpZXMoQ29uc3RydWN0b3IsIHN0YXRpY1Byb3BzKTsgcmV0dXJuIENvbnN0cnVjdG9yOyB9OyB9KSgpOwoKZnVuY3Rpb24gX2ludGVyb3BSZXF1aXJlRGVmYXVsdChvYmopIHsgcmV0dXJuIG9iaiAmJiBvYmouX19lc01vZHVsZSA/IG9iaiA6IHsgJ2RlZmF1bHQnOiBvYmogfTsgfQoKZnVuY3Rpb24gX2NsYXNzQ2FsbENoZWNrKGluc3RhbmNlLCBDb25zdHJ1Y3RvcikgeyBpZiAoIShpbnN0YW5jZSBpbnN0YW5jZW9mIENvbnN0cnVjdG9yKSkgeyB0aHJvdyBuZXcgVHlwZUVycm9yKCdDYW5ub3QgY2FsbCBhIGNsYXNzIGFzIGEgZnVuY3Rpb24nKTsgfSB9Cgp2YXIgX1N5bmNPYmplY3QgPSByZXF1aXJlKCcuL1N5bmNPYmplY3QnKTsKCnZhciBfU3luY09iamVjdDIgPSBfaW50ZXJvcFJlcXVpcmVEZWZhdWx0KF9TeW5jT2JqZWN0KTsKCnZhciBfRGF0YU9iamVjdENoaWxkID0gcmVxdWlyZSgnLi9EYXRhT2JqZWN0Q2hpbGQnKTsKCnZhciBfRGF0YU9iamVjdENoaWxkMiA9IF9pbnRlcm9wUmVxdWlyZURlZmF1bHQoX0RhdGFPYmplY3RDaGlsZCk7Cgp2YXIgRGF0YU9iamVjdCA9IChmdW5jdGlvbiAoKSB7CiAgLyogcHJpdmF0ZQogIF92ZXJzaW9uOiBudW1iZXIKICAgX293bmVyOiBIeXBlcnR5VVJMCiAgX3VybDogT2JqZWN0VVJMCiAgX3NjaGVtYTogU2NoZW1hCiAgX2J1czogTWluaUJ1cwogIF9zdGF0dXM6IG9uIHwgcGF1c2VkCiAgX3N5bmNPYmo6IFN5bmNEYXRhCiAgIF9jaGlsZHJlbjogeyBpZDogRGF0YU9iamVjdENoaWxkIH0KICAgLS0tLWV2ZW50IGhhbmRsZXJzLS0tLQogIF9vbkFkZENoaWxkcmVuSGFuZGxlcjogKGV2ZW50KSA9PiB2b2lkCiAgKi8KCiAgLyoqCiAgICogQGlnbm9yZQogICAqIFNob3VsZCBub3QgYmUgdXNlZCBkaXJlY3RseSBieSBIeXBlcnRpZXMuIEl0J3MgY2FsbGVkIGJ5IHRoZSBTeW5jaGVyIGNyZWF0ZSBvciBzdWJzY3JpYmUgbWV0aG9kJ3MKICAgKi8KCiAgZnVuY3Rpb24gRGF0YU9iamVjdChvd25lciwgdXJsLCBzY2hlbWEsIGJ1cywgaW5pdGlhbFN0YXR1cywgaW5pdGlhbERhdGEsIGNoaWxkcmVuKSB7CiAgICB2YXIgX3RoaXMyID0gdGhpczsKCiAgICBfY2xhc3NDYWxsQ2hlY2sodGhpcywgRGF0YU9iamVjdCk7CgogICAgdmFyIF90aGlzID0gdGhpczsKCiAgICBfdGhpcy5fdmVyc2lvbiA9IDA7CgogICAgX3RoaXMuX293bmVyID0gb3duZXI7CiAgICBfdGhpcy5fdXJsID0gdXJsOwogICAgX3RoaXMuX3NjaGVtYSA9IHNjaGVtYTsKICAgIF90aGlzLl9idXMgPSBidXM7CiAgICBfdGhpcy5fc3RhdHVzID0gaW5pdGlhbFN0YXR1czsKICAgIF90aGlzLl9zeW5jT2JqID0gbmV3IF9TeW5jT2JqZWN0MlsnZGVmYXVsdCddKGluaXRpYWxEYXRhKTsKCiAgICBfdGhpcy5fY2hpbGRJZCA9IDA7CiAgICBfdGhpcy5fY2hpbGRyZW4gPSB7fTsKCiAgICB2YXIgY2hpbGRCYXNlVVJMID0gdXJsICsgJy9jaGlsZHJlbi8nOwoKICAgIGlmIChjaGlsZHJlbikgewogICAgICBjaGlsZHJlbi5mb3JFYWNoKGZ1bmN0aW9uIChjaGlsZCkgewogICAgICAgIHZhciBjaGlsZFVSTCA9IGNoaWxkQmFzZVVSTCArIGNoaWxkOwogICAgICAgIGJ1cy5hZGRMaXN0ZW5lcihjaGlsZFVSTCwgZnVuY3Rpb24gKG1zZykgewogICAgICAgICAgLy9pZ25vcmUgbXNnIHNlbnQgYnkgaGltc2VsZgogICAgICAgICAgaWYgKG1zZy5mcm9tICE9PSBfdGhpczIuX293bmVyKSB7CiAgICAgICAgICAgIHN3aXRjaCAobXNnLnR5cGUpIHsKICAgICAgICAgICAgICBjYXNlICdjcmVhdGUnOgogICAgICAgICAgICAgICAgX3RoaXMuX29uQ2hpbGRyZW5DcmVhdGUobXNnKTticmVhazsKICAgICAgICAgICAgICBjYXNlICdkZWxldGUnOgogICAgICAgICAgICAgICAgY29uc29sZS5sb2cobXNnKTticmVhazsKICAgICAgICAgICAgICBkZWZhdWx0OgogICAgICAgICAgICAgICAgX3RoaXMuX2NoYW5nZUNoaWxkcmVuKG1zZyk7YnJlYWs7CiAgICAgICAgICAgIH0KICAgICAgICAgIH0KICAgICAgICB9KTsKICAgICAgfSk7CiAgICB9CiAgfQoKICAvKioKICAgKiBPYmplY3QgVVJMIG9mIHJlcG9ydGVyIG9yIG9ic2VydmVyCiAgICogQHR5cGUge09iamVjdFVSTH0KICAgKi8KCiAgX2NyZWF0ZUNsYXNzKERhdGFPYmplY3QsIFt7CiAgICBrZXk6ICdwYXVzZScsCgogICAgLyoqCiAgICAgKiBAaWdub3JlCiAgICAgKi8KICAgIHZhbHVlOiBmdW5jdGlvbiBwYXVzZSgpIHsKICAgICAgLy9UT0RPOiB0aGlzIGZlYXR1cmUgbmVlZHMgbW9yZSBhbmFsaXNlCiAgICAgIHRocm93ICdOb3QgaW1wbGVtZW50ZWQnOwogICAgfQoKICAgIC8qKgogICAgICogQGlnbm9yZQogICAgICovCiAgfSwgewogICAga2V5OiAncmVzdW1lJywKICAgIHZhbHVlOiBmdW5jdGlvbiByZXN1bWUoKSB7CiAgICAgIC8vVE9ETzogdGhpcyBmZWF0dXJlIG5lZWRzIG1vcmUgYW5hbGlzZQogICAgICB0aHJvdyAnTm90IGltcGxlbWVudGVkJzsKICAgIH0KCiAgICAvKioKICAgICAqIEBpZ25vcmUKICAgICAqLwogIH0sIHsKICAgIGtleTogJ3N0b3AnLAogICAgdmFsdWU6IGZ1bmN0aW9uIHN0b3AoKSB7CiAgICAgIC8vVE9ETzogc2hvdWxkIHJlbW92ZSB0aGUgc3Vic2NyaXB0aW9uIGFuZCBzZW5kIG1lc3NhZ2UgdW5zdWJzY3JpYmU/CiAgICAgIHRocm93ICdOb3QgaW1wbGVtZW50ZWQnOwogICAgfQoKICAgIC8qKgogICAgICogQGlnbm9yZQogICAgICovCiAgfSwgewogICAga2V5OiAncmVsZWFzZScsCiAgICB2YWx1ZTogZnVuY3Rpb24gcmVsZWFzZSgpIHt9CiAgICAvL1RPRE86IHJlbW92ZSBhbGwgbGlzdGVuZXJzIGZvciB0aGlzIG9iamVjdAoKICAgIC8qKgogICAgICogQ3JlYXRlIGFuZCBhZGQgYSBjaGlsZHJlbiB0byB0aGUgc3Vic2NyaXB0aW9uIGdyb3VwLgogICAgICogQHBhcmFtIHtTdHJpbmd9IHJlc291cmNlIC0gUmVzb3VyY2UgbmFtZSwgb25lIG9mIHRoZSBpdGVtcyBpbiB0aGUgc2NoZW1hLnByb3BlcnRpZXMuc2NoZW1lIG9mIHRoZSBwYXJlbnQgb2JqZWN0LgogICAgICogQHBhcmFtIHtKU09OfSBpbml0aWFsRGF0YSAtIEluaXRpYWwgZGF0YSBvZiB0aGUgY2hpbGQKICAgICAqIEByZXR1cm4ge1Byb21pc2U8RGF0YU9iamVjdENoaWxkPn0gLSBSZXR1cm4gUHJvbWlzZSB0byBhIG5ldyBDaGlsZHJlbi4KICAgICAqLwoKICB9LCB7CiAgICBrZXk6ICdhZGRDaGlsZHJlbicsCiAgICB2YWx1ZTogZnVuY3Rpb24gYWRkQ2hpbGRyZW4ocmVzb3VyY2UsIGluaXRpYWxEYXRhKSB7CiAgICAgIHZhciBfdGhpcyA9IHRoaXM7CgogICAgICAvL2NyZWF0ZSBuZXcgY2hpbGQgdW5pcXVlIElELCBiYXNlZCBvbiBoeXBlcnR5VVJMCiAgICAgIF90aGlzLl9jaGlsZElkKys7CiAgICAgIHZhciBtc2dDaGlsZElkID0gX3RoaXMuX293bmVyICsgJyMnICsgX3RoaXMuX2NoaWxkSWQ7CiAgICAgIHZhciBtc2dDaGlsZFBhdGggPSBfdGhpcy5fdXJsICsgJy9jaGlsZHJlbi8nICsgcmVzb3VyY2U7CgogICAgICB2YXIgcmVxdWVzdE1zZyA9IHsKICAgICAgICB0eXBlOiAnY3JlYXRlJywgZnJvbTogX3RoaXMuX293bmVyLCB0bzogbXNnQ2hpbGRQYXRoLAogICAgICAgIGJvZHk6IHsgcmVzb3VyY2U6IG1zZ0NoaWxkSWQsIHZhbHVlOiBpbml0aWFsRGF0YSB9CiAgICAgIH07CgogICAgICAvL3JldHVybnMgcHJvbWlzZSwgaW4gdGhlIGZ1dHVyZSwgdGhlIEFQSSBtYXkgY2hhbmdlIHRvIGFzeW5jaHJvbm91cyBjYWxsCiAgICAgIHJldHVybiBuZXcgUHJvbWlzZShmdW5jdGlvbiAocmVzb2x2ZSkgewogICAgICAgIHZhciBtc2dJZCA9IF90aGlzLl9idXMucG9zdE1lc3NhZ2UocmVxdWVzdE1zZyk7CgogICAgICAgIGNvbnNvbGUubG9nKCdjcmVhdGUtcmVwb3J0ZXItY2hpbGQoICcgKyBfdGhpcy5fb3duZXIgKyAnICk6ICcsIHJlcXVlc3RNc2cpOwogICAgICAgIHZhciBuZXdDaGlsZCA9IG5ldyBfRGF0YU9iamVjdENoaWxkMlsnZGVmYXVsdCddKF90aGlzLl9vd25lciwgbXNnQ2hpbGRJZCwgbXNnSWQsIF90aGlzLl9idXMsIGluaXRpYWxEYXRhKTsKICAgICAgICBuZXdDaGlsZC5vbkNoYW5nZShmdW5jdGlvbiAoZXZlbnQpIHsKICAgICAgICAgIF90aGlzLl9vbkNoYW5nZShldmVudCwgeyBwYXRoOiBtc2dDaGlsZFBhdGgsIGNoaWxkSWQ6IG1zZ0NoaWxkSWQgfSk7CiAgICAgICAgfSk7CgogICAgICAgIF90aGlzLl9jaGlsZHJlblttc2dDaGlsZElkXSA9IG5ld0NoaWxkOwoKICAgICAgICByZXNvbHZlKG5ld0NoaWxkKTsKICAgICAgfSk7CiAgICB9CgogICAgLyoqCiAgICAgKiBTZXR1cCB0aGUgY2FsbGJhY2sgdG8gcHJvY2VzcyBjcmVhdGUgYW5kIGRlbGV0ZSBjaGlsZHJlbnMKICAgICAqIEBwYXJhbSB7ZnVuY3Rpb24oZXZlbnQ6IE1zZ0V2ZW50KX0gY2FsbGJhY2sKICAgICAqLwogIH0sIHsKICAgIGtleTogJ29uQWRkQ2hpbGRyZW4nLAogICAgdmFsdWU6IGZ1bmN0aW9uIG9uQWRkQ2hpbGRyZW4oY2FsbGJhY2spIHsKICAgICAgdGhpcy5fb25BZGRDaGlsZHJlbkhhbmRsZXIgPSBjYWxsYmFjazsKICAgIH0KICB9LCB7CiAgICBrZXk6ICdfb25DaGlsZHJlbkNyZWF0ZScsCiAgICB2YWx1ZTogZnVuY3Rpb24gX29uQ2hpbGRyZW5DcmVhdGUobXNnKSB7CiAgICAgIHZhciBfdGhpcyA9IHRoaXM7CiAgICAgIHZhciBtc2dDaGlsZElkID0gbXNnLmJvZHkucmVzb3VyY2U7CgogICAgICBjb25zb2xlLmxvZygnY3JlYXRlLW9ic2VydmVyLWNoaWxkKCAnICsgX3RoaXMuX293bmVyICsgJyApOiAnLCBtc2cpOwogICAgICB2YXIgbmV3Q2hpbGQgPSBuZXcgX0RhdGFPYmplY3RDaGlsZDJbJ2RlZmF1bHQnXShtc2cuZnJvbSwgbXNnQ2hpbGRJZCwgMCwgX3RoaXMuX2J1cywgbXNnLmJvZHkudmFsdWUpOwogICAgICBfdGhpcy5fY2hpbGRyZW5bbXNnQ2hpbGRJZF0gPSBuZXdDaGlsZDsKCiAgICAgIHNldFRpbWVvdXQoZnVuY3Rpb24gKCkgewogICAgICAgIF90aGlzLl9idXMucG9zdE1lc3NhZ2UoewogICAgICAgICAgaWQ6IG1zZy5pZCwgdHlwZTogJ3Jlc3BvbnNlJywgZnJvbTogbXNnLnRvLCB0bzogbXNnLmZyb20sCiAgICAgICAgICBib2R5OiB7IGNvZGU6IDIwMCwgc291cmNlOiBfdGhpcy5fb3duZXIgfQogICAgICAgIH0pOwogICAgICB9KTsKCiAgICAgIHZhciBldmVudCA9IHsKICAgICAgICB0eXBlOiBtc2cudHlwZSwKICAgICAgICBmcm9tOiBtc2cuZnJvbSwKICAgICAgICB1cmw6IG1zZy50bywKICAgICAgICB2YWx1ZTogbXNnLmJvZHkudmFsdWUsCiAgICAgICAgY2hpbGRJZDogbXNnQ2hpbGRJZAogICAgICB9OwoKICAgICAgaWYgKF90aGlzLl9vbkFkZENoaWxkcmVuSGFuZGxlcikgewogICAgICAgIF90aGlzLl9vbkFkZENoaWxkcmVuSGFuZGxlcihldmVudCk7CiAgICAgIH0KICAgIH0KCiAgICAvL3NlbmQgZGVsdGEgbWVzc2FnZXMgdG8gc3Vic2NyaXB0aW9ucwogIH0sIHsKICAgIGtleTogJ19vbkNoYW5nZScsCiAgICB2YWx1ZTogZnVuY3Rpb24gX29uQ2hhbmdlKGV2ZW50LCBjaGlsZEluZm8pIHsKICAgICAgdmFyIF90aGlzID0gdGhpczsKCiAgICAgIF90aGlzLl92ZXJzaW9uKys7CgogICAgICBpZiAoX3RoaXMuX3N0YXR1cyA9PT0gJ29uJykgewogICAgICAgIHZhciBjaGFuZ2VNc2cgPSB7CiAgICAgICAgICB0eXBlOiBldmVudC5jVHlwZSwgZnJvbTogX3RoaXMuX293bmVyLCB0bzogX3RoaXMuX3VybCwKICAgICAgICAgIGJvZHk6IHsgdmVyc2lvbjogX3RoaXMuX3ZlcnNpb24sIG9UeXBlOiBldmVudC5vVHlwZSwgYXR0cmliOiBldmVudC5maWVsZCwgdmFsdWU6IGV2ZW50LmRhdGEgfQogICAgICAgIH07CgogICAgICAgIC8vY2hpbGRJbmZvIG11c3QgaGF2ZSAocGF0aCwgY2hpbGRJZCkKICAgICAgICBpZiAoY2hpbGRJbmZvKSB7CiAgICAgICAgICBjaGFuZ2VNc2cudG8gPSBjaGlsZEluZm8ucGF0aDsKICAgICAgICAgIGNoYW5nZU1zZy5ib2R5LmNoaWxkSWQgPSBjaGlsZEluZm8uY2hpbGRJZDsKICAgICAgICB9CgogICAgICAgIF90aGlzLl9idXMucG9zdE1lc3NhZ2UoY2hhbmdlTXNnKTsKICAgICAgfQogICAgfQoKICAgIC8vcmVjZWl2ZSBhbmQgcHJvY2VzcyBkZWx0YSBtZXNzYWdlcwogIH0sIHsKICAgIGtleTogJ19jaGFuZ2VPYmplY3QnLAogICAgdmFsdWU6IGZ1bmN0aW9uIF9jaGFuZ2VPYmplY3Qoc3luY09iaiwgbXNnKSB7CiAgICAgIHZhciBfdGhpcyA9IHRoaXM7CgogICAgICAvL1RPRE86IHVwZGF0ZSB2ZXJzaW9uID8KICAgICAgLy9ob3cgdG8gaGFuZGxlIGFuIGluY29ycmVjdCB2ZXJzaW9uID8gRXhhbXBsZTogcmVjZWl2ZSBhIHZlcnNpb24gMyB3aGVuIHRoZSBvYnNlcnZlciBpcyBpbiB2ZXJzaW9uIDEsIHdoZXJlIGlzIHRoZSB2ZXJzaW9uIDIgPwogICAgICAvL3dpbGwgd2UgbmVlZCB0byBjb25maXJtIHRoZSByZWNlcHRpb24gPwogICAgICBpZiAoX3RoaXMuX3ZlcnNpb24gKyAxID09PSBtc2cuYm9keS52ZXJzaW9uKSB7CiAgICAgICAgX3RoaXMuX3ZlcnNpb24rKzsKICAgICAgICB2YXIgcGF0aCA9IG1zZy5ib2R5LmF0dHJpYjsKICAgICAgICB2YXIgdmFsdWUgPSBtc2cuYm9keS52YWx1ZTsKICAgICAgICB2YXIgZmluZFJlc3VsdCA9IHN5bmNPYmouZmluZEJlZm9yZShwYXRoKTsKCiAgICAgICAgaWYgKG1zZy50eXBlID09PSBfU3luY09iamVjdC5DaGFuZ2VUeXBlLlVQREFURSkgewogICAgICAgICAgZmluZFJlc3VsdC5vYmpbZmluZFJlc3VsdC5sYXN0XSA9IHZhbHVlOwogICAgICAgIH0gZWxzZSB7CiAgICAgICAgICBpZiAobXNnLnR5cGUgPT09IF9TeW5jT2JqZWN0LkNoYW5nZVR5cGUuQUREKSB7CiAgICAgICAgICAgIGlmIChtc2cuYm9keS5vVHlwZSA9PT0gX1N5bmNPYmplY3QuT2JqZWN0VHlwZS5PQkpFQ1QpIHsKICAgICAgICAgICAgICBmaW5kUmVzdWx0Lm9ialtmaW5kUmVzdWx0Lmxhc3RdID0gdmFsdWU7CiAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgLy9BUlJBWQogICAgICAgICAgICAgIHZhciBhcnIgPSBmaW5kUmVzdWx0Lm9iajsKICAgICAgICAgICAgICB2YXIgaW5kZXggPSBmaW5kUmVzdWx0Lmxhc3Q7CiAgICAgICAgICAgICAgQXJyYXkucHJvdG90eXBlLnNwbGljZS5hcHBseShhcnIsIFtpbmRleCwgMF0uY29uY2F0KHZhbHVlKSk7CiAgICAgICAgICAgIH0KICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgIC8vUkVNT1ZFCiAgICAgICAgICAgIGlmIChtc2cuYm9keS5vVHlwZSA9PT0gX1N5bmNPYmplY3QuT2JqZWN0VHlwZS5PQkpFQ1QpIHsKICAgICAgICAgICAgICBkZWxldGUgZmluZFJlc3VsdC5vYmpbZmluZFJlc3VsdC5sYXN0XTsKICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAvL0FSUkFZCiAgICAgICAgICAgICAgdmFyIGFyciA9IGZpbmRSZXN1bHQub2JqOwogICAgICAgICAgICAgIHZhciBpbmRleCA9IGZpbmRSZXN1bHQubGFzdDsKICAgICAgICAgICAgICBhcnIuc3BsaWNlKGluZGV4LCB2YWx1ZSk7CiAgICAgICAgICAgIH0KICAgICAgICAgIH0KICAgICAgICB9CiAgICAgIH0gZWxzZSB7CiAgICAgICAgLy9UT0RPOiBob3cgdG8gaGFuZGxlIHVuc3luY2hyb25pemVkIHZlcnNpb25zPwogICAgICAgIGNvbnNvbGUubG9nKCd1bnN5bmNocm9uaXplZCB2ZXJzaW9ucycpOwogICAgICB9CiAgICB9CiAgfSwgewogICAga2V5OiAnX2NoYW5nZUNoaWxkcmVuJywKICAgIHZhbHVlOiBmdW5jdGlvbiBfY2hhbmdlQ2hpbGRyZW4obXNnKSB7CiAgICAgIHZhciBfdGhpcyA9IHRoaXM7CiAgICAgIGNvbnNvbGUubG9nKCdDaGFuZ2UgY2hpbGRyZW46ICcsIF90aGlzLl9vd25lciwgbXNnKTsKCiAgICAgIHZhciBjaGlsZElkID0gbXNnLmJvZHkuY2hpbGRJZDsKICAgICAgdmFyIGNoaWxkcmVuID0gX3RoaXMuX2NoaWxkcmVuW2NoaWxkSWRdOwoKICAgICAgaWYgKGNoaWxkcmVuKSB7CiAgICAgICAgX3RoaXMuX2NoYW5nZU9iamVjdChjaGlsZHJlbiwgbXNnKTsKICAgICAgfSBlbHNlIHsKICAgICAgICBjb25zb2xlLmxvZygnTm8gY2hpbGRyZW4gZm91bmQgZm9yOiAnLCBjaGlsZElkKTsKICAgICAgfQogICAgfQogIH0sIHsKICAgIGtleTogJ3VybCcsCiAgICBnZXQ6IGZ1bmN0aW9uIGdldCgpIHsKICAgICAgcmV0dXJuIHRoaXMuX3VybDsKICAgIH0KCiAgICAvKioKICAgICAqIE9iamVjdCBzY2hlbWEgVVJMICh0aGlzIGZpZWxkIGlzIG5vdCB5ZXQgc3RhYmxlLCBhbmQgaXMgc3Vic2plY3QgdG8gY2hhbmdlKQogICAgICogQHR5cGUge1NjaGVtYVVSTH0KICAgICAqLwogIH0sIHsKICAgIGtleTogJ3NjaGVtYScsCiAgICBnZXQ6IGZ1bmN0aW9uIGdldCgpIHsKICAgICAgcmV0dXJuIHRoaXMuX3NjaGVtYTsKICAgIH0KCiAgICAvKioKICAgICAqIFN0YXR1cyBvZiB0aGUgcmVwb3J0ZXIgb3Igb2JzZXJ2ZXIgY29ubmVjdGlvbiAodGhpcyBmaWVsZCBpcyBub3QgeWV0IHN0YWJsZSwgYW5kIGlzIHN1YnNqZWN0IHRvIGNoYW5nZSkKICAgICAqIEB0eXBlIHtTdGF0dXN9IC0gRW51bSBvZjogb24gfCBwYXVzZWQKICAgICAqLwogIH0sIHsKICAgIGtleTogJ3N0YXR1cycsCiAgICBnZXQ6IGZ1bmN0aW9uIGdldCgpIHsKICAgICAgcmV0dXJuIHRoaXMuX3N0YXR1czsKICAgIH0KCiAgICAvKioKICAgICAqIERhdGEgc3RydWN0dXJlIHRvIGJlIHN5bmNocm9uaXplZC4KICAgICAqIEB0eXBlIHtKU09OfSAtIEpTT04gc3RydWN0dXJlIHRoYXQgc2hvdWxkIGZvbGxvdyB0aGUgZGVmaW5lZCBzY2hlbWEsIGlmIGFueS4KICAgICAqLwogIH0sIHsKICAgIGtleTogJ2RhdGEnLAogICAgZ2V0OiBmdW5jdGlvbiBnZXQoKSB7CiAgICAgIHJldHVybiB0aGlzLl9zeW5jT2JqLmRhdGE7CiAgICB9CgogICAgLyoqCiAgICAgKiBBbGwgY3JlYXRlZCBjaGlsZHJlbidzIHNpbmNlIHRoZSBzdWJzY3JpcHRpb24sIGRvZXNuJ3QgY29udGFpbiBhbGwgY2hpbGRyZW4ncyBzaW5jZSByZXBvcnRlciBjcmVhdGlvbi4KICAgICAqIEB0eXBlIHtPYmplY3Q8Q2hpbGRJZCwgRGF0YU9iamVjdENoaWxkPn0KICAgICAqLwogIH0sIHsKICAgIGtleTogJ2NoaWxkcmVuJywKICAgIGdldDogZnVuY3Rpb24gZ2V0KCkgewogICAgICByZXR1cm4gdGhpcy5fY2hpbGRyZW47CiAgICB9CiAgfV0pOwoKICByZXR1cm4gRGF0YU9iamVjdDsKfSkoKTsKCmV4cG9ydHNbJ2RlZmF1bHQnXSA9IERhdGFPYmplY3Q7Cm1vZHVsZS5leHBvcnRzID0gZXhwb3J0c1snZGVmYXVsdCddOwoKfSx7Ii4vRGF0YU9iamVjdENoaWxkIjo4LCIuL1N5bmNPYmplY3QiOjEyfV0sODpbZnVuY3Rpb24ocmVxdWlyZSxtb2R1bGUsZXhwb3J0cyl7Cid1c2Ugc3RyaWN0JzsKCk9iamVjdC5kZWZpbmVQcm9wZXJ0eShleHBvcnRzLCAnX19lc01vZHVsZScsIHsKICB2YWx1ZTogdHJ1ZQp9KTsKCnZhciBfY3JlYXRlQ2xhc3MgPSAoZnVuY3Rpb24gKCkgeyBmdW5jdGlvbiBkZWZpbmVQcm9wZXJ0aWVzKHRhcmdldCwgcHJvcHMpIHsgZm9yICh2YXIgaSA9IDA7IGkgPCBwcm9wcy5sZW5ndGg7IGkrKykgeyB2YXIgZGVzY3JpcHRvciA9IHByb3BzW2ldOyBkZXNjcmlwdG9yLmVudW1lcmFibGUgPSBkZXNjcmlwdG9yLmVudW1lcmFibGUgfHwgZmFsc2U7IGRlc2NyaXB0b3IuY29uZmlndXJhYmxlID0gdHJ1ZTsgaWYgKCd2YWx1ZScgaW4gZGVzY3JpcHRvcikgZGVzY3JpcHRvci53cml0YWJsZSA9IHRydWU7IE9iamVjdC5kZWZpbmVQcm9wZXJ0eSh0YXJnZXQsIGRlc2NyaXB0b3Iua2V5LCBkZXNjcmlwdG9yKTsgfSB9IHJldHVybiBmdW5jdGlvbiAoQ29uc3RydWN0b3IsIHByb3RvUHJvcHMsIHN0YXRpY1Byb3BzKSB7IGlmIChwcm90b1Byb3BzKSBkZWZpbmVQcm9wZXJ0aWVzKENvbnN0cnVjdG9yLnByb3RvdHlwZSwgcHJvdG9Qcm9wcyk7IGlmIChzdGF0aWNQcm9wcykgZGVmaW5lUHJvcGVydGllcyhDb25zdHJ1Y3Rvciwgc3RhdGljUHJvcHMpOyByZXR1cm4gQ29uc3RydWN0b3I7IH07IH0pKCk7CgpmdW5jdGlvbiBfaW50ZXJvcFJlcXVpcmVEZWZhdWx0KG9iaikgeyByZXR1cm4gb2JqICYmIG9iai5fX2VzTW9kdWxlID8gb2JqIDogeyAnZGVmYXVsdCc6IG9iaiB9OyB9CgpmdW5jdGlvbiBfY2xhc3NDYWxsQ2hlY2soaW5zdGFuY2UsIENvbnN0cnVjdG9yKSB7IGlmICghKGluc3RhbmNlIGluc3RhbmNlb2YgQ29uc3RydWN0b3IpKSB7IHRocm93IG5ldyBUeXBlRXJyb3IoJ0Nhbm5vdCBjYWxsIGEgY2xhc3MgYXMgYSBmdW5jdGlvbicpOyB9IH0KCnZhciBfU3luY09iamVjdCA9IHJlcXVpcmUoJy4vU3luY09iamVjdCcpOwoKdmFyIF9TeW5jT2JqZWN0MiA9IF9pbnRlcm9wUmVxdWlyZURlZmF1bHQoX1N5bmNPYmplY3QpOwoKdmFyIERhdGFPYmplY3RDaGlsZCAvKiBpbXBsZW1lbnRzIFN5bmNTdGF0dXMgKi8gPSAoZnVuY3Rpb24gKCkgewogIC8qIHByaXZhdGUKICAgLS0tLWV2ZW50IGhhbmRsZXJzLS0tLQogIF9vblJlc3BvbnNlSGFuZGxlcjogKGV2ZW50KSA9PiB2b2lkCiAgKi8KCiAgLyoqCiAgICogQGlnbm9yZQogICAqIFNob3VsZCBub3QgYmUgdXNlZCBkaXJlY3RseSBieSBIeXBlcnRpZXMuIEl0J3MgY2FsbGVkIGJ5IHRoZSBEYXRhT2JqZWN0LmFkZENoaWxkcmVuCiAgICovCgogIGZ1bmN0aW9uIERhdGFPYmplY3RDaGlsZChvd25lciwgY2hpbGRJZCwgbXNnSWQsIGJ1cywgaW5pdGlhbERhdGEpIHsKICAgIF9jbGFzc0NhbGxDaGVjayh0aGlzLCBEYXRhT2JqZWN0Q2hpbGQpOwoKICAgIHZhciBfdGhpcyA9IHRoaXM7CgogICAgX3RoaXMuX293bmVyID0gb3duZXI7CiAgICBfdGhpcy5fY2hpbGRJZCA9IGNoaWxkSWQ7CiAgICBfdGhpcy5fYnVzID0gYnVzOwogICAgX3RoaXMuX3N5bmNPYmogPSBuZXcgX1N5bmNPYmplY3QyWydkZWZhdWx0J10oaW5pdGlhbERhdGEpOwoKICAgIGJ1cy5hZGRMaXN0ZW5lcihvd25lciwgZnVuY3Rpb24gKG1zZykgewogICAgICBpZiAobXNnLnR5cGUgPT09ICdyZXNwb25zZScgJiYgbXNnLmlkID09PSBtc2dJZCkgewogICAgICAgIGNvbnNvbGUubG9nKCdEYXRhT2JqZWN0Q2hpbGQub25SZXNwb25zZTonLCBtc2cpOwogICAgICAgIF90aGlzLl9vblJlc3BvbnNlKG1zZyk7CiAgICAgIH0KICAgIH0pOwogIH0KCiAgLyoqCiAgICogQ2hpbGRyZW4gSUQgZ2VuZXJhdGVkIG9uIGFkZENoaWxkcmVuLiBVbmlxdWUgaWRlbnRpZmllcgogICAqIEB0eXBlIHtVUkx9IC0gVVJMIG9mIHRoZSBmb3JtYXQgPEh5cGVydHlVUkw+IzxudW1lcmljLXNlcXVlbmNlPgogICAqLwoKICBfY3JlYXRlQ2xhc3MoRGF0YU9iamVjdENoaWxkLCBbewogICAga2V5OiAnb25DaGFuZ2UnLAoKICAgIC8qKgogICAgICogUmVnaXN0ZXIgdGhlIGNoYW5nZSBsaXN0ZW5lcnMgc2VudCBieSB0aGUgcmVwb3J0ZXIgY2hpbGQKICAgICAqIEBwYXJhbSB7ZnVuY3Rpb24oZXZlbnQ6IE1zZ0V2ZW50KX0gY2FsbGJhY2sKICAgICAqLwogICAgdmFsdWU6IGZ1bmN0aW9uIG9uQ2hhbmdlKGNhbGxiYWNrKSB7CiAgICAgIHRoaXMuX3N5bmNPYmoub2JzZXJ2ZShmdW5jdGlvbiAoZXZlbnQpIHsKICAgICAgICBjYWxsYmFjayhldmVudCk7CiAgICAgIH0pOwogICAgfQoKICAgIC8qKgogICAgICogU2V0dXAgdGhlIGNhbGxiYWNrIHRvIHByb2Nlc3MgcmVzcG9uc2Ugbm90aWZpY2F0aW9ucyBvZiB0aGUgY3JlYXRlcwogICAgICogQHBhcmFtIHtmdW5jdGlvbihldmVudDogTXNnRXZlbnQpfSBjYWxsYmFjawogICAgICovCiAgfSwgewogICAga2V5OiAnb25SZXNwb25zZScsCiAgICB2YWx1ZTogZnVuY3Rpb24gb25SZXNwb25zZShjYWxsYmFjaykgewogICAgICB0aGlzLl9vblJlc3BvbnNlSGFuZGxlciA9IGNhbGxiYWNrOwogICAgfQogIH0sIHsKICAgIGtleTogJ19vblJlc3BvbnNlJywKICAgIHZhbHVlOiBmdW5jdGlvbiBfb25SZXNwb25zZShtc2cpIHsKICAgICAgdmFyIF90aGlzID0gdGhpczsKCiAgICAgIHZhciBldmVudCA9IHsKICAgICAgICB0eXBlOiBtc2cudHlwZSwKICAgICAgICB1cmw6IG1zZy5ib2R5LnNvdXJjZSwKICAgICAgICBjb2RlOiBtc2cuYm9keS5jb2RlCiAgICAgIH07CgogICAgICBpZiAoX3RoaXMuX29uUmVzcG9uc2VIYW5kbGVyKSB7CiAgICAgICAgX3RoaXMuX29uUmVzcG9uc2VIYW5kbGVyKGV2ZW50KTsKICAgICAgfQogICAgfQogIH0sIHsKICAgIGtleTogJ2NoaWxkSWQnLAogICAgZ2V0OiBmdW5jdGlvbiBnZXQoKSB7CiAgICAgIHJldHVybiB0aGlzLl9jaGlsZElkOwogICAgfQoKICAgIC8qKgogICAgICogRGF0YSBTdHJ1Y3R1cmUgdG8gYmUgc3luY2hyb25pemVkLgogICAgICogQHR5cGUge0pTT059IC0gSlNPTiBzdHJ1Y3R1cmUgdGhhdCBzaG91bGQgZm9sbG93IHRoZSBkZWZpbmVkIHNjaGVtYSwgaWYgYW55LgogICAgICovCiAgfSwgewogICAga2V5OiAnZGF0YScsCiAgICBnZXQ6IGZ1bmN0aW9uIGdldCgpIHsKICAgICAgcmV0dXJuIHRoaXMuX3N5bmNPYmouZGF0YTsKICAgIH0KICB9XSk7CgogIHJldHVybiBEYXRhT2JqZWN0Q2hpbGQ7Cn0pKCk7CgpleHBvcnRzWydkZWZhdWx0J10gPSBEYXRhT2JqZWN0Q2hpbGQ7Cm1vZHVsZS5leHBvcnRzID0gZXhwb3J0c1snZGVmYXVsdCddOwoKfSx7Ii4vU3luY09iamVjdCI6MTJ9XSw5OltmdW5jdGlvbihyZXF1aXJlLG1vZHVsZSxleHBvcnRzKXsKJ3VzZSBzdHJpY3QnOwoKT2JqZWN0LmRlZmluZVByb3BlcnR5KGV4cG9ydHMsICdfX2VzTW9kdWxlJywgewogIHZhbHVlOiB0cnVlCn0pOwoKdmFyIF9jcmVhdGVDbGFzcyA9IChmdW5jdGlvbiAoKSB7IGZ1bmN0aW9uIGRlZmluZVByb3BlcnRpZXModGFyZ2V0LCBwcm9wcykgeyBmb3IgKHZhciBpID0gMDsgaSA8IHByb3BzLmxlbmd0aDsgaSsrKSB7IHZhciBkZXNjcmlwdG9yID0gcHJvcHNbaV07IGRlc2NyaXB0b3IuZW51bWVyYWJsZSA9IGRlc2NyaXB0b3IuZW51bWVyYWJsZSB8fCBmYWxzZTsgZGVzY3JpcHRvci5jb25maWd1cmFibGUgPSB0cnVlOyBpZiAoJ3ZhbHVlJyBpbiBkZXNjcmlwdG9yKSBkZXNjcmlwdG9yLndyaXRhYmxlID0gdHJ1ZTsgT2JqZWN0LmRlZmluZVByb3BlcnR5KHRhcmdldCwgZGVzY3JpcHRvci5rZXksIGRlc2NyaXB0b3IpOyB9IH0gcmV0dXJuIGZ1bmN0aW9uIChDb25zdHJ1Y3RvciwgcHJvdG9Qcm9wcywgc3RhdGljUHJvcHMpIHsgaWYgKHByb3RvUHJvcHMpIGRlZmluZVByb3BlcnRpZXMoQ29uc3RydWN0b3IucHJvdG90eXBlLCBwcm90b1Byb3BzKTsgaWYgKHN0YXRpY1Byb3BzKSBkZWZpbmVQcm9wZXJ0aWVzKENvbnN0cnVjdG9yLCBzdGF0aWNQcm9wcyk7IHJldHVybiBDb25zdHJ1Y3RvcjsgfTsgfSkoKTsKCnZhciBfZ2V0ID0gZnVuY3Rpb24gZ2V0KF94LCBfeDIsIF94MykgeyB2YXIgX2FnYWluID0gdHJ1ZTsgX2Z1bmN0aW9uOiB3aGlsZSAoX2FnYWluKSB7IHZhciBvYmplY3QgPSBfeCwgcHJvcGVydHkgPSBfeDIsIHJlY2VpdmVyID0gX3gzOyBfYWdhaW4gPSBmYWxzZTsgaWYgKG9iamVjdCA9PT0gbnVsbCkgb2JqZWN0ID0gRnVuY3Rpb24ucHJvdG90eXBlOyB2YXIgZGVzYyA9IE9iamVjdC5nZXRPd25Qcm9wZXJ0eURlc2NyaXB0b3Iob2JqZWN0LCBwcm9wZXJ0eSk7IGlmIChkZXNjID09PSB1bmRlZmluZWQpIHsgdmFyIHBhcmVudCA9IE9iamVjdC5nZXRQcm90b3R5cGVPZihvYmplY3QpOyBpZiAocGFyZW50ID09PSBudWxsKSB7IHJldHVybiB1bmRlZmluZWQ7IH0gZWxzZSB7IF94ID0gcGFyZW50OyBfeDIgPSBwcm9wZXJ0eTsgX3gzID0gcmVjZWl2ZXI7IF9hZ2FpbiA9IHRydWU7IGRlc2MgPSBwYXJlbnQgPSB1bmRlZmluZWQ7IGNvbnRpbnVlIF9mdW5jdGlvbjsgfSB9IGVsc2UgaWYgKCd2YWx1ZScgaW4gZGVzYykgeyByZXR1cm4gZGVzYy52YWx1ZTsgfSBlbHNlIHsgdmFyIGdldHRlciA9IGRlc2MuZ2V0OyBpZiAoZ2V0dGVyID09PSB1bmRlZmluZWQpIHsgcmV0dXJuIHVuZGVmaW5lZDsgfSByZXR1cm4gZ2V0dGVyLmNhbGwocmVjZWl2ZXIpOyB9IH0gfTsKCmZ1bmN0aW9uIF9pbnRlcm9wUmVxdWlyZURlZmF1bHQob2JqKSB7IHJldHVybiBvYmogJiYgb2JqLl9fZXNNb2R1bGUgPyBvYmogOiB7ICdkZWZhdWx0Jzogb2JqIH07IH0KCmZ1bmN0aW9uIF9jbGFzc0NhbGxDaGVjayhpbnN0YW5jZSwgQ29uc3RydWN0b3IpIHsgaWYgKCEoaW5zdGFuY2UgaW5zdGFuY2VvZiBDb25zdHJ1Y3RvcikpIHsgdGhyb3cgbmV3IFR5cGVFcnJvcignQ2Fubm90IGNhbGwgYSBjbGFzcyBhcyBhIGZ1bmN0aW9uJyk7IH0gfQoKZnVuY3Rpb24gX2luaGVyaXRzKHN1YkNsYXNzLCBzdXBlckNsYXNzKSB7IGlmICh0eXBlb2Ygc3VwZXJDbGFzcyAhPT0gJ2Z1bmN0aW9uJyAmJiBzdXBlckNsYXNzICE9PSBudWxsKSB7IHRocm93IG5ldyBUeXBlRXJyb3IoJ1N1cGVyIGV4cHJlc3Npb24gbXVzdCBlaXRoZXIgYmUgbnVsbCBvciBhIGZ1bmN0aW9uLCBub3QgJyArIHR5cGVvZiBzdXBlckNsYXNzKTsgfSBzdWJDbGFzcy5wcm90b3R5cGUgPSBPYmplY3QuY3JlYXRlKHN1cGVyQ2xhc3MgJiYgc3VwZXJDbGFzcy5wcm90b3R5cGUsIHsgY29uc3RydWN0b3I6IHsgdmFsdWU6IHN1YkNsYXNzLCBlbnVtZXJhYmxlOiBmYWxzZSwgd3JpdGFibGU6IHRydWUsIGNvbmZpZ3VyYWJsZTogdHJ1ZSB9IH0pOyBpZiAoc3VwZXJDbGFzcykgT2JqZWN0LnNldFByb3RvdHlwZU9mID8gT2JqZWN0LnNldFByb3RvdHlwZU9mKHN1YkNsYXNzLCBzdXBlckNsYXNzKSA6IHN1YkNsYXNzLl9fcHJvdG9fXyA9IHN1cGVyQ2xhc3M7IH0KCnZhciBfRGF0YU9iamVjdDIgPSByZXF1aXJlKCcuL0RhdGFPYmplY3QnKTsKCnZhciBfRGF0YU9iamVjdDMgPSBfaW50ZXJvcFJlcXVpcmVEZWZhdWx0KF9EYXRhT2JqZWN0Mik7Cgp2YXIgRmlsdGVyVHlwZSA9IHsgQU5ZOiAnYW55JywgU1RBUlQ6ICdzdGFydCcsIEVYQUNUOiAnZXhhY3QnIH07Cgp2YXIgRGF0YU9iamVjdE9ic2VydmVyID0gKGZ1bmN0aW9uIChfRGF0YU9iamVjdCkgewogIF9pbmhlcml0cyhEYXRhT2JqZWN0T2JzZXJ2ZXIsIF9EYXRhT2JqZWN0KTsKCiAgLyogcHJpdmF0ZQogICAtLS0tZXZlbnQgaGFuZGxlcnMtLS0tCiAgX2ZpbHRlcnM6IHs8ZmlsdGVyPjoge3R5cGU6IDxzdGFydCwgZXhhY3Q+LCBjYWxsYmFjazogPGZ1bmN0aW9uPn0gfQogICovCgogIC8qKgogICAqIEBpZ25vcmUKICAgKiBTaG91bGQgbm90IGJlIHVzZWQgZGlyZWN0bHkgYnkgSHlwZXJ0aWVzLiBJdCdzIGNhbGxlZCBieSB0aGUgU3luY2hlci5zdWJzY3JpYmUgbWV0aG9kCiAgICovCgogIGZ1bmN0aW9uIERhdGFPYmplY3RPYnNlcnZlcihvd25lciwgdXJsLCBzY2hlbWEsIGJ1cywgaW5pdGlhbFN0YXR1cywgaW5pdGlhbERhdGEsIGNoaWxkcmVuKSB7CiAgICBfY2xhc3NDYWxsQ2hlY2sodGhpcywgRGF0YU9iamVjdE9ic2VydmVyKTsKCiAgICBfZ2V0KE9iamVjdC5nZXRQcm90b3R5cGVPZihEYXRhT2JqZWN0T2JzZXJ2ZXIucHJvdG90eXBlKSwgJ2NvbnN0cnVjdG9yJywgdGhpcykuY2FsbCh0aGlzLCBvd25lciwgdXJsLCBzY2hlbWEsIGJ1cywgaW5pdGlhbFN0YXR1cywgaW5pdGlhbERhdGEsIGNoaWxkcmVuKTsKICAgIHZhciBfdGhpcyA9IHRoaXM7CgogICAgLy9hZGQgbGlzdGVuZXIgZm9yIG9ialVSTAogICAgYnVzLmFkZExpc3RlbmVyKHVybCwgZnVuY3Rpb24gKG1zZykgewogICAgICBjb25zb2xlLmxvZygnRGF0YU9iamVjdE9ic2VydmVyLScgKyB1cmwgKyAnLVJDVjogJywgbXNnKTsKICAgICAgX3RoaXMuX2NoYW5nZU9iamVjdChfdGhpcy5fc3luY09iaiwgbXNnKTsKICAgIH0pOwoKICAgIF90aGlzLl9zeW5jT2JqLm9ic2VydmUoZnVuY3Rpb24gKGV2ZW50KSB7CiAgICAgIF90aGlzLl9vbkZpbHRlcihldmVudCk7CiAgICB9KTsKCiAgICBfdGhpcy5fZmlsdGVycyA9IHt9OwogIH0KCiAgLyoqCiAgICogUmVnaXN0ZXIgdGhlIGNoYW5nZSBsaXN0ZW5lcnMgc2VudCBieSB0aGUgcmVwb3J0ZXIKICAgKiBAcGFyYW0ge3N0cmluZ30gZmlsdGVyIC0gRmlsdGVyIHRoYXQgaWRlbnRpZmllcyB0aGUgZmllbGQgKHNlcGFyZXRlZCBkb3QgcGF0aCkuIEFjY2VwdHMgKiBhdCB0aGUgZW5kIGZvciBhIG1vcmUgdW5yZXN0cmljdGVkIGZpbHRlcmluZy4KICAgKiBAcGFyYW0ge2Z1bmN0aW9uKGV2ZW50OiBNc2dFdmVudCl9IGNhbGxiYWNrCiAgICovCgogIF9jcmVhdGVDbGFzcyhEYXRhT2JqZWN0T2JzZXJ2ZXIsIFt7CiAgICBrZXk6ICdvbkNoYW5nZScsCiAgICB2YWx1ZTogZnVuY3Rpb24gb25DaGFuZ2UoZmlsdGVyLCBjYWxsYmFjaykgewogICAgICB2YXIga2V5ID0gZmlsdGVyOwogICAgICB2YXIgZmlsdGVyT2JqID0gewogICAgICAgIHR5cGU6IEZpbHRlclR5cGUuRVhBQ1QsCiAgICAgICAgY2FsbGJhY2s6IGNhbGxiYWNrCiAgICAgIH07CgogICAgICB2YXIgaWR4ID0gZmlsdGVyLmluZGV4T2YoJyonKTsKICAgICAgaWYgKGlkeCA9PT0gZmlsdGVyLmxlbmd0aCAtIDEpIHsKICAgICAgICBpZiAoaWR4ID09PSAwKSB7CiAgICAgICAgICBmaWx0ZXJPYmoudHlwZSA9IEZpbHRlclR5cGUuQU5ZOwogICAgICAgIH0gZWxzZSB7CiAgICAgICAgICBmaWx0ZXJPYmoudHlwZSA9IEZpbHRlclR5cGUuU1RBUlQ7CiAgICAgICAgICBrZXkgPSBmaWx0ZXIuc3Vic3RyKDAsIGZpbHRlci5sZW5ndGggLSAxKTsKICAgICAgICB9CiAgICAgIH0KCiAgICAgIHRoaXMuX2ZpbHRlcnNba2V5XSA9IGZpbHRlck9iajsKICAgIH0KICB9LCB7CiAgICBrZXk6ICdfb25GaWx0ZXInLAogICAgdmFsdWU6IGZ1bmN0aW9uIF9vbkZpbHRlcihldmVudCkgewogICAgICB2YXIgX3RoaXMgPSB0aGlzOwoKICAgICAgT2JqZWN0LmtleXMoX3RoaXMuX2ZpbHRlcnMpLmZvckVhY2goZnVuY3Rpb24gKGtleSkgewogICAgICAgIHZhciBmaWx0ZXIgPSBfdGhpcy5fZmlsdGVyc1trZXldOwogICAgICAgIGlmIChmaWx0ZXIudHlwZSA9PT0gRmlsdGVyVHlwZS5BTlkpIHsKICAgICAgICAgIC8vbWF0Y2ggYW55dGhpbmcKICAgICAgICAgIGZpbHRlci5jYWxsYmFjayhldmVudCk7CiAgICAgICAgfSBlbHNlIGlmIChmaWx0ZXIudHlwZSA9PT0gRmlsdGVyVHlwZS5TVEFSVCkgewogICAgICAgICAgLy9pZiBzdGFydHMgd2l0aCBmaWx0ZXIuLi4KICAgICAgICAgIGlmIChldmVudC5maWVsZC5pbmRleE9mKGtleSkgPT09IDApIHsKICAgICAgICAgICAgZmlsdGVyLmNhbGxiYWNrKGV2ZW50KTsKICAgICAgICAgIH0KICAgICAgICB9IGVsc2UgaWYgKGZpbHRlci50eXBlID09PSBGaWx0ZXJUeXBlLkVYQUNUKSB7CiAgICAgICAgICAvL2V4YWN0IG1hdGNoCiAgICAgICAgICBpZiAoZXZlbnQuZmllbGQgPT09IGtleSkgewogICAgICAgICAgICBmaWx0ZXIuY2FsbGJhY2soZXZlbnQpOwogICAgICAgICAgfQogICAgICAgIH0KICAgICAgfSk7CiAgICB9CiAgfV0pOwoKICByZXR1cm4gRGF0YU9iamVjdE9ic2VydmVyOwp9KShfRGF0YU9iamVjdDNbJ2RlZmF1bHQnXSAvKiBpbXBsZW1lbnRzIFN5bmNTdGF0dXMgKi8pOwoKZXhwb3J0c1snZGVmYXVsdCddID0gRGF0YU9iamVjdE9ic2VydmVyOwptb2R1bGUuZXhwb3J0cyA9IGV4cG9ydHNbJ2RlZmF1bHQnXTsKCn0seyIuL0RhdGFPYmplY3QiOjd9XSwxMDpbZnVuY3Rpb24ocmVxdWlyZSxtb2R1bGUsZXhwb3J0cyl7Cid1c2Ugc3RyaWN0JzsKCk9iamVjdC5kZWZpbmVQcm9wZXJ0eShleHBvcnRzLCAnX19lc01vZHVsZScsIHsKICB2YWx1ZTogdHJ1ZQp9KTsKCnZhciBfY3JlYXRlQ2xhc3MgPSAoZnVuY3Rpb24gKCkgeyBmdW5jdGlvbiBkZWZpbmVQcm9wZXJ0aWVzKHRhcmdldCwgcHJvcHMpIHsgZm9yICh2YXIgaSA9IDA7IGkgPCBwcm9wcy5sZW5ndGg7IGkrKykgeyB2YXIgZGVzY3JpcHRvciA9IHByb3BzW2ldOyBkZXNjcmlwdG9yLmVudW1lcmFibGUgPSBkZXNjcmlwdG9yLmVudW1lcmFibGUgfHwgZmFsc2U7IGRlc2NyaXB0b3IuY29uZmlndXJhYmxlID0gdHJ1ZTsgaWYgKCd2YWx1ZScgaW4gZGVzY3JpcHRvcikgZGVzY3JpcHRvci53cml0YWJsZSA9IHRydWU7IE9iamVjdC5kZWZpbmVQcm9wZXJ0eSh0YXJnZXQsIGRlc2NyaXB0b3Iua2V5LCBkZXNjcmlwdG9yKTsgfSB9IHJldHVybiBmdW5jdGlvbiAoQ29uc3RydWN0b3IsIHByb3RvUHJvcHMsIHN0YXRpY1Byb3BzKSB7IGlmIChwcm90b1Byb3BzKSBkZWZpbmVQcm9wZXJ0aWVzKENvbnN0cnVjdG9yLnByb3RvdHlwZSwgcHJvdG9Qcm9wcyk7IGlmIChzdGF0aWNQcm9wcykgZGVmaW5lUHJvcGVydGllcyhDb25zdHJ1Y3Rvciwgc3RhdGljUHJvcHMpOyByZXR1cm4gQ29uc3RydWN0b3I7IH07IH0pKCk7Cgp2YXIgX2dldCA9IGZ1bmN0aW9uIGdldChfeCwgX3gyLCBfeDMpIHsgdmFyIF9hZ2FpbiA9IHRydWU7IF9mdW5jdGlvbjogd2hpbGUgKF9hZ2FpbikgeyB2YXIgb2JqZWN0ID0gX3gsIHByb3BlcnR5ID0gX3gyLCByZWNlaXZlciA9IF94MzsgX2FnYWluID0gZmFsc2U7IGlmIChvYmplY3QgPT09IG51bGwpIG9iamVjdCA9IEZ1bmN0aW9uLnByb3RvdHlwZTsgdmFyIGRlc2MgPSBPYmplY3QuZ2V0T3duUHJvcGVydHlEZXNjcmlwdG9yKG9iamVjdCwgcHJvcGVydHkpOyBpZiAoZGVzYyA9PT0gdW5kZWZpbmVkKSB7IHZhciBwYXJlbnQgPSBPYmplY3QuZ2V0UHJvdG90eXBlT2Yob2JqZWN0KTsgaWYgKHBhcmVudCA9PT0gbnVsbCkgeyByZXR1cm4gdW5kZWZpbmVkOyB9IGVsc2UgeyBfeCA9IHBhcmVudDsgX3gyID0gcHJvcGVydHk7IF94MyA9IHJlY2VpdmVyOyBfYWdhaW4gPSB0cnVlOyBkZXNjID0gcGFyZW50ID0gdW5kZWZpbmVkOyBjb250aW51ZSBfZnVuY3Rpb247IH0gfSBlbHNlIGlmICgndmFsdWUnIGluIGRlc2MpIHsgcmV0dXJuIGRlc2MudmFsdWU7IH0gZWxzZSB7IHZhciBnZXR0ZXIgPSBkZXNjLmdldDsgaWYgKGdldHRlciA9PT0gdW5kZWZpbmVkKSB7IHJldHVybiB1bmRlZmluZWQ7IH0gcmV0dXJuIGdldHRlci5jYWxsKHJlY2VpdmVyKTsgfSB9IH07CgpmdW5jdGlvbiBfaW50ZXJvcFJlcXVpcmVEZWZhdWx0KG9iaikgeyByZXR1cm4gb2JqICYmIG9iai5fX2VzTW9kdWxlID8gb2JqIDogeyAnZGVmYXVsdCc6IG9iaiB9OyB9CgpmdW5jdGlvbiBfY2xhc3NDYWxsQ2hlY2soaW5zdGFuY2UsIENvbnN0cnVjdG9yKSB7IGlmICghKGluc3RhbmNlIGluc3RhbmNlb2YgQ29uc3RydWN0b3IpKSB7IHRocm93IG5ldyBUeXBlRXJyb3IoJ0Nhbm5vdCBjYWxsIGEgY2xhc3MgYXMgYSBmdW5jdGlvbicpOyB9IH0KCmZ1bmN0aW9uIF9pbmhlcml0cyhzdWJDbGFzcywgc3VwZXJDbGFzcykgeyBpZiAodHlwZW9mIHN1cGVyQ2xhc3MgIT09ICdmdW5jdGlvbicgJiYgc3VwZXJDbGFzcyAhPT0gbnVsbCkgeyB0aHJvdyBuZXcgVHlwZUVycm9yKCdTdXBlciBleHByZXNzaW9uIG11c3QgZWl0aGVyIGJlIG51bGwgb3IgYSBmdW5jdGlvbiwgbm90ICcgKyB0eXBlb2Ygc3VwZXJDbGFzcyk7IH0gc3ViQ2xhc3MucHJvdG90eXBlID0gT2JqZWN0LmNyZWF0ZShzdXBlckNsYXNzICYmIHN1cGVyQ2xhc3MucHJvdG90eXBlLCB7IGNvbnN0cnVjdG9yOiB7IHZhbHVlOiBzdWJDbGFzcywgZW51bWVyYWJsZTogZmFsc2UsIHdyaXRhYmxlOiB0cnVlLCBjb25maWd1cmFibGU6IHRydWUgfSB9KTsgaWYgKHN1cGVyQ2xhc3MpIE9iamVjdC5zZXRQcm90b3R5cGVPZiA/IE9iamVjdC5zZXRQcm90b3R5cGVPZihzdWJDbGFzcywgc3VwZXJDbGFzcykgOiBzdWJDbGFzcy5fX3Byb3RvX18gPSBzdXBlckNsYXNzOyB9Cgp2YXIgX0RhdGFPYmplY3QyID0gcmVxdWlyZSgnLi9EYXRhT2JqZWN0Jyk7Cgp2YXIgX0RhdGFPYmplY3QzID0gX2ludGVyb3BSZXF1aXJlRGVmYXVsdChfRGF0YU9iamVjdDIpOwoKdmFyIF91dGlsc1V0aWxzSnMgPSByZXF1aXJlKCcuLi91dGlscy91dGlscy5qcycpOwoKdmFyIERhdGFPYmplY3RSZXBvcnRlciA9IChmdW5jdGlvbiAoX0RhdGFPYmplY3QpIHsKICBfaW5oZXJpdHMoRGF0YU9iamVjdFJlcG9ydGVyLCBfRGF0YU9iamVjdCk7CgogIC8qIHByaXZhdGUKICBfc3Vic2NyaXB0aW9uczogPGh5cGVydHlVcmw6IHsgc3RhdHVzOiBzdHJpbmcgfSB9PgogICAtLS0tZXZlbnQgaGFuZGxlcnMtLS0tCiAgX29uU3Vic2NyaXB0aW9uSGFuZGxlcjogKGV2ZW50KSA9PiB2b2lkCiAgX29uUmVzcG9uc2VIYW5kbGVyOiAoZXZlbnQpID0+IHZvaWQKICAqLwoKICAvKioKICAgKiBAaWdub3JlCiAgICogU2hvdWxkIG5vdCBiZSB1c2VkIGRpcmVjdGx5IGJ5IEh5cGVydGllcy4gSXQncyBjYWxsZWQgYnkgdGhlIFN5bmNoZXIuY3JlYXRlIG1ldGhvZAogICAqLwoKICBmdW5jdGlvbiBEYXRhT2JqZWN0UmVwb3J0ZXIob3duZXIsIHVybCwgc2NoZW1hLCBidXMsIGluaXRpYWxTdGF0dXMsIGluaXRpYWxEYXRhLCBjaGlsZHJlbikgewogICAgX2NsYXNzQ2FsbENoZWNrKHRoaXMsIERhdGFPYmplY3RSZXBvcnRlcik7CgogICAgX2dldChPYmplY3QuZ2V0UHJvdG90eXBlT2YoRGF0YU9iamVjdFJlcG9ydGVyLnByb3RvdHlwZSksICdjb25zdHJ1Y3RvcicsIHRoaXMpLmNhbGwodGhpcywgb3duZXIsIHVybCwgc2NoZW1hLCBidXMsIGluaXRpYWxTdGF0dXMsIGluaXRpYWxEYXRhLCBjaGlsZHJlbik7CiAgICB2YXIgX3RoaXMgPSB0aGlzOwoKICAgIGJ1cy5hZGRMaXN0ZW5lcihvd25lciwgZnVuY3Rpb24gKG1zZykgewogICAgICBpZiAobXNnLnR5cGUgPT09ICdyZXNwb25zZScgJiYgbXNnLmJvZHkuc291cmNlID09PSB1cmwpIHsKICAgICAgICBfdGhpcy5fb25SZXNwb25zZShtc2cpOwogICAgICB9CiAgICB9KTsKCiAgICBfdGhpcy5fc3luY09iai5vYnNlcnZlKGZ1bmN0aW9uIChldmVudCkgewogICAgICBfdGhpcy5fb25DaGFuZ2UoZXZlbnQpOwogICAgfSk7CgogICAgX3RoaXMuX3N1YnNjcmlwdGlvbnMgPSB7fTsKICB9CgogIC8qKgogICAqIFN1YnNjcmlwdGlvbnMgcmVxdWVzdGVkIGFuZCBhY2NlcHRlZCB0byB0aGlzIHJlcG9ydGVyCiAgICogQHR5cGUge09iamVjdDxIeXBlcnR5VVJMLCBTeW5jU3Vic2NyaXB0aW9uPn0KICAgKi8KCiAgX2NyZWF0ZUNsYXNzKERhdGFPYmplY3RSZXBvcnRlciwgW3sKICAgIGtleTogJ29uU3Vic2NyaXB0aW9uJywKCiAgICAvKioKICAgICAqIFNldHVwIHRoZSBjYWxsYmFjayB0byBwcm9jZXNzIHN1YnNjcmliZSBhbmQgdW5zdWJzY3JpYmUgbm90aWZpY2F0aW9ucwogICAgICogQHBhcmFtIHtmdW5jdGlvbihldmVudDogTXNnRXZlbnQpfSBjYWxsYmFjawogICAgICovCiAgICB2YWx1ZTogZnVuY3Rpb24gb25TdWJzY3JpcHRpb24oY2FsbGJhY2spIHsKICAgICAgdGhpcy5fb25TdWJzY3JpcHRpb25IYW5kbGVyID0gY2FsbGJhY2s7CiAgICB9CgogICAgLyoqCiAgICAgKiBTZXR1cCB0aGUgY2FsbGJhY2sgdG8gcHJvY2VzcyByZXNwb25zZSBub3RpZmljYXRpb25zIG9mIHRoZSBjcmVhdGUncwogICAgICogQHBhcmFtIHtmdW5jdGlvbihldmVudDogTXNnRXZlbnQpfSBjYWxsYmFjawogICAgICovCiAgfSwgewogICAga2V5OiAnb25SZXNwb25zZScsCiAgICB2YWx1ZTogZnVuY3Rpb24gb25SZXNwb25zZShjYWxsYmFjaykgewogICAgICB0aGlzLl9vblJlc3BvbnNlSGFuZGxlciA9IGNhbGxiYWNrOwogICAgfQogIH0sIHsKICAgIGtleTogJ19vbkZvcndhcmQnLAogICAgdmFsdWU6IGZ1bmN0aW9uIF9vbkZvcndhcmQobXNnKSB7CiAgICAgIHZhciBfdGhpcyA9IHRoaXM7CgogICAgICBjb25zb2xlLmxvZygnRGF0YU9iamVjdFJlcG9ydGVyLVJDVjogJywgbXNnKTsKICAgICAgc3dpdGNoIChtc2cuYm9keS50eXBlKSB7CiAgICAgICAgY2FzZSAnc3Vic2NyaWJlJzoKICAgICAgICAgIF90aGlzLl9vblN1YnNjcmliZShtc2cpO2JyZWFrOwogICAgICAgIGNhc2UgJ3Vuc3Vic2NyaWJlJzoKICAgICAgICAgIF90aGlzLl9vblVuU3Vic2NyaWJlKG1zZyk7YnJlYWs7CiAgICAgIH0KICAgIH0KICB9LCB7CiAgICBrZXk6ICdfb25TdWJzY3JpYmUnLAogICAgdmFsdWU6IGZ1bmN0aW9uIF9vblN1YnNjcmliZShtc2cpIHsKICAgICAgdmFyIF90aGlzID0gdGhpczsKICAgICAgdmFyIGh5cGVydHlVcmwgPSBtc2cuYm9keS5mcm9tOwoKICAgICAgdmFyIGV2ZW50ID0gewogICAgICAgIHR5cGU6IG1zZy5ib2R5LnR5cGUsCiAgICAgICAgdXJsOiBoeXBlcnR5VXJsLAoKICAgICAgICBhY2NlcHQ6IGZ1bmN0aW9uIGFjY2VwdCgpIHsKICAgICAgICAgIC8vY3JlYXRlIG5ldyBzdWJzY3JpcHRpb24KICAgICAgICAgIHZhciBzdWIgPSB7IHVybDogaHlwZXJ0eVVybCwgc3RhdHVzOiAnb24nIH07CiAgICAgICAgICBfdGhpcy5fc3Vic2NyaXB0aW9uc1toeXBlcnR5VXJsXSA9IHN1YjsKCiAgICAgICAgICAvL3NlbmQgb2sgcmVzcG9uc2UgbWVzc2FnZQogICAgICAgICAgX3RoaXMuX2J1cy5wb3N0TWVzc2FnZSh7CiAgICAgICAgICAgIGlkOiBtc2cuaWQsIHR5cGU6ICdyZXNwb25zZScsIGZyb206IG1zZy50bywgdG86IG1zZy5mcm9tLAogICAgICAgICAgICBib2R5OiB7IGNvZGU6IDIwMCwgc2NoZW1hOiBfdGhpcy5fc2NoZW1hLCB2ZXJzaW9uOiBfdGhpcy5fdmVyc2lvbiwgdmFsdWU6ICgwLCBfdXRpbHNVdGlsc0pzLmRlZXBDbG9uZSkoX3RoaXMuZGF0YSkgfQogICAgICAgICAgfSk7CgogICAgICAgICAgcmV0dXJuIHN1YjsKICAgICAgICB9LAoKICAgICAgICByZWplY3Q6IGZ1bmN0aW9uIHJlamVjdChyZWFzb24pIHsKICAgICAgICAgIC8vc2VuZCByZWplY3QgcmVzcG9uc2UgbWVzc2FnZQogICAgICAgICAgX3RoaXMuX2J1cy5wb3N0TWVzc2FnZSh7CiAgICAgICAgICAgIGlkOiBtc2cuaWQsIHR5cGU6ICdyZXNwb25zZScsIGZyb206IG1zZy50bywgdG86IG1zZy5mcm9tLAogICAgICAgICAgICBib2R5OiB7IGNvZGU6IDQwMywgZGVzYzogcmVhc29uIH0KICAgICAgICAgIH0pOwogICAgICAgIH0KICAgICAgfTsKCiAgICAgIGlmIChfdGhpcy5fb25TdWJzY3JpcHRpb25IYW5kbGVyKSB7CiAgICAgICAgX3RoaXMuX29uU3Vic2NyaXB0aW9uSGFuZGxlcihldmVudCk7CiAgICAgIH0KICAgIH0KICB9LCB7CiAgICBrZXk6ICdfb25VblN1YnNjcmliZScsCiAgICB2YWx1ZTogZnVuY3Rpb24gX29uVW5TdWJzY3JpYmUobXNnKSB7CiAgICAgIHZhciBfdGhpcyA9IHRoaXM7CiAgICAgIHZhciBoeXBlcnR5VXJsID0gbXNnLmJvZHkuZnJvbTsKCiAgICAgIHZhciBzdWIgPSBfdGhpcy5fc3Vic2NyaXB0aW9uc1toeXBlcnR5VXJsXTsKICAgICAgZGVsZXRlIF90aGlzLl9zdWJzY3JpcHRpb25zW2h5cGVydHlVcmxdOwoKICAgICAgdmFyIGV2ZW50ID0gewogICAgICAgIHR5cGU6IG1zZy5ib2R5LnR5cGUsCiAgICAgICAgdXJsOiBoeXBlcnR5VXJsLAogICAgICAgIG9iamVjdDogc3ViCiAgICAgIH07CgogICAgICBpZiAoX3RoaXMuX29uU3Vic2NyaXB0aW9uSGFuZGxlcikgewogICAgICAgIF90aGlzLl9vblN1YnNjcmlwdGlvbkhhbmRsZXIoZXZlbnQpOwogICAgICB9CiAgICB9CiAgfSwgewogICAga2V5OiAnX29uUmVzcG9uc2UnLAogICAgdmFsdWU6IGZ1bmN0aW9uIF9vblJlc3BvbnNlKG1zZykgewogICAgICB2YXIgX3RoaXMgPSB0aGlzOwoKICAgICAgdmFyIGV2ZW50ID0gewogICAgICAgIHR5cGU6IG1zZy50eXBlLAogICAgICAgIHVybDogbXNnLmZyb20sCiAgICAgICAgY29kZTogbXNnLmJvZHkuY29kZQogICAgICB9OwoKICAgICAgaWYgKF90aGlzLl9vblJlc3BvbnNlSGFuZGxlcikgewogICAgICAgIF90aGlzLl9vblJlc3BvbnNlSGFuZGxlcihldmVudCk7CiAgICAgIH0KICAgIH0KICB9LCB7CiAgICBrZXk6ICdzdWJzY3JpcHRpb25zJywKICAgIGdldDogZnVuY3Rpb24gZ2V0KCkgewogICAgICByZXR1cm4gdGhpcy5fc3Vic2NyaXB0aW9uczsKICAgIH0KICB9XSk7CgogIHJldHVybiBEYXRhT2JqZWN0UmVwb3J0ZXI7Cn0pKF9EYXRhT2JqZWN0M1snZGVmYXVsdCddIC8qIGltcGxlbWVudHMgU3luY1N0YXR1cyAqLyk7CgpleHBvcnRzWydkZWZhdWx0J10gPSBEYXRhT2JqZWN0UmVwb3J0ZXI7Cm1vZHVsZS5leHBvcnRzID0gZXhwb3J0c1snZGVmYXVsdCddOwoKfSx7Ii4uL3V0aWxzL3V0aWxzLmpzIjoxNSwiLi9EYXRhT2JqZWN0Ijo3fV0sMTE6W2Z1bmN0aW9uKHJlcXVpcmUsbW9kdWxlLGV4cG9ydHMpewovKioKICogQGFjY2VzcyBwcml2YXRlCiAqLwondXNlIHN0cmljdCc7CgpPYmplY3QuZGVmaW5lUHJvcGVydHkoZXhwb3J0cywgJ19fZXNNb2R1bGUnLCB7CiAgdmFsdWU6IHRydWUKfSk7Cgp2YXIgX2NyZWF0ZUNsYXNzID0gKGZ1bmN0aW9uICgpIHsgZnVuY3Rpb24gZGVmaW5lUHJvcGVydGllcyh0YXJnZXQsIHByb3BzKSB7IGZvciAodmFyIGkgPSAwOyBpIDwgcHJvcHMubGVuZ3RoOyBpKyspIHsgdmFyIGRlc2NyaXB0b3IgPSBwcm9wc1tpXTsgZGVzY3JpcHRvci5lbnVtZXJhYmxlID0gZGVzY3JpcHRvci5lbnVtZXJhYmxlIHx8IGZhbHNlOyBkZXNjcmlwdG9yLmNvbmZpZ3VyYWJsZSA9IHRydWU7IGlmICgndmFsdWUnIGluIGRlc2NyaXB0b3IpIGRlc2NyaXB0b3Iud3JpdGFibGUgPSB0cnVlOyBPYmplY3QuZGVmaW5lUHJvcGVydHkodGFyZ2V0LCBkZXNjcmlwdG9yLmtleSwgZGVzY3JpcHRvcik7IH0gfSByZXR1cm4gZnVuY3Rpb24gKENvbnN0cnVjdG9yLCBwcm90b1Byb3BzLCBzdGF0aWNQcm9wcykgeyBpZiAocHJvdG9Qcm9wcykgZGVmaW5lUHJvcGVydGllcyhDb25zdHJ1Y3Rvci5wcm90b3R5cGUsIHByb3RvUHJvcHMpOyBpZiAoc3RhdGljUHJvcHMpIGRlZmluZVByb3BlcnRpZXMoQ29uc3RydWN0b3IsIHN0YXRpY1Byb3BzKTsgcmV0dXJuIENvbnN0cnVjdG9yOyB9OyB9KSgpOwoKZnVuY3Rpb24gX2NsYXNzQ2FsbENoZWNrKGluc3RhbmNlLCBDb25zdHJ1Y3RvcikgeyBpZiAoIShpbnN0YW5jZSBpbnN0YW5jZW9mIENvbnN0cnVjdG9yKSkgeyB0aHJvdyBuZXcgVHlwZUVycm9yKCdDYW5ub3QgY2FsbCBhIGNsYXNzIGFzIGEgZnVuY3Rpb24nKTsgfSB9Cgp2YXIgRGF0YVByb3Zpc2lvbmFsID0gKGZ1bmN0aW9uICgpIHsKICAvKiBwcml2YXRlCiAgX2NoaWxkcmVuTGlzdGVuZXJzOiBbTXNnTGlzdGVuZXJdCiAgX2xpc3RlbmVyOiBNc2dMaXN0ZW5lcgogICBfY2hhbmdlczogW10KICAqLwoKICBmdW5jdGlvbiBEYXRhUHJvdmlzaW9uYWwob3duZXIsIHVybCwgYnVzLCBjaGlsZHJlbikgewogICAgX2NsYXNzQ2FsbENoZWNrKHRoaXMsIERhdGFQcm92aXNpb25hbCk7CgogICAgdmFyIF90aGlzID0gdGhpczsKCiAgICBfdGhpcy5fY2hhbmdlcyA9IFtdOwogICAgX3RoaXMuX2NoaWxkcmVuID0gY2hpbGRyZW47CiAgICBfdGhpcy5fY2hpbGRyZW5MaXN0ZW5lcnMgPSBbXTsKCiAgICBfdGhpcy5fbGlzdGVuZXIgPSBidXMuYWRkTGlzdGVuZXIodXJsLCBmdW5jdGlvbiAobXNnKSB7CiAgICAgIGNvbnNvbGUubG9nKCdEYXRhUHJvdmlzaW9uYWwtJyArIHVybCArICctUkNWOiAnLCBtc2cpOwogICAgICBfdGhpcy5fY2hhbmdlcy5wdXNoKG1zZyk7CiAgICB9KTsKCiAgICAvKmlmIChjaGlsZHJlbikgewogICAgICBsZXQgY2hpbGRCYXNlVVJMID0gdXJsICsgJy9jaGlsZHJlbi8nOwogICAgICBjaGlsZHJlbi5mb3JFYWNoKChjaGlsZCkgPT4gewogICAgICAgIGxldCBjaGlsZFVSTCA9IGNoaWxkQmFzZVVSTCArIGNoaWxkOwogICAgICAgIGxldCBsaXN0ZW5lciA9IGJ1cy5hZGRMaXN0ZW5lcihjaGlsZFVSTCwgKG1zZykgPT4gewogICAgICAgICAgLy9pZ25vcmUgbXNnIHNlbnQgYnkgaGltc2VsZgogICAgICAgICAgaWYgKG1zZy5mcm9tICE9PSBvd25lcikgewogICAgICAgICAgICBjb25zb2xlLmxvZyhtc2cpOwogICAgICAgICAgfQogICAgICAgIH0pOwogICAgICAgICBfdGhpcy5fY2hpbGRyZW5MaXN0ZW5lcnMucHVzaChsaXN0ZW5lcik7CiAgICAgIH0pOwogICAgfSovCiAgfQoKICBfY3JlYXRlQ2xhc3MoRGF0YVByb3Zpc2lvbmFsLCBbewogICAga2V5OiAnYXBwbHknLAogICAgdmFsdWU6IGZ1bmN0aW9uIGFwcGx5KG9ic2VydmVyKSB7CiAgICAgIHZhciBfdGhpcyA9IHRoaXM7CiAgICAgIF90aGlzLl9jaGFuZ2VzLmZvckVhY2goZnVuY3Rpb24gKGNoYW5nZSkgewogICAgICAgIG9ic2VydmVyLl9jaGFuZ2VPYmplY3Qob2JzZXJ2ZXIuX3N5bmNPYmosIGNoYW5nZSk7CiAgICAgIH0pOwogICAgfQogIH0sIHsKICAgIGtleTogJ3JlbGVhc2UnLAogICAgdmFsdWU6IGZ1bmN0aW9uIHJlbGVhc2UoKSB7CiAgICAgIHRoaXMuX2xpc3RlbmVyLnJlbW92ZSgpOwoKICAgICAgLyp0aGlzLl9jaGlsZHJlbkxpc3RlbmVycy5mb3JFYWNoKChsaXN0ZW5lcikgPT4gewogICAgICAgIGxpc3RlbmVyLnJlbW92ZSgpOwogICAgICB9KTsqLwogICAgfQogIH0sIHsKICAgIGtleTogJ2NoaWxkcmVuJywKICAgIGdldDogZnVuY3Rpb24gZ2V0KCkgewogICAgICByZXR1cm4gdGhpcy5fY2hpbGRyZW47CiAgICB9CiAgfV0pOwoKICByZXR1cm4gRGF0YVByb3Zpc2lvbmFsOwp9KSgpOwoKZXhwb3J0c1snZGVmYXVsdCddID0gRGF0YVByb3Zpc2lvbmFsOwptb2R1bGUuZXhwb3J0cyA9IGV4cG9ydHNbJ2RlZmF1bHQnXTsKCn0se31dLDEyOltmdW5jdGlvbihyZXF1aXJlLG1vZHVsZSxleHBvcnRzKXsKJ3VzZSBzdHJpY3QnOwoKT2JqZWN0LmRlZmluZVByb3BlcnR5KGV4cG9ydHMsICdfX2VzTW9kdWxlJywgewogIHZhbHVlOiB0cnVlCn0pOwoKdmFyIF9jcmVhdGVDbGFzcyA9IChmdW5jdGlvbiAoKSB7IGZ1bmN0aW9uIGRlZmluZVByb3BlcnRpZXModGFyZ2V0LCBwcm9wcykgeyBmb3IgKHZhciBpID0gMDsgaSA8IHByb3BzLmxlbmd0aDsgaSsrKSB7IHZhciBkZXNjcmlwdG9yID0gcHJvcHNbaV07IGRlc2NyaXB0b3IuZW51bWVyYWJsZSA9IGRlc2NyaXB0b3IuZW51bWVyYWJsZSB8fCBmYWxzZTsgZGVzY3JpcHRvci5jb25maWd1cmFibGUgPSB0cnVlOyBpZiAoJ3ZhbHVlJyBpbiBkZXNjcmlwdG9yKSBkZXNjcmlwdG9yLndyaXRhYmxlID0gdHJ1ZTsgT2JqZWN0LmRlZmluZVByb3BlcnR5KHRhcmdldCwgZGVzY3JpcHRvci5rZXksIGRlc2NyaXB0b3IpOyB9IH0gcmV0dXJuIGZ1bmN0aW9uIChDb25zdHJ1Y3RvciwgcHJvdG9Qcm9wcywgc3RhdGljUHJvcHMpIHsgaWYgKHByb3RvUHJvcHMpIGRlZmluZVByb3BlcnRpZXMoQ29uc3RydWN0b3IucHJvdG90eXBlLCBwcm90b1Byb3BzKTsgaWYgKHN0YXRpY1Byb3BzKSBkZWZpbmVQcm9wZXJ0aWVzKENvbnN0cnVjdG9yLCBzdGF0aWNQcm9wcyk7IHJldHVybiBDb25zdHJ1Y3RvcjsgfTsgfSkoKTsKCmZ1bmN0aW9uIF9jbGFzc0NhbGxDaGVjayhpbnN0YW5jZSwgQ29uc3RydWN0b3IpIHsgaWYgKCEoaW5zdGFuY2UgaW5zdGFuY2VvZiBDb25zdHJ1Y3RvcikpIHsgdGhyb3cgbmV3IFR5cGVFcnJvcignQ2Fubm90IGNhbGwgYSBjbGFzcyBhcyBhIGZ1bmN0aW9uJyk7IH0gfQoKdmFyIF91dGlsc1V0aWxzSnMgPSByZXF1aXJlKCcuLi91dGlscy91dGlscy5qcycpOwoKLyoqCiAqIEBhY2Nlc3MgcHJpdmF0ZQogKi8KCnZhciBTeW5jT2JqZWN0ID0gKGZ1bmN0aW9uICgpIHsKICAvKiBwcml2YXRlCiAgICBfZGF0YTogYW55OwogICAgX29ic2VydmVyczogKChldmVudDogQ2hhbmdlRXZlbnQpID0+IHZvaWQpW10KICAqLwoKICBmdW5jdGlvbiBTeW5jT2JqZWN0KGluaXRpYWxEYXRhKSB7CiAgICBfY2xhc3NDYWxsQ2hlY2sodGhpcywgU3luY09iamVjdCk7CgogICAgdmFyIF90aGlzID0gdGhpczsKCiAgICBfdGhpcy5fb2JzZXJ2ZXJzID0gW107CiAgICBfdGhpcy5fZmlsdGVycyA9IHt9OwoKICAgIGlmIChpbml0aWFsRGF0YSkgewogICAgICBfdGhpcy5fZGF0YSA9IGluaXRpYWxEYXRhOwogICAgfSBlbHNlIHsKICAgICAgX3RoaXMuX2RhdGEgPSB7fTsKICAgIH0KCiAgICBfdGhpcy5faW50ZXJuYWxPYnNlcnZlKG5ldyBQYXRoKCksIF90aGlzLl9kYXRhKTsKICB9CgogIC8vZHluYW1pYyBwYXRoIGZvciBBcnJheSBpbmRleC4uLgoKICBfY3JlYXRlQ2xhc3MoU3luY09iamVjdCwgW3sKICAgIGtleTogJ29ic2VydmUnLAogICAgdmFsdWU6IGZ1bmN0aW9uIG9ic2VydmUoY2FsbGJhY2spIHsKICAgICAgdGhpcy5fb2JzZXJ2ZXJzLnB1c2goY2FsbGJhY2spOwogICAgfQogIH0sIHsKICAgIGtleTogJ2ZpbmQnLAogICAgdmFsdWU6IGZ1bmN0aW9uIGZpbmQocGF0aCkgewogICAgICB2YXIgbGlzdCA9IHBhdGguc3BsaXQoJy4nKTsKCiAgICAgIHJldHVybiB0aGlzLl9maW5kV2l0aFNwbGl0KGxpc3QpOwogICAgfQogIH0sIHsKICAgIGtleTogJ2ZpbmRCZWZvcmUnLAogICAgdmFsdWU6IGZ1bmN0aW9uIGZpbmRCZWZvcmUocGF0aCkgewogICAgICB2YXIgcmVzdWx0ID0ge307CiAgICAgIHZhciBsaXN0ID0gcGF0aC5zcGxpdCgnLicpOwogICAgICByZXN1bHQubGFzdCA9IGxpc3QucG9wKCk7CiAgICAgIHJlc3VsdC5vYmogPSB0aGlzLl9maW5kV2l0aFNwbGl0KGxpc3QpOwoKICAgICAgcmV0dXJuIHJlc3VsdDsKICAgIH0KICB9LCB7CiAgICBrZXk6ICdfZmluZFdpdGhTcGxpdCcsCiAgICB2YWx1ZTogZnVuY3Rpb24gX2ZpbmRXaXRoU3BsaXQobGlzdCkgewogICAgICB2YXIgb2JqID0gdGhpcy5fZGF0YTsKICAgICAgbGlzdC5mb3JFYWNoKGZ1bmN0aW9uICh2YWx1ZSkgewogICAgICAgIG9iaiA9IG9ialt2YWx1ZV07CiAgICAgIH0pOwoKICAgICAgcmV0dXJuIG9iajsKICAgIH0KICB9LCB7CiAgICBrZXk6ICdfZmlyZUV2ZW50JywKICAgIHZhbHVlOiBmdW5jdGlvbiBfZmlyZUV2ZW50KGV2ZW50KSB7CiAgICAgIHRoaXMuX29ic2VydmVycy5mb3JFYWNoKGZ1bmN0aW9uIChjYWxsYmFjaykgewogICAgICAgIGNhbGxiYWNrKGV2ZW50KTsKICAgICAgfSk7CiAgICB9CiAgfSwgewogICAga2V5OiAnX2lzT2JzZXJ2YWJsZScsCiAgICB2YWx1ZTogZnVuY3Rpb24gX2lzT2JzZXJ2YWJsZShvYmopIHsKICAgICAgaWYgKG9iai5jb25zdHJ1Y3RvciA9PT0gT2JqZWN0IHx8IG9iai5jb25zdHJ1Y3RvciA9PT0gQXJyYXkpIHsKICAgICAgICByZXR1cm4gdHJ1ZTsKICAgICAgfQoKICAgICAgcmV0dXJuIGZhbHNlOwogICAgfQogIH0sIHsKICAgIGtleTogJ19pbnRlcm5hbE9ic2VydmUnLAogICAgdmFsdWU6IGZ1bmN0aW9uIF9pbnRlcm5hbE9ic2VydmUocGF0aCwgb2JqKSB7CiAgICAgIHZhciBfdGhpcyA9IHRoaXM7CgogICAgICBpZiAoX3RoaXMuX2lzT2JzZXJ2YWJsZShvYmopKSB7CiAgICAgICAgdmFyIGhhbmRsZXIgPSBmdW5jdGlvbiBoYW5kbGVyKGNoYW5nZXMpIHsKICAgICAgICAgIF90aGlzLl9vbkNoYW5nZXMocGF0aCwgY2hhbmdlcyk7CiAgICAgICAgfTsKCiAgICAgICAgaWYgKG9iai5jb25zdHJ1Y3RvciA9PT0gT2JqZWN0KSB7CiAgICAgICAgICBPYmplY3Qub2JzZXJ2ZShvYmosIGhhbmRsZXIpOwogICAgICAgICAgZm9yICh2YXIgcHJvcCBpbiBvYmopIHsKICAgICAgICAgICAgaWYgKF90aGlzLl9pc09ic2VydmFibGUob2JqW3Byb3BdKSkgewogICAgICAgICAgICAgIF90aGlzLl9pbnRlcm5hbE9ic2VydmUocGF0aFsnbmV3J10ocHJvcCksIG9ialtwcm9wXSk7CiAgICAgICAgICAgIH0KICAgICAgICAgIH0KICAgICAgICB9IGVsc2UgaWYgKG9iai5jb25zdHJ1Y3RvciA9PT0gQXJyYXkpIHsKICAgICAgICAgIEFycmF5Lm9ic2VydmUob2JqLCBoYW5kbGVyKTsKICAgICAgICAgIGZvciAodmFyIHByb3AgaW4gb2JqKSB7CiAgICAgICAgICAgIGlmIChfdGhpcy5faXNPYnNlcnZhYmxlKG9ialtwcm9wXSkpIHsKICAgICAgICAgICAgICB2YXIgbnAgPSBwYXRoWyduZXcnXShuZXcgQXJyYXlJbmRleChvYmpbcHJvcF0sIHByb3ApKTsKICAgICAgICAgICAgICBfdGhpcy5faW50ZXJuYWxPYnNlcnZlKG5wLCBvYmpbcHJvcF0pOwogICAgICAgICAgICB9CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICB9CiAgICB9CiAgfSwgewogICAga2V5OiAnX29uQ2hhbmdlcycsCiAgICB2YWx1ZTogZnVuY3Rpb24gX29uQ2hhbmdlcyhwYXRoLCBjaGFuZ2VzKSB7CiAgICAgIHZhciBfdGhpczIgPSB0aGlzOwoKICAgICAgZm9yICh2YXIgaSBpbiBjaGFuZ2VzKSB7CiAgICAgICAgdmFyIG9iaiA9IGNoYW5nZXNbaV0ub2JqZWN0OwogICAgICAgIHZhciBvYmpUeXBlID0gdW5kZWZpbmVkOwoKICAgICAgICBpZiAob2JqLmNvbnN0cnVjdG9yID09PSBPYmplY3QpIHsKICAgICAgICAgIG9ialR5cGUgPSBPYmplY3RUeXBlLk9CSkVDVDsKICAgICAgICB9CgogICAgICAgIGlmIChvYmouY29uc3RydWN0b3IgPT09IEFycmF5KSB7CiAgICAgICAgICBvYmpUeXBlID0gT2JqZWN0VHlwZS5BUlJBWTsKICAgICAgICB9CgogICAgICAgIGlmIChjaGFuZ2VzW2ldLnR5cGUgPT09ICdzcGxpY2UnKSB7CiAgICAgICAgICAoZnVuY3Rpb24gKCkgewogICAgICAgICAgICB2YXIgaWR4ID0gY2hhbmdlc1tpXS5pbmRleDsKICAgICAgICAgICAgdmFyIGZpZWxkID0gcGF0aFsnbmV3J10oJycgKyBpZHgpOwogICAgICAgICAgICB2YXIgZmllbGRTdHJpbmcgPSBmaWVsZC50b1N0cmluZygpOwoKICAgICAgICAgICAgdmFyIHJlbW92ZVNpemUgPSBjaGFuZ2VzW2ldLnJlbW92ZWQubGVuZ3RoOwogICAgICAgICAgICBpZiAocmVtb3ZlU2l6ZSAhPT0gMCkgewogICAgICAgICAgICAgIHZhciByZW1vdmVWYWx1ZXMgPSBjaGFuZ2VzW2ldLnJlbW92ZWQ7CiAgICAgICAgICAgICAgcmVtb3ZlVmFsdWVzLmZvckVhY2goZnVuY3Rpb24gKHZhbHVlLCBpbmRleCkgewogICAgICAgICAgICAgICAgaWYgKF90aGlzMi5faXNPYnNlcnZhYmxlKHZhbHVlKSkgewogICAgICAgICAgICAgICAgICBwYXRoLnJlbW92ZUluZGV4KGlkeCArIGluZGV4KTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICB9KTsKCiAgICAgICAgICAgICAgX3RoaXMyLl9maXJlRXZlbnQoewogICAgICAgICAgICAgICAgY1R5cGU6IENoYW5nZVR5cGUuUkVNT1ZFLAogICAgICAgICAgICAgICAgb1R5cGU6IG9ialR5cGUsCiAgICAgICAgICAgICAgICBmaWVsZDogZmllbGRTdHJpbmcsCiAgICAgICAgICAgICAgICBkYXRhOiByZW1vdmVTaXplCiAgICAgICAgICAgICAgfSk7CiAgICAgICAgICAgIH0KCiAgICAgICAgICAgIHZhciBhZGRTaXplID0gY2hhbmdlc1tpXS5hZGRlZENvdW50OwogICAgICAgICAgICBpZiAoYWRkU2l6ZSAhPT0gMCkgewogICAgICAgICAgICAgIHZhciBhZGRWYWx1ZXMgPSBvYmouc2xpY2UoaWR4LCBpZHggKyBhZGRTaXplKTsKICAgICAgICAgICAgICBhZGRWYWx1ZXMuZm9yRWFjaChmdW5jdGlvbiAodmFsdWUsIGluZGV4KSB7CiAgICAgICAgICAgICAgICBpZiAoX3RoaXMyLl9pc09ic2VydmFibGUodmFsdWUpKSB7CiAgICAgICAgICAgICAgICAgIHZhciBucCA9IHBhdGhbJ25ldyddKG5ldyBBcnJheUluZGV4KHZhbHVlLCBpZHggKyBpbmRleCkpOwogICAgICAgICAgICAgICAgICBfdGhpczIuX2ludGVybmFsT2JzZXJ2ZShucCwgdmFsdWUpOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIH0pOwoKICAgICAgICAgICAgICBfdGhpczIuX2ZpcmVFdmVudCh7CiAgICAgICAgICAgICAgICBjVHlwZTogQ2hhbmdlVHlwZS5BREQsCiAgICAgICAgICAgICAgICBvVHlwZTogb2JqVHlwZSwKICAgICAgICAgICAgICAgIGZpZWxkOiBmaWVsZFN0cmluZywKICAgICAgICAgICAgICAgIGRhdGE6ICgwLCBfdXRpbHNVdGlsc0pzLmRlZXBDbG9uZSkoYWRkVmFsdWVzKQogICAgICAgICAgICAgIH0pOwogICAgICAgICAgICB9CgogICAgICAgICAgICAvL3JlLWRlZmluZSBwYXRocy4uLgogICAgICAgICAgICBpZiAoaWR4ICE9PSBvYmoubGVuZ3RoIC0gMSkgewogICAgICAgICAgICAgIHBhdGgucmVJbmRleEZyb20ob2JqKTsKICAgICAgICAgICAgfQogICAgICAgICAgfSkoKTsKICAgICAgICB9IGVsc2UgewogICAgICAgICAgdmFyIGZpZWxkID0gcGF0aFsnbmV3J10oY2hhbmdlc1tpXS5uYW1lKTsKICAgICAgICAgIHZhciBmaWVsZFN0cmluZyA9IGZpZWxkLnRvU3RyaW5nKCk7CgogICAgICAgICAgaWYgKGZpZWxkU3RyaW5nLmluZGV4T2YoJ1N5bWJvbCcpICE9PSAtMSkgewogICAgICAgICAgICAvL2hhY2sgZm9yIFBoYW50b21KUzIKICAgICAgICAgICAgLy9jb25zb2xlLmxvZygnU1lNQk9MOiAnLCBjaGFuZ2VzW2ldKTsKICAgICAgICAgICAgY29udGludWU7CiAgICAgICAgICB9CgogICAgICAgICAgLy9sZXQgb2xkVmFsdWUgPSBjaGFuZ2VzW2ldLm9sZFZhbHVlOwogICAgICAgICAgdmFyIG5ld1ZhbHVlID0gb2JqW2NoYW5nZXNbaV0ubmFtZV07CiAgICAgICAgICBpZiAoY2hhbmdlc1tpXS50eXBlID09PSAndXBkYXRlJykgewogICAgICAgICAgICB0aGlzLl9maXJlRXZlbnQoewogICAgICAgICAgICAgIGNUeXBlOiBDaGFuZ2VUeXBlLlVQREFURSwKICAgICAgICAgICAgICBvVHlwZTogb2JqVHlwZSwKICAgICAgICAgICAgICBmaWVsZDogZmllbGRTdHJpbmcsCiAgICAgICAgICAgICAgZGF0YTogKDAsIF91dGlsc1V0aWxzSnMuZGVlcENsb25lKShuZXdWYWx1ZSkKICAgICAgICAgICAgfSk7CiAgICAgICAgICB9CgogICAgICAgICAgaWYgKGNoYW5nZXNbaV0udHlwZSA9PT0gJ2FkZCcpIHsKICAgICAgICAgICAgdGhpcy5faW50ZXJuYWxPYnNlcnZlKGZpZWxkLCBuZXdWYWx1ZSk7CiAgICAgICAgICAgIHRoaXMuX2ZpcmVFdmVudCh7CiAgICAgICAgICAgICAgY1R5cGU6IENoYW5nZVR5cGUuQURELAogICAgICAgICAgICAgIG9UeXBlOiBvYmpUeXBlLAogICAgICAgICAgICAgIGZpZWxkOiBmaWVsZFN0cmluZywKICAgICAgICAgICAgICBkYXRhOiAoMCwgX3V0aWxzVXRpbHNKcy5kZWVwQ2xvbmUpKG5ld1ZhbHVlKQogICAgICAgICAgICB9KTsKICAgICAgICAgIH0KCiAgICAgICAgICBpZiAoY2hhbmdlc1tpXS50eXBlID09PSAnZGVsZXRlJykgewogICAgICAgICAgICB0aGlzLl9maXJlRXZlbnQoewogICAgICAgICAgICAgIGNUeXBlOiBDaGFuZ2VUeXBlLlJFTU9WRSwKICAgICAgICAgICAgICBvVHlwZTogb2JqVHlwZSwKICAgICAgICAgICAgICBmaWVsZDogZmllbGRTdHJpbmcKICAgICAgICAgICAgfSk7CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICB9CiAgICB9CiAgfSwgewogICAga2V5OiAnZGF0YScsCiAgICBnZXQ6IGZ1bmN0aW9uIGdldCgpIHsKICAgICAgcmV0dXJuIHRoaXMuX2RhdGE7CiAgICB9CiAgfV0pOwoKICByZXR1cm4gU3luY09iamVjdDsKfSkoKTsKCnZhciBQYXRoID0gKGZ1bmN0aW9uICgpIHsKICBmdW5jdGlvbiBQYXRoKCkgewogICAgX2NsYXNzQ2FsbENoZWNrKHRoaXMsIFBhdGgpOwoKICAgIHRoaXMuX3BhdGggPSBbXTsKICAgIHRoaXMuX29ic2VydmFibGVzID0ge307IC8vPGluZGV4OkFycmF5SW5kZXg+CiAgfQoKICBfY3JlYXRlQ2xhc3MoUGF0aCwgW3sKICAgIGtleTogJ3JlbW92ZUluZGV4JywKICAgIHZhbHVlOiBmdW5jdGlvbiByZW1vdmVJbmRleChpZHgpIHsKICAgICAgLy9jb25zb2xlLmxvZygnUkVNT1ZFLVBBVEggJyArIGlkeCk7CiAgICAgIGRlbGV0ZSB0aGlzLl9vYnNlcnZhYmxlc1tpZHhdOwogICAgfQogIH0sIHsKICAgIGtleTogJ3JlSW5kZXhGcm9tJywKICAgIHZhbHVlOiBmdW5jdGlvbiByZUluZGV4RnJvbShhcnJheSkgewogICAgICB2YXIgX3RoaXMzID0gdGhpczsKCiAgICAgIE9iamVjdC5rZXlzKHRoaXMuX29ic2VydmFibGVzKS5mb3JFYWNoKGZ1bmN0aW9uIChrZXkpIHsKICAgICAgICB2YXIgYXJyYXlJbmRleCA9IF90aGlzMy5fb2JzZXJ2YWJsZXNba2V5XTsKICAgICAgICB2YXIgaWR4ID0gYXJyYXkuaW5kZXhPZihhcnJheUluZGV4Lm9iaik7CiAgICAgICAgaWYgKGFycmF5SW5kZXguaWR4ICE9IGlkeCkgewogICAgICAgICAgLy9jb25zb2xlLmxvZygnUkUtSU5ERVg6ICcgKyBrZXkgKyAnLT4nICsgaWR4KTsKICAgICAgICAgIGFycmF5SW5kZXguaWR4ID0gaWR4OwogICAgICAgICAgZGVsZXRlIF90aGlzMy5fb2JzZXJ2YWJsZXNba2V5XTsKICAgICAgICAgIF90aGlzMy5fb2JzZXJ2YWJsZXNbaWR4XSA9IGFycmF5SW5kZXg7CiAgICAgICAgfQogICAgICB9KTsKICAgIH0KICB9LCB7CiAgICBrZXk6ICduZXcnLAogICAgdmFsdWU6IGZ1bmN0aW9uIF9uZXcoaWR4KSB7CiAgICAgIGlmIChpZHguY29uc3RydWN0b3IgPT0gQXJyYXlJbmRleCkgewogICAgICAgIC8vY29uc29sZS5sb2coJ1BBVEgtT0JTRVJWOiAnLCBpZHgpOwogICAgICAgIHRoaXMuX29ic2VydmFibGVzW2lkeC5pZHhdID0gaWR4OwogICAgICB9CgogICAgICB2YXIgblBhdGggPSB0aGlzLmNsb25lKCk7CiAgICAgIG5QYXRoLl9wYXRoLnB1c2goaWR4KTsKCiAgICAgIHJldHVybiBuUGF0aDsKICAgIH0KICB9LCB7CiAgICBrZXk6ICdjbG9uZScsCiAgICB2YWx1ZTogZnVuY3Rpb24gY2xvbmUoKSB7CiAgICAgIHZhciBuUGF0aCA9IG5ldyBQYXRoKCk7CiAgICAgIHRoaXMuX3BhdGguZm9yRWFjaChmdW5jdGlvbiAodmFsdWUpIHsKICAgICAgICBuUGF0aC5fcGF0aC5wdXNoKHZhbHVlKTsKICAgICAgfSk7CgogICAgICByZXR1cm4gblBhdGg7CiAgICB9CiAgfSwgewogICAga2V5OiAndG9TdHJpbmcnLAogICAgdmFsdWU6IGZ1bmN0aW9uIHRvU3RyaW5nKCkgewogICAgICAvL1RPRE86IG9wdGltaXplISEKICAgICAgdmFyIHN0ciA9ICcnOwogICAgICB0aGlzLl9wYXRoLmZvckVhY2goZnVuY3Rpb24gKHZhbHVlLCBpbmRleCkgewogICAgICAgIGlmIChpbmRleCA9PT0gMCkgewogICAgICAgICAgc3RyID0gdmFsdWUudG9TdHJpbmcoKTsKICAgICAgICB9IGVsc2UgewogICAgICAgICAgc3RyICs9ICcuJyArIHZhbHVlLnRvU3RyaW5nKCk7CiAgICAgICAgfQogICAgICB9KTsKCiAgICAgIHJldHVybiBzdHI7CiAgICB9CiAgfV0pOwoKICByZXR1cm4gUGF0aDsKfSkoKTsKCnZhciBBcnJheUluZGV4ID0gKGZ1bmN0aW9uICgpIHsKICBmdW5jdGlvbiBBcnJheUluZGV4KG9iaiwgaWR4KSB7CiAgICBfY2xhc3NDYWxsQ2hlY2sodGhpcywgQXJyYXlJbmRleCk7CgogICAgdGhpcy5vYmogPSBvYmo7CiAgICB0aGlzLmlkeCA9IGlkeDsKICB9CgogIF9jcmVhdGVDbGFzcyhBcnJheUluZGV4LCBbewogICAga2V5OiAndG9TdHJpbmcnLAogICAgdmFsdWU6IGZ1bmN0aW9uIHRvU3RyaW5nKCkgewogICAgICByZXR1cm4gdGhpcy5pZHgudG9TdHJpbmcoKTsKICAgIH0KICB9XSk7CgogIHJldHVybiBBcnJheUluZGV4Owp9KSgpOwoKdmFyIENoYW5nZVR5cGUgPSB7IFVQREFURTogJ3VwZGF0ZScsIEFERDogJ2FkZCcsIFJFTU9WRTogJ3JlbW92ZScgfTsKZXhwb3J0cy5DaGFuZ2VUeXBlID0gQ2hhbmdlVHlwZTsKdmFyIE9iamVjdFR5cGUgPSB7IE9CSkVDVDogJ29iamVjdCcsIEFSUkFZOiAnYXJyYXknIH07CmV4cG9ydHMuT2JqZWN0VHlwZSA9IE9iamVjdFR5cGU7CmV4cG9ydHNbJ2RlZmF1bHQnXSA9IFN5bmNPYmplY3Q7Cgp9LHsiLi4vdXRpbHMvdXRpbHMuanMiOjE1fV0sMTM6W2Z1bmN0aW9uKHJlcXVpcmUsbW9kdWxlLGV4cG9ydHMpewondXNlIHN0cmljdCc7CgpPYmplY3QuZGVmaW5lUHJvcGVydHkoZXhwb3J0cywgJ19fZXNNb2R1bGUnLCB7CiAgdmFsdWU6IHRydWUKfSk7Cgp2YXIgX2NyZWF0ZUNsYXNzID0gKGZ1bmN0aW9uICgpIHsgZnVuY3Rpb24gZGVmaW5lUHJvcGVydGllcyh0YXJnZXQsIHByb3BzKSB7IGZvciAodmFyIGkgPSAwOyBpIDwgcHJvcHMubGVuZ3RoOyBpKyspIHsgdmFyIGRlc2NyaXB0b3IgPSBwcm9wc1tpXTsgZGVzY3JpcHRvci5lbnVtZXJhYmxlID0gZGVzY3JpcHRvci5lbnVtZXJhYmxlIHx8IGZhbHNlOyBkZXNjcmlwdG9yLmNvbmZpZ3VyYWJsZSA9IHRydWU7IGlmICgndmFsdWUnIGluIGRlc2NyaXB0b3IpIGRlc2NyaXB0b3Iud3JpdGFibGUgPSB0cnVlOyBPYmplY3QuZGVmaW5lUHJvcGVydHkodGFyZ2V0LCBkZXNjcmlwdG9yLmtleSwgZGVzY3JpcHRvcik7IH0gfSByZXR1cm4gZnVuY3Rpb24gKENvbnN0cnVjdG9yLCBwcm90b1Byb3BzLCBzdGF0aWNQcm9wcykgeyBpZiAocHJvdG9Qcm9wcykgZGVmaW5lUHJvcGVydGllcyhDb25zdHJ1Y3Rvci5wcm90b3R5cGUsIHByb3RvUHJvcHMpOyBpZiAoc3RhdGljUHJvcHMpIGRlZmluZVByb3BlcnRpZXMoQ29uc3RydWN0b3IsIHN0YXRpY1Byb3BzKTsgcmV0dXJuIENvbnN0cnVjdG9yOyB9OyB9KSgpOwoKZnVuY3Rpb24gX2ludGVyb3BSZXF1aXJlRGVmYXVsdChvYmopIHsgcmV0dXJuIG9iaiAmJiBvYmouX19lc01vZHVsZSA/IG9iaiA6IHsgJ2RlZmF1bHQnOiBvYmogfTsgfQoKZnVuY3Rpb24gX2NsYXNzQ2FsbENoZWNrKGluc3RhbmNlLCBDb25zdHJ1Y3RvcikgeyBpZiAoIShpbnN0YW5jZSBpbnN0YW5jZW9mIENvbnN0cnVjdG9yKSkgeyB0aHJvdyBuZXcgVHlwZUVycm9yKCdDYW5ub3QgY2FsbCBhIGNsYXNzIGFzIGEgZnVuY3Rpb24nKTsgfSB9Cgp2YXIgX0RhdGFPYmplY3RSZXBvcnRlciA9IHJlcXVpcmUoJy4vRGF0YU9iamVjdFJlcG9ydGVyJyk7Cgp2YXIgX0RhdGFPYmplY3RSZXBvcnRlcjIgPSBfaW50ZXJvcFJlcXVpcmVEZWZhdWx0KF9EYXRhT2JqZWN0UmVwb3J0ZXIpOwoKdmFyIF9EYXRhT2JqZWN0T2JzZXJ2ZXIgPSByZXF1aXJlKCcuL0RhdGFPYmplY3RPYnNlcnZlcicpOwoKdmFyIF9EYXRhT2JqZWN0T2JzZXJ2ZXIyID0gX2ludGVyb3BSZXF1aXJlRGVmYXVsdChfRGF0YU9iamVjdE9ic2VydmVyKTsKCnZhciBfRGF0YVByb3Zpc2lvbmFsID0gcmVxdWlyZSgnLi9EYXRhUHJvdmlzaW9uYWwnKTsKCnZhciBfRGF0YVByb3Zpc2lvbmFsMiA9IF9pbnRlcm9wUmVxdWlyZURlZmF1bHQoX0RhdGFQcm92aXNpb25hbCk7CgovKioKICogQGF1dGhvciBtaWNhZWxwZWRyb3NhQGdtYWlsLmNvbQogKiBDbGllbnQgQVBJIFN5bmNyb25pemF0aW9uIHN5c3RlbS4KICovCgp2YXIgU3luY2hlciA9IChmdW5jdGlvbiAoKSB7CiAgLyogcHJpdmF0ZQogIF9vd25lcjogVVJMCiAgX2J1czogTWluaUJ1cwogICBfc3ViVVJMOiBVUkwKICAgX3JlcG9ydGVyczogPHVybDogRGF0YU9iamVjdFJlcG9ydGVyPgogIF9vYnNlcnZlcnM6IDx1cmw6IERhdGFPYmplY3RPYnNlcnZlcj4KICBfcHJvdmlzaW9uYWxzOiA8dXJsOiBEYXRhUHJvdmlzaW9uYWw+CiAgIC0tLS1ldmVudCBoYW5kbGVycy0tLS0KICBfb25Ob3RpZmljYXRpb25IYW5kbGVyOiAoZXZlbnQpID0+IHZvaWQKICAqLwoKICAvKioKICAgKiBDb25zdHJ1Y3RvciB0aGF0IHNob3VsZCBiZSB1c2VkIGJ5IHRoZSBIeXBlcnR5IG93bmVyCiAgICogQHBhcmFtIHtIeXBlcnR5VVJMfSBvd25lciAtIEh5cGVydHkgVVJMIG93bmVyCiAgICogQHBhcmFtIHtNaW5pQnVzfSBidXMgLSBUaGUgaW50ZXJuYWwgc2FuZGJveCBNaW5pQnVzIHVzZWQgYnkgdGhlIEh5cGVydHkKICAgKiBAcGFyYW0ge0pTT059IGNvbmZpZyAtIFRoZSBvbmx5IHJlcXVpcmVkIGZpZWxkIGZvciBub3cgaXMgcnVudGltZVVSTAogICAqLwoKICBmdW5jdGlvbiBTeW5jaGVyKG93bmVyLCBidXMsIGNvbmZpZykgewogICAgX2NsYXNzQ2FsbENoZWNrKHRoaXMsIFN5bmNoZXIpOwoKICAgIHZhciBfdGhpcyA9IHRoaXM7CgogICAgX3RoaXMuX293bmVyID0gb3duZXI7CiAgICBfdGhpcy5fYnVzID0gYnVzOwoKICAgIF90aGlzLl9zdWJVUkwgPSBjb25maWcucnVudGltZVVSTCArICcvc20nOwoKICAgIF90aGlzLl9yZXBvcnRlcnMgPSB7fTsKICAgIF90aGlzLl9vYnNlcnZlcnMgPSB7fTsKICAgIF90aGlzLl9wcm92aXNpb25hbHMgPSB7fTsKCiAgICBidXMuYWRkTGlzdGVuZXIob3duZXIsIGZ1bmN0aW9uIChtc2cpIHsKICAgICAgY29uc29sZS5sb2coJ1N5bmNoZXItUkNWOiAnLCBtc2cpOwogICAgICBzd2l0Y2ggKG1zZy50eXBlKSB7CiAgICAgICAgY2FzZSAnZm9yd2FyZCc6CiAgICAgICAgICBfdGhpcy5fb25Gb3J3YXJkKG1zZyk7YnJlYWs7CiAgICAgICAgY2FzZSAnY3JlYXRlJzoKICAgICAgICAgIF90aGlzLl9vblJlbW90ZUNyZWF0ZShtc2cpO2JyZWFrOwogICAgICB9CiAgICB9KTsKICB9CgogIC8qKgogICAqIFRoZSBvd25lciBvZiB0aGUgU3luY2hlciBhbmQgYWxsIGNyZWF0ZWQgcmVwb3J0ZXJzLgogICAqIEB0eXBlIHtIeXBlcnR5VVJMfQogICAqLwoKICBfY3JlYXRlQ2xhc3MoU3luY2hlciwgW3sKICAgIGtleTogJ2NyZWF0ZScsCgogICAgLyoqCiAgICAgKiBSZXF1ZXN0IGEgRGF0YU9iamVjdFJlcG9ydGVyIGNyZWF0aW9uLiBUaGUgVVJMIHdpbGwgYmUgYmUgcmVxdWVzdGVkIGJ5IHRoZSBhbGxvY2F0aW9uIG1lY2hhbmlzbS4KICAgICAqIEBwYXJhbSAge1NjaGVtYVVSTH0gc2NoZW1hIC0gVVJMIG9mIHRoZSBvYmplY3QgZGVzY3JpcHRvcgogICAgICogQHBhcmFtICB7SHlwZXJ0eVVSTFtdfSBvYnNlcnZlcnMgLSBMaXN0IG9mIGh5cGVydGllcyB0aGF0IGFyZSBwcmUtYXV0aG9yaXplZCBmb3Igc3Vic2NyaXB0aW9uCiAgICAgKiBAcGFyYW0gIHtKU09OfSBpbml0aWFsRGF0YSAtIEluaXRpYWwgZGF0YSBvZiB0aGUgcmVwb3J0ZXIKICAgICAqIEByZXR1cm4ge1Byb21pc2U8RGF0YU9iamVjdFJlcG9ydGVyPn0gUmV0dXJuIFByb21pc2UgdG8gYSBuZXcgUmVwb3J0ZXIuIFRoZSByZXBvcnRlciBjYW4gYmUgYWNjZXB0ZWQgb3IgcmVqZWN0ZWQgYnkgdGhlIFBFUAogICAgICovCiAgICB2YWx1ZTogZnVuY3Rpb24gY3JlYXRlKHNjaGVtYSwgb2JzZXJ2ZXJzLCBpbml0aWFsRGF0YSkgewogICAgICB2YXIgX3RoaXMgPSB0aGlzOwoKICAgICAgdmFyIHJlcXVlc3RNc2cgPSB7CiAgICAgICAgdHlwZTogJ2NyZWF0ZScsIGZyb206IF90aGlzLl9vd25lciwgdG86IF90aGlzLl9zdWJVUkwsCiAgICAgICAgYm9keTogeyBzY2hlbWE6IHNjaGVtYSwgdmFsdWU6IGluaXRpYWxEYXRhLCBhdXRob3Jpc2U6IG9ic2VydmVycyB9CiAgICAgIH07CgogICAgICByZXR1cm4gbmV3IFByb21pc2UoZnVuY3Rpb24gKHJlc29sdmUsIHJlamVjdCkgewogICAgICAgIC8vcmVxdWVzdCBjcmVhdGUgdG8gdGhlIEFsbG9jYXRpb24gc3lzdGVtPyBDYW4gYmUgcmVqZWN0ZWQgYnkgdGhlIFBvbGljeUVuZ2luZS4KICAgICAgICBfdGhpcy5fYnVzLnBvc3RNZXNzYWdlKHJlcXVlc3RNc2csIGZ1bmN0aW9uIChyZXBseSkgewogICAgICAgICAgY29uc29sZS5sb2coJ2NyZWF0ZS1yZXNwb25zZTogJywgcmVwbHkpOwogICAgICAgICAgaWYgKHJlcGx5LmJvZHkuY29kZSA9PT0gMjAwKSB7CiAgICAgICAgICAgIHZhciBvYmpVUkwgPSByZXBseS5ib2R5LnJlc291cmNlOwoKICAgICAgICAgICAgLy9yZXBvcnRlciBjcmVhdGlvbiBhY2NlcHRlZAogICAgICAgICAgICB2YXIgbmV3T2JqID0gbmV3IF9EYXRhT2JqZWN0UmVwb3J0ZXIyWydkZWZhdWx0J10oX3RoaXMuX293bmVyLCBvYmpVUkwsIHNjaGVtYSwgX3RoaXMuX2J1cywgJ29uJywgaW5pdGlhbERhdGEsIHJlcGx5LmJvZHkuY2hpbGRyZW4pOwogICAgICAgICAgICBfdGhpcy5fcmVwb3J0ZXJzW29ialVSTF0gPSBuZXdPYmo7CgogICAgICAgICAgICByZXNvbHZlKG5ld09iaik7CiAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAvL3JlcG9ydGVyIGNyZWF0aW9uIHJlamVjdGVkCiAgICAgICAgICAgIHJlamVjdChyZXBseS5ib2R5LmRlc2MpOwogICAgICAgICAgfQogICAgICAgIH0pOwogICAgICB9KTsKICAgIH0KCiAgICAvKioKICAgICAqIFJlcXVlc3QgYSBzdWJzY3JpcHRpb24gdG8gYW4gZXhpc3RlbnQgb2JqZWN0LgogICAgICogQHBhcmFtIHtTY2hlbWFVUkx9IHNjaGVtYSAtIFVSTCBvZiB0aGUgb2JqZWN0IGRlc2NyaXB0b3IKICAgICAqIEBwYXJhbSB7T2JqZWN0VVJMfSBvYmpVUkwgLSBBZGRyZXNzIG9mIHRoZSBleGlzdGVudCByZXBvcnRlciBvYmplY3QKICAgICAqIEByZXR1cm4ge1Byb21pc2U8RGF0YU9iamVjdE9ic2VydmVyPn0gUmV0dXJuIFByb21pc2UgdG8gYSBuZXcgb2JzZXJ2ZXIuCiAgICAgKi8KICB9LCB7CiAgICBrZXk6ICdzdWJzY3JpYmUnLAogICAgdmFsdWU6IGZ1bmN0aW9uIHN1YnNjcmliZShzY2hlbWEsIG9ialVSTCkgewogICAgICB2YXIgX3RoaXMgPSB0aGlzOwoKICAgICAgLy9UT0RPOiB2YWxpZGF0ZSBpZiBzdWJzY3JpcHRpb24gYWxyZWFkeSBleGlzdHMgPwogICAgICB2YXIgc3Vic2NyaWJlTXNnID0gewogICAgICAgIHR5cGU6ICdzdWJzY3JpYmUnLCBmcm9tOiBfdGhpcy5fb3duZXIsIHRvOiBfdGhpcy5fc3ViVVJMLAogICAgICAgIGJvZHk6IHsgc2NoZW1hOiBzY2hlbWEsIHJlc291cmNlOiBvYmpVUkwgfQogICAgICB9OwoKICAgICAgcmV0dXJuIG5ldyBQcm9taXNlKGZ1bmN0aW9uIChyZXNvbHZlLCByZWplY3QpIHsKICAgICAgICAvL3JlcXVlc3Qgc3Vic2NyaXB0aW9uCiAgICAgICAgX3RoaXMuX2J1cy5wb3N0TWVzc2FnZShzdWJzY3JpYmVNc2csIGZ1bmN0aW9uIChyZXBseSkgewogICAgICAgICAgY29uc29sZS5sb2coJ3N1YnNjcmliZS1yZXNwb25zZTogJywgcmVwbHkpOwogICAgICAgICAgdmFyIG5ld1Byb3Zpc2lvbmFsID0gX3RoaXMuX3Byb3Zpc2lvbmFsc1tvYmpVUkxdOwogICAgICAgICAgZGVsZXRlIF90aGlzLl9wcm92aXNpb25hbHNbb2JqVVJMXTsKICAgICAgICAgIGlmIChuZXdQcm92aXNpb25hbCkgbmV3UHJvdmlzaW9uYWwucmVsZWFzZSgpOwoKICAgICAgICAgIGlmIChyZXBseS5ib2R5LmNvZGUgPCAyMDApIHsKICAgICAgICAgICAgbmV3UHJvdmlzaW9uYWwgPSBuZXcgX0RhdGFQcm92aXNpb25hbDJbJ2RlZmF1bHQnXShfdGhpcy5fb3duZXIsIG9ialVSTCwgX3RoaXMuX2J1cywgcmVwbHkuYm9keS5jaGlsZHJlblJlc291cmNlcyk7CiAgICAgICAgICAgIF90aGlzLl9wcm92aXNpb25hbHNbb2JqVVJMXSA9IG5ld1Byb3Zpc2lvbmFsOwogICAgICAgICAgfSBlbHNlIGlmIChyZXBseS5ib2R5LmNvZGUgPT09IDIwMCkgewogICAgICAgICAgICB2YXIgbmV3T2JqID0gbmV3IF9EYXRhT2JqZWN0T2JzZXJ2ZXIyWydkZWZhdWx0J10oX3RoaXMuX293bmVyLCBvYmpVUkwsIHNjaGVtYSwgX3RoaXMuX2J1cywgJ29uJywgcmVwbHkuYm9keS52YWx1ZSwgbmV3UHJvdmlzaW9uYWwuY2hpbGRyZW4pOwoKICAgICAgICAgICAgcmVzb2x2ZShuZXdPYmopOwogICAgICAgICAgICBuZXdQcm92aXNpb25hbC5hcHBseShuZXdPYmopOwogICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgcmVqZWN0KHJlcGx5LmJvZHkuZGVzYyk7CiAgICAgICAgICB9CiAgICAgICAgfSk7CiAgICAgIH0pOwogICAgfQoKICAgIC8qKgogICAgICogU2V0dXAgdGhlIGNhbGxiYWNrIHRvIHByb2Nlc3MgY3JlYXRlIGFuZCBkZWxldGUgZXZlbnRzIG9mIHJlbW92ZSBSZXBvcnRlciBvYmplY3RzLgogICAgICogVGhpcyBpcyByZWxlYXRlZCB0byB0aGUgbWVzc2FnZW5zIHNlbnQgYnkgY3JlYXRlIHRvIHRoZSBvYnNlcnZlcnMgSHlwZXJ0eSBhcnJheS4KICAgICAqIEBwYXJhbSB7ZnVuY3Rpb24oZXZlbnQ6IE1zZ0V2ZW50KX0gY2FsbGJhY2sKICAgICAqLwogIH0sIHsKICAgIGtleTogJ29uTm90aWZpY2F0aW9uJywKICAgIHZhbHVlOiBmdW5jdGlvbiBvbk5vdGlmaWNhdGlvbihjYWxsYmFjaykgewogICAgICB0aGlzLl9vbk5vdGlmaWNhdGlvbkhhbmRsZXIgPSBjYWxsYmFjazsKICAgIH0KICB9LCB7CiAgICBrZXk6ICdfb25Gb3J3YXJkJywKICAgIHZhbHVlOiBmdW5jdGlvbiBfb25Gb3J3YXJkKG1zZykgewogICAgICB2YXIgX3RoaXMgPSB0aGlzOwoKICAgICAgdmFyIHJlcG9ydGVyID0gX3RoaXMuX3JlcG9ydGVyc1ttc2cuYm9keS50b107CiAgICAgIHJlcG9ydGVyLl9vbkZvcndhcmQobXNnKTsKICAgIH0KICB9LCB7CiAgICBrZXk6ICdfb25SZW1vdGVDcmVhdGUnLAogICAgdmFsdWU6IGZ1bmN0aW9uIF9vblJlbW90ZUNyZWF0ZShtc2cpIHsKICAgICAgdmFyIF90aGlzID0gdGhpczsKCiAgICAgIHZhciBldmVudCA9IHsKICAgICAgICB0eXBlOiBtc2cudHlwZSwKICAgICAgICBmcm9tOiBtc2cuZnJvbSwKICAgICAgICB1cmw6IG1zZy5ib2R5LnJlc291cmNlLAogICAgICAgIHNjaGVtYTogbXNnLmJvZHkuc2NoZW1hLAogICAgICAgIHZhbHVlOiBtc2cuYm9keS52YWx1ZSwKICAgICAgICBpZGVudGl0eTogbXNnLmJvZHkuaWRUb2tlbiwKCiAgICAgICAgYWNrOiBmdW5jdGlvbiBhY2sodHlwZSkgewogICAgICAgICAgdmFyIGxUeXBlID0gMjAwOwogICAgICAgICAgaWYgKHR5cGUpIHsKICAgICAgICAgICAgbFR5cGUgPSB0eXBlOwogICAgICAgICAgfQoKICAgICAgICAgIC8vc2VuZCBhY2sgcmVzcG9uc2UgbWVzc2FnZQogICAgICAgICAgX3RoaXMuX2J1cy5wb3N0TWVzc2FnZSh7CiAgICAgICAgICAgIGlkOiBtc2cuaWQsIHR5cGU6ICdyZXNwb25zZScsIGZyb206IG1zZy50bywgdG86IG1zZy5mcm9tLAogICAgICAgICAgICBib2R5OiB7IGNvZGU6IGxUeXBlLCBzb3VyY2U6IG1zZy5ib2R5LnJlc291cmNlIH0KICAgICAgICAgIH0pOwogICAgICAgIH0KICAgICAgfTsKCiAgICAgIGlmIChfdGhpcy5fb25Ob3RpZmljYXRpb25IYW5kbGVyKSB7CiAgICAgICAgX3RoaXMuX29uTm90aWZpY2F0aW9uSGFuZGxlcihldmVudCk7CiAgICAgIH0KICAgIH0KICB9LCB7CiAgICBrZXk6ICdvd25lcicsCiAgICBnZXQ6IGZ1bmN0aW9uIGdldCgpIHsKICAgICAgcmV0dXJuIHRoaXMuX293bmVyOwogICAgfQoKICAgIC8qKgogICAgICogQWxsIG93bmVkIHJlcG9ydGVycywgdGhlIG9uZXMgdGhhdCB3ZXJlIGNyZWF0ZWQgYnkgYSBjcmVhdGUKICAgICAqIEB0eXBlIHtPYmplY3Q8VVJMLCBEYXRhT2JqZWN0UmVwb3J0ZXI+fQogICAgICovCiAgfSwgewogICAga2V5OiAncmVwb3J0ZXJzJywKICAgIGdldDogZnVuY3Rpb24gZ2V0KCkgewogICAgICByZXR1cm4gdGhpcy5fcmVwb3J0ZXJzOwogICAgfQoKICAgIC8qKgogICAgICogQWxsIG93bmVkIG9ic2VydmVycywgdGhlIG9uZXMgdGhhdCB3ZXJlIGNyZWF0ZWQgYnkgYSBsb2NhbCBzdWJzY3JpcHRpb24KICAgICAqIEB0eXBlIHtPYmplY3Q8VVJMLCBEYXRhT2JqZWN0T2JzZXJ2ZXI+fQogICAgICovCiAgfSwgewogICAga2V5OiAnb2JzZXJ2ZXJzJywKICAgIGdldDogZnVuY3Rpb24gZ2V0KCkgewogICAgICByZXR1cm4gdGhpcy5fb2JzZXJ2ZXJzOwogICAgfQogIH1dKTsKCiAgcmV0dXJuIFN5bmNoZXI7Cn0pKCk7CgpleHBvcnRzWydkZWZhdWx0J10gPSBTeW5jaGVyOwptb2R1bGUuZXhwb3J0cyA9IGV4cG9ydHNbJ2RlZmF1bHQnXTsKCn0seyIuL0RhdGFPYmplY3RPYnNlcnZlciI6OSwiLi9EYXRhT2JqZWN0UmVwb3J0ZXIiOjEwLCIuL0RhdGFQcm92aXNpb25hbCI6MTF9XSwxNDpbZnVuY3Rpb24ocmVxdWlyZSxtb2R1bGUsZXhwb3J0cyl7Ci8qKgogKiBFdmVudEVtaXR0ZXIKICogQWxsIGNsYXNzZXMgd2hpY2ggZXh0ZW5kcyB0aGlzLCBjYW4gaGF2ZSBhZGRFdmVudExpc3RlbmVyIGFuZCB0cmlnZ2VyIGV2ZW50czsKICovCiJ1c2Ugc3RyaWN0IjsKCk9iamVjdC5kZWZpbmVQcm9wZXJ0eShleHBvcnRzLCAiX19lc01vZHVsZSIsIHsKICB2YWx1ZTogdHJ1ZQp9KTsKCnZhciBfY3JlYXRlQ2xhc3MgPSAoZnVuY3Rpb24gKCkgeyBmdW5jdGlvbiBkZWZpbmVQcm9wZXJ0aWVzKHRhcmdldCwgcHJvcHMpIHsgZm9yICh2YXIgaSA9IDA7IGkgPCBwcm9wcy5sZW5ndGg7IGkrKykgeyB2YXIgZGVzY3JpcHRvciA9IHByb3BzW2ldOyBkZXNjcmlwdG9yLmVudW1lcmFibGUgPSBkZXNjcmlwdG9yLmVudW1lcmFibGUgfHwgZmFsc2U7IGRlc2NyaXB0b3IuY29uZmlndXJhYmxlID0gdHJ1ZTsgaWYgKCJ2YWx1ZSIgaW4gZGVzY3JpcHRvcikgZGVzY3JpcHRvci53cml0YWJsZSA9IHRydWU7IE9iamVjdC5kZWZpbmVQcm9wZXJ0eSh0YXJnZXQsIGRlc2NyaXB0b3Iua2V5LCBkZXNjcmlwdG9yKTsgfSB9IHJldHVybiBmdW5jdGlvbiAoQ29uc3RydWN0b3IsIHByb3RvUHJvcHMsIHN0YXRpY1Byb3BzKSB7IGlmIChwcm90b1Byb3BzKSBkZWZpbmVQcm9wZXJ0aWVzKENvbnN0cnVjdG9yLnByb3RvdHlwZSwgcHJvdG9Qcm9wcyk7IGlmIChzdGF0aWNQcm9wcykgZGVmaW5lUHJvcGVydGllcyhDb25zdHJ1Y3Rvciwgc3RhdGljUHJvcHMpOyByZXR1cm4gQ29uc3RydWN0b3I7IH07IH0pKCk7CgpmdW5jdGlvbiBfY2xhc3NDYWxsQ2hlY2soaW5zdGFuY2UsIENvbnN0cnVjdG9yKSB7IGlmICghKGluc3RhbmNlIGluc3RhbmNlb2YgQ29uc3RydWN0b3IpKSB7IHRocm93IG5ldyBUeXBlRXJyb3IoIkNhbm5vdCBjYWxsIGEgY2xhc3MgYXMgYSBmdW5jdGlvbiIpOyB9IH0KCnZhciBFdmVudEVtaXR0ZXIgPSAoZnVuY3Rpb24gKCkgewogIGZ1bmN0aW9uIEV2ZW50RW1pdHRlcigpIHsKICAgIF9jbGFzc0NhbGxDaGVjayh0aGlzLCBFdmVudEVtaXR0ZXIpOwogIH0KCiAgX2NyZWF0ZUNsYXNzKEV2ZW50RW1pdHRlciwgW3sKICAgIGtleTogImFkZEV2ZW50TGlzdGVuZXIiLAoKICAgIC8qKgogICAgICogYWRkRXZlbnRMaXN0ZW5lciBsaXN0ZW4gZm9yIGFuIGV2ZW50VHlwZQogICAgICogQHBhcmFtICB7c3RyaW5nfSAgICAgICAgIGV2ZW50VHlwZSAtIGxpc3RlbmluZyBmb3IgdGhpcyB0eXBlIG9mIGV2ZW50CiAgICAgKiBAcGFyYW0gIHtGdW5jdGlvbn0gICAgICAgY2IgICAgICAgIC0gY2FsbGJhY2sgZnVuY3Rpb24gd2lsbCBiZSBleGVjdXRlZCB3aGVuIHRoZSBldmVudCBpdCBpcyBpbnZva2VkCiAgICAgKi8KICAgIHZhbHVlOiBmdW5jdGlvbiBhZGRFdmVudExpc3RlbmVyKGV2ZW50VHlwZSwgY2IpIHsKICAgICAgdmFyIF90aGlzID0gdGhpczsKICAgICAgX3RoaXNbZXZlbnRUeXBlXSA9IGNiOwogICAgfQoKICAgIC8qKgogICAgICogSW52b2tlIHRoZSBldmVudFR5cGUKICAgICAqIEBwYXJhbSAge3N0cmluZ30gZXZlbnRUeXBlIC0gZXZlbnQgd2lsbCBiZSBpbnZva2VkCiAgICAgKiBAcGFyYW0gIHtvYmplY3R9IHBhcmFtcyAtIHBhcmFtZXRlcnMgd2lsbCBiZSBwYXNzZWQgdG8gdGhlIGFkZEV2ZW50TGlzdGVuZXIKICAgICAqLwogIH0sIHsKICAgIGtleTogInRyaWdnZXIiLAogICAgdmFsdWU6IGZ1bmN0aW9uIHRyaWdnZXIoZXZlbnRUeXBlLCBwYXJhbXMpIHsKICAgICAgdmFyIF90aGlzID0gdGhpczsKCiAgICAgIGlmIChfdGhpc1tldmVudFR5cGVdKSB7CiAgICAgICAgX3RoaXNbZXZlbnRUeXBlXShwYXJhbXMpOwogICAgICB9CiAgICB9CiAgfV0pOwoKICByZXR1cm4gRXZlbnRFbWl0dGVyOwp9KSgpOwoKZXhwb3J0c1siZGVmYXVsdCJdID0gRXZlbnRFbWl0dGVyOwptb2R1bGUuZXhwb3J0cyA9IGV4cG9ydHNbImRlZmF1bHQiXTsKCn0se31dLDE1OltmdW5jdGlvbihyZXF1aXJlLG1vZHVsZSxleHBvcnRzKXsKLyoqCiAqIFN1cHBvcnQgbW9kdWxlIHdpdGggc29tZSBmdW5jdGlvbnMgd2lsbCBiZSB1c2VmdWwKICogQG1vZHVsZSB1dGlscwogKi8KCi8qKgogKiBAdHlwZWRlZiBkaXZpZGVVUkwKICogQHR5cGUgT2JqZWN0CiAqIEBwcm9wZXJ0eSB7c3RyaW5nfSB0eXBlIFRoZSB0eXBlIG9mIFVSTAogKiBAcHJvcGVydHkge3N0cmluZ30gZG9tYWluIFRoZSBkb21haW4gb2YgVVJMCiAqIEBwcm9wZXJ0eSB7c3RyaW5nfSBpZGVudGl0eSBUaGUgaWRlbnRpdHkgb2YgVVJMCiAqLwoKLyoqCiAqIERpdmlkZSBhbiB1cmwgaW4gdHlwZSwgZG9tYWluIGFuZCBpZGVudGl0eQogKiBAcGFyYW0gIHtVUkwuVVJMfSB1cmwgLSB1cmwgYWRkcmVzcwogKiBAcmV0dXJuIHtkaXZpZGVVUkx9IHRoZSByZXN1bHQgb2YgZGl2aWRlVVJMCiAqLwondXNlIHN0cmljdCc7CgpPYmplY3QuZGVmaW5lUHJvcGVydHkoZXhwb3J0cywgJ19fZXNNb2R1bGUnLCB7CiAgdmFsdWU6IHRydWUKfSk7CmV4cG9ydHMuZGl2aWRlVVJMID0gZGl2aWRlVVJMOwpleHBvcnRzLmRlZXBDbG9uZSA9IGRlZXBDbG9uZTsKCmZ1bmN0aW9uIGRpdmlkZVVSTCh1cmwpIHsKCiAgLy8gbGV0IHJlID0gLyhbYS16QS1aLV0qKT86XC9cLyg/OlwuKT8oWy1hLXpBLVowLTlAOiUuX1wrfiM9XXsyLDI1Nn1cLlthLXpdezIsNn1cYikqKFwvW1wvXGRcd1wuLV0qKSooPzpbXD9dKSooLispKi9naTsKICB2YXIgcmUgPSAvKFthLXpBLVotXSopOlwvXC8oPzpcLik/KFstYS16QS1aMC05QDolLl9cK34jPV17MiwyNTZ9KShbLWEtekEtWjAtOUA6JS5fXCt+Iz1cL10qKS9naTsKICB2YXIgc3Vic3QgPSAnJDEsJDIsJDMnOwogIHZhciBwYXJ0cyA9IHVybC5yZXBsYWNlKHJlLCBzdWJzdCkuc3BsaXQoJywnKTsKICB2YXIgcmVzdWx0ID0gewogICAgdHlwZTogcGFydHNbMF0sCiAgICBkb21haW46IHBhcnRzWzFdLAogICAgaWRlbnRpdHk6IHBhcnRzWzJdCiAgfTsKCiAgcmV0dXJuIHJlc3VsdDsKfQoKLyoqCiAqIE1ha2UgYSBDT1BZIG9mIHRoZSBvcmlnaW5hbCBkYXRhCiAqIEBwYXJhbSAge09iamVjdH0gIG9iaiAtIG9iamVjdCB0byBiZSBjbG9uZWQKICogQHJldHVybiB7T2JqZWN0fQogKi8KCmZ1bmN0aW9uIGRlZXBDbG9uZShvYmopIHsKICAvL1RPRE86IHNpbXBsZSBidXQgaW5lZmZpY2llbnQgSlNPTiBkZWVwIGNsb25lLi4uCiAgcmV0dXJuIEpTT04ucGFyc2UoSlNPTi5zdHJpbmdpZnkob2JqKSk7Cn0KCn0se31dfSx7fSxbNF0pKDQpCn0pOw==",
      "sourceCodeClassname": "HypertyConnector",
      "encoding": "base64",
      "signature": ""
    },
    "cguid": 1,
    "type": "Hyperties",
    "version": "0.1",
    "description": "Description of HypertyConnector",
    "objectName": "HypertyConnector",
    "sourcePackageURL": "/sourcePackage",
    "language": "javascript",
    "signature": "",
    "messageSchemas": "",
    "dataObjects": [],
    "accessControlPolicy": "somePolicy"
  },
  "HypertyChat": {
    "sourcePackage": {
      "sourceCode": "KGZ1bmN0aW9uKGYpe2lmKHR5cGVvZiBleHBvcnRzPT09Im9iamVjdCImJnR5cGVvZiBtb2R1bGUhPT0idW5kZWZpbmVkIil7bW9kdWxlLmV4cG9ydHM9ZigpfWVsc2UgaWYodHlwZW9mIGRlZmluZT09PSJmdW5jdGlvbiImJmRlZmluZS5hbWQpe2RlZmluZShbXSxmKX1lbHNle3ZhciBnO2lmKHR5cGVvZiB3aW5kb3chPT0idW5kZWZpbmVkIil7Zz13aW5kb3d9ZWxzZSBpZih0eXBlb2YgZ2xvYmFsIT09InVuZGVmaW5lZCIpe2c9Z2xvYmFsfWVsc2UgaWYodHlwZW9mIHNlbGYhPT0idW5kZWZpbmVkIil7Zz1zZWxmfWVsc2V7Zz10aGlzfWcuYWN0aXZhdGUgPSBmKCl9fSkoZnVuY3Rpb24oKXt2YXIgZGVmaW5lLG1vZHVsZSxleHBvcnRzO3JldHVybiAoZnVuY3Rpb24gZSh0LG4scil7ZnVuY3Rpb24gcyhvLHUpe2lmKCFuW29dKXtpZighdFtvXSl7dmFyIGE9dHlwZW9mIHJlcXVpcmU9PSJmdW5jdGlvbiImJnJlcXVpcmU7aWYoIXUmJmEpcmV0dXJuIGEobywhMCk7aWYoaSlyZXR1cm4gaShvLCEwKTt2YXIgZj1uZXcgRXJyb3IoIkNhbm5vdCBmaW5kIG1vZHVsZSAnIitvKyInIik7dGhyb3cgZi5jb2RlPSJNT0RVTEVfTk9UX0ZPVU5EIixmfXZhciBsPW5bb109e2V4cG9ydHM6e319O3Rbb11bMF0uY2FsbChsLmV4cG9ydHMsZnVuY3Rpb24oZSl7dmFyIG49dFtvXVsxXVtlXTtyZXR1cm4gcyhuP246ZSl9LGwsbC5leHBvcnRzLGUsdCxuLHIpfXJldHVybiBuW29dLmV4cG9ydHN9dmFyIGk9dHlwZW9mIHJlcXVpcmU9PSJmdW5jdGlvbiImJnJlcXVpcmU7Zm9yKHZhciBvPTA7bzxyLmxlbmd0aDtvKyspcyhyW29dKTtyZXR1cm4gc30pKHsxOltmdW5jdGlvbihyZXF1aXJlLG1vZHVsZSxleHBvcnRzKXsKJ3VzZSBzdHJpY3QnOwoKT2JqZWN0LmRlZmluZVByb3BlcnR5KGV4cG9ydHMsICdfX2VzTW9kdWxlJywgewogIHZhbHVlOiB0cnVlCn0pOwoKdmFyIF9jcmVhdGVDbGFzcyA9IChmdW5jdGlvbiAoKSB7IGZ1bmN0aW9uIGRlZmluZVByb3BlcnRpZXModGFyZ2V0LCBwcm9wcykgeyBmb3IgKHZhciBpID0gMDsgaSA8IHByb3BzLmxlbmd0aDsgaSsrKSB7IHZhciBkZXNjcmlwdG9yID0gcHJvcHNbaV07IGRlc2NyaXB0b3IuZW51bWVyYWJsZSA9IGRlc2NyaXB0b3IuZW51bWVyYWJsZSB8fCBmYWxzZTsgZGVzY3JpcHRvci5jb25maWd1cmFibGUgPSB0cnVlOyBpZiAoJ3ZhbHVlJyBpbiBkZXNjcmlwdG9yKSBkZXNjcmlwdG9yLndyaXRhYmxlID0gdHJ1ZTsgT2JqZWN0LmRlZmluZVByb3BlcnR5KHRhcmdldCwgZGVzY3JpcHRvci5rZXksIGRlc2NyaXB0b3IpOyB9IH0gcmV0dXJuIGZ1bmN0aW9uIChDb25zdHJ1Y3RvciwgcHJvdG9Qcm9wcywgc3RhdGljUHJvcHMpIHsgaWYgKHByb3RvUHJvcHMpIGRlZmluZVByb3BlcnRpZXMoQ29uc3RydWN0b3IucHJvdG90eXBlLCBwcm90b1Byb3BzKTsgaWYgKHN0YXRpY1Byb3BzKSBkZWZpbmVQcm9wZXJ0aWVzKENvbnN0cnVjdG9yLCBzdGF0aWNQcm9wcyk7IHJldHVybiBDb25zdHJ1Y3RvcjsgfTsgfSkoKTsKCnZhciBfZ2V0ID0gZnVuY3Rpb24gZ2V0KF94LCBfeDIsIF94MykgeyB2YXIgX2FnYWluID0gdHJ1ZTsgX2Z1bmN0aW9uOiB3aGlsZSAoX2FnYWluKSB7IHZhciBvYmplY3QgPSBfeCwgcHJvcGVydHkgPSBfeDIsIHJlY2VpdmVyID0gX3gzOyBfYWdhaW4gPSBmYWxzZTsgaWYgKG9iamVjdCA9PT0gbnVsbCkgb2JqZWN0ID0gRnVuY3Rpb24ucHJvdG90eXBlOyB2YXIgZGVzYyA9IE9iamVjdC5nZXRPd25Qcm9wZXJ0eURlc2NyaXB0b3Iob2JqZWN0LCBwcm9wZXJ0eSk7IGlmIChkZXNjID09PSB1bmRlZmluZWQpIHsgdmFyIHBhcmVudCA9IE9iamVjdC5nZXRQcm90b3R5cGVPZihvYmplY3QpOyBpZiAocGFyZW50ID09PSBudWxsKSB7IHJldHVybiB1bmRlZmluZWQ7IH0gZWxzZSB7IF94ID0gcGFyZW50OyBfeDIgPSBwcm9wZXJ0eTsgX3gzID0gcmVjZWl2ZXI7IF9hZ2FpbiA9IHRydWU7IGRlc2MgPSBwYXJlbnQgPSB1bmRlZmluZWQ7IGNvbnRpbnVlIF9mdW5jdGlvbjsgfSB9IGVsc2UgaWYgKCd2YWx1ZScgaW4gZGVzYykgeyByZXR1cm4gZGVzYy52YWx1ZTsgfSBlbHNlIHsgdmFyIGdldHRlciA9IGRlc2MuZ2V0OyBpZiAoZ2V0dGVyID09PSB1bmRlZmluZWQpIHsgcmV0dXJuIHVuZGVmaW5lZDsgfSByZXR1cm4gZ2V0dGVyLmNhbGwocmVjZWl2ZXIpOyB9IH0gfTsKCmZ1bmN0aW9uIF9pbnRlcm9wUmVxdWlyZURlZmF1bHQob2JqKSB7IHJldHVybiBvYmogJiYgb2JqLl9fZXNNb2R1bGUgPyBvYmogOiB7ICdkZWZhdWx0Jzogb2JqIH07IH0KCmZ1bmN0aW9uIF9jbGFzc0NhbGxDaGVjayhpbnN0YW5jZSwgQ29uc3RydWN0b3IpIHsgaWYgKCEoaW5zdGFuY2UgaW5zdGFuY2VvZiBDb25zdHJ1Y3RvcikpIHsgdGhyb3cgbmV3IFR5cGVFcnJvcignQ2Fubm90IGNhbGwgYSBjbGFzcyBhcyBhIGZ1bmN0aW9uJyk7IH0gfQoKZnVuY3Rpb24gX2luaGVyaXRzKHN1YkNsYXNzLCBzdXBlckNsYXNzKSB7IGlmICh0eXBlb2Ygc3VwZXJDbGFzcyAhPT0gJ2Z1bmN0aW9uJyAmJiBzdXBlckNsYXNzICE9PSBudWxsKSB7IHRocm93IG5ldyBUeXBlRXJyb3IoJ1N1cGVyIGV4cHJlc3Npb24gbXVzdCBlaXRoZXIgYmUgbnVsbCBvciBhIGZ1bmN0aW9uLCBub3QgJyArIHR5cGVvZiBzdXBlckNsYXNzKTsgfSBzdWJDbGFzcy5wcm90b3R5cGUgPSBPYmplY3QuY3JlYXRlKHN1cGVyQ2xhc3MgJiYgc3VwZXJDbGFzcy5wcm90b3R5cGUsIHsgY29uc3RydWN0b3I6IHsgdmFsdWU6IHN1YkNsYXNzLCBlbnVtZXJhYmxlOiBmYWxzZSwgd3JpdGFibGU6IHRydWUsIGNvbmZpZ3VyYWJsZTogdHJ1ZSB9IH0pOyBpZiAoc3VwZXJDbGFzcykgT2JqZWN0LnNldFByb3RvdHlwZU9mID8gT2JqZWN0LnNldFByb3RvdHlwZU9mKHN1YkNsYXNzLCBzdXBlckNsYXNzKSA6IHN1YkNsYXNzLl9fcHJvdG9fXyA9IHN1cGVyQ2xhc3M7IH0KCnZhciBfdXRpbHNFdmVudEVtaXR0ZXIgPSByZXF1aXJlKCcuLi91dGlscy9FdmVudEVtaXR0ZXInKTsKCnZhciBfdXRpbHNFdmVudEVtaXR0ZXIyID0gX2ludGVyb3BSZXF1aXJlRGVmYXVsdChfdXRpbHNFdmVudEVtaXR0ZXIpOwoKdmFyIENoYXRHcm91cCA9IChmdW5jdGlvbiAoX0V2ZW50RW1pdHRlcikgewogIF9pbmhlcml0cyhDaGF0R3JvdXAsIF9FdmVudEVtaXR0ZXIpOwoKICBmdW5jdGlvbiBDaGF0R3JvdXAoc3luY2hlciwgaHlwZXJ0eURpc2NvdmVyeSkgewogICAgX2NsYXNzQ2FsbENoZWNrKHRoaXMsIENoYXRHcm91cCk7CgogICAgaWYgKCFzeW5jaGVyKSB0aHJvdyBFcnJvcignU3luY2hlciBpcyBhIG5lY2Vzc2FyeSBkZXBlbmRlY3knKTsKICAgIGlmICghaHlwZXJ0eURpc2NvdmVyeSkgdGhyb3cgRXJyb3IoJ0h5cGVydHkgZGlzY292ZXIgaXMgYSBuZWNlc3NhcnkgZGVwZW5kZWN5Jyk7CgogICAgX2dldChPYmplY3QuZ2V0UHJvdG90eXBlT2YoQ2hhdEdyb3VwLnByb3RvdHlwZSksICdjb25zdHJ1Y3RvcicsIHRoaXMpLmNhbGwodGhpcywgc3luY2hlciwgaHlwZXJ0eURpc2NvdmVyeSk7CgogICAgdmFyIF90aGlzID0gdGhpczsKICAgIF90aGlzLl9zeW5jaGVyID0gc3luY2hlcjsKICAgIF90aGlzLl9oeXBlcnR5RGlzY292ZXJ5ID0gaHlwZXJ0eURpc2NvdmVyeTsKCiAgICBfdGhpcy5fb2JqZWN0RGVzY1VSTCA9ICdoeXBlcnR5LWNhdGFsb2d1ZTovL2xvY2FsaG9zdC8ud2VsbC1rbm93bi9kYXRhc2NoZW1hcy9GYWtlRGF0YVNjaGVtYSc7CgogICAgc3luY2hlci5vbk5vdGlmaWNhdGlvbihmdW5jdGlvbiAoZXZlbnQpIHsKICAgICAgY29uc29sZS5sb2coJ05vdGlmaWNhdGlvbjogJywgZXZlbnQpOwogICAgICBfdGhpcy50cmlnZ2VyKCdoYXZlOm5ldzpub3RpZmljYXRpb24nLCBldmVudCk7CiAgICB9KTsKICB9CgogIF9jcmVhdGVDbGFzcyhDaGF0R3JvdXAsIFt7CiAgICBrZXk6ICdfcHJvY2Vzc0NoaWxkcmVuJywKICAgIHZhbHVlOiBmdW5jdGlvbiBfcHJvY2Vzc0NoaWxkcmVuKGNoaWxkcmVuKSB7CiAgICAgIGNvbnNvbGUuaW5mbygnb24gYWRkIGNoaWxkcmVuOiAnLCBjaGlsZHJlbik7CiAgICB9CgogICAgLyoqCiAgICAgKiBUaGlzIGZ1bmN0aW9uIGlzIHVzZWQgdG8gc2VuZCBhIGNoYXQgbWVzc2FnZS4KICAgICAqIEBwYXJhbSAge01lc3NhZ2V9IG1lc3NhZ2UgdGV4dCB0byBiZSBzZW5kCiAgICAgKi8KICB9LCB7CiAgICBrZXk6ICdzZW5kJywKICAgIHZhbHVlOiBmdW5jdGlvbiBzZW5kKG1lc3NhZ2UpIHsKICAgICAgY29uc29sZS5sb2cobWVzc2FnZSwgdGhpcyk7CiAgICAgIHZhciBfdGhpcyA9IHRoaXM7CiAgICAgIHZhciBkYXRhT2JqZWN0ID0gX3RoaXMuZGF0YU9iamVjdFJlcG9ydGVyID8gX3RoaXMuZGF0YU9iamVjdFJlcG9ydGVyIDogX3RoaXMuZGF0YU9iamVjdE9ic2VydmVyOwoKICAgICAgcmV0dXJuIG5ldyBQcm9taXNlKGZ1bmN0aW9uIChyZXNvbHZlLCByZWplY3QpIHsKCiAgICAgICAgZGF0YU9iamVjdC5hZGRDaGlsZHJlbignbWVzc2FnZScsIHsgbWVzc2FnZTogbWVzc2FnZSB9KS50aGVuKGZ1bmN0aW9uIChyZXN1bHQpIHsKICAgICAgICAgIGNvbnNvbGUuaW5mbyhyZXN1bHQpOwogICAgICAgICAgcmVzb2x2ZShyZXN1bHQpOwogICAgICAgIH0pWydjYXRjaCddKGZ1bmN0aW9uIChyZWFzb24pIHsKICAgICAgICAgIGNvbnNvbGUuZXJyb3IoJ1JlYXNvbjonLCByZWFzb24pOwogICAgICAgICAgcmVqZWN0KHJlYXNvbik7CiAgICAgICAgfSk7CiAgICAgIH0pOwogICAgfQoKICAgIC8qKgogICAgICogVGhpcyBmdW5jdGlvbiBpcyB1c2VkIHRvIGNsb3NlIGFuIGV4aXN0aW5nIEdyb3VwIENoYXQgaW5zdGFuY2UuCiAgICAgKgogICAgICovCiAgfSwgewogICAga2V5OiAnY2xvc2UnLAogICAgdmFsdWU6IGZ1bmN0aW9uIGNsb3NlKCkge30KICB9LCB7CiAgICBrZXk6ICdqb2luJywKICAgIHZhbHVlOiBmdW5jdGlvbiBqb2luKHJlc291cmNlKSB7CgogICAgICB2YXIgX3RoaXMgPSB0aGlzOwoKICAgICAgcmV0dXJuIG5ldyBQcm9taXNlKGZ1bmN0aW9uIChyZXNvbHZlLCByZWplY3QpIHsKCiAgICAgICAgX3RoaXMuYWRkUGFydGljaXBhbnQocmVzb3VyY2UpLnRoZW4oZnVuY3Rpb24gKHJlc3VsdCkgewogICAgICAgICAgcmVzb2x2ZSgnam9pbmVkOiAnLCByZXN1bHQpOwogICAgICAgIH0pWydjYXRjaCddKGZ1bmN0aW9uIChyZWFzb24pIHsKICAgICAgICAgIHJlamVjdChyZWFzb24pOwogICAgICAgIH0pOwogICAgICB9KTsKICAgIH0KCiAgICAvLyBUT0RPOiBpbXByb3ZlIHRoaXMgd2l0aCBhbiBpbnZpdGU7CiAgICAvKioKICAgICAqIFRoaXMgZnVuY3Rpb24gaXMgdXNlZCB0byBhZGQgLyBpbnZpdGUgbmV3IHBhcnRpY2lwYW50IG9uIGFuIGV4aXN0aW5nIEdyb3VwIENoYXQgaW5zdGFuY2UuCiAgICAgKiBAcmV0dXJuIHtQcm9taXNlfSBQcm9taXNlIHdpdGggdGhlIHN0YXR1cwogICAgICovCiAgfSwgewogICAga2V5OiAnYWRkUGFydGljaXBhbnQnLAogICAgdmFsdWU6IGZ1bmN0aW9uIGFkZFBhcnRpY2lwYW50KHJlc291cmNlKSB7CgogICAgICB2YXIgX3RoaXMgPSB0aGlzOwogICAgICB2YXIgc3luY2hlciA9IF90aGlzLl9zeW5jaGVyOwoKICAgICAgcmV0dXJuIG5ldyBQcm9taXNlKGZ1bmN0aW9uIChyZXNvbHZlLCByZWplY3QpIHsKCiAgICAgICAgY29uc29sZS5pbmZvKCctLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0gU3luY2hlciBzdWJzY3JpYmUgLS0tLS0tLS0tLS0tLS0tLS0tLS0tLSBcbicpOwogICAgICAgIGNvbnNvbGUuaW5mbyhyZXNvdXJjZSk7CiAgICAgICAgc3luY2hlci5zdWJzY3JpYmUoX3RoaXMuX29iamVjdERlc2NVUkwsIHJlc291cmNlKS50aGVuKGZ1bmN0aW9uIChkYXRhT2JqZWN0T2JzZXJ2ZXIpIHsKICAgICAgICAgIGNvbnNvbGUuaW5mbygnRGF0YSBPYmplY3QgT2JzZXJ2ZXI6ICcsIGRhdGFPYmplY3RPYnNlcnZlcik7CiAgICAgICAgICBfdGhpcy5kYXRhT2JqZWN0T2JzZXJ2ZXIgPSBkYXRhT2JqZWN0T2JzZXJ2ZXI7CiAgICAgICAgfSlbJ2NhdGNoJ10oZnVuY3Rpb24gKHJlYXNvbikgewogICAgICAgICAgcmVqZWN0KHJlYXNvbik7CiAgICAgICAgfSk7CiAgICAgIH0pOwogICAgfQoKICAgIC8qKgogICAgICogVGhpcyBmdW5jdGlvbiBpcyB1c2VkIHRvIHJlbW92ZSBhIHBhcnRpY2lwYW50IGZyb20gYW4gZXhpc3RpbmcgR3JvdXAgQ2hhdCBpbnN0YW5jZS4KICAgICAqIEByZXR1cm4ge1Byb21pc2V9IFByb21pc2Ugd2l0aCB0aGUgc3RhdHVzCiAgICAgKi8KICB9LCB7CiAgICBrZXk6ICdyZW1vdmVQYXJ0aWNpcGFudCcsCiAgICB2YWx1ZTogZnVuY3Rpb24gcmVtb3ZlUGFydGljaXBhbnQoKSB7CiAgICAgIHJldHVybiBuZXcgUHJvbWlzZShmdW5jdGlvbiAocmVzb2x2ZSwgcmVqZWN0KSB7CgogICAgICAgIHRyeSB7CiAgICAgICAgICByZXNvbHZlKCdwYXJ0aWNpcGFudCByZW1vdmVkJyk7CiAgICAgICAgfSBjYXRjaCAoZSkgewogICAgICAgICAgcmVqZWN0KCdyZW1vdmUgcGFydGljaXBhbnQgZmFpbCcpOwogICAgICAgIH0KICAgICAgfSk7CiAgICB9CgogICAgLyoqCiAgICAgKiBUaGlzIGZ1bmN0aW9uIGlzIHVzZWQgdG8gb3BlbiBhIEdyb3VwIENoYXQgaW5zdGFuY2UgdGhhdCB3YXMgcHJldmlvdXNseSBjbG9zZWQuCiAgICAgKiBAcmV0dXJuIHtbdHlwZV19IFtkZXNjcmlwdGlvbl0KICAgICAqLwogIH0sIHsKICAgIGtleTogJ29wZW4nLAogICAgdmFsdWU6IGZ1bmN0aW9uIG9wZW4oKSB7fQogIH0sIHsKICAgIGtleTogJ2RhdGFPYmplY3RSZXBvcnRlcicsCiAgICBzZXQ6IGZ1bmN0aW9uIHNldChkYXRhT2JqZWN0UmVwb3J0ZXIpIHsKCiAgICAgIGlmICghZGF0YU9iamVjdFJlcG9ydGVyKSB0aHJvdyBuZXcgRXJyb3IoJ1RoZSBkYXRhIG9iamVjdCByZXBvcnRlciBpcyBuZWNlc3NhcnkgcGFyYW1ldGVyJyk7CgogICAgICB2YXIgX3RoaXMgPSB0aGlzOwogICAgICBfdGhpcy5fZGF0YU9iamVjdFJlcG9ydGVyID0gZGF0YU9iamVjdFJlcG9ydGVyOwoKICAgICAgdmFyIGRhdGEgPSBkYXRhT2JqZWN0UmVwb3J0ZXIuZGF0YTsKCiAgICAgIGNvbnNvbGUuaW5mbygnU2V0IGRhdGEgb2JqZWN0IHJlcG9ydGVyOiAnLCBkYXRhKTsKCiAgICAgIGRhdGFPYmplY3RSZXBvcnRlci5vblN1YnNjcmlwdGlvbihmdW5jdGlvbiAoZXZlbnQpIHsKICAgICAgICBjb25zb2xlLmxvZygnU3Vic2NyaXB0aW9uOiAnLCBldmVudCk7CiAgICAgICAgZXZlbnQuYWNjZXB0KCk7CgogICAgICAgIF90aGlzLnRyaWdnZXIoJ3BhcnRpY2lwYW50OmFkZGVkJywgZXZlbnQudXJsKTsKICAgICAgfSk7CgogICAgICBkYXRhT2JqZWN0UmVwb3J0ZXIub25BZGRDaGlsZHJlbihfdGhpcy5fcHJvY2Vzc0NoaWxkcmVuKTsKICAgIH0sCiAgICBnZXQ6IGZ1bmN0aW9uIGdldCgpIHsKICAgICAgdmFyIF90aGlzID0gdGhpczsKICAgICAgcmV0dXJuIF90aGlzLl9kYXRhT2JqZWN0UmVwb3J0ZXI7CiAgICB9CiAgfSwgewogICAga2V5OiAnZGF0YU9iamVjdE9ic2VydmVyJywKICAgIHNldDogZnVuY3Rpb24gc2V0KGRhdGFPYmplY3RPYnNlcnZlcikgewogICAgICB2YXIgX3RoaXMgPSB0aGlzOwoKICAgICAgX3RoaXMuX2RhdGFPYmplY3RPYnNlcnZlciA9IGRhdGFPYmplY3RPYnNlcnZlcjsKCiAgICAgIGNvbnNvbGUubG9nKCdzZXQgZGF0YSBPYmplY3QgT2JzZXJ2ZXI6ICcsIGRhdGFPYmplY3RPYnNlcnZlcik7CgogICAgICBkYXRhT2JqZWN0T2JzZXJ2ZXIub25DaGFuZ2UoJyonLCBmdW5jdGlvbiAoZXZlbnQpIHsKICAgICAgICBjb25zb2xlLmluZm8oJ0NoYW5nZSBFdmVudDogJywgZXZlbnQpOwogICAgICB9KTsKCiAgICAgIGRhdGFPYmplY3RPYnNlcnZlci5vbkFkZENoaWxkcmVuKF90aGlzLl9wcm9jZXNzQ2hpbGRyZW4pOwogICAgfSwKICAgIGdldDogZnVuY3Rpb24gZ2V0KCkgewogICAgICB2YXIgX3RoaXMgPSB0aGlzOwogICAgICByZXR1cm4gX3RoaXMuX2RhdGFPYmplY3RPYnNlcnZlcjsKICAgIH0KICB9XSk7CgogIHJldHVybiBDaGF0R3JvdXA7Cn0pKF91dGlsc0V2ZW50RW1pdHRlcjJbJ2RlZmF1bHQnXSk7CgpleHBvcnRzWydkZWZhdWx0J10gPSBDaGF0R3JvdXA7Cm1vZHVsZS5leHBvcnRzID0gZXhwb3J0c1snZGVmYXVsdCddOwoKfSx7Ii4uL3V0aWxzL0V2ZW50RW1pdHRlciI6MTJ9XSwyOltmdW5jdGlvbihyZXF1aXJlLG1vZHVsZSxleHBvcnRzKXsKJ3VzZSBzdHJpY3QnOwoKT2JqZWN0LmRlZmluZVByb3BlcnR5KGV4cG9ydHMsICdfX2VzTW9kdWxlJywgewogIHZhbHVlOiB0cnVlCn0pOwoKZnVuY3Rpb24gX2NsYXNzQ2FsbENoZWNrKGluc3RhbmNlLCBDb25zdHJ1Y3RvcikgeyBpZiAoIShpbnN0YW5jZSBpbnN0YW5jZW9mIENvbnN0cnVjdG9yKSkgeyB0aHJvdyBuZXcgVHlwZUVycm9yKCdDYW5ub3QgY2FsbCBhIGNsYXNzIGFzIGEgZnVuY3Rpb24nKTsgfSB9Cgp2YXIgQ29tbXVuaWNhdGlvblN0YXR1cyA9IHsKICBPUEVOOiAnb3BlbicsCiAgUEVORElORzogJ3BlbmRpbmcnLAogIENMT1NFRDogJ2Nsb3NlZCcsCiAgUEFVU0VEOiAncGF1c2VkJywKICBGQUlMRUQ6ICdmYWlsZWQnCn07CgpleHBvcnRzLkNvbW11bmljYXRpb25TdGF0dXMgPSBDb21tdW5pY2F0aW9uU3RhdHVzOwoKdmFyIENvbW11bmljYXRpb24gPSBmdW5jdGlvbiBDb21tdW5pY2F0aW9uKCkgewogIF9jbGFzc0NhbGxDaGVjayh0aGlzLCBDb21tdW5pY2F0aW9uKTsKCiAgdmFyIF90aGlzID0gdGhpczsKCiAgX3RoaXMuaWQgPSAnJzsKICBfdGhpcy5ob3N0ID0gJyc7CiAgX3RoaXMub3duZXIgPSAnJzsKICBfdGhpcy5zdGFydGluZ1RpbWUgPSAnJzsKICBfdGhpcy5sYXN0TW9kaWZpZWQgPSAnJzsKICBfdGhpcy5kdXJhdGlvbiA9ICcnOwogIF90aGlzLmNvbW11bmljYXRpb25TdGF0dXMgPSAnJzsKICBfdGhpcy5wYXJ0aWNpcGFudCA9ICcnOwogIF90aGlzLkNvbW11bmljYXRpb25RdWFsaXR5ID0gJyc7Cn07CgpleHBvcnRzWydkZWZhdWx0J10gPSBDb21tdW5pY2F0aW9uOwoKfSx7fV0sMzpbZnVuY3Rpb24ocmVxdWlyZSxtb2R1bGUsZXhwb3J0cyl7Cid1c2Ugc3RyaWN0JzsKCk9iamVjdC5kZWZpbmVQcm9wZXJ0eShleHBvcnRzLCAnX19lc01vZHVsZScsIHsKICB2YWx1ZTogdHJ1ZQp9KTsKCnZhciBfY3JlYXRlQ2xhc3MgPSAoZnVuY3Rpb24gKCkgeyBmdW5jdGlvbiBkZWZpbmVQcm9wZXJ0aWVzKHRhcmdldCwgcHJvcHMpIHsgZm9yICh2YXIgaSA9IDA7IGkgPCBwcm9wcy5sZW5ndGg7IGkrKykgeyB2YXIgZGVzY3JpcHRvciA9IHByb3BzW2ldOyBkZXNjcmlwdG9yLmVudW1lcmFibGUgPSBkZXNjcmlwdG9yLmVudW1lcmFibGUgfHwgZmFsc2U7IGRlc2NyaXB0b3IuY29uZmlndXJhYmxlID0gdHJ1ZTsgaWYgKCd2YWx1ZScgaW4gZGVzY3JpcHRvcikgZGVzY3JpcHRvci53cml0YWJsZSA9IHRydWU7IE9iamVjdC5kZWZpbmVQcm9wZXJ0eSh0YXJnZXQsIGRlc2NyaXB0b3Iua2V5LCBkZXNjcmlwdG9yKTsgfSB9IHJldHVybiBmdW5jdGlvbiAoQ29uc3RydWN0b3IsIHByb3RvUHJvcHMsIHN0YXRpY1Byb3BzKSB7IGlmIChwcm90b1Byb3BzKSBkZWZpbmVQcm9wZXJ0aWVzKENvbnN0cnVjdG9yLnByb3RvdHlwZSwgcHJvdG9Qcm9wcyk7IGlmIChzdGF0aWNQcm9wcykgZGVmaW5lUHJvcGVydGllcyhDb25zdHJ1Y3Rvciwgc3RhdGljUHJvcHMpOyByZXR1cm4gQ29uc3RydWN0b3I7IH07IH0pKCk7CgpleHBvcnRzWydkZWZhdWx0J10gPSBhY3RpdmF0ZTsKCmZ1bmN0aW9uIF9pbnRlcm9wUmVxdWlyZURlZmF1bHQob2JqKSB7IHJldHVybiBvYmogJiYgb2JqLl9fZXNNb2R1bGUgPyBvYmogOiB7ICdkZWZhdWx0Jzogb2JqIH07IH0KCmZ1bmN0aW9uIF9jbGFzc0NhbGxDaGVjayhpbnN0YW5jZSwgQ29uc3RydWN0b3IpIHsgaWYgKCEoaW5zdGFuY2UgaW5zdGFuY2VvZiBDb25zdHJ1Y3RvcikpIHsgdGhyb3cgbmV3IFR5cGVFcnJvcignQ2Fubm90IGNhbGwgYSBjbGFzcyBhcyBhIGZ1bmN0aW9uJyk7IH0gfQoKdmFyIF9oeXBlcnR5RGlzY292ZXJ5SHlwZXJ0eURpc2NvdmVyeSA9IHJlcXVpcmUoJy4uL2h5cGVydHktZGlzY292ZXJ5L0h5cGVydHlEaXNjb3ZlcnknKTsKCnZhciBfaHlwZXJ0eURpc2NvdmVyeUh5cGVydHlEaXNjb3ZlcnkyID0gX2ludGVyb3BSZXF1aXJlRGVmYXVsdChfaHlwZXJ0eURpc2NvdmVyeUh5cGVydHlEaXNjb3ZlcnkpOwoKdmFyIF9Db21tdW5pY2F0aW9uID0gcmVxdWlyZSgnLi9Db21tdW5pY2F0aW9uJyk7Cgp2YXIgX0NvbW11bmljYXRpb24yID0gX2ludGVyb3BSZXF1aXJlRGVmYXVsdChfQ29tbXVuaWNhdGlvbik7Cgp2YXIgX3V0aWxzVXRpbHMgPSByZXF1aXJlKCcuLi91dGlscy91dGlscycpOwoKdmFyIF9zeW5jaGVyU3luY2hlciA9IHJlcXVpcmUoJy4uL3N5bmNoZXIvU3luY2hlcicpOwoKdmFyIF9zeW5jaGVyU3luY2hlcjIgPSBfaW50ZXJvcFJlcXVpcmVEZWZhdWx0KF9zeW5jaGVyU3luY2hlcik7Cgp2YXIgX0NoYXQgPSByZXF1aXJlKCcuL0NoYXQnKTsKCnZhciBfQ2hhdDIgPSBfaW50ZXJvcFJlcXVpcmVEZWZhdWx0KF9DaGF0KTsKCi8qKgoqIEh5cGVydHkgQ2hhdDsKKiBAYXV0aG9yIFZpdG9yIFNpbHZhIFt2aXRvci10LXNpbHZhQHRlbGVjb20ucHRdCiogQHZlcnNpb24gMC4xLjAKKi8KCnZhciBIeXBlcnR5Q2hhdCA9IChmdW5jdGlvbiAoKSB7CiAgZnVuY3Rpb24gSHlwZXJ0eUNoYXQoaHlwZXJ0eVVSTCwgYnVzLCBjb25maWd1cmF0aW9uKSB7CiAgICBfY2xhc3NDYWxsQ2hlY2sodGhpcywgSHlwZXJ0eUNoYXQpOwoKICAgIGlmICghaHlwZXJ0eVVSTCkgdGhyb3cgbmV3IEVycm9yKCdUaGUgaHlwZXJ0eVVSTCBpcyBhIG5lZWRlZCBwYXJhbWV0ZXInKTsKICAgIGlmICghYnVzKSB0aHJvdyBuZXcgRXJyb3IoJ1RoZSBNaW5pQnVzIGlzIGEgbmVlZGVkIHBhcmFtZXRlcicpOwogICAgaWYgKCFjb25maWd1cmF0aW9uKSB0aHJvdyBuZXcgRXJyb3IoJ1RoZSBjb25maWd1cmF0aW9uIGlzIGEgbmVlZGVkIHBhcmFtZXRlcicpOwoKICAgIC8vIHN1cGVyKGh5cGVydHlVUkwsIGJ1cywgY29uZmlndXJhdGlvbik7CgogICAgdmFyIF90aGlzID0gdGhpczsKICAgIHZhciBzeW5jaGVyID0gbmV3IF9zeW5jaGVyU3luY2hlcjJbJ2RlZmF1bHQnXShoeXBlcnR5VVJMLCBidXMsIGNvbmZpZ3VyYXRpb24pOwoKICAgIHZhciBkb21haW4gPSAoMCwgX3V0aWxzVXRpbHMuZGl2aWRlVVJMKShoeXBlcnR5VVJMKS5kb21haW47CiAgICB2YXIgaHlwZXJ0eURpc2NvdmVyeSA9IG5ldyBfaHlwZXJ0eURpc2NvdmVyeUh5cGVydHlEaXNjb3ZlcnkyWydkZWZhdWx0J10oZG9tYWluLCBidXMpOwoKICAgIF90aGlzLl9vYmplY3REZXNjVVJMID0gJ2h5cGVydHktY2F0YWxvZ3VlOi8vbG9jYWxob3N0Ly53ZWxsLWtub3duL2RhdGFzY2hlbWFzL0Zha2VEYXRhU2NoZW1hJzsKCiAgICBfdGhpcy5fc3luY2hlciA9IHN5bmNoZXI7CiAgICBfdGhpcy5faHlwZXJ0eURpc2NvdmVyeSA9IGh5cGVydHlEaXNjb3Zlcnk7CiAgfQoKICAvKioKICAgKiBUaGlzIGZ1bmN0aW9uIGlzIHVzZWQgdG8gY3JlYXRlIGEgbmV3IEdyb3VwIENoYXQgcHJvdmlkaW5nIHRoZSBpZGVudGlmaWVyIG9mIHRoZSBHcm91cCB0byBiZSBub3RpZmllZC4KICAgKiBAcGFyYW0gIHtTdHJpbmd9IG5hbWUgICAgICAgICAgICAgY2hhdCBuYW1lCiAgICogQHBhcmFtICB7VVJMLlVzZXJVUkx9IFVzZXJVUkxMaXN0IExpc3Qgb2YgVXNlciBhbGxvd2VkCiAgICogQHJldHVybiB7UHJvbWlzZX0KICAgKi8KCiAgX2NyZWF0ZUNsYXNzKEh5cGVydHlDaGF0LCBbewogICAga2V5OiAnY3JlYXRlJywKICAgIHZhbHVlOiBmdW5jdGlvbiBjcmVhdGUobmFtZSkgewoKICAgICAgdmFyIF90aGlzID0gdGhpczsKICAgICAgdmFyIHN5bmNoZXIgPSBfdGhpcy5fc3luY2hlcjsKICAgICAgdmFyIGh5cGVydHlEaXNjb3ZlcnkgPSBfdGhpcy5faHlwZXJ0eURpc2NvdmVyeTsKCiAgICAgIHJldHVybiBuZXcgUHJvbWlzZShmdW5jdGlvbiAocmVzb2x2ZSwgcmVqZWN0KSB7CgogICAgICAgIHZhciBjb21tdW5pY2F0aW9uID0gbmV3IF9Db21tdW5pY2F0aW9uMlsnZGVmYXVsdCddKCk7CiAgICAgICAgY29tbXVuaWNhdGlvbi5pZCA9IG5hbWU7CgogICAgICAgIGNvbnNvbGUuaW5mbygnLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tIFN5bmNoZXIgQ3JlYXRlIC0tLS0tLS0tLS0tLS0tLS0tLS0tLS0gXG4nKTsKICAgICAgICBzeW5jaGVyLmNyZWF0ZShfdGhpcy5fb2JqZWN0RGVzY1VSTCwgW10sIHsgY29tbXVuaWNhdGlvbjogY29tbXVuaWNhdGlvbiB9KS50aGVuKGZ1bmN0aW9uIChkYXRhT2JqZWN0UmVwb3J0ZXIpIHsKICAgICAgICAgIGNvbnNvbGUuaW5mbygnMy4gUmV0dXJuIENyZWF0ZSBEYXRhIE9iamVjdCBSZXBvcnRlcicsIGRhdGFPYmplY3RSZXBvcnRlcik7CgogICAgICAgICAgdmFyIGNoYXQgPSBuZXcgX0NoYXQyWydkZWZhdWx0J10oc3luY2hlciwgaHlwZXJ0eURpc2NvdmVyeSk7CiAgICAgICAgICBjaGF0LmRhdGFPYmplY3RSZXBvcnRlciA9IGRhdGFPYmplY3RSZXBvcnRlcjsKCiAgICAgICAgICByZXNvbHZlKGNoYXQpOwogICAgICAgIH0pWydjYXRjaCddKGZ1bmN0aW9uIChyZWFzb24pIHsKICAgICAgICAgIHJlamVjdChyZWFzb24pOwogICAgICAgIH0pOwogICAgICB9KTsKICAgIH0KICB9LCB7CiAgICBrZXk6ICdfbWFwcGluZ1VzZXInLAogICAgdmFsdWU6IGZ1bmN0aW9uIF9tYXBwaW5nVXNlcih1c2VyTGlzdCkgewoKICAgICAgdmFyIF90aGlzID0gdGhpczsKCiAgICAgIHJldHVybiBuZXcgUHJvbWlzZShmdW5jdGlvbiAocmVzb2x2ZSwgcmVqZWN0KSB7CiAgICAgICAgdmFyIHByb21pc2VMaXN0ID0gW107CgogICAgICAgIHVzZXJMaXN0LmZvckVhY2goZnVuY3Rpb24gKGVtYWlsKSB7CiAgICAgICAgICBwcm9taXNlTGlzdC5wdXNoKF90aGlzLl9oeXBlcnR5RGlzY292ZXJ5KGVtYWlsKSk7CiAgICAgICAgfSk7CgogICAgICAgIFByb21pc2UuYWxsKHByb21pc2VMaXN0KS50aGVuKGZ1bmN0aW9uICh2YWx1ZXMpIHsKICAgICAgICAgIHZhciBoeXBlcnRpZXMgPSBbXTsKCiAgICAgICAgICB2YWx1ZXMuZm9yRWFjaChmdW5jdGlvbiAodmFsdWUpIHsKICAgICAgICAgICAgaHlwZXJ0aWVzLnB1c2godmFsdWUuaHlwZXJ0eVVSTCk7CiAgICAgICAgICB9KTsKCiAgICAgICAgICByZXNvbHZlKGh5cGVydGllcyk7CiAgICAgICAgfSlbJ2NhdGNoJ10oZnVuY3Rpb24gKHJlYXNvbikgewogICAgICAgICAgcmVqZWN0KHJlYXNvbik7CiAgICAgICAgfSk7CiAgICAgIH0pOwogICAgfQogIH1dKTsKCiAgcmV0dXJuIEh5cGVydHlDaGF0Owp9KSgpOwoKZnVuY3Rpb24gYWN0aXZhdGUoaHlwZXJ0eVVSTCwgYnVzLCBjb25maWd1cmF0aW9uKSB7CgogIHJldHVybiB7CiAgICBuYW1lOiAnSHlwZXJ0eUNoYXQnLAogICAgaW5zdGFuY2U6IG5ldyBIeXBlcnR5Q2hhdChoeXBlcnR5VVJMLCBidXMsIGNvbmZpZ3VyYXRpb24pCiAgfTsKfQoKbW9kdWxlLmV4cG9ydHMgPSBleHBvcnRzWydkZWZhdWx0J107Cgp9LHsiLi4vaHlwZXJ0eS1kaXNjb3ZlcnkvSHlwZXJ0eURpc2NvdmVyeSI6NCwiLi4vc3luY2hlci9TeW5jaGVyIjoxMSwiLi4vdXRpbHMvdXRpbHMiOjEzLCIuL0NoYXQiOjEsIi4vQ29tbXVuaWNhdGlvbiI6Mn1dLDQ6W2Z1bmN0aW9uKHJlcXVpcmUsbW9kdWxlLGV4cG9ydHMpewondXNlIHN0cmljdCc7CgpPYmplY3QuZGVmaW5lUHJvcGVydHkoZXhwb3J0cywgJ19fZXNNb2R1bGUnLCB7CiAgdmFsdWU6IHRydWUKfSk7Cgp2YXIgX2NyZWF0ZUNsYXNzID0gKGZ1bmN0aW9uICgpIHsgZnVuY3Rpb24gZGVmaW5lUHJvcGVydGllcyh0YXJnZXQsIHByb3BzKSB7IGZvciAodmFyIGkgPSAwOyBpIDwgcHJvcHMubGVuZ3RoOyBpKyspIHsgdmFyIGRlc2NyaXB0b3IgPSBwcm9wc1tpXTsgZGVzY3JpcHRvci5lbnVtZXJhYmxlID0gZGVzY3JpcHRvci5lbnVtZXJhYmxlIHx8IGZhbHNlOyBkZXNjcmlwdG9yLmNvbmZpZ3VyYWJsZSA9IHRydWU7IGlmICgndmFsdWUnIGluIGRlc2NyaXB0b3IpIGRlc2NyaXB0b3Iud3JpdGFibGUgPSB0cnVlOyBPYmplY3QuZGVmaW5lUHJvcGVydHkodGFyZ2V0LCBkZXNjcmlwdG9yLmtleSwgZGVzY3JpcHRvcik7IH0gfSByZXR1cm4gZnVuY3Rpb24gKENvbnN0cnVjdG9yLCBwcm90b1Byb3BzLCBzdGF0aWNQcm9wcykgeyBpZiAocHJvdG9Qcm9wcykgZGVmaW5lUHJvcGVydGllcyhDb25zdHJ1Y3Rvci5wcm90b3R5cGUsIHByb3RvUHJvcHMpOyBpZiAoc3RhdGljUHJvcHMpIGRlZmluZVByb3BlcnRpZXMoQ29uc3RydWN0b3IsIHN0YXRpY1Byb3BzKTsgcmV0dXJuIENvbnN0cnVjdG9yOyB9OyB9KSgpOwoKZnVuY3Rpb24gX2NsYXNzQ2FsbENoZWNrKGluc3RhbmNlLCBDb25zdHJ1Y3RvcikgeyBpZiAoIShpbnN0YW5jZSBpbnN0YW5jZW9mIENvbnN0cnVjdG9yKSkgeyB0aHJvdyBuZXcgVHlwZUVycm9yKCdDYW5ub3QgY2FsbCBhIGNsYXNzIGFzIGEgZnVuY3Rpb24nKTsgfSB9Cgp2YXIgX3V0aWxzVXRpbHNKcyA9IHJlcXVpcmUoJy4uL3V0aWxzL3V0aWxzLmpzJyk7CgovKioKKiBDb3JlIEh5cGVydHlEaXNjb3ZlcnkgaW50ZXJmYWNlCiogQ2xhc3MgdG8gYWxsb3cgYXBwbGljYXRpb25zIHRvIHNlYXJjaCBmb3IgaHlwZXJ0aWVzIHVzaW5nIHRoZSBtZXNzYWdlIGJ1cwoqLwoKdmFyIEh5cGVydHlEaXNjb3ZlcnkgPSAoZnVuY3Rpb24gKCkgewoKICAvKioKICAqIFRvIGluaXRpYWxpc2UgdGhlIEh5cGVydHlEaXNjb3Zlciwgd2hpY2ggd2lsbCBwcm92aWRlIHRoZSBzdXBwb3J0IGZvciBoeXBlcnRpZXMgdG8KICAqIHF1ZXJ5IHVzZXJzIHJlZ2lzdGVyZWQgaW4gb3V0c2lkZSB0aGUgaW50ZXJuYWwgY29yZS4KICAqIEBwYXJhbSAge1J1bnRpbWVVUkx9ICAgICAgICAgIHJ1bnRpbWVVUkwgICAgICAgICAgICBydW50aW1lVVJMCiAgKiBAcGFyYW0gIHtNZXNzYWdlQnVzfSAgICAgICAgICBtc2didXMgICAgICAgICAgICAgICAgbXNnYnVzCiAgKi8KCiAgZnVuY3Rpb24gSHlwZXJ0eURpc2NvdmVyeShkb21haW4sIG1zZ0J1cykgewogICAgX2NsYXNzQ2FsbENoZWNrKHRoaXMsIEh5cGVydHlEaXNjb3ZlcnkpOwoKICAgIHZhciBfdGhpcyA9IHRoaXM7CiAgICBfdGhpcy5tZXNzYWdlQnVzID0gbXNnQnVzOwoKICAgIF90aGlzLmRvbWFpbiA9IGRvbWFpbjsKICAgIF90aGlzLmRpc2NvdmVyeVVSTCA9ICdoeXBlcnR5Oi8vJyArIGRvbWFpbiArICcvaHlwZXJ0eURpc292ZXJ5JzsKICB9CgogIC8qKgogICogZnVuY3Rpb24gdG8gcmVxdWVzdCBhYm91dCB1c2VycyByZWdpc3RlcmVkIGluIGRvbWFpbiByZWdpc3RyeSwgYW5kCiAgKiByZXR1cm4gdGhlIGh5cGVydHkgaW5zdGFuY2UgaWYgZm91bmQuCiAgKiBAcGFyYW0gIHtlbWFpbH0gICAgICAgICAgICAgIGVtYWlsCiAgKiBAcmV0dXJuIHtQcm9taXNlfSAgICAgICAgICBQcm9taXNlCiAgKi8KCiAgX2NyZWF0ZUNsYXNzKEh5cGVydHlEaXNjb3ZlcnksIFt7CiAgICBrZXk6ICdkaXNjb3Zlckh5cGVydHlQZXJVc2VyJywKICAgIHZhbHVlOiBmdW5jdGlvbiBkaXNjb3Zlckh5cGVydHlQZXJVc2VyKGVtYWlsKSB7CiAgICAgIHZhciBfdGhpcyA9IHRoaXM7CiAgICAgIHZhciBpZGVudGl0eVVSTCA9ICd1c2VyOi8vJyArIGVtYWlsLnN1YnN0cmluZyhlbWFpbC5pbmRleE9mKCdAJykgKyAxLCBlbWFpbC5sZW5ndGgpICsgJy8nICsgZW1haWwuc3Vic3RyaW5nKDAsIGVtYWlsLmluZGV4T2YoJ0AnKSk7CgogICAgICAvLyBtZXNzYWdlIHRvIHF1ZXJ5IGRvbWFpbiByZWdpc3RyeSwgYXNraW5nIGZvciBhIHVzZXIgaHlwZXJ0eS4KICAgICAgdmFyIG1lc3NhZ2UgPSB7CiAgICAgICAgdHlwZTogJ1JFQUQnLCBmcm9tOiBfdGhpcy5kaXNjb3ZlcnlVUkwsIHRvOiAnZG9tYWluOi8vcmVnaXN0cnkuJyArIF90aGlzLmRvbWFpbiArICcvJywgYm9keTogeyB1c2VyOiBpZGVudGl0eVVSTCB9CiAgICAgIH07CgogICAgICByZXR1cm4gbmV3IFByb21pc2UoZnVuY3Rpb24gKHJlc29sdmUsIHJlamVjdCkgewoKICAgICAgICBfdGhpcy5tZXNzYWdlQnVzLnBvc3RNZXNzYWdlKG1lc3NhZ2UsIGZ1bmN0aW9uIChyZXBseSkgewoKICAgICAgICAgIHZhciBoeXBlcnR5VVJMID0gcmVwbHkuYm9keS5sYXN0OwoKICAgICAgICAgIGlmIChoeXBlcnR5VVJMID09PSB1bmRlZmluZWQpIHsKICAgICAgICAgICAgcmV0dXJuIHJlamVjdCgnVXNlciBIeXBlcnR5IG5vdCBmb3VuZCcpOwogICAgICAgICAgfQoKICAgICAgICAgIHZhciBpZFBhY2thZ2UgPSB7CiAgICAgICAgICAgIGlkOiBlbWFpbCwKICAgICAgICAgICAgZGVzY3JpcHRvcjogcmVwbHkuYm9keS5oeXBlcnRpZXNbaHlwZXJ0eVVSTF0uZGVzY3JpcHRvciwKICAgICAgICAgICAgaHlwZXJ0eVVSTDogaHlwZXJ0eVVSTAogICAgICAgICAgfTsKCiAgICAgICAgICByZXNvbHZlKGlkUGFja2FnZSk7CiAgICAgICAgfSk7CiAgICAgIH0pOwogICAgfQogIH1dKTsKCiAgcmV0dXJuIEh5cGVydHlEaXNjb3Zlcnk7Cn0pKCk7CgpleHBvcnRzWydkZWZhdWx0J10gPSBIeXBlcnR5RGlzY292ZXJ5Owptb2R1bGUuZXhwb3J0cyA9IGV4cG9ydHNbJ2RlZmF1bHQnXTsKCn0seyIuLi91dGlscy91dGlscy5qcyI6MTN9XSw1OltmdW5jdGlvbihyZXF1aXJlLG1vZHVsZSxleHBvcnRzKXsKJ3VzZSBzdHJpY3QnOwoKT2JqZWN0LmRlZmluZVByb3BlcnR5KGV4cG9ydHMsICdfX2VzTW9kdWxlJywgewogIHZhbHVlOiB0cnVlCn0pOwoKdmFyIF9jcmVhdGVDbGFzcyA9IChmdW5jdGlvbiAoKSB7IGZ1bmN0aW9uIGRlZmluZVByb3BlcnRpZXModGFyZ2V0LCBwcm9wcykgeyBmb3IgKHZhciBpID0gMDsgaSA8IHByb3BzLmxlbmd0aDsgaSsrKSB7IHZhciBkZXNjcmlwdG9yID0gcHJvcHNbaV07IGRlc2NyaXB0b3IuZW51bWVyYWJsZSA9IGRlc2NyaXB0b3IuZW51bWVyYWJsZSB8fCBmYWxzZTsgZGVzY3JpcHRvci5jb25maWd1cmFibGUgPSB0cnVlOyBpZiAoJ3ZhbHVlJyBpbiBkZXNjcmlwdG9yKSBkZXNjcmlwdG9yLndyaXRhYmxlID0gdHJ1ZTsgT2JqZWN0LmRlZmluZVByb3BlcnR5KHRhcmdldCwgZGVzY3JpcHRvci5rZXksIGRlc2NyaXB0b3IpOyB9IH0gcmV0dXJuIGZ1bmN0aW9uIChDb25zdHJ1Y3RvciwgcHJvdG9Qcm9wcywgc3RhdGljUHJvcHMpIHsgaWYgKHByb3RvUHJvcHMpIGRlZmluZVByb3BlcnRpZXMoQ29uc3RydWN0b3IucHJvdG90eXBlLCBwcm90b1Byb3BzKTsgaWYgKHN0YXRpY1Byb3BzKSBkZWZpbmVQcm9wZXJ0aWVzKENvbnN0cnVjdG9yLCBzdGF0aWNQcm9wcyk7IHJldHVybiBDb25zdHJ1Y3RvcjsgfTsgfSkoKTsKCmZ1bmN0aW9uIF9pbnRlcm9wUmVxdWlyZURlZmF1bHQob2JqKSB7IHJldHVybiBvYmogJiYgb2JqLl9fZXNNb2R1bGUgPyBvYmogOiB7ICdkZWZhdWx0Jzogb2JqIH07IH0KCmZ1bmN0aW9uIF9jbGFzc0NhbGxDaGVjayhpbnN0YW5jZSwgQ29uc3RydWN0b3IpIHsgaWYgKCEoaW5zdGFuY2UgaW5zdGFuY2VvZiBDb25zdHJ1Y3RvcikpIHsgdGhyb3cgbmV3IFR5cGVFcnJvcignQ2Fubm90IGNhbGwgYSBjbGFzcyBhcyBhIGZ1bmN0aW9uJyk7IH0gfQoKdmFyIF9TeW5jT2JqZWN0ID0gcmVxdWlyZSgnLi9TeW5jT2JqZWN0Jyk7Cgp2YXIgX1N5bmNPYmplY3QyID0gX2ludGVyb3BSZXF1aXJlRGVmYXVsdChfU3luY09iamVjdCk7Cgp2YXIgX0RhdGFPYmplY3RDaGlsZCA9IHJlcXVpcmUoJy4vRGF0YU9iamVjdENoaWxkJyk7Cgp2YXIgX0RhdGFPYmplY3RDaGlsZDIgPSBfaW50ZXJvcFJlcXVpcmVEZWZhdWx0KF9EYXRhT2JqZWN0Q2hpbGQpOwoKdmFyIERhdGFPYmplY3QgPSAoZnVuY3Rpb24gKCkgewogIC8qIHByaXZhdGUKICBfdmVyc2lvbjogbnVtYmVyCiAgIF9vd25lcjogSHlwZXJ0eVVSTAogIF91cmw6IE9iamVjdFVSTAogIF9zY2hlbWE6IFNjaGVtYQogIF9idXM6IE1pbmlCdXMKICBfc3RhdHVzOiBvbiB8IHBhdXNlZAogIF9zeW5jT2JqOiBTeW5jRGF0YQogICBfY2hpbGRyZW46IHsgaWQ6IERhdGFPYmplY3RDaGlsZCB9CiAgIC0tLS1ldmVudCBoYW5kbGVycy0tLS0KICBfb25BZGRDaGlsZHJlbkhhbmRsZXI6IChldmVudCkgPT4gdm9pZAogICovCgogIC8qKgogICAqIEBpZ25vcmUKICAgKiBTaG91bGQgbm90IGJlIHVzZWQgZGlyZWN0bHkgYnkgSHlwZXJ0aWVzLiBJdCdzIGNhbGxlZCBieSB0aGUgU3luY2hlciBjcmVhdGUgb3Igc3Vic2NyaWJlIG1ldGhvZCdzCiAgICovCgogIGZ1bmN0aW9uIERhdGFPYmplY3Qob3duZXIsIHVybCwgc2NoZW1hLCBidXMsIGluaXRpYWxTdGF0dXMsIGluaXRpYWxEYXRhLCBjaGlsZHJlbikgewogICAgdmFyIF90aGlzMiA9IHRoaXM7CgogICAgX2NsYXNzQ2FsbENoZWNrKHRoaXMsIERhdGFPYmplY3QpOwoKICAgIHZhciBfdGhpcyA9IHRoaXM7CgogICAgX3RoaXMuX3ZlcnNpb24gPSAwOwoKICAgIF90aGlzLl9vd25lciA9IG93bmVyOwogICAgX3RoaXMuX3VybCA9IHVybDsKICAgIF90aGlzLl9zY2hlbWEgPSBzY2hlbWE7CiAgICBfdGhpcy5fYnVzID0gYnVzOwogICAgX3RoaXMuX3N0YXR1cyA9IGluaXRpYWxTdGF0dXM7CiAgICBfdGhpcy5fc3luY09iaiA9IG5ldyBfU3luY09iamVjdDJbJ2RlZmF1bHQnXShpbml0aWFsRGF0YSk7CgogICAgX3RoaXMuX2NoaWxkSWQgPSAwOwogICAgX3RoaXMuX2NoaWxkcmVuID0ge307CgogICAgdmFyIGNoaWxkQmFzZVVSTCA9IHVybCArICcvY2hpbGRyZW4vJzsKCiAgICBpZiAoY2hpbGRyZW4pIHsKICAgICAgY2hpbGRyZW4uZm9yRWFjaChmdW5jdGlvbiAoY2hpbGQpIHsKICAgICAgICB2YXIgY2hpbGRVUkwgPSBjaGlsZEJhc2VVUkwgKyBjaGlsZDsKICAgICAgICBidXMuYWRkTGlzdGVuZXIoY2hpbGRVUkwsIGZ1bmN0aW9uIChtc2cpIHsKICAgICAgICAgIC8vaWdub3JlIG1zZyBzZW50IGJ5IGhpbXNlbGYKICAgICAgICAgIGlmIChtc2cuZnJvbSAhPT0gX3RoaXMyLl9vd25lcikgewogICAgICAgICAgICBzd2l0Y2ggKG1zZy50eXBlKSB7CiAgICAgICAgICAgICAgY2FzZSAnY3JlYXRlJzoKICAgICAgICAgICAgICAgIF90aGlzLl9vbkNoaWxkcmVuQ3JlYXRlKG1zZyk7YnJlYWs7CiAgICAgICAgICAgICAgY2FzZSAnZGVsZXRlJzoKICAgICAgICAgICAgICAgIGNvbnNvbGUubG9nKG1zZyk7YnJlYWs7CiAgICAgICAgICAgICAgZGVmYXVsdDoKICAgICAgICAgICAgICAgIF90aGlzLl9jaGFuZ2VDaGlsZHJlbihtc2cpO2JyZWFrOwogICAgICAgICAgICB9CiAgICAgICAgICB9CiAgICAgICAgfSk7CiAgICAgIH0pOwogICAgfQogIH0KCiAgLyoqCiAgICogT2JqZWN0IFVSTCBvZiByZXBvcnRlciBvciBvYnNlcnZlcgogICAqIEB0eXBlIHtPYmplY3RVUkx9CiAgICovCgogIF9jcmVhdGVDbGFzcyhEYXRhT2JqZWN0LCBbewogICAga2V5OiAncGF1c2UnLAoKICAgIC8qKgogICAgICogQGlnbm9yZQogICAgICovCiAgICB2YWx1ZTogZnVuY3Rpb24gcGF1c2UoKSB7CiAgICAgIC8vVE9ETzogdGhpcyBmZWF0dXJlIG5lZWRzIG1vcmUgYW5hbGlzZQogICAgICB0aHJvdyAnTm90IGltcGxlbWVudGVkJzsKICAgIH0KCiAgICAvKioKICAgICAqIEBpZ25vcmUKICAgICAqLwogIH0sIHsKICAgIGtleTogJ3Jlc3VtZScsCiAgICB2YWx1ZTogZnVuY3Rpb24gcmVzdW1lKCkgewogICAgICAvL1RPRE86IHRoaXMgZmVhdHVyZSBuZWVkcyBtb3JlIGFuYWxpc2UKICAgICAgdGhyb3cgJ05vdCBpbXBsZW1lbnRlZCc7CiAgICB9CgogICAgLyoqCiAgICAgKiBAaWdub3JlCiAgICAgKi8KICB9LCB7CiAgICBrZXk6ICdzdG9wJywKICAgIHZhbHVlOiBmdW5jdGlvbiBzdG9wKCkgewogICAgICAvL1RPRE86IHNob3VsZCByZW1vdmUgdGhlIHN1YnNjcmlwdGlvbiBhbmQgc2VuZCBtZXNzYWdlIHVuc3Vic2NyaWJlPwogICAgICB0aHJvdyAnTm90IGltcGxlbWVudGVkJzsKICAgIH0KCiAgICAvKioKICAgICAqIEBpZ25vcmUKICAgICAqLwogIH0sIHsKICAgIGtleTogJ3JlbGVhc2UnLAogICAgdmFsdWU6IGZ1bmN0aW9uIHJlbGVhc2UoKSB7fQogICAgLy9UT0RPOiByZW1vdmUgYWxsIGxpc3RlbmVycyBmb3IgdGhpcyBvYmplY3QKCiAgICAvKioKICAgICAqIENyZWF0ZSBhbmQgYWRkIGEgY2hpbGRyZW4gdG8gdGhlIHN1YnNjcmlwdGlvbiBncm91cC4KICAgICAqIEBwYXJhbSB7U3RyaW5nfSByZXNvdXJjZSAtIFJlc291cmNlIG5hbWUsIG9uZSBvZiB0aGUgaXRlbXMgaW4gdGhlIHNjaGVtYS5wcm9wZXJ0aWVzLnNjaGVtZSBvZiB0aGUgcGFyZW50IG9iamVjdC4KICAgICAqIEBwYXJhbSB7SlNPTn0gaW5pdGlhbERhdGEgLSBJbml0aWFsIGRhdGEgb2YgdGhlIGNoaWxkCiAgICAgKiBAcmV0dXJuIHtQcm9taXNlPERhdGFPYmplY3RDaGlsZD59IC0gUmV0dXJuIFByb21pc2UgdG8gYSBuZXcgQ2hpbGRyZW4uCiAgICAgKi8KCiAgfSwgewogICAga2V5OiAnYWRkQ2hpbGRyZW4nLAogICAgdmFsdWU6IGZ1bmN0aW9uIGFkZENoaWxkcmVuKHJlc291cmNlLCBpbml0aWFsRGF0YSkgewogICAgICB2YXIgX3RoaXMgPSB0aGlzOwoKICAgICAgLy9jcmVhdGUgbmV3IGNoaWxkIHVuaXF1ZSBJRCwgYmFzZWQgb24gaHlwZXJ0eVVSTAogICAgICBfdGhpcy5fY2hpbGRJZCsrOwogICAgICB2YXIgbXNnQ2hpbGRJZCA9IF90aGlzLl9vd25lciArICcjJyArIF90aGlzLl9jaGlsZElkOwogICAgICB2YXIgbXNnQ2hpbGRQYXRoID0gX3RoaXMuX3VybCArICcvY2hpbGRyZW4vJyArIHJlc291cmNlOwoKICAgICAgdmFyIHJlcXVlc3RNc2cgPSB7CiAgICAgICAgdHlwZTogJ2NyZWF0ZScsIGZyb206IF90aGlzLl9vd25lciwgdG86IG1zZ0NoaWxkUGF0aCwKICAgICAgICBib2R5OiB7IHJlc291cmNlOiBtc2dDaGlsZElkLCB2YWx1ZTogaW5pdGlhbERhdGEgfQogICAgICB9OwoKICAgICAgLy9yZXR1cm5zIHByb21pc2UsIGluIHRoZSBmdXR1cmUsIHRoZSBBUEkgbWF5IGNoYW5nZSB0byBhc3luY2hyb25vdXMgY2FsbAogICAgICByZXR1cm4gbmV3IFByb21pc2UoZnVuY3Rpb24gKHJlc29sdmUpIHsKICAgICAgICB2YXIgbXNnSWQgPSBfdGhpcy5fYnVzLnBvc3RNZXNzYWdlKHJlcXVlc3RNc2cpOwoKICAgICAgICBjb25zb2xlLmxvZygnY3JlYXRlLXJlcG9ydGVyLWNoaWxkKCAnICsgX3RoaXMuX293bmVyICsgJyApOiAnLCByZXF1ZXN0TXNnKTsKICAgICAgICB2YXIgbmV3Q2hpbGQgPSBuZXcgX0RhdGFPYmplY3RDaGlsZDJbJ2RlZmF1bHQnXShfdGhpcy5fb3duZXIsIG1zZ0NoaWxkSWQsIG1zZ0lkLCBfdGhpcy5fYnVzLCBpbml0aWFsRGF0YSk7CiAgICAgICAgbmV3Q2hpbGQub25DaGFuZ2UoZnVuY3Rpb24gKGV2ZW50KSB7CiAgICAgICAgICBfdGhpcy5fb25DaGFuZ2UoZXZlbnQsIHsgcGF0aDogbXNnQ2hpbGRQYXRoLCBjaGlsZElkOiBtc2dDaGlsZElkIH0pOwogICAgICAgIH0pOwoKICAgICAgICBfdGhpcy5fY2hpbGRyZW5bbXNnQ2hpbGRJZF0gPSBuZXdDaGlsZDsKCiAgICAgICAgcmVzb2x2ZShuZXdDaGlsZCk7CiAgICAgIH0pOwogICAgfQoKICAgIC8qKgogICAgICogU2V0dXAgdGhlIGNhbGxiYWNrIHRvIHByb2Nlc3MgY3JlYXRlIGFuZCBkZWxldGUgY2hpbGRyZW5zCiAgICAgKiBAcGFyYW0ge2Z1bmN0aW9uKGV2ZW50OiBNc2dFdmVudCl9IGNhbGxiYWNrCiAgICAgKi8KICB9LCB7CiAgICBrZXk6ICdvbkFkZENoaWxkcmVuJywKICAgIHZhbHVlOiBmdW5jdGlvbiBvbkFkZENoaWxkcmVuKGNhbGxiYWNrKSB7CiAgICAgIHRoaXMuX29uQWRkQ2hpbGRyZW5IYW5kbGVyID0gY2FsbGJhY2s7CiAgICB9CiAgfSwgewogICAga2V5OiAnX29uQ2hpbGRyZW5DcmVhdGUnLAogICAgdmFsdWU6IGZ1bmN0aW9uIF9vbkNoaWxkcmVuQ3JlYXRlKG1zZykgewogICAgICB2YXIgX3RoaXMgPSB0aGlzOwogICAgICB2YXIgbXNnQ2hpbGRJZCA9IG1zZy5ib2R5LnJlc291cmNlOwoKICAgICAgY29uc29sZS5sb2coJ2NyZWF0ZS1vYnNlcnZlci1jaGlsZCggJyArIF90aGlzLl9vd25lciArICcgKTogJywgbXNnKTsKICAgICAgdmFyIG5ld0NoaWxkID0gbmV3IF9EYXRhT2JqZWN0Q2hpbGQyWydkZWZhdWx0J10obXNnLmZyb20sIG1zZ0NoaWxkSWQsIDAsIF90aGlzLl9idXMsIG1zZy5ib2R5LnZhbHVlKTsKICAgICAgX3RoaXMuX2NoaWxkcmVuW21zZ0NoaWxkSWRdID0gbmV3Q2hpbGQ7CgogICAgICBzZXRUaW1lb3V0KGZ1bmN0aW9uICgpIHsKICAgICAgICBfdGhpcy5fYnVzLnBvc3RNZXNzYWdlKHsKICAgICAgICAgIGlkOiBtc2cuaWQsIHR5cGU6ICdyZXNwb25zZScsIGZyb206IG1zZy50bywgdG86IG1zZy5mcm9tLAogICAgICAgICAgYm9keTogeyBjb2RlOiAyMDAsIHNvdXJjZTogX3RoaXMuX293bmVyIH0KICAgICAgICB9KTsKICAgICAgfSk7CgogICAgICB2YXIgZXZlbnQgPSB7CiAgICAgICAgdHlwZTogbXNnLnR5cGUsCiAgICAgICAgZnJvbTogbXNnLmZyb20sCiAgICAgICAgdXJsOiBtc2cudG8sCiAgICAgICAgdmFsdWU6IG1zZy5ib2R5LnZhbHVlLAogICAgICAgIGNoaWxkSWQ6IG1zZ0NoaWxkSWQKICAgICAgfTsKCiAgICAgIGlmIChfdGhpcy5fb25BZGRDaGlsZHJlbkhhbmRsZXIpIHsKICAgICAgICBfdGhpcy5fb25BZGRDaGlsZHJlbkhhbmRsZXIoZXZlbnQpOwogICAgICB9CiAgICB9CgogICAgLy9zZW5kIGRlbHRhIG1lc3NhZ2VzIHRvIHN1YnNjcmlwdGlvbnMKICB9LCB7CiAgICBrZXk6ICdfb25DaGFuZ2UnLAogICAgdmFsdWU6IGZ1bmN0aW9uIF9vbkNoYW5nZShldmVudCwgY2hpbGRJbmZvKSB7CiAgICAgIHZhciBfdGhpcyA9IHRoaXM7CgogICAgICBfdGhpcy5fdmVyc2lvbisrOwoKICAgICAgaWYgKF90aGlzLl9zdGF0dXMgPT09ICdvbicpIHsKICAgICAgICB2YXIgY2hhbmdlTXNnID0gewogICAgICAgICAgdHlwZTogZXZlbnQuY1R5cGUsIGZyb206IF90aGlzLl9vd25lciwgdG86IF90aGlzLl91cmwsCiAgICAgICAgICBib2R5OiB7IHZlcnNpb246IF90aGlzLl92ZXJzaW9uLCBvVHlwZTogZXZlbnQub1R5cGUsIGF0dHJpYjogZXZlbnQuZmllbGQsIHZhbHVlOiBldmVudC5kYXRhIH0KICAgICAgICB9OwoKICAgICAgICAvL2NoaWxkSW5mbyBtdXN0IGhhdmUgKHBhdGgsIGNoaWxkSWQpCiAgICAgICAgaWYgKGNoaWxkSW5mbykgewogICAgICAgICAgY2hhbmdlTXNnLnRvID0gY2hpbGRJbmZvLnBhdGg7CiAgICAgICAgICBjaGFuZ2VNc2cuYm9keS5jaGlsZElkID0gY2hpbGRJbmZvLmNoaWxkSWQ7CiAgICAgICAgfQoKICAgICAgICBfdGhpcy5fYnVzLnBvc3RNZXNzYWdlKGNoYW5nZU1zZyk7CiAgICAgIH0KICAgIH0KCiAgICAvL3JlY2VpdmUgYW5kIHByb2Nlc3MgZGVsdGEgbWVzc2FnZXMKICB9LCB7CiAgICBrZXk6ICdfY2hhbmdlT2JqZWN0JywKICAgIHZhbHVlOiBmdW5jdGlvbiBfY2hhbmdlT2JqZWN0KHN5bmNPYmosIG1zZykgewogICAgICB2YXIgX3RoaXMgPSB0aGlzOwoKICAgICAgLy9UT0RPOiB1cGRhdGUgdmVyc2lvbiA/CiAgICAgIC8vaG93IHRvIGhhbmRsZSBhbiBpbmNvcnJlY3QgdmVyc2lvbiA/IEV4YW1wbGU6IHJlY2VpdmUgYSB2ZXJzaW9uIDMgd2hlbiB0aGUgb2JzZXJ2ZXIgaXMgaW4gdmVyc2lvbiAxLCB3aGVyZSBpcyB0aGUgdmVyc2lvbiAyID8KICAgICAgLy93aWxsIHdlIG5lZWQgdG8gY29uZmlybSB0aGUgcmVjZXB0aW9uID8KICAgICAgaWYgKF90aGlzLl92ZXJzaW9uICsgMSA9PT0gbXNnLmJvZHkudmVyc2lvbikgewogICAgICAgIF90aGlzLl92ZXJzaW9uKys7CiAgICAgICAgdmFyIHBhdGggPSBtc2cuYm9keS5hdHRyaWI7CiAgICAgICAgdmFyIHZhbHVlID0gbXNnLmJvZHkudmFsdWU7CiAgICAgICAgdmFyIGZpbmRSZXN1bHQgPSBzeW5jT2JqLmZpbmRCZWZvcmUocGF0aCk7CgogICAgICAgIGlmIChtc2cudHlwZSA9PT0gX1N5bmNPYmplY3QuQ2hhbmdlVHlwZS5VUERBVEUpIHsKICAgICAgICAgIGZpbmRSZXN1bHQub2JqW2ZpbmRSZXN1bHQubGFzdF0gPSB2YWx1ZTsKICAgICAgICB9IGVsc2UgewogICAgICAgICAgaWYgKG1zZy50eXBlID09PSBfU3luY09iamVjdC5DaGFuZ2VUeXBlLkFERCkgewogICAgICAgICAgICBpZiAobXNnLmJvZHkub1R5cGUgPT09IF9TeW5jT2JqZWN0Lk9iamVjdFR5cGUuT0JKRUNUKSB7CiAgICAgICAgICAgICAgZmluZFJlc3VsdC5vYmpbZmluZFJlc3VsdC5sYXN0XSA9IHZhbHVlOwogICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgIC8vQVJSQVkKICAgICAgICAgICAgICB2YXIgYXJyID0gZmluZFJlc3VsdC5vYmo7CiAgICAgICAgICAgICAgdmFyIGluZGV4ID0gZmluZFJlc3VsdC5sYXN0OwogICAgICAgICAgICAgIEFycmF5LnByb3RvdHlwZS5zcGxpY2UuYXBwbHkoYXJyLCBbaW5kZXgsIDBdLmNvbmNhdCh2YWx1ZSkpOwogICAgICAgICAgICB9CiAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAvL1JFTU9WRQogICAgICAgICAgICBpZiAobXNnLmJvZHkub1R5cGUgPT09IF9TeW5jT2JqZWN0Lk9iamVjdFR5cGUuT0JKRUNUKSB7CiAgICAgICAgICAgICAgZGVsZXRlIGZpbmRSZXN1bHQub2JqW2ZpbmRSZXN1bHQubGFzdF07CiAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgLy9BUlJBWQogICAgICAgICAgICAgIHZhciBhcnIgPSBmaW5kUmVzdWx0Lm9iajsKICAgICAgICAgICAgICB2YXIgaW5kZXggPSBmaW5kUmVzdWx0Lmxhc3Q7CiAgICAgICAgICAgICAgYXJyLnNwbGljZShpbmRleCwgdmFsdWUpOwogICAgICAgICAgICB9CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICB9IGVsc2UgewogICAgICAgIC8vVE9ETzogaG93IHRvIGhhbmRsZSB1bnN5bmNocm9uaXplZCB2ZXJzaW9ucz8KICAgICAgICBjb25zb2xlLmxvZygndW5zeW5jaHJvbml6ZWQgdmVyc2lvbnMnKTsKICAgICAgfQogICAgfQogIH0sIHsKICAgIGtleTogJ19jaGFuZ2VDaGlsZHJlbicsCiAgICB2YWx1ZTogZnVuY3Rpb24gX2NoYW5nZUNoaWxkcmVuKG1zZykgewogICAgICB2YXIgX3RoaXMgPSB0aGlzOwogICAgICBjb25zb2xlLmxvZygnQ2hhbmdlIGNoaWxkcmVuOiAnLCBfdGhpcy5fb3duZXIsIG1zZyk7CgogICAgICB2YXIgY2hpbGRJZCA9IG1zZy5ib2R5LmNoaWxkSWQ7CiAgICAgIHZhciBjaGlsZHJlbiA9IF90aGlzLl9jaGlsZHJlbltjaGlsZElkXTsKCiAgICAgIGlmIChjaGlsZHJlbikgewogICAgICAgIF90aGlzLl9jaGFuZ2VPYmplY3QoY2hpbGRyZW4sIG1zZyk7CiAgICAgIH0gZWxzZSB7CiAgICAgICAgY29uc29sZS5sb2coJ05vIGNoaWxkcmVuIGZvdW5kIGZvcjogJywgY2hpbGRJZCk7CiAgICAgIH0KICAgIH0KICB9LCB7CiAgICBrZXk6ICd1cmwnLAogICAgZ2V0OiBmdW5jdGlvbiBnZXQoKSB7CiAgICAgIHJldHVybiB0aGlzLl91cmw7CiAgICB9CgogICAgLyoqCiAgICAgKiBPYmplY3Qgc2NoZW1hIFVSTCAodGhpcyBmaWVsZCBpcyBub3QgeWV0IHN0YWJsZSwgYW5kIGlzIHN1YnNqZWN0IHRvIGNoYW5nZSkKICAgICAqIEB0eXBlIHtTY2hlbWFVUkx9CiAgICAgKi8KICB9LCB7CiAgICBrZXk6ICdzY2hlbWEnLAogICAgZ2V0OiBmdW5jdGlvbiBnZXQoKSB7CiAgICAgIHJldHVybiB0aGlzLl9zY2hlbWE7CiAgICB9CgogICAgLyoqCiAgICAgKiBTdGF0dXMgb2YgdGhlIHJlcG9ydGVyIG9yIG9ic2VydmVyIGNvbm5lY3Rpb24gKHRoaXMgZmllbGQgaXMgbm90IHlldCBzdGFibGUsIGFuZCBpcyBzdWJzamVjdCB0byBjaGFuZ2UpCiAgICAgKiBAdHlwZSB7U3RhdHVzfSAtIEVudW0gb2Y6IG9uIHwgcGF1c2VkCiAgICAgKi8KICB9LCB7CiAgICBrZXk6ICdzdGF0dXMnLAogICAgZ2V0OiBmdW5jdGlvbiBnZXQoKSB7CiAgICAgIHJldHVybiB0aGlzLl9zdGF0dXM7CiAgICB9CgogICAgLyoqCiAgICAgKiBEYXRhIHN0cnVjdHVyZSB0byBiZSBzeW5jaHJvbml6ZWQuCiAgICAgKiBAdHlwZSB7SlNPTn0gLSBKU09OIHN0cnVjdHVyZSB0aGF0IHNob3VsZCBmb2xsb3cgdGhlIGRlZmluZWQgc2NoZW1hLCBpZiBhbnkuCiAgICAgKi8KICB9LCB7CiAgICBrZXk6ICdkYXRhJywKICAgIGdldDogZnVuY3Rpb24gZ2V0KCkgewogICAgICByZXR1cm4gdGhpcy5fc3luY09iai5kYXRhOwogICAgfQoKICAgIC8qKgogICAgICogQWxsIGNyZWF0ZWQgY2hpbGRyZW4ncyBzaW5jZSB0aGUgc3Vic2NyaXB0aW9uLCBkb2Vzbid0IGNvbnRhaW4gYWxsIGNoaWxkcmVuJ3Mgc2luY2UgcmVwb3J0ZXIgY3JlYXRpb24uCiAgICAgKiBAdHlwZSB7T2JqZWN0PENoaWxkSWQsIERhdGFPYmplY3RDaGlsZD59CiAgICAgKi8KICB9LCB7CiAgICBrZXk6ICdjaGlsZHJlbicsCiAgICBnZXQ6IGZ1bmN0aW9uIGdldCgpIHsKICAgICAgcmV0dXJuIHRoaXMuX2NoaWxkcmVuOwogICAgfQogIH1dKTsKCiAgcmV0dXJuIERhdGFPYmplY3Q7Cn0pKCk7CgpleHBvcnRzWydkZWZhdWx0J10gPSBEYXRhT2JqZWN0Owptb2R1bGUuZXhwb3J0cyA9IGV4cG9ydHNbJ2RlZmF1bHQnXTsKCn0seyIuL0RhdGFPYmplY3RDaGlsZCI6NiwiLi9TeW5jT2JqZWN0IjoxMH1dLDY6W2Z1bmN0aW9uKHJlcXVpcmUsbW9kdWxlLGV4cG9ydHMpewondXNlIHN0cmljdCc7CgpPYmplY3QuZGVmaW5lUHJvcGVydHkoZXhwb3J0cywgJ19fZXNNb2R1bGUnLCB7CiAgdmFsdWU6IHRydWUKfSk7Cgp2YXIgX2NyZWF0ZUNsYXNzID0gKGZ1bmN0aW9uICgpIHsgZnVuY3Rpb24gZGVmaW5lUHJvcGVydGllcyh0YXJnZXQsIHByb3BzKSB7IGZvciAodmFyIGkgPSAwOyBpIDwgcHJvcHMubGVuZ3RoOyBpKyspIHsgdmFyIGRlc2NyaXB0b3IgPSBwcm9wc1tpXTsgZGVzY3JpcHRvci5lbnVtZXJhYmxlID0gZGVzY3JpcHRvci5lbnVtZXJhYmxlIHx8IGZhbHNlOyBkZXNjcmlwdG9yLmNvbmZpZ3VyYWJsZSA9IHRydWU7IGlmICgndmFsdWUnIGluIGRlc2NyaXB0b3IpIGRlc2NyaXB0b3Iud3JpdGFibGUgPSB0cnVlOyBPYmplY3QuZGVmaW5lUHJvcGVydHkodGFyZ2V0LCBkZXNjcmlwdG9yLmtleSwgZGVzY3JpcHRvcik7IH0gfSByZXR1cm4gZnVuY3Rpb24gKENvbnN0cnVjdG9yLCBwcm90b1Byb3BzLCBzdGF0aWNQcm9wcykgeyBpZiAocHJvdG9Qcm9wcykgZGVmaW5lUHJvcGVydGllcyhDb25zdHJ1Y3Rvci5wcm90b3R5cGUsIHByb3RvUHJvcHMpOyBpZiAoc3RhdGljUHJvcHMpIGRlZmluZVByb3BlcnRpZXMoQ29uc3RydWN0b3IsIHN0YXRpY1Byb3BzKTsgcmV0dXJuIENvbnN0cnVjdG9yOyB9OyB9KSgpOwoKZnVuY3Rpb24gX2ludGVyb3BSZXF1aXJlRGVmYXVsdChvYmopIHsgcmV0dXJuIG9iaiAmJiBvYmouX19lc01vZHVsZSA/IG9iaiA6IHsgJ2RlZmF1bHQnOiBvYmogfTsgfQoKZnVuY3Rpb24gX2NsYXNzQ2FsbENoZWNrKGluc3RhbmNlLCBDb25zdHJ1Y3RvcikgeyBpZiAoIShpbnN0YW5jZSBpbnN0YW5jZW9mIENvbnN0cnVjdG9yKSkgeyB0aHJvdyBuZXcgVHlwZUVycm9yKCdDYW5ub3QgY2FsbCBhIGNsYXNzIGFzIGEgZnVuY3Rpb24nKTsgfSB9Cgp2YXIgX1N5bmNPYmplY3QgPSByZXF1aXJlKCcuL1N5bmNPYmplY3QnKTsKCnZhciBfU3luY09iamVjdDIgPSBfaW50ZXJvcFJlcXVpcmVEZWZhdWx0KF9TeW5jT2JqZWN0KTsKCnZhciBEYXRhT2JqZWN0Q2hpbGQgLyogaW1wbGVtZW50cyBTeW5jU3RhdHVzICovID0gKGZ1bmN0aW9uICgpIHsKICAvKiBwcml2YXRlCiAgIC0tLS1ldmVudCBoYW5kbGVycy0tLS0KICBfb25SZXNwb25zZUhhbmRsZXI6IChldmVudCkgPT4gdm9pZAogICovCgogIC8qKgogICAqIEBpZ25vcmUKICAgKiBTaG91bGQgbm90IGJlIHVzZWQgZGlyZWN0bHkgYnkgSHlwZXJ0aWVzLiBJdCdzIGNhbGxlZCBieSB0aGUgRGF0YU9iamVjdC5hZGRDaGlsZHJlbgogICAqLwoKICBmdW5jdGlvbiBEYXRhT2JqZWN0Q2hpbGQob3duZXIsIGNoaWxkSWQsIG1zZ0lkLCBidXMsIGluaXRpYWxEYXRhKSB7CiAgICBfY2xhc3NDYWxsQ2hlY2sodGhpcywgRGF0YU9iamVjdENoaWxkKTsKCiAgICB2YXIgX3RoaXMgPSB0aGlzOwoKICAgIF90aGlzLl9vd25lciA9IG93bmVyOwogICAgX3RoaXMuX2NoaWxkSWQgPSBjaGlsZElkOwogICAgX3RoaXMuX2J1cyA9IGJ1czsKICAgIF90aGlzLl9zeW5jT2JqID0gbmV3IF9TeW5jT2JqZWN0MlsnZGVmYXVsdCddKGluaXRpYWxEYXRhKTsKCiAgICBidXMuYWRkTGlzdGVuZXIob3duZXIsIGZ1bmN0aW9uIChtc2cpIHsKICAgICAgaWYgKG1zZy50eXBlID09PSAncmVzcG9uc2UnICYmIG1zZy5pZCA9PT0gbXNnSWQpIHsKICAgICAgICBjb25zb2xlLmxvZygnRGF0YU9iamVjdENoaWxkLm9uUmVzcG9uc2U6JywgbXNnKTsKICAgICAgICBfdGhpcy5fb25SZXNwb25zZShtc2cpOwogICAgICB9CiAgICB9KTsKICB9CgogIC8qKgogICAqIENoaWxkcmVuIElEIGdlbmVyYXRlZCBvbiBhZGRDaGlsZHJlbi4gVW5pcXVlIGlkZW50aWZpZXIKICAgKiBAdHlwZSB7VVJMfSAtIFVSTCBvZiB0aGUgZm9ybWF0IDxIeXBlcnR5VVJMPiM8bnVtZXJpYy1zZXF1ZW5jZT4KICAgKi8KCiAgX2NyZWF0ZUNsYXNzKERhdGFPYmplY3RDaGlsZCwgW3sKICAgIGtleTogJ29uQ2hhbmdlJywKCiAgICAvKioKICAgICAqIFJlZ2lzdGVyIHRoZSBjaGFuZ2UgbGlzdGVuZXJzIHNlbnQgYnkgdGhlIHJlcG9ydGVyIGNoaWxkCiAgICAgKiBAcGFyYW0ge2Z1bmN0aW9uKGV2ZW50OiBNc2dFdmVudCl9IGNhbGxiYWNrCiAgICAgKi8KICAgIHZhbHVlOiBmdW5jdGlvbiBvbkNoYW5nZShjYWxsYmFjaykgewogICAgICB0aGlzLl9zeW5jT2JqLm9ic2VydmUoZnVuY3Rpb24gKGV2ZW50KSB7CiAgICAgICAgY2FsbGJhY2soZXZlbnQpOwogICAgICB9KTsKICAgIH0KCiAgICAvKioKICAgICAqIFNldHVwIHRoZSBjYWxsYmFjayB0byBwcm9jZXNzIHJlc3BvbnNlIG5vdGlmaWNhdGlvbnMgb2YgdGhlIGNyZWF0ZXMKICAgICAqIEBwYXJhbSB7ZnVuY3Rpb24oZXZlbnQ6IE1zZ0V2ZW50KX0gY2FsbGJhY2sKICAgICAqLwogIH0sIHsKICAgIGtleTogJ29uUmVzcG9uc2UnLAogICAgdmFsdWU6IGZ1bmN0aW9uIG9uUmVzcG9uc2UoY2FsbGJhY2spIHsKICAgICAgdGhpcy5fb25SZXNwb25zZUhhbmRsZXIgPSBjYWxsYmFjazsKICAgIH0KICB9LCB7CiAgICBrZXk6ICdfb25SZXNwb25zZScsCiAgICB2YWx1ZTogZnVuY3Rpb24gX29uUmVzcG9uc2UobXNnKSB7CiAgICAgIHZhciBfdGhpcyA9IHRoaXM7CgogICAgICB2YXIgZXZlbnQgPSB7CiAgICAgICAgdHlwZTogbXNnLnR5cGUsCiAgICAgICAgdXJsOiBtc2cuYm9keS5zb3VyY2UsCiAgICAgICAgY29kZTogbXNnLmJvZHkuY29kZQogICAgICB9OwoKICAgICAgaWYgKF90aGlzLl9vblJlc3BvbnNlSGFuZGxlcikgewogICAgICAgIF90aGlzLl9vblJlc3BvbnNlSGFuZGxlcihldmVudCk7CiAgICAgIH0KICAgIH0KICB9LCB7CiAgICBrZXk6ICdjaGlsZElkJywKICAgIGdldDogZnVuY3Rpb24gZ2V0KCkgewogICAgICByZXR1cm4gdGhpcy5fY2hpbGRJZDsKICAgIH0KCiAgICAvKioKICAgICAqIERhdGEgU3RydWN0dXJlIHRvIGJlIHN5bmNocm9uaXplZC4KICAgICAqIEB0eXBlIHtKU09OfSAtIEpTT04gc3RydWN0dXJlIHRoYXQgc2hvdWxkIGZvbGxvdyB0aGUgZGVmaW5lZCBzY2hlbWEsIGlmIGFueS4KICAgICAqLwogIH0sIHsKICAgIGtleTogJ2RhdGEnLAogICAgZ2V0OiBmdW5jdGlvbiBnZXQoKSB7CiAgICAgIHJldHVybiB0aGlzLl9zeW5jT2JqLmRhdGE7CiAgICB9CiAgfV0pOwoKICByZXR1cm4gRGF0YU9iamVjdENoaWxkOwp9KSgpOwoKZXhwb3J0c1snZGVmYXVsdCddID0gRGF0YU9iamVjdENoaWxkOwptb2R1bGUuZXhwb3J0cyA9IGV4cG9ydHNbJ2RlZmF1bHQnXTsKCn0seyIuL1N5bmNPYmplY3QiOjEwfV0sNzpbZnVuY3Rpb24ocmVxdWlyZSxtb2R1bGUsZXhwb3J0cyl7Cid1c2Ugc3RyaWN0JzsKCk9iamVjdC5kZWZpbmVQcm9wZXJ0eShleHBvcnRzLCAnX19lc01vZHVsZScsIHsKICB2YWx1ZTogdHJ1ZQp9KTsKCnZhciBfY3JlYXRlQ2xhc3MgPSAoZnVuY3Rpb24gKCkgeyBmdW5jdGlvbiBkZWZpbmVQcm9wZXJ0aWVzKHRhcmdldCwgcHJvcHMpIHsgZm9yICh2YXIgaSA9IDA7IGkgPCBwcm9wcy5sZW5ndGg7IGkrKykgeyB2YXIgZGVzY3JpcHRvciA9IHByb3BzW2ldOyBkZXNjcmlwdG9yLmVudW1lcmFibGUgPSBkZXNjcmlwdG9yLmVudW1lcmFibGUgfHwgZmFsc2U7IGRlc2NyaXB0b3IuY29uZmlndXJhYmxlID0gdHJ1ZTsgaWYgKCd2YWx1ZScgaW4gZGVzY3JpcHRvcikgZGVzY3JpcHRvci53cml0YWJsZSA9IHRydWU7IE9iamVjdC5kZWZpbmVQcm9wZXJ0eSh0YXJnZXQsIGRlc2NyaXB0b3Iua2V5LCBkZXNjcmlwdG9yKTsgfSB9IHJldHVybiBmdW5jdGlvbiAoQ29uc3RydWN0b3IsIHByb3RvUHJvcHMsIHN0YXRpY1Byb3BzKSB7IGlmIChwcm90b1Byb3BzKSBkZWZpbmVQcm9wZXJ0aWVzKENvbnN0cnVjdG9yLnByb3RvdHlwZSwgcHJvdG9Qcm9wcyk7IGlmIChzdGF0aWNQcm9wcykgZGVmaW5lUHJvcGVydGllcyhDb25zdHJ1Y3Rvciwgc3RhdGljUHJvcHMpOyByZXR1cm4gQ29uc3RydWN0b3I7IH07IH0pKCk7Cgp2YXIgX2dldCA9IGZ1bmN0aW9uIGdldChfeCwgX3gyLCBfeDMpIHsgdmFyIF9hZ2FpbiA9IHRydWU7IF9mdW5jdGlvbjogd2hpbGUgKF9hZ2FpbikgeyB2YXIgb2JqZWN0ID0gX3gsIHByb3BlcnR5ID0gX3gyLCByZWNlaXZlciA9IF94MzsgX2FnYWluID0gZmFsc2U7IGlmIChvYmplY3QgPT09IG51bGwpIG9iamVjdCA9IEZ1bmN0aW9uLnByb3RvdHlwZTsgdmFyIGRlc2MgPSBPYmplY3QuZ2V0T3duUHJvcGVydHlEZXNjcmlwdG9yKG9iamVjdCwgcHJvcGVydHkpOyBpZiAoZGVzYyA9PT0gdW5kZWZpbmVkKSB7IHZhciBwYXJlbnQgPSBPYmplY3QuZ2V0UHJvdG90eXBlT2Yob2JqZWN0KTsgaWYgKHBhcmVudCA9PT0gbnVsbCkgeyByZXR1cm4gdW5kZWZpbmVkOyB9IGVsc2UgeyBfeCA9IHBhcmVudDsgX3gyID0gcHJvcGVydHk7IF94MyA9IHJlY2VpdmVyOyBfYWdhaW4gPSB0cnVlOyBkZXNjID0gcGFyZW50ID0gdW5kZWZpbmVkOyBjb250aW51ZSBfZnVuY3Rpb247IH0gfSBlbHNlIGlmICgndmFsdWUnIGluIGRlc2MpIHsgcmV0dXJuIGRlc2MudmFsdWU7IH0gZWxzZSB7IHZhciBnZXR0ZXIgPSBkZXNjLmdldDsgaWYgKGdldHRlciA9PT0gdW5kZWZpbmVkKSB7IHJldHVybiB1bmRlZmluZWQ7IH0gcmV0dXJuIGdldHRlci5jYWxsKHJlY2VpdmVyKTsgfSB9IH07CgpmdW5jdGlvbiBfaW50ZXJvcFJlcXVpcmVEZWZhdWx0KG9iaikgeyByZXR1cm4gb2JqICYmIG9iai5fX2VzTW9kdWxlID8gb2JqIDogeyAnZGVmYXVsdCc6IG9iaiB9OyB9CgpmdW5jdGlvbiBfY2xhc3NDYWxsQ2hlY2soaW5zdGFuY2UsIENvbnN0cnVjdG9yKSB7IGlmICghKGluc3RhbmNlIGluc3RhbmNlb2YgQ29uc3RydWN0b3IpKSB7IHRocm93IG5ldyBUeXBlRXJyb3IoJ0Nhbm5vdCBjYWxsIGEgY2xhc3MgYXMgYSBmdW5jdGlvbicpOyB9IH0KCmZ1bmN0aW9uIF9pbmhlcml0cyhzdWJDbGFzcywgc3VwZXJDbGFzcykgeyBpZiAodHlwZW9mIHN1cGVyQ2xhc3MgIT09ICdmdW5jdGlvbicgJiYgc3VwZXJDbGFzcyAhPT0gbnVsbCkgeyB0aHJvdyBuZXcgVHlwZUVycm9yKCdTdXBlciBleHByZXNzaW9uIG11c3QgZWl0aGVyIGJlIG51bGwgb3IgYSBmdW5jdGlvbiwgbm90ICcgKyB0eXBlb2Ygc3VwZXJDbGFzcyk7IH0gc3ViQ2xhc3MucHJvdG90eXBlID0gT2JqZWN0LmNyZWF0ZShzdXBlckNsYXNzICYmIHN1cGVyQ2xhc3MucHJvdG90eXBlLCB7IGNvbnN0cnVjdG9yOiB7IHZhbHVlOiBzdWJDbGFzcywgZW51bWVyYWJsZTogZmFsc2UsIHdyaXRhYmxlOiB0cnVlLCBjb25maWd1cmFibGU6IHRydWUgfSB9KTsgaWYgKHN1cGVyQ2xhc3MpIE9iamVjdC5zZXRQcm90b3R5cGVPZiA/IE9iamVjdC5zZXRQcm90b3R5cGVPZihzdWJDbGFzcywgc3VwZXJDbGFzcykgOiBzdWJDbGFzcy5fX3Byb3RvX18gPSBzdXBlckNsYXNzOyB9Cgp2YXIgX0RhdGFPYmplY3QyID0gcmVxdWlyZSgnLi9EYXRhT2JqZWN0Jyk7Cgp2YXIgX0RhdGFPYmplY3QzID0gX2ludGVyb3BSZXF1aXJlRGVmYXVsdChfRGF0YU9iamVjdDIpOwoKdmFyIEZpbHRlclR5cGUgPSB7IEFOWTogJ2FueScsIFNUQVJUOiAnc3RhcnQnLCBFWEFDVDogJ2V4YWN0JyB9OwoKdmFyIERhdGFPYmplY3RPYnNlcnZlciA9IChmdW5jdGlvbiAoX0RhdGFPYmplY3QpIHsKICBfaW5oZXJpdHMoRGF0YU9iamVjdE9ic2VydmVyLCBfRGF0YU9iamVjdCk7CgogIC8qIHByaXZhdGUKICAgLS0tLWV2ZW50IGhhbmRsZXJzLS0tLQogIF9maWx0ZXJzOiB7PGZpbHRlcj46IHt0eXBlOiA8c3RhcnQsIGV4YWN0PiwgY2FsbGJhY2s6IDxmdW5jdGlvbj59IH0KICAqLwoKICAvKioKICAgKiBAaWdub3JlCiAgICogU2hvdWxkIG5vdCBiZSB1c2VkIGRpcmVjdGx5IGJ5IEh5cGVydGllcy4gSXQncyBjYWxsZWQgYnkgdGhlIFN5bmNoZXIuc3Vic2NyaWJlIG1ldGhvZAogICAqLwoKICBmdW5jdGlvbiBEYXRhT2JqZWN0T2JzZXJ2ZXIob3duZXIsIHVybCwgc2NoZW1hLCBidXMsIGluaXRpYWxTdGF0dXMsIGluaXRpYWxEYXRhLCBjaGlsZHJlbikgewogICAgX2NsYXNzQ2FsbENoZWNrKHRoaXMsIERhdGFPYmplY3RPYnNlcnZlcik7CgogICAgX2dldChPYmplY3QuZ2V0UHJvdG90eXBlT2YoRGF0YU9iamVjdE9ic2VydmVyLnByb3RvdHlwZSksICdjb25zdHJ1Y3RvcicsIHRoaXMpLmNhbGwodGhpcywgb3duZXIsIHVybCwgc2NoZW1hLCBidXMsIGluaXRpYWxTdGF0dXMsIGluaXRpYWxEYXRhLCBjaGlsZHJlbik7CiAgICB2YXIgX3RoaXMgPSB0aGlzOwoKICAgIC8vYWRkIGxpc3RlbmVyIGZvciBvYmpVUkwKICAgIGJ1cy5hZGRMaXN0ZW5lcih1cmwsIGZ1bmN0aW9uIChtc2cpIHsKICAgICAgY29uc29sZS5sb2coJ0RhdGFPYmplY3RPYnNlcnZlci0nICsgdXJsICsgJy1SQ1Y6ICcsIG1zZyk7CiAgICAgIF90aGlzLl9jaGFuZ2VPYmplY3QoX3RoaXMuX3N5bmNPYmosIG1zZyk7CiAgICB9KTsKCiAgICBfdGhpcy5fc3luY09iai5vYnNlcnZlKGZ1bmN0aW9uIChldmVudCkgewogICAgICBfdGhpcy5fb25GaWx0ZXIoZXZlbnQpOwogICAgfSk7CgogICAgX3RoaXMuX2ZpbHRlcnMgPSB7fTsKICB9CgogIC8qKgogICAqIFJlZ2lzdGVyIHRoZSBjaGFuZ2UgbGlzdGVuZXJzIHNlbnQgYnkgdGhlIHJlcG9ydGVyCiAgICogQHBhcmFtIHtzdHJpbmd9IGZpbHRlciAtIEZpbHRlciB0aGF0IGlkZW50aWZpZXMgdGhlIGZpZWxkIChzZXBhcmV0ZWQgZG90IHBhdGgpLiBBY2NlcHRzICogYXQgdGhlIGVuZCBmb3IgYSBtb3JlIHVucmVzdHJpY3RlZCBmaWx0ZXJpbmcuCiAgICogQHBhcmFtIHtmdW5jdGlvbihldmVudDogTXNnRXZlbnQpfSBjYWxsYmFjawogICAqLwoKICBfY3JlYXRlQ2xhc3MoRGF0YU9iamVjdE9ic2VydmVyLCBbewogICAga2V5OiAnb25DaGFuZ2UnLAogICAgdmFsdWU6IGZ1bmN0aW9uIG9uQ2hhbmdlKGZpbHRlciwgY2FsbGJhY2spIHsKICAgICAgdmFyIGtleSA9IGZpbHRlcjsKICAgICAgdmFyIGZpbHRlck9iaiA9IHsKICAgICAgICB0eXBlOiBGaWx0ZXJUeXBlLkVYQUNULAogICAgICAgIGNhbGxiYWNrOiBjYWxsYmFjawogICAgICB9OwoKICAgICAgdmFyIGlkeCA9IGZpbHRlci5pbmRleE9mKCcqJyk7CiAgICAgIGlmIChpZHggPT09IGZpbHRlci5sZW5ndGggLSAxKSB7CiAgICAgICAgaWYgKGlkeCA9PT0gMCkgewogICAgICAgICAgZmlsdGVyT2JqLnR5cGUgPSBGaWx0ZXJUeXBlLkFOWTsKICAgICAgICB9IGVsc2UgewogICAgICAgICAgZmlsdGVyT2JqLnR5cGUgPSBGaWx0ZXJUeXBlLlNUQVJUOwogICAgICAgICAga2V5ID0gZmlsdGVyLnN1YnN0cigwLCBmaWx0ZXIubGVuZ3RoIC0gMSk7CiAgICAgICAgfQogICAgICB9CgogICAgICB0aGlzLl9maWx0ZXJzW2tleV0gPSBmaWx0ZXJPYmo7CiAgICB9CiAgfSwgewogICAga2V5OiAnX29uRmlsdGVyJywKICAgIHZhbHVlOiBmdW5jdGlvbiBfb25GaWx0ZXIoZXZlbnQpIHsKICAgICAgdmFyIF90aGlzID0gdGhpczsKCiAgICAgIE9iamVjdC5rZXlzKF90aGlzLl9maWx0ZXJzKS5mb3JFYWNoKGZ1bmN0aW9uIChrZXkpIHsKICAgICAgICB2YXIgZmlsdGVyID0gX3RoaXMuX2ZpbHRlcnNba2V5XTsKICAgICAgICBpZiAoZmlsdGVyLnR5cGUgPT09IEZpbHRlclR5cGUuQU5ZKSB7CiAgICAgICAgICAvL21hdGNoIGFueXRoaW5nCiAgICAgICAgICBmaWx0ZXIuY2FsbGJhY2soZXZlbnQpOwogICAgICAgIH0gZWxzZSBpZiAoZmlsdGVyLnR5cGUgPT09IEZpbHRlclR5cGUuU1RBUlQpIHsKICAgICAgICAgIC8vaWYgc3RhcnRzIHdpdGggZmlsdGVyLi4uCiAgICAgICAgICBpZiAoZXZlbnQuZmllbGQuaW5kZXhPZihrZXkpID09PSAwKSB7CiAgICAgICAgICAgIGZpbHRlci5jYWxsYmFjayhldmVudCk7CiAgICAgICAgICB9CiAgICAgICAgfSBlbHNlIGlmIChmaWx0ZXIudHlwZSA9PT0gRmlsdGVyVHlwZS5FWEFDVCkgewogICAgICAgICAgLy9leGFjdCBtYXRjaAogICAgICAgICAgaWYgKGV2ZW50LmZpZWxkID09PSBrZXkpIHsKICAgICAgICAgICAgZmlsdGVyLmNhbGxiYWNrKGV2ZW50KTsKICAgICAgICAgIH0KICAgICAgICB9CiAgICAgIH0pOwogICAgfQogIH1dKTsKCiAgcmV0dXJuIERhdGFPYmplY3RPYnNlcnZlcjsKfSkoX0RhdGFPYmplY3QzWydkZWZhdWx0J10gLyogaW1wbGVtZW50cyBTeW5jU3RhdHVzICovKTsKCmV4cG9ydHNbJ2RlZmF1bHQnXSA9IERhdGFPYmplY3RPYnNlcnZlcjsKbW9kdWxlLmV4cG9ydHMgPSBleHBvcnRzWydkZWZhdWx0J107Cgp9LHsiLi9EYXRhT2JqZWN0Ijo1fV0sODpbZnVuY3Rpb24ocmVxdWlyZSxtb2R1bGUsZXhwb3J0cyl7Cid1c2Ugc3RyaWN0JzsKCk9iamVjdC5kZWZpbmVQcm9wZXJ0eShleHBvcnRzLCAnX19lc01vZHVsZScsIHsKICB2YWx1ZTogdHJ1ZQp9KTsKCnZhciBfY3JlYXRlQ2xhc3MgPSAoZnVuY3Rpb24gKCkgeyBmdW5jdGlvbiBkZWZpbmVQcm9wZXJ0aWVzKHRhcmdldCwgcHJvcHMpIHsgZm9yICh2YXIgaSA9IDA7IGkgPCBwcm9wcy5sZW5ndGg7IGkrKykgeyB2YXIgZGVzY3JpcHRvciA9IHByb3BzW2ldOyBkZXNjcmlwdG9yLmVudW1lcmFibGUgPSBkZXNjcmlwdG9yLmVudW1lcmFibGUgfHwgZmFsc2U7IGRlc2NyaXB0b3IuY29uZmlndXJhYmxlID0gdHJ1ZTsgaWYgKCd2YWx1ZScgaW4gZGVzY3JpcHRvcikgZGVzY3JpcHRvci53cml0YWJsZSA9IHRydWU7IE9iamVjdC5kZWZpbmVQcm9wZXJ0eSh0YXJnZXQsIGRlc2NyaXB0b3Iua2V5LCBkZXNjcmlwdG9yKTsgfSB9IHJldHVybiBmdW5jdGlvbiAoQ29uc3RydWN0b3IsIHByb3RvUHJvcHMsIHN0YXRpY1Byb3BzKSB7IGlmIChwcm90b1Byb3BzKSBkZWZpbmVQcm9wZXJ0aWVzKENvbnN0cnVjdG9yLnByb3RvdHlwZSwgcHJvdG9Qcm9wcyk7IGlmIChzdGF0aWNQcm9wcykgZGVmaW5lUHJvcGVydGllcyhDb25zdHJ1Y3Rvciwgc3RhdGljUHJvcHMpOyByZXR1cm4gQ29uc3RydWN0b3I7IH07IH0pKCk7Cgp2YXIgX2dldCA9IGZ1bmN0aW9uIGdldChfeCwgX3gyLCBfeDMpIHsgdmFyIF9hZ2FpbiA9IHRydWU7IF9mdW5jdGlvbjogd2hpbGUgKF9hZ2FpbikgeyB2YXIgb2JqZWN0ID0gX3gsIHByb3BlcnR5ID0gX3gyLCByZWNlaXZlciA9IF94MzsgX2FnYWluID0gZmFsc2U7IGlmIChvYmplY3QgPT09IG51bGwpIG9iamVjdCA9IEZ1bmN0aW9uLnByb3RvdHlwZTsgdmFyIGRlc2MgPSBPYmplY3QuZ2V0T3duUHJvcGVydHlEZXNjcmlwdG9yKG9iamVjdCwgcHJvcGVydHkpOyBpZiAoZGVzYyA9PT0gdW5kZWZpbmVkKSB7IHZhciBwYXJlbnQgPSBPYmplY3QuZ2V0UHJvdG90eXBlT2Yob2JqZWN0KTsgaWYgKHBhcmVudCA9PT0gbnVsbCkgeyByZXR1cm4gdW5kZWZpbmVkOyB9IGVsc2UgeyBfeCA9IHBhcmVudDsgX3gyID0gcHJvcGVydHk7IF94MyA9IHJlY2VpdmVyOyBfYWdhaW4gPSB0cnVlOyBkZXNjID0gcGFyZW50ID0gdW5kZWZpbmVkOyBjb250aW51ZSBfZnVuY3Rpb247IH0gfSBlbHNlIGlmICgndmFsdWUnIGluIGRlc2MpIHsgcmV0dXJuIGRlc2MudmFsdWU7IH0gZWxzZSB7IHZhciBnZXR0ZXIgPSBkZXNjLmdldDsgaWYgKGdldHRlciA9PT0gdW5kZWZpbmVkKSB7IHJldHVybiB1bmRlZmluZWQ7IH0gcmV0dXJuIGdldHRlci5jYWxsKHJlY2VpdmVyKTsgfSB9IH07CgpmdW5jdGlvbiBfaW50ZXJvcFJlcXVpcmVEZWZhdWx0KG9iaikgeyByZXR1cm4gb2JqICYmIG9iai5fX2VzTW9kdWxlID8gb2JqIDogeyAnZGVmYXVsdCc6IG9iaiB9OyB9CgpmdW5jdGlvbiBfY2xhc3NDYWxsQ2hlY2soaW5zdGFuY2UsIENvbnN0cnVjdG9yKSB7IGlmICghKGluc3RhbmNlIGluc3RhbmNlb2YgQ29uc3RydWN0b3IpKSB7IHRocm93IG5ldyBUeXBlRXJyb3IoJ0Nhbm5vdCBjYWxsIGEgY2xhc3MgYXMgYSBmdW5jdGlvbicpOyB9IH0KCmZ1bmN0aW9uIF9pbmhlcml0cyhzdWJDbGFzcywgc3VwZXJDbGFzcykgeyBpZiAodHlwZW9mIHN1cGVyQ2xhc3MgIT09ICdmdW5jdGlvbicgJiYgc3VwZXJDbGFzcyAhPT0gbnVsbCkgeyB0aHJvdyBuZXcgVHlwZUVycm9yKCdTdXBlciBleHByZXNzaW9uIG11c3QgZWl0aGVyIGJlIG51bGwgb3IgYSBmdW5jdGlvbiwgbm90ICcgKyB0eXBlb2Ygc3VwZXJDbGFzcyk7IH0gc3ViQ2xhc3MucHJvdG90eXBlID0gT2JqZWN0LmNyZWF0ZShzdXBlckNsYXNzICYmIHN1cGVyQ2xhc3MucHJvdG90eXBlLCB7IGNvbnN0cnVjdG9yOiB7IHZhbHVlOiBzdWJDbGFzcywgZW51bWVyYWJsZTogZmFsc2UsIHdyaXRhYmxlOiB0cnVlLCBjb25maWd1cmFibGU6IHRydWUgfSB9KTsgaWYgKHN1cGVyQ2xhc3MpIE9iamVjdC5zZXRQcm90b3R5cGVPZiA/IE9iamVjdC5zZXRQcm90b3R5cGVPZihzdWJDbGFzcywgc3VwZXJDbGFzcykgOiBzdWJDbGFzcy5fX3Byb3RvX18gPSBzdXBlckNsYXNzOyB9Cgp2YXIgX0RhdGFPYmplY3QyID0gcmVxdWlyZSgnLi9EYXRhT2JqZWN0Jyk7Cgp2YXIgX0RhdGFPYmplY3QzID0gX2ludGVyb3BSZXF1aXJlRGVmYXVsdChfRGF0YU9iamVjdDIpOwoKdmFyIF91dGlsc1V0aWxzSnMgPSByZXF1aXJlKCcuLi91dGlscy91dGlscy5qcycpOwoKdmFyIERhdGFPYmplY3RSZXBvcnRlciA9IChmdW5jdGlvbiAoX0RhdGFPYmplY3QpIHsKICBfaW5oZXJpdHMoRGF0YU9iamVjdFJlcG9ydGVyLCBfRGF0YU9iamVjdCk7CgogIC8qIHByaXZhdGUKICBfc3Vic2NyaXB0aW9uczogPGh5cGVydHlVcmw6IHsgc3RhdHVzOiBzdHJpbmcgfSB9PgogICAtLS0tZXZlbnQgaGFuZGxlcnMtLS0tCiAgX29uU3Vic2NyaXB0aW9uSGFuZGxlcjogKGV2ZW50KSA9PiB2b2lkCiAgX29uUmVzcG9uc2VIYW5kbGVyOiAoZXZlbnQpID0+IHZvaWQKICAqLwoKICAvKioKICAgKiBAaWdub3JlCiAgICogU2hvdWxkIG5vdCBiZSB1c2VkIGRpcmVjdGx5IGJ5IEh5cGVydGllcy4gSXQncyBjYWxsZWQgYnkgdGhlIFN5bmNoZXIuY3JlYXRlIG1ldGhvZAogICAqLwoKICBmdW5jdGlvbiBEYXRhT2JqZWN0UmVwb3J0ZXIob3duZXIsIHVybCwgc2NoZW1hLCBidXMsIGluaXRpYWxTdGF0dXMsIGluaXRpYWxEYXRhLCBjaGlsZHJlbikgewogICAgX2NsYXNzQ2FsbENoZWNrKHRoaXMsIERhdGFPYmplY3RSZXBvcnRlcik7CgogICAgX2dldChPYmplY3QuZ2V0UHJvdG90eXBlT2YoRGF0YU9iamVjdFJlcG9ydGVyLnByb3RvdHlwZSksICdjb25zdHJ1Y3RvcicsIHRoaXMpLmNhbGwodGhpcywgb3duZXIsIHVybCwgc2NoZW1hLCBidXMsIGluaXRpYWxTdGF0dXMsIGluaXRpYWxEYXRhLCBjaGlsZHJlbik7CiAgICB2YXIgX3RoaXMgPSB0aGlzOwoKICAgIGJ1cy5hZGRMaXN0ZW5lcihvd25lciwgZnVuY3Rpb24gKG1zZykgewogICAgICBpZiAobXNnLnR5cGUgPT09ICdyZXNwb25zZScgJiYgbXNnLmJvZHkuc291cmNlID09PSB1cmwpIHsKICAgICAgICBfdGhpcy5fb25SZXNwb25zZShtc2cpOwogICAgICB9CiAgICB9KTsKCiAgICBfdGhpcy5fc3luY09iai5vYnNlcnZlKGZ1bmN0aW9uIChldmVudCkgewogICAgICBfdGhpcy5fb25DaGFuZ2UoZXZlbnQpOwogICAgfSk7CgogICAgX3RoaXMuX3N1YnNjcmlwdGlvbnMgPSB7fTsKICB9CgogIC8qKgogICAqIFN1YnNjcmlwdGlvbnMgcmVxdWVzdGVkIGFuZCBhY2NlcHRlZCB0byB0aGlzIHJlcG9ydGVyCiAgICogQHR5cGUge09iamVjdDxIeXBlcnR5VVJMLCBTeW5jU3Vic2NyaXB0aW9uPn0KICAgKi8KCiAgX2NyZWF0ZUNsYXNzKERhdGFPYmplY3RSZXBvcnRlciwgW3sKICAgIGtleTogJ29uU3Vic2NyaXB0aW9uJywKCiAgICAvKioKICAgICAqIFNldHVwIHRoZSBjYWxsYmFjayB0byBwcm9jZXNzIHN1YnNjcmliZSBhbmQgdW5zdWJzY3JpYmUgbm90aWZpY2F0aW9ucwogICAgICogQHBhcmFtIHtmdW5jdGlvbihldmVudDogTXNnRXZlbnQpfSBjYWxsYmFjawogICAgICovCiAgICB2YWx1ZTogZnVuY3Rpb24gb25TdWJzY3JpcHRpb24oY2FsbGJhY2spIHsKICAgICAgdGhpcy5fb25TdWJzY3JpcHRpb25IYW5kbGVyID0gY2FsbGJhY2s7CiAgICB9CgogICAgLyoqCiAgICAgKiBTZXR1cCB0aGUgY2FsbGJhY2sgdG8gcHJvY2VzcyByZXNwb25zZSBub3RpZmljYXRpb25zIG9mIHRoZSBjcmVhdGUncwogICAgICogQHBhcmFtIHtmdW5jdGlvbihldmVudDogTXNnRXZlbnQpfSBjYWxsYmFjawogICAgICovCiAgfSwgewogICAga2V5OiAnb25SZXNwb25zZScsCiAgICB2YWx1ZTogZnVuY3Rpb24gb25SZXNwb25zZShjYWxsYmFjaykgewogICAgICB0aGlzLl9vblJlc3BvbnNlSGFuZGxlciA9IGNhbGxiYWNrOwogICAgfQogIH0sIHsKICAgIGtleTogJ19vbkZvcndhcmQnLAogICAgdmFsdWU6IGZ1bmN0aW9uIF9vbkZvcndhcmQobXNnKSB7CiAgICAgIHZhciBfdGhpcyA9IHRoaXM7CgogICAgICBjb25zb2xlLmxvZygnRGF0YU9iamVjdFJlcG9ydGVyLVJDVjogJywgbXNnKTsKICAgICAgc3dpdGNoIChtc2cuYm9keS50eXBlKSB7CiAgICAgICAgY2FzZSAnc3Vic2NyaWJlJzoKICAgICAgICAgIF90aGlzLl9vblN1YnNjcmliZShtc2cpO2JyZWFrOwogICAgICAgIGNhc2UgJ3Vuc3Vic2NyaWJlJzoKICAgICAgICAgIF90aGlzLl9vblVuU3Vic2NyaWJlKG1zZyk7YnJlYWs7CiAgICAgIH0KICAgIH0KICB9LCB7CiAgICBrZXk6ICdfb25TdWJzY3JpYmUnLAogICAgdmFsdWU6IGZ1bmN0aW9uIF9vblN1YnNjcmliZShtc2cpIHsKICAgICAgdmFyIF90aGlzID0gdGhpczsKICAgICAgdmFyIGh5cGVydHlVcmwgPSBtc2cuYm9keS5mcm9tOwoKICAgICAgdmFyIGV2ZW50ID0gewogICAgICAgIHR5cGU6IG1zZy5ib2R5LnR5cGUsCiAgICAgICAgdXJsOiBoeXBlcnR5VXJsLAoKICAgICAgICBhY2NlcHQ6IGZ1bmN0aW9uIGFjY2VwdCgpIHsKICAgICAgICAgIC8vY3JlYXRlIG5ldyBzdWJzY3JpcHRpb24KICAgICAgICAgIHZhciBzdWIgPSB7IHVybDogaHlwZXJ0eVVybCwgc3RhdHVzOiAnb24nIH07CiAgICAgICAgICBfdGhpcy5fc3Vic2NyaXB0aW9uc1toeXBlcnR5VXJsXSA9IHN1YjsKCiAgICAgICAgICAvL3NlbmQgb2sgcmVzcG9uc2UgbWVzc2FnZQogICAgICAgICAgX3RoaXMuX2J1cy5wb3N0TWVzc2FnZSh7CiAgICAgICAgICAgIGlkOiBtc2cuaWQsIHR5cGU6ICdyZXNwb25zZScsIGZyb206IG1zZy50bywgdG86IG1zZy5mcm9tLAogICAgICAgICAgICBib2R5OiB7IGNvZGU6IDIwMCwgc2NoZW1hOiBfdGhpcy5fc2NoZW1hLCB2ZXJzaW9uOiBfdGhpcy5fdmVyc2lvbiwgdmFsdWU6ICgwLCBfdXRpbHNVdGlsc0pzLmRlZXBDbG9uZSkoX3RoaXMuZGF0YSkgfQogICAgICAgICAgfSk7CgogICAgICAgICAgcmV0dXJuIHN1YjsKICAgICAgICB9LAoKICAgICAgICByZWplY3Q6IGZ1bmN0aW9uIHJlamVjdChyZWFzb24pIHsKICAgICAgICAgIC8vc2VuZCByZWplY3QgcmVzcG9uc2UgbWVzc2FnZQogICAgICAgICAgX3RoaXMuX2J1cy5wb3N0TWVzc2FnZSh7CiAgICAgICAgICAgIGlkOiBtc2cuaWQsIHR5cGU6ICdyZXNwb25zZScsIGZyb206IG1zZy50bywgdG86IG1zZy5mcm9tLAogICAgICAgICAgICBib2R5OiB7IGNvZGU6IDQwMywgZGVzYzogcmVhc29uIH0KICAgICAgICAgIH0pOwogICAgICAgIH0KICAgICAgfTsKCiAgICAgIGlmIChfdGhpcy5fb25TdWJzY3JpcHRpb25IYW5kbGVyKSB7CiAgICAgICAgX3RoaXMuX29uU3Vic2NyaXB0aW9uSGFuZGxlcihldmVudCk7CiAgICAgIH0KICAgIH0KICB9LCB7CiAgICBrZXk6ICdfb25VblN1YnNjcmliZScsCiAgICB2YWx1ZTogZnVuY3Rpb24gX29uVW5TdWJzY3JpYmUobXNnKSB7CiAgICAgIHZhciBfdGhpcyA9IHRoaXM7CiAgICAgIHZhciBoeXBlcnR5VXJsID0gbXNnLmJvZHkuZnJvbTsKCiAgICAgIHZhciBzdWIgPSBfdGhpcy5fc3Vic2NyaXB0aW9uc1toeXBlcnR5VXJsXTsKICAgICAgZGVsZXRlIF90aGlzLl9zdWJzY3JpcHRpb25zW2h5cGVydHlVcmxdOwoKICAgICAgdmFyIGV2ZW50ID0gewogICAgICAgIHR5cGU6IG1zZy5ib2R5LnR5cGUsCiAgICAgICAgdXJsOiBoeXBlcnR5VXJsLAogICAgICAgIG9iamVjdDogc3ViCiAgICAgIH07CgogICAgICBpZiAoX3RoaXMuX29uU3Vic2NyaXB0aW9uSGFuZGxlcikgewogICAgICAgIF90aGlzLl9vblN1YnNjcmlwdGlvbkhhbmRsZXIoZXZlbnQpOwogICAgICB9CiAgICB9CiAgfSwgewogICAga2V5OiAnX29uUmVzcG9uc2UnLAogICAgdmFsdWU6IGZ1bmN0aW9uIF9vblJlc3BvbnNlKG1zZykgewogICAgICB2YXIgX3RoaXMgPSB0aGlzOwoKICAgICAgdmFyIGV2ZW50ID0gewogICAgICAgIHR5cGU6IG1zZy50eXBlLAogICAgICAgIHVybDogbXNnLmZyb20sCiAgICAgICAgY29kZTogbXNnLmJvZHkuY29kZQogICAgICB9OwoKICAgICAgaWYgKF90aGlzLl9vblJlc3BvbnNlSGFuZGxlcikgewogICAgICAgIF90aGlzLl9vblJlc3BvbnNlSGFuZGxlcihldmVudCk7CiAgICAgIH0KICAgIH0KICB9LCB7CiAgICBrZXk6ICdzdWJzY3JpcHRpb25zJywKICAgIGdldDogZnVuY3Rpb24gZ2V0KCkgewogICAgICByZXR1cm4gdGhpcy5fc3Vic2NyaXB0aW9uczsKICAgIH0KICB9XSk7CgogIHJldHVybiBEYXRhT2JqZWN0UmVwb3J0ZXI7Cn0pKF9EYXRhT2JqZWN0M1snZGVmYXVsdCddIC8qIGltcGxlbWVudHMgU3luY1N0YXR1cyAqLyk7CgpleHBvcnRzWydkZWZhdWx0J10gPSBEYXRhT2JqZWN0UmVwb3J0ZXI7Cm1vZHVsZS5leHBvcnRzID0gZXhwb3J0c1snZGVmYXVsdCddOwoKfSx7Ii4uL3V0aWxzL3V0aWxzLmpzIjoxMywiLi9EYXRhT2JqZWN0Ijo1fV0sOTpbZnVuY3Rpb24ocmVxdWlyZSxtb2R1bGUsZXhwb3J0cyl7Ci8qKgogKiBAYWNjZXNzIHByaXZhdGUKICovCid1c2Ugc3RyaWN0JzsKCk9iamVjdC5kZWZpbmVQcm9wZXJ0eShleHBvcnRzLCAnX19lc01vZHVsZScsIHsKICB2YWx1ZTogdHJ1ZQp9KTsKCnZhciBfY3JlYXRlQ2xhc3MgPSAoZnVuY3Rpb24gKCkgeyBmdW5jdGlvbiBkZWZpbmVQcm9wZXJ0aWVzKHRhcmdldCwgcHJvcHMpIHsgZm9yICh2YXIgaSA9IDA7IGkgPCBwcm9wcy5sZW5ndGg7IGkrKykgeyB2YXIgZGVzY3JpcHRvciA9IHByb3BzW2ldOyBkZXNjcmlwdG9yLmVudW1lcmFibGUgPSBkZXNjcmlwdG9yLmVudW1lcmFibGUgfHwgZmFsc2U7IGRlc2NyaXB0b3IuY29uZmlndXJhYmxlID0gdHJ1ZTsgaWYgKCd2YWx1ZScgaW4gZGVzY3JpcHRvcikgZGVzY3JpcHRvci53cml0YWJsZSA9IHRydWU7IE9iamVjdC5kZWZpbmVQcm9wZXJ0eSh0YXJnZXQsIGRlc2NyaXB0b3Iua2V5LCBkZXNjcmlwdG9yKTsgfSB9IHJldHVybiBmdW5jdGlvbiAoQ29uc3RydWN0b3IsIHByb3RvUHJvcHMsIHN0YXRpY1Byb3BzKSB7IGlmIChwcm90b1Byb3BzKSBkZWZpbmVQcm9wZXJ0aWVzKENvbnN0cnVjdG9yLnByb3RvdHlwZSwgcHJvdG9Qcm9wcyk7IGlmIChzdGF0aWNQcm9wcykgZGVmaW5lUHJvcGVydGllcyhDb25zdHJ1Y3Rvciwgc3RhdGljUHJvcHMpOyByZXR1cm4gQ29uc3RydWN0b3I7IH07IH0pKCk7CgpmdW5jdGlvbiBfY2xhc3NDYWxsQ2hlY2soaW5zdGFuY2UsIENvbnN0cnVjdG9yKSB7IGlmICghKGluc3RhbmNlIGluc3RhbmNlb2YgQ29uc3RydWN0b3IpKSB7IHRocm93IG5ldyBUeXBlRXJyb3IoJ0Nhbm5vdCBjYWxsIGEgY2xhc3MgYXMgYSBmdW5jdGlvbicpOyB9IH0KCnZhciBEYXRhUHJvdmlzaW9uYWwgPSAoZnVuY3Rpb24gKCkgewogIC8qIHByaXZhdGUKICBfY2hpbGRyZW5MaXN0ZW5lcnM6IFtNc2dMaXN0ZW5lcl0KICBfbGlzdGVuZXI6IE1zZ0xpc3RlbmVyCiAgIF9jaGFuZ2VzOiBbXQogICovCgogIGZ1bmN0aW9uIERhdGFQcm92aXNpb25hbChvd25lciwgdXJsLCBidXMsIGNoaWxkcmVuKSB7CiAgICBfY2xhc3NDYWxsQ2hlY2sodGhpcywgRGF0YVByb3Zpc2lvbmFsKTsKCiAgICB2YXIgX3RoaXMgPSB0aGlzOwoKICAgIF90aGlzLl9jaGFuZ2VzID0gW107CiAgICBfdGhpcy5fY2hpbGRyZW4gPSBjaGlsZHJlbjsKICAgIF90aGlzLl9jaGlsZHJlbkxpc3RlbmVycyA9IFtdOwoKICAgIF90aGlzLl9saXN0ZW5lciA9IGJ1cy5hZGRMaXN0ZW5lcih1cmwsIGZ1bmN0aW9uIChtc2cpIHsKICAgICAgY29uc29sZS5sb2coJ0RhdGFQcm92aXNpb25hbC0nICsgdXJsICsgJy1SQ1Y6ICcsIG1zZyk7CiAgICAgIF90aGlzLl9jaGFuZ2VzLnB1c2gobXNnKTsKICAgIH0pOwoKICAgIC8qaWYgKGNoaWxkcmVuKSB7CiAgICAgIGxldCBjaGlsZEJhc2VVUkwgPSB1cmwgKyAnL2NoaWxkcmVuLyc7CiAgICAgIGNoaWxkcmVuLmZvckVhY2goKGNoaWxkKSA9PiB7CiAgICAgICAgbGV0IGNoaWxkVVJMID0gY2hpbGRCYXNlVVJMICsgY2hpbGQ7CiAgICAgICAgbGV0IGxpc3RlbmVyID0gYnVzLmFkZExpc3RlbmVyKGNoaWxkVVJMLCAobXNnKSA9PiB7CiAgICAgICAgICAvL2lnbm9yZSBtc2cgc2VudCBieSBoaW1zZWxmCiAgICAgICAgICBpZiAobXNnLmZyb20gIT09IG93bmVyKSB7CiAgICAgICAgICAgIGNvbnNvbGUubG9nKG1zZyk7CiAgICAgICAgICB9CiAgICAgICAgfSk7CiAgICAgICAgIF90aGlzLl9jaGlsZHJlbkxpc3RlbmVycy5wdXNoKGxpc3RlbmVyKTsKICAgICAgfSk7CiAgICB9Ki8KICB9CgogIF9jcmVhdGVDbGFzcyhEYXRhUHJvdmlzaW9uYWwsIFt7CiAgICBrZXk6ICdhcHBseScsCiAgICB2YWx1ZTogZnVuY3Rpb24gYXBwbHkob2JzZXJ2ZXIpIHsKICAgICAgdmFyIF90aGlzID0gdGhpczsKICAgICAgX3RoaXMuX2NoYW5nZXMuZm9yRWFjaChmdW5jdGlvbiAoY2hhbmdlKSB7CiAgICAgICAgb2JzZXJ2ZXIuX2NoYW5nZU9iamVjdChvYnNlcnZlci5fc3luY09iaiwgY2hhbmdlKTsKICAgICAgfSk7CiAgICB9CiAgfSwgewogICAga2V5OiAncmVsZWFzZScsCiAgICB2YWx1ZTogZnVuY3Rpb24gcmVsZWFzZSgpIHsKICAgICAgdGhpcy5fbGlzdGVuZXIucmVtb3ZlKCk7CgogICAgICAvKnRoaXMuX2NoaWxkcmVuTGlzdGVuZXJzLmZvckVhY2goKGxpc3RlbmVyKSA9PiB7CiAgICAgICAgbGlzdGVuZXIucmVtb3ZlKCk7CiAgICAgIH0pOyovCiAgICB9CiAgfSwgewogICAga2V5OiAnY2hpbGRyZW4nLAogICAgZ2V0OiBmdW5jdGlvbiBnZXQoKSB7CiAgICAgIHJldHVybiB0aGlzLl9jaGlsZHJlbjsKICAgIH0KICB9XSk7CgogIHJldHVybiBEYXRhUHJvdmlzaW9uYWw7Cn0pKCk7CgpleHBvcnRzWydkZWZhdWx0J10gPSBEYXRhUHJvdmlzaW9uYWw7Cm1vZHVsZS5leHBvcnRzID0gZXhwb3J0c1snZGVmYXVsdCddOwoKfSx7fV0sMTA6W2Z1bmN0aW9uKHJlcXVpcmUsbW9kdWxlLGV4cG9ydHMpewondXNlIHN0cmljdCc7CgpPYmplY3QuZGVmaW5lUHJvcGVydHkoZXhwb3J0cywgJ19fZXNNb2R1bGUnLCB7CiAgdmFsdWU6IHRydWUKfSk7Cgp2YXIgX2NyZWF0ZUNsYXNzID0gKGZ1bmN0aW9uICgpIHsgZnVuY3Rpb24gZGVmaW5lUHJvcGVydGllcyh0YXJnZXQsIHByb3BzKSB7IGZvciAodmFyIGkgPSAwOyBpIDwgcHJvcHMubGVuZ3RoOyBpKyspIHsgdmFyIGRlc2NyaXB0b3IgPSBwcm9wc1tpXTsgZGVzY3JpcHRvci5lbnVtZXJhYmxlID0gZGVzY3JpcHRvci5lbnVtZXJhYmxlIHx8IGZhbHNlOyBkZXNjcmlwdG9yLmNvbmZpZ3VyYWJsZSA9IHRydWU7IGlmICgndmFsdWUnIGluIGRlc2NyaXB0b3IpIGRlc2NyaXB0b3Iud3JpdGFibGUgPSB0cnVlOyBPYmplY3QuZGVmaW5lUHJvcGVydHkodGFyZ2V0LCBkZXNjcmlwdG9yLmtleSwgZGVzY3JpcHRvcik7IH0gfSByZXR1cm4gZnVuY3Rpb24gKENvbnN0cnVjdG9yLCBwcm90b1Byb3BzLCBzdGF0aWNQcm9wcykgeyBpZiAocHJvdG9Qcm9wcykgZGVmaW5lUHJvcGVydGllcyhDb25zdHJ1Y3Rvci5wcm90b3R5cGUsIHByb3RvUHJvcHMpOyBpZiAoc3RhdGljUHJvcHMpIGRlZmluZVByb3BlcnRpZXMoQ29uc3RydWN0b3IsIHN0YXRpY1Byb3BzKTsgcmV0dXJuIENvbnN0cnVjdG9yOyB9OyB9KSgpOwoKZnVuY3Rpb24gX2NsYXNzQ2FsbENoZWNrKGluc3RhbmNlLCBDb25zdHJ1Y3RvcikgeyBpZiAoIShpbnN0YW5jZSBpbnN0YW5jZW9mIENvbnN0cnVjdG9yKSkgeyB0aHJvdyBuZXcgVHlwZUVycm9yKCdDYW5ub3QgY2FsbCBhIGNsYXNzIGFzIGEgZnVuY3Rpb24nKTsgfSB9Cgp2YXIgX3V0aWxzVXRpbHNKcyA9IHJlcXVpcmUoJy4uL3V0aWxzL3V0aWxzLmpzJyk7CgovKioKICogQGFjY2VzcyBwcml2YXRlCiAqLwoKdmFyIFN5bmNPYmplY3QgPSAoZnVuY3Rpb24gKCkgewogIC8qIHByaXZhdGUKICAgIF9kYXRhOiBhbnk7CiAgICBfb2JzZXJ2ZXJzOiAoKGV2ZW50OiBDaGFuZ2VFdmVudCkgPT4gdm9pZClbXQogICovCgogIGZ1bmN0aW9uIFN5bmNPYmplY3QoaW5pdGlhbERhdGEpIHsKICAgIF9jbGFzc0NhbGxDaGVjayh0aGlzLCBTeW5jT2JqZWN0KTsKCiAgICB2YXIgX3RoaXMgPSB0aGlzOwoKICAgIF90aGlzLl9vYnNlcnZlcnMgPSBbXTsKICAgIF90aGlzLl9maWx0ZXJzID0ge307CgogICAgaWYgKGluaXRpYWxEYXRhKSB7CiAgICAgIF90aGlzLl9kYXRhID0gaW5pdGlhbERhdGE7CiAgICB9IGVsc2UgewogICAgICBfdGhpcy5fZGF0YSA9IHt9OwogICAgfQoKICAgIF90aGlzLl9pbnRlcm5hbE9ic2VydmUobmV3IFBhdGgoKSwgX3RoaXMuX2RhdGEpOwogIH0KCiAgLy9keW5hbWljIHBhdGggZm9yIEFycmF5IGluZGV4Li4uCgogIF9jcmVhdGVDbGFzcyhTeW5jT2JqZWN0LCBbewogICAga2V5OiAnb2JzZXJ2ZScsCiAgICB2YWx1ZTogZnVuY3Rpb24gb2JzZXJ2ZShjYWxsYmFjaykgewogICAgICB0aGlzLl9vYnNlcnZlcnMucHVzaChjYWxsYmFjayk7CiAgICB9CiAgfSwgewogICAga2V5OiAnZmluZCcsCiAgICB2YWx1ZTogZnVuY3Rpb24gZmluZChwYXRoKSB7CiAgICAgIHZhciBsaXN0ID0gcGF0aC5zcGxpdCgnLicpOwoKICAgICAgcmV0dXJuIHRoaXMuX2ZpbmRXaXRoU3BsaXQobGlzdCk7CiAgICB9CiAgfSwgewogICAga2V5OiAnZmluZEJlZm9yZScsCiAgICB2YWx1ZTogZnVuY3Rpb24gZmluZEJlZm9yZShwYXRoKSB7CiAgICAgIHZhciByZXN1bHQgPSB7fTsKICAgICAgdmFyIGxpc3QgPSBwYXRoLnNwbGl0KCcuJyk7CiAgICAgIHJlc3VsdC5sYXN0ID0gbGlzdC5wb3AoKTsKICAgICAgcmVzdWx0Lm9iaiA9IHRoaXMuX2ZpbmRXaXRoU3BsaXQobGlzdCk7CgogICAgICByZXR1cm4gcmVzdWx0OwogICAgfQogIH0sIHsKICAgIGtleTogJ19maW5kV2l0aFNwbGl0JywKICAgIHZhbHVlOiBmdW5jdGlvbiBfZmluZFdpdGhTcGxpdChsaXN0KSB7CiAgICAgIHZhciBvYmogPSB0aGlzLl9kYXRhOwogICAgICBsaXN0LmZvckVhY2goZnVuY3Rpb24gKHZhbHVlKSB7CiAgICAgICAgb2JqID0gb2JqW3ZhbHVlXTsKICAgICAgfSk7CgogICAgICByZXR1cm4gb2JqOwogICAgfQogIH0sIHsKICAgIGtleTogJ19maXJlRXZlbnQnLAogICAgdmFsdWU6IGZ1bmN0aW9uIF9maXJlRXZlbnQoZXZlbnQpIHsKICAgICAgdGhpcy5fb2JzZXJ2ZXJzLmZvckVhY2goZnVuY3Rpb24gKGNhbGxiYWNrKSB7CiAgICAgICAgY2FsbGJhY2soZXZlbnQpOwogICAgICB9KTsKICAgIH0KICB9LCB7CiAgICBrZXk6ICdfaXNPYnNlcnZhYmxlJywKICAgIHZhbHVlOiBmdW5jdGlvbiBfaXNPYnNlcnZhYmxlKG9iaikgewogICAgICBpZiAob2JqLmNvbnN0cnVjdG9yID09PSBPYmplY3QgfHwgb2JqLmNvbnN0cnVjdG9yID09PSBBcnJheSkgewogICAgICAgIHJldHVybiB0cnVlOwogICAgICB9CgogICAgICByZXR1cm4gZmFsc2U7CiAgICB9CiAgfSwgewogICAga2V5OiAnX2ludGVybmFsT2JzZXJ2ZScsCiAgICB2YWx1ZTogZnVuY3Rpb24gX2ludGVybmFsT2JzZXJ2ZShwYXRoLCBvYmopIHsKICAgICAgdmFyIF90aGlzID0gdGhpczsKCiAgICAgIGlmIChfdGhpcy5faXNPYnNlcnZhYmxlKG9iaikpIHsKICAgICAgICB2YXIgaGFuZGxlciA9IGZ1bmN0aW9uIGhhbmRsZXIoY2hhbmdlcykgewogICAgICAgICAgX3RoaXMuX29uQ2hhbmdlcyhwYXRoLCBjaGFuZ2VzKTsKICAgICAgICB9OwoKICAgICAgICBpZiAob2JqLmNvbnN0cnVjdG9yID09PSBPYmplY3QpIHsKICAgICAgICAgIE9iamVjdC5vYnNlcnZlKG9iaiwgaGFuZGxlcik7CiAgICAgICAgICBmb3IgKHZhciBwcm9wIGluIG9iaikgewogICAgICAgICAgICBpZiAoX3RoaXMuX2lzT2JzZXJ2YWJsZShvYmpbcHJvcF0pKSB7CiAgICAgICAgICAgICAgX3RoaXMuX2ludGVybmFsT2JzZXJ2ZShwYXRoWyduZXcnXShwcm9wKSwgb2JqW3Byb3BdKTsKICAgICAgICAgICAgfQogICAgICAgICAgfQogICAgICAgIH0gZWxzZSBpZiAob2JqLmNvbnN0cnVjdG9yID09PSBBcnJheSkgewogICAgICAgICAgQXJyYXkub2JzZXJ2ZShvYmosIGhhbmRsZXIpOwogICAgICAgICAgZm9yICh2YXIgcHJvcCBpbiBvYmopIHsKICAgICAgICAgICAgaWYgKF90aGlzLl9pc09ic2VydmFibGUob2JqW3Byb3BdKSkgewogICAgICAgICAgICAgIHZhciBucCA9IHBhdGhbJ25ldyddKG5ldyBBcnJheUluZGV4KG9ialtwcm9wXSwgcHJvcCkpOwogICAgICAgICAgICAgIF90aGlzLl9pbnRlcm5hbE9ic2VydmUobnAsIG9ialtwcm9wXSk7CiAgICAgICAgICAgIH0KICAgICAgICAgIH0KICAgICAgICB9CiAgICAgIH0KICAgIH0KICB9LCB7CiAgICBrZXk6ICdfb25DaGFuZ2VzJywKICAgIHZhbHVlOiBmdW5jdGlvbiBfb25DaGFuZ2VzKHBhdGgsIGNoYW5nZXMpIHsKICAgICAgdmFyIF90aGlzMiA9IHRoaXM7CgogICAgICBmb3IgKHZhciBpIGluIGNoYW5nZXMpIHsKICAgICAgICB2YXIgb2JqID0gY2hhbmdlc1tpXS5vYmplY3Q7CiAgICAgICAgdmFyIG9ialR5cGUgPSB1bmRlZmluZWQ7CgogICAgICAgIGlmIChvYmouY29uc3RydWN0b3IgPT09IE9iamVjdCkgewogICAgICAgICAgb2JqVHlwZSA9IE9iamVjdFR5cGUuT0JKRUNUOwogICAgICAgIH0KCiAgICAgICAgaWYgKG9iai5jb25zdHJ1Y3RvciA9PT0gQXJyYXkpIHsKICAgICAgICAgIG9ialR5cGUgPSBPYmplY3RUeXBlLkFSUkFZOwogICAgICAgIH0KCiAgICAgICAgaWYgKGNoYW5nZXNbaV0udHlwZSA9PT0gJ3NwbGljZScpIHsKICAgICAgICAgIChmdW5jdGlvbiAoKSB7CiAgICAgICAgICAgIHZhciBpZHggPSBjaGFuZ2VzW2ldLmluZGV4OwogICAgICAgICAgICB2YXIgZmllbGQgPSBwYXRoWyduZXcnXSgnJyArIGlkeCk7CiAgICAgICAgICAgIHZhciBmaWVsZFN0cmluZyA9IGZpZWxkLnRvU3RyaW5nKCk7CgogICAgICAgICAgICB2YXIgcmVtb3ZlU2l6ZSA9IGNoYW5nZXNbaV0ucmVtb3ZlZC5sZW5ndGg7CiAgICAgICAgICAgIGlmIChyZW1vdmVTaXplICE9PSAwKSB7CiAgICAgICAgICAgICAgdmFyIHJlbW92ZVZhbHVlcyA9IGNoYW5nZXNbaV0ucmVtb3ZlZDsKICAgICAgICAgICAgICByZW1vdmVWYWx1ZXMuZm9yRWFjaChmdW5jdGlvbiAodmFsdWUsIGluZGV4KSB7CiAgICAgICAgICAgICAgICBpZiAoX3RoaXMyLl9pc09ic2VydmFibGUodmFsdWUpKSB7CiAgICAgICAgICAgICAgICAgIHBhdGgucmVtb3ZlSW5kZXgoaWR4ICsgaW5kZXgpOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIH0pOwoKICAgICAgICAgICAgICBfdGhpczIuX2ZpcmVFdmVudCh7CiAgICAgICAgICAgICAgICBjVHlwZTogQ2hhbmdlVHlwZS5SRU1PVkUsCiAgICAgICAgICAgICAgICBvVHlwZTogb2JqVHlwZSwKICAgICAgICAgICAgICAgIGZpZWxkOiBmaWVsZFN0cmluZywKICAgICAgICAgICAgICAgIGRhdGE6IHJlbW92ZVNpemUKICAgICAgICAgICAgICB9KTsKICAgICAgICAgICAgfQoKICAgICAgICAgICAgdmFyIGFkZFNpemUgPSBjaGFuZ2VzW2ldLmFkZGVkQ291bnQ7CiAgICAgICAgICAgIGlmIChhZGRTaXplICE9PSAwKSB7CiAgICAgICAgICAgICAgdmFyIGFkZFZhbHVlcyA9IG9iai5zbGljZShpZHgsIGlkeCArIGFkZFNpemUpOwogICAgICAgICAgICAgIGFkZFZhbHVlcy5mb3JFYWNoKGZ1bmN0aW9uICh2YWx1ZSwgaW5kZXgpIHsKICAgICAgICAgICAgICAgIGlmIChfdGhpczIuX2lzT2JzZXJ2YWJsZSh2YWx1ZSkpIHsKICAgICAgICAgICAgICAgICAgdmFyIG5wID0gcGF0aFsnbmV3J10obmV3IEFycmF5SW5kZXgodmFsdWUsIGlkeCArIGluZGV4KSk7CiAgICAgICAgICAgICAgICAgIF90aGlzMi5faW50ZXJuYWxPYnNlcnZlKG5wLCB2YWx1ZSk7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgfSk7CgogICAgICAgICAgICAgIF90aGlzMi5fZmlyZUV2ZW50KHsKICAgICAgICAgICAgICAgIGNUeXBlOiBDaGFuZ2VUeXBlLkFERCwKICAgICAgICAgICAgICAgIG9UeXBlOiBvYmpUeXBlLAogICAgICAgICAgICAgICAgZmllbGQ6IGZpZWxkU3RyaW5nLAogICAgICAgICAgICAgICAgZGF0YTogKDAsIF91dGlsc1V0aWxzSnMuZGVlcENsb25lKShhZGRWYWx1ZXMpCiAgICAgICAgICAgICAgfSk7CiAgICAgICAgICAgIH0KCiAgICAgICAgICAgIC8vcmUtZGVmaW5lIHBhdGhzLi4uCiAgICAgICAgICAgIGlmIChpZHggIT09IG9iai5sZW5ndGggLSAxKSB7CiAgICAgICAgICAgICAgcGF0aC5yZUluZGV4RnJvbShvYmopOwogICAgICAgICAgICB9CiAgICAgICAgICB9KSgpOwogICAgICAgIH0gZWxzZSB7CiAgICAgICAgICB2YXIgZmllbGQgPSBwYXRoWyduZXcnXShjaGFuZ2VzW2ldLm5hbWUpOwogICAgICAgICAgdmFyIGZpZWxkU3RyaW5nID0gZmllbGQudG9TdHJpbmcoKTsKCiAgICAgICAgICBpZiAoZmllbGRTdHJpbmcuaW5kZXhPZignU3ltYm9sJykgIT09IC0xKSB7CiAgICAgICAgICAgIC8vaGFjayBmb3IgUGhhbnRvbUpTMgogICAgICAgICAgICAvL2NvbnNvbGUubG9nKCdTWU1CT0w6ICcsIGNoYW5nZXNbaV0pOwogICAgICAgICAgICBjb250aW51ZTsKICAgICAgICAgIH0KCiAgICAgICAgICAvL2xldCBvbGRWYWx1ZSA9IGNoYW5nZXNbaV0ub2xkVmFsdWU7CiAgICAgICAgICB2YXIgbmV3VmFsdWUgPSBvYmpbY2hhbmdlc1tpXS5uYW1lXTsKICAgICAgICAgIGlmIChjaGFuZ2VzW2ldLnR5cGUgPT09ICd1cGRhdGUnKSB7CiAgICAgICAgICAgIHRoaXMuX2ZpcmVFdmVudCh7CiAgICAgICAgICAgICAgY1R5cGU6IENoYW5nZVR5cGUuVVBEQVRFLAogICAgICAgICAgICAgIG9UeXBlOiBvYmpUeXBlLAogICAgICAgICAgICAgIGZpZWxkOiBmaWVsZFN0cmluZywKICAgICAgICAgICAgICBkYXRhOiAoMCwgX3V0aWxzVXRpbHNKcy5kZWVwQ2xvbmUpKG5ld1ZhbHVlKQogICAgICAgICAgICB9KTsKICAgICAgICAgIH0KCiAgICAgICAgICBpZiAoY2hhbmdlc1tpXS50eXBlID09PSAnYWRkJykgewogICAgICAgICAgICB0aGlzLl9pbnRlcm5hbE9ic2VydmUoZmllbGQsIG5ld1ZhbHVlKTsKICAgICAgICAgICAgdGhpcy5fZmlyZUV2ZW50KHsKICAgICAgICAgICAgICBjVHlwZTogQ2hhbmdlVHlwZS5BREQsCiAgICAgICAgICAgICAgb1R5cGU6IG9ialR5cGUsCiAgICAgICAgICAgICAgZmllbGQ6IGZpZWxkU3RyaW5nLAogICAgICAgICAgICAgIGRhdGE6ICgwLCBfdXRpbHNVdGlsc0pzLmRlZXBDbG9uZSkobmV3VmFsdWUpCiAgICAgICAgICAgIH0pOwogICAgICAgICAgfQoKICAgICAgICAgIGlmIChjaGFuZ2VzW2ldLnR5cGUgPT09ICdkZWxldGUnKSB7CiAgICAgICAgICAgIHRoaXMuX2ZpcmVFdmVudCh7CiAgICAgICAgICAgICAgY1R5cGU6IENoYW5nZVR5cGUuUkVNT1ZFLAogICAgICAgICAgICAgIG9UeXBlOiBvYmpUeXBlLAogICAgICAgICAgICAgIGZpZWxkOiBmaWVsZFN0cmluZwogICAgICAgICAgICB9KTsKICAgICAgICAgIH0KICAgICAgICB9CiAgICAgIH0KICAgIH0KICB9LCB7CiAgICBrZXk6ICdkYXRhJywKICAgIGdldDogZnVuY3Rpb24gZ2V0KCkgewogICAgICByZXR1cm4gdGhpcy5fZGF0YTsKICAgIH0KICB9XSk7CgogIHJldHVybiBTeW5jT2JqZWN0Owp9KSgpOwoKdmFyIFBhdGggPSAoZnVuY3Rpb24gKCkgewogIGZ1bmN0aW9uIFBhdGgoKSB7CiAgICBfY2xhc3NDYWxsQ2hlY2sodGhpcywgUGF0aCk7CgogICAgdGhpcy5fcGF0aCA9IFtdOwogICAgdGhpcy5fb2JzZXJ2YWJsZXMgPSB7fTsgLy88aW5kZXg6QXJyYXlJbmRleD4KICB9CgogIF9jcmVhdGVDbGFzcyhQYXRoLCBbewogICAga2V5OiAncmVtb3ZlSW5kZXgnLAogICAgdmFsdWU6IGZ1bmN0aW9uIHJlbW92ZUluZGV4KGlkeCkgewogICAgICAvL2NvbnNvbGUubG9nKCdSRU1PVkUtUEFUSCAnICsgaWR4KTsKICAgICAgZGVsZXRlIHRoaXMuX29ic2VydmFibGVzW2lkeF07CiAgICB9CiAgfSwgewogICAga2V5OiAncmVJbmRleEZyb20nLAogICAgdmFsdWU6IGZ1bmN0aW9uIHJlSW5kZXhGcm9tKGFycmF5KSB7CiAgICAgIHZhciBfdGhpczMgPSB0aGlzOwoKICAgICAgT2JqZWN0LmtleXModGhpcy5fb2JzZXJ2YWJsZXMpLmZvckVhY2goZnVuY3Rpb24gKGtleSkgewogICAgICAgIHZhciBhcnJheUluZGV4ID0gX3RoaXMzLl9vYnNlcnZhYmxlc1trZXldOwogICAgICAgIHZhciBpZHggPSBhcnJheS5pbmRleE9mKGFycmF5SW5kZXgub2JqKTsKICAgICAgICBpZiAoYXJyYXlJbmRleC5pZHggIT0gaWR4KSB7CiAgICAgICAgICAvL2NvbnNvbGUubG9nKCdSRS1JTkRFWDogJyArIGtleSArICctPicgKyBpZHgpOwogICAgICAgICAgYXJyYXlJbmRleC5pZHggPSBpZHg7CiAgICAgICAgICBkZWxldGUgX3RoaXMzLl9vYnNlcnZhYmxlc1trZXldOwogICAgICAgICAgX3RoaXMzLl9vYnNlcnZhYmxlc1tpZHhdID0gYXJyYXlJbmRleDsKICAgICAgICB9CiAgICAgIH0pOwogICAgfQogIH0sIHsKICAgIGtleTogJ25ldycsCiAgICB2YWx1ZTogZnVuY3Rpb24gX25ldyhpZHgpIHsKICAgICAgaWYgKGlkeC5jb25zdHJ1Y3RvciA9PSBBcnJheUluZGV4KSB7CiAgICAgICAgLy9jb25zb2xlLmxvZygnUEFUSC1PQlNFUlY6ICcsIGlkeCk7CiAgICAgICAgdGhpcy5fb2JzZXJ2YWJsZXNbaWR4LmlkeF0gPSBpZHg7CiAgICAgIH0KCiAgICAgIHZhciBuUGF0aCA9IHRoaXMuY2xvbmUoKTsKICAgICAgblBhdGguX3BhdGgucHVzaChpZHgpOwoKICAgICAgcmV0dXJuIG5QYXRoOwogICAgfQogIH0sIHsKICAgIGtleTogJ2Nsb25lJywKICAgIHZhbHVlOiBmdW5jdGlvbiBjbG9uZSgpIHsKICAgICAgdmFyIG5QYXRoID0gbmV3IFBhdGgoKTsKICAgICAgdGhpcy5fcGF0aC5mb3JFYWNoKGZ1bmN0aW9uICh2YWx1ZSkgewogICAgICAgIG5QYXRoLl9wYXRoLnB1c2godmFsdWUpOwogICAgICB9KTsKCiAgICAgIHJldHVybiBuUGF0aDsKICAgIH0KICB9LCB7CiAgICBrZXk6ICd0b1N0cmluZycsCiAgICB2YWx1ZTogZnVuY3Rpb24gdG9TdHJpbmcoKSB7CiAgICAgIC8vVE9ETzogb3B0aW1pemUhIQogICAgICB2YXIgc3RyID0gJyc7CiAgICAgIHRoaXMuX3BhdGguZm9yRWFjaChmdW5jdGlvbiAodmFsdWUsIGluZGV4KSB7CiAgICAgICAgaWYgKGluZGV4ID09PSAwKSB7CiAgICAgICAgICBzdHIgPSB2YWx1ZS50b1N0cmluZygpOwogICAgICAgIH0gZWxzZSB7CiAgICAgICAgICBzdHIgKz0gJy4nICsgdmFsdWUudG9TdHJpbmcoKTsKICAgICAgICB9CiAgICAgIH0pOwoKICAgICAgcmV0dXJuIHN0cjsKICAgIH0KICB9XSk7CgogIHJldHVybiBQYXRoOwp9KSgpOwoKdmFyIEFycmF5SW5kZXggPSAoZnVuY3Rpb24gKCkgewogIGZ1bmN0aW9uIEFycmF5SW5kZXgob2JqLCBpZHgpIHsKICAgIF9jbGFzc0NhbGxDaGVjayh0aGlzLCBBcnJheUluZGV4KTsKCiAgICB0aGlzLm9iaiA9IG9iajsKICAgIHRoaXMuaWR4ID0gaWR4OwogIH0KCiAgX2NyZWF0ZUNsYXNzKEFycmF5SW5kZXgsIFt7CiAgICBrZXk6ICd0b1N0cmluZycsCiAgICB2YWx1ZTogZnVuY3Rpb24gdG9TdHJpbmcoKSB7CiAgICAgIHJldHVybiB0aGlzLmlkeC50b1N0cmluZygpOwogICAgfQogIH1dKTsKCiAgcmV0dXJuIEFycmF5SW5kZXg7Cn0pKCk7Cgp2YXIgQ2hhbmdlVHlwZSA9IHsgVVBEQVRFOiAndXBkYXRlJywgQUREOiAnYWRkJywgUkVNT1ZFOiAncmVtb3ZlJyB9OwpleHBvcnRzLkNoYW5nZVR5cGUgPSBDaGFuZ2VUeXBlOwp2YXIgT2JqZWN0VHlwZSA9IHsgT0JKRUNUOiAnb2JqZWN0JywgQVJSQVk6ICdhcnJheScgfTsKZXhwb3J0cy5PYmplY3RUeXBlID0gT2JqZWN0VHlwZTsKZXhwb3J0c1snZGVmYXVsdCddID0gU3luY09iamVjdDsKCn0seyIuLi91dGlscy91dGlscy5qcyI6MTN9XSwxMTpbZnVuY3Rpb24ocmVxdWlyZSxtb2R1bGUsZXhwb3J0cyl7Cid1c2Ugc3RyaWN0JzsKCk9iamVjdC5kZWZpbmVQcm9wZXJ0eShleHBvcnRzLCAnX19lc01vZHVsZScsIHsKICB2YWx1ZTogdHJ1ZQp9KTsKCnZhciBfY3JlYXRlQ2xhc3MgPSAoZnVuY3Rpb24gKCkgeyBmdW5jdGlvbiBkZWZpbmVQcm9wZXJ0aWVzKHRhcmdldCwgcHJvcHMpIHsgZm9yICh2YXIgaSA9IDA7IGkgPCBwcm9wcy5sZW5ndGg7IGkrKykgeyB2YXIgZGVzY3JpcHRvciA9IHByb3BzW2ldOyBkZXNjcmlwdG9yLmVudW1lcmFibGUgPSBkZXNjcmlwdG9yLmVudW1lcmFibGUgfHwgZmFsc2U7IGRlc2NyaXB0b3IuY29uZmlndXJhYmxlID0gdHJ1ZTsgaWYgKCd2YWx1ZScgaW4gZGVzY3JpcHRvcikgZGVzY3JpcHRvci53cml0YWJsZSA9IHRydWU7IE9iamVjdC5kZWZpbmVQcm9wZXJ0eSh0YXJnZXQsIGRlc2NyaXB0b3Iua2V5LCBkZXNjcmlwdG9yKTsgfSB9IHJldHVybiBmdW5jdGlvbiAoQ29uc3RydWN0b3IsIHByb3RvUHJvcHMsIHN0YXRpY1Byb3BzKSB7IGlmIChwcm90b1Byb3BzKSBkZWZpbmVQcm9wZXJ0aWVzKENvbnN0cnVjdG9yLnByb3RvdHlwZSwgcHJvdG9Qcm9wcyk7IGlmIChzdGF0aWNQcm9wcykgZGVmaW5lUHJvcGVydGllcyhDb25zdHJ1Y3Rvciwgc3RhdGljUHJvcHMpOyByZXR1cm4gQ29uc3RydWN0b3I7IH07IH0pKCk7CgpmdW5jdGlvbiBfaW50ZXJvcFJlcXVpcmVEZWZhdWx0KG9iaikgeyByZXR1cm4gb2JqICYmIG9iai5fX2VzTW9kdWxlID8gb2JqIDogeyAnZGVmYXVsdCc6IG9iaiB9OyB9CgpmdW5jdGlvbiBfY2xhc3NDYWxsQ2hlY2soaW5zdGFuY2UsIENvbnN0cnVjdG9yKSB7IGlmICghKGluc3RhbmNlIGluc3RhbmNlb2YgQ29uc3RydWN0b3IpKSB7IHRocm93IG5ldyBUeXBlRXJyb3IoJ0Nhbm5vdCBjYWxsIGEgY2xhc3MgYXMgYSBmdW5jdGlvbicpOyB9IH0KCnZhciBfRGF0YU9iamVjdFJlcG9ydGVyID0gcmVxdWlyZSgnLi9EYXRhT2JqZWN0UmVwb3J0ZXInKTsKCnZhciBfRGF0YU9iamVjdFJlcG9ydGVyMiA9IF9pbnRlcm9wUmVxdWlyZURlZmF1bHQoX0RhdGFPYmplY3RSZXBvcnRlcik7Cgp2YXIgX0RhdGFPYmplY3RPYnNlcnZlciA9IHJlcXVpcmUoJy4vRGF0YU9iamVjdE9ic2VydmVyJyk7Cgp2YXIgX0RhdGFPYmplY3RPYnNlcnZlcjIgPSBfaW50ZXJvcFJlcXVpcmVEZWZhdWx0KF9EYXRhT2JqZWN0T2JzZXJ2ZXIpOwoKdmFyIF9EYXRhUHJvdmlzaW9uYWwgPSByZXF1aXJlKCcuL0RhdGFQcm92aXNpb25hbCcpOwoKdmFyIF9EYXRhUHJvdmlzaW9uYWwyID0gX2ludGVyb3BSZXF1aXJlRGVmYXVsdChfRGF0YVByb3Zpc2lvbmFsKTsKCi8qKgogKiBAYXV0aG9yIG1pY2FlbHBlZHJvc2FAZ21haWwuY29tCiAqIENsaWVudCBBUEkgU3luY3Jvbml6YXRpb24gc3lzdGVtLgogKi8KCnZhciBTeW5jaGVyID0gKGZ1bmN0aW9uICgpIHsKICAvKiBwcml2YXRlCiAgX293bmVyOiBVUkwKICBfYnVzOiBNaW5pQnVzCiAgIF9zdWJVUkw6IFVSTAogICBfcmVwb3J0ZXJzOiA8dXJsOiBEYXRhT2JqZWN0UmVwb3J0ZXI+CiAgX29ic2VydmVyczogPHVybDogRGF0YU9iamVjdE9ic2VydmVyPgogIF9wcm92aXNpb25hbHM6IDx1cmw6IERhdGFQcm92aXNpb25hbD4KICAgLS0tLWV2ZW50IGhhbmRsZXJzLS0tLQogIF9vbk5vdGlmaWNhdGlvbkhhbmRsZXI6IChldmVudCkgPT4gdm9pZAogICovCgogIC8qKgogICAqIENvbnN0cnVjdG9yIHRoYXQgc2hvdWxkIGJlIHVzZWQgYnkgdGhlIEh5cGVydHkgb3duZXIKICAgKiBAcGFyYW0ge0h5cGVydHlVUkx9IG93bmVyIC0gSHlwZXJ0eSBVUkwgb3duZXIKICAgKiBAcGFyYW0ge01pbmlCdXN9IGJ1cyAtIFRoZSBpbnRlcm5hbCBzYW5kYm94IE1pbmlCdXMgdXNlZCBieSB0aGUgSHlwZXJ0eQogICAqIEBwYXJhbSB7SlNPTn0gY29uZmlnIC0gVGhlIG9ubHkgcmVxdWlyZWQgZmllbGQgZm9yIG5vdyBpcyBydW50aW1lVVJMCiAgICovCgogIGZ1bmN0aW9uIFN5bmNoZXIob3duZXIsIGJ1cywgY29uZmlnKSB7CiAgICBfY2xhc3NDYWxsQ2hlY2sodGhpcywgU3luY2hlcik7CgogICAgdmFyIF90aGlzID0gdGhpczsKCiAgICBfdGhpcy5fb3duZXIgPSBvd25lcjsKICAgIF90aGlzLl9idXMgPSBidXM7CgogICAgX3RoaXMuX3N1YlVSTCA9IGNvbmZpZy5ydW50aW1lVVJMICsgJy9zbSc7CgogICAgX3RoaXMuX3JlcG9ydGVycyA9IHt9OwogICAgX3RoaXMuX29ic2VydmVycyA9IHt9OwogICAgX3RoaXMuX3Byb3Zpc2lvbmFscyA9IHt9OwoKICAgIGJ1cy5hZGRMaXN0ZW5lcihvd25lciwgZnVuY3Rpb24gKG1zZykgewogICAgICBjb25zb2xlLmxvZygnU3luY2hlci1SQ1Y6ICcsIG1zZyk7CiAgICAgIHN3aXRjaCAobXNnLnR5cGUpIHsKICAgICAgICBjYXNlICdmb3J3YXJkJzoKICAgICAgICAgIF90aGlzLl9vbkZvcndhcmQobXNnKTticmVhazsKICAgICAgICBjYXNlICdjcmVhdGUnOgogICAgICAgICAgX3RoaXMuX29uUmVtb3RlQ3JlYXRlKG1zZyk7YnJlYWs7CiAgICAgIH0KICAgIH0pOwogIH0KCiAgLyoqCiAgICogVGhlIG93bmVyIG9mIHRoZSBTeW5jaGVyIGFuZCBhbGwgY3JlYXRlZCByZXBvcnRlcnMuCiAgICogQHR5cGUge0h5cGVydHlVUkx9CiAgICovCgogIF9jcmVhdGVDbGFzcyhTeW5jaGVyLCBbewogICAga2V5OiAnY3JlYXRlJywKCiAgICAvKioKICAgICAqIFJlcXVlc3QgYSBEYXRhT2JqZWN0UmVwb3J0ZXIgY3JlYXRpb24uIFRoZSBVUkwgd2lsbCBiZSBiZSByZXF1ZXN0ZWQgYnkgdGhlIGFsbG9jYXRpb24gbWVjaGFuaXNtLgogICAgICogQHBhcmFtICB7U2NoZW1hVVJMfSBzY2hlbWEgLSBVUkwgb2YgdGhlIG9iamVjdCBkZXNjcmlwdG9yCiAgICAgKiBAcGFyYW0gIHtIeXBlcnR5VVJMW119IG9ic2VydmVycyAtIExpc3Qgb2YgaHlwZXJ0aWVzIHRoYXQgYXJlIHByZS1hdXRob3JpemVkIGZvciBzdWJzY3JpcHRpb24KICAgICAqIEBwYXJhbSAge0pTT059IGluaXRpYWxEYXRhIC0gSW5pdGlhbCBkYXRhIG9mIHRoZSByZXBvcnRlcgogICAgICogQHJldHVybiB7UHJvbWlzZTxEYXRhT2JqZWN0UmVwb3J0ZXI+fSBSZXR1cm4gUHJvbWlzZSB0byBhIG5ldyBSZXBvcnRlci4gVGhlIHJlcG9ydGVyIGNhbiBiZSBhY2NlcHRlZCBvciByZWplY3RlZCBieSB0aGUgUEVQCiAgICAgKi8KICAgIHZhbHVlOiBmdW5jdGlvbiBjcmVhdGUoc2NoZW1hLCBvYnNlcnZlcnMsIGluaXRpYWxEYXRhKSB7CiAgICAgIHZhciBfdGhpcyA9IHRoaXM7CgogICAgICB2YXIgcmVxdWVzdE1zZyA9IHsKICAgICAgICB0eXBlOiAnY3JlYXRlJywgZnJvbTogX3RoaXMuX293bmVyLCB0bzogX3RoaXMuX3N1YlVSTCwKICAgICAgICBib2R5OiB7IHNjaGVtYTogc2NoZW1hLCB2YWx1ZTogaW5pdGlhbERhdGEsIGF1dGhvcmlzZTogb2JzZXJ2ZXJzIH0KICAgICAgfTsKCiAgICAgIHJldHVybiBuZXcgUHJvbWlzZShmdW5jdGlvbiAocmVzb2x2ZSwgcmVqZWN0KSB7CiAgICAgICAgLy9yZXF1ZXN0IGNyZWF0ZSB0byB0aGUgQWxsb2NhdGlvbiBzeXN0ZW0/IENhbiBiZSByZWplY3RlZCBieSB0aGUgUG9saWN5RW5naW5lLgogICAgICAgIF90aGlzLl9idXMucG9zdE1lc3NhZ2UocmVxdWVzdE1zZywgZnVuY3Rpb24gKHJlcGx5KSB7CiAgICAgICAgICBjb25zb2xlLmxvZygnY3JlYXRlLXJlc3BvbnNlOiAnLCByZXBseSk7CiAgICAgICAgICBpZiAocmVwbHkuYm9keS5jb2RlID09PSAyMDApIHsKICAgICAgICAgICAgdmFyIG9ialVSTCA9IHJlcGx5LmJvZHkucmVzb3VyY2U7CgogICAgICAgICAgICAvL3JlcG9ydGVyIGNyZWF0aW9uIGFjY2VwdGVkCiAgICAgICAgICAgIHZhciBuZXdPYmogPSBuZXcgX0RhdGFPYmplY3RSZXBvcnRlcjJbJ2RlZmF1bHQnXShfdGhpcy5fb3duZXIsIG9ialVSTCwgc2NoZW1hLCBfdGhpcy5fYnVzLCAnb24nLCBpbml0aWFsRGF0YSwgcmVwbHkuYm9keS5jaGlsZHJlbik7CiAgICAgICAgICAgIF90aGlzLl9yZXBvcnRlcnNbb2JqVVJMXSA9IG5ld09iajsKCiAgICAgICAgICAgIHJlc29sdmUobmV3T2JqKTsKICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgIC8vcmVwb3J0ZXIgY3JlYXRpb24gcmVqZWN0ZWQKICAgICAgICAgICAgcmVqZWN0KHJlcGx5LmJvZHkuZGVzYyk7CiAgICAgICAgICB9CiAgICAgICAgfSk7CiAgICAgIH0pOwogICAgfQoKICAgIC8qKgogICAgICogUmVxdWVzdCBhIHN1YnNjcmlwdGlvbiB0byBhbiBleGlzdGVudCBvYmplY3QuCiAgICAgKiBAcGFyYW0ge1NjaGVtYVVSTH0gc2NoZW1hIC0gVVJMIG9mIHRoZSBvYmplY3QgZGVzY3JpcHRvcgogICAgICogQHBhcmFtIHtPYmplY3RVUkx9IG9ialVSTCAtIEFkZHJlc3Mgb2YgdGhlIGV4aXN0ZW50IHJlcG9ydGVyIG9iamVjdAogICAgICogQHJldHVybiB7UHJvbWlzZTxEYXRhT2JqZWN0T2JzZXJ2ZXI+fSBSZXR1cm4gUHJvbWlzZSB0byBhIG5ldyBvYnNlcnZlci4KICAgICAqLwogIH0sIHsKICAgIGtleTogJ3N1YnNjcmliZScsCiAgICB2YWx1ZTogZnVuY3Rpb24gc3Vic2NyaWJlKHNjaGVtYSwgb2JqVVJMKSB7CiAgICAgIHZhciBfdGhpcyA9IHRoaXM7CgogICAgICAvL1RPRE86IHZhbGlkYXRlIGlmIHN1YnNjcmlwdGlvbiBhbHJlYWR5IGV4aXN0cyA/CiAgICAgIHZhciBzdWJzY3JpYmVNc2cgPSB7CiAgICAgICAgdHlwZTogJ3N1YnNjcmliZScsIGZyb206IF90aGlzLl9vd25lciwgdG86IF90aGlzLl9zdWJVUkwsCiAgICAgICAgYm9keTogeyBzY2hlbWE6IHNjaGVtYSwgcmVzb3VyY2U6IG9ialVSTCB9CiAgICAgIH07CgogICAgICByZXR1cm4gbmV3IFByb21pc2UoZnVuY3Rpb24gKHJlc29sdmUsIHJlamVjdCkgewogICAgICAgIC8vcmVxdWVzdCBzdWJzY3JpcHRpb24KICAgICAgICBfdGhpcy5fYnVzLnBvc3RNZXNzYWdlKHN1YnNjcmliZU1zZywgZnVuY3Rpb24gKHJlcGx5KSB7CiAgICAgICAgICBjb25zb2xlLmxvZygnc3Vic2NyaWJlLXJlc3BvbnNlOiAnLCByZXBseSk7CiAgICAgICAgICB2YXIgbmV3UHJvdmlzaW9uYWwgPSBfdGhpcy5fcHJvdmlzaW9uYWxzW29ialVSTF07CiAgICAgICAgICBkZWxldGUgX3RoaXMuX3Byb3Zpc2lvbmFsc1tvYmpVUkxdOwogICAgICAgICAgaWYgKG5ld1Byb3Zpc2lvbmFsKSBuZXdQcm92aXNpb25hbC5yZWxlYXNlKCk7CgogICAgICAgICAgaWYgKHJlcGx5LmJvZHkuY29kZSA8IDIwMCkgewogICAgICAgICAgICBuZXdQcm92aXNpb25hbCA9IG5ldyBfRGF0YVByb3Zpc2lvbmFsMlsnZGVmYXVsdCddKF90aGlzLl9vd25lciwgb2JqVVJMLCBfdGhpcy5fYnVzLCByZXBseS5ib2R5LmNoaWxkcmVuUmVzb3VyY2VzKTsKICAgICAgICAgICAgX3RoaXMuX3Byb3Zpc2lvbmFsc1tvYmpVUkxdID0gbmV3UHJvdmlzaW9uYWw7CiAgICAgICAgICB9IGVsc2UgaWYgKHJlcGx5LmJvZHkuY29kZSA9PT0gMjAwKSB7CiAgICAgICAgICAgIHZhciBuZXdPYmogPSBuZXcgX0RhdGFPYmplY3RPYnNlcnZlcjJbJ2RlZmF1bHQnXShfdGhpcy5fb3duZXIsIG9ialVSTCwgc2NoZW1hLCBfdGhpcy5fYnVzLCAnb24nLCByZXBseS5ib2R5LnZhbHVlLCBuZXdQcm92aXNpb25hbC5jaGlsZHJlbik7CgogICAgICAgICAgICByZXNvbHZlKG5ld09iaik7CiAgICAgICAgICAgIG5ld1Byb3Zpc2lvbmFsLmFwcGx5KG5ld09iaik7CiAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICByZWplY3QocmVwbHkuYm9keS5kZXNjKTsKICAgICAgICAgIH0KICAgICAgICB9KTsKICAgICAgfSk7CiAgICB9CgogICAgLyoqCiAgICAgKiBTZXR1cCB0aGUgY2FsbGJhY2sgdG8gcHJvY2VzcyBjcmVhdGUgYW5kIGRlbGV0ZSBldmVudHMgb2YgcmVtb3ZlIFJlcG9ydGVyIG9iamVjdHMuCiAgICAgKiBUaGlzIGlzIHJlbGVhdGVkIHRvIHRoZSBtZXNzYWdlbnMgc2VudCBieSBjcmVhdGUgdG8gdGhlIG9ic2VydmVycyBIeXBlcnR5IGFycmF5LgogICAgICogQHBhcmFtIHtmdW5jdGlvbihldmVudDogTXNnRXZlbnQpfSBjYWxsYmFjawogICAgICovCiAgfSwgewogICAga2V5OiAnb25Ob3RpZmljYXRpb24nLAogICAgdmFsdWU6IGZ1bmN0aW9uIG9uTm90aWZpY2F0aW9uKGNhbGxiYWNrKSB7CiAgICAgIHRoaXMuX29uTm90aWZpY2F0aW9uSGFuZGxlciA9IGNhbGxiYWNrOwogICAgfQogIH0sIHsKICAgIGtleTogJ19vbkZvcndhcmQnLAogICAgdmFsdWU6IGZ1bmN0aW9uIF9vbkZvcndhcmQobXNnKSB7CiAgICAgIHZhciBfdGhpcyA9IHRoaXM7CgogICAgICB2YXIgcmVwb3J0ZXIgPSBfdGhpcy5fcmVwb3J0ZXJzW21zZy5ib2R5LnRvXTsKICAgICAgcmVwb3J0ZXIuX29uRm9yd2FyZChtc2cpOwogICAgfQogIH0sIHsKICAgIGtleTogJ19vblJlbW90ZUNyZWF0ZScsCiAgICB2YWx1ZTogZnVuY3Rpb24gX29uUmVtb3RlQ3JlYXRlKG1zZykgewogICAgICB2YXIgX3RoaXMgPSB0aGlzOwoKICAgICAgdmFyIGV2ZW50ID0gewogICAgICAgIHR5cGU6IG1zZy50eXBlLAogICAgICAgIGZyb206IG1zZy5mcm9tLAogICAgICAgIHVybDogbXNnLmJvZHkucmVzb3VyY2UsCiAgICAgICAgc2NoZW1hOiBtc2cuYm9keS5zY2hlbWEsCiAgICAgICAgdmFsdWU6IG1zZy5ib2R5LnZhbHVlLAoKICAgICAgICBhY2s6IGZ1bmN0aW9uIGFjayh0eXBlKSB7CiAgICAgICAgICB2YXIgbFR5cGUgPSAyMDA7CiAgICAgICAgICBpZiAodHlwZSkgewogICAgICAgICAgICBsVHlwZSA9IHR5cGU7CiAgICAgICAgICB9CgogICAgICAgICAgLy9zZW5kIGFjayByZXNwb25zZSBtZXNzYWdlCiAgICAgICAgICBfdGhpcy5fYnVzLnBvc3RNZXNzYWdlKHsKICAgICAgICAgICAgaWQ6IG1zZy5pZCwgdHlwZTogJ3Jlc3BvbnNlJywgZnJvbTogbXNnLnRvLCB0bzogbXNnLmZyb20sCiAgICAgICAgICAgIGJvZHk6IHsgY29kZTogbFR5cGUsIHNvdXJjZTogbXNnLmJvZHkucmVzb3VyY2UgfQogICAgICAgICAgfSk7CiAgICAgICAgfQogICAgICB9OwoKICAgICAgaWYgKF90aGlzLl9vbk5vdGlmaWNhdGlvbkhhbmRsZXIpIHsKICAgICAgICBfdGhpcy5fb25Ob3RpZmljYXRpb25IYW5kbGVyKGV2ZW50KTsKICAgICAgfQogICAgfQogIH0sIHsKICAgIGtleTogJ293bmVyJywKICAgIGdldDogZnVuY3Rpb24gZ2V0KCkgewogICAgICByZXR1cm4gdGhpcy5fb3duZXI7CiAgICB9CgogICAgLyoqCiAgICAgKiBBbGwgb3duZWQgcmVwb3J0ZXJzLCB0aGUgb25lcyB0aGF0IHdlcmUgY3JlYXRlZCBieSBhIGNyZWF0ZQogICAgICogQHR5cGUge09iamVjdDxVUkwsIERhdGFPYmplY3RSZXBvcnRlcj59CiAgICAgKi8KICB9LCB7CiAgICBrZXk6ICdyZXBvcnRlcnMnLAogICAgZ2V0OiBmdW5jdGlvbiBnZXQoKSB7CiAgICAgIHJldHVybiB0aGlzLl9yZXBvcnRlcnM7CiAgICB9CgogICAgLyoqCiAgICAgKiBBbGwgb3duZWQgb2JzZXJ2ZXJzLCB0aGUgb25lcyB0aGF0IHdlcmUgY3JlYXRlZCBieSBhIGxvY2FsIHN1YnNjcmlwdGlvbgogICAgICogQHR5cGUge09iamVjdDxVUkwsIERhdGFPYmplY3RPYnNlcnZlcj59CiAgICAgKi8KICB9LCB7CiAgICBrZXk6ICdvYnNlcnZlcnMnLAogICAgZ2V0OiBmdW5jdGlvbiBnZXQoKSB7CiAgICAgIHJldHVybiB0aGlzLl9vYnNlcnZlcnM7CiAgICB9CiAgfV0pOwoKICByZXR1cm4gU3luY2hlcjsKfSkoKTsKCmV4cG9ydHNbJ2RlZmF1bHQnXSA9IFN5bmNoZXI7Cm1vZHVsZS5leHBvcnRzID0gZXhwb3J0c1snZGVmYXVsdCddOwoKfSx7Ii4vRGF0YU9iamVjdE9ic2VydmVyIjo3LCIuL0RhdGFPYmplY3RSZXBvcnRlciI6OCwiLi9EYXRhUHJvdmlzaW9uYWwiOjl9XSwxMjpbZnVuY3Rpb24ocmVxdWlyZSxtb2R1bGUsZXhwb3J0cyl7Ci8qKgogKiBFdmVudEVtaXR0ZXIKICogQWxsIGNsYXNzZXMgd2hpY2ggZXh0ZW5kcyB0aGlzLCBjYW4gaGF2ZSBhZGRFdmVudExpc3RlbmVyIGFuZCB0cmlnZ2VyIGV2ZW50czsKICovCiJ1c2Ugc3RyaWN0IjsKCk9iamVjdC5kZWZpbmVQcm9wZXJ0eShleHBvcnRzLCAiX19lc01vZHVsZSIsIHsKICB2YWx1ZTogdHJ1ZQp9KTsKCnZhciBfY3JlYXRlQ2xhc3MgPSAoZnVuY3Rpb24gKCkgeyBmdW5jdGlvbiBkZWZpbmVQcm9wZXJ0aWVzKHRhcmdldCwgcHJvcHMpIHsgZm9yICh2YXIgaSA9IDA7IGkgPCBwcm9wcy5sZW5ndGg7IGkrKykgeyB2YXIgZGVzY3JpcHRvciA9IHByb3BzW2ldOyBkZXNjcmlwdG9yLmVudW1lcmFibGUgPSBkZXNjcmlwdG9yLmVudW1lcmFibGUgfHwgZmFsc2U7IGRlc2NyaXB0b3IuY29uZmlndXJhYmxlID0gdHJ1ZTsgaWYgKCJ2YWx1ZSIgaW4gZGVzY3JpcHRvcikgZGVzY3JpcHRvci53cml0YWJsZSA9IHRydWU7IE9iamVjdC5kZWZpbmVQcm9wZXJ0eSh0YXJnZXQsIGRlc2NyaXB0b3Iua2V5LCBkZXNjcmlwdG9yKTsgfSB9IHJldHVybiBmdW5jdGlvbiAoQ29uc3RydWN0b3IsIHByb3RvUHJvcHMsIHN0YXRpY1Byb3BzKSB7IGlmIChwcm90b1Byb3BzKSBkZWZpbmVQcm9wZXJ0aWVzKENvbnN0cnVjdG9yLnByb3RvdHlwZSwgcHJvdG9Qcm9wcyk7IGlmIChzdGF0aWNQcm9wcykgZGVmaW5lUHJvcGVydGllcyhDb25zdHJ1Y3Rvciwgc3RhdGljUHJvcHMpOyByZXR1cm4gQ29uc3RydWN0b3I7IH07IH0pKCk7CgpmdW5jdGlvbiBfY2xhc3NDYWxsQ2hlY2soaW5zdGFuY2UsIENvbnN0cnVjdG9yKSB7IGlmICghKGluc3RhbmNlIGluc3RhbmNlb2YgQ29uc3RydWN0b3IpKSB7IHRocm93IG5ldyBUeXBlRXJyb3IoIkNhbm5vdCBjYWxsIGEgY2xhc3MgYXMgYSBmdW5jdGlvbiIpOyB9IH0KCnZhciBFdmVudEVtaXR0ZXIgPSAoZnVuY3Rpb24gKCkgewogIGZ1bmN0aW9uIEV2ZW50RW1pdHRlcigpIHsKICAgIF9jbGFzc0NhbGxDaGVjayh0aGlzLCBFdmVudEVtaXR0ZXIpOwogIH0KCiAgX2NyZWF0ZUNsYXNzKEV2ZW50RW1pdHRlciwgW3sKICAgIGtleTogImFkZEV2ZW50TGlzdGVuZXIiLAoKICAgIC8qKgogICAgICogYWRkRXZlbnRMaXN0ZW5lciBsaXN0ZW4gZm9yIGFuIGV2ZW50VHlwZQogICAgICogQHBhcmFtICB7c3RyaW5nfSAgICAgICAgIGV2ZW50VHlwZSAtIGxpc3RlbmluZyBmb3IgdGhpcyB0eXBlIG9mIGV2ZW50CiAgICAgKiBAcGFyYW0gIHtGdW5jdGlvbn0gICAgICAgY2IgICAgICAgIC0gY2FsbGJhY2sgZnVuY3Rpb24gd2lsbCBiZSBleGVjdXRlZCB3aGVuIHRoZSBldmVudCBpdCBpcyBpbnZva2VkCiAgICAgKi8KICAgIHZhbHVlOiBmdW5jdGlvbiBhZGRFdmVudExpc3RlbmVyKGV2ZW50VHlwZSwgY2IpIHsKICAgICAgdmFyIF90aGlzID0gdGhpczsKICAgICAgX3RoaXNbZXZlbnRUeXBlXSA9IGNiOwogICAgfQoKICAgIC8qKgogICAgICogSW52b2tlIHRoZSBldmVudFR5cGUKICAgICAqIEBwYXJhbSAge3N0cmluZ30gZXZlbnRUeXBlIC0gZXZlbnQgd2lsbCBiZSBpbnZva2VkCiAgICAgKiBAcGFyYW0gIHtvYmplY3R9IHBhcmFtcyAtIHBhcmFtZXRlcnMgd2lsbCBiZSBwYXNzZWQgdG8gdGhlIGFkZEV2ZW50TGlzdGVuZXIKICAgICAqLwogIH0sIHsKICAgIGtleTogInRyaWdnZXIiLAogICAgdmFsdWU6IGZ1bmN0aW9uIHRyaWdnZXIoZXZlbnRUeXBlLCBwYXJhbXMpIHsKICAgICAgdmFyIF90aGlzID0gdGhpczsKCiAgICAgIGlmIChfdGhpc1tldmVudFR5cGVdKSB7CiAgICAgICAgX3RoaXNbZXZlbnRUeXBlXShwYXJhbXMpOwogICAgICB9CiAgICB9CiAgfV0pOwoKICByZXR1cm4gRXZlbnRFbWl0dGVyOwp9KSgpOwoKZXhwb3J0c1siZGVmYXVsdCJdID0gRXZlbnRFbWl0dGVyOwptb2R1bGUuZXhwb3J0cyA9IGV4cG9ydHNbImRlZmF1bHQiXTsKCn0se31dLDEzOltmdW5jdGlvbihyZXF1aXJlLG1vZHVsZSxleHBvcnRzKXsKLyoqCiAqIFN1cHBvcnQgbW9kdWxlIHdpdGggc29tZSBmdW5jdGlvbnMgd2lsbCBiZSB1c2VmdWwKICogQG1vZHVsZSB1dGlscwogKi8KCi8qKgogKiBAdHlwZWRlZiBkaXZpZGVVUkwKICogQHR5cGUgT2JqZWN0CiAqIEBwcm9wZXJ0eSB7c3RyaW5nfSB0eXBlIFRoZSB0eXBlIG9mIFVSTAogKiBAcHJvcGVydHkge3N0cmluZ30gZG9tYWluIFRoZSBkb21haW4gb2YgVVJMCiAqIEBwcm9wZXJ0eSB7c3RyaW5nfSBpZGVudGl0eSBUaGUgaWRlbnRpdHkgb2YgVVJMCiAqLwoKLyoqCiAqIERpdmlkZSBhbiB1cmwgaW4gdHlwZSwgZG9tYWluIGFuZCBpZGVudGl0eQogKiBAcGFyYW0gIHtVUkwuVVJMfSB1cmwgLSB1cmwgYWRkcmVzcwogKiBAcmV0dXJuIHtkaXZpZGVVUkx9IHRoZSByZXN1bHQgb2YgZGl2aWRlVVJMCiAqLwondXNlIHN0cmljdCc7CgpPYmplY3QuZGVmaW5lUHJvcGVydHkoZXhwb3J0cywgJ19fZXNNb2R1bGUnLCB7CiAgdmFsdWU6IHRydWUKfSk7CmV4cG9ydHMuZGl2aWRlVVJMID0gZGl2aWRlVVJMOwpleHBvcnRzLmRlZXBDbG9uZSA9IGRlZXBDbG9uZTsKCmZ1bmN0aW9uIGRpdmlkZVVSTCh1cmwpIHsKCiAgLy8gbGV0IHJlID0gLyhbYS16QS1aLV0qKT86XC9cLyg/OlwuKT8oWy1hLXpBLVowLTlAOiUuX1wrfiM9XXsyLDI1Nn1cLlthLXpdezIsNn1cYikqKFwvW1wvXGRcd1wuLV0qKSooPzpbXD9dKSooLispKi9naTsKICB2YXIgcmUgPSAvKFthLXpBLVotXSopOlwvXC8oPzpcLik/KFstYS16QS1aMC05QDolLl9cK34jPV17MiwyNTZ9KShbLWEtekEtWjAtOUA6JS5fXCt+Iz1cL10qKS9naTsKICB2YXIgc3Vic3QgPSAnJDEsJDIsJDMnOwogIHZhciBwYXJ0cyA9IHVybC5yZXBsYWNlKHJlLCBzdWJzdCkuc3BsaXQoJywnKTsKICB2YXIgcmVzdWx0ID0gewogICAgdHlwZTogcGFydHNbMF0sCiAgICBkb21haW46IHBhcnRzWzFdLAogICAgaWRlbnRpdHk6IHBhcnRzWzJdCiAgfTsKCiAgcmV0dXJuIHJlc3VsdDsKfQoKLyoqCiAqIE1ha2UgYSBDT1BZIG9mIHRoZSBvcmlnaW5hbCBkYXRhCiAqIEBwYXJhbSAge09iamVjdH0gIG9iaiAtIG9iamVjdCB0byBiZSBjbG9uZWQKICogQHJldHVybiB7T2JqZWN0fQogKi8KCmZ1bmN0aW9uIGRlZXBDbG9uZShvYmopIHsKICAvL1RPRE86IHNpbXBsZSBidXQgaW5lZmZpY2llbnQgSlNPTiBkZWVwIGNsb25lLi4uCiAgcmV0dXJuIEpTT04ucGFyc2UoSlNPTi5zdHJpbmdpZnkob2JqKSk7Cn0KCn0se31dfSx7fSxbM10pKDMpCn0pOw==",
      "sourceCodeClassname": "HypertyChat",
      "encoding": "base64",
      "signature": ""
    },
    "cguid": 1,
    "type": "Hyperties",
    "version": "0.1",
    "description": "Description of HypertyChat",
    "objectName": "HypertyChat",
    "sourcePackageURL": "/sourcePackage",
    "language": "javascript",
    "signature": "",
    "messageSchemas": "",
    "dataObjects": [],
    "accessControlPolicy": "somePolicy"
  },
  "HypertyDiscovery": {
    "sourcePackage": {
      "sourceCode": "KGZ1bmN0aW9uKGYpe2lmKHR5cGVvZiBleHBvcnRzPT09Im9iamVjdCImJnR5cGVvZiBtb2R1bGUhPT0idW5kZWZpbmVkIil7bW9kdWxlLmV4cG9ydHM9ZigpfWVsc2UgaWYodHlwZW9mIGRlZmluZT09PSJmdW5jdGlvbiImJmRlZmluZS5hbWQpe2RlZmluZShbXSxmKX1lbHNle3ZhciBnO2lmKHR5cGVvZiB3aW5kb3chPT0idW5kZWZpbmVkIil7Zz13aW5kb3d9ZWxzZSBpZih0eXBlb2YgZ2xvYmFsIT09InVuZGVmaW5lZCIpe2c9Z2xvYmFsfWVsc2UgaWYodHlwZW9mIHNlbGYhPT0idW5kZWZpbmVkIil7Zz1zZWxmfWVsc2V7Zz10aGlzfWcuYWN0aXZhdGUgPSBmKCl9fSkoZnVuY3Rpb24oKXt2YXIgZGVmaW5lLG1vZHVsZSxleHBvcnRzO3JldHVybiAoZnVuY3Rpb24gZSh0LG4scil7ZnVuY3Rpb24gcyhvLHUpe2lmKCFuW29dKXtpZighdFtvXSl7dmFyIGE9dHlwZW9mIHJlcXVpcmU9PSJmdW5jdGlvbiImJnJlcXVpcmU7aWYoIXUmJmEpcmV0dXJuIGEobywhMCk7aWYoaSlyZXR1cm4gaShvLCEwKTt2YXIgZj1uZXcgRXJyb3IoIkNhbm5vdCBmaW5kIG1vZHVsZSAnIitvKyInIik7dGhyb3cgZi5jb2RlPSJNT0RVTEVfTk9UX0ZPVU5EIixmfXZhciBsPW5bb109e2V4cG9ydHM6e319O3Rbb11bMF0uY2FsbChsLmV4cG9ydHMsZnVuY3Rpb24oZSl7dmFyIG49dFtvXVsxXVtlXTtyZXR1cm4gcyhuP246ZSl9LGwsbC5leHBvcnRzLGUsdCxuLHIpfXJldHVybiBuW29dLmV4cG9ydHN9dmFyIGk9dHlwZW9mIHJlcXVpcmU9PSJmdW5jdGlvbiImJnJlcXVpcmU7Zm9yKHZhciBvPTA7bzxyLmxlbmd0aDtvKyspcyhyW29dKTtyZXR1cm4gc30pKHsxOltmdW5jdGlvbihyZXF1aXJlLG1vZHVsZSxleHBvcnRzKXsKJ3VzZSBzdHJpY3QnOwoKT2JqZWN0LmRlZmluZVByb3BlcnR5KGV4cG9ydHMsICdfX2VzTW9kdWxlJywgewogIHZhbHVlOiB0cnVlCn0pOwoKdmFyIF9jcmVhdGVDbGFzcyA9IChmdW5jdGlvbiAoKSB7IGZ1bmN0aW9uIGRlZmluZVByb3BlcnRpZXModGFyZ2V0LCBwcm9wcykgeyBmb3IgKHZhciBpID0gMDsgaSA8IHByb3BzLmxlbmd0aDsgaSsrKSB7IHZhciBkZXNjcmlwdG9yID0gcHJvcHNbaV07IGRlc2NyaXB0b3IuZW51bWVyYWJsZSA9IGRlc2NyaXB0b3IuZW51bWVyYWJsZSB8fCBmYWxzZTsgZGVzY3JpcHRvci5jb25maWd1cmFibGUgPSB0cnVlOyBpZiAoJ3ZhbHVlJyBpbiBkZXNjcmlwdG9yKSBkZXNjcmlwdG9yLndyaXRhYmxlID0gdHJ1ZTsgT2JqZWN0LmRlZmluZVByb3BlcnR5KHRhcmdldCwgZGVzY3JpcHRvci5rZXksIGRlc2NyaXB0b3IpOyB9IH0gcmV0dXJuIGZ1bmN0aW9uIChDb25zdHJ1Y3RvciwgcHJvdG9Qcm9wcywgc3RhdGljUHJvcHMpIHsgaWYgKHByb3RvUHJvcHMpIGRlZmluZVByb3BlcnRpZXMoQ29uc3RydWN0b3IucHJvdG90eXBlLCBwcm90b1Byb3BzKTsgaWYgKHN0YXRpY1Byb3BzKSBkZWZpbmVQcm9wZXJ0aWVzKENvbnN0cnVjdG9yLCBzdGF0aWNQcm9wcyk7IHJldHVybiBDb25zdHJ1Y3RvcjsgfTsgfSkoKTsKCmV4cG9ydHNbJ2RlZmF1bHQnXSA9IGFjdGl2YXRlOwoKZnVuY3Rpb24gX2NsYXNzQ2FsbENoZWNrKGluc3RhbmNlLCBDb25zdHJ1Y3RvcikgeyBpZiAoIShpbnN0YW5jZSBpbnN0YW5jZW9mIENvbnN0cnVjdG9yKSkgeyB0aHJvdyBuZXcgVHlwZUVycm9yKCdDYW5ub3QgY2FsbCBhIGNsYXNzIGFzIGEgZnVuY3Rpb24nKTsgfSB9Cgp2YXIgX3V0aWxzVXRpbHNKcyA9IHJlcXVpcmUoJy4uL3V0aWxzL3V0aWxzLmpzJyk7CgovKioKKiBDb3JlIEh5cGVydHlEaXNjb3ZlcnkgaW50ZXJmYWNlCiogQ2xhc3MgdG8gYWxsb3cgYXBwbGljYXRpb25zIHRvIHNlYXJjaCBmb3IgaHlwZXJ0aWVzIHVzaW5nIHRoZSBtZXNzYWdlIGJ1cwoqLwoKdmFyIEh5cGVydHlEaXNjb3ZlcnkgPSAoZnVuY3Rpb24gKCkgewoKICAvKioKICAqIFRvIGluaXRpYWxpc2UgdGhlIEh5cGVydHlEaXNjb3Zlciwgd2hpY2ggd2lsbCBwcm92aWRlIHRoZSBzdXBwb3J0IGZvciBoeXBlcnRpZXMgdG8KICAqIHF1ZXJ5IHVzZXJzIHJlZ2lzdGVyZWQgaW4gb3V0c2lkZSB0aGUgaW50ZXJuYWwgY29yZS4KICAqIEBwYXJhbSAge1J1bnRpbWVVUkx9ICAgICAgICAgIHJ1bnRpbWVVUkwgICAgICAgICAgICBydW50aW1lVVJMCiAgKiBAcGFyYW0gIHtNZXNzYWdlQnVzfSAgICAgICAgICBtc2didXMgICAgICAgICAgICAgICAgbXNnYnVzCiAgKi8KCiAgZnVuY3Rpb24gSHlwZXJ0eURpc2NvdmVyeShoeXBlcnR5VVJMLCBidXMsIGNvbmZpZ3VyYXRpb24pIHsKICAgIF9jbGFzc0NhbGxDaGVjayh0aGlzLCBIeXBlcnR5RGlzY292ZXJ5KTsKCiAgICB2YXIgX3RoaXMgPSB0aGlzOwogICAgX3RoaXMubWVzc2FnZUJ1cyA9IGJ1czsKCiAgICB2YXIgZG9tYWluID0gKDAsIF91dGlsc1V0aWxzSnMuZGl2aWRlVVJMKShoeXBlcnR5VVJMKS5kb21haW47CiAgICBfdGhpcy5fZG9tYWluID0gZG9tYWluOwoKICAgIGNvbnNvbGUubG9nKGNvbmZpZ3VyYXRpb24pOwoKICAgIF90aGlzLmRpc2NvdmVyeVVSTCA9ICdoeXBlcnR5Oi8vJyArIGRvbWFpbiArICcvaHlwZXJ0eURpc292ZXJ5JzsKICB9CgogIC8qKgogICogZnVuY3Rpb24gdG8gcmVxdWVzdCBhYm91dCB1c2VycyByZWdpc3RlcmVkIGluIGRvbWFpbiByZWdpc3RyeSwgYW5kCiAgKiByZXR1cm4gdGhlIGh5cGVydHkgaW5zdGFuY2UgaWYgZm91bmQuCiAgKiBAcGFyYW0gIHtlbWFpbH0gICAgICAgICAgICAgIGVtYWlsCiAgKiBAcmV0dXJuIHtQcm9taXNlfSAgICAgICAgICBQcm9taXNlCiAgKi8KCiAgX2NyZWF0ZUNsYXNzKEh5cGVydHlEaXNjb3ZlcnksIFt7CiAgICBrZXk6ICdkaXNjb3Zlckh5cGVydHlQZXJVc2VyJywKICAgIHZhbHVlOiBmdW5jdGlvbiBkaXNjb3Zlckh5cGVydHlQZXJVc2VyKGVtYWlsKSB7CiAgICAgIHZhciBfdGhpcyA9IHRoaXM7CiAgICAgIHZhciBpZGVudGl0eVVSTCA9ICd1c2VyOi8vJyArIGVtYWlsLnN1YnN0cmluZyhlbWFpbC5pbmRleE9mKCdAJykgKyAxLCBlbWFpbC5sZW5ndGgpICsgJy8nICsgZW1haWwuc3Vic3RyaW5nKDAsIGVtYWlsLmluZGV4T2YoJ0AnKSk7CgogICAgICAvLyBtZXNzYWdlIHRvIHF1ZXJ5IGRvbWFpbiByZWdpc3RyeSwgYXNraW5nIGZvciBhIHVzZXIgaHlwZXJ0eS4KICAgICAgdmFyIG1lc3NhZ2UgPSB7CiAgICAgICAgdHlwZTogJ1JFQUQnLCBmcm9tOiBfdGhpcy5kaXNjb3ZlcnlVUkwsIHRvOiAnZG9tYWluOi8vcmVnaXN0cnkuJyArIF90aGlzLmRvbWFpbiArICcvJywgYm9keTogeyB1c2VyOiBpZGVudGl0eVVSTCB9CiAgICAgIH07CgogICAgICByZXR1cm4gbmV3IFByb21pc2UoZnVuY3Rpb24gKHJlc29sdmUsIHJlamVjdCkgewoKICAgICAgICBfdGhpcy5tZXNzYWdlQnVzLnBvc3RNZXNzYWdlKG1lc3NhZ2UsIGZ1bmN0aW9uIChyZXBseSkgewoKICAgICAgICAgIHZhciBoeXBlcnR5VVJMID0gcmVwbHkuYm9keS5sYXN0OwoKICAgICAgICAgIGlmIChoeXBlcnR5VVJMID09PSB1bmRlZmluZWQpIHsKICAgICAgICAgICAgcmV0dXJuIHJlamVjdCgnVXNlciBIeXBlcnR5IG5vdCBmb3VuZCcpOwogICAgICAgICAgfQoKICAgICAgICAgIHZhciBpZFBhY2thZ2UgPSB7CiAgICAgICAgICAgIGlkOiBlbWFpbCwKICAgICAgICAgICAgZGVzY3JpcHRvcjogcmVwbHkuYm9keS5oeXBlcnRpZXNbaHlwZXJ0eVVSTF0uZGVzY3JpcHRvciwKICAgICAgICAgICAgaHlwZXJ0eVVSTDogaHlwZXJ0eVVSTAogICAgICAgICAgfTsKCiAgICAgICAgICByZXNvbHZlKGlkUGFja2FnZSk7CiAgICAgICAgfSk7CiAgICAgIH0pOwogICAgfQogIH1dKTsKCiAgcmV0dXJuIEh5cGVydHlEaXNjb3Zlcnk7Cn0pKCk7CgpmdW5jdGlvbiBhY3RpdmF0ZShoeXBlcnR5VVJMLCBidXMsIGNvbmZpZ3VyYXRpb24pIHsKCiAgcmV0dXJuIHsKICAgIG5hbWU6ICdIeXBlcnR5RGlzY292ZXJ5JywKICAgIGluc3RhbmNlOiBuZXcgSHlwZXJ0eURpc2NvdmVyeShoeXBlcnR5VVJMLCBidXMsIGNvbmZpZ3VyYXRpb24pCiAgfTsKfQoKbW9kdWxlLmV4cG9ydHMgPSBleHBvcnRzWydkZWZhdWx0J107Cgp9LHsiLi4vdXRpbHMvdXRpbHMuanMiOjJ9XSwyOltmdW5jdGlvbihyZXF1aXJlLG1vZHVsZSxleHBvcnRzKXsKLyoqCiAqIFN1cHBvcnQgbW9kdWxlIHdpdGggc29tZSBmdW5jdGlvbnMgd2lsbCBiZSB1c2VmdWwKICogQG1vZHVsZSB1dGlscwogKi8KCi8qKgogKiBAdHlwZWRlZiBkaXZpZGVVUkwKICogQHR5cGUgT2JqZWN0CiAqIEBwcm9wZXJ0eSB7c3RyaW5nfSB0eXBlIFRoZSB0eXBlIG9mIFVSTAogKiBAcHJvcGVydHkge3N0cmluZ30gZG9tYWluIFRoZSBkb21haW4gb2YgVVJMCiAqIEBwcm9wZXJ0eSB7c3RyaW5nfSBpZGVudGl0eSBUaGUgaWRlbnRpdHkgb2YgVVJMCiAqLwoKLyoqCiAqIERpdmlkZSBhbiB1cmwgaW4gdHlwZSwgZG9tYWluIGFuZCBpZGVudGl0eQogKiBAcGFyYW0gIHtVUkwuVVJMfSB1cmwgLSB1cmwgYWRkcmVzcwogKiBAcmV0dXJuIHtkaXZpZGVVUkx9IHRoZSByZXN1bHQgb2YgZGl2aWRlVVJMCiAqLwondXNlIHN0cmljdCc7CgpPYmplY3QuZGVmaW5lUHJvcGVydHkoZXhwb3J0cywgJ19fZXNNb2R1bGUnLCB7CiAgdmFsdWU6IHRydWUKfSk7CmV4cG9ydHMuZGl2aWRlVVJMID0gZGl2aWRlVVJMOwpleHBvcnRzLmRlZXBDbG9uZSA9IGRlZXBDbG9uZTsKCmZ1bmN0aW9uIGRpdmlkZVVSTCh1cmwpIHsKCiAgLy8gbGV0IHJlID0gLyhbYS16QS1aLV0qKT86XC9cLyg/OlwuKT8oWy1hLXpBLVowLTlAOiUuX1wrfiM9XXsyLDI1Nn1cLlthLXpdezIsNn1cYikqKFwvW1wvXGRcd1wuLV0qKSooPzpbXD9dKSooLispKi9naTsKICB2YXIgcmUgPSAvKFthLXpBLVotXSopOlwvXC8oPzpcLik/KFstYS16QS1aMC05QDolLl9cK34jPV17MiwyNTZ9KShbLWEtekEtWjAtOUA6JS5fXCt+Iz1cL10qKS9naTsKICB2YXIgc3Vic3QgPSAnJDEsJDIsJDMnOwogIHZhciBwYXJ0cyA9IHVybC5yZXBsYWNlKHJlLCBzdWJzdCkuc3BsaXQoJywnKTsKICB2YXIgcmVzdWx0ID0gewogICAgdHlwZTogcGFydHNbMF0sCiAgICBkb21haW46IHBhcnRzWzFdLAogICAgaWRlbnRpdHk6IHBhcnRzWzJdCiAgfTsKCiAgcmV0dXJuIHJlc3VsdDsKfQoKLyoqCiAqIE1ha2UgYSBDT1BZIG9mIHRoZSBvcmlnaW5hbCBkYXRhCiAqIEBwYXJhbSAge09iamVjdH0gIG9iaiAtIG9iamVjdCB0byBiZSBjbG9uZWQKICogQHJldHVybiB7T2JqZWN0fQogKi8KCmZ1bmN0aW9uIGRlZXBDbG9uZShvYmopIHsKICAvL1RPRE86IHNpbXBsZSBidXQgaW5lZmZpY2llbnQgSlNPTiBkZWVwIGNsb25lLi4uCiAgcmV0dXJuIEpTT04ucGFyc2UoSlNPTi5zdHJpbmdpZnkob2JqKSk7Cn0KCn0se31dfSx7fSxbMV0pKDEpCn0pOw==",
      "sourceCodeClassname": "HypertyDiscovery",
      "encoding": "base64",
      "signature": ""
    },
    "cguid": 1,
    "type": "Hyperties",
    "version": "0.1",
    "description": "Description of HypertyDiscovery",
    "objectName": "HypertyDiscovery",
    "sourcePackageURL": "/sourcePackage",
    "language": "javascript",
    "signature": "",
    "messageSchemas": "",
    "dataObjects": [],
    "accessControlPolicy": "somePolicy"
  }
}