{"sourceCode":"KGZ1bmN0aW9uKGYpe2lmKHR5cGVvZiBleHBvcnRzPT09Im9iamVjdCImJnR5cGVvZiBtb2R1bGUhPT0idW5kZWZpbmVkIil7bW9kdWxlLmV4cG9ydHM9ZigpfWVsc2UgaWYodHlwZW9mIGRlZmluZT09PSJmdW5jdGlvbiImJmRlZmluZS5hbWQpe2RlZmluZShbXSxmKX1lbHNle3ZhciBnO2lmKHR5cGVvZiB3aW5kb3chPT0idW5kZWZpbmVkIil7Zz13aW5kb3d9ZWxzZSBpZih0eXBlb2YgZ2xvYmFsIT09InVuZGVmaW5lZCIpe2c9Z2xvYmFsfWVsc2UgaWYodHlwZW9mIHNlbGYhPT0idW5kZWZpbmVkIil7Zz1zZWxmfWVsc2V7Zz10aGlzfWcuYWN0aXZhdGUgPSBmKCl9fSkoZnVuY3Rpb24oKXt2YXIgZGVmaW5lLG1vZHVsZSxleHBvcnRzO3JldHVybiAoZnVuY3Rpb24gZSh0LG4scil7ZnVuY3Rpb24gcyhvLHUpe2lmKCFuW29dKXtpZighdFtvXSl7dmFyIGE9dHlwZW9mIHJlcXVpcmU9PSJmdW5jdGlvbiImJnJlcXVpcmU7aWYoIXUmJmEpcmV0dXJuIGEobywhMCk7aWYoaSlyZXR1cm4gaShvLCEwKTt2YXIgZj1uZXcgRXJyb3IoIkNhbm5vdCBmaW5kIG1vZHVsZSAnIitvKyInIik7dGhyb3cgZi5jb2RlPSJNT0RVTEVfTk9UX0ZPVU5EIixmfXZhciBsPW5bb109e2V4cG9ydHM6e319O3Rbb11bMF0uY2FsbChsLmV4cG9ydHMsZnVuY3Rpb24oZSl7dmFyIG49dFtvXVsxXVtlXTtyZXR1cm4gcyhuP246ZSl9LGwsbC5leHBvcnRzLGUsdCxuLHIpfXJldHVybiBuW29dLmV4cG9ydHN9dmFyIGk9dHlwZW9mIHJlcXVpcmU9PSJmdW5jdGlvbiImJnJlcXVpcmU7Zm9yKHZhciBvPTA7bzxyLmxlbmd0aDtvKyspcyhyW29dKTtyZXR1cm4gc30pKHsxOltmdW5jdGlvbihyZXF1aXJlLG1vZHVsZSxleHBvcnRzKXsKLyoKQXV0aG9yOiBHZXJhaW50IEx1ZmYgYW5kIG90aGVycwpZZWFyOiAyMDEzCgpUaGlzIGNvZGUgaXMgcmVsZWFzZWQgaW50byB0aGUgInB1YmxpYyBkb21haW4iIGJ5IGl0cyBhdXRob3IocykuICBBbnlib2R5IG1heSB1c2UsIGFsdGVyIGFuZCBkaXN0cmlidXRlIHRoZSBjb2RlIHdpdGhvdXQgcmVzdHJpY3Rpb24uICBUaGUgYXV0aG9yIG1ha2VzIG5vIGd1YXJhbnRlZXMsIGFuZCB0YWtlcyBubyBsaWFiaWxpdHkgb2YgYW55IGtpbmQgZm9yIHVzZSBvZiB0aGlzIGNvZGUuCgpJZiB5b3UgZmluZCBhIGJ1ZyBvciBtYWtlIGFuIGltcHJvdmVtZW50LCBpdCB3b3VsZCBiZSBjb3VydGVvdXMgdG8gbGV0IHRoZSBhdXRob3Iga25vdywgYnV0IGl0IGlzIG5vdCBjb21wdWxzb3J5LgoqLwooZnVuY3Rpb24gKGdsb2JhbCwgZmFjdG9yeSkgewogIGlmICh0eXBlb2YgZGVmaW5lID09PSAnZnVuY3Rpb24nICYmIGRlZmluZS5hbWQpIHsKICAgIC8vIEFNRC4gUmVnaXN0ZXIgYXMgYW4gYW5vbnltb3VzIG1vZHVsZS4KICAgIGRlZmluZShbXSwgZmFjdG9yeSk7CiAgfSBlbHNlIGlmICh0eXBlb2YgbW9kdWxlICE9PSAndW5kZWZpbmVkJyAmJiBtb2R1bGUuZXhwb3J0cyl7CiAgICAvLyBDb21tb25KUy4gRGVmaW5lIGV4cG9ydC4KICAgIG1vZHVsZS5leHBvcnRzID0gZmFjdG9yeSgpOwogIH0gZWxzZSB7CiAgICAvLyBCcm93c2VyIGdsb2JhbHMKICAgIGdsb2JhbC50djQgPSBmYWN0b3J5KCk7CiAgfQp9KHRoaXMsIGZ1bmN0aW9uICgpIHsKCi8vIGh0dHBzOi8vZGV2ZWxvcGVyLm1vemlsbGEub3JnL2VuLVVTL2RvY3MvV2ViL0phdmFTY3JpcHQvUmVmZXJlbmNlL0dsb2JhbF9PYmplY3RzL09iamVjdC9rZXlzP3JlZGlyZWN0bG9jYWxlPWVuLVVTJnJlZGlyZWN0c2x1Zz1KYXZhU2NyaXB0JTJGUmVmZXJlbmNlJTJGR2xvYmFsX09iamVjdHMlMkZPYmplY3QlMkZrZXlzCmlmICghT2JqZWN0LmtleXMpIHsKCU9iamVjdC5rZXlzID0gKGZ1bmN0aW9uICgpIHsKCQl2YXIgaGFzT3duUHJvcGVydHkgPSBPYmplY3QucHJvdG90eXBlLmhhc093blByb3BlcnR5LAoJCQloYXNEb250RW51bUJ1ZyA9ICEoe3RvU3RyaW5nOiBudWxsfSkucHJvcGVydHlJc0VudW1lcmFibGUoJ3RvU3RyaW5nJyksCgkJCWRvbnRFbnVtcyA9IFsKCQkJCSd0b1N0cmluZycsCgkJCQkndG9Mb2NhbGVTdHJpbmcnLAoJCQkJJ3ZhbHVlT2YnLAoJCQkJJ2hhc093blByb3BlcnR5JywKCQkJCSdpc1Byb3RvdHlwZU9mJywKCQkJCSdwcm9wZXJ0eUlzRW51bWVyYWJsZScsCgkJCQknY29uc3RydWN0b3InCgkJCV0sCgkJCWRvbnRFbnVtc0xlbmd0aCA9IGRvbnRFbnVtcy5sZW5ndGg7CgoJCXJldHVybiBmdW5jdGlvbiAob2JqKSB7CgkJCWlmICh0eXBlb2Ygb2JqICE9PSAnb2JqZWN0JyAmJiB0eXBlb2Ygb2JqICE9PSAnZnVuY3Rpb24nIHx8IG9iaiA9PT0gbnVsbCkgewoJCQkJdGhyb3cgbmV3IFR5cGVFcnJvcignT2JqZWN0LmtleXMgY2FsbGVkIG9uIG5vbi1vYmplY3QnKTsKCQkJfQoKCQkJdmFyIHJlc3VsdCA9IFtdOwoKCQkJZm9yICh2YXIgcHJvcCBpbiBvYmopIHsKCQkJCWlmIChoYXNPd25Qcm9wZXJ0eS5jYWxsKG9iaiwgcHJvcCkpIHsKCQkJCQlyZXN1bHQucHVzaChwcm9wKTsKCQkJCX0KCQkJfQoKCQkJaWYgKGhhc0RvbnRFbnVtQnVnKSB7CgkJCQlmb3IgKHZhciBpPTA7IGkgPCBkb250RW51bXNMZW5ndGg7IGkrKykgewoJCQkJCWlmIChoYXNPd25Qcm9wZXJ0eS5jYWxsKG9iaiwgZG9udEVudW1zW2ldKSkgewoJCQkJCQlyZXN1bHQucHVzaChkb250RW51bXNbaV0pOwoJCQkJCX0KCQkJCX0KCQkJfQoJCQlyZXR1cm4gcmVzdWx0OwoJCX07Cgl9KSgpOwp9Ci8vIGh0dHBzOi8vZGV2ZWxvcGVyLm1vemlsbGEub3JnL2VuLVVTL2RvY3MvV2ViL0phdmFTY3JpcHQvUmVmZXJlbmNlL0dsb2JhbF9PYmplY3RzL09iamVjdC9jcmVhdGUKaWYgKCFPYmplY3QuY3JlYXRlKSB7CglPYmplY3QuY3JlYXRlID0gKGZ1bmN0aW9uKCl7CgkJZnVuY3Rpb24gRigpe30KCgkJcmV0dXJuIGZ1bmN0aW9uKG8pewoJCQlpZiAoYXJndW1lbnRzLmxlbmd0aCAhPT0gMSkgewoJCQkJdGhyb3cgbmV3IEVycm9yKCdPYmplY3QuY3JlYXRlIGltcGxlbWVudGF0aW9uIG9ubHkgYWNjZXB0cyBvbmUgcGFyYW1ldGVyLicpOwoJCQl9CgkJCUYucHJvdG90eXBlID0gbzsKCQkJcmV0dXJuIG5ldyBGKCk7CgkJfTsKCX0pKCk7Cn0KLy8gaHR0cHM6Ly9kZXZlbG9wZXIubW96aWxsYS5vcmcvZW4tVVMvZG9jcy9XZWIvSmF2YVNjcmlwdC9SZWZlcmVuY2UvR2xvYmFsX09iamVjdHMvQXJyYXkvaXNBcnJheT9yZWRpcmVjdGxvY2FsZT1lbi1VUyZyZWRpcmVjdHNsdWc9SmF2YVNjcmlwdCUyRlJlZmVyZW5jZSUyRkdsb2JhbF9PYmplY3RzJTJGQXJyYXklMkZpc0FycmF5CmlmKCFBcnJheS5pc0FycmF5KSB7CglBcnJheS5pc0FycmF5ID0gZnVuY3Rpb24gKHZBcmcpIHsKCQlyZXR1cm4gT2JqZWN0LnByb3RvdHlwZS50b1N0cmluZy5jYWxsKHZBcmcpID09PSAiW29iamVjdCBBcnJheV0iOwoJfTsKfQovLyBodHRwczovL2RldmVsb3Blci5tb3ppbGxhLm9yZy9lbi1VUy9kb2NzL1dlYi9KYXZhU2NyaXB0L1JlZmVyZW5jZS9HbG9iYWxfT2JqZWN0cy9BcnJheS9pbmRleE9mP3JlZGlyZWN0bG9jYWxlPWVuLVVTJnJlZGlyZWN0c2x1Zz1KYXZhU2NyaXB0JTJGUmVmZXJlbmNlJTJGR2xvYmFsX09iamVjdHMlMkZBcnJheSUyRmluZGV4T2YKaWYgKCFBcnJheS5wcm90b3R5cGUuaW5kZXhPZikgewoJQXJyYXkucHJvdG90eXBlLmluZGV4T2YgPSBmdW5jdGlvbiAoc2VhcmNoRWxlbWVudCAvKiwgZnJvbUluZGV4ICovICkgewoJCWlmICh0aGlzID09PSBudWxsKSB7CgkJCXRocm93IG5ldyBUeXBlRXJyb3IoKTsKCQl9CgkJdmFyIHQgPSBPYmplY3QodGhpcyk7CgkJdmFyIGxlbiA9IHQubGVuZ3RoID4+PiAwOwoKCQlpZiAobGVuID09PSAwKSB7CgkJCXJldHVybiAtMTsKCQl9CgkJdmFyIG4gPSAwOwoJCWlmIChhcmd1bWVudHMubGVuZ3RoID4gMSkgewoJCQluID0gTnVtYmVyKGFyZ3VtZW50c1sxXSk7CgkJCWlmIChuICE9PSBuKSB7IC8vIHNob3J0Y3V0IGZvciB2ZXJpZnlpbmcgaWYgaXQncyBOYU4KCQkJCW4gPSAwOwoJCQl9IGVsc2UgaWYgKG4gIT09IDAgJiYgbiAhPT0gSW5maW5pdHkgJiYgbiAhPT0gLUluZmluaXR5KSB7CgkJCQluID0gKG4gPiAwIHx8IC0xKSAqIE1hdGguZmxvb3IoTWF0aC5hYnMobikpOwoJCQl9CgkJfQoJCWlmIChuID49IGxlbikgewoJCQlyZXR1cm4gLTE7CgkJfQoJCXZhciBrID0gbiA+PSAwID8gbiA6IE1hdGgubWF4KGxlbiAtIE1hdGguYWJzKG4pLCAwKTsKCQlmb3IgKDsgayA8IGxlbjsgaysrKSB7CgkJCWlmIChrIGluIHQgJiYgdFtrXSA9PT0gc2VhcmNoRWxlbWVudCkgewoJCQkJcmV0dXJuIGs7CgkJCX0KCQl9CgkJcmV0dXJuIC0xOwoJfTsKfQoKLy8gR3J1bmdleSBPYmplY3QuaXNGcm96ZW4gaGFjawppZiAoIU9iamVjdC5pc0Zyb3plbikgewoJT2JqZWN0LmlzRnJvemVuID0gZnVuY3Rpb24gKG9iaikgewoJCXZhciBrZXkgPSAidHY0X3Rlc3RfZnJvemVuX2tleSI7CgkJd2hpbGUgKG9iai5oYXNPd25Qcm9wZXJ0eShrZXkpKSB7CgkJCWtleSArPSBNYXRoLnJhbmRvbSgpOwoJCX0KCQl0cnkgewoJCQlvYmpba2V5XSA9IHRydWU7CgkJCWRlbGV0ZSBvYmpba2V5XTsKCQkJcmV0dXJuIGZhbHNlOwoJCX0gY2F0Y2ggKGUpIHsKCQkJcmV0dXJuIHRydWU7CgkJfQoJfTsKfQovLyBCYXNlZCBvbjogaHR0cHM6Ly9naXRodWIuY29tL2dlcmFpbnRsdWZmL3VyaS10ZW1wbGF0ZXMsIGJ1dCB3aXRoIGFsbCB0aGUgZGUtc3Vic3RpdHV0aW9uIHN0dWZmIHJlbW92ZWQKCnZhciB1cmlUZW1wbGF0ZUdsb2JhbE1vZGlmaWVycyA9IHsKCSIrIjogdHJ1ZSwKCSIjIjogdHJ1ZSwKCSIuIjogdHJ1ZSwKCSIvIjogdHJ1ZSwKCSI7IjogdHJ1ZSwKCSI/IjogdHJ1ZSwKCSImIjogdHJ1ZQp9Owp2YXIgdXJpVGVtcGxhdGVTdWZmaWNlcyA9IHsKCSIqIjogdHJ1ZQp9OwoKZnVuY3Rpb24gbm90UmVhbGx5UGVyY2VudEVuY29kZShzdHJpbmcpIHsKCXJldHVybiBlbmNvZGVVUkkoc3RyaW5nKS5yZXBsYWNlKC8lMjVbMC05XVswLTldL2csIGZ1bmN0aW9uIChkb3VibGVFbmNvZGVkKSB7CgkJcmV0dXJuICIlIiArIGRvdWJsZUVuY29kZWQuc3Vic3RyaW5nKDMpOwoJfSk7Cn0KCmZ1bmN0aW9uIHVyaVRlbXBsYXRlU3Vic3RpdHV0aW9uKHNwZWMpIHsKCXZhciBtb2RpZmllciA9ICIiOwoJaWYgKHVyaVRlbXBsYXRlR2xvYmFsTW9kaWZpZXJzW3NwZWMuY2hhckF0KDApXSkgewoJCW1vZGlmaWVyID0gc3BlYy5jaGFyQXQoMCk7CgkJc3BlYyA9IHNwZWMuc3Vic3RyaW5nKDEpOwoJfQoJdmFyIHNlcGFyYXRvciA9ICIiOwoJdmFyIHByZWZpeCA9ICIiOwoJdmFyIHNob3VsZEVzY2FwZSA9IHRydWU7Cgl2YXIgc2hvd1ZhcmlhYmxlcyA9IGZhbHNlOwoJdmFyIHRyaW1FbXB0eVN0cmluZyA9IGZhbHNlOwoJaWYgKG1vZGlmaWVyID09PSAnKycpIHsKCQlzaG91bGRFc2NhcGUgPSBmYWxzZTsKCX0gZWxzZSBpZiAobW9kaWZpZXIgPT09ICIuIikgewoJCXByZWZpeCA9ICIuIjsKCQlzZXBhcmF0b3IgPSAiLiI7Cgl9IGVsc2UgaWYgKG1vZGlmaWVyID09PSAiLyIpIHsKCQlwcmVmaXggPSAiLyI7CgkJc2VwYXJhdG9yID0gIi8iOwoJfSBlbHNlIGlmIChtb2RpZmllciA9PT0gJyMnKSB7CgkJcHJlZml4ID0gIiMiOwoJCXNob3VsZEVzY2FwZSA9IGZhbHNlOwoJfSBlbHNlIGlmIChtb2RpZmllciA9PT0gJzsnKSB7CgkJcHJlZml4ID0gIjsiOwoJCXNlcGFyYXRvciA9ICI7IjsKCQlzaG93VmFyaWFibGVzID0gdHJ1ZTsKCQl0cmltRW1wdHlTdHJpbmcgPSB0cnVlOwoJfSBlbHNlIGlmIChtb2RpZmllciA9PT0gJz8nKSB7CgkJcHJlZml4ID0gIj8iOwoJCXNlcGFyYXRvciA9ICImIjsKCQlzaG93VmFyaWFibGVzID0gdHJ1ZTsKCX0gZWxzZSBpZiAobW9kaWZpZXIgPT09ICcmJykgewoJCXByZWZpeCA9ICImIjsKCQlzZXBhcmF0b3IgPSAiJiI7CgkJc2hvd1ZhcmlhYmxlcyA9IHRydWU7Cgl9CgoJdmFyIHZhck5hbWVzID0gW107Cgl2YXIgdmFyTGlzdCA9IHNwZWMuc3BsaXQoIiwiKTsKCXZhciB2YXJTcGVjcyA9IFtdOwoJdmFyIHZhclNwZWNNYXAgPSB7fTsKCWZvciAodmFyIGkgPSAwOyBpIDwgdmFyTGlzdC5sZW5ndGg7IGkrKykgewoJCXZhciB2YXJOYW1lID0gdmFyTGlzdFtpXTsKCQl2YXIgdHJ1bmNhdGUgPSBudWxsOwoJCWlmICh2YXJOYW1lLmluZGV4T2YoIjoiKSAhPT0gLTEpIHsKCQkJdmFyIHBhcnRzID0gdmFyTmFtZS5zcGxpdCgiOiIpOwoJCQl2YXJOYW1lID0gcGFydHNbMF07CgkJCXRydW5jYXRlID0gcGFyc2VJbnQocGFydHNbMV0sIDEwKTsKCQl9CgkJdmFyIHN1ZmZpY2VzID0ge307CgkJd2hpbGUgKHVyaVRlbXBsYXRlU3VmZmljZXNbdmFyTmFtZS5jaGFyQXQodmFyTmFtZS5sZW5ndGggLSAxKV0pIHsKCQkJc3VmZmljZXNbdmFyTmFtZS5jaGFyQXQodmFyTmFtZS5sZW5ndGggLSAxKV0gPSB0cnVlOwoJCQl2YXJOYW1lID0gdmFyTmFtZS5zdWJzdHJpbmcoMCwgdmFyTmFtZS5sZW5ndGggLSAxKTsKCQl9CgkJdmFyIHZhclNwZWMgPSB7CgkJCXRydW5jYXRlOiB0cnVuY2F0ZSwKCQkJbmFtZTogdmFyTmFtZSwKCQkJc3VmZmljZXM6IHN1ZmZpY2VzCgkJfTsKCQl2YXJTcGVjcy5wdXNoKHZhclNwZWMpOwoJCXZhclNwZWNNYXBbdmFyTmFtZV0gPSB2YXJTcGVjOwoJCXZhck5hbWVzLnB1c2godmFyTmFtZSk7Cgl9Cgl2YXIgc3ViRnVuY3Rpb24gPSBmdW5jdGlvbiAodmFsdWVGdW5jdGlvbikgewoJCXZhciByZXN1bHQgPSAiIjsKCQl2YXIgc3RhcnRJbmRleCA9IDA7CgkJZm9yICh2YXIgaSA9IDA7IGkgPCB2YXJTcGVjcy5sZW5ndGg7IGkrKykgewoJCQl2YXIgdmFyU3BlYyA9IHZhclNwZWNzW2ldOwoJCQl2YXIgdmFsdWUgPSB2YWx1ZUZ1bmN0aW9uKHZhclNwZWMubmFtZSk7CgkJCWlmICh2YWx1ZSA9PT0gbnVsbCB8fCB2YWx1ZSA9PT0gdW5kZWZpbmVkIHx8IChBcnJheS5pc0FycmF5KHZhbHVlKSAmJiB2YWx1ZS5sZW5ndGggPT09IDApIHx8ICh0eXBlb2YgdmFsdWUgPT09ICdvYmplY3QnICYmIE9iamVjdC5rZXlzKHZhbHVlKS5sZW5ndGggPT09IDApKSB7CgkJCQlzdGFydEluZGV4Kys7CgkJCQljb250aW51ZTsKCQkJfQoJCQlpZiAoaSA9PT0gc3RhcnRJbmRleCkgewoJCQkJcmVzdWx0ICs9IHByZWZpeDsKCQkJfSBlbHNlIHsKCQkJCXJlc3VsdCArPSAoc2VwYXJhdG9yIHx8ICIsIik7CgkJCX0KCQkJaWYgKEFycmF5LmlzQXJyYXkodmFsdWUpKSB7CgkJCQlpZiAoc2hvd1ZhcmlhYmxlcykgewoJCQkJCXJlc3VsdCArPSB2YXJTcGVjLm5hbWUgKyAiPSI7CgkJCQl9CgkJCQlmb3IgKHZhciBqID0gMDsgaiA8IHZhbHVlLmxlbmd0aDsgaisrKSB7CgkJCQkJaWYgKGogPiAwKSB7CgkJCQkJCXJlc3VsdCArPSB2YXJTcGVjLnN1ZmZpY2VzWycqJ10gPyAoc2VwYXJhdG9yIHx8ICIsIikgOiAiLCI7CgkJCQkJCWlmICh2YXJTcGVjLnN1ZmZpY2VzWycqJ10gJiYgc2hvd1ZhcmlhYmxlcykgewoJCQkJCQkJcmVzdWx0ICs9IHZhclNwZWMubmFtZSArICI9IjsKCQkJCQkJfQoJCQkJCX0KCQkJCQlyZXN1bHQgKz0gc2hvdWxkRXNjYXBlID8gZW5jb2RlVVJJQ29tcG9uZW50KHZhbHVlW2pdKS5yZXBsYWNlKC8hL2csICIlMjEiKSA6IG5vdFJlYWxseVBlcmNlbnRFbmNvZGUodmFsdWVbal0pOwoJCQkJfQoJCQl9IGVsc2UgaWYgKHR5cGVvZiB2YWx1ZSA9PT0gIm9iamVjdCIpIHsKCQkJCWlmIChzaG93VmFyaWFibGVzICYmICF2YXJTcGVjLnN1ZmZpY2VzWycqJ10pIHsKCQkJCQlyZXN1bHQgKz0gdmFyU3BlYy5uYW1lICsgIj0iOwoJCQkJfQoJCQkJdmFyIGZpcnN0ID0gdHJ1ZTsKCQkJCWZvciAodmFyIGtleSBpbiB2YWx1ZSkgewoJCQkJCWlmICghZmlyc3QpIHsKCQkJCQkJcmVzdWx0ICs9IHZhclNwZWMuc3VmZmljZXNbJyonXSA/IChzZXBhcmF0b3IgfHwgIiwiKSA6ICIsIjsKCQkJCQl9CgkJCQkJZmlyc3QgPSBmYWxzZTsKCQkJCQlyZXN1bHQgKz0gc2hvdWxkRXNjYXBlID8gZW5jb2RlVVJJQ29tcG9uZW50KGtleSkucmVwbGFjZSgvIS9nLCAiJTIxIikgOiBub3RSZWFsbHlQZXJjZW50RW5jb2RlKGtleSk7CgkJCQkJcmVzdWx0ICs9IHZhclNwZWMuc3VmZmljZXNbJyonXSA/ICc9JyA6ICIsIjsKCQkJCQlyZXN1bHQgKz0gc2hvdWxkRXNjYXBlID8gZW5jb2RlVVJJQ29tcG9uZW50KHZhbHVlW2tleV0pLnJlcGxhY2UoLyEvZywgIiUyMSIpIDogbm90UmVhbGx5UGVyY2VudEVuY29kZSh2YWx1ZVtrZXldKTsKCQkJCX0KCQkJfSBlbHNlIHsKCQkJCWlmIChzaG93VmFyaWFibGVzKSB7CgkJCQkJcmVzdWx0ICs9IHZhclNwZWMubmFtZTsKCQkJCQlpZiAoIXRyaW1FbXB0eVN0cmluZyB8fCB2YWx1ZSAhPT0gIiIpIHsKCQkJCQkJcmVzdWx0ICs9ICI9IjsKCQkJCQl9CgkJCQl9CgkJCQlpZiAodmFyU3BlYy50cnVuY2F0ZSAhPSBudWxsKSB7CgkJCQkJdmFsdWUgPSB2YWx1ZS5zdWJzdHJpbmcoMCwgdmFyU3BlYy50cnVuY2F0ZSk7CgkJCQl9CgkJCQlyZXN1bHQgKz0gc2hvdWxkRXNjYXBlID8gZW5jb2RlVVJJQ29tcG9uZW50KHZhbHVlKS5yZXBsYWNlKC8hL2csICIlMjEiKTogbm90UmVhbGx5UGVyY2VudEVuY29kZSh2YWx1ZSk7CgkJCX0KCQl9CgkJcmV0dXJuIHJlc3VsdDsKCX07CglzdWJGdW5jdGlvbi52YXJOYW1lcyA9IHZhck5hbWVzOwoJcmV0dXJuIHsKCQlwcmVmaXg6IHByZWZpeCwKCQlzdWJzdGl0dXRpb246IHN1YkZ1bmN0aW9uCgl9Owp9CgpmdW5jdGlvbiBVcmlUZW1wbGF0ZSh0ZW1wbGF0ZSkgewoJaWYgKCEodGhpcyBpbnN0YW5jZW9mIFVyaVRlbXBsYXRlKSkgewoJCXJldHVybiBuZXcgVXJpVGVtcGxhdGUodGVtcGxhdGUpOwoJfQoJdmFyIHBhcnRzID0gdGVtcGxhdGUuc3BsaXQoInsiKTsKCXZhciB0ZXh0UGFydHMgPSBbcGFydHMuc2hpZnQoKV07Cgl2YXIgcHJlZml4ZXMgPSBbXTsKCXZhciBzdWJzdGl0dXRpb25zID0gW107Cgl2YXIgdmFyTmFtZXMgPSBbXTsKCXdoaWxlIChwYXJ0cy5sZW5ndGggPiAwKSB7CgkJdmFyIHBhcnQgPSBwYXJ0cy5zaGlmdCgpOwoJCXZhciBzcGVjID0gcGFydC5zcGxpdCgifSIpWzBdOwoJCXZhciByZW1haW5kZXIgPSBwYXJ0LnN1YnN0cmluZyhzcGVjLmxlbmd0aCArIDEpOwoJCXZhciBmdW5jcyA9IHVyaVRlbXBsYXRlU3Vic3RpdHV0aW9uKHNwZWMpOwoJCXN1YnN0aXR1dGlvbnMucHVzaChmdW5jcy5zdWJzdGl0dXRpb24pOwoJCXByZWZpeGVzLnB1c2goZnVuY3MucHJlZml4KTsKCQl0ZXh0UGFydHMucHVzaChyZW1haW5kZXIpOwoJCXZhck5hbWVzID0gdmFyTmFtZXMuY29uY2F0KGZ1bmNzLnN1YnN0aXR1dGlvbi52YXJOYW1lcyk7Cgl9Cgl0aGlzLmZpbGwgPSBmdW5jdGlvbiAodmFsdWVGdW5jdGlvbikgewoJCXZhciByZXN1bHQgPSB0ZXh0UGFydHNbMF07CgkJZm9yICh2YXIgaSA9IDA7IGkgPCBzdWJzdGl0dXRpb25zLmxlbmd0aDsgaSsrKSB7CgkJCXZhciBzdWJzdGl0dXRpb24gPSBzdWJzdGl0dXRpb25zW2ldOwoJCQlyZXN1bHQgKz0gc3Vic3RpdHV0aW9uKHZhbHVlRnVuY3Rpb24pOwoJCQlyZXN1bHQgKz0gdGV4dFBhcnRzW2kgKyAxXTsKCQl9CgkJcmV0dXJuIHJlc3VsdDsKCX07Cgl0aGlzLnZhck5hbWVzID0gdmFyTmFtZXM7Cgl0aGlzLnRlbXBsYXRlID0gdGVtcGxhdGU7Cn0KVXJpVGVtcGxhdGUucHJvdG90eXBlID0gewoJdG9TdHJpbmc6IGZ1bmN0aW9uICgpIHsKCQlyZXR1cm4gdGhpcy50ZW1wbGF0ZTsKCX0sCglmaWxsRnJvbU9iamVjdDogZnVuY3Rpb24gKG9iaikgewoJCXJldHVybiB0aGlzLmZpbGwoZnVuY3Rpb24gKHZhck5hbWUpIHsKCQkJcmV0dXJuIG9ialt2YXJOYW1lXTsKCQl9KTsKCX0KfTsKdmFyIFZhbGlkYXRvckNvbnRleHQgPSBmdW5jdGlvbiBWYWxpZGF0b3JDb250ZXh0KHBhcmVudCwgY29sbGVjdE11bHRpcGxlLCBlcnJvclJlcG9ydGVyLCBjaGVja1JlY3Vyc2l2ZSwgdHJhY2tVbmtub3duUHJvcGVydGllcykgewoJdGhpcy5taXNzaW5nID0gW107Cgl0aGlzLm1pc3NpbmdNYXAgPSB7fTsKCXRoaXMuZm9ybWF0VmFsaWRhdG9ycyA9IHBhcmVudCA/IE9iamVjdC5jcmVhdGUocGFyZW50LmZvcm1hdFZhbGlkYXRvcnMpIDoge307Cgl0aGlzLnNjaGVtYXMgPSBwYXJlbnQgPyBPYmplY3QuY3JlYXRlKHBhcmVudC5zY2hlbWFzKSA6IHt9OwoJdGhpcy5jb2xsZWN0TXVsdGlwbGUgPSBjb2xsZWN0TXVsdGlwbGU7Cgl0aGlzLmVycm9ycyA9IFtdOwoJdGhpcy5oYW5kbGVFcnJvciA9IGNvbGxlY3RNdWx0aXBsZSA/IHRoaXMuY29sbGVjdEVycm9yIDogdGhpcy5yZXR1cm5FcnJvcjsKCWlmIChjaGVja1JlY3Vyc2l2ZSkgewoJCXRoaXMuY2hlY2tSZWN1cnNpdmUgPSB0cnVlOwoJCXRoaXMuc2Nhbm5lZCA9IFtdOwoJCXRoaXMuc2Nhbm5lZEZyb3plbiA9IFtdOwoJCXRoaXMuc2Nhbm5lZEZyb3plblNjaGVtYXMgPSBbXTsKCQl0aGlzLnNjYW5uZWRGcm96ZW5WYWxpZGF0aW9uRXJyb3JzID0gW107CgkJdGhpcy52YWxpZGF0ZWRTY2hlbWFzS2V5ID0gJ3R2NF92YWxpZGF0aW9uX2lkJzsKCQl0aGlzLnZhbGlkYXRpb25FcnJvcnNLZXkgPSAndHY0X3ZhbGlkYXRpb25fZXJyb3JzX2lkJzsKCX0KCWlmICh0cmFja1Vua25vd25Qcm9wZXJ0aWVzKSB7CgkJdGhpcy50cmFja1Vua25vd25Qcm9wZXJ0aWVzID0gdHJ1ZTsKCQl0aGlzLmtub3duUHJvcGVydHlQYXRocyA9IHt9OwoJCXRoaXMudW5rbm93blByb3BlcnR5UGF0aHMgPSB7fTsKCX0KCXRoaXMuZXJyb3JSZXBvcnRlciA9IGVycm9yUmVwb3J0ZXIgfHwgZGVmYXVsdEVycm9yUmVwb3J0ZXIoJ2VuJyk7CglpZiAodHlwZW9mIHRoaXMuZXJyb3JSZXBvcnRlciA9PT0gJ3N0cmluZycpIHsKCQl0aHJvdyBuZXcgRXJyb3IoJ2RlYnVnJyk7Cgl9Cgl0aGlzLmRlZmluZWRLZXl3b3JkcyA9IHt9OwoJaWYgKHBhcmVudCkgewoJCWZvciAodmFyIGtleSBpbiBwYXJlbnQuZGVmaW5lZEtleXdvcmRzKSB7CgkJCXRoaXMuZGVmaW5lZEtleXdvcmRzW2tleV0gPSBwYXJlbnQuZGVmaW5lZEtleXdvcmRzW2tleV0uc2xpY2UoMCk7CgkJfQoJfQp9OwpWYWxpZGF0b3JDb250ZXh0LnByb3RvdHlwZS5kZWZpbmVLZXl3b3JkID0gZnVuY3Rpb24gKGtleXdvcmQsIGtleXdvcmRGdW5jdGlvbikgewoJdGhpcy5kZWZpbmVkS2V5d29yZHNba2V5d29yZF0gPSB0aGlzLmRlZmluZWRLZXl3b3Jkc1trZXl3b3JkXSB8fCBbXTsKCXRoaXMuZGVmaW5lZEtleXdvcmRzW2tleXdvcmRdLnB1c2goa2V5d29yZEZ1bmN0aW9uKTsKfTsKVmFsaWRhdG9yQ29udGV4dC5wcm90b3R5cGUuY3JlYXRlRXJyb3IgPSBmdW5jdGlvbiAoY29kZSwgbWVzc2FnZVBhcmFtcywgZGF0YVBhdGgsIHNjaGVtYVBhdGgsIHN1YkVycm9ycywgZGF0YSwgc2NoZW1hKSB7Cgl2YXIgZXJyb3IgPSBuZXcgVmFsaWRhdGlvbkVycm9yKGNvZGUsIG1lc3NhZ2VQYXJhbXMsIGRhdGFQYXRoLCBzY2hlbWFQYXRoLCBzdWJFcnJvcnMpOwoJZXJyb3IubWVzc2FnZSA9IHRoaXMuZXJyb3JSZXBvcnRlcihlcnJvciwgZGF0YSwgc2NoZW1hKTsKCXJldHVybiBlcnJvcjsKfTsKVmFsaWRhdG9yQ29udGV4dC5wcm90b3R5cGUucmV0dXJuRXJyb3IgPSBmdW5jdGlvbiAoZXJyb3IpIHsKCXJldHVybiBlcnJvcjsKfTsKVmFsaWRhdG9yQ29udGV4dC5wcm90b3R5cGUuY29sbGVjdEVycm9yID0gZnVuY3Rpb24gKGVycm9yKSB7CglpZiAoZXJyb3IpIHsKCQl0aGlzLmVycm9ycy5wdXNoKGVycm9yKTsKCX0KCXJldHVybiBudWxsOwp9OwpWYWxpZGF0b3JDb250ZXh0LnByb3RvdHlwZS5wcmVmaXhFcnJvcnMgPSBmdW5jdGlvbiAoc3RhcnRJbmRleCwgZGF0YVBhdGgsIHNjaGVtYVBhdGgpIHsKCWZvciAodmFyIGkgPSBzdGFydEluZGV4OyBpIDwgdGhpcy5lcnJvcnMubGVuZ3RoOyBpKyspIHsKCQl0aGlzLmVycm9yc1tpXSA9IHRoaXMuZXJyb3JzW2ldLnByZWZpeFdpdGgoZGF0YVBhdGgsIHNjaGVtYVBhdGgpOwoJfQoJcmV0dXJuIHRoaXM7Cn07ClZhbGlkYXRvckNvbnRleHQucHJvdG90eXBlLmJhblVua25vd25Qcm9wZXJ0aWVzID0gZnVuY3Rpb24gKGRhdGEsIHNjaGVtYSkgewoJZm9yICh2YXIgdW5rbm93blBhdGggaW4gdGhpcy51bmtub3duUHJvcGVydHlQYXRocykgewoJCXZhciBlcnJvciA9IHRoaXMuY3JlYXRlRXJyb3IoRXJyb3JDb2Rlcy5VTktOT1dOX1BST1BFUlRZLCB7cGF0aDogdW5rbm93blBhdGh9LCB1bmtub3duUGF0aCwgIiIsIG51bGwsIGRhdGEsIHNjaGVtYSk7CgkJdmFyIHJlc3VsdCA9IHRoaXMuaGFuZGxlRXJyb3IoZXJyb3IpOwoJCWlmIChyZXN1bHQpIHsKCQkJcmV0dXJuIHJlc3VsdDsKCQl9Cgl9CglyZXR1cm4gbnVsbDsKfTsKClZhbGlkYXRvckNvbnRleHQucHJvdG90eXBlLmFkZEZvcm1hdCA9IGZ1bmN0aW9uIChmb3JtYXQsIHZhbGlkYXRvcikgewoJaWYgKHR5cGVvZiBmb3JtYXQgPT09ICdvYmplY3QnKSB7CgkJZm9yICh2YXIga2V5IGluIGZvcm1hdCkgewoJCQl0aGlzLmFkZEZvcm1hdChrZXksIGZvcm1hdFtrZXldKTsKCQl9CgkJcmV0dXJuIHRoaXM7Cgl9Cgl0aGlzLmZvcm1hdFZhbGlkYXRvcnNbZm9ybWF0XSA9IHZhbGlkYXRvcjsKfTsKVmFsaWRhdG9yQ29udGV4dC5wcm90b3R5cGUucmVzb2x2ZVJlZnMgPSBmdW5jdGlvbiAoc2NoZW1hLCB1cmxIaXN0b3J5KSB7CglpZiAoc2NoZW1hWyckcmVmJ10gIT09IHVuZGVmaW5lZCkgewoJCXVybEhpc3RvcnkgPSB1cmxIaXN0b3J5IHx8IHt9OwoJCWlmICh1cmxIaXN0b3J5W3NjaGVtYVsnJHJlZiddXSkgewoJCQlyZXR1cm4gdGhpcy5jcmVhdGVFcnJvcihFcnJvckNvZGVzLkNJUkNVTEFSX1JFRkVSRU5DRSwge3VybHM6IE9iamVjdC5rZXlzKHVybEhpc3RvcnkpLmpvaW4oJywgJyl9LCAnJywgJycsIG51bGwsIHVuZGVmaW5lZCwgc2NoZW1hKTsKCQl9CgkJdXJsSGlzdG9yeVtzY2hlbWFbJyRyZWYnXV0gPSB0cnVlOwoJCXNjaGVtYSA9IHRoaXMuZ2V0U2NoZW1hKHNjaGVtYVsnJHJlZiddLCB1cmxIaXN0b3J5KTsKCX0KCXJldHVybiBzY2hlbWE7Cn07ClZhbGlkYXRvckNvbnRleHQucHJvdG90eXBlLmdldFNjaGVtYSA9IGZ1bmN0aW9uICh1cmwsIHVybEhpc3RvcnkpIHsKCXZhciBzY2hlbWE7CglpZiAodGhpcy5zY2hlbWFzW3VybF0gIT09IHVuZGVmaW5lZCkgewoJCXNjaGVtYSA9IHRoaXMuc2NoZW1hc1t1cmxdOwoJCXJldHVybiB0aGlzLnJlc29sdmVSZWZzKHNjaGVtYSwgdXJsSGlzdG9yeSk7Cgl9Cgl2YXIgYmFzZVVybCA9IHVybDsKCXZhciBmcmFnbWVudCA9ICIiOwoJaWYgKHVybC5pbmRleE9mKCcjJykgIT09IC0xKSB7CgkJZnJhZ21lbnQgPSB1cmwuc3Vic3RyaW5nKHVybC5pbmRleE9mKCIjIikgKyAxKTsKCQliYXNlVXJsID0gdXJsLnN1YnN0cmluZygwLCB1cmwuaW5kZXhPZigiIyIpKTsKCX0KCWlmICh0eXBlb2YgdGhpcy5zY2hlbWFzW2Jhc2VVcmxdID09PSAnb2JqZWN0JykgewoJCXNjaGVtYSA9IHRoaXMuc2NoZW1hc1tiYXNlVXJsXTsKCQl2YXIgcG9pbnRlclBhdGggPSBkZWNvZGVVUklDb21wb25lbnQoZnJhZ21lbnQpOwoJCWlmIChwb2ludGVyUGF0aCA9PT0gIiIpIHsKCQkJcmV0dXJuIHRoaXMucmVzb2x2ZVJlZnMoc2NoZW1hLCB1cmxIaXN0b3J5KTsKCQl9IGVsc2UgaWYgKHBvaW50ZXJQYXRoLmNoYXJBdCgwKSAhPT0gIi8iKSB7CgkJCXJldHVybiB1bmRlZmluZWQ7CgkJfQoJCXZhciBwYXJ0cyA9IHBvaW50ZXJQYXRoLnNwbGl0KCIvIikuc2xpY2UoMSk7CgkJZm9yICh2YXIgaSA9IDA7IGkgPCBwYXJ0cy5sZW5ndGg7IGkrKykgewoJCQl2YXIgY29tcG9uZW50ID0gcGFydHNbaV0ucmVwbGFjZSgvfjEvZywgIi8iKS5yZXBsYWNlKC9+MC9nLCAifiIpOwoJCQlpZiAoc2NoZW1hW2NvbXBvbmVudF0gPT09IHVuZGVmaW5lZCkgewoJCQkJc2NoZW1hID0gdW5kZWZpbmVkOwoJCQkJYnJlYWs7CgkJCX0KCQkJc2NoZW1hID0gc2NoZW1hW2NvbXBvbmVudF07CgkJfQoJCWlmIChzY2hlbWEgIT09IHVuZGVmaW5lZCkgewoJCQlyZXR1cm4gdGhpcy5yZXNvbHZlUmVmcyhzY2hlbWEsIHVybEhpc3RvcnkpOwoJCX0KCX0KCWlmICh0aGlzLm1pc3NpbmdbYmFzZVVybF0gPT09IHVuZGVmaW5lZCkgewoJCXRoaXMubWlzc2luZy5wdXNoKGJhc2VVcmwpOwoJCXRoaXMubWlzc2luZ1tiYXNlVXJsXSA9IGJhc2VVcmw7CgkJdGhpcy5taXNzaW5nTWFwW2Jhc2VVcmxdID0gYmFzZVVybDsKCX0KfTsKVmFsaWRhdG9yQ29udGV4dC5wcm90b3R5cGUuc2VhcmNoU2NoZW1hcyA9IGZ1bmN0aW9uIChzY2hlbWEsIHVybCkgewoJaWYgKEFycmF5LmlzQXJyYXkoc2NoZW1hKSkgewoJCWZvciAodmFyIGkgPSAwOyBpIDwgc2NoZW1hLmxlbmd0aDsgaSsrKSB7CgkJCXRoaXMuc2VhcmNoU2NoZW1hcyhzY2hlbWFbaV0sIHVybCk7CgkJfQoJfSBlbHNlIGlmIChzY2hlbWEgJiYgdHlwZW9mIHNjaGVtYSA9PT0gIm9iamVjdCIpIHsKCQlpZiAodHlwZW9mIHNjaGVtYS5pZCA9PT0gInN0cmluZyIpIHsKCQkJaWYgKGlzVHJ1c3RlZFVybCh1cmwsIHNjaGVtYS5pZCkpIHsKCQkJCWlmICh0aGlzLnNjaGVtYXNbc2NoZW1hLmlkXSA9PT0gdW5kZWZpbmVkKSB7CgkJCQkJdGhpcy5zY2hlbWFzW3NjaGVtYS5pZF0gPSBzY2hlbWE7CgkJCQl9CgkJCX0KCQl9CgkJZm9yICh2YXIga2V5IGluIHNjaGVtYSkgewoJCQlpZiAoa2V5ICE9PSAiZW51bSIpIHsKCQkJCWlmICh0eXBlb2Ygc2NoZW1hW2tleV0gPT09ICJvYmplY3QiKSB7CgkJCQkJdGhpcy5zZWFyY2hTY2hlbWFzKHNjaGVtYVtrZXldLCB1cmwpOwoJCQkJfSBlbHNlIGlmIChrZXkgPT09ICIkcmVmIikgewoJCQkJCXZhciB1cmkgPSBnZXREb2N1bWVudFVyaShzY2hlbWFba2V5XSk7CgkJCQkJaWYgKHVyaSAmJiB0aGlzLnNjaGVtYXNbdXJpXSA9PT0gdW5kZWZpbmVkICYmIHRoaXMubWlzc2luZ01hcFt1cmldID09PSB1bmRlZmluZWQpIHsKCQkJCQkJdGhpcy5taXNzaW5nTWFwW3VyaV0gPSB1cmk7CgkJCQkJfQoJCQkJfQoJCQl9CgkJfQoJfQp9OwpWYWxpZGF0b3JDb250ZXh0LnByb3RvdHlwZS5hZGRTY2hlbWEgPSBmdW5jdGlvbiAodXJsLCBzY2hlbWEpIHsKCS8vb3ZlcmxvYWQKCWlmICh0eXBlb2YgdXJsICE9PSAnc3RyaW5nJyB8fCB0eXBlb2Ygc2NoZW1hID09PSAndW5kZWZpbmVkJykgewoJCWlmICh0eXBlb2YgdXJsID09PSAnb2JqZWN0JyAmJiB0eXBlb2YgdXJsLmlkID09PSAnc3RyaW5nJykgewoJCQlzY2hlbWEgPSB1cmw7CgkJCXVybCA9IHNjaGVtYS5pZDsKCQl9CgkJZWxzZSB7CgkJCXJldHVybjsKCQl9Cgl9CglpZiAodXJsID09PSBnZXREb2N1bWVudFVyaSh1cmwpICsgIiMiKSB7CgkJLy8gUmVtb3ZlIGVtcHR5IGZyYWdtZW50CgkJdXJsID0gZ2V0RG9jdW1lbnRVcmkodXJsKTsKCX0KCXRoaXMuc2NoZW1hc1t1cmxdID0gc2NoZW1hOwoJZGVsZXRlIHRoaXMubWlzc2luZ01hcFt1cmxdOwoJbm9ybVNjaGVtYShzY2hlbWEsIHVybCk7Cgl0aGlzLnNlYXJjaFNjaGVtYXMoc2NoZW1hLCB1cmwpOwp9OwoKVmFsaWRhdG9yQ29udGV4dC5wcm90b3R5cGUuZ2V0U2NoZW1hTWFwID0gZnVuY3Rpb24gKCkgewoJdmFyIG1hcCA9IHt9OwoJZm9yICh2YXIga2V5IGluIHRoaXMuc2NoZW1hcykgewoJCW1hcFtrZXldID0gdGhpcy5zY2hlbWFzW2tleV07Cgl9CglyZXR1cm4gbWFwOwp9OwoKVmFsaWRhdG9yQ29udGV4dC5wcm90b3R5cGUuZ2V0U2NoZW1hVXJpcyA9IGZ1bmN0aW9uIChmaWx0ZXJSZWdFeHApIHsKCXZhciBsaXN0ID0gW107Cglmb3IgKHZhciBrZXkgaW4gdGhpcy5zY2hlbWFzKSB7CgkJaWYgKCFmaWx0ZXJSZWdFeHAgfHwgZmlsdGVyUmVnRXhwLnRlc3Qoa2V5KSkgewoJCQlsaXN0LnB1c2goa2V5KTsKCQl9Cgl9CglyZXR1cm4gbGlzdDsKfTsKClZhbGlkYXRvckNvbnRleHQucHJvdG90eXBlLmdldE1pc3NpbmdVcmlzID0gZnVuY3Rpb24gKGZpbHRlclJlZ0V4cCkgewoJdmFyIGxpc3QgPSBbXTsKCWZvciAodmFyIGtleSBpbiB0aGlzLm1pc3NpbmdNYXApIHsKCQlpZiAoIWZpbHRlclJlZ0V4cCB8fCBmaWx0ZXJSZWdFeHAudGVzdChrZXkpKSB7CgkJCWxpc3QucHVzaChrZXkpOwoJCX0KCX0KCXJldHVybiBsaXN0Owp9OwoKVmFsaWRhdG9yQ29udGV4dC5wcm90b3R5cGUuZHJvcFNjaGVtYXMgPSBmdW5jdGlvbiAoKSB7Cgl0aGlzLnNjaGVtYXMgPSB7fTsKCXRoaXMucmVzZXQoKTsKfTsKVmFsaWRhdG9yQ29udGV4dC5wcm90b3R5cGUucmVzZXQgPSBmdW5jdGlvbiAoKSB7Cgl0aGlzLm1pc3NpbmcgPSBbXTsKCXRoaXMubWlzc2luZ01hcCA9IHt9OwoJdGhpcy5lcnJvcnMgPSBbXTsKfTsKClZhbGlkYXRvckNvbnRleHQucHJvdG90eXBlLnZhbGlkYXRlQWxsID0gZnVuY3Rpb24gKGRhdGEsIHNjaGVtYSwgZGF0YVBhdGhQYXJ0cywgc2NoZW1hUGF0aFBhcnRzLCBkYXRhUG9pbnRlclBhdGgpIHsKCXZhciB0b3BMZXZlbDsKCXNjaGVtYSA9IHRoaXMucmVzb2x2ZVJlZnMoc2NoZW1hKTsKCWlmICghc2NoZW1hKSB7CgkJcmV0dXJuIG51bGw7Cgl9IGVsc2UgaWYgKHNjaGVtYSBpbnN0YW5jZW9mIFZhbGlkYXRpb25FcnJvcikgewoJCXRoaXMuZXJyb3JzLnB1c2goc2NoZW1hKTsKCQlyZXR1cm4gc2NoZW1hOwoJfQoKCXZhciBzdGFydEVycm9yQ291bnQgPSB0aGlzLmVycm9ycy5sZW5ndGg7Cgl2YXIgZnJvemVuSW5kZXgsIHNjYW5uZWRGcm96ZW5TY2hlbWFJbmRleCA9IG51bGwsIHNjYW5uZWRTY2hlbWFzSW5kZXggPSBudWxsOwoJaWYgKHRoaXMuY2hlY2tSZWN1cnNpdmUgJiYgZGF0YSAmJiB0eXBlb2YgZGF0YSA9PT0gJ29iamVjdCcpIHsKCQl0b3BMZXZlbCA9ICF0aGlzLnNjYW5uZWQubGVuZ3RoOwoJCWlmIChkYXRhW3RoaXMudmFsaWRhdGVkU2NoZW1hc0tleV0pIHsKCQkJdmFyIHNjaGVtYUluZGV4ID0gZGF0YVt0aGlzLnZhbGlkYXRlZFNjaGVtYXNLZXldLmluZGV4T2Yoc2NoZW1hKTsKCQkJaWYgKHNjaGVtYUluZGV4ICE9PSAtMSkgewoJCQkJdGhpcy5lcnJvcnMgPSB0aGlzLmVycm9ycy5jb25jYXQoZGF0YVt0aGlzLnZhbGlkYXRpb25FcnJvcnNLZXldW3NjaGVtYUluZGV4XSk7CgkJCQlyZXR1cm4gbnVsbDsKCQkJfQoJCX0KCQlpZiAoT2JqZWN0LmlzRnJvemVuKGRhdGEpKSB7CgkJCWZyb3plbkluZGV4ID0gdGhpcy5zY2FubmVkRnJvemVuLmluZGV4T2YoZGF0YSk7CgkJCWlmIChmcm96ZW5JbmRleCAhPT0gLTEpIHsKCQkJCXZhciBmcm96ZW5TY2hlbWFJbmRleCA9IHRoaXMuc2Nhbm5lZEZyb3plblNjaGVtYXNbZnJvemVuSW5kZXhdLmluZGV4T2Yoc2NoZW1hKTsKCQkJCWlmIChmcm96ZW5TY2hlbWFJbmRleCAhPT0gLTEpIHsKCQkJCQl0aGlzLmVycm9ycyA9IHRoaXMuZXJyb3JzLmNvbmNhdCh0aGlzLnNjYW5uZWRGcm96ZW5WYWxpZGF0aW9uRXJyb3JzW2Zyb3plbkluZGV4XVtmcm96ZW5TY2hlbWFJbmRleF0pOwoJCQkJCXJldHVybiBudWxsOwoJCQkJfQoJCQl9CgkJfQoJCXRoaXMuc2Nhbm5lZC5wdXNoKGRhdGEpOwoJCWlmIChPYmplY3QuaXNGcm96ZW4oZGF0YSkpIHsKCQkJaWYgKGZyb3plbkluZGV4ID09PSAtMSkgewoJCQkJZnJvemVuSW5kZXggPSB0aGlzLnNjYW5uZWRGcm96ZW4ubGVuZ3RoOwoJCQkJdGhpcy5zY2FubmVkRnJvemVuLnB1c2goZGF0YSk7CgkJCQl0aGlzLnNjYW5uZWRGcm96ZW5TY2hlbWFzLnB1c2goW10pOwoJCQl9CgkJCXNjYW5uZWRGcm96ZW5TY2hlbWFJbmRleCA9IHRoaXMuc2Nhbm5lZEZyb3plblNjaGVtYXNbZnJvemVuSW5kZXhdLmxlbmd0aDsKCQkJdGhpcy5zY2FubmVkRnJvemVuU2NoZW1hc1tmcm96ZW5JbmRleF1bc2Nhbm5lZEZyb3plblNjaGVtYUluZGV4XSA9IHNjaGVtYTsKCQkJdGhpcy5zY2FubmVkRnJvemVuVmFsaWRhdGlvbkVycm9yc1tmcm96ZW5JbmRleF1bc2Nhbm5lZEZyb3plblNjaGVtYUluZGV4XSA9IFtdOwoJCX0gZWxzZSB7CgkJCWlmICghZGF0YVt0aGlzLnZhbGlkYXRlZFNjaGVtYXNLZXldKSB7CgkJCQl0cnkgewoJCQkJCU9iamVjdC5kZWZpbmVQcm9wZXJ0eShkYXRhLCB0aGlzLnZhbGlkYXRlZFNjaGVtYXNLZXksIHsKCQkJCQkJdmFsdWU6IFtdLAoJCQkJCQljb25maWd1cmFibGU6IHRydWUKCQkJCQl9KTsKCQkJCQlPYmplY3QuZGVmaW5lUHJvcGVydHkoZGF0YSwgdGhpcy52YWxpZGF0aW9uRXJyb3JzS2V5LCB7CgkJCQkJCXZhbHVlOiBbXSwKCQkJCQkJY29uZmlndXJhYmxlOiB0cnVlCgkJCQkJfSk7CgkJCQl9IGNhdGNoIChlKSB7CgkJCQkJLy9JRSA3Lzggd29ya2Fyb3VuZAoJCQkJCWRhdGFbdGhpcy52YWxpZGF0ZWRTY2hlbWFzS2V5XSA9IFtdOwoJCQkJCWRhdGFbdGhpcy52YWxpZGF0aW9uRXJyb3JzS2V5XSA9IFtdOwoJCQkJfQoJCQl9CgkJCXNjYW5uZWRTY2hlbWFzSW5kZXggPSBkYXRhW3RoaXMudmFsaWRhdGVkU2NoZW1hc0tleV0ubGVuZ3RoOwoJCQlkYXRhW3RoaXMudmFsaWRhdGVkU2NoZW1hc0tleV1bc2Nhbm5lZFNjaGVtYXNJbmRleF0gPSBzY2hlbWE7CgkJCWRhdGFbdGhpcy52YWxpZGF0aW9uRXJyb3JzS2V5XVtzY2FubmVkU2NoZW1hc0luZGV4XSA9IFtdOwoJCX0KCX0KCgl2YXIgZXJyb3JDb3VudCA9IHRoaXMuZXJyb3JzLmxlbmd0aDsKCXZhciBlcnJvciA9IHRoaXMudmFsaWRhdGVCYXNpYyhkYXRhLCBzY2hlbWEsIGRhdGFQb2ludGVyUGF0aCkKCQl8fCB0aGlzLnZhbGlkYXRlTnVtZXJpYyhkYXRhLCBzY2hlbWEsIGRhdGFQb2ludGVyUGF0aCkKCQl8fCB0aGlzLnZhbGlkYXRlU3RyaW5nKGRhdGEsIHNjaGVtYSwgZGF0YVBvaW50ZXJQYXRoKQoJCXx8IHRoaXMudmFsaWRhdGVBcnJheShkYXRhLCBzY2hlbWEsIGRhdGFQb2ludGVyUGF0aCkKCQl8fCB0aGlzLnZhbGlkYXRlT2JqZWN0KGRhdGEsIHNjaGVtYSwgZGF0YVBvaW50ZXJQYXRoKQoJCXx8IHRoaXMudmFsaWRhdGVDb21iaW5hdGlvbnMoZGF0YSwgc2NoZW1hLCBkYXRhUG9pbnRlclBhdGgpCgkJfHwgdGhpcy52YWxpZGF0ZUh5cGVybWVkaWEoZGF0YSwgc2NoZW1hLCBkYXRhUG9pbnRlclBhdGgpCgkJfHwgdGhpcy52YWxpZGF0ZUZvcm1hdChkYXRhLCBzY2hlbWEsIGRhdGFQb2ludGVyUGF0aCkKCQl8fCB0aGlzLnZhbGlkYXRlRGVmaW5lZEtleXdvcmRzKGRhdGEsIHNjaGVtYSwgZGF0YVBvaW50ZXJQYXRoKQoJCXx8IG51bGw7CgoJaWYgKHRvcExldmVsKSB7CgkJd2hpbGUgKHRoaXMuc2Nhbm5lZC5sZW5ndGgpIHsKCQkJdmFyIGl0ZW0gPSB0aGlzLnNjYW5uZWQucG9wKCk7CgkJCWRlbGV0ZSBpdGVtW3RoaXMudmFsaWRhdGVkU2NoZW1hc0tleV07CgkJfQoJCXRoaXMuc2Nhbm5lZEZyb3plbiA9IFtdOwoJCXRoaXMuc2Nhbm5lZEZyb3plblNjaGVtYXMgPSBbXTsKCX0KCglpZiAoZXJyb3IgfHwgZXJyb3JDb3VudCAhPT0gdGhpcy5lcnJvcnMubGVuZ3RoKSB7CgkJd2hpbGUgKChkYXRhUGF0aFBhcnRzICYmIGRhdGFQYXRoUGFydHMubGVuZ3RoKSB8fCAoc2NoZW1hUGF0aFBhcnRzICYmIHNjaGVtYVBhdGhQYXJ0cy5sZW5ndGgpKSB7CgkJCXZhciBkYXRhUGFydCA9IChkYXRhUGF0aFBhcnRzICYmIGRhdGFQYXRoUGFydHMubGVuZ3RoKSA/ICIiICsgZGF0YVBhdGhQYXJ0cy5wb3AoKSA6IG51bGw7CgkJCXZhciBzY2hlbWFQYXJ0ID0gKHNjaGVtYVBhdGhQYXJ0cyAmJiBzY2hlbWFQYXRoUGFydHMubGVuZ3RoKSA/ICIiICsgc2NoZW1hUGF0aFBhcnRzLnBvcCgpIDogbnVsbDsKCQkJaWYgKGVycm9yKSB7CgkJCQllcnJvciA9IGVycm9yLnByZWZpeFdpdGgoZGF0YVBhcnQsIHNjaGVtYVBhcnQpOwoJCQl9CgkJCXRoaXMucHJlZml4RXJyb3JzKGVycm9yQ291bnQsIGRhdGFQYXJ0LCBzY2hlbWFQYXJ0KTsKCQl9Cgl9CgoJaWYgKHNjYW5uZWRGcm96ZW5TY2hlbWFJbmRleCAhPT0gbnVsbCkgewoJCXRoaXMuc2Nhbm5lZEZyb3plblZhbGlkYXRpb25FcnJvcnNbZnJvemVuSW5kZXhdW3NjYW5uZWRGcm96ZW5TY2hlbWFJbmRleF0gPSB0aGlzLmVycm9ycy5zbGljZShzdGFydEVycm9yQ291bnQpOwoJfSBlbHNlIGlmIChzY2FubmVkU2NoZW1hc0luZGV4ICE9PSBudWxsKSB7CgkJZGF0YVt0aGlzLnZhbGlkYXRpb25FcnJvcnNLZXldW3NjYW5uZWRTY2hlbWFzSW5kZXhdID0gdGhpcy5lcnJvcnMuc2xpY2Uoc3RhcnRFcnJvckNvdW50KTsKCX0KCglyZXR1cm4gdGhpcy5oYW5kbGVFcnJvcihlcnJvcik7Cn07ClZhbGlkYXRvckNvbnRleHQucHJvdG90eXBlLnZhbGlkYXRlRm9ybWF0ID0gZnVuY3Rpb24gKGRhdGEsIHNjaGVtYSkgewoJaWYgKHR5cGVvZiBzY2hlbWEuZm9ybWF0ICE9PSAnc3RyaW5nJyB8fCAhdGhpcy5mb3JtYXRWYWxpZGF0b3JzW3NjaGVtYS5mb3JtYXRdKSB7CgkJcmV0dXJuIG51bGw7Cgl9Cgl2YXIgZXJyb3JNZXNzYWdlID0gdGhpcy5mb3JtYXRWYWxpZGF0b3JzW3NjaGVtYS5mb3JtYXRdLmNhbGwobnVsbCwgZGF0YSwgc2NoZW1hKTsKCWlmICh0eXBlb2YgZXJyb3JNZXNzYWdlID09PSAnc3RyaW5nJyB8fCB0eXBlb2YgZXJyb3JNZXNzYWdlID09PSAnbnVtYmVyJykgewoJCXJldHVybiB0aGlzLmNyZWF0ZUVycm9yKEVycm9yQ29kZXMuRk9STUFUX0NVU1RPTSwge21lc3NhZ2U6IGVycm9yTWVzc2FnZX0sICcnLCAnL2Zvcm1hdCcsIG51bGwsIGRhdGEsIHNjaGVtYSk7Cgl9IGVsc2UgaWYgKGVycm9yTWVzc2FnZSAmJiB0eXBlb2YgZXJyb3JNZXNzYWdlID09PSAnb2JqZWN0JykgewoJCXJldHVybiB0aGlzLmNyZWF0ZUVycm9yKEVycm9yQ29kZXMuRk9STUFUX0NVU1RPTSwge21lc3NhZ2U6IGVycm9yTWVzc2FnZS5tZXNzYWdlIHx8ICI/In0sIGVycm9yTWVzc2FnZS5kYXRhUGF0aCB8fCAnJywgZXJyb3JNZXNzYWdlLnNjaGVtYVBhdGggfHwgIi9mb3JtYXQiLCBudWxsLCBkYXRhLCBzY2hlbWEpOwoJfQoJcmV0dXJuIG51bGw7Cn07ClZhbGlkYXRvckNvbnRleHQucHJvdG90eXBlLnZhbGlkYXRlRGVmaW5lZEtleXdvcmRzID0gZnVuY3Rpb24gKGRhdGEsIHNjaGVtYSwgZGF0YVBvaW50ZXJQYXRoKSB7Cglmb3IgKHZhciBrZXkgaW4gdGhpcy5kZWZpbmVkS2V5d29yZHMpIHsKCQlpZiAodHlwZW9mIHNjaGVtYVtrZXldID09PSAndW5kZWZpbmVkJykgewoJCQljb250aW51ZTsKCQl9CgkJdmFyIHZhbGlkYXRpb25GdW5jdGlvbnMgPSB0aGlzLmRlZmluZWRLZXl3b3Jkc1trZXldOwoJCWZvciAodmFyIGkgPSAwOyBpIDwgdmFsaWRhdGlvbkZ1bmN0aW9ucy5sZW5ndGg7IGkrKykgewoJCQl2YXIgZnVuYyA9IHZhbGlkYXRpb25GdW5jdGlvbnNbaV07CgkJCXZhciByZXN1bHQgPSBmdW5jKGRhdGEsIHNjaGVtYVtrZXldLCBzY2hlbWEsIGRhdGFQb2ludGVyUGF0aCk7CgkJCWlmICh0eXBlb2YgcmVzdWx0ID09PSAnc3RyaW5nJyB8fCB0eXBlb2YgcmVzdWx0ID09PSAnbnVtYmVyJykgewoJCQkJcmV0dXJuIHRoaXMuY3JlYXRlRXJyb3IoRXJyb3JDb2Rlcy5LRVlXT1JEX0NVU1RPTSwge2tleToga2V5LCBtZXNzYWdlOiByZXN1bHR9LCAnJywgJycsIG51bGwsIGRhdGEsIHNjaGVtYSkucHJlZml4V2l0aChudWxsLCBrZXkpOwoJCQl9IGVsc2UgaWYgKHJlc3VsdCAmJiB0eXBlb2YgcmVzdWx0ID09PSAnb2JqZWN0JykgewoJCQkJdmFyIGNvZGUgPSByZXN1bHQuY29kZTsKCQkJCWlmICh0eXBlb2YgY29kZSA9PT0gJ3N0cmluZycpIHsKCQkJCQlpZiAoIUVycm9yQ29kZXNbY29kZV0pIHsKCQkJCQkJdGhyb3cgbmV3IEVycm9yKCdVbmRlZmluZWQgZXJyb3IgY29kZSAodXNlIGRlZmluZUVycm9yKTogJyArIGNvZGUpOwoJCQkJCX0KCQkJCQljb2RlID0gRXJyb3JDb2Rlc1tjb2RlXTsKCQkJCX0gZWxzZSBpZiAodHlwZW9mIGNvZGUgIT09ICdudW1iZXInKSB7CgkJCQkJY29kZSA9IEVycm9yQ29kZXMuS0VZV09SRF9DVVNUT007CgkJCQl9CgkJCQl2YXIgbWVzc2FnZVBhcmFtcyA9ICh0eXBlb2YgcmVzdWx0Lm1lc3NhZ2UgPT09ICdvYmplY3QnKSA/IHJlc3VsdC5tZXNzYWdlIDoge2tleToga2V5LCBtZXNzYWdlOiByZXN1bHQubWVzc2FnZSB8fCAiPyJ9OwoJCQkJdmFyIHNjaGVtYVBhdGggPSByZXN1bHQuc2NoZW1hUGF0aCB8fCAoIi8iICsga2V5LnJlcGxhY2UoL34vZywgJ34wJykucmVwbGFjZSgvXC8vZywgJ34xJykpOwoJCQkJcmV0dXJuIHRoaXMuY3JlYXRlRXJyb3IoY29kZSwgbWVzc2FnZVBhcmFtcywgcmVzdWx0LmRhdGFQYXRoIHx8IG51bGwsIHNjaGVtYVBhdGgsIG51bGwsIGRhdGEsIHNjaGVtYSk7CgkJCX0KCQl9Cgl9CglyZXR1cm4gbnVsbDsKfTsKCmZ1bmN0aW9uIHJlY3Vyc2l2ZUNvbXBhcmUoQSwgQikgewoJaWYgKEEgPT09IEIpIHsKCQlyZXR1cm4gdHJ1ZTsKCX0KCWlmIChBICYmIEIgJiYgdHlwZW9mIEEgPT09ICJvYmplY3QiICYmIHR5cGVvZiBCID09PSAib2JqZWN0IikgewoJCWlmIChBcnJheS5pc0FycmF5KEEpICE9PSBBcnJheS5pc0FycmF5KEIpKSB7CgkJCXJldHVybiBmYWxzZTsKCQl9IGVsc2UgaWYgKEFycmF5LmlzQXJyYXkoQSkpIHsKCQkJaWYgKEEubGVuZ3RoICE9PSBCLmxlbmd0aCkgewoJCQkJcmV0dXJuIGZhbHNlOwoJCQl9CgkJCWZvciAodmFyIGkgPSAwOyBpIDwgQS5sZW5ndGg7IGkrKykgewoJCQkJaWYgKCFyZWN1cnNpdmVDb21wYXJlKEFbaV0sIEJbaV0pKSB7CgkJCQkJcmV0dXJuIGZhbHNlOwoJCQkJfQoJCQl9CgkJfSBlbHNlIHsKCQkJdmFyIGtleTsKCQkJZm9yIChrZXkgaW4gQSkgewoJCQkJaWYgKEJba2V5XSA9PT0gdW5kZWZpbmVkICYmIEFba2V5XSAhPT0gdW5kZWZpbmVkKSB7CgkJCQkJcmV0dXJuIGZhbHNlOwoJCQkJfQoJCQl9CgkJCWZvciAoa2V5IGluIEIpIHsKCQkJCWlmIChBW2tleV0gPT09IHVuZGVmaW5lZCAmJiBCW2tleV0gIT09IHVuZGVmaW5lZCkgewoJCQkJCXJldHVybiBmYWxzZTsKCQkJCX0KCQkJfQoJCQlmb3IgKGtleSBpbiBBKSB7CgkJCQlpZiAoIXJlY3Vyc2l2ZUNvbXBhcmUoQVtrZXldLCBCW2tleV0pKSB7CgkJCQkJcmV0dXJuIGZhbHNlOwoJCQkJfQoJCQl9CgkJfQoJCXJldHVybiB0cnVlOwoJfQoJcmV0dXJuIGZhbHNlOwp9CgpWYWxpZGF0b3JDb250ZXh0LnByb3RvdHlwZS52YWxpZGF0ZUJhc2ljID0gZnVuY3Rpb24gdmFsaWRhdGVCYXNpYyhkYXRhLCBzY2hlbWEsIGRhdGFQb2ludGVyUGF0aCkgewoJdmFyIGVycm9yOwoJaWYgKGVycm9yID0gdGhpcy52YWxpZGF0ZVR5cGUoZGF0YSwgc2NoZW1hLCBkYXRhUG9pbnRlclBhdGgpKSB7CgkJcmV0dXJuIGVycm9yLnByZWZpeFdpdGgobnVsbCwgInR5cGUiKTsKCX0KCWlmIChlcnJvciA9IHRoaXMudmFsaWRhdGVFbnVtKGRhdGEsIHNjaGVtYSwgZGF0YVBvaW50ZXJQYXRoKSkgewoJCXJldHVybiBlcnJvci5wcmVmaXhXaXRoKG51bGwsICJ0eXBlIik7Cgl9CglyZXR1cm4gbnVsbDsKfTsKClZhbGlkYXRvckNvbnRleHQucHJvdG90eXBlLnZhbGlkYXRlVHlwZSA9IGZ1bmN0aW9uIHZhbGlkYXRlVHlwZShkYXRhLCBzY2hlbWEpIHsKCWlmIChzY2hlbWEudHlwZSA9PT0gdW5kZWZpbmVkKSB7CgkJcmV0dXJuIG51bGw7Cgl9Cgl2YXIgZGF0YVR5cGUgPSB0eXBlb2YgZGF0YTsKCWlmIChkYXRhID09PSBudWxsKSB7CgkJZGF0YVR5cGUgPSAibnVsbCI7Cgl9IGVsc2UgaWYgKEFycmF5LmlzQXJyYXkoZGF0YSkpIHsKCQlkYXRhVHlwZSA9ICJhcnJheSI7Cgl9Cgl2YXIgYWxsb3dlZFR5cGVzID0gc2NoZW1hLnR5cGU7CglpZiAoIUFycmF5LmlzQXJyYXkoYWxsb3dlZFR5cGVzKSkgewoJCWFsbG93ZWRUeXBlcyA9IFthbGxvd2VkVHlwZXNdOwoJfQoKCWZvciAodmFyIGkgPSAwOyBpIDwgYWxsb3dlZFR5cGVzLmxlbmd0aDsgaSsrKSB7CgkJdmFyIHR5cGUgPSBhbGxvd2VkVHlwZXNbaV07CgkJaWYgKHR5cGUgPT09IGRhdGFUeXBlIHx8ICh0eXBlID09PSAiaW50ZWdlciIgJiYgZGF0YVR5cGUgPT09ICJudW1iZXIiICYmIChkYXRhICUgMSA9PT0gMCkpKSB7CgkJCXJldHVybiBudWxsOwoJCX0KCX0KCXJldHVybiB0aGlzLmNyZWF0ZUVycm9yKEVycm9yQ29kZXMuSU5WQUxJRF9UWVBFLCB7dHlwZTogZGF0YVR5cGUsIGV4cGVjdGVkOiBhbGxvd2VkVHlwZXMuam9pbigiLyIpfSwgJycsICcnLCBudWxsLCBkYXRhLCBzY2hlbWEpOwp9OwoKVmFsaWRhdG9yQ29udGV4dC5wcm90b3R5cGUudmFsaWRhdGVFbnVtID0gZnVuY3Rpb24gdmFsaWRhdGVFbnVtKGRhdGEsIHNjaGVtYSkgewoJaWYgKHNjaGVtYVsiZW51bSJdID09PSB1bmRlZmluZWQpIHsKCQlyZXR1cm4gbnVsbDsKCX0KCWZvciAodmFyIGkgPSAwOyBpIDwgc2NoZW1hWyJlbnVtIl0ubGVuZ3RoOyBpKyspIHsKCQl2YXIgZW51bVZhbCA9IHNjaGVtYVsiZW51bSJdW2ldOwoJCWlmIChyZWN1cnNpdmVDb21wYXJlKGRhdGEsIGVudW1WYWwpKSB7CgkJCXJldHVybiBudWxsOwoJCX0KCX0KCXJldHVybiB0aGlzLmNyZWF0ZUVycm9yKEVycm9yQ29kZXMuRU5VTV9NSVNNQVRDSCwge3ZhbHVlOiAodHlwZW9mIEpTT04gIT09ICd1bmRlZmluZWQnKSA/IEpTT04uc3RyaW5naWZ5KGRhdGEpIDogZGF0YX0sICcnLCAnJywgbnVsbCwgZGF0YSwgc2NoZW1hKTsKfTsKClZhbGlkYXRvckNvbnRleHQucHJvdG90eXBlLnZhbGlkYXRlTnVtZXJpYyA9IGZ1bmN0aW9uIHZhbGlkYXRlTnVtZXJpYyhkYXRhLCBzY2hlbWEsIGRhdGFQb2ludGVyUGF0aCkgewoJcmV0dXJuIHRoaXMudmFsaWRhdGVNdWx0aXBsZU9mKGRhdGEsIHNjaGVtYSwgZGF0YVBvaW50ZXJQYXRoKQoJCXx8IHRoaXMudmFsaWRhdGVNaW5NYXgoZGF0YSwgc2NoZW1hLCBkYXRhUG9pbnRlclBhdGgpCgkJfHwgdGhpcy52YWxpZGF0ZU5hTihkYXRhLCBzY2hlbWEsIGRhdGFQb2ludGVyUGF0aCkKCQl8fCBudWxsOwp9OwoKdmFyIENMT1NFX0VOT1VHSF9MT1cgPSBNYXRoLnBvdygyLCAtNTEpOwp2YXIgQ0xPU0VfRU5PVUdIX0hJR0ggPSAxIC0gQ0xPU0VfRU5PVUdIX0xPVzsKVmFsaWRhdG9yQ29udGV4dC5wcm90b3R5cGUudmFsaWRhdGVNdWx0aXBsZU9mID0gZnVuY3Rpb24gdmFsaWRhdGVNdWx0aXBsZU9mKGRhdGEsIHNjaGVtYSkgewoJdmFyIG11bHRpcGxlT2YgPSBzY2hlbWEubXVsdGlwbGVPZiB8fCBzY2hlbWEuZGl2aXNpYmxlQnk7CglpZiAobXVsdGlwbGVPZiA9PT0gdW5kZWZpbmVkKSB7CgkJcmV0dXJuIG51bGw7Cgl9CglpZiAodHlwZW9mIGRhdGEgPT09ICJudW1iZXIiKSB7CgkJdmFyIHJlbWFpbmRlciA9IChkYXRhL211bHRpcGxlT2YpJTE7CgkJaWYgKHJlbWFpbmRlciA+PSBDTE9TRV9FTk9VR0hfTE9XICYmIHJlbWFpbmRlciA8IENMT1NFX0VOT1VHSF9ISUdIKSB7CgkJCXJldHVybiB0aGlzLmNyZWF0ZUVycm9yKEVycm9yQ29kZXMuTlVNQkVSX01VTFRJUExFX09GLCB7dmFsdWU6IGRhdGEsIG11bHRpcGxlT2Y6IG11bHRpcGxlT2Z9LCAnJywgJycsIG51bGwsIGRhdGEsIHNjaGVtYSk7CgkJfQoJfQoJcmV0dXJuIG51bGw7Cn07CgpWYWxpZGF0b3JDb250ZXh0LnByb3RvdHlwZS52YWxpZGF0ZU1pbk1heCA9IGZ1bmN0aW9uIHZhbGlkYXRlTWluTWF4KGRhdGEsIHNjaGVtYSkgewoJaWYgKHR5cGVvZiBkYXRhICE9PSAibnVtYmVyIikgewoJCXJldHVybiBudWxsOwoJfQoJaWYgKHNjaGVtYS5taW5pbXVtICE9PSB1bmRlZmluZWQpIHsKCQlpZiAoZGF0YSA8IHNjaGVtYS5taW5pbXVtKSB7CgkJCXJldHVybiB0aGlzLmNyZWF0ZUVycm9yKEVycm9yQ29kZXMuTlVNQkVSX01JTklNVU0sIHt2YWx1ZTogZGF0YSwgbWluaW11bTogc2NoZW1hLm1pbmltdW19LCAnJywgJy9taW5pbXVtJywgbnVsbCwgZGF0YSwgc2NoZW1hKTsKCQl9CgkJaWYgKHNjaGVtYS5leGNsdXNpdmVNaW5pbXVtICYmIGRhdGEgPT09IHNjaGVtYS5taW5pbXVtKSB7CgkJCXJldHVybiB0aGlzLmNyZWF0ZUVycm9yKEVycm9yQ29kZXMuTlVNQkVSX01JTklNVU1fRVhDTFVTSVZFLCB7dmFsdWU6IGRhdGEsIG1pbmltdW06IHNjaGVtYS5taW5pbXVtfSwgJycsICcvZXhjbHVzaXZlTWluaW11bScsIG51bGwsIGRhdGEsIHNjaGVtYSk7CgkJfQoJfQoJaWYgKHNjaGVtYS5tYXhpbXVtICE9PSB1bmRlZmluZWQpIHsKCQlpZiAoZGF0YSA+IHNjaGVtYS5tYXhpbXVtKSB7CgkJCXJldHVybiB0aGlzLmNyZWF0ZUVycm9yKEVycm9yQ29kZXMuTlVNQkVSX01BWElNVU0sIHt2YWx1ZTogZGF0YSwgbWF4aW11bTogc2NoZW1hLm1heGltdW19LCAnJywgJy9tYXhpbXVtJywgbnVsbCwgZGF0YSwgc2NoZW1hKTsKCQl9CgkJaWYgKHNjaGVtYS5leGNsdXNpdmVNYXhpbXVtICYmIGRhdGEgPT09IHNjaGVtYS5tYXhpbXVtKSB7CgkJCXJldHVybiB0aGlzLmNyZWF0ZUVycm9yKEVycm9yQ29kZXMuTlVNQkVSX01BWElNVU1fRVhDTFVTSVZFLCB7dmFsdWU6IGRhdGEsIG1heGltdW06IHNjaGVtYS5tYXhpbXVtfSwgJycsICcvZXhjbHVzaXZlTWF4aW11bScsIG51bGwsIGRhdGEsIHNjaGVtYSk7CgkJfQoJfQoJcmV0dXJuIG51bGw7Cn07CgpWYWxpZGF0b3JDb250ZXh0LnByb3RvdHlwZS52YWxpZGF0ZU5hTiA9IGZ1bmN0aW9uIHZhbGlkYXRlTmFOKGRhdGEsIHNjaGVtYSkgewoJaWYgKHR5cGVvZiBkYXRhICE9PSAibnVtYmVyIikgewoJCXJldHVybiBudWxsOwoJfQoJaWYgKGlzTmFOKGRhdGEpID09PSB0cnVlIHx8IGRhdGEgPT09IEluZmluaXR5IHx8IGRhdGEgPT09IC1JbmZpbml0eSkgewoJCXJldHVybiB0aGlzLmNyZWF0ZUVycm9yKEVycm9yQ29kZXMuTlVNQkVSX05PVF9BX05VTUJFUiwge3ZhbHVlOiBkYXRhfSwgJycsICcvdHlwZScsIG51bGwsIGRhdGEsIHNjaGVtYSk7Cgl9CglyZXR1cm4gbnVsbDsKfTsKClZhbGlkYXRvckNvbnRleHQucHJvdG90eXBlLnZhbGlkYXRlU3RyaW5nID0gZnVuY3Rpb24gdmFsaWRhdGVTdHJpbmcoZGF0YSwgc2NoZW1hLCBkYXRhUG9pbnRlclBhdGgpIHsKCXJldHVybiB0aGlzLnZhbGlkYXRlU3RyaW5nTGVuZ3RoKGRhdGEsIHNjaGVtYSwgZGF0YVBvaW50ZXJQYXRoKQoJCXx8IHRoaXMudmFsaWRhdGVTdHJpbmdQYXR0ZXJuKGRhdGEsIHNjaGVtYSwgZGF0YVBvaW50ZXJQYXRoKQoJCXx8IG51bGw7Cn07CgpWYWxpZGF0b3JDb250ZXh0LnByb3RvdHlwZS52YWxpZGF0ZVN0cmluZ0xlbmd0aCA9IGZ1bmN0aW9uIHZhbGlkYXRlU3RyaW5nTGVuZ3RoKGRhdGEsIHNjaGVtYSkgewoJaWYgKHR5cGVvZiBkYXRhICE9PSAic3RyaW5nIikgewoJCXJldHVybiBudWxsOwoJfQoJaWYgKHNjaGVtYS5taW5MZW5ndGggIT09IHVuZGVmaW5lZCkgewoJCWlmIChkYXRhLmxlbmd0aCA8IHNjaGVtYS5taW5MZW5ndGgpIHsKCQkJcmV0dXJuIHRoaXMuY3JlYXRlRXJyb3IoRXJyb3JDb2Rlcy5TVFJJTkdfTEVOR1RIX1NIT1JULCB7bGVuZ3RoOiBkYXRhLmxlbmd0aCwgbWluaW11bTogc2NoZW1hLm1pbkxlbmd0aH0sICcnLCAnL21pbkxlbmd0aCcsIG51bGwsIGRhdGEsIHNjaGVtYSk7CgkJfQoJfQoJaWYgKHNjaGVtYS5tYXhMZW5ndGggIT09IHVuZGVmaW5lZCkgewoJCWlmIChkYXRhLmxlbmd0aCA+IHNjaGVtYS5tYXhMZW5ndGgpIHsKCQkJcmV0dXJuIHRoaXMuY3JlYXRlRXJyb3IoRXJyb3JDb2Rlcy5TVFJJTkdfTEVOR1RIX0xPTkcsIHtsZW5ndGg6IGRhdGEubGVuZ3RoLCBtYXhpbXVtOiBzY2hlbWEubWF4TGVuZ3RofSwgJycsICcvbWF4TGVuZ3RoJywgbnVsbCwgZGF0YSwgc2NoZW1hKTsKCQl9Cgl9CglyZXR1cm4gbnVsbDsKfTsKClZhbGlkYXRvckNvbnRleHQucHJvdG90eXBlLnZhbGlkYXRlU3RyaW5nUGF0dGVybiA9IGZ1bmN0aW9uIHZhbGlkYXRlU3RyaW5nUGF0dGVybihkYXRhLCBzY2hlbWEpIHsKCWlmICh0eXBlb2YgZGF0YSAhPT0gInN0cmluZyIgfHwgKHR5cGVvZiBzY2hlbWEucGF0dGVybiAhPT0gInN0cmluZyIgJiYgIShzY2hlbWEucGF0dGVybiBpbnN0YW5jZW9mIFJlZ0V4cCkpKSB7CgkJcmV0dXJuIG51bGw7Cgl9Cgl2YXIgcmVnZXhwOwoJaWYgKHNjaGVtYS5wYXR0ZXJuIGluc3RhbmNlb2YgUmVnRXhwKSB7CgkgIHJlZ2V4cCA9IHNjaGVtYS5wYXR0ZXJuOwoJfQoJZWxzZSB7CgkgIHZhciBib2R5LCBmbGFncyA9ICcnOwoJICAvLyBDaGVjayBmb3IgcmVndWxhciBleHByZXNzaW9uIGxpdGVyYWxzCgkgIC8vIEBzZWUgaHR0cDovL3d3dy5lY21hLWludGVybmF0aW9uYWwub3JnL2VjbWEtMjYyLzUuMS8jc2VjLTcuOC41CgkgIHZhciBsaXRlcmFsID0gc2NoZW1hLnBhdHRlcm4ubWF0Y2goL15cLyguKylcLyhbaW1nXSopJC8pOwoJICBpZiAobGl0ZXJhbCkgewoJICAgIGJvZHkgPSBsaXRlcmFsWzFdOwoJICAgIGZsYWdzID0gbGl0ZXJhbFsyXTsKCSAgfQoJICBlbHNlIHsKCSAgICBib2R5ID0gc2NoZW1hLnBhdHRlcm47CgkgIH0KCSAgcmVnZXhwID0gbmV3IFJlZ0V4cChib2R5LCBmbGFncyk7Cgl9CglpZiAoIXJlZ2V4cC50ZXN0KGRhdGEpKSB7CgkJcmV0dXJuIHRoaXMuY3JlYXRlRXJyb3IoRXJyb3JDb2Rlcy5TVFJJTkdfUEFUVEVSTiwge3BhdHRlcm46IHNjaGVtYS5wYXR0ZXJufSwgJycsICcvcGF0dGVybicsIG51bGwsIGRhdGEsIHNjaGVtYSk7Cgl9CglyZXR1cm4gbnVsbDsKfTsKClZhbGlkYXRvckNvbnRleHQucHJvdG90eXBlLnZhbGlkYXRlQXJyYXkgPSBmdW5jdGlvbiB2YWxpZGF0ZUFycmF5KGRhdGEsIHNjaGVtYSwgZGF0YVBvaW50ZXJQYXRoKSB7CglpZiAoIUFycmF5LmlzQXJyYXkoZGF0YSkpIHsKCQlyZXR1cm4gbnVsbDsKCX0KCXJldHVybiB0aGlzLnZhbGlkYXRlQXJyYXlMZW5ndGgoZGF0YSwgc2NoZW1hLCBkYXRhUG9pbnRlclBhdGgpCgkJfHwgdGhpcy52YWxpZGF0ZUFycmF5VW5pcXVlSXRlbXMoZGF0YSwgc2NoZW1hLCBkYXRhUG9pbnRlclBhdGgpCgkJfHwgdGhpcy52YWxpZGF0ZUFycmF5SXRlbXMoZGF0YSwgc2NoZW1hLCBkYXRhUG9pbnRlclBhdGgpCgkJfHwgbnVsbDsKfTsKClZhbGlkYXRvckNvbnRleHQucHJvdG90eXBlLnZhbGlkYXRlQXJyYXlMZW5ndGggPSBmdW5jdGlvbiB2YWxpZGF0ZUFycmF5TGVuZ3RoKGRhdGEsIHNjaGVtYSkgewoJdmFyIGVycm9yOwoJaWYgKHNjaGVtYS5taW5JdGVtcyAhPT0gdW5kZWZpbmVkKSB7CgkJaWYgKGRhdGEubGVuZ3RoIDwgc2NoZW1hLm1pbkl0ZW1zKSB7CgkJCWVycm9yID0gdGhpcy5jcmVhdGVFcnJvcihFcnJvckNvZGVzLkFSUkFZX0xFTkdUSF9TSE9SVCwge2xlbmd0aDogZGF0YS5sZW5ndGgsIG1pbmltdW06IHNjaGVtYS5taW5JdGVtc30sICcnLCAnL21pbkl0ZW1zJywgbnVsbCwgZGF0YSwgc2NoZW1hKTsKCQkJaWYgKHRoaXMuaGFuZGxlRXJyb3IoZXJyb3IpKSB7CgkJCQlyZXR1cm4gZXJyb3I7CgkJCX0KCQl9Cgl9CglpZiAoc2NoZW1hLm1heEl0ZW1zICE9PSB1bmRlZmluZWQpIHsKCQlpZiAoZGF0YS5sZW5ndGggPiBzY2hlbWEubWF4SXRlbXMpIHsKCQkJZXJyb3IgPSB0aGlzLmNyZWF0ZUVycm9yKEVycm9yQ29kZXMuQVJSQVlfTEVOR1RIX0xPTkcsIHtsZW5ndGg6IGRhdGEubGVuZ3RoLCBtYXhpbXVtOiBzY2hlbWEubWF4SXRlbXN9LCAnJywgJy9tYXhJdGVtcycsIG51bGwsIGRhdGEsIHNjaGVtYSk7CgkJCWlmICh0aGlzLmhhbmRsZUVycm9yKGVycm9yKSkgewoJCQkJcmV0dXJuIGVycm9yOwoJCQl9CgkJfQoJfQoJcmV0dXJuIG51bGw7Cn07CgpWYWxpZGF0b3JDb250ZXh0LnByb3RvdHlwZS52YWxpZGF0ZUFycmF5VW5pcXVlSXRlbXMgPSBmdW5jdGlvbiB2YWxpZGF0ZUFycmF5VW5pcXVlSXRlbXMoZGF0YSwgc2NoZW1hKSB7CglpZiAoc2NoZW1hLnVuaXF1ZUl0ZW1zKSB7CgkJZm9yICh2YXIgaSA9IDA7IGkgPCBkYXRhLmxlbmd0aDsgaSsrKSB7CgkJCWZvciAodmFyIGogPSBpICsgMTsgaiA8IGRhdGEubGVuZ3RoOyBqKyspIHsKCQkJCWlmIChyZWN1cnNpdmVDb21wYXJlKGRhdGFbaV0sIGRhdGFbal0pKSB7CgkJCQkJdmFyIGVycm9yID0gdGhpcy5jcmVhdGVFcnJvcihFcnJvckNvZGVzLkFSUkFZX1VOSVFVRSwge21hdGNoMTogaSwgbWF0Y2gyOiBqfSwgJycsICcvdW5pcXVlSXRlbXMnLCBudWxsLCBkYXRhLCBzY2hlbWEpOwoJCQkJCWlmICh0aGlzLmhhbmRsZUVycm9yKGVycm9yKSkgewoJCQkJCQlyZXR1cm4gZXJyb3I7CgkJCQkJfQoJCQkJfQoJCQl9CgkJfQoJfQoJcmV0dXJuIG51bGw7Cn07CgpWYWxpZGF0b3JDb250ZXh0LnByb3RvdHlwZS52YWxpZGF0ZUFycmF5SXRlbXMgPSBmdW5jdGlvbiB2YWxpZGF0ZUFycmF5SXRlbXMoZGF0YSwgc2NoZW1hLCBkYXRhUG9pbnRlclBhdGgpIHsKCWlmIChzY2hlbWEuaXRlbXMgPT09IHVuZGVmaW5lZCkgewoJCXJldHVybiBudWxsOwoJfQoJdmFyIGVycm9yLCBpOwoJaWYgKEFycmF5LmlzQXJyYXkoc2NoZW1hLml0ZW1zKSkgewoJCWZvciAoaSA9IDA7IGkgPCBkYXRhLmxlbmd0aDsgaSsrKSB7CgkJCWlmIChpIDwgc2NoZW1hLml0ZW1zLmxlbmd0aCkgewoJCQkJaWYgKGVycm9yID0gdGhpcy52YWxpZGF0ZUFsbChkYXRhW2ldLCBzY2hlbWEuaXRlbXNbaV0sIFtpXSwgWyJpdGVtcyIsIGldLCBkYXRhUG9pbnRlclBhdGggKyAiLyIgKyBpKSkgewoJCQkJCXJldHVybiBlcnJvcjsKCQkJCX0KCQkJfSBlbHNlIGlmIChzY2hlbWEuYWRkaXRpb25hbEl0ZW1zICE9PSB1bmRlZmluZWQpIHsKCQkJCWlmICh0eXBlb2Ygc2NoZW1hLmFkZGl0aW9uYWxJdGVtcyA9PT0gImJvb2xlYW4iKSB7CgkJCQkJaWYgKCFzY2hlbWEuYWRkaXRpb25hbEl0ZW1zKSB7CgkJCQkJCWVycm9yID0gKHRoaXMuY3JlYXRlRXJyb3IoRXJyb3JDb2Rlcy5BUlJBWV9BRERJVElPTkFMX0lURU1TLCB7fSwgJy8nICsgaSwgJy9hZGRpdGlvbmFsSXRlbXMnLCBudWxsLCBkYXRhLCBzY2hlbWEpKTsKCQkJCQkJaWYgKHRoaXMuaGFuZGxlRXJyb3IoZXJyb3IpKSB7CgkJCQkJCQlyZXR1cm4gZXJyb3I7CgkJCQkJCX0KCQkJCQl9CgkJCQl9IGVsc2UgaWYgKGVycm9yID0gdGhpcy52YWxpZGF0ZUFsbChkYXRhW2ldLCBzY2hlbWEuYWRkaXRpb25hbEl0ZW1zLCBbaV0sIFsiYWRkaXRpb25hbEl0ZW1zIl0sIGRhdGFQb2ludGVyUGF0aCArICIvIiArIGkpKSB7CgkJCQkJcmV0dXJuIGVycm9yOwoJCQkJfQoJCQl9CgkJfQoJfSBlbHNlIHsKCQlmb3IgKGkgPSAwOyBpIDwgZGF0YS5sZW5ndGg7IGkrKykgewoJCQlpZiAoZXJyb3IgPSB0aGlzLnZhbGlkYXRlQWxsKGRhdGFbaV0sIHNjaGVtYS5pdGVtcywgW2ldLCBbIml0ZW1zIl0sIGRhdGFQb2ludGVyUGF0aCArICIvIiArIGkpKSB7CgkJCQlyZXR1cm4gZXJyb3I7CgkJCX0KCQl9Cgl9CglyZXR1cm4gbnVsbDsKfTsKClZhbGlkYXRvckNvbnRleHQucHJvdG90eXBlLnZhbGlkYXRlT2JqZWN0ID0gZnVuY3Rpb24gdmFsaWRhdGVPYmplY3QoZGF0YSwgc2NoZW1hLCBkYXRhUG9pbnRlclBhdGgpIHsKCWlmICh0eXBlb2YgZGF0YSAhPT0gIm9iamVjdCIgfHwgZGF0YSA9PT0gbnVsbCB8fCBBcnJheS5pc0FycmF5KGRhdGEpKSB7CgkJcmV0dXJuIG51bGw7Cgl9CglyZXR1cm4gdGhpcy52YWxpZGF0ZU9iamVjdE1pbk1heFByb3BlcnRpZXMoZGF0YSwgc2NoZW1hLCBkYXRhUG9pbnRlclBhdGgpCgkJfHwgdGhpcy52YWxpZGF0ZU9iamVjdFJlcXVpcmVkUHJvcGVydGllcyhkYXRhLCBzY2hlbWEsIGRhdGFQb2ludGVyUGF0aCkKCQl8fCB0aGlzLnZhbGlkYXRlT2JqZWN0UHJvcGVydGllcyhkYXRhLCBzY2hlbWEsIGRhdGFQb2ludGVyUGF0aCkKCQl8fCB0aGlzLnZhbGlkYXRlT2JqZWN0RGVwZW5kZW5jaWVzKGRhdGEsIHNjaGVtYSwgZGF0YVBvaW50ZXJQYXRoKQoJCXx8IG51bGw7Cn07CgpWYWxpZGF0b3JDb250ZXh0LnByb3RvdHlwZS52YWxpZGF0ZU9iamVjdE1pbk1heFByb3BlcnRpZXMgPSBmdW5jdGlvbiB2YWxpZGF0ZU9iamVjdE1pbk1heFByb3BlcnRpZXMoZGF0YSwgc2NoZW1hKSB7Cgl2YXIga2V5cyA9IE9iamVjdC5rZXlzKGRhdGEpOwoJdmFyIGVycm9yOwoJaWYgKHNjaGVtYS5taW5Qcm9wZXJ0aWVzICE9PSB1bmRlZmluZWQpIHsKCQlpZiAoa2V5cy5sZW5ndGggPCBzY2hlbWEubWluUHJvcGVydGllcykgewoJCQllcnJvciA9IHRoaXMuY3JlYXRlRXJyb3IoRXJyb3JDb2Rlcy5PQkpFQ1RfUFJPUEVSVElFU19NSU5JTVVNLCB7cHJvcGVydHlDb3VudDoga2V5cy5sZW5ndGgsIG1pbmltdW06IHNjaGVtYS5taW5Qcm9wZXJ0aWVzfSwgJycsICcvbWluUHJvcGVydGllcycsIG51bGwsIGRhdGEsIHNjaGVtYSk7CgkJCWlmICh0aGlzLmhhbmRsZUVycm9yKGVycm9yKSkgewoJCQkJcmV0dXJuIGVycm9yOwoJCQl9CgkJfQoJfQoJaWYgKHNjaGVtYS5tYXhQcm9wZXJ0aWVzICE9PSB1bmRlZmluZWQpIHsKCQlpZiAoa2V5cy5sZW5ndGggPiBzY2hlbWEubWF4UHJvcGVydGllcykgewoJCQllcnJvciA9IHRoaXMuY3JlYXRlRXJyb3IoRXJyb3JDb2Rlcy5PQkpFQ1RfUFJPUEVSVElFU19NQVhJTVVNLCB7cHJvcGVydHlDb3VudDoga2V5cy5sZW5ndGgsIG1heGltdW06IHNjaGVtYS5tYXhQcm9wZXJ0aWVzfSwgJycsICcvbWF4UHJvcGVydGllcycsIG51bGwsIGRhdGEsIHNjaGVtYSk7CgkJCWlmICh0aGlzLmhhbmRsZUVycm9yKGVycm9yKSkgewoJCQkJcmV0dXJuIGVycm9yOwoJCQl9CgkJfQoJfQoJcmV0dXJuIG51bGw7Cn07CgpWYWxpZGF0b3JDb250ZXh0LnByb3RvdHlwZS52YWxpZGF0ZU9iamVjdFJlcXVpcmVkUHJvcGVydGllcyA9IGZ1bmN0aW9uIHZhbGlkYXRlT2JqZWN0UmVxdWlyZWRQcm9wZXJ0aWVzKGRhdGEsIHNjaGVtYSkgewoJaWYgKHNjaGVtYS5yZXF1aXJlZCAhPT0gdW5kZWZpbmVkKSB7CgkJZm9yICh2YXIgaSA9IDA7IGkgPCBzY2hlbWEucmVxdWlyZWQubGVuZ3RoOyBpKyspIHsKCQkJdmFyIGtleSA9IHNjaGVtYS5yZXF1aXJlZFtpXTsKCQkJaWYgKGRhdGFba2V5XSA9PT0gdW5kZWZpbmVkKSB7CgkJCQl2YXIgZXJyb3IgPSB0aGlzLmNyZWF0ZUVycm9yKEVycm9yQ29kZXMuT0JKRUNUX1JFUVVJUkVELCB7a2V5OiBrZXl9LCAnJywgJy9yZXF1aXJlZC8nICsgaSwgbnVsbCwgZGF0YSwgc2NoZW1hKTsKCQkJCWlmICh0aGlzLmhhbmRsZUVycm9yKGVycm9yKSkgewoJCQkJCXJldHVybiBlcnJvcjsKCQkJCX0KCQkJfQoJCX0KCX0KCXJldHVybiBudWxsOwp9OwoKVmFsaWRhdG9yQ29udGV4dC5wcm90b3R5cGUudmFsaWRhdGVPYmplY3RQcm9wZXJ0aWVzID0gZnVuY3Rpb24gdmFsaWRhdGVPYmplY3RQcm9wZXJ0aWVzKGRhdGEsIHNjaGVtYSwgZGF0YVBvaW50ZXJQYXRoKSB7Cgl2YXIgZXJyb3I7Cglmb3IgKHZhciBrZXkgaW4gZGF0YSkgewoJCXZhciBrZXlQb2ludGVyUGF0aCA9IGRhdGFQb2ludGVyUGF0aCArICIvIiArIGtleS5yZXBsYWNlKC9+L2csICd+MCcpLnJlcGxhY2UoL1wvL2csICd+MScpOwoJCXZhciBmb3VuZE1hdGNoID0gZmFsc2U7CgkJaWYgKHNjaGVtYS5wcm9wZXJ0aWVzICE9PSB1bmRlZmluZWQgJiYgc2NoZW1hLnByb3BlcnRpZXNba2V5XSAhPT0gdW5kZWZpbmVkKSB7CgkJCWZvdW5kTWF0Y2ggPSB0cnVlOwoJCQlpZiAoZXJyb3IgPSB0aGlzLnZhbGlkYXRlQWxsKGRhdGFba2V5XSwgc2NoZW1hLnByb3BlcnRpZXNba2V5XSwgW2tleV0sIFsicHJvcGVydGllcyIsIGtleV0sIGtleVBvaW50ZXJQYXRoKSkgewoJCQkJcmV0dXJuIGVycm9yOwoJCQl9CgkJfQoJCWlmIChzY2hlbWEucGF0dGVyblByb3BlcnRpZXMgIT09IHVuZGVmaW5lZCkgewoJCQlmb3IgKHZhciBwYXR0ZXJuS2V5IGluIHNjaGVtYS5wYXR0ZXJuUHJvcGVydGllcykgewoJCQkJdmFyIHJlZ2V4cCA9IG5ldyBSZWdFeHAocGF0dGVybktleSk7CgkJCQlpZiAocmVnZXhwLnRlc3Qoa2V5KSkgewoJCQkJCWZvdW5kTWF0Y2ggPSB0cnVlOwoJCQkJCWlmIChlcnJvciA9IHRoaXMudmFsaWRhdGVBbGwoZGF0YVtrZXldLCBzY2hlbWEucGF0dGVyblByb3BlcnRpZXNbcGF0dGVybktleV0sIFtrZXldLCBbInBhdHRlcm5Qcm9wZXJ0aWVzIiwgcGF0dGVybktleV0sIGtleVBvaW50ZXJQYXRoKSkgewoJCQkJCQlyZXR1cm4gZXJyb3I7CgkJCQkJfQoJCQkJfQoJCQl9CgkJfQoJCWlmICghZm91bmRNYXRjaCkgewoJCQlpZiAoc2NoZW1hLmFkZGl0aW9uYWxQcm9wZXJ0aWVzICE9PSB1bmRlZmluZWQpIHsKCQkJCWlmICh0aGlzLnRyYWNrVW5rbm93blByb3BlcnRpZXMpIHsKCQkJCQl0aGlzLmtub3duUHJvcGVydHlQYXRoc1trZXlQb2ludGVyUGF0aF0gPSB0cnVlOwoJCQkJCWRlbGV0ZSB0aGlzLnVua25vd25Qcm9wZXJ0eVBhdGhzW2tleVBvaW50ZXJQYXRoXTsKCQkJCX0KCQkJCWlmICh0eXBlb2Ygc2NoZW1hLmFkZGl0aW9uYWxQcm9wZXJ0aWVzID09PSAiYm9vbGVhbiIpIHsKCQkJCQlpZiAoIXNjaGVtYS5hZGRpdGlvbmFsUHJvcGVydGllcykgewoJCQkJCQllcnJvciA9IHRoaXMuY3JlYXRlRXJyb3IoRXJyb3JDb2Rlcy5PQkpFQ1RfQURESVRJT05BTF9QUk9QRVJUSUVTLCB7a2V5OiBrZXl9LCAnJywgJy9hZGRpdGlvbmFsUHJvcGVydGllcycsIG51bGwsIGRhdGEsIHNjaGVtYSkucHJlZml4V2l0aChrZXksIG51bGwpOwoJCQkJCQlpZiAodGhpcy5oYW5kbGVFcnJvcihlcnJvcikpIHsKCQkJCQkJCXJldHVybiBlcnJvcjsKCQkJCQkJfQoJCQkJCX0KCQkJCX0gZWxzZSB7CgkJCQkJaWYgKGVycm9yID0gdGhpcy52YWxpZGF0ZUFsbChkYXRhW2tleV0sIHNjaGVtYS5hZGRpdGlvbmFsUHJvcGVydGllcywgW2tleV0sIFsiYWRkaXRpb25hbFByb3BlcnRpZXMiXSwga2V5UG9pbnRlclBhdGgpKSB7CgkJCQkJCXJldHVybiBlcnJvcjsKCQkJCQl9CgkJCQl9CgkJCX0gZWxzZSBpZiAodGhpcy50cmFja1Vua25vd25Qcm9wZXJ0aWVzICYmICF0aGlzLmtub3duUHJvcGVydHlQYXRoc1trZXlQb2ludGVyUGF0aF0pIHsKCQkJCXRoaXMudW5rbm93blByb3BlcnR5UGF0aHNba2V5UG9pbnRlclBhdGhdID0gdHJ1ZTsKCQkJfQoJCX0gZWxzZSBpZiAodGhpcy50cmFja1Vua25vd25Qcm9wZXJ0aWVzKSB7CgkJCXRoaXMua25vd25Qcm9wZXJ0eVBhdGhzW2tleVBvaW50ZXJQYXRoXSA9IHRydWU7CgkJCWRlbGV0ZSB0aGlzLnVua25vd25Qcm9wZXJ0eVBhdGhzW2tleVBvaW50ZXJQYXRoXTsKCQl9Cgl9CglyZXR1cm4gbnVsbDsKfTsKClZhbGlkYXRvckNvbnRleHQucHJvdG90eXBlLnZhbGlkYXRlT2JqZWN0RGVwZW5kZW5jaWVzID0gZnVuY3Rpb24gdmFsaWRhdGVPYmplY3REZXBlbmRlbmNpZXMoZGF0YSwgc2NoZW1hLCBkYXRhUG9pbnRlclBhdGgpIHsKCXZhciBlcnJvcjsKCWlmIChzY2hlbWEuZGVwZW5kZW5jaWVzICE9PSB1bmRlZmluZWQpIHsKCQlmb3IgKHZhciBkZXBLZXkgaW4gc2NoZW1hLmRlcGVuZGVuY2llcykgewoJCQlpZiAoZGF0YVtkZXBLZXldICE9PSB1bmRlZmluZWQpIHsKCQkJCXZhciBkZXAgPSBzY2hlbWEuZGVwZW5kZW5jaWVzW2RlcEtleV07CgkJCQlpZiAodHlwZW9mIGRlcCA9PT0gInN0cmluZyIpIHsKCQkJCQlpZiAoZGF0YVtkZXBdID09PSB1bmRlZmluZWQpIHsKCQkJCQkJZXJyb3IgPSB0aGlzLmNyZWF0ZUVycm9yKEVycm9yQ29kZXMuT0JKRUNUX0RFUEVOREVOQ1lfS0VZLCB7a2V5OiBkZXBLZXksIG1pc3Npbmc6IGRlcH0sICcnLCAnJywgbnVsbCwgZGF0YSwgc2NoZW1hKS5wcmVmaXhXaXRoKG51bGwsIGRlcEtleSkucHJlZml4V2l0aChudWxsLCAiZGVwZW5kZW5jaWVzIik7CgkJCQkJCWlmICh0aGlzLmhhbmRsZUVycm9yKGVycm9yKSkgewoJCQkJCQkJcmV0dXJuIGVycm9yOwoJCQkJCQl9CgkJCQkJfQoJCQkJfSBlbHNlIGlmIChBcnJheS5pc0FycmF5KGRlcCkpIHsKCQkJCQlmb3IgKHZhciBpID0gMDsgaSA8IGRlcC5sZW5ndGg7IGkrKykgewoJCQkJCQl2YXIgcmVxdWlyZWRLZXkgPSBkZXBbaV07CgkJCQkJCWlmIChkYXRhW3JlcXVpcmVkS2V5XSA9PT0gdW5kZWZpbmVkKSB7CgkJCQkJCQllcnJvciA9IHRoaXMuY3JlYXRlRXJyb3IoRXJyb3JDb2Rlcy5PQkpFQ1RfREVQRU5ERU5DWV9LRVksIHtrZXk6IGRlcEtleSwgbWlzc2luZzogcmVxdWlyZWRLZXl9LCAnJywgJy8nICsgaSwgbnVsbCwgZGF0YSwgc2NoZW1hKS5wcmVmaXhXaXRoKG51bGwsIGRlcEtleSkucHJlZml4V2l0aChudWxsLCAiZGVwZW5kZW5jaWVzIik7CgkJCQkJCQlpZiAodGhpcy5oYW5kbGVFcnJvcihlcnJvcikpIHsKCQkJCQkJCQlyZXR1cm4gZXJyb3I7CgkJCQkJCQl9CgkJCQkJCX0KCQkJCQl9CgkJCQl9IGVsc2UgewoJCQkJCWlmIChlcnJvciA9IHRoaXMudmFsaWRhdGVBbGwoZGF0YSwgZGVwLCBbXSwgWyJkZXBlbmRlbmNpZXMiLCBkZXBLZXldLCBkYXRhUG9pbnRlclBhdGgpKSB7CgkJCQkJCXJldHVybiBlcnJvcjsKCQkJCQl9CgkJCQl9CgkJCX0KCQl9Cgl9CglyZXR1cm4gbnVsbDsKfTsKClZhbGlkYXRvckNvbnRleHQucHJvdG90eXBlLnZhbGlkYXRlQ29tYmluYXRpb25zID0gZnVuY3Rpb24gdmFsaWRhdGVDb21iaW5hdGlvbnMoZGF0YSwgc2NoZW1hLCBkYXRhUG9pbnRlclBhdGgpIHsKCXJldHVybiB0aGlzLnZhbGlkYXRlQWxsT2YoZGF0YSwgc2NoZW1hLCBkYXRhUG9pbnRlclBhdGgpCgkJfHwgdGhpcy52YWxpZGF0ZUFueU9mKGRhdGEsIHNjaGVtYSwgZGF0YVBvaW50ZXJQYXRoKQoJCXx8IHRoaXMudmFsaWRhdGVPbmVPZihkYXRhLCBzY2hlbWEsIGRhdGFQb2ludGVyUGF0aCkKCQl8fCB0aGlzLnZhbGlkYXRlTm90KGRhdGEsIHNjaGVtYSwgZGF0YVBvaW50ZXJQYXRoKQoJCXx8IG51bGw7Cn07CgpWYWxpZGF0b3JDb250ZXh0LnByb3RvdHlwZS52YWxpZGF0ZUFsbE9mID0gZnVuY3Rpb24gdmFsaWRhdGVBbGxPZihkYXRhLCBzY2hlbWEsIGRhdGFQb2ludGVyUGF0aCkgewoJaWYgKHNjaGVtYS5hbGxPZiA9PT0gdW5kZWZpbmVkKSB7CgkJcmV0dXJuIG51bGw7Cgl9Cgl2YXIgZXJyb3I7Cglmb3IgKHZhciBpID0gMDsgaSA8IHNjaGVtYS5hbGxPZi5sZW5ndGg7IGkrKykgewoJCXZhciBzdWJTY2hlbWEgPSBzY2hlbWEuYWxsT2ZbaV07CgkJaWYgKGVycm9yID0gdGhpcy52YWxpZGF0ZUFsbChkYXRhLCBzdWJTY2hlbWEsIFtdLCBbImFsbE9mIiwgaV0sIGRhdGFQb2ludGVyUGF0aCkpIHsKCQkJcmV0dXJuIGVycm9yOwoJCX0KCX0KCXJldHVybiBudWxsOwp9OwoKVmFsaWRhdG9yQ29udGV4dC5wcm90b3R5cGUudmFsaWRhdGVBbnlPZiA9IGZ1bmN0aW9uIHZhbGlkYXRlQW55T2YoZGF0YSwgc2NoZW1hLCBkYXRhUG9pbnRlclBhdGgpIHsKCWlmIChzY2hlbWEuYW55T2YgPT09IHVuZGVmaW5lZCkgewoJCXJldHVybiBudWxsOwoJfQoJdmFyIGVycm9ycyA9IFtdOwoJdmFyIHN0YXJ0RXJyb3JDb3VudCA9IHRoaXMuZXJyb3JzLmxlbmd0aDsKCXZhciBvbGRVbmtub3duUHJvcGVydHlQYXRocywgb2xkS25vd25Qcm9wZXJ0eVBhdGhzOwoJaWYgKHRoaXMudHJhY2tVbmtub3duUHJvcGVydGllcykgewoJCW9sZFVua25vd25Qcm9wZXJ0eVBhdGhzID0gdGhpcy51bmtub3duUHJvcGVydHlQYXRoczsKCQlvbGRLbm93blByb3BlcnR5UGF0aHMgPSB0aGlzLmtub3duUHJvcGVydHlQYXRoczsKCX0KCXZhciBlcnJvckF0RW5kID0gdHJ1ZTsKCWZvciAodmFyIGkgPSAwOyBpIDwgc2NoZW1hLmFueU9mLmxlbmd0aDsgaSsrKSB7CgkJaWYgKHRoaXMudHJhY2tVbmtub3duUHJvcGVydGllcykgewoJCQl0aGlzLnVua25vd25Qcm9wZXJ0eVBhdGhzID0ge307CgkJCXRoaXMua25vd25Qcm9wZXJ0eVBhdGhzID0ge307CgkJfQoJCXZhciBzdWJTY2hlbWEgPSBzY2hlbWEuYW55T2ZbaV07CgoJCXZhciBlcnJvckNvdW50ID0gdGhpcy5lcnJvcnMubGVuZ3RoOwoJCXZhciBlcnJvciA9IHRoaXMudmFsaWRhdGVBbGwoZGF0YSwgc3ViU2NoZW1hLCBbXSwgWyJhbnlPZiIsIGldLCBkYXRhUG9pbnRlclBhdGgpOwoKCQlpZiAoZXJyb3IgPT09IG51bGwgJiYgZXJyb3JDb3VudCA9PT0gdGhpcy5lcnJvcnMubGVuZ3RoKSB7CgkJCXRoaXMuZXJyb3JzID0gdGhpcy5lcnJvcnMuc2xpY2UoMCwgc3RhcnRFcnJvckNvdW50KTsKCgkJCWlmICh0aGlzLnRyYWNrVW5rbm93blByb3BlcnRpZXMpIHsKCQkJCWZvciAodmFyIGtub3duS2V5IGluIHRoaXMua25vd25Qcm9wZXJ0eVBhdGhzKSB7CgkJCQkJb2xkS25vd25Qcm9wZXJ0eVBhdGhzW2tub3duS2V5XSA9IHRydWU7CgkJCQkJZGVsZXRlIG9sZFVua25vd25Qcm9wZXJ0eVBhdGhzW2tub3duS2V5XTsKCQkJCX0KCQkJCWZvciAodmFyIHVua25vd25LZXkgaW4gdGhpcy51bmtub3duUHJvcGVydHlQYXRocykgewoJCQkJCWlmICghb2xkS25vd25Qcm9wZXJ0eVBhdGhzW3Vua25vd25LZXldKSB7CgkJCQkJCW9sZFVua25vd25Qcm9wZXJ0eVBhdGhzW3Vua25vd25LZXldID0gdHJ1ZTsKCQkJCQl9CgkJCQl9CgkJCQkvLyBXZSBuZWVkIHRvIGNvbnRpbnVlIGxvb3Bpbmcgc28gd2UgY2F0Y2ggYWxsIHRoZSBwcm9wZXJ0eSBkZWZpbml0aW9ucywgYnV0IHdlIGRvbid0IHdhbnQgdG8gcmV0dXJuIGFuIGVycm9yCgkJCQllcnJvckF0RW5kID0gZmFsc2U7CgkJCQljb250aW51ZTsKCQkJfQoKCQkJcmV0dXJuIG51bGw7CgkJfQoJCWlmIChlcnJvcikgewoJCQllcnJvcnMucHVzaChlcnJvci5wcmVmaXhXaXRoKG51bGwsICIiICsgaSkucHJlZml4V2l0aChudWxsLCAiYW55T2YiKSk7CgkJfQoJfQoJaWYgKHRoaXMudHJhY2tVbmtub3duUHJvcGVydGllcykgewoJCXRoaXMudW5rbm93blByb3BlcnR5UGF0aHMgPSBvbGRVbmtub3duUHJvcGVydHlQYXRoczsKCQl0aGlzLmtub3duUHJvcGVydHlQYXRocyA9IG9sZEtub3duUHJvcGVydHlQYXRoczsKCX0KCWlmIChlcnJvckF0RW5kKSB7CgkJZXJyb3JzID0gZXJyb3JzLmNvbmNhdCh0aGlzLmVycm9ycy5zbGljZShzdGFydEVycm9yQ291bnQpKTsKCQl0aGlzLmVycm9ycyA9IHRoaXMuZXJyb3JzLnNsaWNlKDAsIHN0YXJ0RXJyb3JDb3VudCk7CgkJcmV0dXJuIHRoaXMuY3JlYXRlRXJyb3IoRXJyb3JDb2Rlcy5BTllfT0ZfTUlTU0lORywge30sICIiLCAiL2FueU9mIiwgZXJyb3JzLCBkYXRhLCBzY2hlbWEpOwoJfQp9OwoKVmFsaWRhdG9yQ29udGV4dC5wcm90b3R5cGUudmFsaWRhdGVPbmVPZiA9IGZ1bmN0aW9uIHZhbGlkYXRlT25lT2YoZGF0YSwgc2NoZW1hLCBkYXRhUG9pbnRlclBhdGgpIHsKCWlmIChzY2hlbWEub25lT2YgPT09IHVuZGVmaW5lZCkgewoJCXJldHVybiBudWxsOwoJfQoJdmFyIHZhbGlkSW5kZXggPSBudWxsOwoJdmFyIGVycm9ycyA9IFtdOwoJdmFyIHN0YXJ0RXJyb3JDb3VudCA9IHRoaXMuZXJyb3JzLmxlbmd0aDsKCXZhciBvbGRVbmtub3duUHJvcGVydHlQYXRocywgb2xkS25vd25Qcm9wZXJ0eVBhdGhzOwoJaWYgKHRoaXMudHJhY2tVbmtub3duUHJvcGVydGllcykgewoJCW9sZFVua25vd25Qcm9wZXJ0eVBhdGhzID0gdGhpcy51bmtub3duUHJvcGVydHlQYXRoczsKCQlvbGRLbm93blByb3BlcnR5UGF0aHMgPSB0aGlzLmtub3duUHJvcGVydHlQYXRoczsKCX0KCWZvciAodmFyIGkgPSAwOyBpIDwgc2NoZW1hLm9uZU9mLmxlbmd0aDsgaSsrKSB7CgkJaWYgKHRoaXMudHJhY2tVbmtub3duUHJvcGVydGllcykgewoJCQl0aGlzLnVua25vd25Qcm9wZXJ0eVBhdGhzID0ge307CgkJCXRoaXMua25vd25Qcm9wZXJ0eVBhdGhzID0ge307CgkJfQoJCXZhciBzdWJTY2hlbWEgPSBzY2hlbWEub25lT2ZbaV07CgoJCXZhciBlcnJvckNvdW50ID0gdGhpcy5lcnJvcnMubGVuZ3RoOwoJCXZhciBlcnJvciA9IHRoaXMudmFsaWRhdGVBbGwoZGF0YSwgc3ViU2NoZW1hLCBbXSwgWyJvbmVPZiIsIGldLCBkYXRhUG9pbnRlclBhdGgpOwoKCQlpZiAoZXJyb3IgPT09IG51bGwgJiYgZXJyb3JDb3VudCA9PT0gdGhpcy5lcnJvcnMubGVuZ3RoKSB7CgkJCWlmICh2YWxpZEluZGV4ID09PSBudWxsKSB7CgkJCQl2YWxpZEluZGV4ID0gaTsKCQkJfSBlbHNlIHsKCQkJCXRoaXMuZXJyb3JzID0gdGhpcy5lcnJvcnMuc2xpY2UoMCwgc3RhcnRFcnJvckNvdW50KTsKCQkJCXJldHVybiB0aGlzLmNyZWF0ZUVycm9yKEVycm9yQ29kZXMuT05FX09GX01VTFRJUExFLCB7aW5kZXgxOiB2YWxpZEluZGV4LCBpbmRleDI6IGl9LCAiIiwgIi9vbmVPZiIsIG51bGwsIGRhdGEsIHNjaGVtYSk7CgkJCX0KCQkJaWYgKHRoaXMudHJhY2tVbmtub3duUHJvcGVydGllcykgewoJCQkJZm9yICh2YXIga25vd25LZXkgaW4gdGhpcy5rbm93blByb3BlcnR5UGF0aHMpIHsKCQkJCQlvbGRLbm93blByb3BlcnR5UGF0aHNba25vd25LZXldID0gdHJ1ZTsKCQkJCQlkZWxldGUgb2xkVW5rbm93blByb3BlcnR5UGF0aHNba25vd25LZXldOwoJCQkJfQoJCQkJZm9yICh2YXIgdW5rbm93bktleSBpbiB0aGlzLnVua25vd25Qcm9wZXJ0eVBhdGhzKSB7CgkJCQkJaWYgKCFvbGRLbm93blByb3BlcnR5UGF0aHNbdW5rbm93bktleV0pIHsKCQkJCQkJb2xkVW5rbm93blByb3BlcnR5UGF0aHNbdW5rbm93bktleV0gPSB0cnVlOwoJCQkJCX0KCQkJCX0KCQkJfQoJCX0gZWxzZSBpZiAoZXJyb3IpIHsKCQkJZXJyb3JzLnB1c2goZXJyb3IpOwoJCX0KCX0KCWlmICh0aGlzLnRyYWNrVW5rbm93blByb3BlcnRpZXMpIHsKCQl0aGlzLnVua25vd25Qcm9wZXJ0eVBhdGhzID0gb2xkVW5rbm93blByb3BlcnR5UGF0aHM7CgkJdGhpcy5rbm93blByb3BlcnR5UGF0aHMgPSBvbGRLbm93blByb3BlcnR5UGF0aHM7Cgl9CglpZiAodmFsaWRJbmRleCA9PT0gbnVsbCkgewoJCWVycm9ycyA9IGVycm9ycy5jb25jYXQodGhpcy5lcnJvcnMuc2xpY2Uoc3RhcnRFcnJvckNvdW50KSk7CgkJdGhpcy5lcnJvcnMgPSB0aGlzLmVycm9ycy5zbGljZSgwLCBzdGFydEVycm9yQ291bnQpOwoJCXJldHVybiB0aGlzLmNyZWF0ZUVycm9yKEVycm9yQ29kZXMuT05FX09GX01JU1NJTkcsIHt9LCAiIiwgIi9vbmVPZiIsIGVycm9ycywgZGF0YSwgc2NoZW1hKTsKCX0gZWxzZSB7CgkJdGhpcy5lcnJvcnMgPSB0aGlzLmVycm9ycy5zbGljZSgwLCBzdGFydEVycm9yQ291bnQpOwoJfQoJcmV0dXJuIG51bGw7Cn07CgpWYWxpZGF0b3JDb250ZXh0LnByb3RvdHlwZS52YWxpZGF0ZU5vdCA9IGZ1bmN0aW9uIHZhbGlkYXRlTm90KGRhdGEsIHNjaGVtYSwgZGF0YVBvaW50ZXJQYXRoKSB7CglpZiAoc2NoZW1hLm5vdCA9PT0gdW5kZWZpbmVkKSB7CgkJcmV0dXJuIG51bGw7Cgl9Cgl2YXIgb2xkRXJyb3JDb3VudCA9IHRoaXMuZXJyb3JzLmxlbmd0aDsKCXZhciBvbGRVbmtub3duUHJvcGVydHlQYXRocywgb2xkS25vd25Qcm9wZXJ0eVBhdGhzOwoJaWYgKHRoaXMudHJhY2tVbmtub3duUHJvcGVydGllcykgewoJCW9sZFVua25vd25Qcm9wZXJ0eVBhdGhzID0gdGhpcy51bmtub3duUHJvcGVydHlQYXRoczsKCQlvbGRLbm93blByb3BlcnR5UGF0aHMgPSB0aGlzLmtub3duUHJvcGVydHlQYXRoczsKCQl0aGlzLnVua25vd25Qcm9wZXJ0eVBhdGhzID0ge307CgkJdGhpcy5rbm93blByb3BlcnR5UGF0aHMgPSB7fTsKCX0KCXZhciBlcnJvciA9IHRoaXMudmFsaWRhdGVBbGwoZGF0YSwgc2NoZW1hLm5vdCwgbnVsbCwgbnVsbCwgZGF0YVBvaW50ZXJQYXRoKTsKCXZhciBub3RFcnJvcnMgPSB0aGlzLmVycm9ycy5zbGljZShvbGRFcnJvckNvdW50KTsKCXRoaXMuZXJyb3JzID0gdGhpcy5lcnJvcnMuc2xpY2UoMCwgb2xkRXJyb3JDb3VudCk7CglpZiAodGhpcy50cmFja1Vua25vd25Qcm9wZXJ0aWVzKSB7CgkJdGhpcy51bmtub3duUHJvcGVydHlQYXRocyA9IG9sZFVua25vd25Qcm9wZXJ0eVBhdGhzOwoJCXRoaXMua25vd25Qcm9wZXJ0eVBhdGhzID0gb2xkS25vd25Qcm9wZXJ0eVBhdGhzOwoJfQoJaWYgKGVycm9yID09PSBudWxsICYmIG5vdEVycm9ycy5sZW5ndGggPT09IDApIHsKCQlyZXR1cm4gdGhpcy5jcmVhdGVFcnJvcihFcnJvckNvZGVzLk5PVF9QQVNTRUQsIHt9LCAiIiwgIi9ub3QiLCBudWxsLCBkYXRhLCBzY2hlbWEpOwoJfQoJcmV0dXJuIG51bGw7Cn07CgpWYWxpZGF0b3JDb250ZXh0LnByb3RvdHlwZS52YWxpZGF0ZUh5cGVybWVkaWEgPSBmdW5jdGlvbiB2YWxpZGF0ZUNvbWJpbmF0aW9ucyhkYXRhLCBzY2hlbWEsIGRhdGFQb2ludGVyUGF0aCkgewoJaWYgKCFzY2hlbWEubGlua3MpIHsKCQlyZXR1cm4gbnVsbDsKCX0KCXZhciBlcnJvcjsKCWZvciAodmFyIGkgPSAwOyBpIDwgc2NoZW1hLmxpbmtzLmxlbmd0aDsgaSsrKSB7CgkJdmFyIGxkbyA9IHNjaGVtYS5saW5rc1tpXTsKCQlpZiAobGRvLnJlbCA9PT0gImRlc2NyaWJlZGJ5IikgewoJCQl2YXIgdGVtcGxhdGUgPSBuZXcgVXJpVGVtcGxhdGUobGRvLmhyZWYpOwoJCQl2YXIgYWxsUHJlc2VudCA9IHRydWU7CgkJCWZvciAodmFyIGogPSAwOyBqIDwgdGVtcGxhdGUudmFyTmFtZXMubGVuZ3RoOyBqKyspIHsKCQkJCWlmICghKHRlbXBsYXRlLnZhck5hbWVzW2pdIGluIGRhdGEpKSB7CgkJCQkJYWxsUHJlc2VudCA9IGZhbHNlOwoJCQkJCWJyZWFrOwoJCQkJfQoJCQl9CgkJCWlmIChhbGxQcmVzZW50KSB7CgkJCQl2YXIgc2NoZW1hVXJsID0gdGVtcGxhdGUuZmlsbEZyb21PYmplY3QoZGF0YSk7CgkJCQl2YXIgc3ViU2NoZW1hID0geyIkcmVmIjogc2NoZW1hVXJsfTsKCQkJCWlmIChlcnJvciA9IHRoaXMudmFsaWRhdGVBbGwoZGF0YSwgc3ViU2NoZW1hLCBbXSwgWyJsaW5rcyIsIGldLCBkYXRhUG9pbnRlclBhdGgpKSB7CgkJCQkJcmV0dXJuIGVycm9yOwoJCQkJfQoJCQl9CgkJfQoJfQp9OwoKLy8gcGFyc2VVUkkoKSBhbmQgcmVzb2x2ZVVybCgpIGFyZSBmcm9tIGh0dHBzOi8vZ2lzdC5naXRodWIuY29tLzEwODg4NTAKLy8gICAtICByZWxlYXNlZCBhcyBwdWJsaWMgZG9tYWluIGJ5IGF1dGhvciAoIllhZmZsZSIpIC0gc2VlIGNvbW1lbnRzIG9uIGdpc3QKCmZ1bmN0aW9uIHBhcnNlVVJJKHVybCkgewoJdmFyIG0gPSBTdHJpbmcodXJsKS5yZXBsYWNlKC9eXHMrfFxzKyQvZywgJycpLm1hdGNoKC9eKFteOlwvPyNdKzopPyhcL1wvKD86W146QF0qKD86OlteOkBdKik/QCk/KChbXjpcLz8jXSopKD86OihcZCopKT8pKT8oW14/I10qKShcP1teI10qKT8oI1tcc1xTXSopPy8pOwoJLy8gYXV0aG9yaXR5ID0gJy8vJyArIHVzZXIgKyAnOicgKyBwYXNzICdAJyArIGhvc3RuYW1lICsgJzonIHBvcnQKCXJldHVybiAobSA/IHsKCQlocmVmICAgICA6IG1bMF0gfHwgJycsCgkJcHJvdG9jb2wgOiBtWzFdIHx8ICcnLAoJCWF1dGhvcml0eTogbVsyXSB8fCAnJywKCQlob3N0ICAgICA6IG1bM10gfHwgJycsCgkJaG9zdG5hbWUgOiBtWzRdIHx8ICcnLAoJCXBvcnQgICAgIDogbVs1XSB8fCAnJywKCQlwYXRobmFtZSA6IG1bNl0gfHwgJycsCgkJc2VhcmNoICAgOiBtWzddIHx8ICcnLAoJCWhhc2ggICAgIDogbVs4XSB8fCAnJwoJfSA6IG51bGwpOwp9CgpmdW5jdGlvbiByZXNvbHZlVXJsKGJhc2UsIGhyZWYpIHsvLyBSRkMgMzk4NgoKCWZ1bmN0aW9uIHJlbW92ZURvdFNlZ21lbnRzKGlucHV0KSB7CgkJdmFyIG91dHB1dCA9IFtdOwoJCWlucHV0LnJlcGxhY2UoL14oXC5cLj8oXC98JCkpKy8sICcnKQoJCQkucmVwbGFjZSgvXC8oXC4oXC98JCkpKy9nLCAnLycpCgkJCS5yZXBsYWNlKC9cL1wuXC4kLywgJy8uLi8nKQoJCQkucmVwbGFjZSgvXC8/W15cL10qL2csIGZ1bmN0aW9uIChwKSB7CgkJCQlpZiAocCA9PT0gJy8uLicpIHsKCQkJCQlvdXRwdXQucG9wKCk7CgkJCQl9IGVsc2UgewoJCQkJCW91dHB1dC5wdXNoKHApOwoJCQkJfQoJCX0pOwoJCXJldHVybiBvdXRwdXQuam9pbignJykucmVwbGFjZSgvXlwvLywgaW5wdXQuY2hhckF0KDApID09PSAnLycgPyAnLycgOiAnJyk7Cgl9CgoJaHJlZiA9IHBhcnNlVVJJKGhyZWYgfHwgJycpOwoJYmFzZSA9IHBhcnNlVVJJKGJhc2UgfHwgJycpOwoKCXJldHVybiAhaHJlZiB8fCAhYmFzZSA/IG51bGwgOiAoaHJlZi5wcm90b2NvbCB8fCBiYXNlLnByb3RvY29sKSArCgkJKGhyZWYucHJvdG9jb2wgfHwgaHJlZi5hdXRob3JpdHkgPyBocmVmLmF1dGhvcml0eSA6IGJhc2UuYXV0aG9yaXR5KSArCgkJcmVtb3ZlRG90U2VnbWVudHMoaHJlZi5wcm90b2NvbCB8fCBocmVmLmF1dGhvcml0eSB8fCBocmVmLnBhdGhuYW1lLmNoYXJBdCgwKSA9PT0gJy8nID8gaHJlZi5wYXRobmFtZSA6IChocmVmLnBhdGhuYW1lID8gKChiYXNlLmF1dGhvcml0eSAmJiAhYmFzZS5wYXRobmFtZSA/ICcvJyA6ICcnKSArIGJhc2UucGF0aG5hbWUuc2xpY2UoMCwgYmFzZS5wYXRobmFtZS5sYXN0SW5kZXhPZignLycpICsgMSkgKyBocmVmLnBhdGhuYW1lKSA6IGJhc2UucGF0aG5hbWUpKSArCgkJKGhyZWYucHJvdG9jb2wgfHwgaHJlZi5hdXRob3JpdHkgfHwgaHJlZi5wYXRobmFtZSA/IGhyZWYuc2VhcmNoIDogKGhyZWYuc2VhcmNoIHx8IGJhc2Uuc2VhcmNoKSkgKwoJCWhyZWYuaGFzaDsKfQoKZnVuY3Rpb24gZ2V0RG9jdW1lbnRVcmkodXJpKSB7CglyZXR1cm4gdXJpLnNwbGl0KCcjJylbMF07Cn0KZnVuY3Rpb24gbm9ybVNjaGVtYShzY2hlbWEsIGJhc2VVcmkpIHsKCWlmIChzY2hlbWEgJiYgdHlwZW9mIHNjaGVtYSA9PT0gIm9iamVjdCIpIHsKCQlpZiAoYmFzZVVyaSA9PT0gdW5kZWZpbmVkKSB7CgkJCWJhc2VVcmkgPSBzY2hlbWEuaWQ7CgkJfSBlbHNlIGlmICh0eXBlb2Ygc2NoZW1hLmlkID09PSAic3RyaW5nIikgewoJCQliYXNlVXJpID0gcmVzb2x2ZVVybChiYXNlVXJpLCBzY2hlbWEuaWQpOwoJCQlzY2hlbWEuaWQgPSBiYXNlVXJpOwoJCX0KCQlpZiAoQXJyYXkuaXNBcnJheShzY2hlbWEpKSB7CgkJCWZvciAodmFyIGkgPSAwOyBpIDwgc2NoZW1hLmxlbmd0aDsgaSsrKSB7CgkJCQlub3JtU2NoZW1hKHNjaGVtYVtpXSwgYmFzZVVyaSk7CgkJCX0KCQl9IGVsc2UgewoJCQlpZiAodHlwZW9mIHNjaGVtYVsnJHJlZiddID09PSAic3RyaW5nIikgewoJCQkJc2NoZW1hWyckcmVmJ10gPSByZXNvbHZlVXJsKGJhc2VVcmksIHNjaGVtYVsnJHJlZiddKTsKCQkJfQoJCQlmb3IgKHZhciBrZXkgaW4gc2NoZW1hKSB7CgkJCQlpZiAoa2V5ICE9PSAiZW51bSIpIHsKCQkJCQlub3JtU2NoZW1hKHNjaGVtYVtrZXldLCBiYXNlVXJpKTsKCQkJCX0KCQkJfQoJCX0KCX0KfQoKZnVuY3Rpb24gZGVmYXVsdEVycm9yUmVwb3J0ZXIobGFuZ3VhZ2UpIHsKCWxhbmd1YWdlID0gbGFuZ3VhZ2UgfHwgJ2VuJzsKCgl2YXIgZXJyb3JNZXNzYWdlcyA9IGxhbmd1YWdlc1tsYW5ndWFnZV07CgoJcmV0dXJuIGZ1bmN0aW9uIChlcnJvcikgewoJCXZhciBtZXNzYWdlVGVtcGxhdGUgPSBlcnJvck1lc3NhZ2VzW2Vycm9yLmNvZGVdIHx8IEVycm9yTWVzc2FnZXNEZWZhdWx0W2Vycm9yLmNvZGVdOwoJCWlmICh0eXBlb2YgbWVzc2FnZVRlbXBsYXRlICE9PSAnc3RyaW5nJykgewoJCQlyZXR1cm4gIlVua25vd24gZXJyb3IgY29kZSAiICsgZXJyb3IuY29kZSArICI6ICIgKyBKU09OLnN0cmluZ2lmeShlcnJvci5tZXNzYWdlUGFyYW1zKTsKCQl9CgkJdmFyIG1lc3NhZ2VQYXJhbXMgPSBlcnJvci5wYXJhbXM7CgkJLy8gQWRhcHRlZCBmcm9tIENyb2NrZm9yZCdzIHN1cHBsYW50KCkKCQlyZXR1cm4gbWVzc2FnZVRlbXBsYXRlLnJlcGxhY2UoL1x7KFtee31dKilcfS9nLCBmdW5jdGlvbiAod2hvbGUsIHZhck5hbWUpIHsKCQkJdmFyIHN1YlZhbHVlID0gbWVzc2FnZVBhcmFtc1t2YXJOYW1lXTsKCQkJcmV0dXJuIHR5cGVvZiBzdWJWYWx1ZSA9PT0gJ3N0cmluZycgfHwgdHlwZW9mIHN1YlZhbHVlID09PSAnbnVtYmVyJyA/IHN1YlZhbHVlIDogd2hvbGU7CgkJfSk7Cgl9Owp9Cgp2YXIgRXJyb3JDb2RlcyA9IHsKCUlOVkFMSURfVFlQRTogMCwKCUVOVU1fTUlTTUFUQ0g6IDEsCglBTllfT0ZfTUlTU0lORzogMTAsCglPTkVfT0ZfTUlTU0lORzogMTEsCglPTkVfT0ZfTVVMVElQTEU6IDEyLAoJTk9UX1BBU1NFRDogMTMsCgkvLyBOdW1lcmljIGVycm9ycwoJTlVNQkVSX01VTFRJUExFX09GOiAxMDAsCglOVU1CRVJfTUlOSU1VTTogMTAxLAoJTlVNQkVSX01JTklNVU1fRVhDTFVTSVZFOiAxMDIsCglOVU1CRVJfTUFYSU1VTTogMTAzLAoJTlVNQkVSX01BWElNVU1fRVhDTFVTSVZFOiAxMDQsCglOVU1CRVJfTk9UX0FfTlVNQkVSOiAxMDUsCgkvLyBTdHJpbmcgZXJyb3JzCglTVFJJTkdfTEVOR1RIX1NIT1JUOiAyMDAsCglTVFJJTkdfTEVOR1RIX0xPTkc6IDIwMSwKCVNUUklOR19QQVRURVJOOiAyMDIsCgkvLyBPYmplY3QgZXJyb3JzCglPQkpFQ1RfUFJPUEVSVElFU19NSU5JTVVNOiAzMDAsCglPQkpFQ1RfUFJPUEVSVElFU19NQVhJTVVNOiAzMDEsCglPQkpFQ1RfUkVRVUlSRUQ6IDMwMiwKCU9CSkVDVF9BRERJVElPTkFMX1BST1BFUlRJRVM6IDMwMywKCU9CSkVDVF9ERVBFTkRFTkNZX0tFWTogMzA0LAoJLy8gQXJyYXkgZXJyb3JzCglBUlJBWV9MRU5HVEhfU0hPUlQ6IDQwMCwKCUFSUkFZX0xFTkdUSF9MT05HOiA0MDEsCglBUlJBWV9VTklRVUU6IDQwMiwKCUFSUkFZX0FERElUSU9OQUxfSVRFTVM6IDQwMywKCS8vIEN1c3RvbS91c2VyLWRlZmluZWQgZXJyb3JzCglGT1JNQVRfQ1VTVE9NOiA1MDAsCglLRVlXT1JEX0NVU1RPTTogNTAxLAoJLy8gU2NoZW1hIHN0cnVjdHVyZQoJQ0lSQ1VMQVJfUkVGRVJFTkNFOiA2MDAsCgkvLyBOb24tc3RhbmRhcmQgdmFsaWRhdGlvbiBvcHRpb25zCglVTktOT1dOX1BST1BFUlRZOiAxMDAwCn07CnZhciBFcnJvckNvZGVMb29rdXAgPSB7fTsKZm9yICh2YXIga2V5IGluIEVycm9yQ29kZXMpIHsKCUVycm9yQ29kZUxvb2t1cFtFcnJvckNvZGVzW2tleV1dID0ga2V5Owp9CnZhciBFcnJvck1lc3NhZ2VzRGVmYXVsdCA9IHsKCUlOVkFMSURfVFlQRTogIkludmFsaWQgdHlwZToge3R5cGV9IChleHBlY3RlZCB7ZXhwZWN0ZWR9KSIsCglFTlVNX01JU01BVENIOiAiTm8gZW51bSBtYXRjaCBmb3I6IHt2YWx1ZX0iLAoJQU5ZX09GX01JU1NJTkc6ICJEYXRhIGRvZXMgbm90IG1hdGNoIGFueSBzY2hlbWFzIGZyb20gXCJhbnlPZlwiIiwKCU9ORV9PRl9NSVNTSU5HOiAiRGF0YSBkb2VzIG5vdCBtYXRjaCBhbnkgc2NoZW1hcyBmcm9tIFwib25lT2ZcIiIsCglPTkVfT0ZfTVVMVElQTEU6ICJEYXRhIGlzIHZhbGlkIGFnYWluc3QgbW9yZSB0aGFuIG9uZSBzY2hlbWEgZnJvbSBcIm9uZU9mXCI6IGluZGljZXMge2luZGV4MX0gYW5kIHtpbmRleDJ9IiwKCU5PVF9QQVNTRUQ6ICJEYXRhIG1hdGNoZXMgc2NoZW1hIGZyb20gXCJub3RcIiIsCgkvLyBOdW1lcmljIGVycm9ycwoJTlVNQkVSX01VTFRJUExFX09GOiAiVmFsdWUge3ZhbHVlfSBpcyBub3QgYSBtdWx0aXBsZSBvZiB7bXVsdGlwbGVPZn0iLAoJTlVNQkVSX01JTklNVU06ICJWYWx1ZSB7dmFsdWV9IGlzIGxlc3MgdGhhbiBtaW5pbXVtIHttaW5pbXVtfSIsCglOVU1CRVJfTUlOSU1VTV9FWENMVVNJVkU6ICJWYWx1ZSB7dmFsdWV9IGlzIGVxdWFsIHRvIGV4Y2x1c2l2ZSBtaW5pbXVtIHttaW5pbXVtfSIsCglOVU1CRVJfTUFYSU1VTTogIlZhbHVlIHt2YWx1ZX0gaXMgZ3JlYXRlciB0aGFuIG1heGltdW0ge21heGltdW19IiwKCU5VTUJFUl9NQVhJTVVNX0VYQ0xVU0lWRTogIlZhbHVlIHt2YWx1ZX0gaXMgZXF1YWwgdG8gZXhjbHVzaXZlIG1heGltdW0ge21heGltdW19IiwKCU5VTUJFUl9OT1RfQV9OVU1CRVI6ICJWYWx1ZSB7dmFsdWV9IGlzIG5vdCBhIHZhbGlkIG51bWJlciIsCgkvLyBTdHJpbmcgZXJyb3JzCglTVFJJTkdfTEVOR1RIX1NIT1JUOiAiU3RyaW5nIGlzIHRvbyBzaG9ydCAoe2xlbmd0aH0gY2hhcnMpLCBtaW5pbXVtIHttaW5pbXVtfSIsCglTVFJJTkdfTEVOR1RIX0xPTkc6ICJTdHJpbmcgaXMgdG9vIGxvbmcgKHtsZW5ndGh9IGNoYXJzKSwgbWF4aW11bSB7bWF4aW11bX0iLAoJU1RSSU5HX1BBVFRFUk46ICJTdHJpbmcgZG9lcyBub3QgbWF0Y2ggcGF0dGVybjoge3BhdHRlcm59IiwKCS8vIE9iamVjdCBlcnJvcnMKCU9CSkVDVF9QUk9QRVJUSUVTX01JTklNVU06ICJUb28gZmV3IHByb3BlcnRpZXMgZGVmaW5lZCAoe3Byb3BlcnR5Q291bnR9KSwgbWluaW11bSB7bWluaW11bX0iLAoJT0JKRUNUX1BST1BFUlRJRVNfTUFYSU1VTTogIlRvbyBtYW55IHByb3BlcnRpZXMgZGVmaW5lZCAoe3Byb3BlcnR5Q291bnR9KSwgbWF4aW11bSB7bWF4aW11bX0iLAoJT0JKRUNUX1JFUVVJUkVEOiAiTWlzc2luZyByZXF1aXJlZCBwcm9wZXJ0eToge2tleX0iLAoJT0JKRUNUX0FERElUSU9OQUxfUFJPUEVSVElFUzogIkFkZGl0aW9uYWwgcHJvcGVydGllcyBub3QgYWxsb3dlZCIsCglPQkpFQ1RfREVQRU5ERU5DWV9LRVk6ICJEZXBlbmRlbmN5IGZhaWxlZCAtIGtleSBtdXN0IGV4aXN0OiB7bWlzc2luZ30gKGR1ZSB0byBrZXk6IHtrZXl9KSIsCgkvLyBBcnJheSBlcnJvcnMKCUFSUkFZX0xFTkdUSF9TSE9SVDogIkFycmF5IGlzIHRvbyBzaG9ydCAoe2xlbmd0aH0pLCBtaW5pbXVtIHttaW5pbXVtfSIsCglBUlJBWV9MRU5HVEhfTE9ORzogIkFycmF5IGlzIHRvbyBsb25nICh7bGVuZ3RofSksIG1heGltdW0ge21heGltdW19IiwKCUFSUkFZX1VOSVFVRTogIkFycmF5IGl0ZW1zIGFyZSBub3QgdW5pcXVlIChpbmRpY2VzIHttYXRjaDF9IGFuZCB7bWF0Y2gyfSkiLAoJQVJSQVlfQURESVRJT05BTF9JVEVNUzogIkFkZGl0aW9uYWwgaXRlbXMgbm90IGFsbG93ZWQiLAoJLy8gRm9ybWF0IGVycm9ycwoJRk9STUFUX0NVU1RPTTogIkZvcm1hdCB2YWxpZGF0aW9uIGZhaWxlZCAoe21lc3NhZ2V9KSIsCglLRVlXT1JEX0NVU1RPTTogIktleXdvcmQgZmFpbGVkOiB7a2V5fSAoe21lc3NhZ2V9KSIsCgkvLyBTY2hlbWEgc3RydWN0dXJlCglDSVJDVUxBUl9SRUZFUkVOQ0U6ICJDaXJjdWxhciAkcmVmczoge3VybHN9IiwKCS8vIE5vbi1zdGFuZGFyZCB2YWxpZGF0aW9uIG9wdGlvbnMKCVVOS05PV05fUFJPUEVSVFk6ICJVbmtub3duIHByb3BlcnR5IChub3QgaW4gc2NoZW1hKSIKfTsKCmZ1bmN0aW9uIFZhbGlkYXRpb25FcnJvcihjb2RlLCBwYXJhbXMsIGRhdGFQYXRoLCBzY2hlbWFQYXRoLCBzdWJFcnJvcnMpIHsKCUVycm9yLmNhbGwodGhpcyk7CglpZiAoY29kZSA9PT0gdW5kZWZpbmVkKSB7CgkJdGhyb3cgbmV3IEVycm9yICgiTm8gZXJyb3IgY29kZSBzdXBwbGllZDogIiArIHNjaGVtYVBhdGgpOwoJfQoJdGhpcy5tZXNzYWdlID0gJyc7Cgl0aGlzLnBhcmFtcyA9IHBhcmFtczsKCXRoaXMuY29kZSA9IGNvZGU7Cgl0aGlzLmRhdGFQYXRoID0gZGF0YVBhdGggfHwgIiI7Cgl0aGlzLnNjaGVtYVBhdGggPSBzY2hlbWFQYXRoIHx8ICIiOwoJdGhpcy5zdWJFcnJvcnMgPSBzdWJFcnJvcnMgfHwgbnVsbDsKCgl2YXIgZXJyID0gbmV3IEVycm9yKHRoaXMubWVzc2FnZSk7Cgl0aGlzLnN0YWNrID0gZXJyLnN0YWNrIHx8IGVyci5zdGFja3RyYWNlOwoJaWYgKCF0aGlzLnN0YWNrKSB7CgkJdHJ5IHsKCQkJdGhyb3cgZXJyOwoJCX0KCQljYXRjaChlcnIpIHsKCQkJdGhpcy5zdGFjayA9IGVyci5zdGFjayB8fCBlcnIuc3RhY2t0cmFjZTsKCQl9Cgl9Cn0KVmFsaWRhdGlvbkVycm9yLnByb3RvdHlwZSA9IE9iamVjdC5jcmVhdGUoRXJyb3IucHJvdG90eXBlKTsKVmFsaWRhdGlvbkVycm9yLnByb3RvdHlwZS5jb25zdHJ1Y3RvciA9IFZhbGlkYXRpb25FcnJvcjsKVmFsaWRhdGlvbkVycm9yLnByb3RvdHlwZS5uYW1lID0gJ1ZhbGlkYXRpb25FcnJvcic7CgpWYWxpZGF0aW9uRXJyb3IucHJvdG90eXBlLnByZWZpeFdpdGggPSBmdW5jdGlvbiAoZGF0YVByZWZpeCwgc2NoZW1hUHJlZml4KSB7CglpZiAoZGF0YVByZWZpeCAhPT0gbnVsbCkgewoJCWRhdGFQcmVmaXggPSBkYXRhUHJlZml4LnJlcGxhY2UoL34vZywgIn4wIikucmVwbGFjZSgvXC8vZywgIn4xIik7CgkJdGhpcy5kYXRhUGF0aCA9ICIvIiArIGRhdGFQcmVmaXggKyB0aGlzLmRhdGFQYXRoOwoJfQoJaWYgKHNjaGVtYVByZWZpeCAhPT0gbnVsbCkgewoJCXNjaGVtYVByZWZpeCA9IHNjaGVtYVByZWZpeC5yZXBsYWNlKC9+L2csICJ+MCIpLnJlcGxhY2UoL1wvL2csICJ+MSIpOwoJCXRoaXMuc2NoZW1hUGF0aCA9ICIvIiArIHNjaGVtYVByZWZpeCArIHRoaXMuc2NoZW1hUGF0aDsKCX0KCWlmICh0aGlzLnN1YkVycm9ycyAhPT0gbnVsbCkgewoJCWZvciAodmFyIGkgPSAwOyBpIDwgdGhpcy5zdWJFcnJvcnMubGVuZ3RoOyBpKyspIHsKCQkJdGhpcy5zdWJFcnJvcnNbaV0ucHJlZml4V2l0aChkYXRhUHJlZml4LCBzY2hlbWFQcmVmaXgpOwoJCX0KCX0KCXJldHVybiB0aGlzOwp9OwoKZnVuY3Rpb24gaXNUcnVzdGVkVXJsKGJhc2VVcmwsIHRlc3RVcmwpIHsKCWlmKHRlc3RVcmwuc3Vic3RyaW5nKDAsIGJhc2VVcmwubGVuZ3RoKSA9PT0gYmFzZVVybCl7CgkJdmFyIHJlbWFpbmRlciA9IHRlc3RVcmwuc3Vic3RyaW5nKGJhc2VVcmwubGVuZ3RoKTsKCQlpZiAoKHRlc3RVcmwubGVuZ3RoID4gMCAmJiB0ZXN0VXJsLmNoYXJBdChiYXNlVXJsLmxlbmd0aCAtIDEpID09PSAiLyIpCgkJCXx8IHJlbWFpbmRlci5jaGFyQXQoMCkgPT09ICIjIgoJCQl8fCByZW1haW5kZXIuY2hhckF0KDApID09PSAiPyIpIHsKCQkJcmV0dXJuIHRydWU7CgkJfQoJfQoJcmV0dXJuIGZhbHNlOwp9Cgp2YXIgbGFuZ3VhZ2VzID0ge307CmZ1bmN0aW9uIGNyZWF0ZUFwaShsYW5ndWFnZSkgewoJdmFyIGdsb2JhbENvbnRleHQgPSBuZXcgVmFsaWRhdG9yQ29udGV4dCgpOwoJdmFyIGN1cnJlbnRMYW5ndWFnZTsKCXZhciBjdXN0b21FcnJvclJlcG9ydGVyOwoJdmFyIGFwaSA9IHsKCQlzZXRFcnJvclJlcG9ydGVyOiBmdW5jdGlvbiAocmVwb3J0ZXIpIHsKCQkJaWYgKHR5cGVvZiByZXBvcnRlciA9PT0gJ3N0cmluZycpIHsKCQkJCXJldHVybiB0aGlzLmxhbmd1YWdlKHJlcG9ydGVyKTsKCQkJfQoJCQljdXN0b21FcnJvclJlcG9ydGVyID0gcmVwb3J0ZXI7CgkJCXJldHVybiB0cnVlOwoJCX0sCgkJYWRkRm9ybWF0OiBmdW5jdGlvbiAoKSB7CgkJCWdsb2JhbENvbnRleHQuYWRkRm9ybWF0LmFwcGx5KGdsb2JhbENvbnRleHQsIGFyZ3VtZW50cyk7CgkJfSwKCQlsYW5ndWFnZTogZnVuY3Rpb24gKGNvZGUpIHsKCQkJaWYgKCFjb2RlKSB7CgkJCQlyZXR1cm4gY3VycmVudExhbmd1YWdlOwoJCQl9CgkJCWlmICghbGFuZ3VhZ2VzW2NvZGVdKSB7CgkJCQljb2RlID0gY29kZS5zcGxpdCgnLScpWzBdOyAvLyBmYWxsIGJhY2sgdG8gYmFzZSBsYW5ndWFnZQoJCQl9CgkJCWlmIChsYW5ndWFnZXNbY29kZV0pIHsKCQkJCWN1cnJlbnRMYW5ndWFnZSA9IGNvZGU7CgkJCQlyZXR1cm4gY29kZTsgLy8gc28geW91IGNhbiB0ZWxsIGlmIGZhbGwtYmFjayBoYXMgaGFwcGVuZWQKCQkJfQoJCQlyZXR1cm4gZmFsc2U7CgkJfSwKCQlhZGRMYW5ndWFnZTogZnVuY3Rpb24gKGNvZGUsIG1lc3NhZ2VNYXApIHsKCQkJdmFyIGtleTsKCQkJZm9yIChrZXkgaW4gRXJyb3JDb2RlcykgewoJCQkJaWYgKG1lc3NhZ2VNYXBba2V5XSAmJiAhbWVzc2FnZU1hcFtFcnJvckNvZGVzW2tleV1dKSB7CgkJCQkJbWVzc2FnZU1hcFtFcnJvckNvZGVzW2tleV1dID0gbWVzc2FnZU1hcFtrZXldOwoJCQkJfQoJCQl9CgkJCXZhciByb290Q29kZSA9IGNvZGUuc3BsaXQoJy0nKVswXTsKCQkJaWYgKCFsYW5ndWFnZXNbcm9vdENvZGVdKSB7IC8vIHVzZSBmb3IgYmFzZSBsYW5ndWFnZSBpZiBub3QgeWV0IGRlZmluZWQKCQkJCWxhbmd1YWdlc1tjb2RlXSA9IG1lc3NhZ2VNYXA7CgkJCQlsYW5ndWFnZXNbcm9vdENvZGVdID0gbWVzc2FnZU1hcDsKCQkJfSBlbHNlIHsKCQkJCWxhbmd1YWdlc1tjb2RlXSA9IE9iamVjdC5jcmVhdGUobGFuZ3VhZ2VzW3Jvb3RDb2RlXSk7CgkJCQlmb3IgKGtleSBpbiBtZXNzYWdlTWFwKSB7CgkJCQkJaWYgKHR5cGVvZiBsYW5ndWFnZXNbcm9vdENvZGVdW2tleV0gPT09ICd1bmRlZmluZWQnKSB7CgkJCQkJCWxhbmd1YWdlc1tyb290Q29kZV1ba2V5XSA9IG1lc3NhZ2VNYXBba2V5XTsKCQkJCQl9CgkJCQkJbGFuZ3VhZ2VzW2NvZGVdW2tleV0gPSBtZXNzYWdlTWFwW2tleV07CgkJCQl9CgkJCX0KCQkJcmV0dXJuIHRoaXM7CgkJfSwKCQlmcmVzaEFwaTogZnVuY3Rpb24gKGxhbmd1YWdlKSB7CgkJCXZhciByZXN1bHQgPSBjcmVhdGVBcGkoKTsKCQkJaWYgKGxhbmd1YWdlKSB7CgkJCQlyZXN1bHQubGFuZ3VhZ2UobGFuZ3VhZ2UpOwoJCQl9CgkJCXJldHVybiByZXN1bHQ7CgkJfSwKCQl2YWxpZGF0ZTogZnVuY3Rpb24gKGRhdGEsIHNjaGVtYSwgY2hlY2tSZWN1cnNpdmUsIGJhblVua25vd25Qcm9wZXJ0aWVzKSB7CgkJCXZhciBkZWYgPSBkZWZhdWx0RXJyb3JSZXBvcnRlcihjdXJyZW50TGFuZ3VhZ2UpOwoJCQl2YXIgZXJyb3JSZXBvcnRlciA9IGN1c3RvbUVycm9yUmVwb3J0ZXIgPyBmdW5jdGlvbiAoZXJyb3IsIGRhdGEsIHNjaGVtYSkgewoJCQkJcmV0dXJuIGN1c3RvbUVycm9yUmVwb3J0ZXIoZXJyb3IsIGRhdGEsIHNjaGVtYSkgfHwgZGVmKGVycm9yLCBkYXRhLCBzY2hlbWEpOwoJCQl9IDogZGVmOwoJCQl2YXIgY29udGV4dCA9IG5ldyBWYWxpZGF0b3JDb250ZXh0KGdsb2JhbENvbnRleHQsIGZhbHNlLCBlcnJvclJlcG9ydGVyLCBjaGVja1JlY3Vyc2l2ZSwgYmFuVW5rbm93blByb3BlcnRpZXMpOwoJCQlpZiAodHlwZW9mIHNjaGVtYSA9PT0gInN0cmluZyIpIHsKCQkJCXNjaGVtYSA9IHsiJHJlZiI6IHNjaGVtYX07CgkJCX0KCQkJY29udGV4dC5hZGRTY2hlbWEoIiIsIHNjaGVtYSk7CgkJCXZhciBlcnJvciA9IGNvbnRleHQudmFsaWRhdGVBbGwoZGF0YSwgc2NoZW1hLCBudWxsLCBudWxsLCAiIik7CgkJCWlmICghZXJyb3IgJiYgYmFuVW5rbm93blByb3BlcnRpZXMpIHsKCQkJCWVycm9yID0gY29udGV4dC5iYW5Vbmtub3duUHJvcGVydGllcyhkYXRhLCBzY2hlbWEpOwoJCQl9CgkJCXRoaXMuZXJyb3IgPSBlcnJvcjsKCQkJdGhpcy5taXNzaW5nID0gY29udGV4dC5taXNzaW5nOwoJCQl0aGlzLnZhbGlkID0gKGVycm9yID09PSBudWxsKTsKCQkJcmV0dXJuIHRoaXMudmFsaWQ7CgkJfSwKCQl2YWxpZGF0ZVJlc3VsdDogZnVuY3Rpb24gKCkgewoJCQl2YXIgcmVzdWx0ID0ge307CgkJCXRoaXMudmFsaWRhdGUuYXBwbHkocmVzdWx0LCBhcmd1bWVudHMpOwoJCQlyZXR1cm4gcmVzdWx0OwoJCX0sCgkJdmFsaWRhdGVNdWx0aXBsZTogZnVuY3Rpb24gKGRhdGEsIHNjaGVtYSwgY2hlY2tSZWN1cnNpdmUsIGJhblVua25vd25Qcm9wZXJ0aWVzKSB7CgkJCXZhciBkZWYgPSBkZWZhdWx0RXJyb3JSZXBvcnRlcihjdXJyZW50TGFuZ3VhZ2UpOwoJCQl2YXIgZXJyb3JSZXBvcnRlciA9IGN1c3RvbUVycm9yUmVwb3J0ZXIgPyBmdW5jdGlvbiAoZXJyb3IsIGRhdGEsIHNjaGVtYSkgewoJCQkJcmV0dXJuIGN1c3RvbUVycm9yUmVwb3J0ZXIoZXJyb3IsIGRhdGEsIHNjaGVtYSkgfHwgZGVmKGVycm9yLCBkYXRhLCBzY2hlbWEpOwoJCQl9IDogZGVmOwoJCQl2YXIgY29udGV4dCA9IG5ldyBWYWxpZGF0b3JDb250ZXh0KGdsb2JhbENvbnRleHQsIHRydWUsIGVycm9yUmVwb3J0ZXIsIGNoZWNrUmVjdXJzaXZlLCBiYW5Vbmtub3duUHJvcGVydGllcyk7CgkJCWlmICh0eXBlb2Ygc2NoZW1hID09PSAic3RyaW5nIikgewoJCQkJc2NoZW1hID0geyIkcmVmIjogc2NoZW1hfTsKCQkJfQoJCQljb250ZXh0LmFkZFNjaGVtYSgiIiwgc2NoZW1hKTsKCQkJY29udGV4dC52YWxpZGF0ZUFsbChkYXRhLCBzY2hlbWEsIG51bGwsIG51bGwsICIiKTsKCQkJaWYgKGJhblVua25vd25Qcm9wZXJ0aWVzKSB7CgkJCQljb250ZXh0LmJhblVua25vd25Qcm9wZXJ0aWVzKGRhdGEsIHNjaGVtYSk7CgkJCX0KCQkJdmFyIHJlc3VsdCA9IHt9OwoJCQlyZXN1bHQuZXJyb3JzID0gY29udGV4dC5lcnJvcnM7CgkJCXJlc3VsdC5taXNzaW5nID0gY29udGV4dC5taXNzaW5nOwoJCQlyZXN1bHQudmFsaWQgPSAocmVzdWx0LmVycm9ycy5sZW5ndGggPT09IDApOwoJCQlyZXR1cm4gcmVzdWx0OwoJCX0sCgkJYWRkU2NoZW1hOiBmdW5jdGlvbiAoKSB7CgkJCXJldHVybiBnbG9iYWxDb250ZXh0LmFkZFNjaGVtYS5hcHBseShnbG9iYWxDb250ZXh0LCBhcmd1bWVudHMpOwoJCX0sCgkJZ2V0U2NoZW1hOiBmdW5jdGlvbiAoKSB7CgkJCXJldHVybiBnbG9iYWxDb250ZXh0LmdldFNjaGVtYS5hcHBseShnbG9iYWxDb250ZXh0LCBhcmd1bWVudHMpOwoJCX0sCgkJZ2V0U2NoZW1hTWFwOiBmdW5jdGlvbiAoKSB7CgkJCXJldHVybiBnbG9iYWxDb250ZXh0LmdldFNjaGVtYU1hcC5hcHBseShnbG9iYWxDb250ZXh0LCBhcmd1bWVudHMpOwoJCX0sCgkJZ2V0U2NoZW1hVXJpczogZnVuY3Rpb24gKCkgewoJCQlyZXR1cm4gZ2xvYmFsQ29udGV4dC5nZXRTY2hlbWFVcmlzLmFwcGx5KGdsb2JhbENvbnRleHQsIGFyZ3VtZW50cyk7CgkJfSwKCQlnZXRNaXNzaW5nVXJpczogZnVuY3Rpb24gKCkgewoJCQlyZXR1cm4gZ2xvYmFsQ29udGV4dC5nZXRNaXNzaW5nVXJpcy5hcHBseShnbG9iYWxDb250ZXh0LCBhcmd1bWVudHMpOwoJCX0sCgkJZHJvcFNjaGVtYXM6IGZ1bmN0aW9uICgpIHsKCQkJZ2xvYmFsQ29udGV4dC5kcm9wU2NoZW1hcy5hcHBseShnbG9iYWxDb250ZXh0LCBhcmd1bWVudHMpOwoJCX0sCgkJZGVmaW5lS2V5d29yZDogZnVuY3Rpb24gKCkgewoJCQlnbG9iYWxDb250ZXh0LmRlZmluZUtleXdvcmQuYXBwbHkoZ2xvYmFsQ29udGV4dCwgYXJndW1lbnRzKTsKCQl9LAoJCWRlZmluZUVycm9yOiBmdW5jdGlvbiAoY29kZU5hbWUsIGNvZGVOdW1iZXIsIGRlZmF1bHRNZXNzYWdlKSB7CgkJCWlmICh0eXBlb2YgY29kZU5hbWUgIT09ICdzdHJpbmcnIHx8ICEvXltBLVpdKyhfW0EtWl0rKSokLy50ZXN0KGNvZGVOYW1lKSkgewoJCQkJdGhyb3cgbmV3IEVycm9yKCdDb2RlIG5hbWUgbXVzdCBiZSBhIHN0cmluZyBpbiBVUFBFUl9DQVNFX1dJVEhfVU5ERVJTQ09SRVMnKTsKCQkJfQoJCQlpZiAodHlwZW9mIGNvZGVOdW1iZXIgIT09ICdudW1iZXInIHx8IGNvZGVOdW1iZXIlMSAhPT0gMCB8fCBjb2RlTnVtYmVyIDwgMTAwMDApIHsKCQkJCXRocm93IG5ldyBFcnJvcignQ29kZSBudW1iZXIgbXVzdCBiZSBhbiBpbnRlZ2VyID4gMTAwMDAnKTsKCQkJfQoJCQlpZiAodHlwZW9mIEVycm9yQ29kZXNbY29kZU5hbWVdICE9PSAndW5kZWZpbmVkJykgewoJCQkJdGhyb3cgbmV3IEVycm9yKCdFcnJvciBhbHJlYWR5IGRlZmluZWQ6ICcgKyBjb2RlTmFtZSArICcgYXMgJyArIEVycm9yQ29kZXNbY29kZU5hbWVdKTsKCQkJfQoJCQlpZiAodHlwZW9mIEVycm9yQ29kZUxvb2t1cFtjb2RlTnVtYmVyXSAhPT0gJ3VuZGVmaW5lZCcpIHsKCQkJCXRocm93IG5ldyBFcnJvcignRXJyb3IgY29kZSBhbHJlYWR5IHVzZWQ6ICcgKyBFcnJvckNvZGVMb29rdXBbY29kZU51bWJlcl0gKyAnIGFzICcgKyBjb2RlTnVtYmVyKTsKCQkJfQoJCQlFcnJvckNvZGVzW2NvZGVOYW1lXSA9IGNvZGVOdW1iZXI7CgkJCUVycm9yQ29kZUxvb2t1cFtjb2RlTnVtYmVyXSA9IGNvZGVOYW1lOwoJCQlFcnJvck1lc3NhZ2VzRGVmYXVsdFtjb2RlTmFtZV0gPSBFcnJvck1lc3NhZ2VzRGVmYXVsdFtjb2RlTnVtYmVyXSA9IGRlZmF1bHRNZXNzYWdlOwoJCQlmb3IgKHZhciBsYW5nQ29kZSBpbiBsYW5ndWFnZXMpIHsKCQkJCXZhciBsYW5ndWFnZSA9IGxhbmd1YWdlc1tsYW5nQ29kZV07CgkJCQlpZiAobGFuZ3VhZ2VbY29kZU5hbWVdKSB7CgkJCQkJbGFuZ3VhZ2VbY29kZU51bWJlcl0gPSBsYW5ndWFnZVtjb2RlTnVtYmVyXSB8fCBsYW5ndWFnZVtjb2RlTmFtZV07CgkJCQl9CgkJCX0KCQl9LAoJCXJlc2V0OiBmdW5jdGlvbiAoKSB7CgkJCWdsb2JhbENvbnRleHQucmVzZXQoKTsKCQkJdGhpcy5lcnJvciA9IG51bGw7CgkJCXRoaXMubWlzc2luZyA9IFtdOwoJCQl0aGlzLnZhbGlkID0gdHJ1ZTsKCQl9LAoJCW1pc3Npbmc6IFtdLAoJCWVycm9yOiBudWxsLAoJCXZhbGlkOiB0cnVlLAoJCW5vcm1TY2hlbWE6IG5vcm1TY2hlbWEsCgkJcmVzb2x2ZVVybDogcmVzb2x2ZVVybCwKCQlnZXREb2N1bWVudFVyaTogZ2V0RG9jdW1lbnRVcmksCgkJZXJyb3JDb2RlczogRXJyb3JDb2RlcwoJfTsKCWFwaS5sYW5ndWFnZShsYW5ndWFnZSB8fCAnZW4nKTsKCXJldHVybiBhcGk7Cn0KCnZhciB0djQgPSBjcmVhdGVBcGkoKTsKdHY0LmFkZExhbmd1YWdlKCdlbi1nYicsIEVycm9yTWVzc2FnZXNEZWZhdWx0KTsKCi8vbGVnYWN5IHByb3BlcnR5CnR2NC50djQgPSB0djQ7CgpyZXR1cm4gdHY0OyAvLyB1c2VkIGJ5IF9oZWFkZXIuanMgdG8gZ2xvYmFsaXNlLgoKfSkpOwp9LHt9XSwyOltmdW5jdGlvbihyZXF1aXJlLG1vZHVsZSxleHBvcnRzKXsKLyoKICogIENvcHlyaWdodCAoYykgMjAxNCBUaGUgV2ViUlRDIHByb2plY3QgYXV0aG9ycy4gQWxsIFJpZ2h0cyBSZXNlcnZlZC4KICoKICogIFVzZSBvZiB0aGlzIHNvdXJjZSBjb2RlIGlzIGdvdmVybmVkIGJ5IGEgQlNELXN0eWxlIGxpY2Vuc2UKICogIHRoYXQgY2FuIGJlIGZvdW5kIGluIHRoZSBMSUNFTlNFIGZpbGUgaW4gdGhlIHJvb3Qgb2YgdGhlIHNvdXJjZQogKiAgdHJlZS4KICovCgovKiBNb3JlIGluZm9ybWF0aW9uIGFib3V0IHRoZXNlIG9wdGlvbnMgYXQganNoaW50LmNvbS9kb2NzL29wdGlvbnMgKi8KLyoganNoaW50IGJyb3dzZXI6IHRydWUsIGNhbWVsY2FzZTogdHJ1ZSwgY3VybHk6IHRydWUsIGRldmVsOiB0cnVlLAogICBlcWVxZXE6IHRydWUsIGZvcmluOiBmYWxzZSwgZ2xvYmFsc3RyaWN0OiB0cnVlLCBub2RlOiB0cnVlLAogICBxdW90bWFyazogc2luZ2xlLCB1bmRlZjogdHJ1ZSwgdW51c2VkOiBzdHJpY3QgKi8KLyogZ2xvYmFsIG1velJUQ0ljZUNhbmRpZGF0ZSwgbW96UlRDUGVlckNvbm5lY3Rpb24sIFByb21pc2UsCm1velJUQ1Nlc3Npb25EZXNjcmlwdGlvbiwgd2Via2l0UlRDUGVlckNvbm5lY3Rpb24sIE1lZGlhU3RyZWFtVHJhY2sgKi8KLyogZXhwb3J0ZWQgdHJhY2UscmVxdWVzdFVzZXJNZWRpYSAqLwoKJ3VzZSBzdHJpY3QnOwoKdmFyIGdldFVzZXJNZWRpYSA9IG51bGw7CnZhciBhdHRhY2hNZWRpYVN0cmVhbSA9IG51bGw7CnZhciByZWF0dGFjaE1lZGlhU3RyZWFtID0gbnVsbDsKdmFyIHdlYnJ0Y0RldGVjdGVkQnJvd3NlciA9IG51bGw7CnZhciB3ZWJydGNEZXRlY3RlZFZlcnNpb24gPSBudWxsOwp2YXIgd2VicnRjTWluaW11bVZlcnNpb24gPSBudWxsOwp2YXIgd2VicnRjVXRpbHMgPSB7CiAgbG9nOiBmdW5jdGlvbigpIHsKICAgIC8vIHN1cHByZXNzIGNvbnNvbGUubG9nIG91dHB1dCB3aGVuIGJlaW5nIGluY2x1ZGVkIGFzIGEgbW9kdWxlLgogICAgaWYgKHR5cGVvZiBtb2R1bGUgIT09ICd1bmRlZmluZWQnIHx8CiAgICAgICAgdHlwZW9mIHJlcXVpcmUgPT09ICdmdW5jdGlvbicgJiYgdHlwZW9mIGRlZmluZSA9PT0gJ2Z1bmN0aW9uJykgewogICAgICByZXR1cm47CiAgICB9CiAgICBjb25zb2xlLmxvZy5hcHBseShjb25zb2xlLCBhcmd1bWVudHMpOwogIH0sCiAgZXh0cmFjdFZlcnNpb246IGZ1bmN0aW9uKHVhc3RyaW5nLCBleHByLCBwb3MpIHsKICAgIHZhciBtYXRjaCA9IHVhc3RyaW5nLm1hdGNoKGV4cHIpOwogICAgcmV0dXJuIG1hdGNoICYmIG1hdGNoLmxlbmd0aCA+PSBwb3MgJiYgcGFyc2VJbnQobWF0Y2hbcG9zXSk7CiAgfQp9OwoKZnVuY3Rpb24gdHJhY2UodGV4dCkgewogIC8vIFRoaXMgZnVuY3Rpb24gaXMgdXNlZCBmb3IgbG9nZ2luZy4KICBpZiAodGV4dFt0ZXh0Lmxlbmd0aCAtIDFdID09PSAnXG4nKSB7CiAgICB0ZXh0ID0gdGV4dC5zdWJzdHJpbmcoMCwgdGV4dC5sZW5ndGggLSAxKTsKICB9CiAgaWYgKHdpbmRvdy5wZXJmb3JtYW5jZSkgewogICAgdmFyIG5vdyA9ICh3aW5kb3cucGVyZm9ybWFuY2Uubm93KCkgLyAxMDAwKS50b0ZpeGVkKDMpOwogICAgd2VicnRjVXRpbHMubG9nKG5vdyArICc6ICcgKyB0ZXh0KTsKICB9IGVsc2UgewogICAgd2VicnRjVXRpbHMubG9nKHRleHQpOwogIH0KfQoKaWYgKHR5cGVvZiB3aW5kb3cgPT09ICdvYmplY3QnKSB7CiAgaWYgKHdpbmRvdy5IVE1MTWVkaWFFbGVtZW50ICYmCiAgICAhKCdzcmNPYmplY3QnIGluIHdpbmRvdy5IVE1MTWVkaWFFbGVtZW50LnByb3RvdHlwZSkpIHsKICAgIC8vIFNoaW0gdGhlIHNyY09iamVjdCBwcm9wZXJ0eSwgb25jZSwgd2hlbiBIVE1MTWVkaWFFbGVtZW50IGlzIGZvdW5kLgogICAgT2JqZWN0LmRlZmluZVByb3BlcnR5KHdpbmRvdy5IVE1MTWVkaWFFbGVtZW50LnByb3RvdHlwZSwgJ3NyY09iamVjdCcsIHsKICAgICAgZ2V0OiBmdW5jdGlvbigpIHsKICAgICAgICAvLyBJZiBwcmVmaXhlZCBzcmNPYmplY3QgcHJvcGVydHkgZXhpc3RzLCByZXR1cm4gaXQuCiAgICAgICAgLy8gT3RoZXJ3aXNlIHVzZSB0aGUgc2hpbW1lZCBwcm9wZXJ0eSwgX3NyY09iamVjdAogICAgICAgIHJldHVybiAnbW96U3JjT2JqZWN0JyBpbiB0aGlzID8gdGhpcy5tb3pTcmNPYmplY3QgOiB0aGlzLl9zcmNPYmplY3Q7CiAgICAgIH0sCiAgICAgIHNldDogZnVuY3Rpb24oc3RyZWFtKSB7CiAgICAgICAgaWYgKCdtb3pTcmNPYmplY3QnIGluIHRoaXMpIHsKICAgICAgICAgIHRoaXMubW96U3JjT2JqZWN0ID0gc3RyZWFtOwogICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAvLyBVc2UgX3NyY09iamVjdCBhcyBhIHByaXZhdGUgcHJvcGVydHkgZm9yIHRoaXMgc2hpbQogICAgICAgICAgdGhpcy5fc3JjT2JqZWN0ID0gc3RyZWFtOwogICAgICAgICAgLy8gVE9ETzogcmV2b2tlT2JqZWN0VXJsKHRoaXMuc3JjKSB3aGVuICFzdHJlYW0gdG8gcmVsZWFzZSByZXNvdXJjZXM/CiAgICAgICAgICB0aGlzLnNyYyA9IFVSTC5jcmVhdGVPYmplY3RVUkwoc3RyZWFtKTsKICAgICAgICB9CiAgICAgIH0KICAgIH0pOwogIH0KICAvLyBQcm94eSBleGlzdGluZyBnbG9iYWxzCiAgZ2V0VXNlck1lZGlhID0gd2luZG93Lm5hdmlnYXRvciAmJiB3aW5kb3cubmF2aWdhdG9yLmdldFVzZXJNZWRpYTsKfQoKLy8gQXR0YWNoIGEgbWVkaWEgc3RyZWFtIHRvIGFuIGVsZW1lbnQuCmF0dGFjaE1lZGlhU3RyZWFtID0gZnVuY3Rpb24oZWxlbWVudCwgc3RyZWFtKSB7CiAgZWxlbWVudC5zcmNPYmplY3QgPSBzdHJlYW07Cn07CgpyZWF0dGFjaE1lZGlhU3RyZWFtID0gZnVuY3Rpb24odG8sIGZyb20pIHsKICB0by5zcmNPYmplY3QgPSBmcm9tLnNyY09iamVjdDsKfTsKCmlmICh0eXBlb2Ygd2luZG93ID09PSAndW5kZWZpbmVkJyB8fCAhd2luZG93Lm5hdmlnYXRvcikgewogIHdlYnJ0Y1V0aWxzLmxvZygnVGhpcyBkb2VzIG5vdCBhcHBlYXIgdG8gYmUgYSBicm93c2VyJyk7CiAgd2VicnRjRGV0ZWN0ZWRCcm93c2VyID0gJ25vdCBhIGJyb3dzZXInOwp9IGVsc2UgaWYgKG5hdmlnYXRvci5tb3pHZXRVc2VyTWVkaWEgJiYgd2luZG93Lm1velJUQ1BlZXJDb25uZWN0aW9uKSB7CiAgd2VicnRjVXRpbHMubG9nKCdUaGlzIGFwcGVhcnMgdG8gYmUgRmlyZWZveCcpOwoKICB3ZWJydGNEZXRlY3RlZEJyb3dzZXIgPSAnZmlyZWZveCc7CgogIC8vIHRoZSBkZXRlY3RlZCBmaXJlZm94IHZlcnNpb24uCiAgd2VicnRjRGV0ZWN0ZWRWZXJzaW9uID0gd2VicnRjVXRpbHMuZXh0cmFjdFZlcnNpb24obmF2aWdhdG9yLnVzZXJBZ2VudCwKICAgICAgL0ZpcmVmb3hcLyhbMC05XSspXC4vLCAxKTsKCiAgLy8gdGhlIG1pbmltdW0gZmlyZWZveCB2ZXJzaW9uIHN0aWxsIHN1cHBvcnRlZCBieSBhZGFwdGVyLgogIHdlYnJ0Y01pbmltdW1WZXJzaW9uID0gMzE7CgogIC8vIFRoZSBSVENQZWVyQ29ubmVjdGlvbiBvYmplY3QuCiAgd2luZG93LlJUQ1BlZXJDb25uZWN0aW9uID0gZnVuY3Rpb24ocGNDb25maWcsIHBjQ29uc3RyYWludHMpIHsKICAgIGlmICh3ZWJydGNEZXRlY3RlZFZlcnNpb24gPCAzOCkgewogICAgICAvLyAudXJscyBpcyBub3Qgc3VwcG9ydGVkIGluIEZGIDwgMzguCiAgICAgIC8vIGNyZWF0ZSBSVENJY2VTZXJ2ZXJzIHdpdGggYSBzaW5nbGUgdXJsLgogICAgICBpZiAocGNDb25maWcgJiYgcGNDb25maWcuaWNlU2VydmVycykgewogICAgICAgIHZhciBuZXdJY2VTZXJ2ZXJzID0gW107CiAgICAgICAgZm9yICh2YXIgaSA9IDA7IGkgPCBwY0NvbmZpZy5pY2VTZXJ2ZXJzLmxlbmd0aDsgaSsrKSB7CiAgICAgICAgICB2YXIgc2VydmVyID0gcGNDb25maWcuaWNlU2VydmVyc1tpXTsKICAgICAgICAgIGlmIChzZXJ2ZXIuaGFzT3duUHJvcGVydHkoJ3VybHMnKSkgewogICAgICAgICAgICBmb3IgKHZhciBqID0gMDsgaiA8IHNlcnZlci51cmxzLmxlbmd0aDsgaisrKSB7CiAgICAgICAgICAgICAgdmFyIG5ld1NlcnZlciA9IHsKICAgICAgICAgICAgICAgIHVybDogc2VydmVyLnVybHNbal0KICAgICAgICAgICAgICB9OwogICAgICAgICAgICAgIGlmIChzZXJ2ZXIudXJsc1tqXS5pbmRleE9mKCd0dXJuJykgPT09IDApIHsKICAgICAgICAgICAgICAgIG5ld1NlcnZlci51c2VybmFtZSA9IHNlcnZlci51c2VybmFtZTsKICAgICAgICAgICAgICAgIG5ld1NlcnZlci5jcmVkZW50aWFsID0gc2VydmVyLmNyZWRlbnRpYWw7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIG5ld0ljZVNlcnZlcnMucHVzaChuZXdTZXJ2ZXIpOwogICAgICAgICAgICB9CiAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICBuZXdJY2VTZXJ2ZXJzLnB1c2gocGNDb25maWcuaWNlU2VydmVyc1tpXSk7CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICAgIHBjQ29uZmlnLmljZVNlcnZlcnMgPSBuZXdJY2VTZXJ2ZXJzOwogICAgICB9CiAgICB9CiAgICByZXR1cm4gbmV3IG1velJUQ1BlZXJDb25uZWN0aW9uKHBjQ29uZmlnLCBwY0NvbnN0cmFpbnRzKTsgLy8ganNjczppZ25vcmUgcmVxdWlyZUNhcGl0YWxpemVkQ29uc3RydWN0b3JzCiAgfTsKCiAgLy8gVGhlIFJUQ1Nlc3Npb25EZXNjcmlwdGlvbiBvYmplY3QuCiAgaWYgKCF3aW5kb3cuUlRDU2Vzc2lvbkRlc2NyaXB0aW9uKSB7CiAgICB3aW5kb3cuUlRDU2Vzc2lvbkRlc2NyaXB0aW9uID0gbW96UlRDU2Vzc2lvbkRlc2NyaXB0aW9uOwogIH0KCiAgLy8gVGhlIFJUQ0ljZUNhbmRpZGF0ZSBvYmplY3QuCiAgaWYgKCF3aW5kb3cuUlRDSWNlQ2FuZGlkYXRlKSB7CiAgICB3aW5kb3cuUlRDSWNlQ2FuZGlkYXRlID0gbW96UlRDSWNlQ2FuZGlkYXRlOwogIH0KCiAgLy8gZ2V0VXNlck1lZGlhIGNvbnN0cmFpbnRzIHNoaW0uCiAgZ2V0VXNlck1lZGlhID0gZnVuY3Rpb24oY29uc3RyYWludHMsIG9uU3VjY2Vzcywgb25FcnJvcikgewogICAgdmFyIGNvbnN0cmFpbnRzVG9GRjM3ID0gZnVuY3Rpb24oYykgewogICAgICBpZiAodHlwZW9mIGMgIT09ICdvYmplY3QnIHx8IGMucmVxdWlyZSkgewogICAgICAgIHJldHVybiBjOwogICAgICB9CiAgICAgIHZhciByZXF1aXJlID0gW107CiAgICAgIE9iamVjdC5rZXlzKGMpLmZvckVhY2goZnVuY3Rpb24oa2V5KSB7CiAgICAgICAgaWYgKGtleSA9PT0gJ3JlcXVpcmUnIHx8IGtleSA9PT0gJ2FkdmFuY2VkJyB8fCBrZXkgPT09ICdtZWRpYVNvdXJjZScpIHsKICAgICAgICAgIHJldHVybjsKICAgICAgICB9CiAgICAgICAgdmFyIHIgPSBjW2tleV0gPSAodHlwZW9mIGNba2V5XSA9PT0gJ29iamVjdCcpID8KICAgICAgICAgICAgY1trZXldIDoge2lkZWFsOiBjW2tleV19OwogICAgICAgIGlmIChyLm1pbiAhPT0gdW5kZWZpbmVkIHx8CiAgICAgICAgICAgIHIubWF4ICE9PSB1bmRlZmluZWQgfHwgci5leGFjdCAhPT0gdW5kZWZpbmVkKSB7CiAgICAgICAgICByZXF1aXJlLnB1c2goa2V5KTsKICAgICAgICB9CiAgICAgICAgaWYgKHIuZXhhY3QgIT09IHVuZGVmaW5lZCkgewogICAgICAgICAgaWYgKHR5cGVvZiByLmV4YWN0ID09PSAnbnVtYmVyJykgewogICAgICAgICAgICByLm1pbiA9IHIubWF4ID0gci5leGFjdDsKICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgIGNba2V5XSA9IHIuZXhhY3Q7CiAgICAgICAgICB9CiAgICAgICAgICBkZWxldGUgci5leGFjdDsKICAgICAgICB9CiAgICAgICAgaWYgKHIuaWRlYWwgIT09IHVuZGVmaW5lZCkgewogICAgICAgICAgYy5hZHZhbmNlZCA9IGMuYWR2YW5jZWQgfHwgW107CiAgICAgICAgICB2YXIgb2MgPSB7fTsKICAgICAgICAgIGlmICh0eXBlb2Ygci5pZGVhbCA9PT0gJ251bWJlcicpIHsKICAgICAgICAgICAgb2Nba2V5XSA9IHttaW46IHIuaWRlYWwsIG1heDogci5pZGVhbH07CiAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICBvY1trZXldID0gci5pZGVhbDsKICAgICAgICAgIH0KICAgICAgICAgIGMuYWR2YW5jZWQucHVzaChvYyk7CiAgICAgICAgICBkZWxldGUgci5pZGVhbDsKICAgICAgICAgIGlmICghT2JqZWN0LmtleXMocikubGVuZ3RoKSB7CiAgICAgICAgICAgIGRlbGV0ZSBjW2tleV07CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICB9KTsKICAgICAgaWYgKHJlcXVpcmUubGVuZ3RoKSB7CiAgICAgICAgYy5yZXF1aXJlID0gcmVxdWlyZTsKICAgICAgfQogICAgICByZXR1cm4gYzsKICAgIH07CiAgICBpZiAod2VicnRjRGV0ZWN0ZWRWZXJzaW9uIDwgMzgpIHsKICAgICAgd2VicnRjVXRpbHMubG9nKCdzcGVjOiAnICsgSlNPTi5zdHJpbmdpZnkoY29uc3RyYWludHMpKTsKICAgICAgaWYgKGNvbnN0cmFpbnRzLmF1ZGlvKSB7CiAgICAgICAgY29uc3RyYWludHMuYXVkaW8gPSBjb25zdHJhaW50c1RvRkYzNyhjb25zdHJhaW50cy5hdWRpbyk7CiAgICAgIH0KICAgICAgaWYgKGNvbnN0cmFpbnRzLnZpZGVvKSB7CiAgICAgICAgY29uc3RyYWludHMudmlkZW8gPSBjb25zdHJhaW50c1RvRkYzNyhjb25zdHJhaW50cy52aWRlbyk7CiAgICAgIH0KICAgICAgd2VicnRjVXRpbHMubG9nKCdmZjM3OiAnICsgSlNPTi5zdHJpbmdpZnkoY29uc3RyYWludHMpKTsKICAgIH0KICAgIHJldHVybiBuYXZpZ2F0b3IubW96R2V0VXNlck1lZGlhKGNvbnN0cmFpbnRzLCBvblN1Y2Nlc3MsIG9uRXJyb3IpOwogIH07CgogIG5hdmlnYXRvci5nZXRVc2VyTWVkaWEgPSBnZXRVc2VyTWVkaWE7CgogIC8vIFNoaW0gZm9yIG1lZGlhRGV2aWNlcyBvbiBvbGRlciB2ZXJzaW9ucy4KICBpZiAoIW5hdmlnYXRvci5tZWRpYURldmljZXMpIHsKICAgIG5hdmlnYXRvci5tZWRpYURldmljZXMgPSB7Z2V0VXNlck1lZGlhOiByZXF1ZXN0VXNlck1lZGlhLAogICAgICBhZGRFdmVudExpc3RlbmVyOiBmdW5jdGlvbigpIHsgfSwKICAgICAgcmVtb3ZlRXZlbnRMaXN0ZW5lcjogZnVuY3Rpb24oKSB7IH0KICAgIH07CiAgfQogIG5hdmlnYXRvci5tZWRpYURldmljZXMuZW51bWVyYXRlRGV2aWNlcyA9CiAgICAgIG5hdmlnYXRvci5tZWRpYURldmljZXMuZW51bWVyYXRlRGV2aWNlcyB8fCBmdW5jdGlvbigpIHsKICAgIHJldHVybiBuZXcgUHJvbWlzZShmdW5jdGlvbihyZXNvbHZlKSB7CiAgICAgIHZhciBpbmZvcyA9IFsKICAgICAgICB7a2luZDogJ2F1ZGlvaW5wdXQnLCBkZXZpY2VJZDogJ2RlZmF1bHQnLCBsYWJlbDogJycsIGdyb3VwSWQ6ICcnfSwKICAgICAgICB7a2luZDogJ3ZpZGVvaW5wdXQnLCBkZXZpY2VJZDogJ2RlZmF1bHQnLCBsYWJlbDogJycsIGdyb3VwSWQ6ICcnfQogICAgICBdOwogICAgICByZXNvbHZlKGluZm9zKTsKICAgIH0pOwogIH07CgogIGlmICh3ZWJydGNEZXRlY3RlZFZlcnNpb24gPCA0MSkgewogICAgLy8gV29yayBhcm91bmQgaHR0cDovL2J1Z3ppbC5sYS8xMTY5NjY1CiAgICB2YXIgb3JnRW51bWVyYXRlRGV2aWNlcyA9CiAgICAgICAgbmF2aWdhdG9yLm1lZGlhRGV2aWNlcy5lbnVtZXJhdGVEZXZpY2VzLmJpbmQobmF2aWdhdG9yLm1lZGlhRGV2aWNlcyk7CiAgICBuYXZpZ2F0b3IubWVkaWFEZXZpY2VzLmVudW1lcmF0ZURldmljZXMgPSBmdW5jdGlvbigpIHsKICAgICAgcmV0dXJuIG9yZ0VudW1lcmF0ZURldmljZXMoKS50aGVuKHVuZGVmaW5lZCwgZnVuY3Rpb24oZSkgewogICAgICAgIGlmIChlLm5hbWUgPT09ICdOb3RGb3VuZEVycm9yJykgewogICAgICAgICAgcmV0dXJuIFtdOwogICAgICAgIH0KICAgICAgICB0aHJvdyBlOwogICAgICB9KTsKICAgIH07CiAgfQp9IGVsc2UgaWYgKG5hdmlnYXRvci53ZWJraXRHZXRVc2VyTWVkaWEgJiYgd2luZG93LndlYmtpdFJUQ1BlZXJDb25uZWN0aW9uKSB7CiAgd2VicnRjVXRpbHMubG9nKCdUaGlzIGFwcGVhcnMgdG8gYmUgQ2hyb21lJyk7CgogIHdlYnJ0Y0RldGVjdGVkQnJvd3NlciA9ICdjaHJvbWUnOwoKICAvLyB0aGUgZGV0ZWN0ZWQgY2hyb21lIHZlcnNpb24uCiAgd2VicnRjRGV0ZWN0ZWRWZXJzaW9uID0gd2VicnRjVXRpbHMuZXh0cmFjdFZlcnNpb24obmF2aWdhdG9yLnVzZXJBZ2VudCwKICAgICAgL0Nocm9tKGV8aXVtKVwvKFswLTldKylcLi8sIDIpOwoKICAvLyB0aGUgbWluaW11bSBjaHJvbWUgdmVyc2lvbiBzdGlsbCBzdXBwb3J0ZWQgYnkgYWRhcHRlci4KICB3ZWJydGNNaW5pbXVtVmVyc2lvbiA9IDM4OwoKICAvLyBUaGUgUlRDUGVlckNvbm5lY3Rpb24gb2JqZWN0LgogIHdpbmRvdy5SVENQZWVyQ29ubmVjdGlvbiA9IGZ1bmN0aW9uKHBjQ29uZmlnLCBwY0NvbnN0cmFpbnRzKSB7CiAgICAvLyBUcmFuc2xhdGUgaWNlVHJhbnNwb3J0UG9saWN5IHRvIGljZVRyYW5zcG9ydHMsCiAgICAvLyBzZWUgaHR0cHM6Ly9jb2RlLmdvb2dsZS5jb20vcC93ZWJydGMvaXNzdWVzL2RldGFpbD9pZD00ODY5CiAgICBpZiAocGNDb25maWcgJiYgcGNDb25maWcuaWNlVHJhbnNwb3J0UG9saWN5KSB7CiAgICAgIHBjQ29uZmlnLmljZVRyYW5zcG9ydHMgPSBwY0NvbmZpZy5pY2VUcmFuc3BvcnRQb2xpY3k7CiAgICB9CgogICAgdmFyIHBjID0gbmV3IHdlYmtpdFJUQ1BlZXJDb25uZWN0aW9uKHBjQ29uZmlnLCBwY0NvbnN0cmFpbnRzKTsgLy8ganNjczppZ25vcmUgcmVxdWlyZUNhcGl0YWxpemVkQ29uc3RydWN0b3JzCiAgICB2YXIgb3JpZ0dldFN0YXRzID0gcGMuZ2V0U3RhdHMuYmluZChwYyk7CiAgICBwYy5nZXRTdGF0cyA9IGZ1bmN0aW9uKHNlbGVjdG9yLCBzdWNjZXNzQ2FsbGJhY2ssIGVycm9yQ2FsbGJhY2spIHsgLy8ganNoaW50IGlnbm9yZTogbGluZQogICAgICB2YXIgc2VsZiA9IHRoaXM7CiAgICAgIHZhciBhcmdzID0gYXJndW1lbnRzOwoKICAgICAgLy8gSWYgc2VsZWN0b3IgaXMgYSBmdW5jdGlvbiB0aGVuIHdlIGFyZSBpbiB0aGUgb2xkIHN0eWxlIHN0YXRzIHNvIGp1c3QKICAgICAgLy8gcGFzcyBiYWNrIHRoZSBvcmlnaW5hbCBnZXRTdGF0cyBmb3JtYXQgdG8gYXZvaWQgYnJlYWtpbmcgb2xkIHVzZXJzLgogICAgICBpZiAoYXJndW1lbnRzLmxlbmd0aCA+IDAgJiYgdHlwZW9mIHNlbGVjdG9yID09PSAnZnVuY3Rpb24nKSB7CiAgICAgICAgcmV0dXJuIG9yaWdHZXRTdGF0cyhzZWxlY3Rvciwgc3VjY2Vzc0NhbGxiYWNrKTsKICAgICAgfQoKICAgICAgdmFyIGZpeENocm9tZVN0YXRzID0gZnVuY3Rpb24ocmVzcG9uc2UpIHsKICAgICAgICB2YXIgc3RhbmRhcmRSZXBvcnQgPSB7fTsKICAgICAgICB2YXIgcmVwb3J0cyA9IHJlc3BvbnNlLnJlc3VsdCgpOwogICAgICAgIHJlcG9ydHMuZm9yRWFjaChmdW5jdGlvbihyZXBvcnQpIHsKICAgICAgICAgIHZhciBzdGFuZGFyZFN0YXRzID0gewogICAgICAgICAgICBpZDogcmVwb3J0LmlkLAogICAgICAgICAgICB0aW1lc3RhbXA6IHJlcG9ydC50aW1lc3RhbXAsCiAgICAgICAgICAgIHR5cGU6IHJlcG9ydC50eXBlCiAgICAgICAgICB9OwogICAgICAgICAgcmVwb3J0Lm5hbWVzKCkuZm9yRWFjaChmdW5jdGlvbihuYW1lKSB7CiAgICAgICAgICAgIHN0YW5kYXJkU3RhdHNbbmFtZV0gPSByZXBvcnQuc3RhdChuYW1lKTsKICAgICAgICAgIH0pOwogICAgICAgICAgc3RhbmRhcmRSZXBvcnRbc3RhbmRhcmRTdGF0cy5pZF0gPSBzdGFuZGFyZFN0YXRzOwogICAgICAgIH0pOwoKICAgICAgICByZXR1cm4gc3RhbmRhcmRSZXBvcnQ7CiAgICAgIH07CgogICAgICBpZiAoYXJndW1lbnRzLmxlbmd0aCA+PSAyKSB7CiAgICAgICAgdmFyIHN1Y2Nlc3NDYWxsYmFja1dyYXBwZXIgPSBmdW5jdGlvbihyZXNwb25zZSkgewogICAgICAgICAgYXJnc1sxXShmaXhDaHJvbWVTdGF0cyhyZXNwb25zZSkpOwogICAgICAgIH07CgogICAgICAgIHJldHVybiBvcmlnR2V0U3RhdHMuYXBwbHkodGhpcywgW3N1Y2Nlc3NDYWxsYmFja1dyYXBwZXIsIGFyZ3VtZW50c1swXV0pOwogICAgICB9CgogICAgICAvLyBwcm9taXNlLXN1cHBvcnQKICAgICAgcmV0dXJuIG5ldyBQcm9taXNlKGZ1bmN0aW9uKHJlc29sdmUsIHJlamVjdCkgewogICAgICAgIGlmIChhcmdzLmxlbmd0aCA9PT0gMSAmJiBzZWxlY3RvciA9PT0gbnVsbCkgewogICAgICAgICAgb3JpZ0dldFN0YXRzLmFwcGx5KHNlbGYsIFsKICAgICAgICAgICAgICBmdW5jdGlvbihyZXNwb25zZSkgewogICAgICAgICAgICAgICAgcmVzb2x2ZS5hcHBseShudWxsLCBbZml4Q2hyb21lU3RhdHMocmVzcG9uc2UpXSk7CiAgICAgICAgICAgICAgfSwgcmVqZWN0XSk7CiAgICAgICAgfSBlbHNlIHsKICAgICAgICAgIG9yaWdHZXRTdGF0cy5hcHBseShzZWxmLCBbcmVzb2x2ZSwgcmVqZWN0XSk7CiAgICAgICAgfQogICAgICB9KTsKICAgIH07CgogICAgcmV0dXJuIHBjOwogIH07CgogIC8vIGFkZCBwcm9taXNlIHN1cHBvcnQKICBbJ2NyZWF0ZU9mZmVyJywgJ2NyZWF0ZUFuc3dlciddLmZvckVhY2goZnVuY3Rpb24obWV0aG9kKSB7CiAgICB2YXIgbmF0aXZlTWV0aG9kID0gd2Via2l0UlRDUGVlckNvbm5lY3Rpb24ucHJvdG90eXBlW21ldGhvZF07CiAgICB3ZWJraXRSVENQZWVyQ29ubmVjdGlvbi5wcm90b3R5cGVbbWV0aG9kXSA9IGZ1bmN0aW9uKCkgewogICAgICB2YXIgc2VsZiA9IHRoaXM7CiAgICAgIGlmIChhcmd1bWVudHMubGVuZ3RoIDwgMSB8fCAoYXJndW1lbnRzLmxlbmd0aCA9PT0gMSAmJgogICAgICAgICAgdHlwZW9mKGFyZ3VtZW50c1swXSkgPT09ICdvYmplY3QnKSkgewogICAgICAgIHZhciBvcHRzID0gYXJndW1lbnRzLmxlbmd0aCA9PT0gMSA/IGFyZ3VtZW50c1swXSA6IHVuZGVmaW5lZDsKICAgICAgICByZXR1cm4gbmV3IFByb21pc2UoZnVuY3Rpb24ocmVzb2x2ZSwgcmVqZWN0KSB7CiAgICAgICAgICBuYXRpdmVNZXRob2QuYXBwbHkoc2VsZiwgW3Jlc29sdmUsIHJlamVjdCwgb3B0c10pOwogICAgICAgIH0pOwogICAgICB9IGVsc2UgewogICAgICAgIHJldHVybiBuYXRpdmVNZXRob2QuYXBwbHkodGhpcywgYXJndW1lbnRzKTsKICAgICAgfQogICAgfTsKICB9KTsKCiAgWydzZXRMb2NhbERlc2NyaXB0aW9uJywgJ3NldFJlbW90ZURlc2NyaXB0aW9uJywKICAgICAgJ2FkZEljZUNhbmRpZGF0ZSddLmZvckVhY2goZnVuY3Rpb24obWV0aG9kKSB7CiAgICB2YXIgbmF0aXZlTWV0aG9kID0gd2Via2l0UlRDUGVlckNvbm5lY3Rpb24ucHJvdG90eXBlW21ldGhvZF07CiAgICB3ZWJraXRSVENQZWVyQ29ubmVjdGlvbi5wcm90b3R5cGVbbWV0aG9kXSA9IGZ1bmN0aW9uKCkgewogICAgICB2YXIgYXJncyA9IGFyZ3VtZW50czsKICAgICAgdmFyIHNlbGYgPSB0aGlzOwogICAgICByZXR1cm4gbmV3IFByb21pc2UoZnVuY3Rpb24ocmVzb2x2ZSwgcmVqZWN0KSB7CiAgICAgICAgbmF0aXZlTWV0aG9kLmFwcGx5KHNlbGYsIFthcmdzWzBdLAogICAgICAgICAgICBmdW5jdGlvbigpIHsKICAgICAgICAgICAgICByZXNvbHZlKCk7CiAgICAgICAgICAgICAgaWYgKGFyZ3MubGVuZ3RoID49IDIpIHsKICAgICAgICAgICAgICAgIGFyZ3NbMV0uYXBwbHkobnVsbCwgW10pOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgfSwKICAgICAgICAgICAgZnVuY3Rpb24oZXJyKSB7CiAgICAgICAgICAgICAgcmVqZWN0KGVycik7CiAgICAgICAgICAgICAgaWYgKGFyZ3MubGVuZ3RoID49IDMpIHsKICAgICAgICAgICAgICAgIGFyZ3NbMl0uYXBwbHkobnVsbCwgW2Vycl0pOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgfV0KICAgICAgICAgICk7CiAgICAgIH0pOwogICAgfTsKICB9KTsKCiAgLy8gZ2V0VXNlck1lZGlhIGNvbnN0cmFpbnRzIHNoaW0uCiAgdmFyIGNvbnN0cmFpbnRzVG9DaHJvbWUgPSBmdW5jdGlvbihjKSB7CiAgICBpZiAodHlwZW9mIGMgIT09ICdvYmplY3QnIHx8IGMubWFuZGF0b3J5IHx8IGMub3B0aW9uYWwpIHsKICAgICAgcmV0dXJuIGM7CiAgICB9CiAgICB2YXIgY2MgPSB7fTsKICAgIE9iamVjdC5rZXlzKGMpLmZvckVhY2goZnVuY3Rpb24oa2V5KSB7CiAgICAgIGlmIChrZXkgPT09ICdyZXF1aXJlJyB8fCBrZXkgPT09ICdhZHZhbmNlZCcgfHwga2V5ID09PSAnbWVkaWFTb3VyY2UnKSB7CiAgICAgICAgcmV0dXJuOwogICAgICB9CiAgICAgIHZhciByID0gKHR5cGVvZiBjW2tleV0gPT09ICdvYmplY3QnKSA/IGNba2V5XSA6IHtpZGVhbDogY1trZXldfTsKICAgICAgaWYgKHIuZXhhY3QgIT09IHVuZGVmaW5lZCAmJiB0eXBlb2Ygci5leGFjdCA9PT0gJ251bWJlcicpIHsKICAgICAgICByLm1pbiA9IHIubWF4ID0gci5leGFjdDsKICAgICAgfQogICAgICB2YXIgb2xkbmFtZSA9IGZ1bmN0aW9uKHByZWZpeCwgbmFtZSkgewogICAgICAgIGlmIChwcmVmaXgpIHsKICAgICAgICAgIHJldHVybiBwcmVmaXggKyBuYW1lLmNoYXJBdCgwKS50b1VwcGVyQ2FzZSgpICsgbmFtZS5zbGljZSgxKTsKICAgICAgICB9CiAgICAgICAgcmV0dXJuIChuYW1lID09PSAnZGV2aWNlSWQnKSA/ICdzb3VyY2VJZCcgOiBuYW1lOwogICAgICB9OwogICAgICBpZiAoci5pZGVhbCAhPT0gdW5kZWZpbmVkKSB7CiAgICAgICAgY2Mub3B0aW9uYWwgPSBjYy5vcHRpb25hbCB8fCBbXTsKICAgICAgICB2YXIgb2MgPSB7fTsKICAgICAgICBpZiAodHlwZW9mIHIuaWRlYWwgPT09ICdudW1iZXInKSB7CiAgICAgICAgICBvY1tvbGRuYW1lKCdtaW4nLCBrZXkpXSA9IHIuaWRlYWw7CiAgICAgICAgICBjYy5vcHRpb25hbC5wdXNoKG9jKTsKICAgICAgICAgIG9jID0ge307CiAgICAgICAgICBvY1tvbGRuYW1lKCdtYXgnLCBrZXkpXSA9IHIuaWRlYWw7CiAgICAgICAgICBjYy5vcHRpb25hbC5wdXNoKG9jKTsKICAgICAgICB9IGVsc2UgewogICAgICAgICAgb2Nbb2xkbmFtZSgnJywga2V5KV0gPSByLmlkZWFsOwogICAgICAgICAgY2Mub3B0aW9uYWwucHVzaChvYyk7CiAgICAgICAgfQogICAgICB9CiAgICAgIGlmIChyLmV4YWN0ICE9PSB1bmRlZmluZWQgJiYgdHlwZW9mIHIuZXhhY3QgIT09ICdudW1iZXInKSB7CiAgICAgICAgY2MubWFuZGF0b3J5ID0gY2MubWFuZGF0b3J5IHx8IHt9OwogICAgICAgIGNjLm1hbmRhdG9yeVtvbGRuYW1lKCcnLCBrZXkpXSA9IHIuZXhhY3Q7CiAgICAgIH0gZWxzZSB7CiAgICAgICAgWydtaW4nLCAnbWF4J10uZm9yRWFjaChmdW5jdGlvbihtaXgpIHsKICAgICAgICAgIGlmIChyW21peF0gIT09IHVuZGVmaW5lZCkgewogICAgICAgICAgICBjYy5tYW5kYXRvcnkgPSBjYy5tYW5kYXRvcnkgfHwge307CiAgICAgICAgICAgIGNjLm1hbmRhdG9yeVtvbGRuYW1lKG1peCwga2V5KV0gPSByW21peF07CiAgICAgICAgICB9CiAgICAgICAgfSk7CiAgICAgIH0KICAgIH0pOwogICAgaWYgKGMuYWR2YW5jZWQpIHsKICAgICAgY2Mub3B0aW9uYWwgPSAoY2Mub3B0aW9uYWwgfHwgW10pLmNvbmNhdChjLmFkdmFuY2VkKTsKICAgIH0KICAgIHJldHVybiBjYzsKICB9OwoKICBnZXRVc2VyTWVkaWEgPSBmdW5jdGlvbihjb25zdHJhaW50cywgb25TdWNjZXNzLCBvbkVycm9yKSB7CiAgICBpZiAoY29uc3RyYWludHMuYXVkaW8pIHsKICAgICAgY29uc3RyYWludHMuYXVkaW8gPSBjb25zdHJhaW50c1RvQ2hyb21lKGNvbnN0cmFpbnRzLmF1ZGlvKTsKICAgIH0KICAgIGlmIChjb25zdHJhaW50cy52aWRlbykgewogICAgICBjb25zdHJhaW50cy52aWRlbyA9IGNvbnN0cmFpbnRzVG9DaHJvbWUoY29uc3RyYWludHMudmlkZW8pOwogICAgfQogICAgd2VicnRjVXRpbHMubG9nKCdjaHJvbWU6ICcgKyBKU09OLnN0cmluZ2lmeShjb25zdHJhaW50cykpOwogICAgcmV0dXJuIG5hdmlnYXRvci53ZWJraXRHZXRVc2VyTWVkaWEoY29uc3RyYWludHMsIG9uU3VjY2Vzcywgb25FcnJvcik7CiAgfTsKICBuYXZpZ2F0b3IuZ2V0VXNlck1lZGlhID0gZ2V0VXNlck1lZGlhOwoKICBpZiAoIW5hdmlnYXRvci5tZWRpYURldmljZXMpIHsKICAgIG5hdmlnYXRvci5tZWRpYURldmljZXMgPSB7Z2V0VXNlck1lZGlhOiByZXF1ZXN0VXNlck1lZGlhLAogICAgICAgICAgICAgICAgICAgICAgICAgICAgICBlbnVtZXJhdGVEZXZpY2VzOiBmdW5jdGlvbigpIHsKICAgICAgcmV0dXJuIG5ldyBQcm9taXNlKGZ1bmN0aW9uKHJlc29sdmUpIHsKICAgICAgICB2YXIga2luZHMgPSB7YXVkaW86ICdhdWRpb2lucHV0JywgdmlkZW86ICd2aWRlb2lucHV0J307CiAgICAgICAgcmV0dXJuIE1lZGlhU3RyZWFtVHJhY2suZ2V0U291cmNlcyhmdW5jdGlvbihkZXZpY2VzKSB7CiAgICAgICAgICByZXNvbHZlKGRldmljZXMubWFwKGZ1bmN0aW9uKGRldmljZSkgewogICAgICAgICAgICByZXR1cm4ge2xhYmVsOiBkZXZpY2UubGFiZWwsCiAgICAgICAgICAgICAgICAgICAga2luZDoga2luZHNbZGV2aWNlLmtpbmRdLAogICAgICAgICAgICAgICAgICAgIGRldmljZUlkOiBkZXZpY2UuaWQsCiAgICAgICAgICAgICAgICAgICAgZ3JvdXBJZDogJyd9OwogICAgICAgICAgfSkpOwogICAgICAgIH0pOwogICAgICB9KTsKICAgIH19OwogIH0KCiAgLy8gQSBzaGltIGZvciBnZXRVc2VyTWVkaWEgbWV0aG9kIG9uIHRoZSBtZWRpYURldmljZXMgb2JqZWN0LgogIC8vIFRPRE8oS2FwdGVuSmFuc3NvbikgcmVtb3ZlIG9uY2UgaW1wbGVtZW50ZWQgaW4gQ2hyb21lIHN0YWJsZS4KICBpZiAoIW5hdmlnYXRvci5tZWRpYURldmljZXMuZ2V0VXNlck1lZGlhKSB7CiAgICBuYXZpZ2F0b3IubWVkaWFEZXZpY2VzLmdldFVzZXJNZWRpYSA9IGZ1bmN0aW9uKGNvbnN0cmFpbnRzKSB7CiAgICAgIHJldHVybiByZXF1ZXN0VXNlck1lZGlhKGNvbnN0cmFpbnRzKTsKICAgIH07CiAgfSBlbHNlIHsKICAgIC8vIEV2ZW4gdGhvdWdoIENocm9tZSA0NSBoYXMgbmF2aWdhdG9yLm1lZGlhRGV2aWNlcyBhbmQgYSBnZXRVc2VyTWVkaWEKICAgIC8vIGZ1bmN0aW9uIHdoaWNoIHJldHVybnMgYSBQcm9taXNlLCBpdCBkb2VzIG5vdCBhY2NlcHQgc3BlYy1zdHlsZQogICAgLy8gY29uc3RyYWludHMuCiAgICB2YXIgb3JpZ0dldFVzZXJNZWRpYSA9IG5hdmlnYXRvci5tZWRpYURldmljZXMuZ2V0VXNlck1lZGlhLgogICAgICAgIGJpbmQobmF2aWdhdG9yLm1lZGlhRGV2aWNlcyk7CiAgICBuYXZpZ2F0b3IubWVkaWFEZXZpY2VzLmdldFVzZXJNZWRpYSA9IGZ1bmN0aW9uKGMpIHsKICAgICAgd2VicnRjVXRpbHMubG9nKCdzcGVjOiAgICcgKyBKU09OLnN0cmluZ2lmeShjKSk7IC8vIHdoaXRlc3BhY2UgZm9yIGFsaWdubWVudAogICAgICBjLmF1ZGlvID0gY29uc3RyYWludHNUb0Nocm9tZShjLmF1ZGlvKTsKICAgICAgYy52aWRlbyA9IGNvbnN0cmFpbnRzVG9DaHJvbWUoYy52aWRlbyk7CiAgICAgIHdlYnJ0Y1V0aWxzLmxvZygnY2hyb21lOiAnICsgSlNPTi5zdHJpbmdpZnkoYykpOwogICAgICByZXR1cm4gb3JpZ0dldFVzZXJNZWRpYShjKTsKICAgIH07CiAgfQoKICAvLyBEdW1teSBkZXZpY2VjaGFuZ2UgZXZlbnQgbWV0aG9kcy4KICAvLyBUT0RPKEthcHRlbkphbnNzb24pIHJlbW92ZSBvbmNlIGltcGxlbWVudGVkIGluIENocm9tZSBzdGFibGUuCiAgaWYgKHR5cGVvZiBuYXZpZ2F0b3IubWVkaWFEZXZpY2VzLmFkZEV2ZW50TGlzdGVuZXIgPT09ICd1bmRlZmluZWQnKSB7CiAgICBuYXZpZ2F0b3IubWVkaWFEZXZpY2VzLmFkZEV2ZW50TGlzdGVuZXIgPSBmdW5jdGlvbigpIHsKICAgICAgd2VicnRjVXRpbHMubG9nKCdEdW1teSBtZWRpYURldmljZXMuYWRkRXZlbnRMaXN0ZW5lciBjYWxsZWQuJyk7CiAgICB9OwogIH0KICBpZiAodHlwZW9mIG5hdmlnYXRvci5tZWRpYURldmljZXMucmVtb3ZlRXZlbnRMaXN0ZW5lciA9PT0gJ3VuZGVmaW5lZCcpIHsKICAgIG5hdmlnYXRvci5tZWRpYURldmljZXMucmVtb3ZlRXZlbnRMaXN0ZW5lciA9IGZ1bmN0aW9uKCkgewogICAgICB3ZWJydGNVdGlscy5sb2coJ0R1bW15IG1lZGlhRGV2aWNlcy5yZW1vdmVFdmVudExpc3RlbmVyIGNhbGxlZC4nKTsKICAgIH07CiAgfQoKICAvLyBBdHRhY2ggYSBtZWRpYSBzdHJlYW0gdG8gYW4gZWxlbWVudC4KICBhdHRhY2hNZWRpYVN0cmVhbSA9IGZ1bmN0aW9uKGVsZW1lbnQsIHN0cmVhbSkgewogICAgaWYgKHdlYnJ0Y0RldGVjdGVkVmVyc2lvbiA+PSA0MykgewogICAgICBlbGVtZW50LnNyY09iamVjdCA9IHN0cmVhbTsKICAgIH0gZWxzZSBpZiAodHlwZW9mIGVsZW1lbnQuc3JjICE9PSAndW5kZWZpbmVkJykgewogICAgICBlbGVtZW50LnNyYyA9IFVSTC5jcmVhdGVPYmplY3RVUkwoc3RyZWFtKTsKICAgIH0gZWxzZSB7CiAgICAgIHdlYnJ0Y1V0aWxzLmxvZygnRXJyb3IgYXR0YWNoaW5nIHN0cmVhbSB0byBlbGVtZW50LicpOwogICAgfQogIH07CiAgcmVhdHRhY2hNZWRpYVN0cmVhbSA9IGZ1bmN0aW9uKHRvLCBmcm9tKSB7CiAgICBpZiAod2VicnRjRGV0ZWN0ZWRWZXJzaW9uID49IDQzKSB7CiAgICAgIHRvLnNyY09iamVjdCA9IGZyb20uc3JjT2JqZWN0OwogICAgfSBlbHNlIHsKICAgICAgdG8uc3JjID0gZnJvbS5zcmM7CiAgICB9CiAgfTsKCn0gZWxzZSBpZiAobmF2aWdhdG9yLm1lZGlhRGV2aWNlcyAmJiBuYXZpZ2F0b3IudXNlckFnZW50Lm1hdGNoKAogICAgL0VkZ2VcLyhcZCspLihcZCspJC8pKSB7CiAgd2VicnRjVXRpbHMubG9nKCdUaGlzIGFwcGVhcnMgdG8gYmUgRWRnZScpOwogIHdlYnJ0Y0RldGVjdGVkQnJvd3NlciA9ICdlZGdlJzsKCiAgd2VicnRjRGV0ZWN0ZWRWZXJzaW9uID0gd2VicnRjVXRpbHMuZXh0cmFjdFZlcnNpb24obmF2aWdhdG9yLnVzZXJBZ2VudCwKICAgICAgL0VkZ2VcLyhcZCspLihcZCspJC8sIDIpOwoKICAvLyB0aGUgbWluaW11bSB2ZXJzaW9uIHN0aWxsIHN1cHBvcnRlZCBieSBhZGFwdGVyLgogIHdlYnJ0Y01pbmltdW1WZXJzaW9uID0gMTI7Cn0gZWxzZSB7CiAgd2VicnRjVXRpbHMubG9nKCdCcm93c2VyIGRvZXMgbm90IGFwcGVhciB0byBiZSBXZWJSVEMtY2FwYWJsZScpOwp9CgovLyBSZXR1cm5zIHRoZSByZXN1bHQgb2YgZ2V0VXNlck1lZGlhIGFzIGEgUHJvbWlzZS4KZnVuY3Rpb24gcmVxdWVzdFVzZXJNZWRpYShjb25zdHJhaW50cykgewogIHJldHVybiBuZXcgUHJvbWlzZShmdW5jdGlvbihyZXNvbHZlLCByZWplY3QpIHsKICAgIGdldFVzZXJNZWRpYShjb25zdHJhaW50cywgcmVzb2x2ZSwgcmVqZWN0KTsKICB9KTsKfQoKdmFyIHdlYnJ0Y1Rlc3RpbmcgPSB7fTsKdHJ5IHsKICBPYmplY3QuZGVmaW5lUHJvcGVydHkod2VicnRjVGVzdGluZywgJ3ZlcnNpb24nLCB7CiAgICBzZXQ6IGZ1bmN0aW9uKHZlcnNpb24pIHsKICAgICAgd2VicnRjRGV0ZWN0ZWRWZXJzaW9uID0gdmVyc2lvbjsKICAgIH0KICB9KTsKfSBjYXRjaCAoZSkge30KCmlmICh0eXBlb2YgbW9kdWxlICE9PSAndW5kZWZpbmVkJykgewogIHZhciBSVENQZWVyQ29ubmVjdGlvbjsKICBpZiAodHlwZW9mIHdpbmRvdyAhPT0gJ3VuZGVmaW5lZCcpIHsKICAgIFJUQ1BlZXJDb25uZWN0aW9uID0gd2luZG93LlJUQ1BlZXJDb25uZWN0aW9uOwogIH0KICBtb2R1bGUuZXhwb3J0cyA9IHsKICAgIFJUQ1BlZXJDb25uZWN0aW9uOiBSVENQZWVyQ29ubmVjdGlvbiwKICAgIGdldFVzZXJNZWRpYTogZ2V0VXNlck1lZGlhLAogICAgYXR0YWNoTWVkaWFTdHJlYW06IGF0dGFjaE1lZGlhU3RyZWFtLAogICAgcmVhdHRhY2hNZWRpYVN0cmVhbTogcmVhdHRhY2hNZWRpYVN0cmVhbSwKICAgIHdlYnJ0Y0RldGVjdGVkQnJvd3Nlcjogd2VicnRjRGV0ZWN0ZWRCcm93c2VyLAogICAgd2VicnRjRGV0ZWN0ZWRWZXJzaW9uOiB3ZWJydGNEZXRlY3RlZFZlcnNpb24sCiAgICB3ZWJydGNNaW5pbXVtVmVyc2lvbjogd2VicnRjTWluaW11bVZlcnNpb24sCiAgICB3ZWJydGNUZXN0aW5nOiB3ZWJydGNUZXN0aW5nLAogICAgd2VicnRjVXRpbHM6IHdlYnJ0Y1V0aWxzCiAgICAvL3JlcXVlc3RVc2VyTWVkaWE6IG5vdCBleHBvc2VkIG9uIHB1cnBvc2UuCiAgICAvL3RyYWNlOiBub3QgZXhwb3NlZCBvbiBwdXJwb3NlLgogIH07Cn0gZWxzZSBpZiAoKHR5cGVvZiByZXF1aXJlID09PSAnZnVuY3Rpb24nKSAmJiAodHlwZW9mIGRlZmluZSA9PT0gJ2Z1bmN0aW9uJykpIHsKICAvLyBFeHBvc2Ugb2JqZWN0cyBhbmQgZnVuY3Rpb25zIHdoZW4gUmVxdWlyZUpTIGlzIGRvaW5nIHRoZSBsb2FkaW5nLgogIGRlZmluZShbXSwgZnVuY3Rpb24oKSB7CiAgICByZXR1cm4gewogICAgICBSVENQZWVyQ29ubmVjdGlvbjogd2luZG93LlJUQ1BlZXJDb25uZWN0aW9uLAogICAgICBnZXRVc2VyTWVkaWE6IGdldFVzZXJNZWRpYSwKICAgICAgYXR0YWNoTWVkaWFTdHJlYW06IGF0dGFjaE1lZGlhU3RyZWFtLAogICAgICByZWF0dGFjaE1lZGlhU3RyZWFtOiByZWF0dGFjaE1lZGlhU3RyZWFtLAogICAgICB3ZWJydGNEZXRlY3RlZEJyb3dzZXI6IHdlYnJ0Y0RldGVjdGVkQnJvd3NlciwKICAgICAgd2VicnRjRGV0ZWN0ZWRWZXJzaW9uOiB3ZWJydGNEZXRlY3RlZFZlcnNpb24sCiAgICAgIHdlYnJ0Y01pbmltdW1WZXJzaW9uOiB3ZWJydGNNaW5pbXVtVmVyc2lvbiwKICAgICAgd2VicnRjVGVzdGluZzogd2VicnRjVGVzdGluZywKICAgICAgd2VicnRjVXRpbHM6IHdlYnJ0Y1V0aWxzCiAgICAgIC8vcmVxdWVzdFVzZXJNZWRpYTogbm90IGV4cG9zZWQgb24gcHVycG9zZS4KICAgICAgLy90cmFjZTogbm90IGV4cG9zZWQgb24gcHVycG9zZS4KICAgIH07CiAgfSk7Cn0KCn0se31dLDM6W2Z1bmN0aW9uKHJlcXVpcmUsbW9kdWxlLGV4cG9ydHMpewondXNlIHN0cmljdCc7CgpPYmplY3QuZGVmaW5lUHJvcGVydHkoZXhwb3J0cywgJ19fZXNNb2R1bGUnLCB7CiAgdmFsdWU6IHRydWUKfSk7Cgp2YXIgX2NyZWF0ZUNsYXNzID0gKGZ1bmN0aW9uICgpIHsgZnVuY3Rpb24gZGVmaW5lUHJvcGVydGllcyh0YXJnZXQsIHByb3BzKSB7IGZvciAodmFyIGkgPSAwOyBpIDwgcHJvcHMubGVuZ3RoOyBpKyspIHsgdmFyIGRlc2NyaXB0b3IgPSBwcm9wc1tpXTsgZGVzY3JpcHRvci5lbnVtZXJhYmxlID0gZGVzY3JpcHRvci5lbnVtZXJhYmxlIHx8IGZhbHNlOyBkZXNjcmlwdG9yLmNvbmZpZ3VyYWJsZSA9IHRydWU7IGlmICgndmFsdWUnIGluIGRlc2NyaXB0b3IpIGRlc2NyaXB0b3Iud3JpdGFibGUgPSB0cnVlOyBPYmplY3QuZGVmaW5lUHJvcGVydHkodGFyZ2V0LCBkZXNjcmlwdG9yLmtleSwgZGVzY3JpcHRvcik7IH0gfSByZXR1cm4gZnVuY3Rpb24gKENvbnN0cnVjdG9yLCBwcm90b1Byb3BzLCBzdGF0aWNQcm9wcykgeyBpZiAocHJvdG9Qcm9wcykgZGVmaW5lUHJvcGVydGllcyhDb25zdHJ1Y3Rvci5wcm90b3R5cGUsIHByb3RvUHJvcHMpOyBpZiAoc3RhdGljUHJvcHMpIGRlZmluZVByb3BlcnRpZXMoQ29uc3RydWN0b3IsIHN0YXRpY1Byb3BzKTsgcmV0dXJuIENvbnN0cnVjdG9yOyB9OyB9KSgpOwoKZXhwb3J0c1snZGVmYXVsdCddID0gYWN0aXZhdGU7CgpmdW5jdGlvbiBfaW50ZXJvcFJlcXVpcmVEZWZhdWx0KG9iaikgeyByZXR1cm4gb2JqICYmIG9iai5fX2VzTW9kdWxlID8gb2JqIDogeyAnZGVmYXVsdCc6IG9iaiB9OyB9CgpmdW5jdGlvbiBfY2xhc3NDYWxsQ2hlY2soaW5zdGFuY2UsIENvbnN0cnVjdG9yKSB7IGlmICghKGluc3RhbmNlIGluc3RhbmNlb2YgQ29uc3RydWN0b3IpKSB7IHRocm93IG5ldyBUeXBlRXJyb3IoJ0Nhbm5vdCBjYWxsIGEgY2xhc3MgYXMgYSBmdW5jdGlvbicpOyB9IH0KCnZhciBfc3JjU2VydmljZUZyYW1ld29yayA9IHJlcXVpcmUoJy4uL3NyYy9zZXJ2aWNlLWZyYW1ld29yaycpOwoKdmFyIF9zcmNIeXBlcnR5SHlwZXJ0eUNvbm5lY3RvciA9IHJlcXVpcmUoJy4uL3NyYy9oeXBlcnR5L0h5cGVydHlDb25uZWN0b3InKTsKCnZhciBfc3JjSHlwZXJ0eUh5cGVydHlDb25uZWN0b3IyID0gX2ludGVyb3BSZXF1aXJlRGVmYXVsdChfc3JjSHlwZXJ0eUh5cGVydHlDb25uZWN0b3IpOwoKdmFyIEhlbGxvSHlwZXJ0eSA9IChmdW5jdGlvbiAoKSB7CiAgZnVuY3Rpb24gSGVsbG9IeXBlcnR5KGh5cGVydHlVUkwsIGJ1cywgY29uZmlndXJhdGlvbikgewogICAgX2NsYXNzQ2FsbENoZWNrKHRoaXMsIEhlbGxvSHlwZXJ0eSk7CgogICAgY29uc29sZS5sb2coJ1dvcmxkIEh5cGVydHkgSW5zdGFuY2UnKTsKCiAgICB2YXIgX3RoaXMgPSB0aGlzOwogICAgX3RoaXMuYnVzID0gYnVzOwogICAgX3RoaXMuY29uZmlndXJhdGlvbiA9IGNvbmZpZ3VyYXRpb247CiAgICBfdGhpcy5oeXBlcnR5VVJMID0gaHlwZXJ0eVVSTDsKCiAgICB2YXIgc3luY2hlciA9IG5ldyBfc3JjU2VydmljZUZyYW1ld29yay5TeW5jaGVyKGh5cGVydHlVUkwsIGJ1cywgY29uZmlndXJhdGlvbik7CiAgICBfdGhpcy5zeW5jaGVyID0gc3luY2hlcjsKCiAgICBfdGhpcy5zeW5jaGVyLm9uTm90aWZpY2F0aW9uKGZ1bmN0aW9uIChldmVudCkgewogICAgICBjb25zb2xlLmxvZygnaHlwZXJ0eSBoZWxsbyBoYXZlIGFuIG5vdGlmaWNhdGlvbjogJywgZXZlbnQpOwogICAgICBfdGhpcy5oeXBlcnR5Q29ubmVjdG9yLl9vbk5vdGlmaWNhdGlvbihldmVudCwgaHlwZXJ0eVVSTCk7CiAgICB9KTsKCiAgICBfdGhpcy5oeXBlcnR5Q29ubmVjdG9yID0gbmV3IF9zcmNIeXBlcnR5SHlwZXJ0eUNvbm5lY3RvcjJbJ2RlZmF1bHQnXShzeW5jaGVyKTsKICAgIF90aGlzLmh5cGVydHlDb25uZWN0b3IubmFtZSA9ICdIZWxsbyBIeXBlcnR5JzsKICB9CgogIF9jcmVhdGVDbGFzcyhIZWxsb0h5cGVydHksIFt7CiAgICBrZXk6ICdjb25uZWN0JywKICAgIHZhbHVlOiBmdW5jdGlvbiBjb25uZWN0KGh5cGVydHlVUkwsIG9wdGlvbnMpIHsKICAgICAgdmFyIF90aGlzID0gdGhpczsKICAgICAgX3RoaXMudG8gPSBoeXBlcnR5VVJMOwoKICAgICAgcmV0dXJuIG5ldyBQcm9taXNlKGZ1bmN0aW9uIChyZXNvbHZlLCByZWplY3QpIHsKCiAgICAgICAgY29uc29sZS5pbmZvKCdDb25uZWN0aW5nIHRvOiAnLCBoeXBlcnR5VVJMKTsKICAgICAgICBfdGhpcy5oeXBlcnR5Q29ubmVjdG9yLmNvbm5lY3QoaHlwZXJ0eVVSTCwgb3B0aW9ucykudGhlbihmdW5jdGlvbiAoY29udHJvbGxlcikgewogICAgICAgICAgY29uc29sZS5pbmZvKCdDb25uZWN0ZWQgdG86ICcsIGh5cGVydHlVUkwsIGNvbnRyb2xsZXIpOwogICAgICAgICAgcmVzb2x2ZShjb250cm9sbGVyKTsKICAgICAgICB9KVsnY2F0Y2gnXShmdW5jdGlvbiAocmVhc29uKSB7CiAgICAgICAgICByZWplY3QocmVhc29uKTsKICAgICAgICB9KTsKICAgICAgfSk7CiAgICB9CiAgfSwgewogICAga2V5OiAnYWNjZXB0JywKICAgIHZhbHVlOiBmdW5jdGlvbiBhY2NlcHQoKSB7CiAgICAgIHZhciBfdGhpcyA9IHRoaXM7CgogICAgICByZXR1cm4gbmV3IFByb21pc2UoZnVuY3Rpb24gKHJlc29sdmUsIHJlamVjdCkgewoKICAgICAgICBjb25zb2xlLmluZm8oJ1N1YnNjcmliaW5nIG9iamVjdCcpOwogICAgICAgIF90aGlzLmh5cGVydHlDb25uZWN0b3IuYWNjZXB0KCkudGhlbihmdW5jdGlvbiAoY29udHJvbGxlcikgewogICAgICAgICAgY29uc29sZS5pbmZvKCdzdWJzY3JpYmVkIHRvOiAnLCBjb250cm9sbGVyKTsKICAgICAgICAgIHJlc29sdmUoY29udHJvbGxlcik7CiAgICAgICAgfSlbJ2NhdGNoJ10oZnVuY3Rpb24gKHJlYXNvbikgewogICAgICAgICAgY29uc29sZS5lcnJvcihyZWFzb24pOwogICAgICAgICAgcmVqZWN0KHJlYXNvbik7CiAgICAgICAgfSk7CiAgICAgIH0pOwogICAgfQogIH0sIHsKICAgIGtleTogJ2Rpc2Nvbm5lY3QnLAogICAgdmFsdWU6IGZ1bmN0aW9uIGRpc2Nvbm5lY3QoKSB7CgogICAgICB2YXIgX3RoaXMgPSB0aGlzOwoKICAgICAgcmV0dXJuIG5ldyBQcm9taXNlKGZ1bmN0aW9uIChyZXNvbHZlLCByZWplY3QpIHsKCiAgICAgICAgY29uc29sZS5pbmZvKCdkaXNjb25uZWN0aW5nIG9iamVjdCcpOwogICAgICAgIF90aGlzLmh5cGVydHlDb25uZWN0b3IuZGlzY29ubmVjdCgpLnRoZW4oZnVuY3Rpb24gKHJlc3VsdCkgewogICAgICAgICAgY29uc29sZS5pbmZvKCdkaXNjb25uZWN0ZWQnKTsKICAgICAgICAgIHJlc29sdmUocmVzdWx0KTsKICAgICAgICB9KVsnY2F0Y2gnXShmdW5jdGlvbiAocmVhc29uKSB7CiAgICAgICAgICBjb25zb2xlLmVycm9yKHJlYXNvbik7CiAgICAgICAgICByZWplY3QocmVhc29uKTsKICAgICAgICB9KTsKICAgICAgfSk7CiAgICB9CiAgfSwgewogICAga2V5OiAnc2VuZE1lc3NhZ2UnLAogICAgdmFsdWU6IGZ1bmN0aW9uIHNlbmRNZXNzYWdlKCkgewoKICAgICAgdmFyIF90aGlzID0gdGhpczsKCiAgICAgIF90aGlzLmJ1cy5wb3N0TWVzc2FnZSh7CiAgICAgICAgZnJvbTogX3RoaXMuaHlwZXJ0eVVSTCwKICAgICAgICB0bzogJ2h5cGVydHktcnVudGltZTovL3NwMS9Xb3JsZEh5cGVydHknLAogICAgICAgIGJvZHk6IHsKICAgICAgICAgIHZhbHVlOiAnSGVsbG8gZnJvbSB3b3JsZCBoeXBlcnR5IGluc3RhbmNlJwogICAgICAgIH0KICAgICAgfSk7CiAgICB9CiAgfV0pOwoKICByZXR1cm4gSGVsbG9IeXBlcnR5Owp9KSgpOwoKZnVuY3Rpb24gYWN0aXZhdGUoaHlwZXJ0eVVSTCwgYnVzLCBjb25maWd1cmF0aW9uKSB7CgogIHJldHVybiB7CiAgICBoeXBlcnR5TmFtZTogJ0hlbGxvSHlwZXJ0eScsCiAgICBoeXBlcnR5Q29kZTogbmV3IEhlbGxvSHlwZXJ0eShoeXBlcnR5VVJMLCBidXMsIGNvbmZpZ3VyYXRpb24pCiAgfTsKfQoKbW9kdWxlLmV4cG9ydHMgPSBleHBvcnRzWydkZWZhdWx0J107Cgp9LHsiLi4vc3JjL2h5cGVydHkvSHlwZXJ0eUNvbm5lY3RvciI6MTMsIi4uL3NyYy9zZXJ2aWNlLWZyYW1ld29yayI6MTh9XSw0OltmdW5jdGlvbihyZXF1aXJlLG1vZHVsZSxleHBvcnRzKXsKLyoqCiAqIENyZWF0ZWQgYnkgYW1vIG9uIDE0LzExLzIwMTUuCiAqLwondXNlIHN0cmljdCc7CgpPYmplY3QuZGVmaW5lUHJvcGVydHkoZXhwb3J0cywgJ19fZXNNb2R1bGUnLCB7CiAgICB2YWx1ZTogdHJ1ZQp9KTsKCnZhciBfY3JlYXRlQ2xhc3MgPSAoZnVuY3Rpb24gKCkgeyBmdW5jdGlvbiBkZWZpbmVQcm9wZXJ0aWVzKHRhcmdldCwgcHJvcHMpIHsgZm9yICh2YXIgaSA9IDA7IGkgPCBwcm9wcy5sZW5ndGg7IGkrKykgeyB2YXIgZGVzY3JpcHRvciA9IHByb3BzW2ldOyBkZXNjcmlwdG9yLmVudW1lcmFibGUgPSBkZXNjcmlwdG9yLmVudW1lcmFibGUgfHwgZmFsc2U7IGRlc2NyaXB0b3IuY29uZmlndXJhYmxlID0gdHJ1ZTsgaWYgKCd2YWx1ZScgaW4gZGVzY3JpcHRvcikgZGVzY3JpcHRvci53cml0YWJsZSA9IHRydWU7IE9iamVjdC5kZWZpbmVQcm9wZXJ0eSh0YXJnZXQsIGRlc2NyaXB0b3Iua2V5LCBkZXNjcmlwdG9yKTsgfSB9IHJldHVybiBmdW5jdGlvbiAoQ29uc3RydWN0b3IsIHByb3RvUHJvcHMsIHN0YXRpY1Byb3BzKSB7IGlmIChwcm90b1Byb3BzKSBkZWZpbmVQcm9wZXJ0aWVzKENvbnN0cnVjdG9yLnByb3RvdHlwZSwgcHJvdG9Qcm9wcyk7IGlmIChzdGF0aWNQcm9wcykgZGVmaW5lUHJvcGVydGllcyhDb25zdHJ1Y3Rvciwgc3RhdGljUHJvcHMpOyByZXR1cm4gQ29uc3RydWN0b3I7IH07IH0pKCk7CgpmdW5jdGlvbiBfY2xhc3NDYWxsQ2hlY2soaW5zdGFuY2UsIENvbnN0cnVjdG9yKSB7IGlmICghKGluc3RhbmNlIGluc3RhbmNlb2YgQ29uc3RydWN0b3IpKSB7IHRocm93IG5ldyBUeXBlRXJyb3IoJ0Nhbm5vdCBjYWxsIGEgY2xhc3MgYXMgYSBmdW5jdGlvbicpOyB9IH0KCnZhciBDYXRhbG9ndWVEYXRhT2JqZWN0ID0gKGZ1bmN0aW9uICgpIHsKICAgIC8qKgogICAgICogQ3JlYXRlcyB0aGUgQ2F0YWxvZ3VlIERhdGEgT2JqZWN0CiAgICAgKiBAcGFyYW0gZ3VpZCAtIEdsb2JhbCBVbmlxdWUgaWRlbnRpZmllciBvZiB0aGUgQ2F0YWxvZ3VlIE9iamVjdCAoZS5nLiBIeXBlcnR5IGRlc2NyaXB0b3IsIFByb3RvY29sU3R1YiBkZXNjcmlwdG9yLAogICAgICogZXRjKSBlbmFibGluZyB0aGUgc2FtZSBvYmplY3QgdG8gYmUgc3RvcmVkIGFuZCBkaXNjb3ZlcmVkIGluIGRpZmZlcmVudCBDYXRhbG9ndWVzLiBUaGF0IG1lYW5zLCBndWlkIGNvcnJlc3BvbmRzIHRvCiAgICAgKiA8cmVzb3VyY2UtdHlwZS1pZD4gcGVyIEJORiBvZiBSZXNvdXJjZSBQYXRoLiBDb3VsZG4ndCB3ZSBoYXZlIHByb2JsZW1zIHdpdGggdG9vIGxvbmcgVVJMIHBhdGhzPwogICAgICogQHBhcmFtIHR5cGUgLSBpbmRpY2F0ZXMgdGhlIHR5cGUgb2YgQ2F0YWxvZ3VlIERhdGEgT2JqZWN0IGUuZy4gSHlwZXJ0eSwgUHJvdG9jb2xTdHViLCBldGMKICAgICAqIEBwYXJhbSBvYmplY3ROYW1lIC0gaHVtYW4tdW5kZXJzdGFuZGFibGUgbmFtZSBvZiB0aGUgY2F0YWxvZ3VlIG9iamVjdCBlLmcuICJNeSBBd2Vzb21lIEh5cGVydHkiCiAgICAgKiBAcGFyYW0gZGVzY3JpcHRpb24gLSBkZXNjcmlwdGlvbiBvZiB0aGUgc291cmNlIHBhY2thZ2UKICAgICAqIEBwYXJhbSBsYW5ndWFnZSAtIHRoZSBwcm9ncmFtbWluZyBsYW5ndWFnZSB1c2VkIGluIHRoZSBTb3VyY2VQYWNrYWdlLlNvdXJjZUNvZGUKICAgICAqIEBwYXJhbSBzb3VyY2VQYWNrYWdlVVJMIC0gQSBzdHJpbmcgY29udGFpbmluZyB0aGUgVVJMIGZyb20gd2hlcmUgdGhlIHNvdXJjZSBjb2RlIHBhY2thZ2Ugb2YgdGhlIGNvcnJlc3BvbmRpbmcKICAgICAqIGNhdGFsb2d1ZSBvYmplY3QsIGUuZy4gZGVwbG95YWJsZSBwYWNrYWdlcyBjb250YWluaW5nIGV4ZWN1dGFibGUgY29kZSBmb3IgSHlwZXJ0aWVzIG9yIFByb3RvU3R1YnMsIGNhbiBiZSBkb3dubG9hZGVkCiAgICAgKi8KCiAgICBmdW5jdGlvbiBDYXRhbG9ndWVEYXRhT2JqZWN0KGd1aWQsIHR5cGUsIG9iamVjdE5hbWUsIGRlc2NyaXB0aW9uLCBsYW5ndWFnZSwgc291cmNlUGFja2FnZVVSTCkgewogICAgICAgIF9jbGFzc0NhbGxDaGVjayh0aGlzLCBDYXRhbG9ndWVEYXRhT2JqZWN0KTsKCiAgICAgICAgdGhpcy5fZ3VpZCA9IGd1aWQ7CiAgICAgICAgdGhpcy5fdHlwZSA9IHR5cGU7CiAgICAgICAgdGhpcy5fb2JqZWN0TmFtZSA9IG9iamVjdE5hbWU7CiAgICAgICAgdGhpcy5fZGVzY3JpcHRpb24gPSBkZXNjcmlwdGlvbjsKICAgICAgICB0aGlzLl9sYW5ndWFnZSA9IGxhbmd1YWdlOwogICAgICAgIHRoaXMuX3NvdXJjZVBhY2thZ2VVUkwgPSBzb3VyY2VQYWNrYWdlVVJMOwoKICAgICAgICB0aGlzLl9zaWduYXR1cmUgPSBudWxsOwogICAgICAgIHRoaXMuX3NvdXJjZVBhY2thZ2UgPSBudWxsOwogICAgfQoKICAgIC8vIEdldHRlcnMKCiAgICBfY3JlYXRlQ2xhc3MoQ2F0YWxvZ3VlRGF0YU9iamVjdCwgW3sKICAgICAgICBrZXk6ICdndWlkJywKICAgICAgICBnZXQ6IGZ1bmN0aW9uIGdldCgpIHsKICAgICAgICAgICAgcmV0dXJuIHRoaXMuX2d1aWQ7CiAgICAgICAgfQogICAgfSwgewogICAgICAgIGtleTogJ3R5cGUnLAogICAgICAgIGdldDogZnVuY3Rpb24gZ2V0KCkgewogICAgICAgICAgICByZXR1cm4gdGhpcy5fdHlwZTsKICAgICAgICB9CiAgICB9LCB7CiAgICAgICAga2V5OiAnb2JqZWN0TmFtZScsCiAgICAgICAgZ2V0OiBmdW5jdGlvbiBnZXQoKSB7CiAgICAgICAgICAgIHJldHVybiB0aGlzLl9vYmplY3ROYW1lOwogICAgICAgIH0KICAgIH0sIHsKICAgICAgICBrZXk6ICdkZXNjcmlwdGlvbicsCiAgICAgICAgZ2V0OiBmdW5jdGlvbiBnZXQoKSB7CiAgICAgICAgICAgIHJldHVybiB0aGlzLl9kZXNjcmlwdGlvbjsKICAgICAgICB9CiAgICB9LCB7CiAgICAgICAga2V5OiAnbGFuZ3VhZ2UnLAogICAgICAgIGdldDogZnVuY3Rpb24gZ2V0KCkgewogICAgICAgICAgICByZXR1cm4gdGhpcy5fbGFuZ3VhZ2U7CiAgICAgICAgfQogICAgfSwgewogICAgICAgIGtleTogJ3NpZ25hdHVyZScsCiAgICAgICAgZ2V0OiBmdW5jdGlvbiBnZXQoKSB7CiAgICAgICAgICAgIHJldHVybiB0aGlzLl9zaWduYXR1cmU7CiAgICAgICAgfSwKCiAgICAgICAgLy8gU2V0dGVycwogICAgICAgIC8qKgogICAgICAgICAqIFNldCB0aGUgc2lnbmF0dXJlIHRvIGVuYWJsZXMgaW50ZWdyaXR5IGFuZCBhdXRoZW50aWNpdHkgdmVyaWZpY2F0aW9uCiAgICAgICAgICogQHBhcmFtIHNpZ25hdHVyZQogICAgICAgICAqLwogICAgICAgIHNldDogZnVuY3Rpb24gc2V0KHNpZ25hdHVyZSkgewogICAgICAgICAgICBpZiAoc2lnbmF0dXJlKSB0aGlzLl9zaWduYXR1cmUgPSBzaWduYXR1cmU7CiAgICAgICAgfQogICAgfSwgewogICAgICAgIGtleTogJ3NvdXJjZVBhY2thZ2UnLAogICAgICAgIGdldDogZnVuY3Rpb24gZ2V0KCkgewogICAgICAgICAgICByZXR1cm4gdGhpcy5fc291cmNlUGFja2FnZTsKICAgICAgICB9LAogICAgICAgIHNldDogZnVuY3Rpb24gc2V0KHNyY1BhY2thZ2UpIHsKICAgICAgICAgICAgaWYgKHNyY1BhY2thZ2UpIHRoaXMuX3NvdXJjZVBhY2thZ2UgPSBzcmNQYWNrYWdlOwogICAgICAgIH0KICAgIH0sIHsKICAgICAgICBrZXk6ICdzb3VyY2VQYWNrYWdlVVJMJywKICAgICAgICBnZXQ6IGZ1bmN0aW9uIGdldCgpIHsKICAgICAgICAgICAgcmV0dXJuIHRoaXMuX3NvdXJjZVBhY2thZ2VVUkw7CiAgICAgICAgfQogICAgfV0pOwoKICAgIHJldHVybiBDYXRhbG9ndWVEYXRhT2JqZWN0Owp9KSgpOwoKdmFyIENhdGFsb2d1ZU9iamVjdFR5cGUgPSB7CiAgICBIWVBFUlRZOiAnaHlwZXJ0eScsIFBST1RPU1RVQjogJ3Byb3Rvc3R1YicsIEhZUEVSVFlfUlVOVElNRTogJ2h5cGVydHlfcnVudGltZScsCiAgICBIWVBFUlRZX0lOVEVSQ0VQVE9SOiAnaHlwZXJ0eV9pbnNwZWN0b3InLCBIWVBFUlRZX0RBVEFfT0JKRUNUOiAnaHlwZXJ0eV9kYXRhX29iamVjdCcsCiAgICBQT0xJQ1lfRU5GT1JDRVI6ICdwb2xpY3lfZW5mb3JjZXInCn07CmV4cG9ydHMuQ2F0YWxvZ3VlT2JqZWN0VHlwZSA9IENhdGFsb2d1ZU9iamVjdFR5cGU7CnZhciBEYXRhT2JqZWN0U291cmNlTGFuZ3VhZ2UgPSB7CiAgICBKQVZBU0NSSVBUX0VDTUE2OiAnamF2YXNjcmlwdF9lY21hNicsIEpBVkFTQ1JJUFRfRUNNQTU6ICdqYXZhc2NyaXB0X2VjbWE1JywKICAgIEpTT05fU0NIRU1BX1Y0OiAnanNvbl9zY2hlbWFfdjQnLCBQWVRIT046ICdweXRob24nLCBUWVBFU0NSSVBUOiAndHlwZXNjcmlwdCcKfTsKZXhwb3J0cy5EYXRhT2JqZWN0U291cmNlTGFuZ3VhZ2UgPSBEYXRhT2JqZWN0U291cmNlTGFuZ3VhZ2U7CmV4cG9ydHNbJ2RlZmF1bHQnXSA9IENhdGFsb2d1ZURhdGFPYmplY3Q7Cgp9LHt9XSw1OltmdW5jdGlvbihyZXF1aXJlLG1vZHVsZSxleHBvcnRzKXsKJ3VzZSBzdHJpY3QnOwoKT2JqZWN0LmRlZmluZVByb3BlcnR5KGV4cG9ydHMsICdfX2VzTW9kdWxlJywgewogICAgdmFsdWU6IHRydWUKfSk7Cgp2YXIgX2NyZWF0ZUNsYXNzID0gKGZ1bmN0aW9uICgpIHsgZnVuY3Rpb24gZGVmaW5lUHJvcGVydGllcyh0YXJnZXQsIHByb3BzKSB7IGZvciAodmFyIGkgPSAwOyBpIDwgcHJvcHMubGVuZ3RoOyBpKyspIHsgdmFyIGRlc2NyaXB0b3IgPSBwcm9wc1tpXTsgZGVzY3JpcHRvci5lbnVtZXJhYmxlID0gZGVzY3JpcHRvci5lbnVtZXJhYmxlIHx8IGZhbHNlOyBkZXNjcmlwdG9yLmNvbmZpZ3VyYWJsZSA9IHRydWU7IGlmICgndmFsdWUnIGluIGRlc2NyaXB0b3IpIGRlc2NyaXB0b3Iud3JpdGFibGUgPSB0cnVlOyBPYmplY3QuZGVmaW5lUHJvcGVydHkodGFyZ2V0LCBkZXNjcmlwdG9yLmtleSwgZGVzY3JpcHRvcik7IH0gfSByZXR1cm4gZnVuY3Rpb24gKENvbnN0cnVjdG9yLCBwcm90b1Byb3BzLCBzdGF0aWNQcm9wcykgeyBpZiAocHJvdG9Qcm9wcykgZGVmaW5lUHJvcGVydGllcyhDb25zdHJ1Y3Rvci5wcm90b3R5cGUsIHByb3RvUHJvcHMpOyBpZiAoc3RhdGljUHJvcHMpIGRlZmluZVByb3BlcnRpZXMoQ29uc3RydWN0b3IsIHN0YXRpY1Byb3BzKTsgcmV0dXJuIENvbnN0cnVjdG9yOyB9OyB9KSgpOwoKdmFyIF9nZXQgPSBmdW5jdGlvbiBnZXQoX3gsIF94MiwgX3gzKSB7IHZhciBfYWdhaW4gPSB0cnVlOyBfZnVuY3Rpb246IHdoaWxlIChfYWdhaW4pIHsgdmFyIG9iamVjdCA9IF94LCBwcm9wZXJ0eSA9IF94MiwgcmVjZWl2ZXIgPSBfeDM7IF9hZ2FpbiA9IGZhbHNlOyBpZiAob2JqZWN0ID09PSBudWxsKSBvYmplY3QgPSBGdW5jdGlvbi5wcm90b3R5cGU7IHZhciBkZXNjID0gT2JqZWN0LmdldE93blByb3BlcnR5RGVzY3JpcHRvcihvYmplY3QsIHByb3BlcnR5KTsgaWYgKGRlc2MgPT09IHVuZGVmaW5lZCkgeyB2YXIgcGFyZW50ID0gT2JqZWN0LmdldFByb3RvdHlwZU9mKG9iamVjdCk7IGlmIChwYXJlbnQgPT09IG51bGwpIHsgcmV0dXJuIHVuZGVmaW5lZDsgfSBlbHNlIHsgX3ggPSBwYXJlbnQ7IF94MiA9IHByb3BlcnR5OyBfeDMgPSByZWNlaXZlcjsgX2FnYWluID0gdHJ1ZTsgZGVzYyA9IHBhcmVudCA9IHVuZGVmaW5lZDsgY29udGludWUgX2Z1bmN0aW9uOyB9IH0gZWxzZSBpZiAoJ3ZhbHVlJyBpbiBkZXNjKSB7IHJldHVybiBkZXNjLnZhbHVlOyB9IGVsc2UgeyB2YXIgZ2V0dGVyID0gZGVzYy5nZXQ7IGlmIChnZXR0ZXIgPT09IHVuZGVmaW5lZCkgeyByZXR1cm4gdW5kZWZpbmVkOyB9IHJldHVybiBnZXR0ZXIuY2FsbChyZWNlaXZlcik7IH0gfSB9OwoKZnVuY3Rpb24gX2ludGVyb3BSZXF1aXJlRGVmYXVsdChvYmopIHsgcmV0dXJuIG9iaiAmJiBvYmouX19lc01vZHVsZSA/IG9iaiA6IHsgJ2RlZmF1bHQnOiBvYmogfTsgfQoKZnVuY3Rpb24gX2NsYXNzQ2FsbENoZWNrKGluc3RhbmNlLCBDb25zdHJ1Y3RvcikgeyBpZiAoIShpbnN0YW5jZSBpbnN0YW5jZW9mIENvbnN0cnVjdG9yKSkgeyB0aHJvdyBuZXcgVHlwZUVycm9yKCdDYW5ub3QgY2FsbCBhIGNsYXNzIGFzIGEgZnVuY3Rpb24nKTsgfSB9CgpmdW5jdGlvbiBfaW5oZXJpdHMoc3ViQ2xhc3MsIHN1cGVyQ2xhc3MpIHsgaWYgKHR5cGVvZiBzdXBlckNsYXNzICE9PSAnZnVuY3Rpb24nICYmIHN1cGVyQ2xhc3MgIT09IG51bGwpIHsgdGhyb3cgbmV3IFR5cGVFcnJvcignU3VwZXIgZXhwcmVzc2lvbiBtdXN0IGVpdGhlciBiZSBudWxsIG9yIGEgZnVuY3Rpb24sIG5vdCAnICsgdHlwZW9mIHN1cGVyQ2xhc3MpOyB9IHN1YkNsYXNzLnByb3RvdHlwZSA9IE9iamVjdC5jcmVhdGUoc3VwZXJDbGFzcyAmJiBzdXBlckNsYXNzLnByb3RvdHlwZSwgeyBjb25zdHJ1Y3RvcjogeyB2YWx1ZTogc3ViQ2xhc3MsIGVudW1lcmFibGU6IGZhbHNlLCB3cml0YWJsZTogdHJ1ZSwgY29uZmlndXJhYmxlOiB0cnVlIH0gfSk7IGlmIChzdXBlckNsYXNzKSBPYmplY3Quc2V0UHJvdG90eXBlT2YgPyBPYmplY3Quc2V0UHJvdG90eXBlT2Yoc3ViQ2xhc3MsIHN1cGVyQ2xhc3MpIDogc3ViQ2xhc3MuX19wcm90b19fID0gc3VwZXJDbGFzczsgfQoKdmFyIF9yZVRISU5LT2JqZWN0UmV0aGlua09iamVjdCA9IHJlcXVpcmUoJy4uL3JlVEhJTktPYmplY3QvUmV0aGlua09iamVjdCcpOwoKdmFyIF9yZVRISU5LT2JqZWN0UmV0aGlua09iamVjdDIgPSBfaW50ZXJvcFJlcXVpcmVEZWZhdWx0KF9yZVRISU5LT2JqZWN0UmV0aGlua09iamVjdCk7Cgp2YXIgX0NhdGFsb2d1ZURhdGFPYmplY3QgPSByZXF1aXJlKCcuL0NhdGFsb2d1ZURhdGFPYmplY3QnKTsKCnZhciBfQ2F0YWxvZ3VlRGF0YU9iamVjdDIgPSBfaW50ZXJvcFJlcXVpcmVEZWZhdWx0KF9DYXRhbG9ndWVEYXRhT2JqZWN0KTsKCnZhciBfU291cmNlUGFja2FnZSA9IHJlcXVpcmUoJy4vU291cmNlUGFja2FnZScpOwoKdmFyIF9Tb3VyY2VQYWNrYWdlMiA9IF9pbnRlcm9wUmVxdWlyZURlZmF1bHQoX1NvdXJjZVBhY2thZ2UpOwoKdmFyIF9IeXBlcnR5RGVzY3JpcHRvciA9IHJlcXVpcmUoJy4vSHlwZXJ0eURlc2NyaXB0b3InKTsKCnZhciBfSHlwZXJ0eURlc2NyaXB0b3IyID0gX2ludGVyb3BSZXF1aXJlRGVmYXVsdChfSHlwZXJ0eURlc2NyaXB0b3IpOwoKdmFyIF9Qcm90b2NvbFN0dWJEZXNjcmlwdG9yID0gcmVxdWlyZSgnLi9Qcm90b2NvbFN0dWJEZXNjcmlwdG9yJyk7Cgp2YXIgX1Byb3RvY29sU3R1YkRlc2NyaXB0b3IyID0gX2ludGVyb3BSZXF1aXJlRGVmYXVsdChfUHJvdG9jb2xTdHViRGVzY3JpcHRvcik7Cgp2YXIgX0h5cGVydHlSdW50aW1lRGVzY3JpcHRvciA9IHJlcXVpcmUoJy4vSHlwZXJ0eVJ1bnRpbWVEZXNjcmlwdG9yJyk7Cgp2YXIgX0h5cGVydHlSdW50aW1lRGVzY3JpcHRvcjIgPSBfaW50ZXJvcFJlcXVpcmVEZWZhdWx0KF9IeXBlcnR5UnVudGltZURlc2NyaXB0b3IpOwoKdmFyIF9Qb2xpY3lFbmZvcmNlckRlc2NyaXB0b3IgPSByZXF1aXJlKCcuL1BvbGljeUVuZm9yY2VyRGVzY3JpcHRvcicpOwoKdmFyIF9Qb2xpY3lFbmZvcmNlckRlc2NyaXB0b3IyID0gX2ludGVyb3BSZXF1aXJlRGVmYXVsdChfUG9saWN5RW5mb3JjZXJEZXNjcmlwdG9yKTsKCnZhciBfRGF0YU9iamVjdFNjaGVtYSA9IHJlcXVpcmUoJy4vRGF0YU9iamVjdFNjaGVtYScpOwoKdmFyIF9EYXRhT2JqZWN0U2NoZW1hMiA9IF9pbnRlcm9wUmVxdWlyZURlZmF1bHQoX0RhdGFPYmplY3RTY2hlbWEpOwoKdmFyIENhdGFsb2d1ZURhdGFPYmplY3RGYWN0b3J5ID0gKGZ1bmN0aW9uIChfUmV0aGlua09iamVjdCkgewogICAgX2luaGVyaXRzKENhdGFsb2d1ZURhdGFPYmplY3RGYWN0b3J5LCBfUmV0aGlua09iamVjdCk7CgogICAgLyoqCiAgICAgKiBDb25zdHJ1Y3RvcgogICAgICogQHBhcmFtIHtib29sZWFufSB2YWxpZGF0aW9uCiAgICAgKiBAcGFyYW0ge1VSTC5VUkwgfSBzY2hlbWEgLSBsaW5rIHRvIHRoZSBzY2hlbWEKICAgICAqLwoKICAgIGZ1bmN0aW9uIENhdGFsb2d1ZURhdGFPYmplY3RGYWN0b3J5KHZhbGlkYXRpb24sIHNjaGVtYSkgewogICAgICAgIF9jbGFzc0NhbGxDaGVjayh0aGlzLCBDYXRhbG9ndWVEYXRhT2JqZWN0RmFjdG9yeSk7CgogICAgICAgIF9nZXQoT2JqZWN0LmdldFByb3RvdHlwZU9mKENhdGFsb2d1ZURhdGFPYmplY3RGYWN0b3J5LnByb3RvdHlwZSksICdjb25zdHJ1Y3RvcicsIHRoaXMpLmNhbGwodGhpcywgdmFsaWRhdGlvbiwgc2NoZW1hKTsKICAgIH0KCiAgICBfY3JlYXRlQ2xhc3MoQ2F0YWxvZ3VlRGF0YU9iamVjdEZhY3RvcnksIFt7CiAgICAgICAga2V5OiAnY3JlYXRlQ2F0YWxvZ3VlRGF0YU9iamVjdCcsCiAgICAgICAgdmFsdWU6IGZ1bmN0aW9uIGNyZWF0ZUNhdGFsb2d1ZURhdGFPYmplY3QodHlwZSwgb2JqZWN0TmFtZSwgZGVzY3JpcHRpb24sIGxhbmd1YWdlLCBzb3VyY2VQYWNrYWdlVVJMKSB7CiAgICAgICAgICAgIGlmICh0eXBlb2YgdHlwZSA9PT0gInVuZGVmaW5lZCIgfHwgdHlwZW9mIG9iamVjdE5hbWUgPT09ICJ1bmRlZmluZWQiIHx8IHR5cGVvZiBkZXNjcmlwdGlvbiA9PT0gInVuZGVmaW5lZCIgfHwgdHlwZW9mIGxhbmd1YWdlID09PSAidW5kZWZpbmVkIiB8fCB0eXBlb2Ygc291cmNlUGFja2FnZVVSTCA9PT0gInVuZGVmaW5lZCIpIHRocm93IG5ldyBFcnJvcigiSW52YWxpZCBwYXJhbWV0ZXJzISIpOwogICAgICAgICAgICByZXR1cm4gbmV3IF9DYXRhbG9ndWVEYXRhT2JqZWN0MlsnZGVmYXVsdCddKHRoaXMuX2dlbmVyYXRlR3VpZCgpLCB0eXBlLCBvYmplY3ROYW1lLCBkZXNjcmlwdGlvbiwgbGFuZ3VhZ2UsIHNvdXJjZVBhY2thZ2VVUkwpOwogICAgICAgIH0KICAgIH0sIHsKICAgICAgICBrZXk6ICdjcmVhdGVIeXBlcnR5RGVzY3JpcHRvck9iamVjdCcsCiAgICAgICAgdmFsdWU6IGZ1bmN0aW9uIGNyZWF0ZUh5cGVydHlEZXNjcmlwdG9yT2JqZWN0KG9iamVjdE5hbWUsIGRlc2NyaXB0aW9uLCBsYW5ndWFnZSwgc291cmNlUGFja2FnZVVSTCwgaHlwZXJ0eVR5cGUsIGRhdGFPYmplY3RzKSB7CiAgICAgICAgICAgIGlmICh0eXBlb2Ygb2JqZWN0TmFtZSA9PT0gInVuZGVmaW5lZCIgfHwgdHlwZW9mIGRlc2NyaXB0aW9uID09PSAidW5kZWZpbmVkIiB8fCB0eXBlb2YgbGFuZ3VhZ2UgPT09ICJ1bmRlZmluZWQiIHx8IHR5cGVvZiBzb3VyY2VQYWNrYWdlVVJMID09PSAidW5kZWZpbmVkIiB8fCB0eXBlb2YgaHlwZXJ0eVR5cGUgPT09ICJ1bmRlZmluZWQiIHx8IHR5cGVvZiBkYXRhT2JqZWN0cyA9PT0gInVuZGVmaW5lZCIpIHRocm93IG5ldyBFcnJvcigiSW52YWxpZCBwYXJhbWV0ZXJzISIpOwogICAgICAgICAgICByZXR1cm4gbmV3IF9IeXBlcnR5RGVzY3JpcHRvcjJbJ2RlZmF1bHQnXSh0aGlzLl9nZW5lcmF0ZUd1aWQoKSwgX0NhdGFsb2d1ZURhdGFPYmplY3QuQ2F0YWxvZ3VlT2JqZWN0VHlwZS5IWVBFUlRZLCBvYmplY3ROYW1lLCBkZXNjcmlwdGlvbiwgbGFuZ3VhZ2UsIHNvdXJjZVBhY2thZ2VVUkwsIGh5cGVydHlUeXBlLCBkYXRhT2JqZWN0cyk7CiAgICAgICAgfQogICAgfSwgewogICAgICAgIGtleTogJ2NyZWF0ZVByb3RvU3R1YkRlc2NyaXB0b3JPYmplY3QnLAogICAgICAgIHZhbHVlOiBmdW5jdGlvbiBjcmVhdGVQcm90b1N0dWJEZXNjcmlwdG9yT2JqZWN0KG9iamVjdE5hbWUsIGRlc2NyaXB0aW9uLCBsYW5ndWFnZSwgc291cmNlUGFja2FnZVVSTCwgbWVzc2FnZVNjaGVtYXMsIGNvbmZpZ3VyYXRpb25MaXN0LCBjb25zdHJhaW50TGlzdCkgewogICAgICAgICAgICBpZiAodHlwZW9mIG9iamVjdE5hbWUgPT09ICJ1bmRlZmluZWQiIHx8IHR5cGVvZiBkZXNjcmlwdGlvbiA9PT0gInVuZGVmaW5lZCIgfHwgdHlwZW9mIGxhbmd1YWdlID09PSAidW5kZWZpbmVkIiB8fCB0eXBlb2Ygc291cmNlUGFja2FnZVVSTCA9PT0gInVuZGVmaW5lZCIgfHwgdHlwZW9mIG1lc3NhZ2VTY2hlbWFzID09PSAidW5kZWZpbmVkIiB8fCB0eXBlb2YgY29uZmlndXJhdGlvbkxpc3QgPT09ICJ1bmRlZmluZWQiIHx8IHR5cGVvZiBjb25zdHJhaW50TGlzdCA9PT0gInVuZGVmaW5lZCIpIHRocm93IG5ldyBFcnJvcigiSW52YWxpZCBwYXJhbWV0ZXJzISIpOwogICAgICAgICAgICByZXR1cm4gbmV3IF9Qcm90b2NvbFN0dWJEZXNjcmlwdG9yMlsnZGVmYXVsdCddKHRoaXMuX2dlbmVyYXRlR3VpZCgpLCBfQ2F0YWxvZ3VlRGF0YU9iamVjdC5DYXRhbG9ndWVPYmplY3RUeXBlLlBST1RPU1RVQiwgb2JqZWN0TmFtZSwgZGVzY3JpcHRpb24sIGxhbmd1YWdlLCBzb3VyY2VQYWNrYWdlVVJMLCBtZXNzYWdlU2NoZW1hcywgY29uZmlndXJhdGlvbkxpc3QsIGNvbnN0cmFpbnRMaXN0KTsKICAgICAgICB9CiAgICB9LCB7CiAgICAgICAga2V5OiAnY3JlYXRlSHlwZXJ0eVJ1bnRpbWVEZXNjcmlwdG9yT2JqZWN0JywKICAgICAgICB2YWx1ZTogZnVuY3Rpb24gY3JlYXRlSHlwZXJ0eVJ1bnRpbWVEZXNjcmlwdG9yT2JqZWN0KG9iamVjdE5hbWUsIGRlc2NyaXB0aW9uLCBsYW5ndWFnZSwgc291cmNlUGFja2FnZVVSTCwgcnVudGltZVR5cGUsIGh5cGVydHlDYXBhYmlsaXRpZXMsIHByb3RvY29sQ2FwYWJpbGl0aWVzKSB7CiAgICAgICAgICAgIGlmICh0eXBlb2Ygb2JqZWN0TmFtZSA9PT0gInVuZGVmaW5lZCIgfHwgdHlwZW9mIGRlc2NyaXB0aW9uID09PSAidW5kZWZpbmVkIiB8fCB0eXBlb2YgbGFuZ3VhZ2UgPT09ICJ1bmRlZmluZWQiIHx8IHR5cGVvZiBzb3VyY2VQYWNrYWdlVVJMID09PSAidW5kZWZpbmVkIiB8fCB0eXBlb2YgcnVudGltZVR5cGUgPT09ICJ1bmRlZmluZWQiIHx8IHR5cGVvZiBoeXBlcnR5Q2FwYWJpbGl0aWVzID09PSAidW5kZWZpbmVkIiB8fCB0eXBlb2YgcHJvdG9jb2xDYXBhYmlsaXRpZXMgPT09ICJ1bmRlZmluZWQiKSB0aHJvdyBuZXcgRXJyb3IoIkludmFsaWQgcGFyYW1ldGVycyEiKTsKCiAgICAgICAgICAgIHJldHVybiBuZXcgX0h5cGVydHlSdW50aW1lRGVzY3JpcHRvcjJbJ2RlZmF1bHQnXSh0aGlzLl9nZW5lcmF0ZUd1aWQoKSwgX0NhdGFsb2d1ZURhdGFPYmplY3QuQ2F0YWxvZ3VlT2JqZWN0VHlwZS5IWVBFUlRZX1JVTlRJTUUsIG9iamVjdE5hbWUsIGRlc2NyaXB0aW9uLCBsYW5ndWFnZSwgc291cmNlUGFja2FnZVVSTCwgcnVudGltZVR5cGUsIGh5cGVydHlDYXBhYmlsaXRpZXMsIHByb3RvY29sQ2FwYWJpbGl0aWVzKTsKICAgICAgICB9CiAgICB9LCB7CiAgICAgICAga2V5OiAnY3JlYXRlUG9saWN5RW5mb3JjZXJEZXNjcmlwdG9yT2JqZWN0JywKICAgICAgICB2YWx1ZTogZnVuY3Rpb24gY3JlYXRlUG9saWN5RW5mb3JjZXJEZXNjcmlwdG9yT2JqZWN0KG9iamVjdE5hbWUsIGRlc2NyaXB0aW9uLCBsYW5ndWFnZSwgc291cmNlUGFja2FnZVVSTCwgY29uZmlndXJhdGlvbiwgcG9saWNpZXMpIHsKICAgICAgICAgICAgaWYgKHR5cGVvZiBvYmplY3ROYW1lID09PSAidW5kZWZpbmVkIiB8fCB0eXBlb2YgZGVzY3JpcHRpb24gPT09ICJ1bmRlZmluZWQiIHx8IHR5cGVvZiBsYW5ndWFnZSA9PT0gInVuZGVmaW5lZCIgfHwgdHlwZW9mIHNvdXJjZVBhY2thZ2VVUkwgPT09ICJ1bmRlZmluZWQiIHx8IHR5cGVvZiBjb25maWd1cmF0aW9uID09PSAidW5kZWZpbmVkIiB8fCB0eXBlb2YgcG9saWNpZXMgPT09ICJ1bmRlZmluZWQiKSB0aHJvdyBuZXcgRXJyb3IoIkludmFsaWQgcGFyYW1ldGVycyEiKTsKCiAgICAgICAgICAgIHJldHVybiBuZXcgX1BvbGljeUVuZm9yY2VyRGVzY3JpcHRvcjJbJ2RlZmF1bHQnXSh0aGlzLl9nZW5lcmF0ZUd1aWQoKSwgX0NhdGFsb2d1ZURhdGFPYmplY3QuQ2F0YWxvZ3VlT2JqZWN0VHlwZS5QT0xJQ1lfRU5GT1JDRVIsIG9iamVjdE5hbWUsIGRlc2NyaXB0aW9uLCBsYW5ndWFnZSwgc291cmNlUGFja2FnZVVSTCwgY29uZmlndXJhdGlvbiwgcG9saWNpZXMpOwogICAgICAgIH0KICAgIH0sIHsKICAgICAgICBrZXk6ICdjcmVhdGVEYXRhT2JqZWN0U2NoZW1hJywKICAgICAgICB2YWx1ZTogZnVuY3Rpb24gY3JlYXRlRGF0YU9iamVjdFNjaGVtYSh0eXBlLCBvYmplY3ROYW1lLCBkZXNjcmlwdGlvbiwgbGFuZ3VhZ2UsIHNvdXJjZVBhY2thZ2VVUkwpIHsKICAgICAgICAgICAgaWYgKHR5cGVvZiB0eXBlID09PSAidW5kZWZpbmVkIiB8fCB0eXBlb2Ygb2JqZWN0TmFtZSA9PT0gInVuZGVmaW5lZCIgfHwgdHlwZW9mIGRlc2NyaXB0aW9uID09PSAidW5kZWZpbmVkIiB8fCB0eXBlb2YgbGFuZ3VhZ2UgPT09ICJ1bmRlZmluZWQiIHx8IHR5cGVvZiBzb3VyY2VQYWNrYWdlVVJMID09PSAidW5kZWZpbmVkIikgdGhyb3cgbmV3IEVycm9yKCJJbnZhbGlkIHBhcmFtZXRlcnMhIik7CgogICAgICAgICAgICByZXR1cm4gbmV3IF9EYXRhT2JqZWN0U2NoZW1hMlsnZGVmYXVsdCddKHRoaXMuX2dlbmVyYXRlR3VpZCgpLCB0eXBlLCBvYmplY3ROYW1lLCBkZXNjcmlwdGlvbiwgbGFuZ3VhZ2UsIHNvdXJjZVBhY2thZ2VVUkwpOwogICAgICAgIH0KICAgIH0sIHsKICAgICAgICBrZXk6ICdfZ2VuZXJhdGVHdWlkJywKICAgICAgICB2YWx1ZTogZnVuY3Rpb24gX2dlbmVyYXRlR3VpZCgpIHsKICAgICAgICAgICAgdmFyIGQgPSBuZXcgRGF0ZSgpLmdldFRpbWUoKTsKCiAgICAgICAgICAgIHJldHVybiAneHh4eHh4eHgteHh4eC00eHh4LXl4eHgteHh4eHh4eHh4eHh4Jy5yZXBsYWNlKC9beHldL2csIGZ1bmN0aW9uIChjKSB7CiAgICAgICAgICAgICAgICB2YXIgciA9IChkICsgTWF0aC5yYW5kb20oKSAqIDE2KSAlIDE2IHwgMDsKICAgICAgICAgICAgICAgIGQgPSBNYXRoLmZsb29yKGQgLyAxNik7CiAgICAgICAgICAgICAgICByZXR1cm4gKGMgPT0gJ3gnID8gciA6IHIgJiAweDMgfCAweDgpLnRvU3RyaW5nKDE2KTsKICAgICAgICAgICAgfSk7CiAgICAgICAgfQogICAgfV0pOwoKICAgIHJldHVybiBDYXRhbG9ndWVEYXRhT2JqZWN0RmFjdG9yeTsKfSkoX3JlVEhJTktPYmplY3RSZXRoaW5rT2JqZWN0MlsnZGVmYXVsdCddKTsKCmV4cG9ydHNbJ2RlZmF1bHQnXSA9IENhdGFsb2d1ZURhdGFPYmplY3RGYWN0b3J5Owptb2R1bGUuZXhwb3J0cyA9IGV4cG9ydHNbJ2RlZmF1bHQnXTsKCn0seyIuLi9yZVRISU5LT2JqZWN0L1JldGhpbmtPYmplY3QiOjE3LCIuL0NhdGFsb2d1ZURhdGFPYmplY3QiOjQsIi4vRGF0YU9iamVjdFNjaGVtYSI6NiwiLi9IeXBlcnR5RGVzY3JpcHRvciI6NywiLi9IeXBlcnR5UnVudGltZURlc2NyaXB0b3IiOjgsIi4vUG9saWN5RW5mb3JjZXJEZXNjcmlwdG9yIjo5LCIuL1Byb3RvY29sU3R1YkRlc2NyaXB0b3IiOjEwLCIuL1NvdXJjZVBhY2thZ2UiOjExfV0sNjpbZnVuY3Rpb24ocmVxdWlyZSxtb2R1bGUsZXhwb3J0cyl7Ci8qKgogKiBDcmVhdGVkIGJ5IHB6dSBvbiAxOS4xMS4xNS4KICovCgondXNlIHN0cmljdCc7CgpPYmplY3QuZGVmaW5lUHJvcGVydHkoZXhwb3J0cywgJ19fZXNNb2R1bGUnLCB7CiAgICB2YWx1ZTogdHJ1ZQp9KTsKCnZhciBfZ2V0ID0gZnVuY3Rpb24gZ2V0KF94LCBfeDIsIF94MykgeyB2YXIgX2FnYWluID0gdHJ1ZTsgX2Z1bmN0aW9uOiB3aGlsZSAoX2FnYWluKSB7IHZhciBvYmplY3QgPSBfeCwgcHJvcGVydHkgPSBfeDIsIHJlY2VpdmVyID0gX3gzOyBfYWdhaW4gPSBmYWxzZTsgaWYgKG9iamVjdCA9PT0gbnVsbCkgb2JqZWN0ID0gRnVuY3Rpb24ucHJvdG90eXBlOyB2YXIgZGVzYyA9IE9iamVjdC5nZXRPd25Qcm9wZXJ0eURlc2NyaXB0b3Iob2JqZWN0LCBwcm9wZXJ0eSk7IGlmIChkZXNjID09PSB1bmRlZmluZWQpIHsgdmFyIHBhcmVudCA9IE9iamVjdC5nZXRQcm90b3R5cGVPZihvYmplY3QpOyBpZiAocGFyZW50ID09PSBudWxsKSB7IHJldHVybiB1bmRlZmluZWQ7IH0gZWxzZSB7IF94ID0gcGFyZW50OyBfeDIgPSBwcm9wZXJ0eTsgX3gzID0gcmVjZWl2ZXI7IF9hZ2FpbiA9IHRydWU7IGRlc2MgPSBwYXJlbnQgPSB1bmRlZmluZWQ7IGNvbnRpbnVlIF9mdW5jdGlvbjsgfSB9IGVsc2UgaWYgKCd2YWx1ZScgaW4gZGVzYykgeyByZXR1cm4gZGVzYy52YWx1ZTsgfSBlbHNlIHsgdmFyIGdldHRlciA9IGRlc2MuZ2V0OyBpZiAoZ2V0dGVyID09PSB1bmRlZmluZWQpIHsgcmV0dXJuIHVuZGVmaW5lZDsgfSByZXR1cm4gZ2V0dGVyLmNhbGwocmVjZWl2ZXIpOyB9IH0gfTsKCmZ1bmN0aW9uIF9pbnRlcm9wUmVxdWlyZURlZmF1bHQob2JqKSB7IHJldHVybiBvYmogJiYgb2JqLl9fZXNNb2R1bGUgPyBvYmogOiB7ICdkZWZhdWx0Jzogb2JqIH07IH0KCmZ1bmN0aW9uIF9jbGFzc0NhbGxDaGVjayhpbnN0YW5jZSwgQ29uc3RydWN0b3IpIHsgaWYgKCEoaW5zdGFuY2UgaW5zdGFuY2VvZiBDb25zdHJ1Y3RvcikpIHsgdGhyb3cgbmV3IFR5cGVFcnJvcignQ2Fubm90IGNhbGwgYSBjbGFzcyBhcyBhIGZ1bmN0aW9uJyk7IH0gfQoKZnVuY3Rpb24gX2luaGVyaXRzKHN1YkNsYXNzLCBzdXBlckNsYXNzKSB7IGlmICh0eXBlb2Ygc3VwZXJDbGFzcyAhPT0gJ2Z1bmN0aW9uJyAmJiBzdXBlckNsYXNzICE9PSBudWxsKSB7IHRocm93IG5ldyBUeXBlRXJyb3IoJ1N1cGVyIGV4cHJlc3Npb24gbXVzdCBlaXRoZXIgYmUgbnVsbCBvciBhIGZ1bmN0aW9uLCBub3QgJyArIHR5cGVvZiBzdXBlckNsYXNzKTsgfSBzdWJDbGFzcy5wcm90b3R5cGUgPSBPYmplY3QuY3JlYXRlKHN1cGVyQ2xhc3MgJiYgc3VwZXJDbGFzcy5wcm90b3R5cGUsIHsgY29uc3RydWN0b3I6IHsgdmFsdWU6IHN1YkNsYXNzLCBlbnVtZXJhYmxlOiBmYWxzZSwgd3JpdGFibGU6IHRydWUsIGNvbmZpZ3VyYWJsZTogdHJ1ZSB9IH0pOyBpZiAoc3VwZXJDbGFzcykgT2JqZWN0LnNldFByb3RvdHlwZU9mID8gT2JqZWN0LnNldFByb3RvdHlwZU9mKHN1YkNsYXNzLCBzdXBlckNsYXNzKSA6IHN1YkNsYXNzLl9fcHJvdG9fXyA9IHN1cGVyQ2xhc3M7IH0KCnZhciBfQ2F0YWxvZ3VlRGF0YU9iamVjdDIgPSByZXF1aXJlKCcuL0NhdGFsb2d1ZURhdGFPYmplY3QnKTsKCnZhciBfQ2F0YWxvZ3VlRGF0YU9iamVjdDMgPSBfaW50ZXJvcFJlcXVpcmVEZWZhdWx0KF9DYXRhbG9ndWVEYXRhT2JqZWN0Mik7Cgp2YXIgRGF0YU9iamVjdFNjaGVtYSA9IChmdW5jdGlvbiAoX0NhdGFsb2d1ZURhdGFPYmplY3QpIHsKICAgIF9pbmhlcml0cyhEYXRhT2JqZWN0U2NoZW1hLCBfQ2F0YWxvZ3VlRGF0YU9iamVjdCk7CgogICAgZnVuY3Rpb24gRGF0YU9iamVjdFNjaGVtYShndWlkLCB0eXBlLCBvYmplY3ROYW1lLCBkZXNjcmlwdGlvbiwgbGFuZ3VhZ2UsIHNvdXJjZVBhY2thZ2VVUkwpIHsKICAgICAgICBfY2xhc3NDYWxsQ2hlY2sodGhpcywgRGF0YU9iamVjdFNjaGVtYSk7CgogICAgICAgIF9nZXQoT2JqZWN0LmdldFByb3RvdHlwZU9mKERhdGFPYmplY3RTY2hlbWEucHJvdG90eXBlKSwgJ2NvbnN0cnVjdG9yJywgdGhpcykuY2FsbCh0aGlzLCBndWlkLCB0eXBlLCBvYmplY3ROYW1lLCBkZXNjcmlwdGlvbiwgbGFuZ3VhZ2UsIHNvdXJjZVBhY2thZ2VVUkwpOwogICAgfQoKICAgIC8vQ2hpbGRyZW4KICAgIHJldHVybiBEYXRhT2JqZWN0U2NoZW1hOwp9KShfQ2F0YWxvZ3VlRGF0YU9iamVjdDNbJ2RlZmF1bHQnXSk7Cgp2YXIgTWVzc2FnZURhdGFPYmplY3RTY2hlbWEgPSAoZnVuY3Rpb24gKF9EYXRhT2JqZWN0U2NoZW1hKSB7CiAgICBfaW5oZXJpdHMoTWVzc2FnZURhdGFPYmplY3RTY2hlbWEsIF9EYXRhT2JqZWN0U2NoZW1hKTsKCiAgICBmdW5jdGlvbiBNZXNzYWdlRGF0YU9iamVjdFNjaGVtYShndWlkLCB0eXBlLCBvYmplY3ROYW1lLCBkZXNjcmlwdGlvbiwgbGFuZ3VhZ2UsIHNvdXJjZVBhY2thZ2VVUkwpIHsKICAgICAgICBfY2xhc3NDYWxsQ2hlY2sodGhpcywgTWVzc2FnZURhdGFPYmplY3RTY2hlbWEpOwoKICAgICAgICBfZ2V0KE9iamVjdC5nZXRQcm90b3R5cGVPZihNZXNzYWdlRGF0YU9iamVjdFNjaGVtYS5wcm90b3R5cGUpLCAnY29uc3RydWN0b3InLCB0aGlzKS5jYWxsKHRoaXMsIGd1aWQsIHR5cGUsIG9iamVjdE5hbWUsIGRlc2NyaXB0aW9uLCBsYW5ndWFnZSwgc291cmNlUGFja2FnZVVSTCk7CiAgICB9CgogICAgcmV0dXJuIE1lc3NhZ2VEYXRhT2JqZWN0U2NoZW1hOwp9KShEYXRhT2JqZWN0U2NoZW1hKTsKCmV4cG9ydHMuTWVzc2FnZURhdGFPYmplY3RTY2hlbWEgPSBNZXNzYWdlRGF0YU9iamVjdFNjaGVtYTsKCnZhciBIeXBlcnR5RGF0YU9iamVjdFNjaGVtYSA9IChmdW5jdGlvbiAoX0RhdGFPYmplY3RTY2hlbWEyKSB7CiAgICBfaW5oZXJpdHMoSHlwZXJ0eURhdGFPYmplY3RTY2hlbWEsIF9EYXRhT2JqZWN0U2NoZW1hMik7CgogICAgZnVuY3Rpb24gSHlwZXJ0eURhdGFPYmplY3RTY2hlbWEoZ3VpZCwgdHlwZSwgb2JqZWN0TmFtZSwgZGVzY3JpcHRpb24sIGxhbmd1YWdlLCBzb3VyY2VQYWNrYWdlVVJMLCBhY2Nlc3NDb250cm9sUG9saWN5KSB7CiAgICAgICAgX2NsYXNzQ2FsbENoZWNrKHRoaXMsIEh5cGVydHlEYXRhT2JqZWN0U2NoZW1hKTsKCiAgICAgICAgX2dldChPYmplY3QuZ2V0UHJvdG90eXBlT2YoSHlwZXJ0eURhdGFPYmplY3RTY2hlbWEucHJvdG90eXBlKSwgJ2NvbnN0cnVjdG9yJywgdGhpcykuY2FsbCh0aGlzLCBndWlkLCB0eXBlLCBvYmplY3ROYW1lLCBkZXNjcmlwdGlvbiwgbGFuZ3VhZ2UsIHNvdXJjZVBhY2thZ2VVUkwpOwogICAgICAgIHRoaXMuX2FjY2Vzc0NvbnRyb2xQb2xpY3kgPSBhY2Nlc3NDb250cm9sUG9saWN5OwogICAgfQoKICAgIC8vQ2hpbGRyZW4KICAgIHJldHVybiBIeXBlcnR5RGF0YU9iamVjdFNjaGVtYTsKfSkoRGF0YU9iamVjdFNjaGVtYSk7CgpleHBvcnRzLkh5cGVydHlEYXRhT2JqZWN0U2NoZW1hID0gSHlwZXJ0eURhdGFPYmplY3RTY2hlbWE7Cgp2YXIgQ29tbXVuaWNhdGlvbkRhdGFPYmplY3RTY2hlbWEgPSAoZnVuY3Rpb24gKF9IeXBlcnR5RGF0YU9iamVjdFNjaGVtYSkgewogICAgX2luaGVyaXRzKENvbW11bmljYXRpb25EYXRhT2JqZWN0U2NoZW1hLCBfSHlwZXJ0eURhdGFPYmplY3RTY2hlbWEpOwoKICAgIGZ1bmN0aW9uIENvbW11bmljYXRpb25EYXRhT2JqZWN0U2NoZW1hKGd1aWQsIHR5cGUsIG9iamVjdE5hbWUsIGRlc2NyaXB0aW9uLCBsYW5ndWFnZSwgc291cmNlUGFja2FnZVVSTCwgYWNjZXNzQ29udHJvbFBvbGljeSkgewogICAgICAgIF9jbGFzc0NhbGxDaGVjayh0aGlzLCBDb21tdW5pY2F0aW9uRGF0YU9iamVjdFNjaGVtYSk7CgogICAgICAgIF9nZXQoT2JqZWN0LmdldFByb3RvdHlwZU9mKENvbW11bmljYXRpb25EYXRhT2JqZWN0U2NoZW1hLnByb3RvdHlwZSksICdjb25zdHJ1Y3RvcicsIHRoaXMpLmNhbGwodGhpcywgZ3VpZCwgdHlwZSwgb2JqZWN0TmFtZSwgZGVzY3JpcHRpb24sIGxhbmd1YWdlLCBzb3VyY2VQYWNrYWdlVVJMLCBhY2Nlc3NDb250cm9sUG9saWN5KTsKICAgIH0KCiAgICByZXR1cm4gQ29tbXVuaWNhdGlvbkRhdGFPYmplY3RTY2hlbWE7Cn0pKEh5cGVydHlEYXRhT2JqZWN0U2NoZW1hKTsKCmV4cG9ydHMuQ29tbXVuaWNhdGlvbkRhdGFPYmplY3RTY2hlbWEgPSBDb21tdW5pY2F0aW9uRGF0YU9iamVjdFNjaGVtYTsKCnZhciBDb25uZWN0aW9uRGF0YU9iamVjdFNjaGVtYSA9IChmdW5jdGlvbiAoX0h5cGVydHlEYXRhT2JqZWN0U2NoZW1hMikgewogICAgX2luaGVyaXRzKENvbm5lY3Rpb25EYXRhT2JqZWN0U2NoZW1hLCBfSHlwZXJ0eURhdGFPYmplY3RTY2hlbWEyKTsKCiAgICBmdW5jdGlvbiBDb25uZWN0aW9uRGF0YU9iamVjdFNjaGVtYShndWlkLCB0eXBlLCBvYmplY3ROYW1lLCBkZXNjcmlwdGlvbiwgbGFuZ3VhZ2UsIHNvdXJjZVBhY2thZ2VVUkwsIGFjY2Vzc0NvbnRyb2xQb2xpY3kpIHsKICAgICAgICBfY2xhc3NDYWxsQ2hlY2sodGhpcywgQ29ubmVjdGlvbkRhdGFPYmplY3RTY2hlbWEpOwoKICAgICAgICBfZ2V0KE9iamVjdC5nZXRQcm90b3R5cGVPZihDb25uZWN0aW9uRGF0YU9iamVjdFNjaGVtYS5wcm90b3R5cGUpLCAnY29uc3RydWN0b3InLCB0aGlzKS5jYWxsKHRoaXMsIGd1aWQsIHR5cGUsIG9iamVjdE5hbWUsIGRlc2NyaXB0aW9uLCBsYW5ndWFnZSwgc291cmNlUGFja2FnZVVSTCwgYWNjZXNzQ29udHJvbFBvbGljeSk7CiAgICB9CgogICAgcmV0dXJuIENvbm5lY3Rpb25EYXRhT2JqZWN0U2NoZW1hOwp9KShIeXBlcnR5RGF0YU9iamVjdFNjaGVtYSk7CgpleHBvcnRzLkNvbm5lY3Rpb25EYXRhT2JqZWN0U2NoZW1hID0gQ29ubmVjdGlvbkRhdGFPYmplY3RTY2hlbWE7Cgp2YXIgSWRlbnRpZnlEYXRhT2JqZWN0U2NoZW1hID0gKGZ1bmN0aW9uIChfSHlwZXJ0eURhdGFPYmplY3RTY2hlbWEzKSB7CiAgICBfaW5oZXJpdHMoSWRlbnRpZnlEYXRhT2JqZWN0U2NoZW1hLCBfSHlwZXJ0eURhdGFPYmplY3RTY2hlbWEzKTsKCiAgICBmdW5jdGlvbiBJZGVudGlmeURhdGFPYmplY3RTY2hlbWEoZ3VpZCwgdHlwZSwgb2JqZWN0TmFtZSwgZGVzY3JpcHRpb24sIGxhbmd1YWdlLCBzb3VyY2VQYWNrYWdlVVJMLCBhY2Nlc3NDb250cm9sUG9saWN5KSB7CiAgICAgICAgX2NsYXNzQ2FsbENoZWNrKHRoaXMsIElkZW50aWZ5RGF0YU9iamVjdFNjaGVtYSk7CgogICAgICAgIF9nZXQoT2JqZWN0LmdldFByb3RvdHlwZU9mKElkZW50aWZ5RGF0YU9iamVjdFNjaGVtYS5wcm90b3R5cGUpLCAnY29uc3RydWN0b3InLCB0aGlzKS5jYWxsKHRoaXMsIGd1aWQsIHR5cGUsIG9iamVjdE5hbWUsIGRlc2NyaXB0aW9uLCBsYW5ndWFnZSwgc291cmNlUGFja2FnZVVSTCwgYWNjZXNzQ29udHJvbFBvbGljeSk7CiAgICB9CgogICAgcmV0dXJuIElkZW50aWZ5RGF0YU9iamVjdFNjaGVtYTsKfSkoSHlwZXJ0eURhdGFPYmplY3RTY2hlbWEpOwoKZXhwb3J0cy5JZGVudGlmeURhdGFPYmplY3RTY2hlbWEgPSBJZGVudGlmeURhdGFPYmplY3RTY2hlbWE7Cgp2YXIgQ29udGV4dERhdGFPYmplY3RTY2hlbWEgPSAoZnVuY3Rpb24gKF9IeXBlcnR5RGF0YU9iamVjdFNjaGVtYTQpIHsKICAgIF9pbmhlcml0cyhDb250ZXh0RGF0YU9iamVjdFNjaGVtYSwgX0h5cGVydHlEYXRhT2JqZWN0U2NoZW1hNCk7CgogICAgZnVuY3Rpb24gQ29udGV4dERhdGFPYmplY3RTY2hlbWEoZ3VpZCwgdHlwZSwgb2JqZWN0TmFtZSwgZGVzY3JpcHRpb24sIGxhbmd1YWdlLCBzb3VyY2VQYWNrYWdlVVJMLCBhY2Nlc3NDb250cm9sUG9saWN5KSB7CiAgICAgICAgX2NsYXNzQ2FsbENoZWNrKHRoaXMsIENvbnRleHREYXRhT2JqZWN0U2NoZW1hKTsKCiAgICAgICAgX2dldChPYmplY3QuZ2V0UHJvdG90eXBlT2YoQ29udGV4dERhdGFPYmplY3RTY2hlbWEucHJvdG90eXBlKSwgJ2NvbnN0cnVjdG9yJywgdGhpcykuY2FsbCh0aGlzLCBndWlkLCB0eXBlLCBvYmplY3ROYW1lLCBkZXNjcmlwdGlvbiwgbGFuZ3VhZ2UsIHNvdXJjZVBhY2thZ2VVUkwsIGFjY2Vzc0NvbnRyb2xQb2xpY3kpOwogICAgfQoKICAgIHJldHVybiBDb250ZXh0RGF0YU9iamVjdFNjaGVtYTsKfSkoSHlwZXJ0eURhdGFPYmplY3RTY2hlbWEpOwoKZXhwb3J0cy5Db250ZXh0RGF0YU9iamVjdFNjaGVtYSA9IENvbnRleHREYXRhT2JqZWN0U2NoZW1hOwpleHBvcnRzWydkZWZhdWx0J10gPSBEYXRhT2JqZWN0U2NoZW1hOwoKfSx7Ii4vQ2F0YWxvZ3VlRGF0YU9iamVjdCI6NH1dLDc6W2Z1bmN0aW9uKHJlcXVpcmUsbW9kdWxlLGV4cG9ydHMpewovKioKICogQ3JlYXRlZCBieSBhbW8gb24gMTQvMTEvMjAxNS4KICovCid1c2Ugc3RyaWN0JzsKCk9iamVjdC5kZWZpbmVQcm9wZXJ0eShleHBvcnRzLCAnX19lc01vZHVsZScsIHsKICAgIHZhbHVlOiB0cnVlCn0pOwoKdmFyIF9jcmVhdGVDbGFzcyA9IChmdW5jdGlvbiAoKSB7IGZ1bmN0aW9uIGRlZmluZVByb3BlcnRpZXModGFyZ2V0LCBwcm9wcykgeyBmb3IgKHZhciBpID0gMDsgaSA8IHByb3BzLmxlbmd0aDsgaSsrKSB7IHZhciBkZXNjcmlwdG9yID0gcHJvcHNbaV07IGRlc2NyaXB0b3IuZW51bWVyYWJsZSA9IGRlc2NyaXB0b3IuZW51bWVyYWJsZSB8fCBmYWxzZTsgZGVzY3JpcHRvci5jb25maWd1cmFibGUgPSB0cnVlOyBpZiAoJ3ZhbHVlJyBpbiBkZXNjcmlwdG9yKSBkZXNjcmlwdG9yLndyaXRhYmxlID0gdHJ1ZTsgT2JqZWN0LmRlZmluZVByb3BlcnR5KHRhcmdldCwgZGVzY3JpcHRvci5rZXksIGRlc2NyaXB0b3IpOyB9IH0gcmV0dXJuIGZ1bmN0aW9uIChDb25zdHJ1Y3RvciwgcHJvdG9Qcm9wcywgc3RhdGljUHJvcHMpIHsgaWYgKHByb3RvUHJvcHMpIGRlZmluZVByb3BlcnRpZXMoQ29uc3RydWN0b3IucHJvdG90eXBlLCBwcm90b1Byb3BzKTsgaWYgKHN0YXRpY1Byb3BzKSBkZWZpbmVQcm9wZXJ0aWVzKENvbnN0cnVjdG9yLCBzdGF0aWNQcm9wcyk7IHJldHVybiBDb25zdHJ1Y3RvcjsgfTsgfSkoKTsKCnZhciBfZ2V0ID0gZnVuY3Rpb24gZ2V0KF94LCBfeDIsIF94MykgeyB2YXIgX2FnYWluID0gdHJ1ZTsgX2Z1bmN0aW9uOiB3aGlsZSAoX2FnYWluKSB7IHZhciBvYmplY3QgPSBfeCwgcHJvcGVydHkgPSBfeDIsIHJlY2VpdmVyID0gX3gzOyBfYWdhaW4gPSBmYWxzZTsgaWYgKG9iamVjdCA9PT0gbnVsbCkgb2JqZWN0ID0gRnVuY3Rpb24ucHJvdG90eXBlOyB2YXIgZGVzYyA9IE9iamVjdC5nZXRPd25Qcm9wZXJ0eURlc2NyaXB0b3Iob2JqZWN0LCBwcm9wZXJ0eSk7IGlmIChkZXNjID09PSB1bmRlZmluZWQpIHsgdmFyIHBhcmVudCA9IE9iamVjdC5nZXRQcm90b3R5cGVPZihvYmplY3QpOyBpZiAocGFyZW50ID09PSBudWxsKSB7IHJldHVybiB1bmRlZmluZWQ7IH0gZWxzZSB7IF94ID0gcGFyZW50OyBfeDIgPSBwcm9wZXJ0eTsgX3gzID0gcmVjZWl2ZXI7IF9hZ2FpbiA9IHRydWU7IGRlc2MgPSBwYXJlbnQgPSB1bmRlZmluZWQ7IGNvbnRpbnVlIF9mdW5jdGlvbjsgfSB9IGVsc2UgaWYgKCd2YWx1ZScgaW4gZGVzYykgeyByZXR1cm4gZGVzYy52YWx1ZTsgfSBlbHNlIHsgdmFyIGdldHRlciA9IGRlc2MuZ2V0OyBpZiAoZ2V0dGVyID09PSB1bmRlZmluZWQpIHsgcmV0dXJuIHVuZGVmaW5lZDsgfSByZXR1cm4gZ2V0dGVyLmNhbGwocmVjZWl2ZXIpOyB9IH0gfTsKCmZ1bmN0aW9uIF9pbnRlcm9wUmVxdWlyZURlZmF1bHQob2JqKSB7IHJldHVybiBvYmogJiYgb2JqLl9fZXNNb2R1bGUgPyBvYmogOiB7ICdkZWZhdWx0Jzogb2JqIH07IH0KCmZ1bmN0aW9uIF9jbGFzc0NhbGxDaGVjayhpbnN0YW5jZSwgQ29uc3RydWN0b3IpIHsgaWYgKCEoaW5zdGFuY2UgaW5zdGFuY2VvZiBDb25zdHJ1Y3RvcikpIHsgdGhyb3cgbmV3IFR5cGVFcnJvcignQ2Fubm90IGNhbGwgYSBjbGFzcyBhcyBhIGZ1bmN0aW9uJyk7IH0gfQoKZnVuY3Rpb24gX2luaGVyaXRzKHN1YkNsYXNzLCBzdXBlckNsYXNzKSB7IGlmICh0eXBlb2Ygc3VwZXJDbGFzcyAhPT0gJ2Z1bmN0aW9uJyAmJiBzdXBlckNsYXNzICE9PSBudWxsKSB7IHRocm93IG5ldyBUeXBlRXJyb3IoJ1N1cGVyIGV4cHJlc3Npb24gbXVzdCBlaXRoZXIgYmUgbnVsbCBvciBhIGZ1bmN0aW9uLCBub3QgJyArIHR5cGVvZiBzdXBlckNsYXNzKTsgfSBzdWJDbGFzcy5wcm90b3R5cGUgPSBPYmplY3QuY3JlYXRlKHN1cGVyQ2xhc3MgJiYgc3VwZXJDbGFzcy5wcm90b3R5cGUsIHsgY29uc3RydWN0b3I6IHsgdmFsdWU6IHN1YkNsYXNzLCBlbnVtZXJhYmxlOiBmYWxzZSwgd3JpdGFibGU6IHRydWUsIGNvbmZpZ3VyYWJsZTogdHJ1ZSB9IH0pOyBpZiAoc3VwZXJDbGFzcykgT2JqZWN0LnNldFByb3RvdHlwZU9mID8gT2JqZWN0LnNldFByb3RvdHlwZU9mKHN1YkNsYXNzLCBzdXBlckNsYXNzKSA6IHN1YkNsYXNzLl9fcHJvdG9fXyA9IHN1cGVyQ2xhc3M7IH0KCnZhciBfQ2F0YWxvZ3VlRGF0YU9iamVjdDIgPSByZXF1aXJlKCcuL0NhdGFsb2d1ZURhdGFPYmplY3QnKTsKCnZhciBfQ2F0YWxvZ3VlRGF0YU9iamVjdDMgPSBfaW50ZXJvcFJlcXVpcmVEZWZhdWx0KF9DYXRhbG9ndWVEYXRhT2JqZWN0Mik7Cgp2YXIgSHlwZXJ0eURlc2NyaXB0b3IgPSAoZnVuY3Rpb24gKF9DYXRhbG9ndWVEYXRhT2JqZWN0KSB7CiAgICBfaW5oZXJpdHMoSHlwZXJ0eURlc2NyaXB0b3IsIF9DYXRhbG9ndWVEYXRhT2JqZWN0KTsKCiAgICBmdW5jdGlvbiBIeXBlcnR5RGVzY3JpcHRvcihndWlkLCBjYXRhbG9ndWVUeXBlLCBvYmplY3ROYW1lLCBkZXNjcmlwdGlvbiwgbGFuZ3VhZ2UsIHNvdXJjZVBhY2thZ2VVUkwsIGh5cGVydHlUeXBlLCBkYXRhT2JqZWN0cykgewogICAgICAgIF9jbGFzc0NhbGxDaGVjayh0aGlzLCBIeXBlcnR5RGVzY3JpcHRvcik7CgogICAgICAgIF9nZXQoT2JqZWN0LmdldFByb3RvdHlwZU9mKEh5cGVydHlEZXNjcmlwdG9yLnByb3RvdHlwZSksICdjb25zdHJ1Y3RvcicsIHRoaXMpLmNhbGwodGhpcywgZ3VpZCwgY2F0YWxvZ3VlVHlwZSwgb2JqZWN0TmFtZSwgZGVzY3JpcHRpb24sIGxhbmd1YWdlLCBzb3VyY2VQYWNrYWdlVVJMKTsKCiAgICAgICAgdGhpcy5fY29uZmlndXJhdGlvbkRhdGFMaXN0ID0ge307CiAgICAgICAgdGhpcy5fcnVudGltZUNvbnN0cmFpbnRMaXN0ID0ge307CiAgICAgICAgdGhpcy5fcG9saWNpZXMgPSB7fTsKICAgICAgICB0aGlzLl9tZXNzYWdlU2NoZW1hID0gbnVsbDsKCiAgICAgICAgdGhpcy5faHlwZXJ0eVR5cGUgPSBoeXBlcnR5VHlwZTsKICAgICAgICB0aGlzLl9kYXRhT2JqZWN0cyA9IGRhdGFPYmplY3RzOwogICAgfQoKICAgIF9jcmVhdGVDbGFzcyhIeXBlcnR5RGVzY3JpcHRvciwgW3sKICAgICAgICBrZXk6ICdoeXBlcnR5VHlwZScsCiAgICAgICAgZ2V0OiBmdW5jdGlvbiBnZXQoKSB7CiAgICAgICAgICAgIHJldHVybiB0aGlzLl9oeXBlcnR5VHlwZTsKICAgICAgICB9LAogICAgICAgIHNldDogZnVuY3Rpb24gc2V0KGhUeXBlKSB7CiAgICAgICAgICAgIGlmIChoVHlwZSkgdGhpcy5faHlwZXJ0eVR5cGUgPSBoVHlwZTsKICAgICAgICB9CiAgICB9LCB7CiAgICAgICAga2V5OiAnZGF0YU9iamVjdHMnLAogICAgICAgIGdldDogZnVuY3Rpb24gZ2V0KCkgewogICAgICAgICAgICByZXR1cm4gdGhpcy5fZGF0YU9iamVjdHM7CiAgICAgICAgfSwKICAgICAgICBzZXQ6IGZ1bmN0aW9uIHNldChkYXRhT2JqZWN0VXJsKSB7CiAgICAgICAgICAgIGlmIChkYXRhT2JqZWN0VXJsKSB0aGlzLl9kYXRhT2JqZWN0cyA9IGRhdGFPYmplY3RVcmw7CiAgICAgICAgfQogICAgfSwgewogICAgICAgIGtleTogJ2NvbmZpZ3VyYXRpb25EYXRhTGlzdCcsCiAgICAgICAgZ2V0OiBmdW5jdGlvbiBnZXQoKSB7CiAgICAgICAgICAgIHJldHVybiB0aGlzLl9jb25maWd1cmF0aW9uRGF0YUxpc3Q7CiAgICAgICAgfSwKICAgICAgICBzZXQ6IGZ1bmN0aW9uIHNldChjb25maWdEYXRhTGlzdCkgewogICAgICAgICAgICBpZiAoY29uZmlnRGF0YUxpc3QpIHRoaXMuX2NvbmZpZ3VyYXRpb25EYXRhTGlzdCA9IGNvbmZpZ0RhdGFMaXN0OwogICAgICAgIH0KICAgIH0sIHsKICAgICAgICBrZXk6ICdydW50aW1lQ29uc3RyYWludExpc3QnLAogICAgICAgIGdldDogZnVuY3Rpb24gZ2V0KCkgewogICAgICAgICAgICByZXR1cm4gdGhpcy5fcnVudGltZUNvbnN0cmFpbnRMaXN0OwogICAgICAgIH0sCiAgICAgICAgc2V0OiBmdW5jdGlvbiBzZXQocnVudGltZUNvbnN0TGlzdCkgewogICAgICAgICAgICBpZiAocnVudGltZUNvbnN0TGlzdCkgdGhpcy5fcnVudGltZUNvbnN0cmFpbnRMaXN0ID0gcnVudGltZUNvbnN0TGlzdDsKICAgICAgICB9CiAgICB9LCB7CiAgICAgICAga2V5OiAnbWVzc2FnZVNjaGVtYScsCiAgICAgICAgZ2V0OiBmdW5jdGlvbiBnZXQoKSB7CiAgICAgICAgICAgIHJldHVybiB0aGlzLl9tZXNzYWdlU2NoZW1hOwogICAgICAgIH0sCiAgICAgICAgc2V0OiBmdW5jdGlvbiBzZXQobXNnU2NoZW1hKSB7CiAgICAgICAgICAgIGlmIChtc2dTY2hlbWEpIHRoaXMuX21lc3NhZ2VTY2hlbWEgPSBtc2dTY2hlbWE7CiAgICAgICAgfQogICAgfSwgewogICAgICAgIGtleTogJ3BvbGljaWVzJywKICAgICAgICBnZXQ6IGZ1bmN0aW9uIGdldCgpIHsKICAgICAgICAgICAgcmV0dXJuIHRoaXMuX3BvbGljaWVzOwogICAgICAgIH0sCiAgICAgICAgc2V0OiBmdW5jdGlvbiBzZXQocG9saWN5TGlzdCkgewogICAgICAgICAgICBpZiAocG9saWN5TGlzdCkgdGhpcy5fcG9saWNpZXMgPSBwb2xpY3lMaXN0OwogICAgICAgIH0KICAgIH1dKTsKCiAgICByZXR1cm4gSHlwZXJ0eURlc2NyaXB0b3I7Cn0pKF9DYXRhbG9ndWVEYXRhT2JqZWN0M1snZGVmYXVsdCddKTsKCnZhciBSdW50aW1lSHlwZXJ0eUNhcGFiaWxpdHlUeXBlID0ge307CmV4cG9ydHMuUnVudGltZUh5cGVydHlDYXBhYmlsaXR5VHlwZSA9IFJ1bnRpbWVIeXBlcnR5Q2FwYWJpbGl0eVR5cGU7CnZhciBIeXBlcnR5VHlwZSA9IHsgQ09NTVVOSUNBVE9SOiAnY29tbXVuaWNhdG9yJywgSURFTlRJVFk6ICdpZGVudGl0eScsIENPTlRFWFQ6ICdjb250ZXh0JyB9OwpleHBvcnRzLkh5cGVydHlUeXBlID0gSHlwZXJ0eVR5cGU7CmV4cG9ydHNbJ2RlZmF1bHQnXSA9IEh5cGVydHlEZXNjcmlwdG9yOwoKfSx7Ii4vQ2F0YWxvZ3VlRGF0YU9iamVjdCI6NH1dLDg6W2Z1bmN0aW9uKHJlcXVpcmUsbW9kdWxlLGV4cG9ydHMpewovKioKICogQ3JlYXRlZCBieSBhbW8gb24gMTQvMTEvMjAxNS4KICovCgondXNlIHN0cmljdCc7CgpPYmplY3QuZGVmaW5lUHJvcGVydHkoZXhwb3J0cywgJ19fZXNNb2R1bGUnLCB7CiAgICB2YWx1ZTogdHJ1ZQp9KTsKCnZhciBfY3JlYXRlQ2xhc3MgPSAoZnVuY3Rpb24gKCkgeyBmdW5jdGlvbiBkZWZpbmVQcm9wZXJ0aWVzKHRhcmdldCwgcHJvcHMpIHsgZm9yICh2YXIgaSA9IDA7IGkgPCBwcm9wcy5sZW5ndGg7IGkrKykgeyB2YXIgZGVzY3JpcHRvciA9IHByb3BzW2ldOyBkZXNjcmlwdG9yLmVudW1lcmFibGUgPSBkZXNjcmlwdG9yLmVudW1lcmFibGUgfHwgZmFsc2U7IGRlc2NyaXB0b3IuY29uZmlndXJhYmxlID0gdHJ1ZTsgaWYgKCd2YWx1ZScgaW4gZGVzY3JpcHRvcikgZGVzY3JpcHRvci53cml0YWJsZSA9IHRydWU7IE9iamVjdC5kZWZpbmVQcm9wZXJ0eSh0YXJnZXQsIGRlc2NyaXB0b3Iua2V5LCBkZXNjcmlwdG9yKTsgfSB9IHJldHVybiBmdW5jdGlvbiAoQ29uc3RydWN0b3IsIHByb3RvUHJvcHMsIHN0YXRpY1Byb3BzKSB7IGlmIChwcm90b1Byb3BzKSBkZWZpbmVQcm9wZXJ0aWVzKENvbnN0cnVjdG9yLnByb3RvdHlwZSwgcHJvdG9Qcm9wcyk7IGlmIChzdGF0aWNQcm9wcykgZGVmaW5lUHJvcGVydGllcyhDb25zdHJ1Y3Rvciwgc3RhdGljUHJvcHMpOyByZXR1cm4gQ29uc3RydWN0b3I7IH07IH0pKCk7Cgp2YXIgX2dldCA9IGZ1bmN0aW9uIGdldChfeCwgX3gyLCBfeDMpIHsgdmFyIF9hZ2FpbiA9IHRydWU7IF9mdW5jdGlvbjogd2hpbGUgKF9hZ2FpbikgeyB2YXIgb2JqZWN0ID0gX3gsIHByb3BlcnR5ID0gX3gyLCByZWNlaXZlciA9IF94MzsgX2FnYWluID0gZmFsc2U7IGlmIChvYmplY3QgPT09IG51bGwpIG9iamVjdCA9IEZ1bmN0aW9uLnByb3RvdHlwZTsgdmFyIGRlc2MgPSBPYmplY3QuZ2V0T3duUHJvcGVydHlEZXNjcmlwdG9yKG9iamVjdCwgcHJvcGVydHkpOyBpZiAoZGVzYyA9PT0gdW5kZWZpbmVkKSB7IHZhciBwYXJlbnQgPSBPYmplY3QuZ2V0UHJvdG90eXBlT2Yob2JqZWN0KTsgaWYgKHBhcmVudCA9PT0gbnVsbCkgeyByZXR1cm4gdW5kZWZpbmVkOyB9IGVsc2UgeyBfeCA9IHBhcmVudDsgX3gyID0gcHJvcGVydHk7IF94MyA9IHJlY2VpdmVyOyBfYWdhaW4gPSB0cnVlOyBkZXNjID0gcGFyZW50ID0gdW5kZWZpbmVkOyBjb250aW51ZSBfZnVuY3Rpb247IH0gfSBlbHNlIGlmICgndmFsdWUnIGluIGRlc2MpIHsgcmV0dXJuIGRlc2MudmFsdWU7IH0gZWxzZSB7IHZhciBnZXR0ZXIgPSBkZXNjLmdldDsgaWYgKGdldHRlciA9PT0gdW5kZWZpbmVkKSB7IHJldHVybiB1bmRlZmluZWQ7IH0gcmV0dXJuIGdldHRlci5jYWxsKHJlY2VpdmVyKTsgfSB9IH07CgpmdW5jdGlvbiBfaW50ZXJvcFJlcXVpcmVEZWZhdWx0KG9iaikgeyByZXR1cm4gb2JqICYmIG9iai5fX2VzTW9kdWxlID8gb2JqIDogeyAnZGVmYXVsdCc6IG9iaiB9OyB9CgpmdW5jdGlvbiBfY2xhc3NDYWxsQ2hlY2soaW5zdGFuY2UsIENvbnN0cnVjdG9yKSB7IGlmICghKGluc3RhbmNlIGluc3RhbmNlb2YgQ29uc3RydWN0b3IpKSB7IHRocm93IG5ldyBUeXBlRXJyb3IoJ0Nhbm5vdCBjYWxsIGEgY2xhc3MgYXMgYSBmdW5jdGlvbicpOyB9IH0KCmZ1bmN0aW9uIF9pbmhlcml0cyhzdWJDbGFzcywgc3VwZXJDbGFzcykgeyBpZiAodHlwZW9mIHN1cGVyQ2xhc3MgIT09ICdmdW5jdGlvbicgJiYgc3VwZXJDbGFzcyAhPT0gbnVsbCkgeyB0aHJvdyBuZXcgVHlwZUVycm9yKCdTdXBlciBleHByZXNzaW9uIG11c3QgZWl0aGVyIGJlIG51bGwgb3IgYSBmdW5jdGlvbiwgbm90ICcgKyB0eXBlb2Ygc3VwZXJDbGFzcyk7IH0gc3ViQ2xhc3MucHJvdG90eXBlID0gT2JqZWN0LmNyZWF0ZShzdXBlckNsYXNzICYmIHN1cGVyQ2xhc3MucHJvdG90eXBlLCB7IGNvbnN0cnVjdG9yOiB7IHZhbHVlOiBzdWJDbGFzcywgZW51bWVyYWJsZTogZmFsc2UsIHdyaXRhYmxlOiB0cnVlLCBjb25maWd1cmFibGU6IHRydWUgfSB9KTsgaWYgKHN1cGVyQ2xhc3MpIE9iamVjdC5zZXRQcm90b3R5cGVPZiA/IE9iamVjdC5zZXRQcm90b3R5cGVPZihzdWJDbGFzcywgc3VwZXJDbGFzcykgOiBzdWJDbGFzcy5fX3Byb3RvX18gPSBzdXBlckNsYXNzOyB9Cgp2YXIgX0NhdGFsb2d1ZURhdGFPYmplY3QyID0gcmVxdWlyZSgnLi9DYXRhbG9ndWVEYXRhT2JqZWN0Jyk7Cgp2YXIgX0NhdGFsb2d1ZURhdGFPYmplY3QzID0gX2ludGVyb3BSZXF1aXJlRGVmYXVsdChfQ2F0YWxvZ3VlRGF0YU9iamVjdDIpOwoKdmFyIEh5cGVydHlSdW50aW1lRGVzY3JpcHRvciA9IChmdW5jdGlvbiAoX0NhdGFsb2d1ZURhdGFPYmplY3QpIHsKICAgIF9pbmhlcml0cyhIeXBlcnR5UnVudGltZURlc2NyaXB0b3IsIF9DYXRhbG9ndWVEYXRhT2JqZWN0KTsKCiAgICBmdW5jdGlvbiBIeXBlcnR5UnVudGltZURlc2NyaXB0b3IoZ3VpZCwgY2F0YWxvZ3VlVHlwZSwgb2JqZWN0TmFtZSwgZGVzY3JpcHRpb24sIGxhbmd1YWdlLCBzb3VyY2VQYWNrYWdlVVJMLCBydW50aW1lVHlwZSwgaHlwZXJ0eUNhcGFiaWxpdGllcywgcHJvdG9jb2xDYXBhYmlsaXRpZXMpIHsKICAgICAgICBfY2xhc3NDYWxsQ2hlY2sodGhpcywgSHlwZXJ0eVJ1bnRpbWVEZXNjcmlwdG9yKTsKCiAgICAgICAgX2dldChPYmplY3QuZ2V0UHJvdG90eXBlT2YoSHlwZXJ0eVJ1bnRpbWVEZXNjcmlwdG9yLnByb3RvdHlwZSksICdjb25zdHJ1Y3RvcicsIHRoaXMpLmNhbGwodGhpcywgZ3VpZCwgY2F0YWxvZ3VlVHlwZSwgb2JqZWN0TmFtZSwgZGVzY3JpcHRpb24sIGxhbmd1YWdlLCBzb3VyY2VQYWNrYWdlVVJMKTsKCiAgICAgICAgdGhpcy5fcnVudGltZVR5cGUgPSBydW50aW1lVHlwZTsKICAgICAgICBpZiAoaHlwZXJ0eUNhcGFiaWxpdGllcykgdGhpcy5faHlwZXJ0eUNhcGFiaWxpdGllcyA9IGh5cGVydHlDYXBhYmlsaXRpZXM7ZWxzZSB0aGlzLl9oeXBlcnR5Q2FwYWJpbGl0aWVzID0ge307CiAgICAgICAgaWYgKHByb3RvY29sQ2FwYWJpbGl0aWVzKSB0aGlzLl9wcm90b2NvbENhcGFiaWxpdGllcyA9IHByb3RvY29sQ2FwYWJpbGl0aWVzO2Vsc2UgdGhpcy5fcHJvdG9jb2xDYXBhYmlsaXRpZXMgPSB7fTsKICAgIH0KCiAgICBfY3JlYXRlQ2xhc3MoSHlwZXJ0eVJ1bnRpbWVEZXNjcmlwdG9yLCBbewogICAgICAgIGtleTogJ3J1bnRpbWVUeXBlJywKICAgICAgICBnZXQ6IGZ1bmN0aW9uIGdldCgpIHsKICAgICAgICAgICAgcmV0dXJuIHRoaXMuX3J1bnRpbWVUeXBlOwogICAgICAgIH0KICAgIH0sIHsKICAgICAgICBrZXk6ICdoeXBlcnR5Q2FwYWJpbGl0aWVzJywKICAgICAgICBnZXQ6IGZ1bmN0aW9uIGdldCgpIHsKICAgICAgICAgICAgcmV0dXJuIHRoaXMuX2h5cGVydHlDYXBhYmlsaXRpZXM7CiAgICAgICAgfQogICAgfSwgewogICAgICAgIGtleTogJ3Byb3RvY29sQ2FwYWJpbGl0aWVzJywKICAgICAgICBnZXQ6IGZ1bmN0aW9uIGdldCgpIHsKICAgICAgICAgICAgcmV0dXJuIHRoaXMuX2h5cGVydHlDYXBhYmlsaXRpZXM7CiAgICAgICAgfQogICAgfV0pOwoKICAgIHJldHVybiBIeXBlcnR5UnVudGltZURlc2NyaXB0b3I7Cn0pKF9DYXRhbG9ndWVEYXRhT2JqZWN0M1snZGVmYXVsdCddKTsKCnZhciBSdW50aW1lVHlwZSA9IHsgQlJPV1NFUjogJ2Jyb3dzZXInLCBTVEFOREFMT05FOiAnc3RhbmRhbG9uZScsIFNFUlZFUjogJ3NlcnZlcicsIEdBVEVXQVk6ICdnYXRld2F5JyB9OwpleHBvcnRzLlJ1bnRpbWVUeXBlID0gUnVudGltZVR5cGU7CnZhciBSdW50aW1lSHlwZXJ0eUNhcGFiaWxpdHlUeXBlID0geyBNSUM6ICdtaWMnLCBDQU1FUkE6ICdjYW1lcmEnLCBTRU5TT1I6ICdzZW5zb3InLCBXRUJSVEM6ICd3ZWJydGMnLAogICAgT1JUQzogJ29ydGMnIH07CmV4cG9ydHMuUnVudGltZUh5cGVydHlDYXBhYmlsaXR5VHlwZSA9IFJ1bnRpbWVIeXBlcnR5Q2FwYWJpbGl0eVR5cGU7CnZhciBSdW50aW1lUHJvdG9jb2xDYXBhYmlsaXR5VHlwZSA9IHsgSFRUUDogJ2h0dHAnLCBIVFRQUzogJ2h0dHBzJywgV1M6ICd3cycsIFdTUzogJ3dzcycsIENPQVA6ICdjb2FwJywKICAgIERBVEFDSEFORUw6ICdkYXRhY2hhbm5lbCcgfTsKZXhwb3J0cy5SdW50aW1lUHJvdG9jb2xDYXBhYmlsaXR5VHlwZSA9IFJ1bnRpbWVQcm90b2NvbENhcGFiaWxpdHlUeXBlOwpleHBvcnRzWydkZWZhdWx0J10gPSBIeXBlcnR5UnVudGltZURlc2NyaXB0b3I7Cgp9LHsiLi9DYXRhbG9ndWVEYXRhT2JqZWN0Ijo0fV0sOTpbZnVuY3Rpb24ocmVxdWlyZSxtb2R1bGUsZXhwb3J0cyl7Ci8qKgogKiBDcmVhdGVkIGJ5IHB6dSBvbiAxOS4xMS4xNS4KICovCid1c2Ugc3RyaWN0JzsKCk9iamVjdC5kZWZpbmVQcm9wZXJ0eShleHBvcnRzLCAnX19lc01vZHVsZScsIHsKICAgIHZhbHVlOiB0cnVlCn0pOwoKdmFyIF9jcmVhdGVDbGFzcyA9IChmdW5jdGlvbiAoKSB7IGZ1bmN0aW9uIGRlZmluZVByb3BlcnRpZXModGFyZ2V0LCBwcm9wcykgeyBmb3IgKHZhciBpID0gMDsgaSA8IHByb3BzLmxlbmd0aDsgaSsrKSB7IHZhciBkZXNjcmlwdG9yID0gcHJvcHNbaV07IGRlc2NyaXB0b3IuZW51bWVyYWJsZSA9IGRlc2NyaXB0b3IuZW51bWVyYWJsZSB8fCBmYWxzZTsgZGVzY3JpcHRvci5jb25maWd1cmFibGUgPSB0cnVlOyBpZiAoJ3ZhbHVlJyBpbiBkZXNjcmlwdG9yKSBkZXNjcmlwdG9yLndyaXRhYmxlID0gdHJ1ZTsgT2JqZWN0LmRlZmluZVByb3BlcnR5KHRhcmdldCwgZGVzY3JpcHRvci5rZXksIGRlc2NyaXB0b3IpOyB9IH0gcmV0dXJuIGZ1bmN0aW9uIChDb25zdHJ1Y3RvciwgcHJvdG9Qcm9wcywgc3RhdGljUHJvcHMpIHsgaWYgKHByb3RvUHJvcHMpIGRlZmluZVByb3BlcnRpZXMoQ29uc3RydWN0b3IucHJvdG90eXBlLCBwcm90b1Byb3BzKTsgaWYgKHN0YXRpY1Byb3BzKSBkZWZpbmVQcm9wZXJ0aWVzKENvbnN0cnVjdG9yLCBzdGF0aWNQcm9wcyk7IHJldHVybiBDb25zdHJ1Y3RvcjsgfTsgfSkoKTsKCnZhciBfZ2V0ID0gZnVuY3Rpb24gZ2V0KF94LCBfeDIsIF94MykgeyB2YXIgX2FnYWluID0gdHJ1ZTsgX2Z1bmN0aW9uOiB3aGlsZSAoX2FnYWluKSB7IHZhciBvYmplY3QgPSBfeCwgcHJvcGVydHkgPSBfeDIsIHJlY2VpdmVyID0gX3gzOyBfYWdhaW4gPSBmYWxzZTsgaWYgKG9iamVjdCA9PT0gbnVsbCkgb2JqZWN0ID0gRnVuY3Rpb24ucHJvdG90eXBlOyB2YXIgZGVzYyA9IE9iamVjdC5nZXRPd25Qcm9wZXJ0eURlc2NyaXB0b3Iob2JqZWN0LCBwcm9wZXJ0eSk7IGlmIChkZXNjID09PSB1bmRlZmluZWQpIHsgdmFyIHBhcmVudCA9IE9iamVjdC5nZXRQcm90b3R5cGVPZihvYmplY3QpOyBpZiAocGFyZW50ID09PSBudWxsKSB7IHJldHVybiB1bmRlZmluZWQ7IH0gZWxzZSB7IF94ID0gcGFyZW50OyBfeDIgPSBwcm9wZXJ0eTsgX3gzID0gcmVjZWl2ZXI7IF9hZ2FpbiA9IHRydWU7IGRlc2MgPSBwYXJlbnQgPSB1bmRlZmluZWQ7IGNvbnRpbnVlIF9mdW5jdGlvbjsgfSB9IGVsc2UgaWYgKCd2YWx1ZScgaW4gZGVzYykgeyByZXR1cm4gZGVzYy52YWx1ZTsgfSBlbHNlIHsgdmFyIGdldHRlciA9IGRlc2MuZ2V0OyBpZiAoZ2V0dGVyID09PSB1bmRlZmluZWQpIHsgcmV0dXJuIHVuZGVmaW5lZDsgfSByZXR1cm4gZ2V0dGVyLmNhbGwocmVjZWl2ZXIpOyB9IH0gfTsKCmZ1bmN0aW9uIF9pbnRlcm9wUmVxdWlyZURlZmF1bHQob2JqKSB7IHJldHVybiBvYmogJiYgb2JqLl9fZXNNb2R1bGUgPyBvYmogOiB7ICdkZWZhdWx0Jzogb2JqIH07IH0KCmZ1bmN0aW9uIF9jbGFzc0NhbGxDaGVjayhpbnN0YW5jZSwgQ29uc3RydWN0b3IpIHsgaWYgKCEoaW5zdGFuY2UgaW5zdGFuY2VvZiBDb25zdHJ1Y3RvcikpIHsgdGhyb3cgbmV3IFR5cGVFcnJvcignQ2Fubm90IGNhbGwgYSBjbGFzcyBhcyBhIGZ1bmN0aW9uJyk7IH0gfQoKZnVuY3Rpb24gX2luaGVyaXRzKHN1YkNsYXNzLCBzdXBlckNsYXNzKSB7IGlmICh0eXBlb2Ygc3VwZXJDbGFzcyAhPT0gJ2Z1bmN0aW9uJyAmJiBzdXBlckNsYXNzICE9PSBudWxsKSB7IHRocm93IG5ldyBUeXBlRXJyb3IoJ1N1cGVyIGV4cHJlc3Npb24gbXVzdCBlaXRoZXIgYmUgbnVsbCBvciBhIGZ1bmN0aW9uLCBub3QgJyArIHR5cGVvZiBzdXBlckNsYXNzKTsgfSBzdWJDbGFzcy5wcm90b3R5cGUgPSBPYmplY3QuY3JlYXRlKHN1cGVyQ2xhc3MgJiYgc3VwZXJDbGFzcy5wcm90b3R5cGUsIHsgY29uc3RydWN0b3I6IHsgdmFsdWU6IHN1YkNsYXNzLCBlbnVtZXJhYmxlOiBmYWxzZSwgd3JpdGFibGU6IHRydWUsIGNvbmZpZ3VyYWJsZTogdHJ1ZSB9IH0pOyBpZiAoc3VwZXJDbGFzcykgT2JqZWN0LnNldFByb3RvdHlwZU9mID8gT2JqZWN0LnNldFByb3RvdHlwZU9mKHN1YkNsYXNzLCBzdXBlckNsYXNzKSA6IHN1YkNsYXNzLl9fcHJvdG9fXyA9IHN1cGVyQ2xhc3M7IH0KCnZhciBfQ2F0YWxvZ3VlRGF0YU9iamVjdDIgPSByZXF1aXJlKCcuL0NhdGFsb2d1ZURhdGFPYmplY3QnKTsKCnZhciBfQ2F0YWxvZ3VlRGF0YU9iamVjdDMgPSBfaW50ZXJvcFJlcXVpcmVEZWZhdWx0KF9DYXRhbG9ndWVEYXRhT2JqZWN0Mik7Cgp2YXIgUG9saWN5RW5mb3JjZXJEZXNjcmlwdG9yID0gKGZ1bmN0aW9uIChfQ2F0YWxvZ3VlRGF0YU9iamVjdCkgewogICAgX2luaGVyaXRzKFBvbGljeUVuZm9yY2VyRGVzY3JpcHRvciwgX0NhdGFsb2d1ZURhdGFPYmplY3QpOwoKICAgIGZ1bmN0aW9uIFBvbGljeUVuZm9yY2VyRGVzY3JpcHRvcihndWlkLCB0eXBlLCBvYmplY3ROYW1lLCBkZXNjcmlwdGlvbiwgbGFuZ3VhZ2UsIHNvdXJjZVBhY2thZ2VVUkwsIGNvbmZpZ3VyYXRpb24sIHBvbGljaWVzKSB7CiAgICAgICAgX2NsYXNzQ2FsbENoZWNrKHRoaXMsIFBvbGljeUVuZm9yY2VyRGVzY3JpcHRvcik7CgogICAgICAgIF9nZXQoT2JqZWN0LmdldFByb3RvdHlwZU9mKFBvbGljeUVuZm9yY2VyRGVzY3JpcHRvci5wcm90b3R5cGUpLCAnY29uc3RydWN0b3InLCB0aGlzKS5jYWxsKHRoaXMsIGd1aWQsIHR5cGUsIG9iamVjdE5hbWUsIGRlc2NyaXB0aW9uLCBsYW5ndWFnZSwgc291cmNlUGFja2FnZVVSTCk7CgogICAgICAgIHRoaXMuX2NvbmZpZ3VyYXRpb24gPSBjb25maWd1cmF0aW9uOwogICAgICAgIHRoaXMuX3BvbGljaWVzID0gcG9saWNpZXM7CiAgICB9CgogICAgX2NyZWF0ZUNsYXNzKFBvbGljeUVuZm9yY2VyRGVzY3JpcHRvciwgW3sKICAgICAgICBrZXk6ICdjb25maWd1cmF0aW9uJywKICAgICAgICBnZXQ6IGZ1bmN0aW9uIGdldCgpIHsKICAgICAgICAgICAgcmV0dXJuIHRoaXMuX2NvbmZpZ3VyYXRpb247CiAgICAgICAgfSwKICAgICAgICBzZXQ6IGZ1bmN0aW9uIHNldChjb25maWd1cmF0aW9uKSB7CiAgICAgICAgICAgIHRoaXMuX2NvbmZpZ3VyYXRpb24gPSBjb25maWd1cmF0aW9uOwogICAgICAgIH0KICAgIH0sIHsKICAgICAgICBrZXk6ICdwb2xpY2llcycsCiAgICAgICAgZ2V0OiBmdW5jdGlvbiBnZXQoKSB7CiAgICAgICAgICAgIHJldHVybiB0aGlzLl9wb2xpY2llczsKICAgICAgICB9LAogICAgICAgIHNldDogZnVuY3Rpb24gc2V0KHBvbGljaWVzKSB7CiAgICAgICAgICAgIHRoaXMuX3BvbGljaWVzID0gcG9saWNpZXM7CiAgICAgICAgfQogICAgfV0pOwoKICAgIHJldHVybiBQb2xpY3lFbmZvcmNlckRlc2NyaXB0b3I7Cn0pKF9DYXRhbG9ndWVEYXRhT2JqZWN0M1snZGVmYXVsdCddKTsKCmV4cG9ydHNbJ2RlZmF1bHQnXSA9IFBvbGljeUVuZm9yY2VyRGVzY3JpcHRvcjsKbW9kdWxlLmV4cG9ydHMgPSBleHBvcnRzWydkZWZhdWx0J107Cgp9LHsiLi9DYXRhbG9ndWVEYXRhT2JqZWN0Ijo0fV0sMTA6W2Z1bmN0aW9uKHJlcXVpcmUsbW9kdWxlLGV4cG9ydHMpewovKioKICogQ3JlYXRlZCBieSBhbW8gb24gMTQvMTEvMjAxNS4KICovCgondXNlIHN0cmljdCc7CgpPYmplY3QuZGVmaW5lUHJvcGVydHkoZXhwb3J0cywgJ19fZXNNb2R1bGUnLCB7CiAgICB2YWx1ZTogdHJ1ZQp9KTsKCnZhciBfY3JlYXRlQ2xhc3MgPSAoZnVuY3Rpb24gKCkgeyBmdW5jdGlvbiBkZWZpbmVQcm9wZXJ0aWVzKHRhcmdldCwgcHJvcHMpIHsgZm9yICh2YXIgaSA9IDA7IGkgPCBwcm9wcy5sZW5ndGg7IGkrKykgeyB2YXIgZGVzY3JpcHRvciA9IHByb3BzW2ldOyBkZXNjcmlwdG9yLmVudW1lcmFibGUgPSBkZXNjcmlwdG9yLmVudW1lcmFibGUgfHwgZmFsc2U7IGRlc2NyaXB0b3IuY29uZmlndXJhYmxlID0gdHJ1ZTsgaWYgKCd2YWx1ZScgaW4gZGVzY3JpcHRvcikgZGVzY3JpcHRvci53cml0YWJsZSA9IHRydWU7IE9iamVjdC5kZWZpbmVQcm9wZXJ0eSh0YXJnZXQsIGRlc2NyaXB0b3Iua2V5LCBkZXNjcmlwdG9yKTsgfSB9IHJldHVybiBmdW5jdGlvbiAoQ29uc3RydWN0b3IsIHByb3RvUHJvcHMsIHN0YXRpY1Byb3BzKSB7IGlmIChwcm90b1Byb3BzKSBkZWZpbmVQcm9wZXJ0aWVzKENvbnN0cnVjdG9yLnByb3RvdHlwZSwgcHJvdG9Qcm9wcyk7IGlmIChzdGF0aWNQcm9wcykgZGVmaW5lUHJvcGVydGllcyhDb25zdHJ1Y3Rvciwgc3RhdGljUHJvcHMpOyByZXR1cm4gQ29uc3RydWN0b3I7IH07IH0pKCk7Cgp2YXIgX2dldCA9IGZ1bmN0aW9uIGdldChfeCwgX3gyLCBfeDMpIHsgdmFyIF9hZ2FpbiA9IHRydWU7IF9mdW5jdGlvbjogd2hpbGUgKF9hZ2FpbikgeyB2YXIgb2JqZWN0ID0gX3gsIHByb3BlcnR5ID0gX3gyLCByZWNlaXZlciA9IF94MzsgX2FnYWluID0gZmFsc2U7IGlmIChvYmplY3QgPT09IG51bGwpIG9iamVjdCA9IEZ1bmN0aW9uLnByb3RvdHlwZTsgdmFyIGRlc2MgPSBPYmplY3QuZ2V0T3duUHJvcGVydHlEZXNjcmlwdG9yKG9iamVjdCwgcHJvcGVydHkpOyBpZiAoZGVzYyA9PT0gdW5kZWZpbmVkKSB7IHZhciBwYXJlbnQgPSBPYmplY3QuZ2V0UHJvdG90eXBlT2Yob2JqZWN0KTsgaWYgKHBhcmVudCA9PT0gbnVsbCkgeyByZXR1cm4gdW5kZWZpbmVkOyB9IGVsc2UgeyBfeCA9IHBhcmVudDsgX3gyID0gcHJvcGVydHk7IF94MyA9IHJlY2VpdmVyOyBfYWdhaW4gPSB0cnVlOyBkZXNjID0gcGFyZW50ID0gdW5kZWZpbmVkOyBjb250aW51ZSBfZnVuY3Rpb247IH0gfSBlbHNlIGlmICgndmFsdWUnIGluIGRlc2MpIHsgcmV0dXJuIGRlc2MudmFsdWU7IH0gZWxzZSB7IHZhciBnZXR0ZXIgPSBkZXNjLmdldDsgaWYgKGdldHRlciA9PT0gdW5kZWZpbmVkKSB7IHJldHVybiB1bmRlZmluZWQ7IH0gcmV0dXJuIGdldHRlci5jYWxsKHJlY2VpdmVyKTsgfSB9IH07CgpmdW5jdGlvbiBfaW50ZXJvcFJlcXVpcmVEZWZhdWx0KG9iaikgeyByZXR1cm4gb2JqICYmIG9iai5fX2VzTW9kdWxlID8gb2JqIDogeyAnZGVmYXVsdCc6IG9iaiB9OyB9CgpmdW5jdGlvbiBfY2xhc3NDYWxsQ2hlY2soaW5zdGFuY2UsIENvbnN0cnVjdG9yKSB7IGlmICghKGluc3RhbmNlIGluc3RhbmNlb2YgQ29uc3RydWN0b3IpKSB7IHRocm93IG5ldyBUeXBlRXJyb3IoJ0Nhbm5vdCBjYWxsIGEgY2xhc3MgYXMgYSBmdW5jdGlvbicpOyB9IH0KCmZ1bmN0aW9uIF9pbmhlcml0cyhzdWJDbGFzcywgc3VwZXJDbGFzcykgeyBpZiAodHlwZW9mIHN1cGVyQ2xhc3MgIT09ICdmdW5jdGlvbicgJiYgc3VwZXJDbGFzcyAhPT0gbnVsbCkgeyB0aHJvdyBuZXcgVHlwZUVycm9yKCdTdXBlciBleHByZXNzaW9uIG11c3QgZWl0aGVyIGJlIG51bGwgb3IgYSBmdW5jdGlvbiwgbm90ICcgKyB0eXBlb2Ygc3VwZXJDbGFzcyk7IH0gc3ViQ2xhc3MucHJvdG90eXBlID0gT2JqZWN0LmNyZWF0ZShzdXBlckNsYXNzICYmIHN1cGVyQ2xhc3MucHJvdG90eXBlLCB7IGNvbnN0cnVjdG9yOiB7IHZhbHVlOiBzdWJDbGFzcywgZW51bWVyYWJsZTogZmFsc2UsIHdyaXRhYmxlOiB0cnVlLCBjb25maWd1cmFibGU6IHRydWUgfSB9KTsgaWYgKHN1cGVyQ2xhc3MpIE9iamVjdC5zZXRQcm90b3R5cGVPZiA/IE9iamVjdC5zZXRQcm90b3R5cGVPZihzdWJDbGFzcywgc3VwZXJDbGFzcykgOiBzdWJDbGFzcy5fX3Byb3RvX18gPSBzdXBlckNsYXNzOyB9Cgp2YXIgX0NhdGFsb2d1ZURhdGFPYmplY3QyID0gcmVxdWlyZSgnLi9DYXRhbG9ndWVEYXRhT2JqZWN0Jyk7Cgp2YXIgX0NhdGFsb2d1ZURhdGFPYmplY3QzID0gX2ludGVyb3BSZXF1aXJlRGVmYXVsdChfQ2F0YWxvZ3VlRGF0YU9iamVjdDIpOwoKdmFyIF9IeXBlcnR5UnVudGltZURlc2NyaXB0b3IgPSByZXF1aXJlKCcuL0h5cGVydHlSdW50aW1lRGVzY3JpcHRvcicpOwoKdmFyIF9IeXBlcnR5UnVudGltZURlc2NyaXB0b3IyID0gX2ludGVyb3BSZXF1aXJlRGVmYXVsdChfSHlwZXJ0eVJ1bnRpbWVEZXNjcmlwdG9yKTsKCnZhciBQcm90b2NvbFN0dWJEZXNjcmlwdG9yID0gKGZ1bmN0aW9uIChfQ2F0YWxvZ3VlRGF0YU9iamVjdCkgewogICAgX2luaGVyaXRzKFByb3RvY29sU3R1YkRlc2NyaXB0b3IsIF9DYXRhbG9ndWVEYXRhT2JqZWN0KTsKCiAgICBmdW5jdGlvbiBQcm90b2NvbFN0dWJEZXNjcmlwdG9yKGd1aWQsIHR5cGUsIG9iamVjdE5hbWUsIGRlc2NyaXB0aW9uLCBsYW5ndWFnZSwgc291cmNlUGFja2FnZVVSTCwgbWVzc2FnZVNjaGVtYXMsIGNvbmZpZ3VyYXRpb25MaXN0LCBjb25zdHJhaW50TGlzdCkgewogICAgICAgIF9jbGFzc0NhbGxDaGVjayh0aGlzLCBQcm90b2NvbFN0dWJEZXNjcmlwdG9yKTsKCiAgICAgICAgX2dldChPYmplY3QuZ2V0UHJvdG90eXBlT2YoUHJvdG9jb2xTdHViRGVzY3JpcHRvci5wcm90b3R5cGUpLCAnY29uc3RydWN0b3InLCB0aGlzKS5jYWxsKHRoaXMsIGd1aWQsIHR5cGUsIG9iamVjdE5hbWUsIGRlc2NyaXB0aW9uLCBsYW5ndWFnZSwgc291cmNlUGFja2FnZVVSTCk7CgogICAgICAgIHRoaXMuX21lc3NhZ2VTY2hlbWFzID0gbWVzc2FnZVNjaGVtYXM7CiAgICAgICAgaWYgKGNvbmZpZ3VyYXRpb25MaXN0KSB0aGlzLl9jb25maWd1cmF0aW9uTGlzdCA9IGNvbmZpZ3VyYXRpb25MaXN0O2Vsc2UgdGhpcy5fY29uZmlndXJhdGlvbkxpc3QgPSB7fTsKCiAgICAgICAgaWYgKGNvbnN0cmFpbnRMaXN0KSB0aGlzLl9jb25zdHJhaW50c0xpc3QgPSBjb25zdHJhaW50TGlzdDtlbHNlIHRoaXMuX2NvbnN0cmFpbnRzTGlzdCA9IHt9OwogICAgfQoKICAgIF9jcmVhdGVDbGFzcyhQcm90b2NvbFN0dWJEZXNjcmlwdG9yLCBbewogICAgICAgIGtleTogJ21lc3NhZ2VTY2hlbWFzJywKICAgICAgICBnZXQ6IGZ1bmN0aW9uIGdldCgpIHsKICAgICAgICAgICAgcmV0dXJuIHRoaXMuX21lc3NhZ2VTY2hlbWFzOwogICAgICAgIH0KICAgIH0sIHsKICAgICAgICBrZXk6ICdjb25zdHJhaW50c0xpc3QnLAogICAgICAgIGdldDogZnVuY3Rpb24gZ2V0KCkgewogICAgICAgICAgICByZXR1cm4gdGhpcy5fY29uc3RyYWludHNMaXN0OwogICAgICAgIH0KICAgIH0sIHsKICAgICAgICBrZXk6ICdjb25maWd1cmF0aW9uTGlzdCcsCiAgICAgICAgZ2V0OiBmdW5jdGlvbiBnZXQoKSB7CiAgICAgICAgICAgIHJldHVybiB0aGlzLl9jb25maWd1cmF0aW9uTGlzdDsKICAgICAgICB9CiAgICB9XSk7CgogICAgcmV0dXJuIFByb3RvY29sU3R1YkRlc2NyaXB0b3I7Cn0pKF9DYXRhbG9ndWVEYXRhT2JqZWN0M1snZGVmYXVsdCddKTsKCmV4cG9ydHNbJ2RlZmF1bHQnXSA9IFByb3RvY29sU3R1YkRlc2NyaXB0b3I7Cm1vZHVsZS5leHBvcnRzID0gZXhwb3J0c1snZGVmYXVsdCddOwoKfSx7Ii4vQ2F0YWxvZ3VlRGF0YU9iamVjdCI6NCwiLi9IeXBlcnR5UnVudGltZURlc2NyaXB0b3IiOjh9XSwxMTpbZnVuY3Rpb24ocmVxdWlyZSxtb2R1bGUsZXhwb3J0cyl7Ci8qKgogKiBDcmVhdGVkIGJ5IGFtbyBvbiAxNC8xMS8yMDE1LgogKi8KInVzZSBzdHJpY3QiOwoKT2JqZWN0LmRlZmluZVByb3BlcnR5KGV4cG9ydHMsICJfX2VzTW9kdWxlIiwgewogICAgdmFsdWU6IHRydWUKfSk7Cgp2YXIgX2NyZWF0ZUNsYXNzID0gKGZ1bmN0aW9uICgpIHsgZnVuY3Rpb24gZGVmaW5lUHJvcGVydGllcyh0YXJnZXQsIHByb3BzKSB7IGZvciAodmFyIGkgPSAwOyBpIDwgcHJvcHMubGVuZ3RoOyBpKyspIHsgdmFyIGRlc2NyaXB0b3IgPSBwcm9wc1tpXTsgZGVzY3JpcHRvci5lbnVtZXJhYmxlID0gZGVzY3JpcHRvci5lbnVtZXJhYmxlIHx8IGZhbHNlOyBkZXNjcmlwdG9yLmNvbmZpZ3VyYWJsZSA9IHRydWU7IGlmICgidmFsdWUiIGluIGRlc2NyaXB0b3IpIGRlc2NyaXB0b3Iud3JpdGFibGUgPSB0cnVlOyBPYmplY3QuZGVmaW5lUHJvcGVydHkodGFyZ2V0LCBkZXNjcmlwdG9yLmtleSwgZGVzY3JpcHRvcik7IH0gfSByZXR1cm4gZnVuY3Rpb24gKENvbnN0cnVjdG9yLCBwcm90b1Byb3BzLCBzdGF0aWNQcm9wcykgeyBpZiAocHJvdG9Qcm9wcykgZGVmaW5lUHJvcGVydGllcyhDb25zdHJ1Y3Rvci5wcm90b3R5cGUsIHByb3RvUHJvcHMpOyBpZiAoc3RhdGljUHJvcHMpIGRlZmluZVByb3BlcnRpZXMoQ29uc3RydWN0b3IsIHN0YXRpY1Byb3BzKTsgcmV0dXJuIENvbnN0cnVjdG9yOyB9OyB9KSgpOwoKZnVuY3Rpb24gX2NsYXNzQ2FsbENoZWNrKGluc3RhbmNlLCBDb25zdHJ1Y3RvcikgeyBpZiAoIShpbnN0YW5jZSBpbnN0YW5jZW9mIENvbnN0cnVjdG9yKSkgeyB0aHJvdyBuZXcgVHlwZUVycm9yKCJDYW5ub3QgY2FsbCBhIGNsYXNzIGFzIGEgZnVuY3Rpb24iKTsgfSB9Cgp2YXIgU291cmNlUGFja2FnZSA9IChmdW5jdGlvbiAoKSB7CiAgICBmdW5jdGlvbiBTb3VyY2VQYWNrYWdlKHNvdXJjZUNvZGUsIHNvdXJjZUNvZGVDbGFzc25hbWUpIHsKICAgICAgICBfY2xhc3NDYWxsQ2hlY2sodGhpcywgU291cmNlUGFja2FnZSk7CgogICAgICAgIHRoaXMuX3NvdXJjZUNvZGUgPSBzb3VyY2VDb2RlOwogICAgICAgIHRoaXMuX3NvdXJjZUNvZGVDbGFzc25hbWUgPSBzb3VyY2VDb2RlQ2xhc3NuYW1lOwoKICAgICAgICB0aGlzLl9lbmNvZGluZyA9IG51bGw7CiAgICAgICAgdGhpcy5fc2lnbmF0dXJlID0gbnVsbDsKICAgIH0KCiAgICBfY3JlYXRlQ2xhc3MoU291cmNlUGFja2FnZSwgW3sKICAgICAgICBrZXk6ICJzb3VyY2VDb2RlIiwKICAgICAgICBnZXQ6IGZ1bmN0aW9uIGdldCgpIHsKICAgICAgICAgICAgcmV0dXJuIHRoaXMuX3NvdXJjZUNvZGU7CiAgICAgICAgfQogICAgfSwgewogICAgICAgIGtleTogInNvdXJjZUNvZGVDbGFzc25hbWUiLAogICAgICAgIGdldDogZnVuY3Rpb24gZ2V0KCkgewogICAgICAgICAgICByZXR1cm4gdGhpcy5fc291cmNlQ29kZTsKICAgICAgICB9CiAgICB9LCB7CiAgICAgICAga2V5OiAiZW5jb2RpbmciLAogICAgICAgIGdldDogZnVuY3Rpb24gZ2V0KCkgewogICAgICAgICAgICByZXR1cm4gdGhpcy5fZW5jb2Rpbmc7CiAgICAgICAgfSwKICAgICAgICBzZXQ6IGZ1bmN0aW9uIHNldChlbmNvZGluZykgewogICAgICAgICAgICBpZiAoZW5jb2RpbmcpIHRoaXMuX2VuY29kaW5nID0gZW5jb2Rpbmc7CiAgICAgICAgfQogICAgfSwgewogICAgICAgIGtleTogInNpZ25hdHVyZSIsCiAgICAgICAgZ2V0OiBmdW5jdGlvbiBnZXQoKSB7CiAgICAgICAgICAgIHJldHVybiB0aGlzLl9zaWduYXR1cmU7CiAgICAgICAgfSwKICAgICAgICBzZXQ6IGZ1bmN0aW9uIHNldChzaWduKSB7CiAgICAgICAgICAgIGlmIChzaWduKSB0aGlzLl9zaWduYXR1cmUgPSBzaWduOwogICAgICAgIH0KICAgIH1dKTsKCiAgICByZXR1cm4gU291cmNlUGFja2FnZTsKfSkoKTsKCmV4cG9ydHNbImRlZmF1bHQiXSA9IFNvdXJjZVBhY2thZ2U7Cm1vZHVsZS5leHBvcnRzID0gZXhwb3J0c1siZGVmYXVsdCJdOwoKfSx7fV0sMTI6W2Z1bmN0aW9uKHJlcXVpcmUsbW9kdWxlLGV4cG9ydHMpewondXNlIHN0cmljdCc7CgpPYmplY3QuZGVmaW5lUHJvcGVydHkoZXhwb3J0cywgJ19fZXNNb2R1bGUnLCB7CiAgdmFsdWU6IHRydWUKfSk7Cgp2YXIgX2NyZWF0ZUNsYXNzID0gKGZ1bmN0aW9uICgpIHsgZnVuY3Rpb24gZGVmaW5lUHJvcGVydGllcyh0YXJnZXQsIHByb3BzKSB7IGZvciAodmFyIGkgPSAwOyBpIDwgcHJvcHMubGVuZ3RoOyBpKyspIHsgdmFyIGRlc2NyaXB0b3IgPSBwcm9wc1tpXTsgZGVzY3JpcHRvci5lbnVtZXJhYmxlID0gZGVzY3JpcHRvci5lbnVtZXJhYmxlIHx8IGZhbHNlOyBkZXNjcmlwdG9yLmNvbmZpZ3VyYWJsZSA9IHRydWU7IGlmICgndmFsdWUnIGluIGRlc2NyaXB0b3IpIGRlc2NyaXB0b3Iud3JpdGFibGUgPSB0cnVlOyBPYmplY3QuZGVmaW5lUHJvcGVydHkodGFyZ2V0LCBkZXNjcmlwdG9yLmtleSwgZGVzY3JpcHRvcik7IH0gfSByZXR1cm4gZnVuY3Rpb24gKENvbnN0cnVjdG9yLCBwcm90b1Byb3BzLCBzdGF0aWNQcm9wcykgeyBpZiAocHJvdG9Qcm9wcykgZGVmaW5lUHJvcGVydGllcyhDb25zdHJ1Y3Rvci5wcm90b3R5cGUsIHByb3RvUHJvcHMpOyBpZiAoc3RhdGljUHJvcHMpIGRlZmluZVByb3BlcnRpZXMoQ29uc3RydWN0b3IsIHN0YXRpY1Byb3BzKTsgcmV0dXJuIENvbnN0cnVjdG9yOyB9OyB9KSgpOwoKdmFyIF9nZXQgPSBmdW5jdGlvbiBnZXQoX3gsIF94MiwgX3gzKSB7IHZhciBfYWdhaW4gPSB0cnVlOyBfZnVuY3Rpb246IHdoaWxlIChfYWdhaW4pIHsgdmFyIG9iamVjdCA9IF94LCBwcm9wZXJ0eSA9IF94MiwgcmVjZWl2ZXIgPSBfeDM7IF9hZ2FpbiA9IGZhbHNlOyBpZiAob2JqZWN0ID09PSBudWxsKSBvYmplY3QgPSBGdW5jdGlvbi5wcm90b3R5cGU7IHZhciBkZXNjID0gT2JqZWN0LmdldE93blByb3BlcnR5RGVzY3JpcHRvcihvYmplY3QsIHByb3BlcnR5KTsgaWYgKGRlc2MgPT09IHVuZGVmaW5lZCkgeyB2YXIgcGFyZW50ID0gT2JqZWN0LmdldFByb3RvdHlwZU9mKG9iamVjdCk7IGlmIChwYXJlbnQgPT09IG51bGwpIHsgcmV0dXJuIHVuZGVmaW5lZDsgfSBlbHNlIHsgX3ggPSBwYXJlbnQ7IF94MiA9IHByb3BlcnR5OyBfeDMgPSByZWNlaXZlcjsgX2FnYWluID0gdHJ1ZTsgZGVzYyA9IHBhcmVudCA9IHVuZGVmaW5lZDsgY29udGludWUgX2Z1bmN0aW9uOyB9IH0gZWxzZSBpZiAoJ3ZhbHVlJyBpbiBkZXNjKSB7IHJldHVybiBkZXNjLnZhbHVlOyB9IGVsc2UgeyB2YXIgZ2V0dGVyID0gZGVzYy5nZXQ7IGlmIChnZXR0ZXIgPT09IHVuZGVmaW5lZCkgeyByZXR1cm4gdW5kZWZpbmVkOyB9IHJldHVybiBnZXR0ZXIuY2FsbChyZWNlaXZlcik7IH0gfSB9OwoKZnVuY3Rpb24gX2ludGVyb3BSZXF1aXJlRGVmYXVsdChvYmopIHsgcmV0dXJuIG9iaiAmJiBvYmouX19lc01vZHVsZSA/IG9iaiA6IHsgJ2RlZmF1bHQnOiBvYmogfTsgfQoKZnVuY3Rpb24gX2NsYXNzQ2FsbENoZWNrKGluc3RhbmNlLCBDb25zdHJ1Y3RvcikgeyBpZiAoIShpbnN0YW5jZSBpbnN0YW5jZW9mIENvbnN0cnVjdG9yKSkgeyB0aHJvdyBuZXcgVHlwZUVycm9yKCdDYW5ub3QgY2FsbCBhIGNsYXNzIGFzIGEgZnVuY3Rpb24nKTsgfSB9CgpmdW5jdGlvbiBfaW5oZXJpdHMoc3ViQ2xhc3MsIHN1cGVyQ2xhc3MpIHsgaWYgKHR5cGVvZiBzdXBlckNsYXNzICE9PSAnZnVuY3Rpb24nICYmIHN1cGVyQ2xhc3MgIT09IG51bGwpIHsgdGhyb3cgbmV3IFR5cGVFcnJvcignU3VwZXIgZXhwcmVzc2lvbiBtdXN0IGVpdGhlciBiZSBudWxsIG9yIGEgZnVuY3Rpb24sIG5vdCAnICsgdHlwZW9mIHN1cGVyQ2xhc3MpOyB9IHN1YkNsYXNzLnByb3RvdHlwZSA9IE9iamVjdC5jcmVhdGUoc3VwZXJDbGFzcyAmJiBzdXBlckNsYXNzLnByb3RvdHlwZSwgeyBjb25zdHJ1Y3RvcjogeyB2YWx1ZTogc3ViQ2xhc3MsIGVudW1lcmFibGU6IGZhbHNlLCB3cml0YWJsZTogdHJ1ZSwgY29uZmlndXJhYmxlOiB0cnVlIH0gfSk7IGlmIChzdXBlckNsYXNzKSBPYmplY3Quc2V0UHJvdG90eXBlT2YgPyBPYmplY3Quc2V0UHJvdG90eXBlT2Yoc3ViQ2xhc3MsIHN1cGVyQ2xhc3MpIDogc3ViQ2xhc3MuX19wcm90b19fID0gc3VwZXJDbGFzczsgfQoKcmVxdWlyZSgnd2VicnRjLWFkYXB0ZXItdGVzdCcpOwoKdmFyIF91dGlsc0V2ZW50RW1pdHRlciA9IHJlcXVpcmUoJy4uL3V0aWxzL0V2ZW50RW1pdHRlcicpOwoKdmFyIF91dGlsc0V2ZW50RW1pdHRlcjIgPSBfaW50ZXJvcFJlcXVpcmVEZWZhdWx0KF91dGlsc0V2ZW50RW1pdHRlcik7Cgp2YXIgQ29ubmVjdGlvbkNvbnRyb2xsZXIgPSAoZnVuY3Rpb24gKF9FdmVudEVtaXR0ZXIpIHsKICBfaW5oZXJpdHMoQ29ubmVjdGlvbkNvbnRyb2xsZXIsIF9FdmVudEVtaXR0ZXIpOwoKICBmdW5jdGlvbiBDb25uZWN0aW9uQ29udHJvbGxlcigpIHsKICAgIF9jbGFzc0NhbGxDaGVjayh0aGlzLCBDb25uZWN0aW9uQ29udHJvbGxlcik7CgogICAgX2dldChPYmplY3QuZ2V0UHJvdG90eXBlT2YoQ29ubmVjdGlvbkNvbnRyb2xsZXIucHJvdG90eXBlKSwgJ2NvbnN0cnVjdG9yJywgdGhpcykuY2FsbCh0aGlzKTsKCiAgICB2YXIgX3RoaXMgPSB0aGlzOwoKICAgIF90aGlzLm1vZGUgPSAnb2ZmZXInOwoKICAgIF90aGlzLm1lZGlhQ29uc3RyYWludHMgPSB7CiAgICAgIG9wdGlvbmFsOiBbXSwKICAgICAgbWFuZGF0b3J5OiB7CiAgICAgICAgb2ZmZXJUb1JlY2VpdmVBdWRpbzogdHJ1ZSwKICAgICAgICBvZmZlclRvUmVjZWl2ZVZpZGVvOiB0cnVlCiAgICAgIH0KICAgIH07CgogICAgLy8gUHJlcGFyZSB0aGUgUGVlckNvbm5lY3Rpb24KICAgIHZhciBwZWVyQ29ubmVjdGlvbiA9IG5ldyBSVENQZWVyQ29ubmVjdGlvbigpOwoKICAgIHBlZXJDb25uZWN0aW9uLmFkZEV2ZW50TGlzdGVuZXIoJ3NpZ25hbGluZ3N0YXRlY2hhbmdlJywgZnVuY3Rpb24gKGV2ZW50KSB7CgogICAgICBpZiAoZXZlbnQuY3VycmVudFRhcmdldC5zaWduYWxpbmdTdGF0ZSA9PT0gJ2hhdmUtcmVtb3RlLW9mZmVyJykgewogICAgICAgIF90aGlzLm1vZGUgPSAnYW5zd2VyJzsKICAgICAgICBfdGhpcy50cmlnZ2VyKCdjb250cm9sbGVyOnN0YXRlOmNoYW5nZScsIF90aGlzLm1vZGUpOwogICAgICB9CgogICAgICBpZiAoZXZlbnQuY3VycmVudFRhcmdldC5zaWduYWxpbmdTdGF0ZSA9PT0gJ2hhdmUtbG9jYWwtb2ZmZXInKSB7CiAgICAgICAgX3RoaXMudHJpZ2dlcignY29udHJvbGxlcjpzdGF0ZTpjaGFuZ2UnLCBfdGhpcy5tb2RlKTsKICAgICAgfQogICAgfSk7CgogICAgcGVlckNvbm5lY3Rpb24uYWRkRXZlbnRMaXN0ZW5lcignaWNlY29ubmVjdGlvbnN0YXRlY2hhbmdlJywgZnVuY3Rpb24gKGV2ZW50KSB7CiAgICAgIGNvbnNvbGUuaW5mbyhldmVudC5jdXJyZW50VGFyZ2V0LmljZUNvbm5lY3Rpb25TdGF0ZSk7CiAgICB9KTsKCiAgICBwZWVyQ29ubmVjdGlvbi5hZGRFdmVudExpc3RlbmVyKCdpY2VjYW5kaWRhdGUnLCBmdW5jdGlvbiAoZXZlbnQpIHsKCiAgICAgIGlmICghZXZlbnQuY2FuZGlkYXRlKSByZXR1cm47CgogICAgICB2YXIgZGF0YSA9IF90aGlzLl9jb25uZWN0aW9uRGF0YU9iamVjdFJlcG9ydGVyLmRhdGE7CiAgICAgIGRhdGEuaWNlID0gewogICAgICAgIHR5cGU6ICdjYW5kaWRhdGUnLAogICAgICAgIGNhbmRpZGF0ZTogZXZlbnQuY2FuZGlkYXRlLmNhbmRpZGF0ZSwKICAgICAgICBzZHBNaWQ6IGV2ZW50LmNhbmRpZGF0ZS5zZHBNaWQsCiAgICAgICAgc2RwTUxpbmVJbmRleDogZXZlbnQuY2FuZGlkYXRlLnNkcE1MaW5lSW5kZXgKICAgICAgfTsKICAgIH0pOwoKICAgIC8vIEFkZCBzdHJlYW0gdG8gUGVlckNvbm5lY3Rpb24KICAgIHBlZXJDb25uZWN0aW9uLmFkZEV2ZW50TGlzdGVuZXIoJ2FkZHN0cmVhbScsIGZ1bmN0aW9uIChldmVudCkgewogICAgICBjb25zb2xlLmluZm8oJ2FkZCBzdHJlYW0gZnJvbSBtb2RlOiAnLCBfdGhpcy5tb2RlKTsKICAgICAgX3RoaXMudHJpZ2dlcignc3RyZWFtOmFkZGVkJywgVVJMLmNyZWF0ZU9iamVjdFVSTChldmVudC5zdHJlYW0pLCBfdGhpcy5jb25uZWN0aW9uRGF0YU9iamVjdFJlcG9ydGVyLCBfdGhpcy5jb25uZWN0aW9uRGF0YU9iamVjdE9ic2VydmVyKTsKICAgIH0pOwoKICAgIF90aGlzLnBlZXJDb25uZWN0aW9uID0gcGVlckNvbm5lY3Rpb247CiAgfQoKICAvKioKICAqIFNldCB0aGUgY29ubmVjdGlvbkRhdGFPYmplY3QgaW4gdGhlIGNvbnRyb2xsZXIKICAqIEBwYXJhbSB7Q29ubmVjdGlvbkRhdGFPYmplY3R9IGNvbm5lY3Rpb25EYXRhT2JqZWN0IC0gaGF2ZSBhbGwgaW5mb3JtYXRpb24gYWJvdXQgdGhlIHN5bmNoZXIgb2JqZWN0OwogICovCgogIF9jcmVhdGVDbGFzcyhDb25uZWN0aW9uQ29udHJvbGxlciwgW3sKICAgIGtleTogJ2dldFVzZXJNZWRpYScsCgogICAgLyoqCiAgICAgKiBHZXQgV2ViUlRDIEFQSSByZXNvdXJjZXMKICAgICAqIEBwYXJhbSAge09iamVjdH0gICAgIG9wdGlvbnMgT2JqZWN0IGNvbnRhaW5pbmcgdGhlIGluZm9ybWF0aW9uIHRoYXQgcmVzb3VyY2VzIHdpbGwgYmUgdXNlZCAoY2FtZXJhLCBtaWMsIHJlc29sdXRpb24sIGV0Yyk7CiAgICAgKiBAcmV0dXJuIHtQcm9taXNlfQogICAgICovCiAgICB2YWx1ZTogZnVuY3Rpb24gZ2V0VXNlck1lZGlhKGNvbnN0cmFpbnRzKSB7CgogICAgICB2YXIgX3RoaXMgPSB0aGlzOwoKICAgICAgcmV0dXJuIG5ldyBQcm9taXNlKGZ1bmN0aW9uIChyZXNvbHZlLCByZWplY3QpIHsKCiAgICAgICAgbmF2aWdhdG9yLm1lZGlhRGV2aWNlcy5nZXRVc2VyTWVkaWEoY29uc3RyYWludHMpLnRoZW4oZnVuY3Rpb24gKG1lZGlhU3RyZWFtKSB7CiAgICAgICAgICBfdGhpcy5wZWVyQ29ubmVjdGlvbi5hZGRTdHJlYW0obWVkaWFTdHJlYW0pOwogICAgICAgICAgcmVzb2x2ZShtZWRpYVN0cmVhbSk7CiAgICAgICAgfSlbJ2NhdGNoJ10oZnVuY3Rpb24gKHJlYXNvbikgewogICAgICAgICAgcmVqZWN0KHJlYXNvbik7CiAgICAgICAgfSk7CiAgICAgIH0pOwogICAgfQogIH0sIHsKICAgIGtleTogJ2NoYW5nZVBlZXJJbmZvcm1hdGlvbicsCiAgICB2YWx1ZTogZnVuY3Rpb24gY2hhbmdlUGVlckluZm9ybWF0aW9uKCkgewoKICAgICAgdmFyIF90aGlzID0gdGhpczsKCiAgICAgIF90aGlzLl9jb25uZWN0aW9uRGF0YU9iamVjdE9ic2VydmVyLm9uQ2hhbmdlKCcqJywgZnVuY3Rpb24gKGV2ZW50KSB7CiAgICAgICAgY29uc29sZS5kZWJ1ZygnbWVzc2FnZTonLCBldmVudCk7CgogICAgICAgIHZhciBtZXNzYWdlID0gZXZlbnQuZGF0YTsKCiAgICAgICAgaWYgKG1lc3NhZ2UudHlwZSA9PT0gJ29mZmVyJyB8fCBtZXNzYWdlLnR5cGUgPT09ICdhbnN3ZXInKSB7CgogICAgICAgICAgX3RoaXMucGVlckNvbm5lY3Rpb24uc2V0UmVtb3RlRGVzY3JpcHRpb24obmV3IFJUQ1Nlc3Npb25EZXNjcmlwdGlvbihtZXNzYWdlKSwgX3RoaXMucmVtb3RlRGVzY3JpcHRpb25TdWNjZXNzLCBfdGhpcy5yZW1vdGVEZXNjcmlwdGlvbkVycm9yKTsKICAgICAgICB9IGVsc2UgaWYgKG1lc3NhZ2UudHlwZSA9PT0gJ2NhbmRpZGF0ZScpIHsKICAgICAgICAgIF90aGlzLnBlZXJDb25uZWN0aW9uLmFkZEljZUNhbmRpZGF0ZShuZXcgUlRDSWNlQ2FuZGlkYXRlKHsgY2FuZGlkYXRlOiBtZXNzYWdlLmNhbmRpZGF0ZSB9KSk7CiAgICAgICAgfQogICAgICB9KTsKICAgIH0KICB9LCB7CiAgICBrZXk6ICdyZW1vdGVEZXNjcmlwdGlvblN1Y2Nlc3MnLAogICAgdmFsdWU6IGZ1bmN0aW9uIHJlbW90ZURlc2NyaXB0aW9uU3VjY2VzcygpIHsKICAgICAgY29uc29sZS5sb2coJ3JlbW90ZSBzdWNjZXNzJyk7CiAgICB9CiAgfSwgewogICAga2V5OiAncmVtb3RlRGVzY3JpcHRpb25FcnJvcicsCiAgICB2YWx1ZTogZnVuY3Rpb24gcmVtb3RlRGVzY3JpcHRpb25FcnJvcihlcnJvcikgewogICAgICBjb25zb2xlLmVycm9yKCdlcnJvcjogJywgZXJyb3IpOwogICAgfQogIH0sIHsKICAgIGtleTogJ2NyZWF0ZU9mZmVyJywKICAgIHZhbHVlOiBmdW5jdGlvbiBjcmVhdGVPZmZlcigpIHsKICAgICAgdmFyIF90aGlzID0gdGhpczsKCiAgICAgIF90aGlzLnBlZXJDb25uZWN0aW9uLmNyZWF0ZU9mZmVyKGZ1bmN0aW9uIChkZXNjcmlwdGlvbikgewogICAgICAgIF90aGlzLm9uTG9jYWxTZXNzaW9uQ3JlYXRlZChkZXNjcmlwdGlvbik7CiAgICAgIH0sIF90aGlzLmxvZ0Vycm9yLCBfdGhpcy5tZWRpYUNvbnN0cmFpbnRzKTsKICAgIH0KICB9LCB7CiAgICBrZXk6ICdjcmVhdGVBbnN3ZXInLAogICAgdmFsdWU6IGZ1bmN0aW9uIGNyZWF0ZUFuc3dlcigpIHsKICAgICAgdmFyIF90aGlzID0gdGhpczsKCiAgICAgIF90aGlzLnBlZXJDb25uZWN0aW9uLmNyZWF0ZUFuc3dlcihmdW5jdGlvbiAoZGVzY3JpcHRpb24pIHsKICAgICAgICBfdGhpcy5vbkxvY2FsU2Vzc2lvbkNyZWF0ZWQoZGVzY3JpcHRpb24pOwogICAgICB9LCBfdGhpcy5sb2dFcnJvcik7CiAgICB9CgogICAgLyoqCiAgICAgKiBEaXNjb25uZWN0IHRoZSBwZWVyIGNvbm5lY3Rpb24KICAgICAqIEBtZXRob2QgZGlzY29ubmVjdAogICAgICogQHJldHVybiB7UHJvbWlzZX0KICAgICAqLwogIH0sIHsKICAgIGtleTogJ2Rpc2Nvbm5lY3QnLAogICAgdmFsdWU6IGZ1bmN0aW9uIGRpc2Nvbm5lY3QoKSB7CgogICAgICAvLyBUT0RPOiBvcHRpbWl6ZSB0aGUgZGlzY29ubmVjdCBmdW5jdGlvbgoKICAgICAgdmFyIF90aGlzID0gdGhpczsKCiAgICAgIHJldHVybiBuZXcgUHJvbWlzZShmdW5jdGlvbiAocmVzb2x2ZSwgcmVqZWN0KSB7CgogICAgICAgIHRyeSB7CgogICAgICAgICAgX3RoaXMucGVlckNvbm5lY3Rpb24uY2xvc2UoKTsKCiAgICAgICAgICByZXNvbHZlKHRydWUpOwogICAgICAgIH0gY2F0Y2ggKGUpIHsKICAgICAgICAgIHJlamVjdCgnZXJyb3IgZGlzY29ubmVjdGluZyBjb25uZWN0aW9uJyk7CiAgICAgICAgfQogICAgICB9KTsKICAgIH0KICB9LCB7CiAgICBrZXk6ICdvbkxvY2FsU2Vzc2lvbkNyZWF0ZWQnLAogICAgdmFsdWU6IGZ1bmN0aW9uIG9uTG9jYWxTZXNzaW9uQ3JlYXRlZChkZXNjcmlwdGlvbikgewoKICAgICAgdmFyIF90aGlzID0gdGhpczsKICAgICAgdmFyIHBlZXJDb25uZWN0aW9uID0gX3RoaXMucGVlckNvbm5lY3Rpb247CgogICAgICBwZWVyQ29ubmVjdGlvbi5zZXRMb2NhbERlc2NyaXB0aW9uKGRlc2NyaXB0aW9uLCBmdW5jdGlvbiAoKSB7CgogICAgICAgIHZhciBkYXRhID0gX3RoaXMuX2Nvbm5lY3Rpb25EYXRhT2JqZWN0UmVwb3J0ZXIuZGF0YTsKICAgICAgICBkYXRhLnNkcCA9IHsKICAgICAgICAgIHNkcDogZGVzY3JpcHRpb24uc2RwLAogICAgICAgICAgdHlwZTogZGVzY3JpcHRpb24udHlwZQogICAgICAgIH07CiAgICAgIH0sIF90aGlzLmxvZ0Vycm9yKTsKICAgIH0KICB9LCB7CiAgICBrZXk6ICdsb2dFcnJvcicsCiAgICB2YWx1ZTogZnVuY3Rpb24gbG9nRXJyb3IoZXJyKSB7CiAgICAgIGNvbnNvbGUuZXJyb3IoZXJyLnRvU3RyaW5nKCksIGVycik7CiAgICB9CiAgfSwgewogICAga2V5OiAnY29ubmVjdGlvbkRhdGFPYmplY3RSZXBvcnRlcicsCiAgICBzZXQ6IGZ1bmN0aW9uIHNldChjb25uZWN0aW9uRGF0YU9iamVjdCkgewogICAgICBpZiAoIWNvbm5lY3Rpb25EYXRhT2JqZWN0KSB0aHJvdyBuZXcgRXJyb3IoJ1RoZSBDb25uZWN0aW9uIERhdGEgT2JqZWN0IGlzIGEgbmVlZGVkIHBhcmFtZXRlcicpOwoKICAgICAgdmFyIF90aGlzID0gdGhpczsKICAgICAgX3RoaXMuX2Nvbm5lY3Rpb25EYXRhT2JqZWN0UmVwb3J0ZXIgPSBjb25uZWN0aW9uRGF0YU9iamVjdDsKCiAgICAgIGNvbm5lY3Rpb25EYXRhT2JqZWN0Lm9uU3Vic2NyaXB0aW9uKGZ1bmN0aW9uIChldmVudCkgewogICAgICAgIGV2ZW50LmFjY2VwdCgpOwoKICAgICAgICBpZiAoX3RoaXMubW9kZSA9PT0gJ29mZmVyJykgewogICAgICAgICAgX3RoaXMuY3JlYXRlT2ZmZXIoKTsKICAgICAgICB9IGVsc2UgewogICAgICAgICAgX3RoaXMuY3JlYXRlQW5zd2VyKCk7CiAgICAgICAgfQogICAgICB9KTsKCiAgICAgIGNvbnNvbGUubG9nKCdTZXQgY29ubmVjdGlvbkRhdGFPYmplY3Q6ICcsIF90aGlzLl9jb25uZWN0aW9uRGF0YU9iamVjdFJlcG9ydGVyKTsKICAgIH0sCgogICAgLyoqCiAgICAqIHJldHVybiB0aGUgY29ubmVjdGlvbkRhdGFPYmplY3QgaW4gdGhlIGNvbnRyb2xsZXIKICAgICogQHJldHVybiB7Q29ubmVjdGlvbkRhdGFPYmplY3R9IGNvbm5lY3Rpb25EYXRhT2JqZWN0CiAgICAqLwogICAgZ2V0OiBmdW5jdGlvbiBnZXQoKSB7CiAgICAgIHZhciBfdGhpcyA9IHRoaXM7CiAgICAgIHJldHVybiBfdGhpcy5fY29ubmVjdGlvbkRhdGFPYmplY3RSZXBvcnRlcjsKICAgIH0KCiAgICAvKioKICAgICogU2V0IHRoZSBjb25uZWN0aW9uRGF0YU9iamVjdCBpbiB0aGUgY29udHJvbGxlcgogICAgKiBAcGFyYW0ge0Nvbm5lY3Rpb25EYXRhT2JqZWN0fSBjb25uZWN0aW9uRGF0YU9iamVjdCAtIGhhdmUgYWxsIGluZm9ybWF0aW9uIGFib3V0IHRoZSBzeW5jaGVyIG9iamVjdDsKICAgICovCiAgfSwgewogICAga2V5OiAnY29ubmVjdGlvbkRhdGFPYmplY3RPYnNlcnZlcicsCiAgICBzZXQ6IGZ1bmN0aW9uIHNldChjb25uZWN0aW9uRGF0YU9iamVjdCkgewogICAgICBpZiAoIWNvbm5lY3Rpb25EYXRhT2JqZWN0KSB0aHJvdyBuZXcgRXJyb3IoJ1RoZSBDb25uZWN0aW9uIERhdGEgT2JqZWN0IGlzIGEgbmVlZGVkIHBhcmFtZXRlcicpOwoKICAgICAgdmFyIF90aGlzID0gdGhpczsKICAgICAgX3RoaXMuX2Nvbm5lY3Rpb25EYXRhT2JqZWN0T2JzZXJ2ZXIgPSBjb25uZWN0aW9uRGF0YU9iamVjdDsKCiAgICAgIGNvbnNvbGUubG9nKCdTZXQgY29ubmVjdGlvbkRhdGFPYmplY3Q6ICcsIF90aGlzLl9jb25uZWN0aW9uRGF0YU9iamVjdE9ic2VydmVyKTsKCiAgICAgIF90aGlzLmNoYW5nZVBlZXJJbmZvcm1hdGlvbigpOwogICAgfSwKCiAgICAvKioKICAgICogcmV0dXJuIHRoZSBjb25uZWN0aW9uRGF0YU9iamVjdCBpbiB0aGUgY29udHJvbGxlcgogICAgKiBAcmV0dXJuIHtDb25uZWN0aW9uRGF0YU9iamVjdH0gY29ubmVjdGlvbkRhdGFPYmplY3QKICAgICovCiAgICBnZXQ6IGZ1bmN0aW9uIGdldCgpIHsKICAgICAgdmFyIF90aGlzID0gdGhpczsKICAgICAgcmV0dXJuIF90aGlzLl9jb25uZWN0aW9uRGF0YU9iamVjdE9ic2VydmVyOwogICAgfQogIH1dKTsKCiAgcmV0dXJuIENvbm5lY3Rpb25Db250cm9sbGVyOwp9KShfdXRpbHNFdmVudEVtaXR0ZXIyWydkZWZhdWx0J10pOwoKZXhwb3J0c1snZGVmYXVsdCddID0gQ29ubmVjdGlvbkNvbnRyb2xsZXI7Cm1vZHVsZS5leHBvcnRzID0gZXhwb3J0c1snZGVmYXVsdCddOwoKfSx7Ii4uL3V0aWxzL0V2ZW50RW1pdHRlciI6MjMsIndlYnJ0Yy1hZGFwdGVyLXRlc3QiOjJ9XSwxMzpbZnVuY3Rpb24ocmVxdWlyZSxtb2R1bGUsZXhwb3J0cyl7Cid1c2Ugc3RyaWN0JzsKCk9iamVjdC5kZWZpbmVQcm9wZXJ0eShleHBvcnRzLCAnX19lc01vZHVsZScsIHsKICB2YWx1ZTogdHJ1ZQp9KTsKCnZhciBfY3JlYXRlQ2xhc3MgPSAoZnVuY3Rpb24gKCkgeyBmdW5jdGlvbiBkZWZpbmVQcm9wZXJ0aWVzKHRhcmdldCwgcHJvcHMpIHsgZm9yICh2YXIgaSA9IDA7IGkgPCBwcm9wcy5sZW5ndGg7IGkrKykgeyB2YXIgZGVzY3JpcHRvciA9IHByb3BzW2ldOyBkZXNjcmlwdG9yLmVudW1lcmFibGUgPSBkZXNjcmlwdG9yLmVudW1lcmFibGUgfHwgZmFsc2U7IGRlc2NyaXB0b3IuY29uZmlndXJhYmxlID0gdHJ1ZTsgaWYgKCd2YWx1ZScgaW4gZGVzY3JpcHRvcikgZGVzY3JpcHRvci53cml0YWJsZSA9IHRydWU7IE9iamVjdC5kZWZpbmVQcm9wZXJ0eSh0YXJnZXQsIGRlc2NyaXB0b3Iua2V5LCBkZXNjcmlwdG9yKTsgfSB9IHJldHVybiBmdW5jdGlvbiAoQ29uc3RydWN0b3IsIHByb3RvUHJvcHMsIHN0YXRpY1Byb3BzKSB7IGlmIChwcm90b1Byb3BzKSBkZWZpbmVQcm9wZXJ0aWVzKENvbnN0cnVjdG9yLnByb3RvdHlwZSwgcHJvdG9Qcm9wcyk7IGlmIChzdGF0aWNQcm9wcykgZGVmaW5lUHJvcGVydGllcyhDb25zdHJ1Y3Rvciwgc3RhdGljUHJvcHMpOyByZXR1cm4gQ29uc3RydWN0b3I7IH07IH0pKCk7Cgp2YXIgX2dldCA9IGZ1bmN0aW9uIGdldChfeCwgX3gyLCBfeDMpIHsgdmFyIF9hZ2FpbiA9IHRydWU7IF9mdW5jdGlvbjogd2hpbGUgKF9hZ2FpbikgeyB2YXIgb2JqZWN0ID0gX3gsIHByb3BlcnR5ID0gX3gyLCByZWNlaXZlciA9IF94MzsgX2FnYWluID0gZmFsc2U7IGlmIChvYmplY3QgPT09IG51bGwpIG9iamVjdCA9IEZ1bmN0aW9uLnByb3RvdHlwZTsgdmFyIGRlc2MgPSBPYmplY3QuZ2V0T3duUHJvcGVydHlEZXNjcmlwdG9yKG9iamVjdCwgcHJvcGVydHkpOyBpZiAoZGVzYyA9PT0gdW5kZWZpbmVkKSB7IHZhciBwYXJlbnQgPSBPYmplY3QuZ2V0UHJvdG90eXBlT2Yob2JqZWN0KTsgaWYgKHBhcmVudCA9PT0gbnVsbCkgeyByZXR1cm4gdW5kZWZpbmVkOyB9IGVsc2UgeyBfeCA9IHBhcmVudDsgX3gyID0gcHJvcGVydHk7IF94MyA9IHJlY2VpdmVyOyBfYWdhaW4gPSB0cnVlOyBkZXNjID0gcGFyZW50ID0gdW5kZWZpbmVkOyBjb250aW51ZSBfZnVuY3Rpb247IH0gfSBlbHNlIGlmICgndmFsdWUnIGluIGRlc2MpIHsgcmV0dXJuIGRlc2MudmFsdWU7IH0gZWxzZSB7IHZhciBnZXR0ZXIgPSBkZXNjLmdldDsgaWYgKGdldHRlciA9PT0gdW5kZWZpbmVkKSB7IHJldHVybiB1bmRlZmluZWQ7IH0gcmV0dXJuIGdldHRlci5jYWxsKHJlY2VpdmVyKTsgfSB9IH07CgpmdW5jdGlvbiBfaW50ZXJvcFJlcXVpcmVEZWZhdWx0KG9iaikgeyByZXR1cm4gb2JqICYmIG9iai5fX2VzTW9kdWxlID8gb2JqIDogeyAnZGVmYXVsdCc6IG9iaiB9OyB9CgpmdW5jdGlvbiBfY2xhc3NDYWxsQ2hlY2soaW5zdGFuY2UsIENvbnN0cnVjdG9yKSB7IGlmICghKGluc3RhbmNlIGluc3RhbmNlb2YgQ29uc3RydWN0b3IpKSB7IHRocm93IG5ldyBUeXBlRXJyb3IoJ0Nhbm5vdCBjYWxsIGEgY2xhc3MgYXMgYSBmdW5jdGlvbicpOyB9IH0KCmZ1bmN0aW9uIF9pbmhlcml0cyhzdWJDbGFzcywgc3VwZXJDbGFzcykgeyBpZiAodHlwZW9mIHN1cGVyQ2xhc3MgIT09ICdmdW5jdGlvbicgJiYgc3VwZXJDbGFzcyAhPT0gbnVsbCkgeyB0aHJvdyBuZXcgVHlwZUVycm9yKCdTdXBlciBleHByZXNzaW9uIG11c3QgZWl0aGVyIGJlIG51bGwgb3IgYSBmdW5jdGlvbiwgbm90ICcgKyB0eXBlb2Ygc3VwZXJDbGFzcyk7IH0gc3ViQ2xhc3MucHJvdG90eXBlID0gT2JqZWN0LmNyZWF0ZShzdXBlckNsYXNzICYmIHN1cGVyQ2xhc3MucHJvdG90eXBlLCB7IGNvbnN0cnVjdG9yOiB7IHZhbHVlOiBzdWJDbGFzcywgZW51bWVyYWJsZTogZmFsc2UsIHdyaXRhYmxlOiB0cnVlLCBjb25maWd1cmFibGU6IHRydWUgfSB9KTsgaWYgKHN1cGVyQ2xhc3MpIE9iamVjdC5zZXRQcm90b3R5cGVPZiA/IE9iamVjdC5zZXRQcm90b3R5cGVPZihzdWJDbGFzcywgc3VwZXJDbGFzcykgOiBzdWJDbGFzcy5fX3Byb3RvX18gPSBzdXBlckNsYXNzOyB9Cgp2YXIgX0Nvbm5lY3Rpb25Db250cm9sbGVyID0gcmVxdWlyZSgnLi9Db25uZWN0aW9uQ29udHJvbGxlcicpOwoKdmFyIF9Db25uZWN0aW9uQ29udHJvbGxlcjIgPSBfaW50ZXJvcFJlcXVpcmVEZWZhdWx0KF9Db25uZWN0aW9uQ29udHJvbGxlcik7Cgp2YXIgX3V0aWxzRXZlbnRFbWl0dGVyID0gcmVxdWlyZSgnLi4vdXRpbHMvRXZlbnRFbWl0dGVyJyk7Cgp2YXIgX3V0aWxzRXZlbnRFbWl0dGVyMiA9IF9pbnRlcm9wUmVxdWlyZURlZmF1bHQoX3V0aWxzRXZlbnRFbWl0dGVyKTsKCi8qKgogKiBIeXBlcnR5IENvbm5lY3RvcjsKICogQGF1dGhvciBWaXRvciBTaWx2YSBbdml0b3ItdC1zaWx2YUB0ZWxlY29tLnB0XQogKiBAdmVyc2lvbiAwLjEuMAogKi8KCnZhciBIeXBlcnR5Q29ubmVjdG9yID0gKGZ1bmN0aW9uIChfRXZlbnRFbWl0dGVyKSB7CiAgX2luaGVyaXRzKEh5cGVydHlDb25uZWN0b3IsIF9FdmVudEVtaXR0ZXIpOwoKICAvKioKICAgKiBDcmVhdGUgYSBuZXcgSHlwZXJ0eSBDb25uZWN0b3IKICAgKiBAcGFyYW0gIHtTeW5jaGVyfSBzeW5jaGVyIC0gU3luY2hlciBwcm92aWRlZCBmcm9tIHRoZSBydW50aW1lIGNvcmUKICAgKi8KCiAgZnVuY3Rpb24gSHlwZXJ0eUNvbm5lY3RvcihzeW5jaGVyKSB7CiAgICBfY2xhc3NDYWxsQ2hlY2sodGhpcywgSHlwZXJ0eUNvbm5lY3Rvcik7CgogICAgaWYgKCFzeW5jaGVyKSB0aHJvdyBuZXcgRXJyb3IoJ1RoZSBTeW5jaGVyIGlzIGEgbmVlZGVkIHBhcmFtZXRlcicpOwoKICAgIF9nZXQoT2JqZWN0LmdldFByb3RvdHlwZU9mKEh5cGVydHlDb25uZWN0b3IucHJvdG90eXBlKSwgJ2NvbnN0cnVjdG9yJywgdGhpcykuY2FsbCh0aGlzLCBzeW5jaGVyKTsKCiAgICB2YXIgX3RoaXMgPSB0aGlzOwogICAgX3RoaXMubW9kZSA9ICdvZmZlcic7CgogICAgX3RoaXMuY29ubmVjdGlvbkNvbnRyb2xsZXIgPSBuZXcgX0Nvbm5lY3Rpb25Db250cm9sbGVyMlsnZGVmYXVsdCddKCk7CgogICAgX3RoaXMuY29ubmVjdGlvbkNvbnRyb2xsZXIuYWRkRXZlbnRMaXN0ZW5lcignY29udHJvbGxlcjpzdGF0ZTpjaGFuZ2UnLCBmdW5jdGlvbiAoc3RhdGUpIHsKICAgICAgaWYgKHN0YXRlID09PSAnYW5zd2VyJykgewogICAgICAgIF90aGlzLm1vZGUgPSBzdGF0ZTsKICAgICAgICBfdGhpcy5fYXV0b0Nvbm5lY3QoX3RoaXMubm90aWZpY2F0aW9uRXZlbnQuZnJvbSk7CiAgICAgIH0KICAgIH0pOwoKICAgIC8vIHN0ZXAgMiAtIGh0dHBzOi8vZ2l0aHViLmNvbS9yZVRISU5LLXByb2plY3Qvc2NlbmFyaW8tc2VydmljZS1pbXBsZW1lbnRhdGlvbi90cmVlL21hc3Rlci9kb2NzL2h5cGVydGllcy9jb25uZWN0b3Ijbm90aWZpY2F0aW9uLWFib3V0LWluY29taW5nLWNvbm5lY3Rpb24tcmVxdWVzdAogICAgc3luY2hlci5vbk5vdGlmaWNhdGlvbihmdW5jdGlvbiAoZXZlbnQpIHsKICAgICAgY29uc29sZS5sb2coJ2Nvbm5lY3RvciBoYXZlIGFuIG5vdGlmaWNhdGlvbjogJywgZXZlbnQpOwoKICAgICAgX3RoaXMubm90aWZpY2F0aW9uRXZlbnQgPSBldmVudDsKCiAgICAgIHZhciBub3RpZmljYXRpb24gPSB7CiAgICAgICAgdHlwZTogZXZlbnQudHlwZSwKICAgICAgICBvd25lcjogZXZlbnQudmFsdWUub3duZXIsCiAgICAgICAgZnJvbTogZXZlbnQuZnJvbSwKICAgICAgICB0bzogZXZlbnQudmFsdWUudG8sCiAgICAgICAgcmVzb3VyY2VzOiBldmVudC52YWx1ZS5yZXNvdXJjZXMKICAgICAgfTsKCiAgICAgIGlmIChldmVudC50eXBlID09PSAnY3JlYXRlJyAmJiBldmVudC52YWx1ZS5vd25lcikgewogICAgICAgIC8vIHN0ZXAgNSAtIGh0dHBzOi8vZ2l0aHViLmNvbS9yZVRISU5LLXByb2plY3Qvc2NlbmFyaW8tc2VydmljZS1pbXBsZW1lbnRhdGlvbi90cmVlL21hc3Rlci9kb2NzL2h5cGVydGllcy9jb25uZWN0b3Ijbm90aWZpY2F0aW9uLWFib3V0LWluY29taW5nLWNvbm5lY3Rpb24tcmVxdWVzdAogICAgICAgIC8vIHRyaWdnZXIgbm90aWZpY2F0aW9uIHRvIHRoZSBhcHAgYW4gd2FpdCBmb3IgYW4gYW5zd2VyCiAgICAgICAgLy8gdG8gc3Vic2NyaWJlIHRoZSBvYmplY3RVUkwKICAgICAgICBfdGhpcy50cmlnZ2VyKCdjb25uZWN0b3I6bm90aWZpY2F0aW9uJywgbm90aWZpY2F0aW9uKTsKICAgICAgfSBlbHNlIHsKICAgICAgICBfdGhpcy5fYXV0b0FjY2VwdChldmVudC51cmwpOwogICAgICB9CiAgICB9KTsKCiAgICBfdGhpcy5fc3luY2hlciA9IHN5bmNoZXI7CiAgfQoKICAvKioKICAgKiBFc3RhYmxpc2ggY29ubmVjdGlvbiB3aXRoIG90aGVyIGNsaWVudCBpZGVudGlmaWVyCiAgICogQHBhcmFtICB7SHlwZXJ0eVVSTH0gSHlwZXJ0eVVSTCAtIERlZmluZSB0aGUgaWRlbnRpZmllciBvZiB0aGUgb3RoZXIgY29tcG9uZW50CiAgICogQHBhcmFtICB7T2JqZWN0fSBvcHRpb25zIC0gT2JqZWN0IHdpdGggb3B0aW9ucyB0byBpbXByb3ZlIHRoZSBjb25uZWN0CiAgICovCgogIF9jcmVhdGVDbGFzcyhIeXBlcnR5Q29ubmVjdG9yLCBbewogICAga2V5OiAnY29ubmVjdCcsCiAgICB2YWx1ZTogZnVuY3Rpb24gY29ubmVjdChoeXBlcnR5VVJMLCBvcHRpb25zKSB7CiAgICAgIC8vIFRPRE86IENIYW5nZSB0aGUgaHlwZXJ0eVVSTCBmb3IgYSBsaXN0IG9mIFVSTFMKICAgICAgdmFyIF90aGlzID0gdGhpczsKCiAgICAgIG9wdGlvbnMgPSBvcHRpb25zIHx8IHsgdmlkZW86IHRydWUsIGF1ZGlvOiB0cnVlIH07CgogICAgICByZXR1cm4gbmV3IFByb21pc2UoZnVuY3Rpb24gKHJlc29sdmUsIHJlamVjdCkgewoKICAgICAgICAvLyBTdGVwIDMgYW5kIDQgLSBodHRwczovL2dpdGh1Yi5jb20vcmVUSElOSy1wcm9qZWN0L3NjZW5hcmlvLXNlcnZpY2UtaW1wbGVtZW50YXRpb24vdHJlZS9tYXN0ZXIvZG9jcy9oeXBlcnRpZXMvY29ubmVjdG9yI2NyZWF0ZS1uZXctY29ubmVjdGlvbgogICAgICAgIF90aGlzLmNvbm5lY3Rpb25Db250cm9sbGVyLmdldFVzZXJNZWRpYShvcHRpb25zKS50aGVuKGZ1bmN0aW9uIChjb21tUmVzb3VyY2VzKSB7CiAgICAgICAgICBjb25zb2xlLmxvZygnR2V0IHdlYlJUQyBjb21tb24gcmVzb3VyY2VzJywgY29tbVJlc291cmNlcywgaHlwZXJ0eVVSTCk7CgogICAgICAgICAgLy8gVE9ETzogT3B0aW1pemUgdGhlIHJlc291cmNlcyB0byBnZXQ7CiAgICAgICAgICAvLyBhbmQgYWRkIGFsbCBvcHRpb25zIGF2YWlsYWJsZTsKICAgICAgICAgIHZhciBpbml0aWFsID0ge307CiAgICAgICAgICBpbml0aWFsLm93bmVyID0gdHJ1ZTsKICAgICAgICAgIGluaXRpYWwudG8gPSBoeXBlcnR5VVJMOwogICAgICAgICAgaW5pdGlhbC5yZXNvdXJjZXMgPSB7CiAgICAgICAgICAgIHZpZGVvOiBvcHRpb25zLnZpZGVvLAogICAgICAgICAgICBhdWRpbzogb3B0aW9ucy5hdWRpbwogICAgICAgICAgfTsKCiAgICAgICAgICAvLyBTdGVwIDUgLSBodHRwczovL2dpdGh1Yi5jb20vcmVUSElOSy1wcm9qZWN0L3NjZW5hcmlvLXNlcnZpY2UtaW1wbGVtZW50YXRpb24vdHJlZS9tYXN0ZXIvZG9jcy9oeXBlcnRpZXMvY29ubmVjdG9yI2NyZWF0ZS1uZXctY29ubmVjdGlvbgogICAgICAgICAgcmV0dXJuIF90aGlzLl9zeW5jaGVyLmNyZWF0ZSh7fSwgW2h5cGVydHlVUkxdLCBpbml0aWFsKTsKICAgICAgICB9KS50aGVuKGZ1bmN0aW9uIChjb25uZWN0aW9uRGF0YU9iamVjdCkgewogICAgICAgICAgY29uc29sZS5sb2coJ1JldHVybiBDcmVhdGUgQ29ubmVjdGlvbiBEYXRhIE9iamVjdCcsIGNvbm5lY3Rpb25EYXRhT2JqZWN0KTsKCiAgICAgICAgICAvLyBTdGVwIDExIC0gaHR0cHM6Ly9naXRodWIuY29tL3JlVEhJTkstcHJvamVjdC9zY2VuYXJpby1zZXJ2aWNlLWltcGxlbWVudGF0aW9uL3RyZWUvbWFzdGVyL2RvY3MvaHlwZXJ0aWVzL2Nvbm5lY3RvciNjcmVhdGUtbmV3LWNvbm5lY3Rpb24KICAgICAgICAgIF90aGlzLmNvbm5lY3Rpb25Db250cm9sbGVyLmNvbm5lY3Rpb25EYXRhT2JqZWN0UmVwb3J0ZXIgPSBjb25uZWN0aW9uRGF0YU9iamVjdDsKCiAgICAgICAgICAvLyBTdGVwIDEyIC0gaHR0cHM6Ly9naXRodWIuY29tL3JlVEhJTkstcHJvamVjdC9zY2VuYXJpby1zZXJ2aWNlLWltcGxlbWVudGF0aW9uL3RyZWUvbWFzdGVyL2RvY3MvaHlwZXJ0aWVzL2Nvbm5lY3RvciNjcmVhdGUtbmV3LWNvbm5lY3Rpb24KICAgICAgICAgIHJlc29sdmUoX3RoaXMuY29ubmVjdGlvbkNvbnRyb2xsZXIpOwogICAgICAgIH0pWydjYXRjaCddKGZ1bmN0aW9uIChyZWFzb24pIHsKICAgICAgICAgIGNvbnNvbGUuZXJyb3IocmVhc29uKTsKICAgICAgICAgIHJlamVjdChyZWFzb24pOwogICAgICAgIH0pOwogICAgICB9KTsKICAgIH0KCiAgICAvKioKICAgICAqIEFjY2VwdCB0aGUgaW5jb21pbmcgY2FsbAogICAgICogQG1ldGhvZCBhY2NlcHQKICAgICAqIEByZXR1cm4ge1Byb21pc2V9CiAgICAgKi8KICB9LCB7CiAgICBrZXk6ICdhY2NlcHQnLAogICAgdmFsdWU6IGZ1bmN0aW9uIGFjY2VwdCgpIHsKICAgICAgdmFyIF90aGlzID0gdGhpczsKCiAgICAgIHJldHVybiBuZXcgUHJvbWlzZShmdW5jdGlvbiAocmVzb2x2ZSwgcmVqZWN0KSB7CgogICAgICAgIHZhciBvYmplY3RVUkwgPSBfdGhpcy5ub3RpZmljYXRpb25FdmVudC51cmw7CgogICAgICAgIC8vIHN0ZXAgNiAtIGh0dHBzOi8vZ2l0aHViLmNvbS9yZVRISU5LLXByb2plY3Qvc2NlbmFyaW8tc2VydmljZS1pbXBsZW1lbnRhdGlvbi90cmVlL21hc3Rlci9kb2NzL2h5cGVydGllcy9jb25uZWN0b3Ijbm90aWZpY2F0aW9uLWFib3V0LWluY29taW5nLWNvbm5lY3Rpb24tcmVxdWVzdAogICAgICAgIC8vIGFmdGVyIHdhaXRpbmcgZm9yIGFuIGFuc3dlciwgd2UgY2FuIG5vdyBzdWJzY3JpYmUgdGhlIG9iamVjdFVSTAogICAgICAgIF90aGlzLl9zeW5jaGVyLnN1YnNjcmliZShvYmplY3RVUkwpLnRoZW4oZnVuY3Rpb24gKGNvbm5lY3Rpb25EYXRhT2JqZWN0KSB7CiAgICAgICAgICBjb25zb2xlLmxvZygnUmV0dXJuIFN1YnNjcmliZSBDb25uZWN0aW9uIERhdGEgT2JqZWN0JywgY29ubmVjdGlvbkRhdGFPYmplY3QpOwoKICAgICAgICAgIC8vIHN0ZXAgNyBhbmQgMTAgLSBodHRwczovL2dpdGh1Yi5jb20vcmVUSElOSy1wcm9qZWN0L3NjZW5hcmlvLXNlcnZpY2UtaW1wbGVtZW50YXRpb24vdHJlZS9tYXN0ZXIvZG9jcy9oeXBlcnRpZXMvY29ubmVjdG9yI25vdGlmaWNhdGlvbi1hYm91dC1pbmNvbWluZy1jb25uZWN0aW9uLXJlcXVlc3QKICAgICAgICAgIF90aGlzLmNvbm5lY3Rpb25Db250cm9sbGVyLmNvbm5lY3Rpb25EYXRhT2JqZWN0T2JzZXJ2ZXIgPSBjb25uZWN0aW9uRGF0YU9iamVjdDsKICAgICAgICAgIHJlc29sdmUoX3RoaXMuY29ubmVjdGlvbkNvbnRyb2xsZXIpOwoKICAgICAgICAgIHZhciByZXNvdXJjZXMgPSBjb25uZWN0aW9uRGF0YU9iamVjdC5kYXRhLnJlc291cmNlczsKICAgICAgICAgIHJldHVybiBfdGhpcy5jb25uZWN0aW9uQ29udHJvbGxlci5nZXRVc2VyTWVkaWEocmVzb3VyY2VzKTsKICAgICAgICB9KS50aGVuKGZ1bmN0aW9uIChjb21tUmVzb3VyY2VzKSB7CiAgICAgICAgICBjb25zb2xlLmxvZygnR2V0IHdlYlJUQyBjb21tb24gcmVzb3VyY2VzJywgY29tbVJlc291cmNlcyk7CiAgICAgICAgfSlbJ2NhdGNoJ10oZnVuY3Rpb24gKHJlYXNvbikgewogICAgICAgICAgY29uc29sZS5lcnJvcihyZWFzb24pOwogICAgICAgICAgcmVqZWN0KHJlYXNvbik7CiAgICAgICAgfSk7CiAgICAgIH0pOwogICAgfQoKICAgIC8qKgogICAgICogQ29ubmVjdGlvbiBpcyBjbG9zZWQgYnkgbG9jYWwgcGVlciBhbmQgZGlzY29ubmVjdGVkOwogICAgICogQG1ldGhvZCBkaXNjb25uZWN0CiAgICAgKiBAcmV0dXJuIHtQcm9taXNlfQogICAgICovCiAgfSwgewogICAga2V5OiAnZGlzY29ubmVjdCcsCiAgICB2YWx1ZTogZnVuY3Rpb24gZGlzY29ubmVjdCgpIHsKCiAgICAgIHZhciBfdGhpcyA9IHRoaXM7CgogICAgICByZXR1cm4gbmV3IFByb21pc2UoZnVuY3Rpb24gKHJlc29sdmUsIHJlamVjdCkgewoKICAgICAgICBfdGhpcy5jb25uZWN0aW9uQ29udHJvbGxlci5kaXNjb25uZWN0KCkudGhlbihmdW5jdGlvbiAoZGlzY29ubmVjdGVkKSB7CgogICAgICAgICAgY29uc29sZS5sb2coJ2Rpc2Nvbm5lY3RlZDogJywgZGlzY29ubmVjdGVkKTsKCiAgICAgICAgICByZXNvbHZlKGRpc2Nvbm5lY3RlZCk7CiAgICAgICAgfSlbJ2NhdGNoJ10oZnVuY3Rpb24gKHJlYXNvbikgewogICAgICAgICAgcmVqZWN0KHJlYXNvbik7CiAgICAgICAgfSk7CiAgICAgIH0pOwogICAgfQogIH0sIHsKICAgIGtleTogJ19hdXRvQ29ubmVjdCcsCiAgICB2YWx1ZTogZnVuY3Rpb24gX2F1dG9Db25uZWN0KGh5cGVydHlVUkwpIHsKICAgICAgdmFyIF90aGlzID0gdGhpczsKCiAgICAgIF90aGlzLl9zeW5jaGVyLmNyZWF0ZSh7fSwgW2h5cGVydHlVUkxdLCB7fSkudGhlbihmdW5jdGlvbiAoY29ubmVjdGlvbkRhdGFPYmplY3QpIHsKICAgICAgICBjb25zb2xlLmxvZygnUmV0dXJuIENyZWF0ZSBDb25uZWN0aW9uIERhdGEgT2JqZWN0JywgY29ubmVjdGlvbkRhdGFPYmplY3QpOwogICAgICAgIF90aGlzLmNvbm5lY3Rpb25Db250cm9sbGVyLmNvbm5lY3Rpb25EYXRhT2JqZWN0UmVwb3J0ZXIgPSBjb25uZWN0aW9uRGF0YU9iamVjdDsKICAgICAgfSlbJ2NhdGNoJ10oZnVuY3Rpb24gKHJlYXNvbikgewogICAgICAgIGNvbnNvbGUuZXJyb3IocmVhc29uKTsKICAgICAgfSk7CiAgICB9CiAgfSwgewogICAga2V5OiAnX2F1dG9BY2NlcHQnLAogICAgdmFsdWU6IGZ1bmN0aW9uIF9hdXRvQWNjZXB0KHVybCkgewogICAgICB2YXIgX3RoaXMgPSB0aGlzOwoKICAgICAgX3RoaXMuX3N5bmNoZXIuc3Vic2NyaWJlKHVybCkudGhlbihmdW5jdGlvbiAoY29ubmVjdGlvbkRhdGFPYmplY3QpIHsKICAgICAgICBjb25zb2xlLmxvZygnUmV0dXJuIFN1YnNjcmliZSBDb25uZWN0aW9uIERhdGEgT2JqZWN0JywgY29ubmVjdGlvbkRhdGFPYmplY3QpOwogICAgICAgIF90aGlzLmNvbm5lY3Rpb25Db250cm9sbGVyLmNvbm5lY3Rpb25EYXRhT2JqZWN0T2JzZXJ2ZXIgPSBjb25uZWN0aW9uRGF0YU9iamVjdDsKICAgICAgfSk7CiAgICB9CiAgfV0pOwoKICByZXR1cm4gSHlwZXJ0eUNvbm5lY3RvcjsKfSkoX3V0aWxzRXZlbnRFbWl0dGVyMlsnZGVmYXVsdCddKTsKCmV4cG9ydHNbJ2RlZmF1bHQnXSA9IEh5cGVydHlDb25uZWN0b3I7Cm1vZHVsZS5leHBvcnRzID0gZXhwb3J0c1snZGVmYXVsdCddOwoKfSx7Ii4uL3V0aWxzL0V2ZW50RW1pdHRlciI6MjMsIi4vQ29ubmVjdGlvbkNvbnRyb2xsZXIiOjEyfV0sMTQ6W2Z1bmN0aW9uKHJlcXVpcmUsbW9kdWxlLGV4cG9ydHMpewovKioKKiBDbGFzcyBpbXBsZW1lbnRhdGlvbiBvZiBNZXNzYWdlIERhdGEgTW9kZWwKKi8KCid1c2Ugc3RyaWN0JzsKCk9iamVjdC5kZWZpbmVQcm9wZXJ0eShleHBvcnRzLCAnX19lc01vZHVsZScsIHsKICAgIHZhbHVlOiB0cnVlCn0pOwoKZnVuY3Rpb24gX2NsYXNzQ2FsbENoZWNrKGluc3RhbmNlLCBDb25zdHJ1Y3RvcikgeyBpZiAoIShpbnN0YW5jZSBpbnN0YW5jZW9mIENvbnN0cnVjdG9yKSkgeyB0aHJvdyBuZXcgVHlwZUVycm9yKCdDYW5ub3QgY2FsbCBhIGNsYXNzIGFzIGEgZnVuY3Rpb24nKTsgfSB9Cgp2YXIgTWVzc2FnZSA9IGZ1bmN0aW9uIE1lc3NhZ2UoaWQsIGZyb20sIHRvTGlzdCwgdHlwZSwgY29udGV4dElkLCBib2R5LCBzaWduYXR1cmUpIHsKICAgIF9jbGFzc0NhbGxDaGVjayh0aGlzLCBNZXNzYWdlKTsKCiAgICB0aGlzLmlkID0gaWQ7CiAgICB0aGlzLmZyb20gPSBmcm9tOwogICAgdGhpcy50byA9IHRvTGlzdDsKICAgIHRoaXMudHlwZSA9IHR5cGU7CiAgICB0aGlzLmNvbnRleHRJZCA9IGNvbnRleHRJZDsKICAgIHRoaXMuc2lnbmF0dXJlID0gc2lnbmF0dXJlOwogICAgdGhpcy5ib2R5ID0gYm9keTsKfQoKLyoKZ2V0IGlkKCl7IHJldHVybiB0aGlzLmlkOyB9CiBnZXQgZnJvbSgpeyByZXR1cm4gdGhpcy5mcm9tOyB9CiBnZXQgdHlwZSgpIHsgcmV0dXJuIHRoaXMudHlwZTsgfQogZ2V0IGNvbnRleHRJZCgpIHsgcmV0dXJuIHRoaXMuY29udGV4dElkOyB9CiBnZXQgYm9keSgpeyByZXR1cm4gdGhpcy5ib2R5OyB9CiBzZXQgaWQoaWRlbnRpZmllcil7CiAgICBpZihpZGVudGlmaWVyKQogICAgICAgIHRoaXMuaWQgPSBpZGVudGlmaWVyOwp9CiBzZXQgZnJvbShzZW5kZXIpewogICAgaWYoc2VuZGVyKQogICAgICAgIHRoaXMuZnJvbSA9IHNlbmRlcjsKfQogc2V0IHR5cGUobXNnVHlwZSl7CiAgICBpZihtc2dUeXBlKQogICAgICAgIHRoaXMudHlwZSA9IG1zZ1R5cGU7Cn0KIHNldCBjb250ZXh0SWQoY0lEKXsKICAgIGlmKGNJRCkKICAgICAgICB0aGlzLmNvbnRleHRJZCA9IGNJRDsKfQpzZXQgYm9keShtc2dCb2R5KXsKICAgIGlmKG1zZ0JvZHkpCiAgICAgICAgdGhpcy5ib2R5ID0gbXNnQm9keTsKfQpzZXQgdG8ocmVjaXBpZW50TGlzdCl7CiAgICBpZihyZWNpcGllbnRMaXN0KQogICAgICAgIHRoaXMudG8gPSByZWNpcGllbnRMaXN0Owp9CiBzZXQgc2lnbmF0dXJlKHNpZ25hdHVyZSkgewogICAgaWYgKHNpZ25hdHVyZSkKICAgICAgICB0aGlzLnNpZ25hdHVyZSA9IHNpZ25hdHVyZTsKfSovCgo7CgpleHBvcnRzLk1lc3NhZ2UgPSBNZXNzYWdlOwp2YXIgTWVzc2FnZVR5cGUgPSB7IENSRUFURTogJ2NyZWF0ZScsIFJFQUQ6ICdyZWFkJywgVVBEQVRFOiAndXBkYXRlJywgREVMRVRFOiAnZGVsZXRlJywgU1VCU0NSSUJFOiAnc3Vic2NyaWJlJywgVU5TVUJTQ1JJQkU6ICd1bnN1YnNjcmliZScsIFJFU1BPTlNFOiAncmVzcG9uc2UnIH07CgpleHBvcnRzLk1lc3NhZ2VUeXBlID0gTWVzc2FnZVR5cGU7CmV4cG9ydHNbJ2RlZmF1bHQnXSA9IE1lc3NhZ2U7Cgp9LHt9XSwxNTpbZnVuY3Rpb24ocmVxdWlyZSxtb2R1bGUsZXhwb3J0cyl7Cid1c2Ugc3RyaWN0JzsKCk9iamVjdC5kZWZpbmVQcm9wZXJ0eShleHBvcnRzLCAnX19lc01vZHVsZScsIHsKICAgIHZhbHVlOiB0cnVlCn0pOwoKdmFyIF9nZXQgPSBmdW5jdGlvbiBnZXQoX3gsIF94MiwgX3gzKSB7IHZhciBfYWdhaW4gPSB0cnVlOyBfZnVuY3Rpb246IHdoaWxlIChfYWdhaW4pIHsgdmFyIG9iamVjdCA9IF94LCBwcm9wZXJ0eSA9IF94MiwgcmVjZWl2ZXIgPSBfeDM7IF9hZ2FpbiA9IGZhbHNlOyBpZiAob2JqZWN0ID09PSBudWxsKSBvYmplY3QgPSBGdW5jdGlvbi5wcm90b3R5cGU7IHZhciBkZXNjID0gT2JqZWN0LmdldE93blByb3BlcnR5RGVzY3JpcHRvcihvYmplY3QsIHByb3BlcnR5KTsgaWYgKGRlc2MgPT09IHVuZGVmaW5lZCkgeyB2YXIgcGFyZW50ID0gT2JqZWN0LmdldFByb3RvdHlwZU9mKG9iamVjdCk7IGlmIChwYXJlbnQgPT09IG51bGwpIHsgcmV0dXJuIHVuZGVmaW5lZDsgfSBlbHNlIHsgX3ggPSBwYXJlbnQ7IF94MiA9IHByb3BlcnR5OyBfeDMgPSByZWNlaXZlcjsgX2FnYWluID0gdHJ1ZTsgZGVzYyA9IHBhcmVudCA9IHVuZGVmaW5lZDsgY29udGludWUgX2Z1bmN0aW9uOyB9IH0gZWxzZSBpZiAoJ3ZhbHVlJyBpbiBkZXNjKSB7IHJldHVybiBkZXNjLnZhbHVlOyB9IGVsc2UgeyB2YXIgZ2V0dGVyID0gZGVzYy5nZXQ7IGlmIChnZXR0ZXIgPT09IHVuZGVmaW5lZCkgeyByZXR1cm4gdW5kZWZpbmVkOyB9IHJldHVybiBnZXR0ZXIuY2FsbChyZWNlaXZlcik7IH0gfSB9OwoKZnVuY3Rpb24gX2luaGVyaXRzKHN1YkNsYXNzLCBzdXBlckNsYXNzKSB7IGlmICh0eXBlb2Ygc3VwZXJDbGFzcyAhPT0gJ2Z1bmN0aW9uJyAmJiBzdXBlckNsYXNzICE9PSBudWxsKSB7IHRocm93IG5ldyBUeXBlRXJyb3IoJ1N1cGVyIGV4cHJlc3Npb24gbXVzdCBlaXRoZXIgYmUgbnVsbCBvciBhIGZ1bmN0aW9uLCBub3QgJyArIHR5cGVvZiBzdXBlckNsYXNzKTsgfSBzdWJDbGFzcy5wcm90b3R5cGUgPSBPYmplY3QuY3JlYXRlKHN1cGVyQ2xhc3MgJiYgc3VwZXJDbGFzcy5wcm90b3R5cGUsIHsgY29uc3RydWN0b3I6IHsgdmFsdWU6IHN1YkNsYXNzLCBlbnVtZXJhYmxlOiBmYWxzZSwgd3JpdGFibGU6IHRydWUsIGNvbmZpZ3VyYWJsZTogdHJ1ZSB9IH0pOyBpZiAoc3VwZXJDbGFzcykgT2JqZWN0LnNldFByb3RvdHlwZU9mID8gT2JqZWN0LnNldFByb3RvdHlwZU9mKHN1YkNsYXNzLCBzdXBlckNsYXNzKSA6IHN1YkNsYXNzLl9fcHJvdG9fXyA9IHN1cGVyQ2xhc3M7IH0KCmZ1bmN0aW9uIF9jbGFzc0NhbGxDaGVjayhpbnN0YW5jZSwgQ29uc3RydWN0b3IpIHsgaWYgKCEoaW5zdGFuY2UgaW5zdGFuY2VvZiBDb25zdHJ1Y3RvcikpIHsgdGhyb3cgbmV3IFR5cGVFcnJvcignQ2Fubm90IGNhbGwgYSBjbGFzcyBhcyBhIGZ1bmN0aW9uJyk7IH0gfQoKdmFyIE1lc3NhZ2VCb2R5ID0gZnVuY3Rpb24gTWVzc2FnZUJvZHkoaWRUb2tlbiwgYWNjZXNzVG9rZW4sIHJlc291cmNlKSB7CiAgICBfY2xhc3NDYWxsQ2hlY2sodGhpcywgTWVzc2FnZUJvZHkpOwoKICAgIC8vbGV0IF90aGlzID0gdGhpczsKICAgIGlmICh0eXBlb2YgaWRva2VuICE9PSAndW5kZWZpbmVkJykgdGhpcy5pZFRva2VuID0gaWRUb2tlbjsKICAgIGlmICh0eXBlb2YgYWNjZXNzVG9rZW4gIT09ICd1bmRlZmluZWQnKSB0aGlzLmFjY2Vzc1Rva2VuID0gYWNjZXNzVG9rZW47CiAgICBpZiAodHlwZW9mIHJlc291cmNlICE9PSAndW5kZWZpbmVkJykgdGhpcy5yZXNvdXJjZSA9IHJlc291cmNlOwp9CgovKmdldCBpZFRva2VuKCl7IHJldHVybiB0aGlzLmlkVG9rZW47IH0KIGdldCBhY2Nlc3NUb2tlbigpeyByZXR1cm4gdGhpcy5hY2Nlc3NUb2tlbjsgfQogZ2V0IHJlc291cmNlKCkgeyByZXR1cm4gdGhpcy5yZXNvdXJjZTsgfQogc2V0IGlkVG9rZW4oaVRva2VuKXsKICAgIGlmKGlUb2tlbikKICAgICAgICB0aGlzLmlkVG9rZW4gPSBpVG9rZW47Cn0KIHNldCBhY2Nlc3NUb2tlbihhVG9rZW4pewogICAgaWYoYVRva2VuKQogICAgICAgIHRoaXMuYWNjZXNzVG9rZW4gPSBhVG9rZW47Cn0KKi8KCjsKCnZhciBDcmVhdGVNZXNzYWdlQm9keSA9IChmdW5jdGlvbiAoX01lc3NhZ2VCb2R5KSB7CiAgICBfaW5oZXJpdHMoQ3JlYXRlTWVzc2FnZUJvZHksIF9NZXNzYWdlQm9keSk7CgogICAgZnVuY3Rpb24gQ3JlYXRlTWVzc2FnZUJvZHkodmFsdWUsIHBvbGljeSwgaWRUb2tlbiwgYWNjZXNzVG9rZW4sIHJlc291cmNlKSB7CiAgICAgICAgX2NsYXNzQ2FsbENoZWNrKHRoaXMsIENyZWF0ZU1lc3NhZ2VCb2R5KTsKCiAgICAgICAgaWYgKHR5cGVvZiB2YWx1ZSA9PT0gJ3VuZGVmaW5lZCcpIHRocm93IG5ldyBOdWxsUGFyYW1ldGVyRXJyb3IoIlRoZSB2YWx1ZSBwYXJhbWV0ZXIgaXMgbnVsbCIpOwogICAgICAgIF9nZXQoT2JqZWN0LmdldFByb3RvdHlwZU9mKENyZWF0ZU1lc3NhZ2VCb2R5LnByb3RvdHlwZSksICdjb25zdHJ1Y3RvcicsIHRoaXMpLmNhbGwodGhpcywgaWRUb2tlbiwgYWNjZXNzVG9rZW4sIHJlc291cmNlKTsKCiAgICAgICAgdGhpcy52YWx1ZSA9IHZhbHVlOwogICAgICAgIGlmIChwb2xpY3kpIHRoaXMucG9saWN5ID0gcG9saWN5OwogICAgfQoKICAgIC8qCiAgICBnZXQgdmFsdWUoKSB7IHJldHVybiB0aGlzLnZhbHVlOyB9CiAgICAgZ2V0IHBvbGljeSgpe3JldHVybiB0aGlzLnBvbGljeX0KICAgICBzZXQgdmFsdWUodmFsdWUpewogICAgICAgIGlmKHZhbHVlKQogICAgICAgICAgICB0aGlzLnZhbHVlID0gdmFsdWU7CiAgICB9CiAgICAgc2V0IHBvbGljeShwb2xpY3kpewogICAgICAgIGlmKHBvbGljeSkKICAgICAgICAgICAgdGhpcy5wb2xpY3kgPSBwb2xpY3k7CiAgICB9Ki8KICAgIHJldHVybiBDcmVhdGVNZXNzYWdlQm9keTsKfSkoTWVzc2FnZUJvZHkpOwoKZXhwb3J0cy5DcmVhdGVNZXNzYWdlQm9keSA9IENyZWF0ZU1lc3NhZ2VCb2R5OwoKdmFyIFJlYWRNZXNzYWdlQm9keSA9IChmdW5jdGlvbiAoX01lc3NhZ2VCb2R5MikgewogICAgX2luaGVyaXRzKFJlYWRNZXNzYWdlQm9keSwgX01lc3NhZ2VCb2R5Mik7CgogICAgZnVuY3Rpb24gUmVhZE1lc3NhZ2VCb2R5KGRhdGEsIGF0dHJpYnV0ZSwgY3JpdGVyaWFTeW50YXgsIGNyaXRlcmlhKSB7CiAgICAgICAgX2NsYXNzQ2FsbENoZWNrKHRoaXMsIFJlYWRNZXNzYWdlQm9keSk7CgogICAgICAgIHZhciBwcmV2aW91c0JvZHkgPSBkYXRhLmJvZHk7CiAgICAgICAgdmFyIGlkVG9rZW4gPSBwcmV2aW91c0JvZHkuaWRUb2tlbjsKICAgICAgICB2YXIgYWNjZXNzVG9rZW4gPSBwcmV2aW91c0JvZHkuYWNjZXNzVG9rZW47CiAgICAgICAgdmFyIHJlc291cmNlID0gcHJldmlvdXNCb2R5LnJlc291cmNlOwoKICAgICAgICBfZ2V0KE9iamVjdC5nZXRQcm90b3R5cGVPZihSZWFkTWVzc2FnZUJvZHkucHJvdG90eXBlKSwgJ2NvbnN0cnVjdG9yJywgdGhpcykuY2FsbCh0aGlzLCBpZFRva2VuLCBhY2Nlc3NUb2tlbiwgcmVzb3VyY2UpOwoKICAgICAgICBpZiAoYXR0cmlidXRlKSB0aGlzLmF0dHJpYnV0ZSA9IGF0dHJpYnV0ZTsKCiAgICAgICAgaWYgKGNyaXRlcmlhU3ludGF4KSB0aGlzLmNyaXRlcmlhU3ludGF4ID0gY3JpdGVyaWFTeW50YXg7CgogICAgICAgIGlmIChjcml0ZXJpYSkgdGhpcy5jcml0ZXJpYSA9IGNyaXRlcmlhOwogICAgfQoKICAgIC8qZ2V0IGF0dHJpYnV0ZSgpIHsgcmV0dXJuIHRoaXMuYXR0cmlidXRlOyB9CiAgICBnZXQgY3JpdGVyaWFTeW50YXgoKSB7IHJldHVybiB0aGlzLmNyaXRlcmlhU3ludGF4OyB9CiAgICBnZXQgY3JpdGVyaWEoKSB7cmV0dXJuIH0KICAgICBzZXQgYXR0cmlidXRlKGF0cil7CiAgICAgICAgaWYoYXRyKQogICAgICAgICAgICB0aGlzLmF0dHJpYnV0ZSA9IGF0cjsKICAgIH0KICAgICBzZXQgY3JpdGVyaWEoY3JpdGVyaWEpewogICAgICAgIGlmKGNyaXRlcmlhKQogICAgICAgICAgICB0aGlzLmNyaXRlcmlhOwogICAgfQogICAgIHNldCBjcml0ZXJpYVN5bnRheChjclN5bnRheCl7CiAgICAgICAgaWYoY3JTeW50YXgpCiAgICAgICAgICAgIHRoaXMuY3JpdGVyaWFTeW50YXggPSBjclN5bnRheDsKICAgIH0qLwogICAgcmV0dXJuIFJlYWRNZXNzYWdlQm9keTsKfSkoTWVzc2FnZUJvZHkpOwoKZXhwb3J0cy5SZWFkTWVzc2FnZUJvZHkgPSBSZWFkTWVzc2FnZUJvZHk7Cgp2YXIgRGVsZXRlTWVzc2FnZUJvZHkgPSAoZnVuY3Rpb24gKF9NZXNzYWdlQm9keTMpIHsKICAgIF9pbmhlcml0cyhEZWxldGVNZXNzYWdlQm9keSwgX01lc3NhZ2VCb2R5Myk7CgogICAgZnVuY3Rpb24gRGVsZXRlTWVzc2FnZUJvZHkoZGF0YSwgYXR0cmlidXRlKSB7CiAgICAgICAgX2NsYXNzQ2FsbENoZWNrKHRoaXMsIERlbGV0ZU1lc3NhZ2VCb2R5KTsKCiAgICAgICAgdmFyIHByZXZpb3VzQm9keSA9IGRhdGEuYm9keTsKICAgICAgICB2YXIgaWRUb2tlbiA9IHByZXZpb3VzQm9keS5pZFRva2VuOwogICAgICAgIHZhciBhY2Nlc3NUb2tlbiA9IHByZXZpb3VzQm9keS5hY2Nlc3NUb2tlbjsKICAgICAgICB2YXIgcmVzb3VyY2UgPSBwcmV2aW91c0JvZHkucmVzb3VyY2U7CgogICAgICAgIF9nZXQoT2JqZWN0LmdldFByb3RvdHlwZU9mKERlbGV0ZU1lc3NhZ2VCb2R5LnByb3RvdHlwZSksICdjb25zdHJ1Y3RvcicsIHRoaXMpLmNhbGwodGhpcywgaWRUb2tlbiwgYWNjZXNzVG9rZW4sIHJlc291cmNlKTsKCiAgICAgICAgaWYgKGF0dHJpYnV0ZSkgewogICAgICAgICAgICB0aGlzLmF0dHJpYnV0ZSA9IGF0dHJpYnV0ZTsKICAgICAgICB9CiAgICB9CgogICAgLyoKICAgIGdldCBhdHRyaWJ1dGUoKSB7IHJldHVybiB0aGlzLmF0dHJpYnV0ZTsgfQogICAgc2V0IGF0dHJpYnV0ZShhdHIpewogICAgICAgIGlmKGF0cikKICAgICAgICAgICAgdGhpcy5hdHRyaWJ1dGUgPSBhdHI7CiAgICB9Ki8KICAgIHJldHVybiBEZWxldGVNZXNzYWdlQm9keTsKfSkoTWVzc2FnZUJvZHkpOwoKZXhwb3J0cy5EZWxldGVNZXNzYWdlQm9keSA9IERlbGV0ZU1lc3NhZ2VCb2R5OwoKdmFyIFVwZGF0ZU1lc3NhZ2VCb2R5ID0gKGZ1bmN0aW9uIChfTWVzc2FnZUJvZHk0KSB7CiAgICBfaW5oZXJpdHMoVXBkYXRlTWVzc2FnZUJvZHksIF9NZXNzYWdlQm9keTQpOwoKICAgIGZ1bmN0aW9uIFVwZGF0ZU1lc3NhZ2VCb2R5KGRhdGEsIGF0dHJpYnV0ZSwgdmFsdWUpIHsKICAgICAgICBfY2xhc3NDYWxsQ2hlY2sodGhpcywgVXBkYXRlTWVzc2FnZUJvZHkpOwoKICAgICAgICB2YXIgcHJldmlvdXNCb2R5ID0gZGF0YS5ib2R5OwogICAgICAgIHZhciBpZFRva2VuID0gcHJldmlvdXNCb2R5LmlkVG9rZW47CiAgICAgICAgdmFyIGFjY2Vzc1Rva2VuID0gcHJldmlvdXNCb2R5LmFjY2Vzc1Rva2VuOwogICAgICAgIHZhciByZXNvdXJjZSA9IHByZXZpb3VzQm9keS5yZXNvdXJjZTsKCiAgICAgICAgX2dldChPYmplY3QuZ2V0UHJvdG90eXBlT2YoVXBkYXRlTWVzc2FnZUJvZHkucHJvdG90eXBlKSwgJ2NvbnN0cnVjdG9yJywgdGhpcykuY2FsbCh0aGlzLCBpZFRva2VuLCBhY2Nlc3NUb2tlbiwgcmVzb3VyY2UpOwoKICAgICAgICB0aGlzLmF0dHJpYnV0ZSA9IGF0dHJpYnV0ZTsKICAgICAgICB0aGlzLnZhbHVlID0gdmFsdWU7CiAgICB9CgogICAgLyogZ2V0IGF0dHJpYnV0ZSgpIHsgcmV0dXJuIHRoaXMuYXR0cmlidXRlOyB9CiAgICAgZ2V0IHZhbHVlKCl7IHJldHVybiB0aGlzLnZhbHVlOyB9CiAgICAgIHNldCBhdHRyaWJ1dGUoYXRyKXsKICAgICAgICAgaWYoYXRyKQogICAgICAgICAgICAgdGhpcy5hdHRyaWJ1dGUgPSBhdHI7CiAgICAgfQogICAgICBzZXQgdmFsdWUodmFsdWUpewogICAgICAgICBpZih2YWx1ZSkKICAgICAgICAgICAgIHRoaXMudmFsdWUgPSB2YWx1ZTsKICAgICB9Ki8KICAgIHJldHVybiBVcGRhdGVNZXNzYWdlQm9keTsKfSkoTWVzc2FnZUJvZHkpOwoKZXhwb3J0cy5VcGRhdGVNZXNzYWdlQm9keSA9IFVwZGF0ZU1lc3NhZ2VCb2R5OwoKdmFyIFJlc3BvbnNlTWVzc2FnZUJvZHkgPSAoZnVuY3Rpb24gKF9NZXNzYWdlQm9keTUpIHsKICAgIF9pbmhlcml0cyhSZXNwb25zZU1lc3NhZ2VCb2R5LCBfTWVzc2FnZUJvZHk1KTsKCiAgICBmdW5jdGlvbiBSZXNwb25zZU1lc3NhZ2VCb2R5KGRhdGEsIGNvZGUsIHZhbHVlKSB7CiAgICAgICAgX2NsYXNzQ2FsbENoZWNrKHRoaXMsIFJlc3BvbnNlTWVzc2FnZUJvZHkpOwoKICAgICAgICB2YXIgcHJldmlvdXNCb2R5ID0gZGF0YS5ib2R5OwogICAgICAgIHZhciBpZFRva2VuID0gcHJldmlvdXNCb2R5LmlkVG9rZW47CiAgICAgICAgdmFyIGFjY2Vzc1Rva2VuID0gcHJldmlvdXNCb2R5LmFjY2Vzc1Rva2VuOwogICAgICAgIHZhciByZXNvdXJjZSA9IHByZXZpb3VzQm9keS5yZXNvdXJjZTsKCiAgICAgICAgX2dldChPYmplY3QuZ2V0UHJvdG90eXBlT2YoUmVzcG9uc2VNZXNzYWdlQm9keS5wcm90b3R5cGUpLCAnY29uc3RydWN0b3InLCB0aGlzKS5jYWxsKHRoaXMsIGlkVG9rZW4sIGFjY2Vzc1Rva2VuLCByZXNvdXJjZSk7CiAgICAgICAgX2dldChPYmplY3QuZ2V0UHJvdG90eXBlT2YoUmVzcG9uc2VNZXNzYWdlQm9keS5wcm90b3R5cGUpLCAnY29uc3RydWN0b3InLCB0aGlzKS5jYWxsKHRoaXMsIGlkVG9rZW4sIGFjY2Vzc1Rva2VuLCByZXNvdXJjZSk7CgogICAgICAgIGlmIChjb2RlKSB7CiAgICAgICAgICAgIHRoaXMuY29kZSA9IGNvZGU7CiAgICAgICAgICAgIHRoaXMuZGVzY3JpcHRpb24gPSBSRUFTT05fUEhSQVNFW2NvZGVdOwogICAgICAgIH0KCiAgICAgICAgaWYgKHZhbHVlKSB0aGlzLnZhbHVlID0gdmFsdWU7CiAgICB9CgogICAgLypnZXQgY29kZSgpeyByZXR1cm4gdGhpcy5jb2RlOyB9CiAgICBnZXQgZGVzY3JpcHRpb24oKSB7IHJldHVybiB0aGlzLmRlc2NyaXB0aW9uOyB9CiAgICBnZXQgdmFsdWUoKXsgcmV0dXJuIHRoaXMudmFsdWU7IH0KICAgICBzZXQgZGVzY3JpcHRpb24oZGVzYyl7CiAgICAgICAgaWYoZGVzYykKICAgICAgICAgICAgdGhpcy5kZXNjcmlwdGlvbiA9IGRlc2M7CiAgICB9CiAgICAgc2V0IHZhbHVlKHZhbHVlKXsKICAgICAgICBpZih2YWx1ZSkKICAgICAgICAgICAgdGhpcy52YWx1ZSA9IHZhbHVlOwogICAgfQogICAgIHNldCBjb2RlKGNvZGUpewogICAgICAgIGlmKGNvZGUpCiAgICAgICAgICAgIHRoaXMuY29kZSA9IGNvZGU7CiAgICB9Ki8KICAgIHJldHVybiBSZXNwb25zZU1lc3NhZ2VCb2R5Owp9KShNZXNzYWdlQm9keSk7CgpleHBvcnRzLlJlc3BvbnNlTWVzc2FnZUJvZHkgPSBSZXNwb25zZU1lc3NhZ2VCb2R5Owp2YXIgUkVTUE9OU19DT0RFID0gewogICAgMTAwOiAnMTAwJywKICAgIDEwMTogJzEwMScsCiAgICAyMDA6ICcyMDAnLAogICAgMjAxOiAnMjAxJywKICAgIDIwMjogJzIwMicsCiAgICAyMDM6ICcyMDMnLAogICAgMjA0OiAnMjA0JywKICAgIDIwNTogJzIwNScsCiAgICAyMDY6ICcyMDYnLAogICAgMzAwOiAnMzAwJywKICAgIDMwMTogJzMwMScsCiAgICAzMDI6ICczMDInLAogICAgMzAzOiAnMzAzJywKICAgIDMwNDogJzMwNCcsCiAgICAzMDU6ICczMDUnLAogICAgMzA3OiAnMzA3JywKICAgIDQwMDogJzQwMCcsCiAgICA0MDE6ICc0MDEnLAogICAgNDAyOiAnNDAyJywKICAgIDQwMzogJzQwMycsCiAgICA0MDQ6ICc0MDQnLAogICAgNDA1OiAnNDA1JywKICAgIDQwNjogJzQwNicsCiAgICA0MDc6ICc0MDcnLAogICAgNDA4OiAnNDA4JywKICAgIDQwOTogJzQwOScsCiAgICA0MTA6ICc0MTAnLAogICAgNDExOiAnNDExJywKICAgIDQxMjogJzQxMicsCiAgICA0MTM6ICc0MTMnLAogICAgNDE0OiAnNDE0JywKICAgIDQxNTogJzQxNScsCiAgICA0MTY6ICc0MTYnLAogICAgNDE3OiAnNDE3JywKICAgIDQyNjogJzQyNicsCiAgICA1MDA6ICc1MDAnLAogICAgNTAxOiAnNTAxJywKICAgIDUwMjogJzUwMicsCiAgICA1MDM6ICc1MDMnLAogICAgNTA0OiAnNTA0JywKICAgIDUwNTogJzUwNScKfTsKZXhwb3J0cy5SRVNQT05TX0NPREUgPSBSRVNQT05TX0NPREU7CnZhciBSRUFTT05fUEhSQVNFID0gewogICAgMTAwOiAnQ29udGludWUnLAogICAgMTAxOiAnU3dpdGNoaW5nIFByb3RvY29scycsCiAgICAyMDA6ICdPSycsCiAgICAyMDE6ICdDcmVhdGVkJywKICAgIDIwMjogJ0FjY2VwdGVkJywKICAgIDIwMzogJ05vbi1BdXRob3JpdGF0aXZlIEluZm9ybWF0aW9uJywKICAgIDIwNDogJ05vIENvbnRlbnQnLAogICAgMjA1OiAnUmVzZXQgQ29udGVudCcsCiAgICAyMDY6ICdQYXJ0aWFsIENvbnRlbnQnLAogICAgMzAwOiAnTXVsdGlwbGUgQ2hvaWNlcycsCiAgICAzMDE6ICdNb3ZlZCBQZXJtYW5lbnRseScsCiAgICAzMDI6ICdGb3VuZCcsCiAgICAzMDM6ICdTZWUgT3RoZXInLAogICAgMzA0OiAnTm90IE1vZGlmaWVkJywKICAgIDMwNTogJ1VzZSBQcm94eScsCiAgICAzMDc6ICdUZW1wb3JhcnkgUmVkaXJlY3QnLAogICAgNDAwOiAnQmFkIFJlcXVlc3QnLAogICAgNDAxOiAnVW5hdXRob3JpemVkJywKICAgIDQwMjogJ1BheW1lbnQgUmVxdWlyZWQnLAogICAgNDAzOiAnRm9yYmlkZGVuJywKICAgIDQwNDogJ05vdCBGb3VuZCcsCiAgICA0MDU6ICdNZXRob2QgTm90IEFsbG93ZWQnLAogICAgNDA2OiAnTm90IEFjY2VwdGFibGUnLAogICAgNDA3OiAnUHJveHkgQXV0aGVudGljYXRpb24gUmVxdWlyZWQnLAogICAgNDA4OiAnUmVxdWVzdCBUaW1lb3V0JywKICAgIDQwOTogJ0NvbmZsaWN0JywKICAgIDQxMDogJ0dvbmUnLAogICAgNDExOiAnTGVuZ3RoIFJlcXVpcmVkJywKICAgIDQxMjogJ1ByZWNvbmRpdGlvbiBGYWlsZWQnLAogICAgNDEzOiAnUGF5bG9hZCBUb28gTGFyZ2UnLAogICAgNDE0OiAnUmVxdWVzdC1VUkkgVG9vIExvbmcnLAogICAgNDE1OiAnVW5zdXBwb3J0ZWQgTWVkaWEgVHlwZScsCiAgICA0MTY6ICdSYW5nZSBOb3QgU2F0aXNmaWFibGUnLAogICAgNDE3OiAnRXhwZWN0YXRpb24gRmFpbGVkJywKICAgIDQyNjogJ1VwZ3JhZGUgUmVxdWlyZWQnLAogICAgNTAwOiAnSW50ZXJuYWwgU2VydmVyIEVycm9yJywKICAgIDUwMTogJ05vdCBJbXBsZW1lbnRlZCcsCiAgICA1MDI6ICdCYWQgR2F0ZXdheScsCiAgICA1MDM6ICdTZXJ2aWNlIFVuYXZhaWxhYmxlJywKICAgIDUwNDogJ0dhdGV3YXkgVGltZS1vdXQnLAogICAgNTA1OiAnSFRUUCBWZXJzaW9uIE5vdCBTdXBwb3J0ZWQnCn07CgpleHBvcnRzLlJFQVNPTl9QSFJBU0UgPSBSRUFTT05fUEhSQVNFOwpleHBvcnRzWydkZWZhdWx0J10gPSBNZXNzYWdlQm9keTsKCn0se31dLDE2OltmdW5jdGlvbihyZXF1aXJlLG1vZHVsZSxleHBvcnRzKXsKLyoqCiogTWVzc2FnZSBGYWN0b3J5CiogCiovCgondXNlIHN0cmljdCc7CgpPYmplY3QuZGVmaW5lUHJvcGVydHkoZXhwb3J0cywgJ19fZXNNb2R1bGUnLCB7CiAgICB2YWx1ZTogdHJ1ZQp9KTsKCnZhciBfY3JlYXRlQ2xhc3MgPSAoZnVuY3Rpb24gKCkgeyBmdW5jdGlvbiBkZWZpbmVQcm9wZXJ0aWVzKHRhcmdldCwgcHJvcHMpIHsgZm9yICh2YXIgaSA9IDA7IGkgPCBwcm9wcy5sZW5ndGg7IGkrKykgeyB2YXIgZGVzY3JpcHRvciA9IHByb3BzW2ldOyBkZXNjcmlwdG9yLmVudW1lcmFibGUgPSBkZXNjcmlwdG9yLmVudW1lcmFibGUgfHwgZmFsc2U7IGRlc2NyaXB0b3IuY29uZmlndXJhYmxlID0gdHJ1ZTsgaWYgKCd2YWx1ZScgaW4gZGVzY3JpcHRvcikgZGVzY3JpcHRvci53cml0YWJsZSA9IHRydWU7IE9iamVjdC5kZWZpbmVQcm9wZXJ0eSh0YXJnZXQsIGRlc2NyaXB0b3Iua2V5LCBkZXNjcmlwdG9yKTsgfSB9IHJldHVybiBmdW5jdGlvbiAoQ29uc3RydWN0b3IsIHByb3RvUHJvcHMsIHN0YXRpY1Byb3BzKSB7IGlmIChwcm90b1Byb3BzKSBkZWZpbmVQcm9wZXJ0aWVzKENvbnN0cnVjdG9yLnByb3RvdHlwZSwgcHJvdG9Qcm9wcyk7IGlmIChzdGF0aWNQcm9wcykgZGVmaW5lUHJvcGVydGllcyhDb25zdHJ1Y3Rvciwgc3RhdGljUHJvcHMpOyByZXR1cm4gQ29uc3RydWN0b3I7IH07IH0pKCk7Cgp2YXIgX2dldCA9IGZ1bmN0aW9uIGdldChfeCwgX3gyLCBfeDMpIHsgdmFyIF9hZ2FpbiA9IHRydWU7IF9mdW5jdGlvbjogd2hpbGUgKF9hZ2FpbikgeyB2YXIgb2JqZWN0ID0gX3gsIHByb3BlcnR5ID0gX3gyLCByZWNlaXZlciA9IF94MzsgX2FnYWluID0gZmFsc2U7IGlmIChvYmplY3QgPT09IG51bGwpIG9iamVjdCA9IEZ1bmN0aW9uLnByb3RvdHlwZTsgdmFyIGRlc2MgPSBPYmplY3QuZ2V0T3duUHJvcGVydHlEZXNjcmlwdG9yKG9iamVjdCwgcHJvcGVydHkpOyBpZiAoZGVzYyA9PT0gdW5kZWZpbmVkKSB7IHZhciBwYXJlbnQgPSBPYmplY3QuZ2V0UHJvdG90eXBlT2Yob2JqZWN0KTsgaWYgKHBhcmVudCA9PT0gbnVsbCkgeyByZXR1cm4gdW5kZWZpbmVkOyB9IGVsc2UgeyBfeCA9IHBhcmVudDsgX3gyID0gcHJvcGVydHk7IF94MyA9IHJlY2VpdmVyOyBfYWdhaW4gPSB0cnVlOyBkZXNjID0gcGFyZW50ID0gdW5kZWZpbmVkOyBjb250aW51ZSBfZnVuY3Rpb247IH0gfSBlbHNlIGlmICgndmFsdWUnIGluIGRlc2MpIHsgcmV0dXJuIGRlc2MudmFsdWU7IH0gZWxzZSB7IHZhciBnZXR0ZXIgPSBkZXNjLmdldDsgaWYgKGdldHRlciA9PT0gdW5kZWZpbmVkKSB7IHJldHVybiB1bmRlZmluZWQ7IH0gcmV0dXJuIGdldHRlci5jYWxsKHJlY2VpdmVyKTsgfSB9IH07CgpmdW5jdGlvbiBfaW50ZXJvcFJlcXVpcmVEZWZhdWx0KG9iaikgeyByZXR1cm4gb2JqICYmIG9iai5fX2VzTW9kdWxlID8gb2JqIDogeyAnZGVmYXVsdCc6IG9iaiB9OyB9CgpmdW5jdGlvbiBfY2xhc3NDYWxsQ2hlY2soaW5zdGFuY2UsIENvbnN0cnVjdG9yKSB7IGlmICghKGluc3RhbmNlIGluc3RhbmNlb2YgQ29uc3RydWN0b3IpKSB7IHRocm93IG5ldyBUeXBlRXJyb3IoJ0Nhbm5vdCBjYWxsIGEgY2xhc3MgYXMgYSBmdW5jdGlvbicpOyB9IH0KCmZ1bmN0aW9uIF9pbmhlcml0cyhzdWJDbGFzcywgc3VwZXJDbGFzcykgeyBpZiAodHlwZW9mIHN1cGVyQ2xhc3MgIT09ICdmdW5jdGlvbicgJiYgc3VwZXJDbGFzcyAhPT0gbnVsbCkgeyB0aHJvdyBuZXcgVHlwZUVycm9yKCdTdXBlciBleHByZXNzaW9uIG11c3QgZWl0aGVyIGJlIG51bGwgb3IgYSBmdW5jdGlvbiwgbm90ICcgKyB0eXBlb2Ygc3VwZXJDbGFzcyk7IH0gc3ViQ2xhc3MucHJvdG90eXBlID0gT2JqZWN0LmNyZWF0ZShzdXBlckNsYXNzICYmIHN1cGVyQ2xhc3MucHJvdG90eXBlLCB7IGNvbnN0cnVjdG9yOiB7IHZhbHVlOiBzdWJDbGFzcywgZW51bWVyYWJsZTogZmFsc2UsIHdyaXRhYmxlOiB0cnVlLCBjb25maWd1cmFibGU6IHRydWUgfSB9KTsgaWYgKHN1cGVyQ2xhc3MpIE9iamVjdC5zZXRQcm90b3R5cGVPZiA/IE9iamVjdC5zZXRQcm90b3R5cGVPZihzdWJDbGFzcywgc3VwZXJDbGFzcykgOiBzdWJDbGFzcy5fX3Byb3RvX18gPSBzdXBlckNsYXNzOyB9Cgp2YXIgX3JlVEhJTktPYmplY3RSZXRoaW5rT2JqZWN0SnMgPSByZXF1aXJlKCcuLi9yZVRISU5LT2JqZWN0L1JldGhpbmtPYmplY3QuanMnKTsKCnZhciBfcmVUSElOS09iamVjdFJldGhpbmtPYmplY3RKczIgPSBfaW50ZXJvcFJlcXVpcmVEZWZhdWx0KF9yZVRISU5LT2JqZWN0UmV0aGlua09iamVjdEpzKTsKCnZhciBfTWVzc2FnZUpzID0gcmVxdWlyZSgnLi9NZXNzYWdlLmpzJyk7Cgp2YXIgX01lc3NhZ2VKczIgPSBfaW50ZXJvcFJlcXVpcmVEZWZhdWx0KF9NZXNzYWdlSnMpOwoKdmFyIF9NZXNzYWdlQm9keUpzID0gcmVxdWlyZSgnLi9NZXNzYWdlQm9keS5qcycpOwoKdmFyIE1lc3NhZ2VGYWN0b3J5ID0gKGZ1bmN0aW9uIChfUmV0aGlua09iamVjdCkgewogICAgX2luaGVyaXRzKE1lc3NhZ2VGYWN0b3J5LCBfUmV0aGlua09iamVjdCk7CgogICAgLyoqCiAgICAgKiBDb25zdHJ1Y3RvcgogICAgICogQHBhcmFtIHtib29sZWFufSB2YWxpZGF0aW9uCiAgICAgKiBAcGFyYW0ge1VSTC5VUkwgfSBzY2hlbWEgLSBsaW5rIHRvIHRoZSBzY2hlbWEKICAgICAqLwoKICAgIGZ1bmN0aW9uIE1lc3NhZ2VGYWN0b3J5KHZhbGlkYXRpb24sIHNjaGVtYSkgewogICAgICAgIF9jbGFzc0NhbGxDaGVjayh0aGlzLCBNZXNzYWdlRmFjdG9yeSk7CgogICAgICAgIF9nZXQoT2JqZWN0LmdldFByb3RvdHlwZU9mKE1lc3NhZ2VGYWN0b3J5LnByb3RvdHlwZSksICdjb25zdHJ1Y3RvcicsIHRoaXMpLmNhbGwodGhpcywgdmFsaWRhdGlvbiwgc2NoZW1hKTsKCiAgICAgICAgdmFyIF90aGlzID0gdGhpczsKICAgIH0KCiAgICBfY3JlYXRlQ2xhc3MoTWVzc2FnZUZhY3RvcnksIFt7CiAgICAgICAga2V5OiAndmFsaWRhdGUnLAogICAgICAgIHZhbHVlOiBmdW5jdGlvbiB2YWxpZGF0ZShkYXRhKSB7CiAgICAgICAgICAgIHJldHVybiBfZ2V0KE9iamVjdC5nZXRQcm90b3R5cGVPZihNZXNzYWdlRmFjdG9yeS5wcm90b3R5cGUpLCAndmFsaWRhdGUnLCB0aGlzKS5jYWxsKHRoaXMsIGRhdGEpOwogICAgICAgIH0KCiAgICAgICAgLyoqCiAgICAgICAgICogQ3JlYXRlIGEgTWVzc2FnZSB3aXRoIENSRUFURSBNZXNzYWdlVHlwZSBhbmQgQ3JlYXRlIE1lc3NhZ2UgQm9keQogICAgICAgICAqCiAgICAgICAgICogQHBhcmFtIHtVUkwuVVJMfSBmcm9tIC0gdGhlIHNlbmRlciBvZiB0aGlzIG1lc3NhZ2UKICAgICAgICAgKiBAcGFyYW0ge1VSTC5VUkxMaXN0fSBPbmUgb3IgbW9yZSBVUkxzIG9mIE1lc3NhZ2UgcmVjaXBpZW50cy4gQWNjb3JkaW5nIHRvIHRoZSBVUkwgc2NoZW1lIGl0IG1heSBiZSBoYW5kbGVkIGluIGRpZmZlcmVudCB3YXlzCiAgICAgICAgICogQHBhcmFtIHtPYmplY3R9IGNvbnRleHRJZCAtIHRoZSBHVUlEIHVzZWQgdG8gaWRlbnRpdHkgZWcgYSBjb21tdW5pY2F0aW9uIHNlc3Npb24gbGlrZSBhIHRlbGVwaG9ueSBjYWxsCiAgICAgICAgICogQHBhcmFtIHtzdHJpbmd9IHZhbHVlIC0gdGhlIGNyZWF0ZWQgb2JqZWN0IGluIEpTT04gZm9ybWF0CiAgICAgICAgICogQHBhcmFtIHtVUkwuVVJMfSBwb2xpY3kgLSBVUkwgZnJvbSB3aGVyZSBhY2Nlc3MgcG9saWN5IGNvbnRyb2wgY2FuIGJlIGRvd25sb2FkZWQKICAgICAgICAgKiBAcGFyYW0ge0lkZW50aXR5LkpXVH0gaWRUb2tlbiAtIHRva2VuIGZvciBJZGVudGl0eSBhc3NlcnRpb24gcHVycG9zZQogICAgICAgICAqIEBwYXJhbSB7SWRlbnRpdHkuSldUfSBhY2Nlc3NUb2tlbiAtIGFjY2VzcyB0b2tlbiBmb3IgYWNjZXNzIGNvbnRyb2wgcHVycG9zZXMKICAgICAgICAgKiBAcGFyYW0ge1VSTC5VUmx9IHJlc291cmNlIC0gVVJMIG9mIERhdGEgT2JqZWN0IFJlc291cmNlIGFzc29jaWF0ZWQgd2l0aCB0aGUgbWVzc2FnZQogICAgICAgICAqIEBwYXJhbSB7c3RyaW5nfSBzaWduYXR1cmUgLQogICAgICAgICAqIEByZXR1cm4ge01lc3NhZ2V9IENyZWF0ZSBNZXNzYWdlCiAgICAgICAgICovCiAgICB9LCB7CiAgICAgICAga2V5OiAnY3JlYXRlTWVzc2FnZVJlcXVlc3QnLAogICAgICAgIHZhbHVlOiBmdW5jdGlvbiBjcmVhdGVNZXNzYWdlUmVxdWVzdChmcm9tLCB0bywgY29udGV4dElkLCB2YWx1ZSwgcG9saWN5LCBpZFRva2VuLCBhY2Nlc3NUb2tlbiwgcmVzb3VyY2UsIHNpZ25hdHVyZSkgewogICAgICAgICAgICBpZiAodHlwZW9mIGZyb20gPT09ICd1bmRlZmluZWQnIHx8IHR5cGVvZiBjb250ZXh0SWQgPT09ICd1bmRlZmluZWQnIHx8IHR5cGVvZiB2YWx1ZSA9PT0gJ3VuZGVmaW5lZCcpIHRocm93IG5ldyBFcnJvcigiZnJvbSwgY29udGV4dElkLCBhbmQgdmFsdWUgb2Ygb2JqZWN0IHRvIGJlIGNyZWF0ZWQgTVVTVCBiZSBzcGVjaWZpZWQiKTsKCiAgICAgICAgICAgIHZhciBtZXNzYWdlQm9keSA9IG5ldyBfTWVzc2FnZUJvZHlKcy5DcmVhdGVNZXNzYWdlQm9keSh2YWx1ZSwgcG9saWN5LCBpZFRva2VuLCBhY2Nlc3NUb2tlbiwgcmVzb3VyY2UpOwogICAgICAgICAgICB2YXIgbWVzc2FnZSA9IG5ldyBfTWVzc2FnZUpzMlsnZGVmYXVsdCddKE1lc3NhZ2VGYWN0b3J5LmdlbmVyYXRlR1VJRCgpLCBmcm9tLCB0bywgX01lc3NhZ2VKcy5NZXNzYWdlVHlwZS5DUkVBVEUsIGNvbnRleHRJZCwgbWVzc2FnZUJvZHksIHNpZ25hdHVyZSk7CiAgICAgICAgICAgIHJldHVybiBtZXNzYWdlOwogICAgICAgIH0KCiAgICAgICAgLyoqCiAgICAgICAgICogQ3JlYXRlIGEgRGVsZXRlIE1lc3NhZ2UgUmVxdWVzdCBmcm9tIGdpdmVuIE1lc3NhZ2UKICAgICAgICAgKiBAcGFyYW0ge01lc3NhZ2V9IGRhdGEgLSB0aGUgaW5wdXQgTWVzc2FnZQogICAgICAgICAqIEBwYXJhbSB7c3RyaW5nfSBhdHRyaWJ1dGUgLSB0aGUgYXR0cmlidXRlIHRvIGJlIGRlbGV0ZWQKICAgICAgICAgKiBAcmV0dXJuIHtNZXNzYWdlfSBEZWxldGUgTWVzc2FnZQogICAgICAgICAqLwogICAgfSwgewogICAgICAgIGtleTogJ2NyZWF0ZURlbGV0ZU1lc3NhZ2VSZXF1ZXN0JywKICAgICAgICB2YWx1ZTogZnVuY3Rpb24gY3JlYXRlRGVsZXRlTWVzc2FnZVJlcXVlc3QoZGF0YSwgYXR0cmlidXRlKSB7CiAgICAgICAgICAgIGlmICh0eXBlb2YgZGF0YSA9PT0gJ3VuZGVmaW5lZCcgfHwgdHlwZW9mIGF0dHJpYnV0ZSA9PT0gJ3VuZGVmaW5lZCcpIHRocm93IG5ldyBFcnJvcigibWVzc2FnZSBhbmQgYXR0cmlidXRlIE1VU1QgYmUgc3BlY2lmaWVkIik7CiAgICAgICAgICAgIHZhciBuZXdCb2R5ID0gbmV3IF9NZXNzYWdlQm9keUpzLkRlbGV0ZU1lc3NhZ2VCb2R5KGRhdGEsIGF0dHJpYnV0ZSk7CiAgICAgICAgICAgIHJldHVybiBuZXcgX01lc3NhZ2VKczJbJ2RlZmF1bHQnXShkYXRhLmlkLCBkYXRhLmZyb20sIGRhdGEudG8sIF9NZXNzYWdlSnMuTWVzc2FnZVR5cGUuREVMRVRFLCBkYXRhLmNvbnRleHRJZCwgbmV3Qm9keSwgZGF0YS5zaWduYXR1cmUpOwogICAgICAgIH0KCiAgICAgICAgLyoqCiAgICAgICAgICogQ3JlYXRlcyBhbiBVcGRhdGUgTWVzc2FnZSBSZXF1ZXN0IGZyb20gdGhlIGdpdmVuIE1lc3NhZ2UKICAgICAgICAgKiBAcGFyYW0ge01lc3NhZ2V9IGRhdGEKICAgICAgICAgKiBAcGFyYW0ge3N0cmluZ30gYXR0cmlidXRlIHRvIGJlIHVwZGF0ZWQKICAgICAgICAgKiBAcGFyYW0ge29iamVjdH0gdmFsdWUgdGhlIG5ldyB2YWx1ZSBvZiB0aGUgYXR0cmlidXRlCiAgICAgICAgICogQHJldHVybiB7TWVzc2FnZX0gVXBkYXRlIE1lc3NhZ2UKICAgICAgICAgKi8KICAgIH0sIHsKICAgICAgICBrZXk6ICdjcmVhdGVVcGRhdGVNZXNzYWdlUmVxdWVzdCcsCiAgICAgICAgdmFsdWU6IGZ1bmN0aW9uIGNyZWF0ZVVwZGF0ZU1lc3NhZ2VSZXF1ZXN0KGRhdGEsIGF0dHJpYnV0ZSwgdmFsdWUpIHsKICAgICAgICAgICAgaWYgKCFkYXRhIHx8ICFhdHRyaWJ1dGUgfHwgIXZhbHVlKSB0aHJvdyBuZXcgRXJyb3IoIm1lc3NhZ2UgYXR0cmlidXRlIGFuZCB2YWx1ZSBNVVNUIGJlIHNwZWNpZmllZCIpOwogICAgICAgICAgICB2YXIgbmV3Qm9keSA9IG5ldyBfTWVzc2FnZUJvZHlKcy5VcGRhdGVNZXNzYWdlQm9keShkYXRhLCBhdHRyaWJ1dGUsIHZhbHVlKTsKICAgICAgICAgICAgcmV0dXJuIG5ldyBfTWVzc2FnZUpzMlsnZGVmYXVsdCddKGRhdGEuaWQsIGRhdGEuZnJvbSwgZGF0YS50bywgX01lc3NhZ2VKcy5NZXNzYWdlVHlwZS5VUERBVEUsIGRhdGEuY29udGV4dElkLCBuZXdCb2R5LCBkYXRhLnNpZ25hdHVyZSk7CiAgICAgICAgfQoKICAgICAgICAvKioKICAgICAgICAgKiBDcmVhdGVzIGEgUmVhZCBNZXNzYWdlIHJlcXVlc3QKICAgICAgICAgKiBAcGFyYW0ge01lc3NhZ2V9IGRhdGEKICAgICAgICAgKiBAcGFyYW0ge09iamVjdH0gYXR0cmlidXRlCiAgICAgICAgICogQHBhcmFtIHtPYmplY3R9IGNyaXRlcmlhCiAgICAgICAgICogQHBhcmFtIHtPYmplY3R9IGNyaXRlcmlhU3ludGF4CiAgICAgICAgICovCiAgICB9LCB7CiAgICAgICAga2V5OiAnY3JlYXRlUmVhZE1lc3NhZ2VSZXF1ZXN0JywKICAgICAgICB2YWx1ZTogZnVuY3Rpb24gY3JlYXRlUmVhZE1lc3NhZ2VSZXF1ZXN0KGRhdGEsIGF0dHJpYnV0ZSwgY3JpdGVyaWEsIGNyaXRlcmlhU3ludGF4KSB7CgogICAgICAgICAgICB2YXIgbmV3Qm9keSA9IG5ldyBfTWVzc2FnZUJvZHlKcy5SZWFkTWVzc2FnZUJvZHkoZGF0YSwgYXR0cmlidXRlLCBjcml0ZXJpYVN5bnRheCwgY3JpdGVyaWEpOwogICAgICAgICAgICByZXR1cm4gbmV3IF9NZXNzYWdlSnMyWydkZWZhdWx0J10oZGF0YS5pZCwgZGF0YS5mcm9tLCBkYXRhLnRvLCBfTWVzc2FnZUpzLk1lc3NhZ2VUeXBlLlJFQUQsIGRhdGEuY29udGV4dElkLCBuZXdCb2R5LCBkYXRhLnNpZ25hdHVyZSk7CiAgICAgICAgfQogICAgfSwgewogICAgICAgIGtleTogJ2NyZWF0ZVJlc3BvbnNlJywKICAgICAgICB2YWx1ZTogZnVuY3Rpb24gY3JlYXRlUmVzcG9uc2UoZGF0YSwgY29kZSwgdmFsdWUpIHsKICAgICAgICAgICAgaWYgKCFkYXRhIHx8ICFjb2RlKSB0aHJvdyBuZXcgRXJyb3IoIm1lc3NhZ2UgYW5kIHJlc3BvbnNlIGNvZGUgTVVTVCBiZSBzcGVjaWZpZWQiKTsKICAgICAgICAgICAgdmFyIHJlc3BvbnNlID0gbmV3IF9NZXNzYWdlQm9keUpzLlJlc3BvbnNlTWVzc2FnZUJvZHkoZGF0YSwgY29kZSwgdmFsdWUpOwogICAgICAgICAgICByZXR1cm4gbmV3IF9NZXNzYWdlSnMyWydkZWZhdWx0J10oZGF0YS5pZCwgZGF0YS5mcm9tLCBkYXRhLnRvLCBfTWVzc2FnZUpzLk1lc3NhZ2VUeXBlLlJFU1BPTlNFLCBkYXRhLmNvbnRleHRJZCwgcmVzcG9uc2UsIGRhdGEuc2lnbmF0dXJlKTsKICAgICAgICB9CiAgICB9XSwgW3sKICAgICAgICBrZXk6ICdnZW5lcmF0ZUdVSUQnLAogICAgICAgIHZhbHVlOiBmdW5jdGlvbiBnZW5lcmF0ZUdVSUQoKSB7CiAgICAgICAgICAgIHZhciBkID0gbmV3IERhdGUoKS5nZXRUaW1lKCk7CgogICAgICAgICAgICByZXR1cm4gJ3h4eHh4eHh4LXh4eHgtNHh4eC15eHh4LXh4eHh4eHh4eHh4eCcucmVwbGFjZSgvW3h5XS9nLCBmdW5jdGlvbiAoYykgewogICAgICAgICAgICAgICAgdmFyIHIgPSAoZCArIE1hdGgucmFuZG9tKCkgKiAxNikgJSAxNiB8IDA7CiAgICAgICAgICAgICAgICBkID0gTWF0aC5mbG9vcihkIC8gMTYpOwogICAgICAgICAgICAgICAgcmV0dXJuIChjID09ICd4JyA/IHIgOiByICYgMHgzIHwgMHg4KS50b1N0cmluZygxNik7CiAgICAgICAgICAgIH0pOwogICAgICAgIH0KICAgIH1dKTsKCiAgICByZXR1cm4gTWVzc2FnZUZhY3Rvcnk7Cn0pKF9yZVRISU5LT2JqZWN0UmV0aGlua09iamVjdEpzMlsnZGVmYXVsdCddKTsKCmV4cG9ydHNbJ2RlZmF1bHQnXSA9IE1lc3NhZ2VGYWN0b3J5Owptb2R1bGUuZXhwb3J0cyA9IGV4cG9ydHNbJ2RlZmF1bHQnXTsKCn0seyIuLi9yZVRISU5LT2JqZWN0L1JldGhpbmtPYmplY3QuanMiOjE3LCIuL01lc3NhZ2UuanMiOjE0LCIuL01lc3NhZ2VCb2R5LmpzIjoxNX1dLDE3OltmdW5jdGlvbihyZXF1aXJlLG1vZHVsZSxleHBvcnRzKXsKInVzZSBzdHJpY3QiOwoKT2JqZWN0LmRlZmluZVByb3BlcnR5KGV4cG9ydHMsICJfX2VzTW9kdWxlIiwgewogICAgdmFsdWU6IHRydWUKfSk7Cgp2YXIgX2NyZWF0ZUNsYXNzID0gKGZ1bmN0aW9uICgpIHsgZnVuY3Rpb24gZGVmaW5lUHJvcGVydGllcyh0YXJnZXQsIHByb3BzKSB7IGZvciAodmFyIGkgPSAwOyBpIDwgcHJvcHMubGVuZ3RoOyBpKyspIHsgdmFyIGRlc2NyaXB0b3IgPSBwcm9wc1tpXTsgZGVzY3JpcHRvci5lbnVtZXJhYmxlID0gZGVzY3JpcHRvci5lbnVtZXJhYmxlIHx8IGZhbHNlOyBkZXNjcmlwdG9yLmNvbmZpZ3VyYWJsZSA9IHRydWU7IGlmICgidmFsdWUiIGluIGRlc2NyaXB0b3IpIGRlc2NyaXB0b3Iud3JpdGFibGUgPSB0cnVlOyBPYmplY3QuZGVmaW5lUHJvcGVydHkodGFyZ2V0LCBkZXNjcmlwdG9yLmtleSwgZGVzY3JpcHRvcik7IH0gfSByZXR1cm4gZnVuY3Rpb24gKENvbnN0cnVjdG9yLCBwcm90b1Byb3BzLCBzdGF0aWNQcm9wcykgeyBpZiAocHJvdG9Qcm9wcykgZGVmaW5lUHJvcGVydGllcyhDb25zdHJ1Y3Rvci5wcm90b3R5cGUsIHByb3RvUHJvcHMpOyBpZiAoc3RhdGljUHJvcHMpIGRlZmluZVByb3BlcnRpZXMoQ29uc3RydWN0b3IsIHN0YXRpY1Byb3BzKTsgcmV0dXJuIENvbnN0cnVjdG9yOyB9OyB9KSgpOwoKZnVuY3Rpb24gX2ludGVyb3BSZXF1aXJlRGVmYXVsdChvYmopIHsgcmV0dXJuIG9iaiAmJiBvYmouX19lc01vZHVsZSA/IG9iaiA6IHsgImRlZmF1bHQiOiBvYmogfTsgfQoKZnVuY3Rpb24gX2NsYXNzQ2FsbENoZWNrKGluc3RhbmNlLCBDb25zdHJ1Y3RvcikgeyBpZiAoIShpbnN0YW5jZSBpbnN0YW5jZW9mIENvbnN0cnVjdG9yKSkgeyB0aHJvdyBuZXcgVHlwZUVycm9yKCJDYW5ub3QgY2FsbCBhIGNsYXNzIGFzIGEgZnVuY3Rpb24iKTsgfSB9Cgp2YXIgX3R2NCA9IHJlcXVpcmUoInR2NCIpOwoKdmFyIF90djQyID0gX2ludGVyb3BSZXF1aXJlRGVmYXVsdChfdHY0KTsKCnZhciBSZXRoaW5rT2JqZWN0ID0gKGZ1bmN0aW9uICgpIHsKICAgIGZ1bmN0aW9uIFJldGhpbmtPYmplY3QodmFsaWRhdGlvbiwgc2NoZW1hKSB7CiAgICAgICAgX2NsYXNzQ2FsbENoZWNrKHRoaXMsIFJldGhpbmtPYmplY3QpOwoKICAgICAgICB2YXIgX3RoaXMgPSB0aGlzOwoKICAgICAgICB0aGlzLnZhbGlkYXRpb24gPSB2YWxpZGF0aW9uOwogICAgICAgIHRoaXMuc2NoZW1hID0gc2NoZW1hOwogICAgfQoKICAgIF9jcmVhdGVDbGFzcyhSZXRoaW5rT2JqZWN0LCBbewogICAgICAgIGtleTogInZhbGlkYXRlIiwKICAgICAgICB2YWx1ZTogZnVuY3Rpb24gdmFsaWRhdGUoZGF0YSkgewogICAgICAgICAgICBpZiAodGhpcy5zY2hlbWEpIHJldHVybiBfdHY0MlsiZGVmYXVsdCJdLnZhbGlkYXRlKGRhdGEsIHRoaXMuc2NoZW1hKTtlbHNlIHJldHVybiBmYWxzZTsKICAgICAgICB9CiAgICB9XSk7CgogICAgcmV0dXJuIFJldGhpbmtPYmplY3Q7Cn0pKCk7CgpleHBvcnRzLlJldGhpbmtPYmplY3QgPSBSZXRoaW5rT2JqZWN0OwpleHBvcnRzWyJkZWZhdWx0Il0gPSBSZXRoaW5rT2JqZWN0OwoKfSx7InR2NCI6MX1dLDE4OltmdW5jdGlvbihyZXF1aXJlLG1vZHVsZSxleHBvcnRzKXsKLy8gaW1wb3J0IEFkZHJlc3NGYWN0b3J5IGZyb20gJy4vYWRkcmVzcy1mYWN0b3J5L3VybCc7Cid1c2Ugc3RyaWN0JzsKCk9iamVjdC5kZWZpbmVQcm9wZXJ0eShleHBvcnRzLCAnX19lc01vZHVsZScsIHsKICB2YWx1ZTogdHJ1ZQp9KTsKCmZ1bmN0aW9uIF9pbnRlcm9wUmVxdWlyZURlZmF1bHQob2JqKSB7IHJldHVybiBvYmogJiYgb2JqLl9fZXNNb2R1bGUgPyBvYmogOiB7ICdkZWZhdWx0Jzogb2JqIH07IH0KCnZhciBfY2F0YWxvZ3VlRmFjdG9yeUNhdGFsb2d1ZURhdGFPYmplY3RGYWN0b3J5ID0gcmVxdWlyZSgnLi9jYXRhbG9ndWUtZmFjdG9yeS9DYXRhbG9ndWVEYXRhT2JqZWN0RmFjdG9yeScpOwoKdmFyIF9jYXRhbG9ndWVGYWN0b3J5Q2F0YWxvZ3VlRGF0YU9iamVjdEZhY3RvcnkyID0gX2ludGVyb3BSZXF1aXJlRGVmYXVsdChfY2F0YWxvZ3VlRmFjdG9yeUNhdGFsb2d1ZURhdGFPYmplY3RGYWN0b3J5KTsKCnZhciBfbWVzc2FnZUZhY3RvcnlNZXNzYWdlRmFjdG9yeSA9IHJlcXVpcmUoJy4vbWVzc2FnZS1mYWN0b3J5L01lc3NhZ2VGYWN0b3J5Jyk7Cgp2YXIgX21lc3NhZ2VGYWN0b3J5TWVzc2FnZUZhY3RvcnkyID0gX2ludGVyb3BSZXF1aXJlRGVmYXVsdChfbWVzc2FnZUZhY3RvcnlNZXNzYWdlRmFjdG9yeSk7Cgp2YXIgX3N5bmNoZXJTeW5jaGVyID0gcmVxdWlyZSgnLi9zeW5jaGVyL1N5bmNoZXInKTsKCnZhciBfc3luY2hlclN5bmNoZXIyID0gX2ludGVyb3BSZXF1aXJlRGVmYXVsdChfc3luY2hlclN5bmNoZXIpOwoKdmFyIF9zeW5jaGVyRGF0YU9iamVjdFJlcG9ydGVyID0gcmVxdWlyZSgnLi9zeW5jaGVyL0RhdGFPYmplY3RSZXBvcnRlcicpOwoKdmFyIF9zeW5jaGVyRGF0YU9iamVjdFJlcG9ydGVyMiA9IF9pbnRlcm9wUmVxdWlyZURlZmF1bHQoX3N5bmNoZXJEYXRhT2JqZWN0UmVwb3J0ZXIpOwoKdmFyIF9zeW5jaGVyRGF0YU9iamVjdE9ic2VydmVyID0gcmVxdWlyZSgnLi9zeW5jaGVyL0RhdGFPYmplY3RPYnNlcnZlcicpOwoKdmFyIF9zeW5jaGVyRGF0YU9iamVjdE9ic2VydmVyMiA9IF9pbnRlcm9wUmVxdWlyZURlZmF1bHQoX3N5bmNoZXJEYXRhT2JqZWN0T2JzZXJ2ZXIpOwoKdmFyIF9oeXBlcnR5SHlwZXJ0eUNvbm5lY3RvciA9IHJlcXVpcmUoJy4vaHlwZXJ0eS9IeXBlcnR5Q29ubmVjdG9yJyk7Cgp2YXIgX2h5cGVydHlIeXBlcnR5Q29ubmVjdG9yMiA9IF9pbnRlcm9wUmVxdWlyZURlZmF1bHQoX2h5cGVydHlIeXBlcnR5Q29ubmVjdG9yKTsKCi8vIGV4cG9ydCB7QWRkcmVzc0ZhY3Rvcnl9OwpleHBvcnRzLkNhdGFsb2d1ZUZhY3RvcnkgPSBfY2F0YWxvZ3VlRmFjdG9yeUNhdGFsb2d1ZURhdGFPYmplY3RGYWN0b3J5MlsnZGVmYXVsdCddOwpleHBvcnRzLk1lc3NhZ2VGYWN0b3J5ID0gX21lc3NhZ2VGYWN0b3J5TWVzc2FnZUZhY3RvcnkyWydkZWZhdWx0J107CmV4cG9ydHMuU3luY2hlciA9IF9zeW5jaGVyU3luY2hlcjJbJ2RlZmF1bHQnXTsKZXhwb3J0cy5EYXRhT2JqZWN0UmVwb3J0ZXIgPSBfc3luY2hlckRhdGFPYmplY3RSZXBvcnRlcjJbJ2RlZmF1bHQnXTsKZXhwb3J0cy5EYXRhT2JqZWN0T2JzZXJ2ZXIgPSBfc3luY2hlckRhdGFPYmplY3RPYnNlcnZlcjJbJ2RlZmF1bHQnXTsKZXhwb3J0cy5IeXBlcnR5Q29ubmVjdG9yID0gX2h5cGVydHlIeXBlcnR5Q29ubmVjdG9yMlsnZGVmYXVsdCddOwoKfSx7Ii4vY2F0YWxvZ3VlLWZhY3RvcnkvQ2F0YWxvZ3VlRGF0YU9iamVjdEZhY3RvcnkiOjUsIi4vaHlwZXJ0eS9IeXBlcnR5Q29ubmVjdG9yIjoxMywiLi9tZXNzYWdlLWZhY3RvcnkvTWVzc2FnZUZhY3RvcnkiOjE2LCIuL3N5bmNoZXIvRGF0YU9iamVjdE9ic2VydmVyIjoxOSwiLi9zeW5jaGVyL0RhdGFPYmplY3RSZXBvcnRlciI6MjAsIi4vc3luY2hlci9TeW5jaGVyIjoyMn1dLDE5OltmdW5jdGlvbihyZXF1aXJlLG1vZHVsZSxleHBvcnRzKXsKJ3VzZSBzdHJpY3QnOwoKT2JqZWN0LmRlZmluZVByb3BlcnR5KGV4cG9ydHMsICdfX2VzTW9kdWxlJywgewogIHZhbHVlOiB0cnVlCn0pOwoKdmFyIF9jcmVhdGVDbGFzcyA9IChmdW5jdGlvbiAoKSB7IGZ1bmN0aW9uIGRlZmluZVByb3BlcnRpZXModGFyZ2V0LCBwcm9wcykgeyBmb3IgKHZhciBpID0gMDsgaSA8IHByb3BzLmxlbmd0aDsgaSsrKSB7IHZhciBkZXNjcmlwdG9yID0gcHJvcHNbaV07IGRlc2NyaXB0b3IuZW51bWVyYWJsZSA9IGRlc2NyaXB0b3IuZW51bWVyYWJsZSB8fCBmYWxzZTsgZGVzY3JpcHRvci5jb25maWd1cmFibGUgPSB0cnVlOyBpZiAoJ3ZhbHVlJyBpbiBkZXNjcmlwdG9yKSBkZXNjcmlwdG9yLndyaXRhYmxlID0gdHJ1ZTsgT2JqZWN0LmRlZmluZVByb3BlcnR5KHRhcmdldCwgZGVzY3JpcHRvci5rZXksIGRlc2NyaXB0b3IpOyB9IH0gcmV0dXJuIGZ1bmN0aW9uIChDb25zdHJ1Y3RvciwgcHJvdG9Qcm9wcywgc3RhdGljUHJvcHMpIHsgaWYgKHByb3RvUHJvcHMpIGRlZmluZVByb3BlcnRpZXMoQ29uc3RydWN0b3IucHJvdG90eXBlLCBwcm90b1Byb3BzKTsgaWYgKHN0YXRpY1Byb3BzKSBkZWZpbmVQcm9wZXJ0aWVzKENvbnN0cnVjdG9yLCBzdGF0aWNQcm9wcyk7IHJldHVybiBDb25zdHJ1Y3RvcjsgfTsgfSkoKTsKCmZ1bmN0aW9uIF9pbnRlcm9wUmVxdWlyZURlZmF1bHQob2JqKSB7IHJldHVybiBvYmogJiYgb2JqLl9fZXNNb2R1bGUgPyBvYmogOiB7ICdkZWZhdWx0Jzogb2JqIH07IH0KCmZ1bmN0aW9uIF9jbGFzc0NhbGxDaGVjayhpbnN0YW5jZSwgQ29uc3RydWN0b3IpIHsgaWYgKCEoaW5zdGFuY2UgaW5zdGFuY2VvZiBDb25zdHJ1Y3RvcikpIHsgdGhyb3cgbmV3IFR5cGVFcnJvcignQ2Fubm90IGNhbGwgYSBjbGFzcyBhcyBhIGZ1bmN0aW9uJyk7IH0gfQoKdmFyIF9TeW5jT2JqZWN0ID0gcmVxdWlyZSgnLi9TeW5jT2JqZWN0Jyk7Cgp2YXIgX1N5bmNPYmplY3QyID0gX2ludGVyb3BSZXF1aXJlRGVmYXVsdChfU3luY09iamVjdCk7Cgp2YXIgRmlsdGVyVHlwZSA9IHsgQU5ZOiAnYW55JywgU1RBUlQ6ICdzdGFydCcsIEVYQUNUOiAnZXhhY3QnIH07Cgp2YXIgRGF0YU9iamVjdE9ic2VydmVyIC8qIGltcGxlbWVudHMgU3luY1N0YXR1cyAqLyA9IChmdW5jdGlvbiAoKSB7CiAgLyogcHJpdmF0ZQogIF92ZXJzaW9uOiBudW1iZXIKICBfb3duZXI6IEh5cGVydHlVUkwKICAgX3VybDogT2JqZWN0VVJMCiAgX3NjaGVtYTogU2NoZW1hCiAgX3N0YXR1czogb24gfCBwYXVzZWQKICAgX3N5bmNPYmo6IFN5bmNEYXRhCiAgIC0tLS1ldmVudCBoYW5kbGVycy0tLS0KICBfZmlsdGVyczogezxmaWx0ZXI+OiB7dHlwZTogPHN0YXJ0LCBleGFjdD4sIGNhbGxiYWNrOiA8ZnVuY3Rpb24+fSB9CiAgKi8KCiAgZnVuY3Rpb24gRGF0YU9iamVjdE9ic2VydmVyKG93bmVyVVJMLCBvYmplY3RVUkwsIHNjaGVtYSwgaW5pdGlhbFN0YXR1cywgaW5pdGlhbERhdGEpIHsKICAgIF9jbGFzc0NhbGxDaGVjayh0aGlzLCBEYXRhT2JqZWN0T2JzZXJ2ZXIpOwoKICAgIHZhciBfdGhpcyA9IHRoaXM7CgogICAgX3RoaXMuX3ZlcnNpb24gPSAwOwogICAgX3RoaXMuX293bmVyID0gb3duZXJVUkw7CiAgICBfdGhpcy5fdXJsID0gb2JqZWN0VVJMOwogICAgX3RoaXMuX3NjaGVtYSA9IHNjaGVtYTsKCiAgICBfdGhpcy5fc3RhdHVzID0gaW5pdGlhbFN0YXR1czsKICAgIF90aGlzLl9zeW5jT2JqID0gbmV3IF9TeW5jT2JqZWN0MlsnZGVmYXVsdCddKGluaXRpYWxEYXRhKTsKICAgIF90aGlzLl9zeW5jT2JqLm9ic2VydmUoZnVuY3Rpb24gKGV2ZW50KSB7CiAgICAgIF90aGlzLl9vbkZpbHRlcihldmVudCk7CiAgICB9KTsKCiAgICBfdGhpcy5fZmlsdGVycyA9IHt9OwogIH0KCiAgX2NyZWF0ZUNsYXNzKERhdGFPYmplY3RPYnNlcnZlciwgW3sKICAgIGtleTogJ3BhdXNlJywKICAgIHZhbHVlOiBmdW5jdGlvbiBwYXVzZSgpIHsKICAgICAgLy9UT0RPOiB0aGlzIGZlYXR1cmUgbmVlZHMgbW9yZSBhbmFsaXNlCiAgICAgIHRocm93ICdOb3QgaW1wbGVtZW50ZWQnOwogICAgfQogIH0sIHsKICAgIGtleTogJ3Jlc3VtZScsCiAgICB2YWx1ZTogZnVuY3Rpb24gcmVzdW1lKCkgewogICAgICAvL1RPRE86IHRoaXMgZmVhdHVyZSBuZWVkcyBtb3JlIGFuYWxpc2UKICAgICAgdGhyb3cgJ05vdCBpbXBsZW1lbnRlZCc7CiAgICB9CiAgfSwgewogICAga2V5OiAnc3RvcCcsCiAgICB2YWx1ZTogZnVuY3Rpb24gc3RvcCgpIHsKICAgICAgLy9UT0RPOiBzaG91bGQgcmVtb3ZlIHRoZSBzdWJzY3JpcHRpb24gYW5kIHNlbmQgbWVzc2FnZSB1bnN1YnNjcmliZT8KICAgICAgdGhyb3cgJ05vdCBpbXBsZW1lbnRlZCc7CiAgICB9CgogICAgLy9yZWdpc3RlciBjaGFuZ2UgZmlsdGVyCiAgfSwgewogICAga2V5OiAnb25DaGFuZ2UnLAogICAgdmFsdWU6IGZ1bmN0aW9uIG9uQ2hhbmdlKGZpbHRlciwgY2FsbGJhY2spIHsKICAgICAgdmFyIGtleSA9IGZpbHRlcjsKICAgICAgdmFyIGZpbHRlck9iaiA9IHsKICAgICAgICB0eXBlOiBGaWx0ZXJUeXBlLkVYQUNULAogICAgICAgIGNhbGxiYWNrOiBjYWxsYmFjawogICAgICB9OwoKICAgICAgdmFyIGlkeCA9IGZpbHRlci5pbmRleE9mKCcqJyk7CiAgICAgIGlmIChpZHggPT09IGZpbHRlci5sZW5ndGggLSAxKSB7CiAgICAgICAgaWYgKGlkeCA9PT0gMCkgewogICAgICAgICAgZmlsdGVyT2JqLnR5cGUgPSBGaWx0ZXJUeXBlLkFOWTsKICAgICAgICB9IGVsc2UgewogICAgICAgICAgZmlsdGVyT2JqLnR5cGUgPSBGaWx0ZXJUeXBlLlNUQVJUOwogICAgICAgICAga2V5ID0gZmlsdGVyLnN1YnN0cigwLCBmaWx0ZXIubGVuZ3RoIC0gMSk7CiAgICAgICAgfQogICAgICB9CgogICAgICB0aGlzLl9maWx0ZXJzW2tleV0gPSBmaWx0ZXJPYmo7CiAgICB9CgogICAgLy9maWx0ZXIgY2hhbmdlcwogIH0sIHsKICAgIGtleTogJ19vbkZpbHRlcicsCiAgICB2YWx1ZTogZnVuY3Rpb24gX29uRmlsdGVyKGV2ZW50KSB7CiAgICAgIHZhciBfdGhpcyA9IHRoaXM7CgogICAgICBPYmplY3Qua2V5cyhfdGhpcy5fZmlsdGVycykuZm9yRWFjaChmdW5jdGlvbiAoa2V5KSB7CiAgICAgICAgdmFyIGZpbHRlciA9IF90aGlzLl9maWx0ZXJzW2tleV07CiAgICAgICAgaWYgKGZpbHRlci50eXBlID09PSBGaWx0ZXJUeXBlLkFOWSkgewogICAgICAgICAgLy9tYXRjaCBhbnl0aGluZwogICAgICAgICAgZmlsdGVyLmNhbGxiYWNrKGV2ZW50KTsKICAgICAgICB9IGVsc2UgaWYgKGZpbHRlci50eXBlID09PSBGaWx0ZXJUeXBlLlNUQVJUKSB7CiAgICAgICAgICAvL2lmIHN0YXJ0cyB3aXRoIGZpbHRlci4uLgogICAgICAgICAgaWYgKGV2ZW50LmZpZWxkLmluZGV4T2Yoa2V5KSA9PT0gMCkgewogICAgICAgICAgICBmaWx0ZXIuY2FsbGJhY2soZXZlbnQpOwogICAgICAgICAgfQogICAgICAgIH0gZWxzZSBpZiAoZmlsdGVyLnR5cGUgPT09IEZpbHRlclR5cGUuRVhBQ1QpIHsKICAgICAgICAgIC8vZXhhY3QgbWF0Y2gKICAgICAgICAgIGlmIChldmVudC5maWVsZCA9PT0ga2V5KSB7CiAgICAgICAgICAgIGZpbHRlci5jYWxsYmFjayhldmVudCk7CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICB9KTsKICAgIH0KCiAgICAvL3JlY2VpdmUgYW5kIHByb2Nlc3MgY2hhbmdlIG1lc3NhZ2VzCiAgfSwgewogICAga2V5OiAnX2NoYW5nZU9iamVjdCcsCiAgICB2YWx1ZTogZnVuY3Rpb24gX2NoYW5nZU9iamVjdChtc2cpIHsKICAgICAgdmFyIF90aGlzID0gdGhpczsKCiAgICAgIC8vVE9ETzogdXBkYXRlIHZlcnNpb24gPwogICAgICAvL2hvdyB0byBoYW5kbGUgYW4gaW5jb3JyZWN0IHZlcnNpb24gPyBFeGFtcGxlOiByZWNlaXZlIGEgdmVyc2lvbiAzIHdoZW4gdGhlIG9ic2VydmVyIGlzIGluIHZlcnNpb24gMSwgd2hlcmUgaXMgdGhlIHZlcnNpb24gMiA/CiAgICAgIC8vd2lsbCB3ZSBuZWVkIHRvIGNvbmZpcm0gdGhlIHJlY2VwdGlvbiA/CiAgICAgIGlmIChfdGhpcy5fdmVyc2lvbiArIDEgPT09IG1zZy5ib2R5LnZlcnNpb24pIHsKICAgICAgICBfdGhpcy5fdmVyc2lvbisrOwogICAgICAgIHZhciBwYXRoID0gbXNnLmJvZHkuYXR0cmliOwogICAgICAgIHZhciB2YWx1ZSA9IG1zZy5ib2R5LnZhbHVlOwogICAgICAgIHZhciBmaW5kUmVzdWx0ID0gX3RoaXMuX3N5bmNPYmouZmluZEJlZm9yZShwYXRoKTsKCiAgICAgICAgaWYgKG1zZy50eXBlID09PSBfU3luY09iamVjdC5DaGFuZ2VUeXBlLlVQREFURSkgewogICAgICAgICAgZmluZFJlc3VsdC5vYmpbZmluZFJlc3VsdC5sYXN0XSA9IHZhbHVlOwogICAgICAgIH0gZWxzZSB7CiAgICAgICAgICBpZiAobXNnLnR5cGUgPT09IF9TeW5jT2JqZWN0LkNoYW5nZVR5cGUuQUREKSB7CiAgICAgICAgICAgIGlmIChtc2cuYm9keS5vVHlwZSA9PT0gX1N5bmNPYmplY3QuT2JqZWN0VHlwZS5PQkpFQ1QpIHsKICAgICAgICAgICAgICBmaW5kUmVzdWx0Lm9ialtmaW5kUmVzdWx0Lmxhc3RdID0gdmFsdWU7CiAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgLy9BUlJBWQogICAgICAgICAgICAgIHZhciBhcnIgPSBmaW5kUmVzdWx0Lm9iajsKICAgICAgICAgICAgICB2YXIgaW5kZXggPSBmaW5kUmVzdWx0Lmxhc3Q7CiAgICAgICAgICAgICAgQXJyYXkucHJvdG90eXBlLnNwbGljZS5hcHBseShhcnIsIFtpbmRleCwgMF0uY29uY2F0KHZhbHVlKSk7CiAgICAgICAgICAgIH0KICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgIC8vUkVNT1ZFCiAgICAgICAgICAgIGlmIChtc2cuYm9keS5vVHlwZSA9PT0gX1N5bmNPYmplY3QuT2JqZWN0VHlwZS5PQkpFQ1QpIHsKICAgICAgICAgICAgICBkZWxldGUgZmluZFJlc3VsdC5vYmpbZmluZFJlc3VsdC5sYXN0XTsKICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAvL0FSUkFZCiAgICAgICAgICAgICAgdmFyIGFyciA9IGZpbmRSZXN1bHQub2JqOwogICAgICAgICAgICAgIHZhciBpbmRleCA9IGZpbmRSZXN1bHQubGFzdDsKICAgICAgICAgICAgICBhcnIuc3BsaWNlKGluZGV4LCB2YWx1ZSk7CiAgICAgICAgICAgIH0KICAgICAgICAgIH0KICAgICAgICB9CiAgICAgIH0gZWxzZSB7CiAgICAgICAgLy9UT0RPOiBob3cgdG8gaGFuZGxlIHVuc3luY2hyb25pemVkIHZlcnNpb25zPwogICAgICAgIGNvbnNvbGUubG9nKCd1bnN5bmNocm9uaXplZCB2ZXJzaW9ucycpOwogICAgICB9CiAgICB9CiAgfSwgewogICAga2V5OiAndmVyc2lvbicsCiAgICBnZXQ6IGZ1bmN0aW9uIGdldCgpIHsKICAgICAgcmV0dXJuIHRoaXMuX3ZlcnNpb247CiAgICB9CiAgfSwgewogICAga2V5OiAnb3duZXInLAogICAgZ2V0OiBmdW5jdGlvbiBnZXQoKSB7CiAgICAgIHJldHVybiB0aGlzLl9vd25lcjsKICAgIH0KICB9LCB7CiAgICBrZXk6ICd1cmwnLAogICAgZ2V0OiBmdW5jdGlvbiBnZXQoKSB7CiAgICAgIHJldHVybiB0aGlzLl91cmw7CiAgICB9CiAgfSwgewogICAga2V5OiAnc2NoZW1hJywKICAgIGdldDogZnVuY3Rpb24gZ2V0KCkgewogICAgICByZXR1cm4gdGhpcy5fc2NoZW1hOwogICAgfQogIH0sIHsKICAgIGtleTogJ3N0YXR1cycsCiAgICBnZXQ6IGZ1bmN0aW9uIGdldCgpIHsKICAgICAgcmV0dXJuIHRoaXMuX3N0YXR1czsKICAgIH0KICB9LCB7CiAgICBrZXk6ICdkYXRhJywKICAgIGdldDogZnVuY3Rpb24gZ2V0KCkgewogICAgICByZXR1cm4gdGhpcy5fc3luY09iai5kYXRhOwogICAgfQogIH1dKTsKCiAgcmV0dXJuIERhdGFPYmplY3RPYnNlcnZlcjsKfSkoKTsKCmV4cG9ydHNbJ2RlZmF1bHQnXSA9IERhdGFPYmplY3RPYnNlcnZlcjsKbW9kdWxlLmV4cG9ydHMgPSBleHBvcnRzWydkZWZhdWx0J107Cgp9LHsiLi9TeW5jT2JqZWN0IjoyMX1dLDIwOltmdW5jdGlvbihyZXF1aXJlLG1vZHVsZSxleHBvcnRzKXsKJ3VzZSBzdHJpY3QnOwoKT2JqZWN0LmRlZmluZVByb3BlcnR5KGV4cG9ydHMsICdfX2VzTW9kdWxlJywgewogIHZhbHVlOiB0cnVlCn0pOwoKdmFyIF9jcmVhdGVDbGFzcyA9IChmdW5jdGlvbiAoKSB7IGZ1bmN0aW9uIGRlZmluZVByb3BlcnRpZXModGFyZ2V0LCBwcm9wcykgeyBmb3IgKHZhciBpID0gMDsgaSA8IHByb3BzLmxlbmd0aDsgaSsrKSB7IHZhciBkZXNjcmlwdG9yID0gcHJvcHNbaV07IGRlc2NyaXB0b3IuZW51bWVyYWJsZSA9IGRlc2NyaXB0b3IuZW51bWVyYWJsZSB8fCBmYWxzZTsgZGVzY3JpcHRvci5jb25maWd1cmFibGUgPSB0cnVlOyBpZiAoJ3ZhbHVlJyBpbiBkZXNjcmlwdG9yKSBkZXNjcmlwdG9yLndyaXRhYmxlID0gdHJ1ZTsgT2JqZWN0LmRlZmluZVByb3BlcnR5KHRhcmdldCwgZGVzY3JpcHRvci5rZXksIGRlc2NyaXB0b3IpOyB9IH0gcmV0dXJuIGZ1bmN0aW9uIChDb25zdHJ1Y3RvciwgcHJvdG9Qcm9wcywgc3RhdGljUHJvcHMpIHsgaWYgKHByb3RvUHJvcHMpIGRlZmluZVByb3BlcnRpZXMoQ29uc3RydWN0b3IucHJvdG90eXBlLCBwcm90b1Byb3BzKTsgaWYgKHN0YXRpY1Byb3BzKSBkZWZpbmVQcm9wZXJ0aWVzKENvbnN0cnVjdG9yLCBzdGF0aWNQcm9wcyk7IHJldHVybiBDb25zdHJ1Y3RvcjsgfTsgfSkoKTsKCmZ1bmN0aW9uIF9pbnRlcm9wUmVxdWlyZURlZmF1bHQob2JqKSB7IHJldHVybiBvYmogJiYgb2JqLl9fZXNNb2R1bGUgPyBvYmogOiB7ICdkZWZhdWx0Jzogb2JqIH07IH0KCmZ1bmN0aW9uIF9jbGFzc0NhbGxDaGVjayhpbnN0YW5jZSwgQ29uc3RydWN0b3IpIHsgaWYgKCEoaW5zdGFuY2UgaW5zdGFuY2VvZiBDb25zdHJ1Y3RvcikpIHsgdGhyb3cgbmV3IFR5cGVFcnJvcignQ2Fubm90IGNhbGwgYSBjbGFzcyBhcyBhIGZ1bmN0aW9uJyk7IH0gfQoKdmFyIF9TeW5jT2JqZWN0ID0gcmVxdWlyZSgnLi9TeW5jT2JqZWN0Jyk7Cgp2YXIgX1N5bmNPYmplY3QyID0gX2ludGVyb3BSZXF1aXJlRGVmYXVsdChfU3luY09iamVjdCk7Cgp2YXIgX3V0aWxzVXRpbHNKcyA9IHJlcXVpcmUoJy4uL3V0aWxzL3V0aWxzLmpzJyk7Cgp2YXIgRGF0YU9iamVjdFJlcG9ydGVyIC8qIGltcGxlbWVudHMgU3luY1N0YXR1cyAqLyA9IChmdW5jdGlvbiAoKSB7CiAgLyogcHJpdmF0ZQogIF92ZXJzaW9uOiBudW1iZXIKICAgX3VybDogT2JqZWN0VVJMCiAgX3NjaGVtYTogU2NoZW1hCiAgX2J1czogTWluaUJ1cwogIF9zdGF0dXM6IG9uIHwgcGF1c2VkCiAgIF9zeW5jT2JqOiBTeW5jRGF0YQogIF9zdWJzY3JpcHRpb25zOiA8aHlwZXJ0eVVybDogeyBzdGF0dXM6IHN0cmluZyB9IH0+CiAgIC0tLS1ldmVudCBoYW5kbGVycy0tLS0KICBfb25TdWJzY3JpcHRpb25IYW5kbGVyOiAoZXZlbnQpID0+IHZvaWQKICAqLwoKICBmdW5jdGlvbiBEYXRhT2JqZWN0UmVwb3J0ZXIob3duZXIsIHVybCwgc2NoZW1hLCBidXMsIGluaXRpYWxTdGF0dXMsIGluaXRpYWxEYXRhKSB7CiAgICBfY2xhc3NDYWxsQ2hlY2sodGhpcywgRGF0YU9iamVjdFJlcG9ydGVyKTsKCiAgICB2YXIgX3RoaXMgPSB0aGlzOwoKICAgIF90aGlzLl92ZXJzaW9uID0gMDsKICAgIF90aGlzLl9vd25lciA9IG93bmVyOwogICAgX3RoaXMuX3VybCA9IHVybDsKICAgIF90aGlzLl9zY2hlbWEgPSBzY2hlbWE7CiAgICBfdGhpcy5fYnVzID0gYnVzOwoKICAgIF90aGlzLl9zdWJzY3JpcHRpb25zID0ge307CgogICAgX3RoaXMuX3N0YXR1cyA9IGluaXRpYWxTdGF0dXM7CiAgICBfdGhpcy5fc3luY09iaiA9IG5ldyBfU3luY09iamVjdDJbJ2RlZmF1bHQnXShpbml0aWFsRGF0YSk7CiAgICBfdGhpcy5fc3luY09iai5vYnNlcnZlKGZ1bmN0aW9uIChldmVudCkgewogICAgICBfdGhpcy5fb25DaGFuZ2UoZXZlbnQpOwogICAgfSk7CiAgfQoKICBfY3JlYXRlQ2xhc3MoRGF0YU9iamVjdFJlcG9ydGVyLCBbewogICAga2V5OiAncGF1c2UnLAogICAgdmFsdWU6IGZ1bmN0aW9uIHBhdXNlKCkgewogICAgICAvL1RPRE86IHBhdXNlIGNoYW5nZSByZXBvcnRzPwogICAgfQogIH0sIHsKICAgIGtleTogJ3Jlc3VtZScsCiAgICB2YWx1ZTogZnVuY3Rpb24gcmVzdW1lKCkgewogICAgICAvL1RPRE86IHJlc3VtZSBjaGFuZ2UgcmVwb3J0cz8KICAgIH0KICB9LCB7CiAgICBrZXk6ICdzdG9wJywKICAgIHZhbHVlOiBmdW5jdGlvbiBzdG9wKCkgewogICAgICAvL1RPRE86IGRlc3Ryb3kgcmVwb3J0ZXI/CiAgICB9CiAgfSwgewogICAga2V5OiAnb25TdWJzY3JpcHRpb24nLAogICAgdmFsdWU6IGZ1bmN0aW9uIG9uU3Vic2NyaXB0aW9uKGNhbGxiYWNrKSB7CiAgICAgIHRoaXMuX29uU3Vic2NyaXB0aW9uSGFuZGxlciA9IGNhbGxiYWNrOwogICAgfQogIH0sIHsKICAgIGtleTogJ19vbkZvcndhcmQnLAogICAgdmFsdWU6IGZ1bmN0aW9uIF9vbkZvcndhcmQobXNnKSB7CiAgICAgIHZhciBfdGhpcyA9IHRoaXM7CgogICAgICBjb25zb2xlLmxvZygnRGF0YU9iamVjdFJlcG9ydGVyLVJDVjogJywgbXNnKTsKICAgICAgc3dpdGNoIChtc2cuYm9keS50eXBlKSB7CiAgICAgICAgY2FzZSAnc3Vic2NyaWJlJzoKICAgICAgICAgIF90aGlzLl9vblN1YnNjcmliZShtc2cpO2JyZWFrOwogICAgICAgIGNhc2UgJ3Vuc3Vic2NyaWJlJzoKICAgICAgICAgIF90aGlzLl9vblVuU3Vic2NyaWJlKG1zZyk7YnJlYWs7CiAgICAgIH0KICAgIH0KICB9LCB7CiAgICBrZXk6ICdfb25TdWJzY3JpYmUnLAogICAgdmFsdWU6IGZ1bmN0aW9uIF9vblN1YnNjcmliZShtc2cpIHsKICAgICAgdmFyIF90aGlzID0gdGhpczsKICAgICAgdmFyIGh5cGVydHlVcmwgPSBtc2cuYm9keS5mcm9tOwoKICAgICAgdmFyIGV2ZW50ID0gewogICAgICAgIHR5cGU6IG1zZy5ib2R5LnR5cGUsCiAgICAgICAgdXJsOiBoeXBlcnR5VXJsLAoKICAgICAgICBhY2NlcHQ6IGZ1bmN0aW9uIGFjY2VwdCgpIHsKICAgICAgICAgIC8vY3JlYXRlIG5ldyBzdWJzY3JpcHRpb24KICAgICAgICAgIF90aGlzLl9zdWJzY3JpcHRpb25zW2h5cGVydHlVcmxdID0geyBzdGF0dXM6ICdvbicgfTsKCiAgICAgICAgICAvL3NlbmQgb2sgcmVzcG9uc2UgbWVzc2FnZQogICAgICAgICAgX3RoaXMuX2J1cy5wb3N0TWVzc2FnZSh7CiAgICAgICAgICAgIGlkOiBtc2cuaWQsIHR5cGU6ICdyZXNwb25zZScsIGZyb206IG1zZy50bywgdG86IG1zZy5mcm9tLAogICAgICAgICAgICBib2R5OiB7IGNvZGU6IDIwMCwgc2NoZW1hOiBfdGhpcy5fc2NoZW1hLCB2ZXJzaW9uOiBfdGhpcy5fdmVyc2lvbiwgdmFsdWU6ICgwLCBfdXRpbHNVdGlsc0pzLmRlZXBDbG9uZSkoX3RoaXMuZGF0YSkgfQogICAgICAgICAgfSk7CiAgICAgICAgfSwKCiAgICAgICAgcmVqZWN0OiBmdW5jdGlvbiByZWplY3QocmVhc29uKSB7CiAgICAgICAgICAvL3NlbmQgcmVqZWN0IHJlc3BvbnNlIG1lc3NhZ2UKICAgICAgICAgIF90aGlzLl9idXMucG9zdE1lc3NhZ2UoewogICAgICAgICAgICBpZDogbXNnLmlkLCB0eXBlOiAncmVzcG9uc2UnLCBmcm9tOiBtc2cudG8sIHRvOiBtc2cuZnJvbSwKICAgICAgICAgICAgYm9keTogeyBjb2RlOiA0MDMsIGRlc2M6IHJlYXNvbiB9CiAgICAgICAgICB9KTsKICAgICAgICB9CiAgICAgIH07CgogICAgICBpZiAoX3RoaXMuX29uU3Vic2NyaXB0aW9uSGFuZGxlcikgewogICAgICAgIF90aGlzLl9vblN1YnNjcmlwdGlvbkhhbmRsZXIoZXZlbnQpOwogICAgICB9CiAgICB9CiAgfSwgewogICAga2V5OiAnX29uVW5TdWJzY3JpYmUnLAogICAgdmFsdWU6IGZ1bmN0aW9uIF9vblVuU3Vic2NyaWJlKG1zZykgewogICAgICB2YXIgX3RoaXMgPSB0aGlzOwogICAgICB2YXIgaHlwZXJ0eVVybCA9IG1zZy5ib2R5LmZyb207CgogICAgICB2YXIgc3ViID0gX3RoaXMuX3N1YnNjcmlwdGlvbnNbaHlwZXJ0eVVybF07CiAgICAgIGRlbGV0ZSBfdGhpcy5fc3Vic2NyaXB0aW9uc1toeXBlcnR5VXJsXTsKCiAgICAgIHZhciBldmVudCA9IHsKICAgICAgICB0eXBlOiBtc2cuYm9keS50eXBlLAogICAgICAgIHVybDogaHlwZXJ0eVVybCwKICAgICAgICBvYmplY3Q6IHN1YgogICAgICB9OwoKICAgICAgaWYgKF90aGlzLl9vblN1YnNjcmlwdGlvbkhhbmRsZXIpIHsKICAgICAgICBfdGhpcy5fb25TdWJzY3JpcHRpb25IYW5kbGVyKGV2ZW50KTsKICAgICAgfQogICAgfQoKICAgIC8vc2VuZCBkZWx0YSBtZXNzYWdlcyB0byBzdWJzY3JpcHRpb25zCiAgfSwgewogICAga2V5OiAnX29uQ2hhbmdlJywKICAgIHZhbHVlOiBmdW5jdGlvbiBfb25DaGFuZ2UoZXZlbnQpIHsKICAgICAgdmFyIF90aGlzID0gdGhpczsKCiAgICAgIF90aGlzLl92ZXJzaW9uKys7CgogICAgICBpZiAoX3RoaXMuX3N0YXR1cyA9PT0gJ29uJykgewogICAgICAgIF90aGlzLl9idXMucG9zdE1lc3NhZ2UoewogICAgICAgICAgdHlwZTogZXZlbnQuY1R5cGUsIGZyb206IF90aGlzLl9vd25lciwgdG86IF90aGlzLl91cmwsCiAgICAgICAgICBib2R5OiB7IHZlcnNpb246IF90aGlzLl92ZXJzaW9uLCBvVHlwZTogZXZlbnQub1R5cGUsIGF0dHJpYjogZXZlbnQuZmllbGQsIHZhbHVlOiBldmVudC5kYXRhIH0KICAgICAgICB9KTsKICAgICAgfQogICAgfQogIH0sIHsKICAgIGtleTogJ3ZlcnNpb24nLAogICAgZ2V0OiBmdW5jdGlvbiBnZXQoKSB7CiAgICAgIHJldHVybiB0aGlzLl92ZXJzaW9uOwogICAgfQogIH0sIHsKICAgIGtleTogJ3VybCcsCiAgICBnZXQ6IGZ1bmN0aW9uIGdldCgpIHsKICAgICAgcmV0dXJuIHRoaXMuX3VybDsKICAgIH0KICB9LCB7CiAgICBrZXk6ICdzY2hlbWEnLAogICAgZ2V0OiBmdW5jdGlvbiBnZXQoKSB7CiAgICAgIHJldHVybiB0aGlzLl9zY2hlbWE7CiAgICB9CiAgfSwgewogICAga2V5OiAnc3RhdHVzJywKICAgIGdldDogZnVuY3Rpb24gZ2V0KCkgewogICAgICByZXR1cm4gdGhpcy5fc3RhdHVzOwogICAgfQogIH0sIHsKICAgIGtleTogJ2RhdGEnLAogICAgZ2V0OiBmdW5jdGlvbiBnZXQoKSB7CiAgICAgIHJldHVybiB0aGlzLl9zeW5jT2JqLmRhdGE7CiAgICB9CiAgfSwgewogICAga2V5OiAnc3Vic2NyaXB0aW9ucycsCiAgICBnZXQ6IGZ1bmN0aW9uIGdldCgpIHsKICAgICAgcmV0dXJuIHRoaXMuX3N1YnNjcmlwdGlvbnM7CiAgICB9CiAgfV0pOwoKICByZXR1cm4gRGF0YU9iamVjdFJlcG9ydGVyOwp9KSgpOwoKZXhwb3J0c1snZGVmYXVsdCddID0gRGF0YU9iamVjdFJlcG9ydGVyOwptb2R1bGUuZXhwb3J0cyA9IGV4cG9ydHNbJ2RlZmF1bHQnXTsKCn0seyIuLi91dGlscy91dGlscy5qcyI6MjQsIi4vU3luY09iamVjdCI6MjF9XSwyMTpbZnVuY3Rpb24ocmVxdWlyZSxtb2R1bGUsZXhwb3J0cyl7Cid1c2Ugc3RyaWN0JzsKCk9iamVjdC5kZWZpbmVQcm9wZXJ0eShleHBvcnRzLCAnX19lc01vZHVsZScsIHsKICB2YWx1ZTogdHJ1ZQp9KTsKCnZhciBfY3JlYXRlQ2xhc3MgPSAoZnVuY3Rpb24gKCkgeyBmdW5jdGlvbiBkZWZpbmVQcm9wZXJ0aWVzKHRhcmdldCwgcHJvcHMpIHsgZm9yICh2YXIgaSA9IDA7IGkgPCBwcm9wcy5sZW5ndGg7IGkrKykgeyB2YXIgZGVzY3JpcHRvciA9IHByb3BzW2ldOyBkZXNjcmlwdG9yLmVudW1lcmFibGUgPSBkZXNjcmlwdG9yLmVudW1lcmFibGUgfHwgZmFsc2U7IGRlc2NyaXB0b3IuY29uZmlndXJhYmxlID0gdHJ1ZTsgaWYgKCd2YWx1ZScgaW4gZGVzY3JpcHRvcikgZGVzY3JpcHRvci53cml0YWJsZSA9IHRydWU7IE9iamVjdC5kZWZpbmVQcm9wZXJ0eSh0YXJnZXQsIGRlc2NyaXB0b3Iua2V5LCBkZXNjcmlwdG9yKTsgfSB9IHJldHVybiBmdW5jdGlvbiAoQ29uc3RydWN0b3IsIHByb3RvUHJvcHMsIHN0YXRpY1Byb3BzKSB7IGlmIChwcm90b1Byb3BzKSBkZWZpbmVQcm9wZXJ0aWVzKENvbnN0cnVjdG9yLnByb3RvdHlwZSwgcHJvdG9Qcm9wcyk7IGlmIChzdGF0aWNQcm9wcykgZGVmaW5lUHJvcGVydGllcyhDb25zdHJ1Y3Rvciwgc3RhdGljUHJvcHMpOyByZXR1cm4gQ29uc3RydWN0b3I7IH07IH0pKCk7CgpmdW5jdGlvbiBfY2xhc3NDYWxsQ2hlY2soaW5zdGFuY2UsIENvbnN0cnVjdG9yKSB7IGlmICghKGluc3RhbmNlIGluc3RhbmNlb2YgQ29uc3RydWN0b3IpKSB7IHRocm93IG5ldyBUeXBlRXJyb3IoJ0Nhbm5vdCBjYWxsIGEgY2xhc3MgYXMgYSBmdW5jdGlvbicpOyB9IH0KCnZhciBfdXRpbHNVdGlsc0pzID0gcmVxdWlyZSgnLi4vdXRpbHMvdXRpbHMuanMnKTsKCnZhciBTeW5jT2JqZWN0ID0gKGZ1bmN0aW9uICgpIHsKICAvKiBwcml2YXRlCiAgICBfZGF0YTogYW55OwogICAgX29ic2VydmVyczogKChldmVudDogQ2hhbmdlRXZlbnQpID0+IHZvaWQpW10KICAqLwoKICBmdW5jdGlvbiBTeW5jT2JqZWN0KGluaXRpYWxEYXRhKSB7CiAgICBfY2xhc3NDYWxsQ2hlY2sodGhpcywgU3luY09iamVjdCk7CgogICAgdmFyIF90aGlzID0gdGhpczsKCiAgICBfdGhpcy5fb2JzZXJ2ZXJzID0gW107CiAgICBfdGhpcy5fZmlsdGVycyA9IHt9OwoKICAgIGlmIChpbml0aWFsRGF0YSkgewogICAgICBfdGhpcy5fZGF0YSA9IGluaXRpYWxEYXRhOwogICAgfSBlbHNlIHsKICAgICAgX3RoaXMuX2RhdGEgPSB7fTsKICAgIH0KCiAgICBfdGhpcy5faW50ZXJuYWxPYnNlcnZlKG5ldyBQYXRoKCksIF90aGlzLl9kYXRhKTsKICB9CgogIC8vZHluYW1pYyBwYXRoIGZvciBBcnJheSBpbmRleC4uLgoKICBfY3JlYXRlQ2xhc3MoU3luY09iamVjdCwgW3sKICAgIGtleTogJ29ic2VydmUnLAogICAgdmFsdWU6IGZ1bmN0aW9uIG9ic2VydmUoY2FsbGJhY2spIHsKICAgICAgdGhpcy5fb2JzZXJ2ZXJzLnB1c2goY2FsbGJhY2spOwogICAgfQogIH0sIHsKICAgIGtleTogJ2ZpbmQnLAogICAgdmFsdWU6IGZ1bmN0aW9uIGZpbmQocGF0aCkgewogICAgICB2YXIgbGlzdCA9IHBhdGguc3BsaXQoJy4nKTsKCiAgICAgIHJldHVybiB0aGlzLl9maW5kV2l0aFNwbGl0KGxpc3QpOwogICAgfQogIH0sIHsKICAgIGtleTogJ2ZpbmRCZWZvcmUnLAogICAgdmFsdWU6IGZ1bmN0aW9uIGZpbmRCZWZvcmUocGF0aCkgewogICAgICB2YXIgcmVzdWx0ID0ge307CiAgICAgIHZhciBsaXN0ID0gcGF0aC5zcGxpdCgnLicpOwogICAgICByZXN1bHQubGFzdCA9IGxpc3QucG9wKCk7CiAgICAgIHJlc3VsdC5vYmogPSB0aGlzLl9maW5kV2l0aFNwbGl0KGxpc3QpOwoKICAgICAgcmV0dXJuIHJlc3VsdDsKICAgIH0KICB9LCB7CiAgICBrZXk6ICdfZmluZFdpdGhTcGxpdCcsCiAgICB2YWx1ZTogZnVuY3Rpb24gX2ZpbmRXaXRoU3BsaXQobGlzdCkgewogICAgICB2YXIgb2JqID0gdGhpcy5fZGF0YTsKICAgICAgbGlzdC5mb3JFYWNoKGZ1bmN0aW9uICh2YWx1ZSkgewogICAgICAgIG9iaiA9IG9ialt2YWx1ZV07CiAgICAgIH0pOwoKICAgICAgcmV0dXJuIG9iajsKICAgIH0KICB9LCB7CiAgICBrZXk6ICdfZmlyZUV2ZW50JywKICAgIHZhbHVlOiBmdW5jdGlvbiBfZmlyZUV2ZW50KGV2ZW50KSB7CiAgICAgIHRoaXMuX29ic2VydmVycy5mb3JFYWNoKGZ1bmN0aW9uIChjYWxsYmFjaykgewogICAgICAgIGNhbGxiYWNrKGV2ZW50KTsKICAgICAgfSk7CiAgICB9CiAgfSwgewogICAga2V5OiAnX2lzT2JzZXJ2YWJsZScsCiAgICB2YWx1ZTogZnVuY3Rpb24gX2lzT2JzZXJ2YWJsZShvYmopIHsKICAgICAgaWYgKG9iai5jb25zdHJ1Y3RvciA9PT0gT2JqZWN0IHx8IG9iai5jb25zdHJ1Y3RvciA9PT0gQXJyYXkpIHsKICAgICAgICByZXR1cm4gdHJ1ZTsKICAgICAgfQoKICAgICAgcmV0dXJuIGZhbHNlOwogICAgfQogIH0sIHsKICAgIGtleTogJ19pbnRlcm5hbE9ic2VydmUnLAogICAgdmFsdWU6IGZ1bmN0aW9uIF9pbnRlcm5hbE9ic2VydmUocGF0aCwgb2JqKSB7CiAgICAgIHZhciBfdGhpcyA9IHRoaXM7CgogICAgICBpZiAoX3RoaXMuX2lzT2JzZXJ2YWJsZShvYmopKSB7CiAgICAgICAgdmFyIGhhbmRsZXIgPSBmdW5jdGlvbiBoYW5kbGVyKGNoYW5nZXMpIHsKICAgICAgICAgIF90aGlzLl9vbkNoYW5nZXMocGF0aCwgY2hhbmdlcyk7CiAgICAgICAgfTsKCiAgICAgICAgaWYgKG9iai5jb25zdHJ1Y3RvciA9PT0gT2JqZWN0KSB7CiAgICAgICAgICBPYmplY3Qub2JzZXJ2ZShvYmosIGhhbmRsZXIpOwogICAgICAgICAgZm9yICh2YXIgcHJvcCBpbiBvYmopIHsKICAgICAgICAgICAgaWYgKF90aGlzLl9pc09ic2VydmFibGUob2JqW3Byb3BdKSkgewogICAgICAgICAgICAgIF90aGlzLl9pbnRlcm5hbE9ic2VydmUocGF0aFsnbmV3J10ocHJvcCksIG9ialtwcm9wXSk7CiAgICAgICAgICAgIH0KICAgICAgICAgIH0KICAgICAgICB9IGVsc2UgaWYgKG9iai5jb25zdHJ1Y3RvciA9PT0gQXJyYXkpIHsKICAgICAgICAgIEFycmF5Lm9ic2VydmUob2JqLCBoYW5kbGVyKTsKICAgICAgICAgIGZvciAodmFyIHByb3AgaW4gb2JqKSB7CiAgICAgICAgICAgIGlmIChfdGhpcy5faXNPYnNlcnZhYmxlKG9ialtwcm9wXSkpIHsKICAgICAgICAgICAgICB2YXIgbnAgPSBwYXRoWyduZXcnXShuZXcgQXJyYXlJbmRleChvYmpbcHJvcF0sIHByb3ApKTsKICAgICAgICAgICAgICBfdGhpcy5faW50ZXJuYWxPYnNlcnZlKG5wLCBvYmpbcHJvcF0pOwogICAgICAgICAgICB9CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICB9CiAgICB9CiAgfSwgewogICAga2V5OiAnX29uQ2hhbmdlcycsCiAgICB2YWx1ZTogZnVuY3Rpb24gX29uQ2hhbmdlcyhwYXRoLCBjaGFuZ2VzKSB7CiAgICAgIHZhciBfdGhpczIgPSB0aGlzOwoKICAgICAgZm9yICh2YXIgaSBpbiBjaGFuZ2VzKSB7CiAgICAgICAgdmFyIG9iaiA9IGNoYW5nZXNbaV0ub2JqZWN0OwogICAgICAgIHZhciBvYmpUeXBlID0gdW5kZWZpbmVkOwoKICAgICAgICBpZiAob2JqLmNvbnN0cnVjdG9yID09IE9iamVjdCkgewogICAgICAgICAgb2JqVHlwZSA9IE9iamVjdFR5cGUuT0JKRUNUOwogICAgICAgIH0KCiAgICAgICAgaWYgKG9iai5jb25zdHJ1Y3RvciA9PSBBcnJheSkgewogICAgICAgICAgb2JqVHlwZSA9IE9iamVjdFR5cGUuQVJSQVk7CiAgICAgICAgfQoKICAgICAgICBpZiAoY2hhbmdlc1tpXS50eXBlID09PSAnc3BsaWNlJykgewogICAgICAgICAgKGZ1bmN0aW9uICgpIHsKICAgICAgICAgICAgdmFyIGlkeCA9IGNoYW5nZXNbaV0uaW5kZXg7CiAgICAgICAgICAgIHZhciBmaWVsZCA9IHBhdGhbJ25ldyddKCcnICsgaWR4KTsKICAgICAgICAgICAgdmFyIGZpZWxkU3RyaW5nID0gZmllbGQudG9TdHJpbmcoKTsKCiAgICAgICAgICAgIHZhciByZW1vdmVTaXplID0gY2hhbmdlc1tpXS5yZW1vdmVkLmxlbmd0aDsKICAgICAgICAgICAgaWYgKHJlbW92ZVNpemUgIT09IDApIHsKICAgICAgICAgICAgICB2YXIgcmVtb3ZlVmFsdWVzID0gY2hhbmdlc1tpXS5yZW1vdmVkOwogICAgICAgICAgICAgIHJlbW92ZVZhbHVlcy5mb3JFYWNoKGZ1bmN0aW9uICh2YWx1ZSwgaW5kZXgpIHsKICAgICAgICAgICAgICAgIGlmIChfdGhpczIuX2lzT2JzZXJ2YWJsZSh2YWx1ZSkpIHsKICAgICAgICAgICAgICAgICAgcGF0aC5yZW1vdmVJbmRleChpZHggKyBpbmRleCk7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgfSk7CgogICAgICAgICAgICAgIF90aGlzMi5fZmlyZUV2ZW50KHsKICAgICAgICAgICAgICAgIGNUeXBlOiBDaGFuZ2VUeXBlLlJFTU9WRSwKICAgICAgICAgICAgICAgIG9UeXBlOiBvYmpUeXBlLAogICAgICAgICAgICAgICAgZmllbGQ6IGZpZWxkU3RyaW5nLAogICAgICAgICAgICAgICAgZGF0YTogcmVtb3ZlU2l6ZQogICAgICAgICAgICAgIH0pOwogICAgICAgICAgICB9CgogICAgICAgICAgICB2YXIgYWRkU2l6ZSA9IGNoYW5nZXNbaV0uYWRkZWRDb3VudDsKICAgICAgICAgICAgaWYgKGFkZFNpemUgIT09IDApIHsKICAgICAgICAgICAgICB2YXIgYWRkVmFsdWVzID0gb2JqLnNsaWNlKGlkeCwgaWR4ICsgYWRkU2l6ZSk7CiAgICAgICAgICAgICAgYWRkVmFsdWVzLmZvckVhY2goZnVuY3Rpb24gKHZhbHVlLCBpbmRleCkgewogICAgICAgICAgICAgICAgaWYgKF90aGlzMi5faXNPYnNlcnZhYmxlKHZhbHVlKSkgewogICAgICAgICAgICAgICAgICB2YXIgbnAgPSBwYXRoWyduZXcnXShuZXcgQXJyYXlJbmRleCh2YWx1ZSwgaWR4ICsgaW5kZXgpKTsKICAgICAgICAgICAgICAgICAgX3RoaXMyLl9pbnRlcm5hbE9ic2VydmUobnAsIHZhbHVlKTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICB9KTsKCiAgICAgICAgICAgICAgX3RoaXMyLl9maXJlRXZlbnQoewogICAgICAgICAgICAgICAgY1R5cGU6IENoYW5nZVR5cGUuQURELAogICAgICAgICAgICAgICAgb1R5cGU6IG9ialR5cGUsCiAgICAgICAgICAgICAgICBmaWVsZDogZmllbGRTdHJpbmcsCiAgICAgICAgICAgICAgICBkYXRhOiAoMCwgX3V0aWxzVXRpbHNKcy5kZWVwQ2xvbmUpKGFkZFZhbHVlcykKICAgICAgICAgICAgICB9KTsKICAgICAgICAgICAgfQoKICAgICAgICAgICAgLy9yZS1kZWZpbmUgcGF0aHMuLi4KICAgICAgICAgICAgaWYgKGlkeCAhPSBvYmoubGVuZ3RoIC0gMSkgewogICAgICAgICAgICAgIHBhdGgucmVJbmRleEZyb20ob2JqKTsKICAgICAgICAgICAgfQogICAgICAgICAgfSkoKTsKICAgICAgICB9IGVsc2UgewogICAgICAgICAgdmFyIGZpZWxkID0gcGF0aFsnbmV3J10oY2hhbmdlc1tpXS5uYW1lKTsKICAgICAgICAgIHZhciBmaWVsZFN0cmluZyA9IGZpZWxkLnRvU3RyaW5nKCk7CgogICAgICAgICAgaWYgKGZpZWxkU3RyaW5nLmluZGV4T2YoJ1N5bWJvbCcpICE9PSAtMSkgewogICAgICAgICAgICAvL2hhY2sgZm9yIFBoYW50b21KUzIKICAgICAgICAgICAgLy9jb25zb2xlLmxvZygnU1lNQk9MOiAnLCBjaGFuZ2VzW2ldKTsKICAgICAgICAgICAgY29udGludWU7CiAgICAgICAgICB9CgogICAgICAgICAgLy9sZXQgb2xkVmFsdWUgPSBjaGFuZ2VzW2ldLm9sZFZhbHVlOwogICAgICAgICAgdmFyIG5ld1ZhbHVlID0gb2JqW2NoYW5nZXNbaV0ubmFtZV07CiAgICAgICAgICBpZiAoY2hhbmdlc1tpXS50eXBlID09PSAndXBkYXRlJykgewogICAgICAgICAgICB0aGlzLl9maXJlRXZlbnQoewogICAgICAgICAgICAgIGNUeXBlOiBDaGFuZ2VUeXBlLlVQREFURSwKICAgICAgICAgICAgICBvVHlwZTogb2JqVHlwZSwKICAgICAgICAgICAgICBmaWVsZDogZmllbGRTdHJpbmcsCiAgICAgICAgICAgICAgZGF0YTogKDAsIF91dGlsc1V0aWxzSnMuZGVlcENsb25lKShuZXdWYWx1ZSkKICAgICAgICAgICAgfSk7CiAgICAgICAgICB9CgogICAgICAgICAgaWYgKGNoYW5nZXNbaV0udHlwZSA9PT0gJ2FkZCcpIHsKICAgICAgICAgICAgdGhpcy5faW50ZXJuYWxPYnNlcnZlKGZpZWxkLCBuZXdWYWx1ZSk7CiAgICAgICAgICAgIHRoaXMuX2ZpcmVFdmVudCh7CiAgICAgICAgICAgICAgY1R5cGU6IENoYW5nZVR5cGUuQURELAogICAgICAgICAgICAgIG9UeXBlOiBvYmpUeXBlLAogICAgICAgICAgICAgIGZpZWxkOiBmaWVsZFN0cmluZywKICAgICAgICAgICAgICBkYXRhOiAoMCwgX3V0aWxzVXRpbHNKcy5kZWVwQ2xvbmUpKG5ld1ZhbHVlKQogICAgICAgICAgICB9KTsKICAgICAgICAgIH0KCiAgICAgICAgICBpZiAoY2hhbmdlc1tpXS50eXBlID09PSAnZGVsZXRlJykgewogICAgICAgICAgICB0aGlzLl9maXJlRXZlbnQoewogICAgICAgICAgICAgIGNUeXBlOiBDaGFuZ2VUeXBlLlJFTU9WRSwKICAgICAgICAgICAgICBvVHlwZTogb2JqVHlwZSwKICAgICAgICAgICAgICBmaWVsZDogZmllbGRTdHJpbmcKICAgICAgICAgICAgfSk7CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICB9CiAgICB9CiAgfSwgewogICAga2V5OiAnZGF0YScsCiAgICBnZXQ6IGZ1bmN0aW9uIGdldCgpIHsKICAgICAgcmV0dXJuIHRoaXMuX2RhdGE7CiAgICB9CiAgfV0pOwoKICByZXR1cm4gU3luY09iamVjdDsKfSkoKTsKCnZhciBQYXRoID0gKGZ1bmN0aW9uICgpIHsKICBmdW5jdGlvbiBQYXRoKCkgewogICAgX2NsYXNzQ2FsbENoZWNrKHRoaXMsIFBhdGgpOwoKICAgIHRoaXMuX3BhdGggPSBbXTsKICAgIHRoaXMuX29ic2VydmFibGVzID0ge307IC8vPGluZGV4OkFycmF5SW5kZXg+CiAgfQoKICBfY3JlYXRlQ2xhc3MoUGF0aCwgW3sKICAgIGtleTogJ3JlbW92ZUluZGV4JywKICAgIHZhbHVlOiBmdW5jdGlvbiByZW1vdmVJbmRleChpZHgpIHsKICAgICAgLy9jb25zb2xlLmxvZygnUkVNT1ZFLVBBVEggJyArIGlkeCk7CiAgICAgIGRlbGV0ZSB0aGlzLl9vYnNlcnZhYmxlc1tpZHhdOwogICAgfQogIH0sIHsKICAgIGtleTogJ3JlSW5kZXhGcm9tJywKICAgIHZhbHVlOiBmdW5jdGlvbiByZUluZGV4RnJvbShhcnJheSkgewogICAgICB2YXIgX3RoaXMzID0gdGhpczsKCiAgICAgIE9iamVjdC5rZXlzKHRoaXMuX29ic2VydmFibGVzKS5mb3JFYWNoKGZ1bmN0aW9uIChrZXkpIHsKICAgICAgICB2YXIgYXJyYXlJbmRleCA9IF90aGlzMy5fb2JzZXJ2YWJsZXNba2V5XTsKICAgICAgICB2YXIgaWR4ID0gYXJyYXkuaW5kZXhPZihhcnJheUluZGV4Lm9iaik7CiAgICAgICAgaWYgKGFycmF5SW5kZXguaWR4ICE9IGlkeCkgewogICAgICAgICAgLy9jb25zb2xlLmxvZygnUkUtSU5ERVg6ICcgKyBrZXkgKyAnLT4nICsgaWR4KTsKICAgICAgICAgIGFycmF5SW5kZXguaWR4ID0gaWR4OwogICAgICAgICAgZGVsZXRlIF90aGlzMy5fb2JzZXJ2YWJsZXNba2V5XTsKICAgICAgICAgIF90aGlzMy5fb2JzZXJ2YWJsZXNbaWR4XSA9IGFycmF5SW5kZXg7CiAgICAgICAgfQogICAgICB9KTsKICAgIH0KICB9LCB7CiAgICBrZXk6ICduZXcnLAogICAgdmFsdWU6IGZ1bmN0aW9uIF9uZXcoaWR4KSB7CiAgICAgIGlmIChpZHguY29uc3RydWN0b3IgPT0gQXJyYXlJbmRleCkgewogICAgICAgIC8vY29uc29sZS5sb2coJ1BBVEgtT0JTRVJWOiAnLCBpZHgpOwogICAgICAgIHRoaXMuX29ic2VydmFibGVzW2lkeC5pZHhdID0gaWR4OwogICAgICB9CgogICAgICB2YXIgblBhdGggPSB0aGlzLmNsb25lKCk7CiAgICAgIG5QYXRoLl9wYXRoLnB1c2goaWR4KTsKCiAgICAgIHJldHVybiBuUGF0aDsKICAgIH0KICB9LCB7CiAgICBrZXk6ICdjbG9uZScsCiAgICB2YWx1ZTogZnVuY3Rpb24gY2xvbmUoKSB7CiAgICAgIHZhciBuUGF0aCA9IG5ldyBQYXRoKCk7CiAgICAgIHRoaXMuX3BhdGguZm9yRWFjaChmdW5jdGlvbiAodmFsdWUpIHsKICAgICAgICBuUGF0aC5fcGF0aC5wdXNoKHZhbHVlKTsKICAgICAgfSk7CgogICAgICByZXR1cm4gblBhdGg7CiAgICB9CiAgfSwgewogICAga2V5OiAndG9TdHJpbmcnLAogICAgdmFsdWU6IGZ1bmN0aW9uIHRvU3RyaW5nKCkgewogICAgICAvL1RPRE86IG9wdGltaXplISEKICAgICAgdmFyIHN0ciA9ICcnOwogICAgICB0aGlzLl9wYXRoLmZvckVhY2goZnVuY3Rpb24gKHZhbHVlLCBpbmRleCkgewogICAgICAgIGlmIChpbmRleCA9PT0gMCkgewogICAgICAgICAgc3RyID0gdmFsdWUudG9TdHJpbmcoKTsKICAgICAgICB9IGVsc2UgewogICAgICAgICAgc3RyICs9ICcuJyArIHZhbHVlLnRvU3RyaW5nKCk7CiAgICAgICAgfQogICAgICB9KTsKCiAgICAgIHJldHVybiBzdHI7CiAgICB9CiAgfV0pOwoKICByZXR1cm4gUGF0aDsKfSkoKTsKCnZhciBBcnJheUluZGV4ID0gKGZ1bmN0aW9uICgpIHsKICBmdW5jdGlvbiBBcnJheUluZGV4KG9iaiwgaWR4KSB7CiAgICBfY2xhc3NDYWxsQ2hlY2sodGhpcywgQXJyYXlJbmRleCk7CgogICAgdGhpcy5vYmogPSBvYmo7CiAgICB0aGlzLmlkeCA9IGlkeDsKICB9CgogIF9jcmVhdGVDbGFzcyhBcnJheUluZGV4LCBbewogICAga2V5OiAndG9TdHJpbmcnLAogICAgdmFsdWU6IGZ1bmN0aW9uIHRvU3RyaW5nKCkgewogICAgICByZXR1cm4gdGhpcy5pZHgudG9TdHJpbmcoKTsKICAgIH0KICB9XSk7CgogIHJldHVybiBBcnJheUluZGV4Owp9KSgpOwoKdmFyIENoYW5nZVR5cGUgPSB7IFVQREFURTogJ3VwZGF0ZScsIEFERDogJ2FkZCcsIFJFTU9WRTogJ3JlbW92ZScgfTsKZXhwb3J0cy5DaGFuZ2VUeXBlID0gQ2hhbmdlVHlwZTsKdmFyIE9iamVjdFR5cGUgPSB7IE9CSkVDVDogJ29iamVjdCcsIEFSUkFZOiAnYXJyYXknIH07CmV4cG9ydHMuT2JqZWN0VHlwZSA9IE9iamVjdFR5cGU7CmV4cG9ydHNbJ2RlZmF1bHQnXSA9IFN5bmNPYmplY3Q7Cgp9LHsiLi4vdXRpbHMvdXRpbHMuanMiOjI0fV0sMjI6W2Z1bmN0aW9uKHJlcXVpcmUsbW9kdWxlLGV4cG9ydHMpewondXNlIHN0cmljdCc7CgpPYmplY3QuZGVmaW5lUHJvcGVydHkoZXhwb3J0cywgJ19fZXNNb2R1bGUnLCB7CiAgdmFsdWU6IHRydWUKfSk7Cgp2YXIgX2NyZWF0ZUNsYXNzID0gKGZ1bmN0aW9uICgpIHsgZnVuY3Rpb24gZGVmaW5lUHJvcGVydGllcyh0YXJnZXQsIHByb3BzKSB7IGZvciAodmFyIGkgPSAwOyBpIDwgcHJvcHMubGVuZ3RoOyBpKyspIHsgdmFyIGRlc2NyaXB0b3IgPSBwcm9wc1tpXTsgZGVzY3JpcHRvci5lbnVtZXJhYmxlID0gZGVzY3JpcHRvci5lbnVtZXJhYmxlIHx8IGZhbHNlOyBkZXNjcmlwdG9yLmNvbmZpZ3VyYWJsZSA9IHRydWU7IGlmICgndmFsdWUnIGluIGRlc2NyaXB0b3IpIGRlc2NyaXB0b3Iud3JpdGFibGUgPSB0cnVlOyBPYmplY3QuZGVmaW5lUHJvcGVydHkodGFyZ2V0LCBkZXNjcmlwdG9yLmtleSwgZGVzY3JpcHRvcik7IH0gfSByZXR1cm4gZnVuY3Rpb24gKENvbnN0cnVjdG9yLCBwcm90b1Byb3BzLCBzdGF0aWNQcm9wcykgeyBpZiAocHJvdG9Qcm9wcykgZGVmaW5lUHJvcGVydGllcyhDb25zdHJ1Y3Rvci5wcm90b3R5cGUsIHByb3RvUHJvcHMpOyBpZiAoc3RhdGljUHJvcHMpIGRlZmluZVByb3BlcnRpZXMoQ29uc3RydWN0b3IsIHN0YXRpY1Byb3BzKTsgcmV0dXJuIENvbnN0cnVjdG9yOyB9OyB9KSgpOwoKZnVuY3Rpb24gX2ludGVyb3BSZXF1aXJlRGVmYXVsdChvYmopIHsgcmV0dXJuIG9iaiAmJiBvYmouX19lc01vZHVsZSA/IG9iaiA6IHsgJ2RlZmF1bHQnOiBvYmogfTsgfQoKZnVuY3Rpb24gX2NsYXNzQ2FsbENoZWNrKGluc3RhbmNlLCBDb25zdHJ1Y3RvcikgeyBpZiAoIShpbnN0YW5jZSBpbnN0YW5jZW9mIENvbnN0cnVjdG9yKSkgeyB0aHJvdyBuZXcgVHlwZUVycm9yKCdDYW5ub3QgY2FsbCBhIGNsYXNzIGFzIGEgZnVuY3Rpb24nKTsgfSB9Cgp2YXIgX0RhdGFPYmplY3RSZXBvcnRlciA9IHJlcXVpcmUoJy4vRGF0YU9iamVjdFJlcG9ydGVyJyk7Cgp2YXIgX0RhdGFPYmplY3RSZXBvcnRlcjIgPSBfaW50ZXJvcFJlcXVpcmVEZWZhdWx0KF9EYXRhT2JqZWN0UmVwb3J0ZXIpOwoKdmFyIF9EYXRhT2JqZWN0T2JzZXJ2ZXIgPSByZXF1aXJlKCcuL0RhdGFPYmplY3RPYnNlcnZlcicpOwoKdmFyIF9EYXRhT2JqZWN0T2JzZXJ2ZXIyID0gX2ludGVyb3BSZXF1aXJlRGVmYXVsdChfRGF0YU9iamVjdE9ic2VydmVyKTsKCi8qKgogKiBAYXV0aG9yIG1pY2FlbHBlZHJvc2FAZ21haWwuY29tCiAqIENsaWVudCBBUEkgU3luY3Jvbml6YXRpb24gc3lzdGVtLgogKi8KCnZhciBTeW5jaGVyID0gKGZ1bmN0aW9uICgpIHsKICAvKiBwcml2YXRlCiAgX293bmVyOiBVUkwKICBfYnVzOiBNaW5pQnVzCiAgIF9zdWJVUkw6IFVSTAogICBfcmVwb3J0ZXJzOiA8dXJsOiBEYXRhT2JqZWN0UmVwb3J0ZXI+CiAgX29ic2VydmVyczogPHVybDogRGF0YU9iamVjdE9ic2VydmVyPgogICAtLS0tZXZlbnQgaGFuZGxlcnMtLS0tCiAgX29uUmVzcG9uc2VIYW5kbGVyOiAoZXZlbnQpID0+IHZvaWQKICBfb25Ob3RpZmljYXRpb25IYW5kbGVyOiAoZXZlbnQpID0+IHZvaWQKICAqLwoKICBmdW5jdGlvbiBTeW5jaGVyKG93bmVyLCBidXMsIGNvbmZpZykgewogICAgX2NsYXNzQ2FsbENoZWNrKHRoaXMsIFN5bmNoZXIpOwoKICAgIHZhciBfdGhpcyA9IHRoaXM7CgogICAgX3RoaXMuX293bmVyID0gb3duZXI7CiAgICBfdGhpcy5fYnVzID0gYnVzOwoKICAgIF90aGlzLl9zdWJVUkwgPSBjb25maWcucnVudGltZVVSTCArICcvc20nOwoKICAgIF90aGlzLl9yZXBvcnRlcnMgPSB7fTsKICAgIF90aGlzLl9vYnNlcnZlcnMgPSB7fTsKCiAgICBidXMuYWRkTGlzdGVuZXIob3duZXIsIGZ1bmN0aW9uIChtc2cpIHsKICAgICAgY29uc29sZS5sb2coJ1N5bmNoZXItUkNWOiAnLCBtc2cpOwogICAgICBzd2l0Y2ggKG1zZy50eXBlKSB7CiAgICAgICAgY2FzZSAncmVzcG9uc2UnOgogICAgICAgICAgX3RoaXMuX29uUmVzcG9uc2UobXNnKTticmVhazsKICAgICAgICBjYXNlICdmb3J3YXJkJzoKICAgICAgICAgIF90aGlzLl9vbkZvcndhcmQobXNnKTticmVhazsKICAgICAgICBjYXNlICdjcmVhdGUnOgogICAgICAgICAgX3RoaXMuX29uQ3JlYXRlKG1zZyk7YnJlYWs7CiAgICAgICAgY2FzZSAndXBkYXRlJzoKICAgICAgICAgIF90aGlzLl9vbkNoYW5nZShtc2cpO2JyZWFrOwogICAgICAgIGNhc2UgJ2FkZCc6CiAgICAgICAgICBfdGhpcy5fb25DaGFuZ2UobXNnKTticmVhazsKICAgICAgICBjYXNlICdyZW1vdmUnOgogICAgICAgICAgX3RoaXMuX29uQ2hhbmdlKG1zZyk7YnJlYWs7CiAgICAgIH0KICAgIH0pOwogIH0KCiAgX2NyZWF0ZUNsYXNzKFN5bmNoZXIsIFt7CiAgICBrZXk6ICdjcmVhdGUnLAoKICAgIC8qKgogICAgICogUmVxdWVzdCBhIERhdGFPYmplY3RSZXBvcnRlciBjcmVhdGlvbi4gVGhlIFVSTCB3aWxsIGJlIGJlIHJlcXVlc3RlZCBieSB0aGUgYWxsb2NhdGlvbiBtZWNoYW5pc20uCiAgICAgKiBAcGFyYW0gIHtTY2hlbWF9IHNjaGVtYSBTY2hlbWEgb2YgdGhlIG9iamVjdAogICAgICogQHBhcmFtICB7SHlwZXJ0eVVSTFtdfSBMaXN0IG9mIGh5cGVydGllcyB0byBzZW5kIHRoZSBjcmVhdGUKICAgICAqIEBwYXJhbSAge0pTT059IGluaXRpYWxEYXRhIE9iamVjdCBpbml0aWFsIGRhdGEKICAgICAqIEByZXR1cm4ge1Byb21pc2U8RGF0YU9iamVjdFJlcG9ydGVyPn0gUmV0dXJuIFByb21pc2UgdG8gYSBuZXcgUmVwb3J0ZXIuIFRoZSByZXBvcnRlciBjYW4gYmUgYWNjZXB0ZWQgb3IgcmVqZWN0ZWQgYnkgdGhlIFBFUAogICAgICovCiAgICB2YWx1ZTogZnVuY3Rpb24gY3JlYXRlKHNjaGVtYSwgb2JzZXJ2ZXJzLCBpbml0aWFsRGF0YSkgewogICAgICB2YXIgX3RoaXMgPSB0aGlzOwoKICAgICAgLy9UT0RPOiB3aGF0IHRvIGRvIHdpdGggc2NoZW1hPwoKICAgICAgdmFyIHJlcXVlc3RNc2cgPSB7CiAgICAgICAgdHlwZTogJ2NyZWF0ZScsIGZyb206IF90aGlzLl9vd25lciwgdG86IF90aGlzLl9zdWJVUkwsCiAgICAgICAgYm9keTogeyBzY2hlbWE6IHNjaGVtYSwgdmFsdWU6IGluaXRpYWxEYXRhLCBhdXRob3Jpc2U6IG9ic2VydmVycyB9CiAgICAgIH07CgogICAgICByZXR1cm4gbmV3IFByb21pc2UoZnVuY3Rpb24gKHJlc29sdmUsIHJlamVjdCkgewogICAgICAgIC8vcmVxdWVzdCBjcmVhdGUgdG8gdGhlIEFsbG9jYXRpb24gc3lzdGVtPyBDYW4gYmUgcmVqZWN0ZWQgYnkgdGhlIFBvbGljeUVuZ2luZS4KICAgICAgICBfdGhpcy5fYnVzLnBvc3RNZXNzYWdlKHJlcXVlc3RNc2csIGZ1bmN0aW9uIChyZXBseSkgewogICAgICAgICAgY29uc29sZS5sb2coJ2NyZWF0ZS1yZXNwb25zZTogJywgcmVwbHkpOwogICAgICAgICAgaWYgKHJlcGx5LmJvZHkuY29kZSA9PT0gMjAwKSB7CiAgICAgICAgICAgIHZhciBvYmpVcmwgPSByZXBseS5ib2R5LnJlc291cmNlOwoKICAgICAgICAgICAgLy9yZXBvcnRlciBjcmVhdGlvbiBhY2NlcHRlZAogICAgICAgICAgICB2YXIgbmV3T2JqID0gbmV3IF9EYXRhT2JqZWN0UmVwb3J0ZXIyWydkZWZhdWx0J10oX3RoaXMuX293bmVyLCBvYmpVcmwsIHNjaGVtYSwgX3RoaXMuX2J1cywgJ29uJywgaW5pdGlhbERhdGEpOwogICAgICAgICAgICBfdGhpcy5fcmVwb3J0ZXJzW29ialVybF0gPSBuZXdPYmo7CiAgICAgICAgICAgIHJlc29sdmUobmV3T2JqKTsKICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgIC8vcmVwb3J0ZXIgY3JlYXRpb24gcmVqZWN0ZWQKICAgICAgICAgICAgcmVqZWN0KHJlcGx5LmJvZHkuZGVzYyk7CiAgICAgICAgICB9CiAgICAgICAgfSk7CiAgICAgIH0pOwogICAgfQoKICAgIC8qKgogICAgICogUmVxdWVzdCBhIHN1YnNjcmlwdGlvbiB0byBhbiBleGlzdGVudCBvYmplY3QuCiAgICAgKiBAcGFyYW0gIHtPYmplY3RVUkx9IG9ialVSTCBBZGRyZXNzIG9mIHRoZSBleGlzdGVudCBvYmplY3QuCiAgICAgKiBAcmV0dXJuIHtQcm9taXNlPERhdGFPYmplY3RPYnNlcnZlcj59IFJldHVybiBQcm9taXNlIHRvIGEgbmV3IE9ic2VydmVyLgogICAgICovCiAgfSwgewogICAga2V5OiAnc3Vic2NyaWJlJywKICAgIHZhbHVlOiBmdW5jdGlvbiBzdWJzY3JpYmUob2JqVVJMKSB7CiAgICAgIHZhciBfdGhpcyA9IHRoaXM7CiAgICAgIHZhciBvYmpTdWJzY3JpcHRvclVSTCA9IG9ialVSTCArICcvc3Vic2NyaXB0aW9uJzsKCiAgICAgIC8vVE9ETzogdmFsaWRhdGUgaWYgc3Vic2NyaXB0aW9uIGFscmVhZHkgZXhpc3RzID8KICAgICAgLy9UT0RPOiByZW1vdmUgZnJvbSBib2R5IGh5cGVydHlVUkwgKHdhcyBhZGRlZCBiZWNhdXNlIHRoZSBQb2xpY3lFbmdpbmUpCiAgICAgIHZhciBzdWJzY3JpYmVNc2cgPSB7CiAgICAgICAgdHlwZTogJ3N1YnNjcmliZScsIGZyb206IF90aGlzLl9vd25lciwgdG86IG9ialN1YnNjcmlwdG9yVVJMCiAgICAgIH07CgogICAgICByZXR1cm4gbmV3IFByb21pc2UoZnVuY3Rpb24gKHJlc29sdmUsIHJlamVjdCkgewogICAgICAgIC8vcmVxdWVzdCBzdWJzY3JpcHRpb24KICAgICAgICBfdGhpcy5fYnVzLnBvc3RNZXNzYWdlKHN1YnNjcmliZU1zZywgZnVuY3Rpb24gKHJlcGx5KSB7CiAgICAgICAgICBjb25zb2xlLmxvZygnc3Vic2NyaWJlLXJlc3BvbnNlOiAnLCByZXBseSk7CiAgICAgICAgICBpZiAocmVwbHkuYm9keS5jb2RlID09PSAyMDApIHsKICAgICAgICAgICAgLy9zdWJzY3JpcHRpb24gYWNjZXB0ZWQKICAgICAgICAgICAgdmFyIG5ld09iaiA9IF90aGlzLl9hZGRPYnNlcnZlcihvYmpVUkwsIHJlcGx5LmJvZHkuc2NoZW1hLCByZXBseS5ib2R5LnZhbHVlKTsKICAgICAgICAgICAgcmVzb2x2ZShuZXdPYmopOwogICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgLy9zdWJzY3JpcHRpb24gcmVqZWN0ZWQKICAgICAgICAgICAgcmVqZWN0KHJlcGx5LmJvZHkuZGVzYyk7CiAgICAgICAgICB9CiAgICAgICAgfSk7CiAgICAgIH0pOwogICAgfQogIH0sIHsKICAgIGtleTogJ29uUmVzcG9uc2UnLAogICAgdmFsdWU6IGZ1bmN0aW9uIG9uUmVzcG9uc2UoY2FsbGJhY2spIHsKICAgICAgdGhpcy5fb25SZXNwb25zZUhhbmRsZXIgPSBjYWxsYmFjazsKICAgIH0KICB9LCB7CiAgICBrZXk6ICdvbk5vdGlmaWNhdGlvbicsCiAgICB2YWx1ZTogZnVuY3Rpb24gb25Ob3RpZmljYXRpb24oY2FsbGJhY2spIHsKICAgICAgdGhpcy5fb25Ob3RpZmljYXRpb25IYW5kbGVyID0gY2FsbGJhY2s7CiAgICB9CiAgfSwgewogICAga2V5OiAnX29uUmVzcG9uc2UnLAogICAgdmFsdWU6IGZ1bmN0aW9uIF9vblJlc3BvbnNlKG1zZykgewogICAgICB2YXIgX3RoaXMgPSB0aGlzOwoKICAgICAgLy9UT0RPOiBwcm9jZXNzIG5vdGlmaWNhdGlvbiByZXBvbnNlcyEKICAgICAgY29uc29sZS5sb2coJ29uUmVzcG9uc2U6JywgbXNnKTsKICAgIH0KICB9LCB7CiAgICBrZXk6ICdfb25Gb3J3YXJkJywKICAgIHZhbHVlOiBmdW5jdGlvbiBfb25Gb3J3YXJkKG1zZykgewogICAgICB2YXIgX3RoaXMgPSB0aGlzOwoKICAgICAgdmFyIHJlcG9ydGVyID0gX3RoaXMuX3JlcG9ydGVyc1ttc2cuYm9keS50b107CiAgICAgIHJlcG9ydGVyLl9vbkZvcndhcmQobXNnKTsKICAgIH0KICB9LCB7CiAgICBrZXk6ICdfb25DcmVhdGUnLAogICAgdmFsdWU6IGZ1bmN0aW9uIF9vbkNyZWF0ZShtc2cpIHsKICAgICAgdmFyIF90aGlzID0gdGhpczsKCiAgICAgIHZhciBldmVudCA9IHsKICAgICAgICB0eXBlOiBtc2cudHlwZSwKICAgICAgICBmcm9tOiBtc2cuZnJvbSwKICAgICAgICB1cmw6IG1zZy5ib2R5LnJlc291cmNlLAogICAgICAgIHNjaGVtYTogbXNnLmJvZHkuc2NoZW1hLAogICAgICAgIHZhbHVlOiBtc2cuYm9keS52YWx1ZSwKCiAgICAgICAgYWNrOiBmdW5jdGlvbiBhY2soKSB7CiAgICAgICAgICAvL3NlbmQgYWNrIHJlc3BvbnNlIG1lc3NhZ2UKICAgICAgICAgIF90aGlzLl9idXMucG9zdE1lc3NhZ2UoewogICAgICAgICAgICBpZDogbXNnLmlkLCB0eXBlOiAncmVzcG9uc2UnLCBmcm9tOiBtc2cudG8sIHRvOiBtc2cuZnJvbSwKICAgICAgICAgICAgYm9keTogeyBjb2RlOiAyMDAgfQogICAgICAgICAgfSk7CiAgICAgICAgfQogICAgICB9OwoKICAgICAgaWYgKF90aGlzLl9vbk5vdGlmaWNhdGlvbkhhbmRsZXIpIHsKICAgICAgICBfdGhpcy5fb25Ob3RpZmljYXRpb25IYW5kbGVyKGV2ZW50KTsKICAgICAgfQogICAgfQogIH0sIHsKICAgIGtleTogJ19vbkNoYW5nZScsCiAgICB2YWx1ZTogZnVuY3Rpb24gX29uQ2hhbmdlKG1zZykgewogICAgICB2YXIgX3RoaXMgPSB0aGlzOwoKICAgICAgdmFyIG9ic2VydmVyID0gX3RoaXMuX29ic2VydmVyc1ttc2cuZnJvbV07CiAgICAgIG9ic2VydmVyLl9jaGFuZ2VPYmplY3QobXNnKTsKICAgIH0KICB9LCB7CiAgICBrZXk6ICdfYWRkT2JzZXJ2ZXInLAogICAgdmFsdWU6IGZ1bmN0aW9uIF9hZGRPYnNlcnZlcihvYmpVUkwsIHNjaGVtYVVSTCwgaW5pdGlhbERhdGEpIHsKICAgICAgdmFyIF90aGlzID0gdGhpczsKCiAgICAgIHZhciBuZXdPYmogPSBuZXcgX0RhdGFPYmplY3RPYnNlcnZlcjJbJ2RlZmF1bHQnXShfdGhpcy5fb3duZXIsIG9ialVSTCwgc2NoZW1hVVJMLCAnb24nLCBpbml0aWFsRGF0YSk7CiAgICAgIF90aGlzLl9vYnNlcnZlcnNbb2JqVVJMXSA9IG5ld09iajsKCiAgICAgIHJldHVybiBuZXdPYmo7CiAgICB9CiAgfSwgewogICAga2V5OiAnb3duZXInLAogICAgZ2V0OiBmdW5jdGlvbiBnZXQoKSB7CiAgICAgIHJldHVybiB0aGlzLl9vd25lcjsKICAgIH0KICB9LCB7CiAgICBrZXk6ICdyZXBvcnRlcnMnLAogICAgZ2V0OiBmdW5jdGlvbiBnZXQoKSB7CiAgICAgIHJldHVybiB0aGlzLl9yZXBvcnRlcnM7CiAgICB9CiAgfSwgewogICAga2V5OiAnb2JzZXJ2ZXJzJywKICAgIGdldDogZnVuY3Rpb24gZ2V0KCkgewogICAgICByZXR1cm4gdGhpcy5fb2JzZXJ2ZXJzOwogICAgfQogIH1dKTsKCiAgcmV0dXJuIFN5bmNoZXI7Cn0pKCk7CgpleHBvcnRzWydkZWZhdWx0J10gPSBTeW5jaGVyOwptb2R1bGUuZXhwb3J0cyA9IGV4cG9ydHNbJ2RlZmF1bHQnXTsKCn0seyIuL0RhdGFPYmplY3RPYnNlcnZlciI6MTksIi4vRGF0YU9iamVjdFJlcG9ydGVyIjoyMH1dLDIzOltmdW5jdGlvbihyZXF1aXJlLG1vZHVsZSxleHBvcnRzKXsKLyoqCiAqIEV2ZW50RW1pdHRlcgogKiBBbGwgY2xhc3NlcyB3aGljaCBleHRlbmRzIHRoaXMsIGNhbiBoYXZlIGFkZEV2ZW50TGlzdGVuZXIgYW5kIHRyaWdnZXIgZXZlbnRzOwogKi8KInVzZSBzdHJpY3QiOwoKT2JqZWN0LmRlZmluZVByb3BlcnR5KGV4cG9ydHMsICJfX2VzTW9kdWxlIiwgewogIHZhbHVlOiB0cnVlCn0pOwoKdmFyIF9jcmVhdGVDbGFzcyA9IChmdW5jdGlvbiAoKSB7IGZ1bmN0aW9uIGRlZmluZVByb3BlcnRpZXModGFyZ2V0LCBwcm9wcykgeyBmb3IgKHZhciBpID0gMDsgaSA8IHByb3BzLmxlbmd0aDsgaSsrKSB7IHZhciBkZXNjcmlwdG9yID0gcHJvcHNbaV07IGRlc2NyaXB0b3IuZW51bWVyYWJsZSA9IGRlc2NyaXB0b3IuZW51bWVyYWJsZSB8fCBmYWxzZTsgZGVzY3JpcHRvci5jb25maWd1cmFibGUgPSB0cnVlOyBpZiAoInZhbHVlIiBpbiBkZXNjcmlwdG9yKSBkZXNjcmlwdG9yLndyaXRhYmxlID0gdHJ1ZTsgT2JqZWN0LmRlZmluZVByb3BlcnR5KHRhcmdldCwgZGVzY3JpcHRvci5rZXksIGRlc2NyaXB0b3IpOyB9IH0gcmV0dXJuIGZ1bmN0aW9uIChDb25zdHJ1Y3RvciwgcHJvdG9Qcm9wcywgc3RhdGljUHJvcHMpIHsgaWYgKHByb3RvUHJvcHMpIGRlZmluZVByb3BlcnRpZXMoQ29uc3RydWN0b3IucHJvdG90eXBlLCBwcm90b1Byb3BzKTsgaWYgKHN0YXRpY1Byb3BzKSBkZWZpbmVQcm9wZXJ0aWVzKENvbnN0cnVjdG9yLCBzdGF0aWNQcm9wcyk7IHJldHVybiBDb25zdHJ1Y3RvcjsgfTsgfSkoKTsKCmZ1bmN0aW9uIF9jbGFzc0NhbGxDaGVjayhpbnN0YW5jZSwgQ29uc3RydWN0b3IpIHsgaWYgKCEoaW5zdGFuY2UgaW5zdGFuY2VvZiBDb25zdHJ1Y3RvcikpIHsgdGhyb3cgbmV3IFR5cGVFcnJvcigiQ2Fubm90IGNhbGwgYSBjbGFzcyBhcyBhIGZ1bmN0aW9uIik7IH0gfQoKdmFyIEV2ZW50RW1pdHRlciA9IChmdW5jdGlvbiAoKSB7CiAgZnVuY3Rpb24gRXZlbnRFbWl0dGVyKCkgewogICAgX2NsYXNzQ2FsbENoZWNrKHRoaXMsIEV2ZW50RW1pdHRlcik7CiAgfQoKICBfY3JlYXRlQ2xhc3MoRXZlbnRFbWl0dGVyLCBbewogICAga2V5OiAiYWRkRXZlbnRMaXN0ZW5lciIsCgogICAgLyoqCiAgICAgKiBhZGRFdmVudExpc3RlbmVyIGxpc3RlbiBmb3IgYW4gZXZlbnRUeXBlCiAgICAgKiBAcGFyYW0gIHtzdHJpbmd9ICAgICAgICAgZXZlbnRUeXBlIC0gbGlzdGVuaW5nIGZvciB0aGlzIHR5cGUgb2YgZXZlbnQKICAgICAqIEBwYXJhbSAge0Z1bmN0aW9ufSAgICAgICBjYiAgICAgICAgLSBjYWxsYmFjayBmdW5jdGlvbiB3aWxsIGJlIGV4ZWN1dGVkIHdoZW4gdGhlIGV2ZW50IGl0IGlzIGludm9rZWQKICAgICAqLwogICAgdmFsdWU6IGZ1bmN0aW9uIGFkZEV2ZW50TGlzdGVuZXIoZXZlbnRUeXBlLCBjYikgewogICAgICB2YXIgX3RoaXMgPSB0aGlzOwogICAgICBfdGhpc1tldmVudFR5cGVdID0gY2I7CiAgICB9CgogICAgLyoqCiAgICAgKiBJbnZva2UgdGhlIGV2ZW50VHlwZQogICAgICogQHBhcmFtICB7c3RyaW5nfSBldmVudFR5cGUgLSBldmVudCB3aWxsIGJlIGludm9rZWQKICAgICAqIEBwYXJhbSAge29iamVjdH0gcGFyYW1zIC0gcGFyYW1ldGVycyB3aWxsIGJlIHBhc3NlZCB0byB0aGUgYWRkRXZlbnRMaXN0ZW5lcgogICAgICovCiAgfSwgewogICAga2V5OiAidHJpZ2dlciIsCiAgICB2YWx1ZTogZnVuY3Rpb24gdHJpZ2dlcihldmVudFR5cGUsIHBhcmFtcykgewogICAgICB2YXIgX3RoaXMgPSB0aGlzOwoKICAgICAgaWYgKF90aGlzW2V2ZW50VHlwZV0pIHsKICAgICAgICBfdGhpc1tldmVudFR5cGVdKHBhcmFtcyk7CiAgICAgIH0KICAgIH0KICB9XSk7CgogIHJldHVybiBFdmVudEVtaXR0ZXI7Cn0pKCk7CgpleHBvcnRzWyJkZWZhdWx0Il0gPSBFdmVudEVtaXR0ZXI7Cm1vZHVsZS5leHBvcnRzID0gZXhwb3J0c1siZGVmYXVsdCJdOwoKfSx7fV0sMjQ6W2Z1bmN0aW9uKHJlcXVpcmUsbW9kdWxlLGV4cG9ydHMpewovKioKICogU3VwcG9ydCBtb2R1bGUgd2l0aCBzb21lIGZ1bmN0aW9ucyB3aWxsIGJlIHVzZWZ1bAogKiBAbW9kdWxlIHV0aWxzCiAqLwoKLyoqCiAqIEB0eXBlZGVmIGRpdmlkZVVSTAogKiBAdHlwZSBPYmplY3QKICogQHByb3BlcnR5IHtzdHJpbmd9IHR5cGUgVGhlIHR5cGUgb2YgVVJMCiAqIEBwcm9wZXJ0eSB7c3RyaW5nfSBkb21haW4gVGhlIGRvbWFpbiBvZiBVUkwKICogQHByb3BlcnR5IHtzdHJpbmd9IGlkZW50aXR5IFRoZSBpZGVudGl0eSBvZiBVUkwKICovCgovKioKICogRGl2aWRlIGFuIHVybCBpbiB0eXBlLCBkb21haW4gYW5kIGlkZW50aXR5CiAqIEBwYXJhbSAge1VSTC5VUkx9IHVybCAtIHVybCBhZGRyZXNzCiAqIEByZXR1cm4ge2RpdmlkZVVSTH0gdGhlIHJlc3VsdCBvZiBkaXZpZGVVUkwKICovCid1c2Ugc3RyaWN0JzsKCk9iamVjdC5kZWZpbmVQcm9wZXJ0eShleHBvcnRzLCAnX19lc01vZHVsZScsIHsKICB2YWx1ZTogdHJ1ZQp9KTsKZXhwb3J0cy5kaXZpZGVVUkwgPSBkaXZpZGVVUkw7CmV4cG9ydHMuZGVlcENsb25lID0gZGVlcENsb25lOwoKZnVuY3Rpb24gZGl2aWRlVVJMKHVybCkgewoKICAvLyBsZXQgcmUgPSAvKFthLXpBLVotXSopPzpcL1wvKD86XC4pPyhbLWEtekEtWjAtOUA6JS5fXCt+Iz1dezIsMjU2fVwuW2Etel17Miw2fVxiKSooXC9bXC9cZFx3XC4tXSopKig/OltcP10pKiguKykqL2dpOwogIHZhciByZSA9IC8oW2EtekEtWi1dKik6XC9cLyg/OlwuKT8oWy1hLXpBLVowLTlAOiUuX1wrfiM9XXsyLDI1Nn0pKFstYS16QS1aMC05QDolLl9cK34jPVwvXSopL2dpOwogIHZhciBzdWJzdCA9ICckMSwkMiwkMyc7CiAgdmFyIHBhcnRzID0gdXJsLnJlcGxhY2UocmUsIHN1YnN0KS5zcGxpdCgnLCcpOwogIHZhciByZXN1bHQgPSB7CiAgICB0eXBlOiBwYXJ0c1swXSwKICAgIGRvbWFpbjogcGFydHNbMV0sCiAgICBpZGVudGl0eTogcGFydHNbMl0KICB9OwoKICByZXR1cm4gcmVzdWx0Owp9CgovKioKICogTWFrZSBhIENPUFkgb2YgdGhlIG9yaWdpbmFsIGRhdGEKICogQHBhcmFtICB7T2JqZWN0fSAgb2JqIC0gb2JqZWN0IHRvIGJlIGNsb25lZAogKiBAcmV0dXJuIHtPYmplY3R9CiAqLwoKZnVuY3Rpb24gZGVlcENsb25lKG9iaikgewogIC8vVE9ETzogc2ltcGxlIGJ1dCBpbmVmZmljaWVudCBKU09OIGRlZXAgY2xvbmUuLi4KICByZXR1cm4gSlNPTi5wYXJzZShKU09OLnN0cmluZ2lmeShvYmopKTsKfQoKfSx7fV19LHt9LFszXSkoMykKfSk7","sourceCodeClassName":"HelloHyperty","encoding":"Base64","signature":""}